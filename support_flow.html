<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FieldOps Insight </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .category-card:hover {
            transform: translateY(-5px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #64748b;
            border-radius: 10px;
        }

        .bg-mesh {
            background-color: #f8fafc;
            background-image: radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.05) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(147, 51, 234, 0.05) 0px, transparent 50%);
        }

        .view-badge {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        }

        #mainGrid>div {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Ajuste para modais no Mobile */
        @media (max-width: 768px) {
            .modal-overlay>div {
                width: 100% !important;
                max-width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
                border-radius: 0 !important;
                /* Estilo folha inteira no mobile */
                margin: 0;
            }

            #listContainer {
                grid-template-cols: 1fr !important;
                /* For√ßa uma coluna no mobile */
                padding: 1rem !important;
            }

            #chatBox {
                width: 90% !important;
                right: 5% !important;
                left: 5% !important;
                bottom: 80px !important;
            }
        }
    </style>
</head>

<body class="bg-mesh min-h-screen">

    <nav class="sticky top-0 z-30 glass border-b border-slate-200 px-6 py-4">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-slate-900 p-2 rounded-xl shadow-lg shadow-blue-200">
                    <i data-lucide="bar-chart-3" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-extrabold text-slate-900 leading-none">FieldOps <span
                            class="text-blue-600">Insight</span></h1>
                    <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">by: Hayden
                        Fernandes</span>
                </div>
            </div>

            <div class="relative w-full md:w-96 group">
                <input type="text" id="searchInput" placeholder="Buscar solu√ß√£o ou categoria..."
                    class="w-full bg-slate-100 border-2 border-transparent focus:border-blue-500 focus:bg-white rounded-2xl py-2.5 px-12 text-sm font-medium outline-none transition-all shadow-sm">
                <i data-lucide="search"
                    class="absolute left-4 top-3 text-slate-400 group-focus-within:text-blue-500 w-5 h-5 transition-colors"></i>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="promptNewCategory()"
                    class="bg-slate-900 hover:bg-slate-800 text-white px-5 py-2.5 rounded-xl text-sm font-semibold flex items-center gap-2 transition-all shadow-xl shadow-slate-200">
                    <i data-lucide="folder-plus" class="w-4 h-4"></i> Nova Categoria
                </button>
                <div class="h-8 w-[1px] bg-slate-200 mx-2"></div>
                <button onclick="exportJSON()" class="p-2.5 text-slate-600 hover:bg-slate-100 rounded-xl transition"
                    title="Exportar Backup"><i data-lucide="download" class="w-5 h-5"></i></button>
                <label class="p-2.5 text-slate-600 hover:bg-slate-100 rounded-xl transition cursor-pointer">
                    <i data-lucide="upload" class="w-5 h-5"></i>
                    <input type="file" class="hidden" accept=".json" onchange="importJSON(event)">
                </label>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-6 py-10">
        <header class="mb-10 flex justify-between items-end">
            <div>
                <h2 class="text-3xl font-extrabold text-slate-900 tracking-tight">Solu√ß√µes Ativas</h2>
                <p class="text-slate-500 text-sm mt-1">M√©tricas de acesso em tempo real do seu CD.</p>
            </div>
        </header>

        <div id="mainGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </main>

    <div id="modalList" class="fixed inset-0 modal-overlay hidden z-40 p-0 md:p-4 flex items-center justify-center">
        <div
            class="bg-white/95 w-full max-w-6xl h-full md:h-[90vh] flex flex-col shadow-2xl border border-white/20 backdrop-blur-xl overflow-hidden md:rounded-[2rem]">
            <div class="p-4 md:p-8 border-b flex flex-col md:flex-row justify-between items-center bg-white/50 gap-4">
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <div id="catIconHeader" class="p-3 md:p-4 bg-blue-600 rounded-2xl text-white"></div>
                    <div>
                        <h2 id="catTitle" class="text-xl md:text-2xl font-extrabold text-slate-900 leading-tight"></h2>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter" id="catCount"></p>
                    </div>
                    <button onclick="closeModals()"
                        class="ml-auto md:hidden p-2 text-slate-400 hover:bg-slate-100 rounded-xl transition">
                        <i data-lucide="x"></i>
                    </button>
                </div>

                <div class="relative flex-grow w-full md:max-w-md mx-0 md:mx-4">
                    <input type="text" id="modalSearchInput" placeholder="Filtrar nesta categoria..."
                        class="w-full bg-slate-50 border border-slate-200 focus:border-blue-500 rounded-xl py-3 px-10 text-xs outline-none transition-all">
                    <i data-lucide="filter" class="absolute left-3 top-3 text-slate-400 w-4 h-4"></i>
                </div>

                <div class="flex items-center gap-3 w-full md:w-auto">
                    <button onclick="showEditor()"
                        class="flex-grow md:flex-none bg-blue-600 hover:bg-blue-700 text-white px-4 md:px-6 py-3 rounded-2xl flex items-center justify-center gap-2 text-xs font-bold shadow-lg transition-all">
                        <i data-lucide="plus" class="w-4 h-4"></i> Postar Solu√ß√£o
                    </button>
                    <button onclick="closeModals()"
                        class="hidden md:block p-3 text-slate-400 hover:bg-slate-100 rounded-2xl transition">
                        <i data-lucide="x"></i>
                    </button>
                </div>
            </div>

            <div id="listContainer"
                class="p-4 md:p-8 overflow-y-auto custom-scrollbar flex-grow grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 bg-slate-50/50">
            </div>
        </div>
    </div>

    <div id="modalView" class="fixed inset-0 modal-overlay hidden z-50 p-0 md:p-4 flex items-center justify-center">
        <div
            class="bg-white w-full max-w-3xl h-full md:h-auto md:max-h-[92vh] flex flex-col shadow-2xl overflow-hidden border border-slate-100 md:rounded-[2.5rem]">
            <div class="md:hidden p-4 border-b flex justify-between items-center bg-slate-50">
                <span class="text-xs font-bold text-slate-500">Editor/Visualizador</span>
                <button onclick="document.getElementById('modalView').classList.add('hidden')"
                    class="p-2 text-slate-400">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <div id="viewBody" class="p-6 md:p-10 overflow-y-auto custom-scrollbar flex-grow"></div>

            <div id="viewFooter" class="p-4 md:p-6 border-t bg-slate-50 flex flex-col md:flex-row justify-end gap-3">
            </div>
        </div>
    </div>

    <script>
        const iconMap = {
            'vpn': 'shield-check', 'wms': 'database', 'manhattan': 'layers',
            'coletor': 'smartphone', 'impressora': 'printer', 'rede': 'wifi',
            'senha': 'key-round', 'default': 'component'
        };

        // --- Persist√™ncia ---
        // Estrutura padr√£o que sempre deve existir (Categorias Fixas)
        const initialStructure = {
            "VPN": [], "WMS": [], "Coletor": [], "REDES": [], "SENHAS": [],
            "IMPRESSORAS": [], "WINDOWS": [], "R√ÅDIO": [], "INSTALADORES": [], "LINUX": []
        };

        // Carrega do LocalStorage ou usa a estrutura fixa inicial
        let db = JSON.parse(localStorage.getItem('fieldOpsDB')) || initialStructure;

        // Garante que, se categorias fixas forem deletadas, elas voltem no pr√≥ximo refresh
        Object.keys(initialStructure).forEach(cat => {
            if (!db[cat]) db[cat] = [];
        });

        // Fun√ß√£o de salvamento atualizada com Auto-Check de Espa√ßo
        function save() {
            const dataString = JSON.stringify(db);

            // Checagem de limite (Baseado em 5MB ~ 5.242.880 caracteres)
            if (dataString.length > 5000000) {
                alert("üö® LIMITE CR√çTICO ATINGIDO! Para evitar perda de dados, o sistema ir√° realizar um backup e limpar o cache agora.");
                forceMaintenance();
                return;
            }

            localStorage.setItem('fieldOpsDB', dataString);
            renderMainGrid();
        }

        function forceMaintenance() {
            exportJSON(); // Backup de seguran√ßa
            localStorage.removeItem('fieldOpsDB');

            // Reinicia o DB com a estrutura fixa em vez de vazio
            db = JSON.parse(JSON.stringify(initialStructure));

            document.getElementById('modalStatus').classList.add('hidden');
            renderMainGrid();

            setTimeout(() => {
                alert("Cache limpo! As categorias fixas foram restauradas automaticamente.");
                document.querySelector('input[type="file"]').click();
            }, 1500);
        }

        let currentCat = "";
        let currentEditIndex = -1;

        function getIcon(name) {
            name = name.toLowerCase();
            for (let key in iconMap) if (name.includes(key)) return iconMap[key];
            return iconMap['default'];
        }

        function renderMainGrid() {
            const grid = document.getElementById('mainGrid');
            grid.innerHTML = "";
            Object.keys(db).forEach(cat => {
                const totalViews = db[cat].reduce((sum, item) => sum + (item.views || 0), 0);
                grid.innerHTML += `
            <div class="category-card group glass p-8 rounded-[2rem] cursor-pointer border-transparent hover:border-blue-500/30 transition-all duration-300 relative overflow-hidden">
                <div onclick="openCategory('${cat}')">
                    <div class="bg-white p-5 rounded-2xl mb-6 shadow-sm inline-block group-hover:bg-blue-600 group-hover:text-white transition-all duration-300">
                        <i data-lucide="${getIcon(cat)}" class="w-8 h-8"></i>
                    </div>
                    <h3 class="text-xl font-extrabold text-slate-800 mb-1">${cat}</h3>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${db[cat].length} T√≥picos</span>
                        <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                        <span class="text-[10px] font-bold text-blue-500 uppercase tracking-widest">${totalViews} Visitas</span>
                    </div>
                </div>
                <button onclick="deleteCategory('${cat}')" class="absolute top-6 right-6 p-2 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            </div>


        `;
            });
            lucide.createIcons();
        }

        // Fun√ß√£o para deletar a categoria
        function deleteCategory(cat) {
            if (confirm(`Tem certeza que deseja excluir a categoria "${cat}" e TODAS as suas solu√ß√µes?`)) {
                delete db[cat];
                save();
            }
        }

        function promptNewCategory() {
            const name = prompt("Nome da Categoria:");
            if (name && !db[name]) { db[name] = []; save(); }
        }

        function openCategory(cat) {
            currentCat = cat;
            document.getElementById('catTitle').innerText = cat;
            document.getElementById('catCount').innerText = `${db[cat].length} solu√ß√µes documentadas`;
            document.getElementById('catIconHeader').innerHTML = `<i data-lucide="${getIcon(cat)}" class="w-8 h-8"></i>`;
            renderList();
            document.getElementById('modalList').classList.remove('hidden');
        }

        function renderList() {
            const container = document.getElementById('listContainer');
            container.innerHTML = "";

            db[currentCat].forEach((item, index) => {
                const tagColor = item.nivel === 'N3' ? 'bg-red-500' : item.nivel === 'N2' ? 'bg-amber-500' : 'bg-emerald-500';

                container.innerHTML += `
            <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 flex flex-col justify-between hover:shadow-xl transition-all relative group">
                <div class="absolute -top-2 -right-2 view-badge text-white text-[10px] font-black px-3 py-1 rounded-full shadow-lg border-2 border-white">
                    ${item.views || 0} VISITAS
                </div>
                <div>
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-2 h-2 rounded-full ${tagColor}"></div>
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">${item.nivel || 'N1'}</span>
                    </div>
                    <h4 class="text-lg font-bold text-slate-800 leading-snug mb-4">${item.titulo}</h4>
                </div>
                <div class="flex items-center gap-2 mt-4 pt-4 border-t border-slate-50">
                    <button onclick="viewContent(${index})" class="flex-grow bg-slate-900 text-white py-3 rounded-2xl text-xs font-bold hover:bg-blue-600 transition-all">Ver Solu√ß√£o</button>
                    
                    <button onclick="showEditor(${index})" class="p-3 text-slate-400 hover:text-blue-600 transition" title="Editar">
                        <i data-lucide="edit-2" class="w-4 h-4"></i>
                    </button>

                    <button onclick="deleteEntry(${index})" class="p-3 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-xl transition" title="Excluir">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        `;
            });
            lucide.createIcons();
        }

        function viewContent(index) {
            db[currentCat][index].views = (db[currentCat][index].views || 0) + 1;
            save();

            const item = db[currentCat][index];
            document.getElementById('viewBody').innerHTML = `
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-2 bg-blue-50 text-blue-600 px-4 py-1.5 rounded-full">
                <i data-lucide="eye" class="w-3 h-3"></i>
                <span class="text-[10px] font-black uppercase tracking-widest">Visualizada ${item.views} vezes</span>
            </div>
            <span class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">${item.nivel}</span>
        </div>
        <h2 class="text-4xl font-black text-slate-900 leading-tight mb-8">${item.titulo}</h2>
        <div class="bg-slate-50 p-8 rounded-[2rem] text-slate-700 leading-relaxed text-lg mb-8 border border-slate-100 whitespace-pre-wrap">${item.descricao}</div>
        
        ${item.doc ? `
            <div class="mb-8 p-6 bg-emerald-50 border border-emerald-200 rounded-[2rem] flex items-center justify-between shadow-sm">
                <div class="flex items-center gap-3">
                    <div class="bg-emerald-600 p-2 rounded-lg text-white">
                        <i data-lucide="file-text" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-black text-emerald-800 uppercase tracking-widest">Anexo Dispon√≠vel</p>
                        <p class="text-xs text-emerald-600 font-semibold">Manual / Documento T√©cnico</p>
                    </div>
                </div>
                <a href="${item.doc}" download="Anexo_${item.titulo.replace(/\s+/g, '_')}" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all shadow-lg shadow-emerald-200">
                    Baixar Arquivo
                </a>
            </div>
        ` : ''}

        ${item.link ? `<a href="${item.link}" target="_blank" class="flex items-center gap-3 bg-white border border-slate-200 p-5 rounded-2xl text-blue-600 font-bold hover:bg-blue-50 transition mb-8 shadow-sm text-sm"><i data-lucide="external-link"></i> Abrir Refer√™ncia</a>` : ''}
        ${item.img ? `<img src="${item.img}" class="rounded-[2rem] w-full h-auto shadow-2xl border-4 border-white">` : ''}
    `;

            document.getElementById('viewFooter').innerHTML = `<button onclick="document.getElementById('modalView').classList.add('hidden')" class="bg-slate-900 text-white px-10 py-4 rounded-2xl font-black text-xs tracking-widest">FECHAR</button>`;
            document.getElementById('modalView').classList.remove('hidden');
            lucide.createIcons();
            renderList();
        }

        function showEditor(index = -1) {
            currentEditIndex = index;
            const item = index === -1 ? { titulo: '', descricao: '', nivel: 'N1', link: '', img: '', views: 0 } : db[currentCat][index];
            document.getElementById('viewBody').innerHTML = `
                <h3 class="text-2xl font-black text-slate-900 mb-8">Editor de Guia</h3>
                <div class="space-y-6">
                    <div class="grid grid-cols-3 gap-3">
                        ${['N1', 'N2', 'N3'].map(n => `<button onclick="window._tmpNivel='${n}'; this.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('bg-blue-600','text-white')); this.classList.add('bg-blue-600','text-white')" class="py-3 rounded-2xl border text-xs font-bold transition ${item.nivel === n ? 'bg-blue-600 text-white' : 'bg-white text-slate-600'}">${n}</button>`).join('')}
                    </div>
                    <input id="editTitle" type="text" placeholder="T√≠tulo do Problema" value="${item.titulo}" class="w-full bg-slate-50 p-6 rounded-2xl outline-none text-xl font-bold">
                    <textarea id="editDesc" placeholder="Solu√ß√£o detalhada..." class="w-full bg-slate-50 p-6 rounded-2xl outline-none h-48 text-lg">${item.descricao}</textarea>
                    <input id="editLink" type="text" placeholder="Link externo" value="${item.link}" class="w-full bg-slate-50 p-4 rounded-2xl outline-none text-sm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-slate-50 p-8 rounded-[2rem] border-2 border-dashed border-slate-200 text-center relative hover:bg-slate-100 transition-colors">
                            <input type="file" id="editImg" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                            <i data-lucide="image" class="w-8 h-8 mx-auto text-blue-600 mb-2"></i>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Anexar Foto</p>
                            <div id="imgStatus" class="text-[9px] text-blue-500 mt-1 font-bold"></div>
                        </div>
                        <div class="bg-slate-50 p-8 rounded-[2rem] border-2 border-dashed border-slate-200 text-center relative hover:bg-slate-100 transition-colors">
                            <input type="file" id="editDoc" accept=".pdf,.doc,.docx" class="absolute inset-0 opacity-0 cursor-pointer">
                            <i data-lucide="file-text" class="w-8 h-8 mx-auto text-emerald-600 mb-2"></i>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Anexar PDF / Word</p>
                            <div id="docStatus" class="text-[9px] text-emerald-500 mt-1 font-bold"></div>
                        </div>
                    </div>
                </div>
`;

            // Adicione estes listeners logo abaixo para dar feedback visual:
            document.getElementById('editImg').onchange = e => document.getElementById('imgStatus').innerText = e.target.files[0].name;
            document.getElementById('editDoc').onchange = e => document.getElementById('docStatus').innerText = e.target.files[0].name;

            window._tmpNivel = item.nivel;
            document.getElementById('viewFooter').innerHTML = `
                <button onclick="document.getElementById('modalView').classList.add('hidden')" class="px-6 py-4 text-slate-400 font-bold text-[10px]">CANCELAR</button>
                <button onclick="saveEntry()" class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-black text-[10px] tracking-widest shadow-lg shadow-blue-100">SALVAR DADOS</button>
            `;
            document.getElementById('modalView').classList.remove('hidden');
            lucide.createIcons();





        }

        async function saveEntry() {
            const imgInput = document.getElementById('editImg');
            const docInput = document.getElementById('editDoc');

            const imgFile = imgInput ? imgInput.files[0] : null;
            const docFile = docInput ? docInput.files[0] : null;

            let base64Img = currentEditIndex !== -1 ? db[currentCat][currentEditIndex].img : "";
            let base64Doc = currentEditIndex !== -1 ? db[currentCat][currentEditIndex].doc : "";

            // Helper para converter arquivo em Base64
            const toBase64 = file => new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
            });

            if (imgFile) base64Img = await toBase64(imgFile);
            if (docFile) base64Doc = await toBase64(docFile);

            const newItem = {
                titulo: document.getElementById('editTitle').value,
                descricao: document.getElementById('editDesc').value,
                nivel: window._tmpNivel || 'N1',
                link: document.getElementById('editLink').value,
                img: base64Img,
                doc: base64Doc,
                views: currentEditIndex !== -1 ? db[currentCat][currentEditIndex].views : 0
            };

            if (currentEditIndex === -1) db[currentCat].push(newItem);
            else db[currentCat][currentEditIndex] = newItem;

            save();
            document.getElementById('modalView').classList.add('hidden');
            renderList();
        }

        function closeModals() {
            document.getElementById('modalList').classList.add('hidden');
            document.getElementById('modalView').classList.add('hidden');
        }

        function exportJSON() {
            const blob = new Blob([JSON.stringify(db, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `FIELDOPS_KNOWLEDGE_BASE.json`;
            a.click();
        }

        function importJSON(e) {
            const reader = new FileReader();
            reader.onload = (event) => { db = JSON.parse(event.target.result); save(); alert("Dados Importados!"); };
            reader.readAsText(e.target.files[0]);
        }

        renderMainGrid();


        // Aguarda o carregamento do DOM para garantir que o elemento existe
        document.addEventListener('DOMContentLoaded', () => {
            const aiInput = document.getElementById('aiInput');

            // Escuta a tecla 'Enter' dentro do campo de texto
            aiInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Evita a quebra de linha ou comportamentos padr√£o
                    askAI(); // Chama a sua fun√ß√£o de envio
                }
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Busca na P√°gina Principal (Filtra Categorias)
            const mainSearch = document.getElementById('searchInput');
            mainSearch.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const categoryCards = document.querySelectorAll('#mainGrid > div');

                categoryCards.forEach(card => {
                    const catName = card.querySelector('h3').innerText.toLowerCase();
                    // Verifica se o termo est√° no nome da categoria
                    if (catName.includes(term)) {
                        card.style.display = "block";
                        card.style.opacity = "1";
                        card.style.transform = "scale(1)";
                    } else {
                        card.style.display = "none";
                        card.style.opacity = "0";
                        card.style.transform = "scale(0.95)";
                    }
                });
            });

            // 2. Busca dentro do Popup (Filtra Solu√ß√µes/Subcategorias)
            const modalSearch = document.getElementById('modalSearchInput');
            modalSearch.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const topicCards = document.querySelectorAll('#listContainer > div');

                topicCards.forEach(card => {
                    const title = card.querySelector('h4').innerText.toLowerCase();
                    // Filtra pelo t√≠tulo da solu√ß√£o
                    if (title.includes(term)) {
                        card.style.display = "flex";
                    } else {
                        card.style.display = "none";
                    }
                });
            });
        });


        function purgeMedia() {
            if (confirm("Deseja remover todas as imagens e documentos para liberar espa√ßo? O texto das solu√ß√µes ser√° mantido.")) {
                Object.keys(db).forEach(cat => {
                    db[cat].forEach(item => {
                        item.img = "";
                        item.doc = "";
                    });
                });
                save();
                alert("Otimiza√ß√£o conclu√≠da!");
                document.getElementById('modalStatus').classList.add('hidden');
            }
        }
        function deleteEntry(index) {
            if (confirm("Tem certeza que deseja excluir esta solu√ß√£o permanentemente?")) {
                db[currentCat].splice(index, 1);
                save(); // Salva no LocalStorage e atualiza a tela principal
                renderList(); // Atualiza a lista no modal aberto
            }
        }

    </script>



    <div id="aiChatContainer" class="fixed bottom-6 right-6 z-50">
        <button onclick="toggleChat()"
            class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-2xl flex items-center justify-center transition-all scale-110">
            <i data-lucide="bot" id="chatIcon"></i>
        </button>

        <div id="chatBox"
            class="hidden glass fixed bottom-24 right-6 w-96 h-[500px] rounded-[2rem] shadow-2xl border border-white/50 flex flex-col overflow-hidden">
            <div class="bg-slate-900 p-4 text-white flex justify-between items-center">
                <span class="text-xs font-bold uppercase tracking-widest">IA Field Assistant</span>
                <button onclick="toggleChat()" class="text-slate-400 hover:text-white"><i data-lucide="x"
                        class="w-4 h-4"></i></button>
            </div>
            <div id="chatMessages" class="flex-grow p-4 overflow-y-auto custom-scrollbar space-y-4 bg-slate-50/50">
                <div class="bg-blue-100 text-blue-800 p-3 rounded-2xl rounded-tl-none text-xs">
                    Ol√° Hayden! Como posso ajudar no suporte do CD hoje? Busco na base local ou na nuvem.
                </div>
            </div>
            <div class="p-4 bg-white border-t flex gap-2">
                <input id="aiInput" type="text" placeholder="Descreva o problema..."
                    class="flex-grow bg-slate-100 border-none rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="askAI()" class="bg-blue-600 text-white p-2 rounded-xl"><i data-lucide="send"
                        class="w-4 h-4"></i></button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO DA IA ---
        const GEMINI_API_KEY = "AIzaSyD9O7W5wX0dLRTCtJuPWacvXmL1rhxg0Oc"; // Gere em: aistudio.google.com

        async function askAI() {
            const input = document.getElementById('aiInput');
            const msgBox = document.getElementById('chatMessages');
            const question = input.value;
            if (!question) return;

            // Adiciona a pergunta do usu√°rio na tela
            msgBox.innerHTML += `<div class="bg-slate-100 p-3 rounded-2xl self-end ml-10 text-[11px] text-slate-700">${question}</div>`;
            input.value = "";

            const loadingDiv = document.createElement('div');
            loadingDiv.id = "loading";
            loadingDiv.className = "text-[10px] text-slate-400 animate-pulse italic";
            loadingDiv.innerText = "Consultando IA...";
            msgBox.appendChild(loadingDiv);
            msgBox.scrollTop = msgBox.scrollHeight;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: `Voc√™ √© um analista Field Support S√™nior em um Centro de Distribui√ß√£o com 18 anos de experi√™ncia. Responda de forma t√©cnica e direta. Problema: ${question}` }]
                        }]
                    })
                });

                const data = await response.json();

                // Remove o loading
                document.getElementById('loading').remove();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const aiResponse = data.candidates[0].content.parts[0].text;

                msgBox.innerHTML += `
            <div class="bg-blue-600 text-white p-3 rounded-2xl rounded-tl-none text-[11px] shadow-lg shadow-blue-100">${aiResponse}</div>
            <div class="p-3 bg-white border rounded-xl text-[9px] mt-2 shadow-sm">
                <p class="font-bold mb-1 text-slate-600">Deseja adicionar isso √† base?</p>
                <button onclick="autoAddAI('${question.replace(/'/g, "\\'")}', '${aiResponse.replace(/'/g, "\\'").replace(/\n/g, ' ')}')" class="text-blue-600 underline font-black hover:text-blue-800">SIM, ADICIONAR AGORA</button>
            </div>`;
            } catch (err) {
                if (document.getElementById('loading')) document.getElementById('loading').remove();
                msgBox.innerHTML += `<div class="text-[10px] text-red-500 italic">Erro: ${err.message}. Verifique sua API Key e conex√£o.</div>`;
                console.error("Erro detalhado:", err);
            }
            msgBox.scrollTop = msgBox.scrollHeight;
        }


        function autoAddAI(titulo, desc) {
            const catSugestao = "IA_Sugerido";
            if (!db[catSugestao]) db[catSugestao] = [];

            db[catSugestao].push({
                titulo: "IA: " + titulo,
                descricao: desc,
                nivel: "N2",
                views: 0,
                img: ""
            });

            save(); // Salva no LocalStorage
            alert(`Adicionado em ${catSugestao}!`);
            toggleChat();
            renderMainGrid();
        }

        function toggleChat() {
            const box = document.getElementById('chatBox');
            box.classList.toggle('hidden');
            lucide.createIcons();
        }

        function checkStorage() {
            // Calcula o tamanho em caracteres da string do banco de dados
            const _lsTotal = JSON.stringify(localStorage).length;
            const _sizeInKB = (_lsTotal / 1024).toFixed(2);
            const _sizeInMB = (_lsTotal / (1024 * 1024)).toFixed(2);

            // Assume-se um limite padr√£o de 5MB para localStorage na maioria dos browsers
            const _percentage = ((_sizeInMB / 5) * 100).toFixed(1);

            // Atualiza o Popup
            document.getElementById('storageUsed').innerText = _sizeInMB > 1 ? `${_sizeInMB} MB` : `${_sizeInKB} KB`;
            document.getElementById('storagePercent').innerText = `${_percentage}%`;
            document.getElementById('storageBar').style.width = `${Math.min(_percentage, 100)}%`;

            // Se passar de 80%, muda a cor para alerta
            if (_percentage > 80) {
                document.getElementById('storageBar').classList.replace('bg-blue-600', 'bg-red-500');
            }

            document.getElementById('modalStatus').classList.remove('hidden');
            lucide.createIcons();
        }

    </script>

    <div class="fixed bottom-4 left-6 z-30">
        <button onclick="checkStorage()"
            class="flex items-center gap-2 text-[10px] font-bold text-slate-400 hover:text-blue-600 transition-colors bg-white/50 px-3 py-1 rounded-full border border-slate-200 backdrop-blur-sm">
            <i data-lucide="database" class="w-3 h-3"></i>
            STATUS DO SISTEMA
        </button>
    </div>

    <div id="modalStatus"
        class="fixed inset-0 bg-black/60 backdrop-blur-md hidden z-[60] p-4 flex items-center justify-center">
        <div class="bg-white rounded-[2rem] w-full max-w-md p-8 shadow-2xl border border-white/20">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-black text-slate-900 uppercase tracking-tight">Armazenamento Local</h3>
                <button onclick="document.getElementById('modalStatus').classList.add('hidden')"
                    class="text-slate-400 hover:text-red-500"><i data-lucide="x"></i></button>
            </div>

            <div class="space-y-6">
                <div>
                    <div class="flex justify-between text-[10px] font-bold uppercase mb-2">
                        <span class="text-slate-500">Espa√ßo em Uso</span>
                        <span id="storagePercent" class="text-blue-600">0%</span>
                    </div>
                    <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
                        <div id="storageBar" class="bg-blue-600 h-full transition-all duration-1000" style="width: 0%">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                        <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Total Usado</p>
                        <p id="storageUsed" class="text-sm font-bold text-slate-800">0 KB</p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                        <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Limite Est.</p>
                        <p class="text-sm font-bold text-slate-800">5 MB</p>
                    </div>
                </div>

                <p class="text-[10px] text-slate-400 leading-relaxed italic">
                    * Imagens em Base64 consomem muito espa√ßo. Recomendamos exportar o backup mensalmente para garantir
                    a integridade dos dados.
                </p>

                <button onclick="exportJSON()"
                    class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-[10px] tracking-widest hover:bg-blue-600 transition-all">
                    EXPORTAR BACKUP AGORA
                </button>

                <button onclick="forceMaintenance()"
                    class="w-full mb-3 bg-red-50 text-red-600 py-4 rounded-2xl font-black text-[10px] tracking-widest hover:bg-red-600 hover:text-white transition-all border border-red-200 flex items-center justify-center gap-2">
                    <i data-lucide="refresh-ccw" class="w-3 h-3"></i>
                    EXECUTAR LIMPEZA E REINICIAR (MANUAL)
                </button>


            </div>
        </div>

    </div>

</body>

</html>
