<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mundo da Malu üíñ | Super Miss√µes</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Poppins:wght@400;600&display=swap"
        rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --pink: #ff85a2;
            --dark-pink: #ff477e;
            --purple: #7d5fff;
            --sky: #a2d2ff;
            --yellow: #feca57;
            --white: #ffffff;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Poppins', sans-serif;
            background: var(--sky);
            overflow-x: hidden;
        }

        /* Fundo Animado com Desenhos */
        .bg-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            background: linear-gradient(to bottom, #a2d2ff 0%, #ffdeeb 100%);
        }

        .cloud {
            position: absolute;
            font-size: 50px;
            opacity: 0.6;
            animation: float 10s infinite linear;
        }

        @keyframes float {
            from {
                transform: translateX(-100px);
            }

            to {
                transform: translateX(110vw);
            }
        }

        /* Dashboard Principal */
        .app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: 100vh;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--white);
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: 0 8px 0 rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border: 3px solid var(--pink);
        }

        .clock-section {
            text-align: left;
            line-height: 1.2;
        }

        .clock-section #time {
            font-family: 'Fredoka One', cursive;
            color: var(--purple);
            font-size: 1.5rem;
        }

        .clock-section #date {
            color: var(--dark-pink);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .score-badge {
            background: var(--dark-pink);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-family: 'Fredoka One', cursive;
            font-size: 1.2rem;
            box-shadow: 0 4px 0 #a30031;
        }

        /* Grid de Miss√µes */
        .missions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            flex-grow: 1;
        }

        .card {
            background: var(--white);
            border-radius: 30px;
            padding: 20px;
            text-align: center;
            border: 4px solid transparent;
            transition: 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-10px);
            border-color: var(--yellow);
        }

        .card.complete {
            background: #d1ffdb;
            border-color: #2ecc71;
            opacity: 0.8;
        }

        .card img-icon {
            font-size: 50px;
            margin-bottom: 10px;
        }

        .card h3 {
            margin: 5px 0;
            font-size: 1rem;
            color: var(--purple);
        }

        .card .reward {
            font-weight: 800;
            color: var(--dark-pink);
            font-size: 0.9rem;
        }

        /* Sess√£o de Leitura */
        .reading-shelf {
            background: rgba(255, 255, 255, 0.8);
            margin-top: 20px;
            padding: 25px;
            border-radius: 30px;
            border: 4px dashed var(--purple);
            text-align: center;
        }

        .reading-shelf h2 {
            font-family: 'Fredoka One', cursive;
            color: var(--purple);
        }

        .book-grid {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
        }

        .book {
            background: var(--purple);
            color: white;
            padding: 15px;
            border-radius: 15px;
            cursor: pointer;
            width: 120px;
            transition: 0.3s;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .book:hover {
            transform: rotate(-5deg) scale(1.1);
            background: var(--dark-pink);
        }

        /* Modais Modernos */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }

        /* Ajuste para o conte√∫do do Modal ficar dentro da tela */
        .modal-content {
            background: white;
            width: 95%;
            /* Ocupa quase toda a largura em telas pequenas */
            max-width: 500px;
            max-height: 95vh;
            overflow-y: auto;
            /* N√£o ultrapassa 90% da altura da tela */
            border-radius: 30px;
            /* Reduzi um pouco para telas menores */
            padding: 20px;
            text-align: center;
            position: relative;
            border: 6px solid var(--pink);
            display: flex;
            flex-direction: column;
            /* Organiza os itens em coluna */
            overflow: hidden;
            align-items: center;
            justify-content: center;
            /* Garante que nada escape das bordas arredondadas */
        }

        /* Ajuste para o bot√£o de boas-vindas n√£o ultrapassar */
        #welcome-modal .btn {
            font-size: 1.2rem;
            /* Reduzido levemente */
            padding: 12px 30px;
            width: 90%;
            /* Garante que fique dentro da margem */
            max-width: 300px;
        }

        /* Ajuste espec√≠fico para o leitor de livros */
        .book-reader {
            max-width: 800px;
            /* Permite ser mais largo em tablets/PCs */
            text-align: left;
        }

        /* √Årea de texto com rolagem interna */
        .page-content {
            flex: 1;
            flex-grow: 1;
            -webkit-overflow-scrolling: touch;
            /* Faz o texto ocupar o espa√ßo dispon√≠vel */
            overflow-y: auto;
            /* Adiciona rolagem se o texto for grande */
            margin: 10px 0;
            padding: 15px;
            font-size: 1rem;
            /* Tamanho confort√°vel para celular */
            line-height: 1.5;
            color: #444;
            background: #fff9fb;
            /* Um fundo sutil para destacar a leitura */
            border-radius: 15px;
            border: 2px solid #eee;
        }

        .page-num {
            text-align: center;
            color: var(--pink);
            font-weight: bold;
        }

        .timer-box {
            background: #eee;
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            font-weight: bold;
            color: var(--dark-pink);
        }

        .btn {
            background: var(--purple);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: 0.3s;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Bot√µes Flutuantes Responsivos */
        .floating-btn {
            position: fixed;
            bottom: 30px;
            background: var(--yellow);
            color: #333;
            border: 4px solid var(--white);
            padding: 12px 20px;
            border-radius: 50px;
            font-family: 'Fredoka One', cursive;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Posicionamento padr√£o (Desktop/Tablet) */
        .btn-curiosidades {
            right: 30px;
        }

        .btn-gastos {
            left: 30px;
            background: var(--pink) !important;
            color: white !important;
        }

        /* Ajuste espec√≠fico para Celular (Mobile) */
        @media (max-width: 600px) {
            .floating-btn {
                bottom: 15px;
                /* Mais perto da borda inferior */
                font-size: 0.85rem;
                padding: 10px 15px;
            }

            .btn-curiosidades {
                right: 10px;
                width: 45%;
                /* Garante que n√£o batam um no outro */
                justify-content: center;
            }

            .btn-gastos {
                left: 10px;
                width: 45%;
                justify-content: center;
            }
        }

        .floating-btn:hover {
            transform: scale(1.1) rotate(5deg);
            background: var(--purple);
            color: white;
        }

        /* Grid de Bot√µes de Curiosidades */
        .curiosity-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .curiosity-item-btn {
            background: var(--sky);
            border: 2px solid var(--purple);
            padding: 10px;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .curiosity-item-btn:hover {
            background: var(--purple);
            color: white;
        }

        .curiosity-text-area {
            text-align: justify;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 20px;
            margin-top: 15px;
            font-size: 0.95rem;
            line-height: 1.6;
            display: none;
            /* Escondido at√© clicar em uma curiosidade */
        }

        /* Estilo para o contador de curiosidades do dia */
        .daily-limit-info {
            font-size: 0.8rem;
            color: var(--dark-pink);
            margin-bottom: 10px;
            font-weight: bold;
        }

        /* Scrollbar personalizada para o texto longo */
        .curiosity-text-area::-webkit-scrollbar {
            width: 8px;
        }

        .curiosity-text-area::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .curiosity-text-area::-webkit-scrollbar-thumb {
            background: var(--pink);
            border-radius: 10px;
        }

        body {
            /* Impede que o usu√°rio selecione textos ou imagens (comum em apps) */
            user-select: none;
            -webkit-user-select: none;
            /* Remove o scroll el√°stico no topo (iOS) */
            overscroll-behavior-y: contain;
        }

        .card,
        .btn,
        .curiosity-item-btn,
        .book {
            /* Feedback visual de toque r√°pido */
            -webkit-tap-highlight-color: transparent;
            transition: transform 0.1s active;
        }

        .card:active,
        .btn:active {
            transform: scale(0.95);
            /* Efeito de clique f√≠sico */
        }

        /* Ajuste do cabe√ßalho para n√£o bater no "notch" (c√¢mera) dos celulares novos */
        header {
            padding-top: env(safe-area-inset-top);
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        /* Deixar os modais com cara de "Sheet" (folha que sobe debaixo) no mobile */
        @media (max-width: 600px) {
            .modal-content {
                width: 100%;
                max-width: none;
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
                position: absolute;
                bottom: 0;
                animation: slideUp 0.3s ease-out;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        /* Estilos do Quebra-Cabe√ßa */
        #puzzle-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            /* 5 colunas */
            gap: 2px;
            background: #ccc;
            border: 5px solid var(--purple);
            width: 300px;
            height: 300px;
            margin: 15px auto;
        }

        .puzzle-piece {
            background-color: var(--pink);
            background-size: 300px 300px;
            /* Tamanho total da imagem */
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .puzzle-piece.empty {
            background: #eee !important;
            cursor: default;
        }

        #game-timer {
            font-size: 1.5rem;
            font-family: 'Fredoka One';
            color: var(--dark-pink);
            margin-bottom: 10px;
        }

        /* Bot√£o de Fechar Popup */
        .close-popup {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            z-index: 100;
        }

        /* Bot√£o de Recupera√ß√£o Discreto */
        .btn-restore-hidden {
            position: fixed;
            bottom: 5px;
            right: 5px;
            opacity: 0.3;
            background: none;
            border: none;
            font-size: 10px;
            cursor: pointer;
            color: #ccc;
        }

        .btn-restore-hidden:hover {
            opacity: 1;
        }

        /* Design do Popup de Backup L√∫dico */
        .backup-popup {
            background: #e3f2fd;
            border: 4px solid var(--sky);
            border-radius: 25px;
            padding: 20px;
            text-align: center;
            animation: bounceIn 0.5s ease;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }

            70% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Fundo Noturno Relaxante */
        .night-bg {
            background: linear-gradient(to bottom, #0f0c29, #302b63, #24243e);
            overflow: hidden;
            position: relative;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.5;
            animation: twinkle var(--duration) infinite ease-in-out;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        .moon {
            font-size: 80px;
            position: absolute;
            top: 10%;
            right: 15%;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.5));
            animation: floatMoon 6s infinite ease-in-out;
        }

        @keyframes floatMoon {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }

            50% {
                transform: translateY(-20px) rotate(5deg);
            }
        }

        /* Estrela Cadente */
        .shooting-star {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.1), 0 0 20px rgba(255, 255, 255, 1);
            animation: shoot 3s linear infinite;
            z-index: -1;
            pointer-events: none;
        }

        .shooting-star::before {
            content: '';
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 150px;
            height: 1px;
            background: linear-gradient(90deg, #fff, transparent);
        }

        @keyframes shoot {
            0% {
                transform: rotate(315deg) translateX(0);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            100% {
                transform: rotate(315deg) translateX(-1000px);
                opacity: 0;
            }
        }

        /* Estrela Cadente */
        .shooting-star {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.8);
            animation: shoot 3s linear forwards;
            z-index: 1;
            /* Fica acima das nuvens */
            pointer-events: none;
        }

        .shooting-star::after {
            content: '';
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100px;
            height: 2px;
            background: linear-gradient(90deg, #fff, transparent);
        }

        @keyframes shoot {
            0% {
                transform: rotate(315deg) translateX(0);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            100% {
                transform: rotate(315deg) translateX(-1200px);
                opacity: 0;
            }
        }

        /* Anima√ß√£o para o bot√£o de WhatsApp brilhar */
        @keyframes glow-gold {
            0% {
                box-shadow: 0 0 5px #feca57;
                transform: scale(1);
            }

            50% {
                box-shadow: 0 0 25px #feca57, 0 0 40px #ff9f43;
                transform: scale(1.05);
            }

            100% {
                box-shadow: 0 0 5px #feca57;
                transform: scale(1);
            }
        }

        .btn-whatsapp-glow {
            animation: glow-gold 1.5s infinite;
            background-color: #25D366 !important;
            /* Cor oficial do WhatsApp */
            border: 3px solid #fff !important;
            font-weight: bold;
        }

        /* Design do Teclado Num√©rico do Papai */
        .teclado-numerico {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            width: 100%;
        }

        .btn-num {
            background: #0f3460;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 1.4rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            border-bottom: 4px solid #0a213e;
        }

        .btn-num:active {
            transform: translateY(2px);
            border-bottom: 0;
        }

        .btn-danger {
            background: #e94560;
            border-bottom-color: #951227;
        }

        .btn-cancel {
            background: #533483;
            border-bottom-color: #3b255d;
        }

        /* Anima√ß√£o de Tremer (Shake) */
        @keyframes shake {
            0% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            50% {
                transform: translateX(10px);
            }

            75% {
                transform: translateX(-10px);
            }

            100% {
                transform: translateX(0);
            }
        }

        .shake-anim {
            animation: shake 0.4s ease-in-out;
        }

        @keyframes glow-green {
            0% {
                box-shadow: 0 0 5px #2ecc71;
            }

            50% {
                box-shadow: 0 0 20px #2ecc71;
            }

            100% {
                box-shadow: 0 0 5px #2ecc71;
            }
        }

        .card-gasto:active {
            transform: scale(0.95);
        }

        /* Layout do Super Painel do Papai */
        #pai-modal .modal-content {
            max-width: 1000px;
            width: 95%;
            padding: 30px;
            background: #f8f9fa;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            text-align: left;
        }

        @media (max-width: 800px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .dash-card {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
        }

        .dash-title {
            font-family: 'Fredoka One';
            color: var(--purple);
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Gr√°ficos de Barra Simples */
        .bar-container {
            margin-bottom: 10px;
        }

        .bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .bar-bg {
            background: #eee;
            height: 12px;
            border-radius: 10px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.5s ease;
        }

        /* Bot√µes do Painel */
        .admin-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .stat-badge {
            padding: 5px 12px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Estiliza√ß√£o da Tela de Login e Cadastro */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--sky);
            z-index: 5000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-box {
            background: white;
            padding: 30px;
            border-radius: 30px;
            border: 6px solid var(--pink);
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .login-box h2 {
            font-family: 'Fredoka One', cursive;
            color: var(--purple);
            margin-bottom: 20px;
        }

        .login-box input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 15px;
            border: 2px solid var(--sky);
            font-family: 'Poppins', sans-serif;
            outline: none;
        }

        .login-box button {
            width: 100%;
            padding: 12px;
            background: var(--pink);
            color: white;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .login-box p {
            font-size: 0.85rem;
            color: #666;
            margin-top: 15px;
            cursor: pointer;
            text-decoration: underline;
        }

        #img-molde {
            object-fit: contain;
            /* Mant√©m a propor√ß√£o da foto da Malu sem esticar */
            transition: opacity 0.3s;
        }

        /* Ajustes para Celular */
        @media (max-width: 600px) {
            #modal-colorir .modal-content {
                width: 100%;
                height: 100%;
                max-height: 100vh;
                border-radius: 0;
                padding: 10px;
            }

            #canvas-colorir {
                height: 350px !important;
                /* Altura reduzida para caber os controles no mobile */
            }

            .ferramentas-mobile {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
        }

        #canvas-colorir {
            touch-action: none;
            /* Crucial: impede que a p√°gina role enquanto ela desenha */
            background-image:
                linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
                linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
                linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        /* Garante que o √≠cone apare√ßa quando a classe 'preview' estiver ativa */
        .memory-card.preview {
            background: white;
            border: 3px solid var(--purple);
        }

        /* Estilos do Jogo da Mem√≥ria */
        #memory-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px auto;
            max-width: 300px;
        }

        .memory-card {
            height: 80px;
            background: var(--purple);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: transform 0.3s;
            transform-style: preserve-3d;
        }

        .memory-card.flipped {
            background: white;
            border: 3px solid var(--purple);
            transform: rotateY(180deg);
        }

        .memory-card.matched {
            background: #d1ffdb;
            border-color: #2ecc71;
            visibility: visible;
        }

        /* Ajuste do Puzzle para 10 pe√ßas */
        #puzzle-container {
            grid-template-columns: repeat(2, 1fr) !important;
            /* 2 colunas */
            grid-template-rows: repeat(5, 1fr) !important;
            /* 5 linhas */
            height: 350px !important;
        }

        #memory-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            /* 3 colunas para n√≠vel m√©dio */
            gap: 12px;
            margin: 20px auto;
            max-width: 320px;
        }

        .memory-card {
            height: 90px;
            background: var(--purple);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            cursor: pointer;
            transition: transform 0.4s;
            transform-style: preserve-3d;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .memory-card.flipped {
            background: white;
            border: 3px solid var(--purple);
            transform: rotateY(180deg);
        }

        .memory-card.matched {
            background: #d1ffdb;
            border-color: #2ecc71;
            cursor: default;
            animation: pulse 0.5s;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Estilo espec√≠fico para o modal de treino livre */
        #treino-modal .memory-card {
            background: var(--sky);
            /* Cor diferente para diferenciar do desafio valendo tempo */
            border: 2px solid var(--purple);
        }

        #treino-modal .modal-content {
            border-color: var(--sky);
        }

        /* Layout dos Bot√µes */
        .game-buttons-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px auto;
            padding: 0 10px;
        }

        .game-buttons-container .btn {
            width: 250px;
            /* Tamanho fixo para alinhar */
            border: 3px solid var(--white);
            font-size: 1.1rem;
        }

        /* Cores Correspondentes ao Site */
        .btn-main-game {
            background: var(--yellow) !important;
            color: #333 !important;
            opacity: 0.5;
        }

        .btn-practice {
            background: var(--sky) !important;
            color: #333 !important;
            border-color: var(--purple) !important;
        }

        .btn-snake {
            background: #2ecc71 !important;
            color: white !important;
        }

        .btn-tetris {
            background: var(--purple) !important;
            color: white !important;
        }

        /* Estilos dos novos jogos */
        #snake-canvas,
        #tetris-canvas {
            background: #1a1a2e;
            display: block;
            margin: 10px auto;
            border: 4px solid var(--purple);
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(125, 95, 255, 0.3);
        }

        .game-score {
            font-family: 'Fredoka One';
            color: var(--dark-pink);
            font-size: 1.5rem;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .ranking-pos {
            color: var(--purple);
            width: 30px;
        }

        .ranking-name {
            flex: 1;
            text-align: left;
            margin-left: 10px;
        }

        .ranking-score {
            color: var(--dark-pink);
        }

        .btn-ranking-abrir {
            background: gold !important;
            color: #333 !important;
            font-weight: bold;
            border: 3px solid white !important;
        }

        /* Container de controles para Mobile */
        .mobile-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            max-width: 220px;
            margin: 15px auto;
        }

        .ctrl-btn {
            background: var(--purple);
            color: white;
            border: none;
            border-radius: 12px;
            height: 55px;
            font-size: 1.4rem;
            cursor: pointer;
            touch-action: manipulation;
        }

        .ctrl-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        /* Esconder no Desktop se houver teclado */
        @media (min-width: 800px) {
            .mobile-controls {
                display: none;
            }
        }
    </style>
</head>

<body>



    <div class="bg-elements">
        <div class="cloud" style="top: 10%; animation-duration: 15s;">‚òÅÔ∏è</div>
        <div class="cloud" style="top: 30%; animation-duration: 20s;">‚≠ê</div>
        <div class="cloud" style="top: 60%; animation-duration: 12s;">‚òÅÔ∏è</div>
    </div>

    <div class="app-container">
        <header style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px;">
            <div class="clock-section">
                <div id="time" style="font-size: 1.2rem;">00:00</div>
                <div id="date" style="font-size: 0.7rem;">Carregando...</div>
            </div>

            <div class="score-badge" style="font-size: 1rem; padding: 8px 15px;">
                üöÄ <span id="total-min">0</span> MIN
            </div>

            <div style="display: flex; gap: 10px; align-items: center;">
                <button onclick="confirmarSair()" title="Sair do Mundo da Malu"
                    style="background: #ff477e; border: none; color: white; padding: 5px 10px; border-radius: 10px; cursor: pointer; font-size: 0.8rem; font-weight: bold;">
                    SAIR üö™
                </button>

                <button onclick="abrirModalSenha()"
                    style="background: none; border: none; font-size: 1.2rem; opacity: 0.4; cursor: pointer;">‚öôÔ∏è</button>
            </div>
        </header>

        <div class="missions-grid">
            <div class="card"
                onclick="completeMission(this, 25, 'üçº Cuidar da Lis', '<b>Paci√™ncia e Amor!</b><br>Cuidar de um beb√™ exige aten√ß√£o aos detalhes. Na medicina ou no direito, isso te tornar√° humana e respeitada!')">
                <div class="img-icon">üçº</div>
                <h3>Cuidar da Lis</h3>
                <span class="reward">+25 Minutos</span>
            </div>

            <div class="card"
                onclick="completeMission(this, 15, 'üßº Lavar a Lou√ßa', '<b>Foco e Limpeza!</b><br>Uma cirurgi√£ precisa de ordem total. Lavar a lou√ßa caprichada treina sua disciplina!')">
                <div class="img-icon">üßº</div>
                <h3>Lavar a Lou√ßa</h3>
                <span class="reward">+15 Minutos</span>
            </div>

            <div class="card"
                onclick="completeMission(this, 10, 'üßπ Varrer a Casa', '<b>Aten√ß√£o aos Detalhes!</b><br>Na advocacia, n√£o deixar poeira nos cantos √© como n√£o deixar erros nos processos!')">
                <div class="img-icon">üßπ</div>
                <h3>Varrer a Casa</h3>
                <span class="reward">+10 Minutos</span>
            </div>

            <div class="card"
                onclick="completeMission(this, 10, '‚ù§Ô∏è Ajudar a Tia e a Av√≥', '<b>Escuta Ativa!</b><br>Uma grande advogada precisa ouvir o que ningu√©m diz para ganhar uma causa!')">
                <div class="img-icon">üëµ</div>
                <h3>Ajudar a Tia e a Av√≥</h3>
                <span class="reward">+10 Minutos</span>
            </div>

            <div class="card"
                onclick="completeMission(this, 10, 'üë¥ Aten√ß√£o ao Av√¥', '<b>Iniciativa!</b><br>L√≠deres n√£o esperam ordens, eles antecipam necessidades. O Av√¥ fica feliz!')">
                <div class="img-icon">üë¥</div>
                <h3>Perguntar ao Av√¥</h3>
                <span class="reward">+10 Minutos</span>
            </div>

            <div class="card" style="border-color: #4cd137;"
                onclick="completeMission(this, 40, 'üìö Dever de Casa', '<b>Futura Ministra!</b><br>Estudar hoje garante que voc√™ tome as decis√µes certas amanh√£.')">
                <div class="img-icon">üìñ</div>
                <h3>Dever de Casa</h3>
                <span class="reward">+40 Minutos</span>
            </div>

            <div class="card" style="border-color: #00a8ff;"
                onclick="completeMission(this, 10, 'üéí Mochila Organizada', '<b>Prontid√£o!</b><br>Uma cirurgi√£ precisa dos instrumentos prontos. Sua mochila √© seu kit de sucesso!')">
                <div class="img-icon">üéí</div>
                <h3>Organizar Material</h3>
                <span class="reward">+10 Minutos</span>
            </div>
        </div>

        <div class="game-buttons-container">

            <button class="btn btn-ranking-abrir" onclick="abrirRanking()">
                üèÜ Ver Ranking Geral
            </button>


            <button id="btn-jogo-inteligente" class="btn btn-main-game" onclick="abrirJogoInteligente()">
                üéÆ Jogo Inteligente (Bloqueado)
            </button>

            <button class="btn btn-practice" onclick="abrirTreinoMemoria()">
                üß† Treinar Mem√≥ria (Livre!)
            </button>

            <button class="btn btn-snake" onclick="abrirSnakeGame()">
                üêç Jogo da Sogra
            </button>

            <button class="btn btn-tetris" onclick="abrirTetrisGame()">
                üß± Tetris Master
            </button>
        </div>

        <div class="reading-shelf">
            <h2>üìö Biblioteca da Malu (M√≠n. 20 min)</h2>
            <div class="book-grid">
                <div class="book" onclick="startReading('advogada')">‚öñÔ∏è Advogada de Sucesso</div>
                <div class="book" onclick="startReading('medica')">ü©∫ M√©dica Cirurgi√£</div>
                <div class="book" onclick="startReading('arquiteta')">üèóÔ∏è Arquiteta do Futuro</div>
                <div class="book" onclick="startReading('piloto')">‚úàÔ∏è Piloto de Aeronave</div>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="modal">
        <div class="modal-content">
            <h1 id="alert-emoji" style="font-size: 4rem; margin: 0;">üôè</h1>
            <h2 id="alert-title">Aten√ß√£o!</h2>
            <p id="alert-msg"></p>
            <button class="btn" onclick="closeModal('alert-modal')">Vou falar a verdade!</button>
        </div>
    </div>

    <div id="reading-modal" class="modal">
        <div class="modal-content book-reader" style="position: relative;">
            <span class="close-popup" onclick="fecharLeitura()" style="position: absolute; top: 15px; right: 20px; font-weight: bold; font-size: 30px; color:
                var(--pink);">√ó</span>

            <h2 id="book-title" style="color: var(--purple); margin-right: 40px;"></h2>

            <div class="recording-status" id="rec-indicator">
                <div class="pulse-red"></div> Gravando sua leitura... üéôÔ∏è
            </div>

            <div class="page-content" id="page-content"></div>

            <div class="page-num">P√°gina <span id="current-page">1</span> de 10</div>

            <div style="display: flex; justify-content: center; gap: 5px; margin-top: 10px;">
                <button class="btn" onclick="changePage(-1)">‚¨ÖÔ∏è</button>
                <button class="btn" id="btn-gravacao" style="background: #ff477e;" onclick="toggleRecording()">üé§
                    Iniciar Leitura</button>
                <button class="btn" onclick="changePage(1)">‚û°Ô∏è</button>
            </div>

            <div class="timer-box" id="reading-timer-display" style="font-size: 0.9rem; text-align: center;">
                ‚è≥ O tempo s√≥ corre enquanto voc√™ grava: <span id="timer-count">20:00</span>
            </div>

            <button class="btn" id="finish-btn" style="width: 100%; margin-top: 10px;" disabled
                onclick="rewardReading()">
                Concluir e Ganhar Tempo! ‚ú®
            </button>
        </div>
    </div>

    <div id="leitura-concluida-modal" class="modal">
        <div class="modal-content" style="border-color: var(--purple); max-width: 380px;">
            <h1 style="font-size: 4rem; margin: 0;">üìö</h1>
            <h2 style="font-family: 'Fredoka One'; color: var(--purple);">Malu, voc√™ j√° brilhou!</h2>
            <p style="font-weight: bold; color: var(--dark-pink);">Sua hist√≥ria inspiradora de hoje j√° foi lida com
                sucesso! ‚ú®</p>
            <p style="font-size: 0.9rem;">Que tal focar em outra miss√£o para ganhar mais minutos?</p>
            <button class="btn" style="background: var(--sky); color: #333; width: 100%;"
                onclick="closeModal('leitura-concluida-modal')">Entendido! üöÄ</button>
        </div>
    </div>

    <div id="backup-modal" class="modal">
        <div class="modal-content backup-popup">
            <h1 style="font-size: 4rem; margin: 0;">‚òÅÔ∏è</h1>
            <h2 style="color: var(--purple); font-family: 'Fredoka One';">Nuvem de Mem√≥rias!</h2>
            <p>Estou guardando suas conquistas de hoje com muito carinho...</p>
            <div style="width: 100%; background: #ddd; height: 10px; border-radius: 5px; margin-top: 10px;">
                <div
                    style="width: 100%; background: var(--sky); height: 100%; border-radius: 5px; animation: progress 2s linear;">
                </div>
            </div>
        </div>
    </div>

    <script>
        let nomeUsuarioLogado = ""; // Vari√°vel global
        let minutosGanhosHoje = 0; // Acumula tudo que ela ganhou nas miss√µes/leitura
        let attentionInterval;
        let attentionActive = false;
        let lastInteractionTime = Date.now();
        const INACTIVITY_LIMIT = 30000;
        let totalMinutes = 0;
        let podeSairDaPagina = false;
        let readingTimer;
        let curiosityTimer;
        let timeLeft = 20 * 60; // Reduzido para 10 minutos (ajust√°vel)
        let curiosityTimeLeft = 4 * 60; // 4 minutos para curiosidades
        let currentPage = 1;
        let currentStoryKey = '';

        // Controles de Limite
        let curiositiesViewedToday = 0;
        const MAX_CURIOSITIES_PER_DAY = 2;
        let storyReadToday = false;
        let missionsCompletedCount = 0;
        const TOTAL_MISSIONS = 5;

        function updateClock() {
            const now = new Date();
            const days = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            const months = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            document.getElementById('time').innerText = now.toLocaleTimeString();
            document.getElementById('date').innerText = `${days[now.getDay()]}, ${now.getDate()} de ${months[now.getMonth()]} de ${now.getFullYear()}`;
        }

        // Disparar popup de boas-vindas ao carregar a p√°gina
        function mostrarBoasVindasPersonalizado(nomeUsuario) {
            const agora = new Date();
            const hora = agora.getHours();
            let saudacao = `Bem-vinda, ${nomeUsuario}!`;
            let mensagem = "Pronta para brilhar hoje?";
            let emoji = "‚ú®";

            if (hora >= 5 && hora < 12) {
                saudacao = `Bom dia, ${nomeUsuario}! ‚òÄÔ∏è`;
                mensagem = "O sol nasceu! Que tal come√ßar suas miss√µes?";
                emoji = "‚òÄÔ∏è";
            }
            else if (hora >= 12 && hora < 18) {
                saudacao = `Boa tarde, ${nomeUsuario}! üå∏`;
                mensagem = "Hora perfeita para uma leitura inspiradora.";
                emoji = "üìö";
            }
            else if (hora >= 18) {
                saudacao = `Boa noite, ${nomeUsuario}! üåô`;
                mensagem = "Voc√™ brilhou muito hoje!";
                emoji = "üåü";
            }

            const welcomeModal = document.getElementById('welcome-modal');
            welcomeModal.querySelector('h1').innerText = emoji;
            welcomeModal.querySelector('h2').innerText = saudacao;
            welcomeModal.querySelector('p').innerText = mensagem;
            document.getElementById('welcome-name').innerText = saudacao;
            welcomeModal.style.display = 'flex';
        }


        setInterval(updateClock, 1000);
        updateClock();

        // Vari√°veis de Controle do Jogo
        const P_ROWS = 5;
        const P_COLS = 2;
        let pieces = [];
        let gameTimerInterval;

        // Atualize sua fun√ß√£o checkAllDone existente
        function checkAllDone() {
            const btnJogo = document.getElementById('btn-jogo-inteligente');
            if (missionsCompletedCount >= TOTAL_MISSIONS && storyReadToday && curiositiesViewedToday >= MAX_CURIOSITIES_PER_DAY) {
                btnJogo.style.opacity = "1";
                btnJogo.innerText = "üéÆ Jogo Inteligente (LIBERADO!)";
                btnJogo.style.animation = "none"; // Remove qualquer movimento
                btnJogo.style.border = "4px solid #2ecc71"; // Sinaliza com cor verde s√≥lida

                setTimeout(() => {
                    showFinalAuthorizationModal();
                }, 1500);
            }
        }

        function abrirJogoInteligente() {
            // Agora o missionsCompletedCount ter√° o valor correto (ex: 7 de 5)
            const missoesOk = missionsCompletedCount >= TOTAL_MISSIONS;
            const leituraOk = storyReadToday;
            const curiosidadesOk = curiositiesViewedToday >= MAX_CURIOSITIES_PER_DAY;

            if (missoesOk && leituraOk && curiosidadesOk) {
                document.getElementById('game-modal').style.display = 'flex';
                initPuzzle();
                startGameTimer();
                return;
            }

            // 3. Caso contr√°rio, atualiza o checklist visual
            const checkM = document.getElementById('check-missions');
            const checkL = document.getElementById('check-reading');
            const checkC = document.getElementById('check-curiosity');

            // Atualiza Miss√µes
            checkM.innerHTML = missoesOk ? "‚úÖ Todas as miss√µes feitas!" : `‚ùå Faltam ${TOTAL_MISSIONS - missionsCompletedCount} miss√µes`;
            checkM.style.color = missoesOk ? "green" : "red";

            // Atualiza Leitura
            checkL.innerHTML = leituraOk ? "‚úÖ Hist√≥ria lida!" : "‚ùå Ler hist√≥ria (20 min)";
            checkL.style.color = leituraOk ? "green" : "red";

            // Atualiza Curiosidades
            checkC.innerHTML = curiosidadesOk ? "‚úÖ Curiosidades visualizadas!" : `‚ùå Ver curiosidades (${curiositiesViewedToday}/${MAX_CURIOSITIES_PER_DAY})`;
            checkC.style.color = curiosidadesOk ? "green" : "red";

            // 4. Mostra o modal personalizado
            document.getElementById('game-locked-modal').style.display = 'flex';
        }

        let currentStage = 1; // 1: Puzzle, 2: Mem√≥ria
        let memoryCards = [];
        let flippedCards = [];

        // Redefinindo as configura√ß√µes do Puzzle para 10 pe√ßas (2x5

        function initPuzzle() {
            currentStage = 1;
            document.getElementById('game-instruction').innerText = "Fase 1: Quebra-Cabe√ßa de 10 Pe√ßas üß©";
            document.getElementById('puzzle-container').style.display = 'grid';
            document.getElementById('memory-grid').style.display = 'none';

            const container = document.getElementById('puzzle-container');
            container.innerHTML = '';

            // Criar 10 pe√ßas (0 a 9). A pe√ßa 9 ser√° o espa√ßo vazio.
            pieces = [];
            for (let i = 0; i < 10; i++) pieces.push(i);

            // Embaralhar garantindo que o jogo seja resolv√≠vel
            pieces.sort(() => Math.random() - 0.5);
            renderPuzzle();
        }

        function renderPuzzle() {
            const container = document.getElementById('puzzle-container');
            container.innerHTML = '';

            pieces.forEach((pieceIdx, currentPos) => {
                const div = document.createElement('div');
                div.className = 'puzzle-piece';

                // O n√∫mero 9 √© o nosso "buraco" para mover as pe√ßas
                if (pieceIdx === 9) {
                    div.classList.add('empty');
                    div.innerText = '';
                } else {
                    const row = Math.floor(pieceIdx / P_COLS);
                    const col = pieceIdx % P_COLS;

                    div.style.backgroundImage = `url('https://api.dicebear.com/7.x/adventurer/svg?seed=Malu&backgroundColor=ff85a2')`;
                    // Ajuste da posi√ß√£o da imagem para 2 colunas
                    div.style.backgroundPosition = `-${col * 150}px -${row * 70}px`;
                    div.innerText = pieceIdx + 1;
                    div.onclick = () => movePiece(currentPos);
                }
                container.appendChild(div);
            });
        }

        function movePiece(pos) {
            const emptyPos = pieces.indexOf(9); // Localiza o vazio
            const row = Math.floor(pos / P_COLS);
            const emptyRow = Math.floor(emptyPos / P_COLS);
            const col = pos % P_COLS;
            const emptyCol = emptyPos % P_COLS;

            // S√≥ move se estiver ao lado, acima ou abaixo do vazio
            const isAdjacent = Math.abs(row - emptyRow) + Math.abs(col - emptyCol) === 1;

            if (isAdjacent) {
                // Troca a pe√ßa de lugar com o vazio
                [pieces[pos], pieces[emptyPos]] = [pieces[emptyPos], pieces[pos]];
                renderPuzzle();
                checkWin();
            }
        }

        function checkWin() {
            const win = pieces.every((val, i) => val === i);
            if (win) {
                // Passar para a fase da mem√≥ria
                currentStage = 2;
                document.getElementById('game-instruction').innerText = "Fase 2: Jogo da Mem√≥ria das Profiss√µes ü©∫";
                document.getElementById('puzzle-container').style.display = 'none';
                initMemoryGame();
            }
        }

        // Configura√ß√µes do Jogo da Mem√≥ria
        let matchedPairs = 0;

        function initMemoryGame() {
            const grid = document.getElementById('memory-grid');
            grid.style.display = 'grid';
            grid.innerHTML = '';
            flippedCards = [];
            matchedPairs = 0;

            // √çcones baseados nos interesses da Malu
            const icons = [
                '‚öñÔ∏è', // Advogada
                'ü©∫', // M√©dica
                'üèóÔ∏è', // Arquiteta
                '‚úàÔ∏è', // Piloto
                'üé®', // Artes/Desenho
                'üèê'  // V√¥lei
            ];

            // Duplicar e embaralhar
            const deck = [...icons, ...icons].sort(() => Math.random() - 0.5);

            deck.forEach((icon, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                card.dataset.icon = icon;
                card.onclick = () => flipCard(card);
                grid.appendChild(card);
            });
        }

        function flipCard(card) {
            // Evita virar mais de 2, a mesma carta ou cartas j√° encontradas
            if (flippedCards.length < 2 && !card.classList.contains('flipped') && !card.classList.contains('matched')) {
                card.classList.add('flipped');
                card.innerText = card.dataset.icon;
                flippedCards.push(card);

                if (flippedCards.length === 2) {
                    setTimeout(checkMemoryMatch, 800);
                }
            }
        }

        function checkMemoryMatch() {
            const [card1, card2] = flippedCards;

            if (card1.dataset.icon === card2.dataset.icon) {
                card1.classList.add('matched');
                card2.classList.add('matched');
                matchedPairs++;

                // Se achou os 6 pares, finaliza
                if (matchedPairs === 6) {
                    finalizarDesafioTotal();
                }
            } else {
                // Se errou, vira de volta
                card1.classList.remove('flipped');
                card2.classList.remove('flipped');
                card1.innerText = '';
                card2.innerText = '';
            }
            flippedCards = [];
        }

        function finalizarDesafioTotal() {
            clearInterval(gameTimerInterval);
            // Adiciona os 45 minutos de recompensa
            totalMinutes += 45;
            document.getElementById('total-min').innerText = totalMinutes;

            mostrarAviso("PARAB√âNS, MALU! üèÜ", "Venceste o Puzzle e a Mem√≥ria! +45 minutos ganhos.", "üåü");

            // Salva no banco de dados para n√£o perder se atualizar
            gravarTudoInstantaneo();
            setTimeout(() => closeModal('game-modal'), 2000);
        }

        function startGameTimer() {
            gameTimeLeft = 15 * 60;
            clearInterval(gameTimerInterval);
            gameTimerInterval = setInterval(() => {
                gameTimeLeft--;
                let m = Math.floor(gameTimeLeft / 60);
                let s = gameTimeLeft % 60;
                document.getElementById('game-timer').innerText = `${m}:${s < 10 ? '0' + s : s}`;

                gravarTudoInstantaneo();

                if (gameTimeLeft <= 0) {
                    clearInterval(gameTimerInterval);
                    perderJogo();
                }
            }, 1000);
        }

        function perderJogo() {
            alert("O tempo acabou! Voc√™ perdeu 30 minutos. Tente ser mais r√°pida na pr√≥xima! ‚è≥");
            totalMinutes = Math.max(0, totalMinutes - 30);
            document.getElementById('total-min').innerText = totalMinutes;

            gravarTudoInstantaneo();
            closeModal('game-modal');
        }

        function desistirJogo() {
            const msg = "Malu, se voc√™ desistir agora, perder√° 30 minutos das suas conquistas! Tem certeza? ü•∫";
            document.getElementById('custom-confirm-message').innerText = msg;
            document.getElementById('custom-confirm-modal').style.display = 'flex';

            document.getElementById('confirm-yes').onclick = function () {
                totalMinutes = Math.max(0, totalMinutes - 30);
                localStorage.setItem('minutosMalu', totalMinutes);
                document.getElementById('total-min').innerText = totalMinutes;

                gravarTudoInstantaneo();
                closeModal('custom-confirm-modal');
                closeModal('game-modal');
                clearInterval(gameTimerInterval);
            };
        }

        function showFinalAuthorizationModal() {
            let authModal = document.getElementById('auth-modal');
            if (!authModal) {
                const modalHTML = `
                <div id="auth-modal" class="modal" style="display:flex">
                    <div class="modal-content" style="border: 10px solid var(--yellow); background: #fff;">
                        <h1 style="font-size: 5rem;">üèÜ</h1>
                        <h2 style="color: var(--dark-pink); font-family: 'Fredoka One';">MISS√ÉO CUMPRIDA!</h2>
                        <p style="font-size: 1.2rem; font-weight: bold;">Malu, voc√™ completou TUDO por hoje! Parab√©ns pela disciplina! ‚ú®</p>
                
                        <div style="background: #f0f0f0; padding: 20px; border-radius: 20px; margin: 20px 0; border: 3px dashed var(--purple); width: 100%;">
                            <button class="btn" style="background: #25D366; color: white; width: 100%; margin-bottom: 10px; font-size: 1.1rem;" onclick="gerarECompartilharCertificado()">
                                üìÑ EMITIR CERTIFICADO & ZAP üöÄ
                            </button>
                            <p style="font-size: 0.9rem; color: #666;">Envie para o Papai Hayden como prova!</p>
                        </div>

                        <button class="btn" onclick="closeModal('auth-modal')">Fechar</button>
                    </div>
                </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            } else {
                authModal.style.display = 'flex';
            }
        }




        // Garante que o saldo seja registrado no dia correto da semana
        function registrarGanhoNoBanco(minutos) {
            const diasNomes = ['dom', 'seg', 'ter', 'qua', 'qui', 'sex', 'sab'];
            const hojeNome = diasNomes[new Date().getDay()];
            let banco = obterBancoHoras();

            // Acumula os minutos ganhos no dia atual
            banco[hojeNome] = (banco[hojeNome] || 0) + minutos;
            localStorage.setItem('bancoHorasMalu', JSON.stringify(banco));
        }

        // ATUALIZA√á√ÉO: V√° na sua fun√ß√£o completeMission() e adicione:
        function completeMission(el, min, title, msg) {
            if (!el.classList.contains('complete')) {
                el.classList.add('complete');

                // ADICIONE ESTA LINHA ABAIXO:
                missionsCompletedCount++;

                totalMinutes += min;
                document.getElementById('total-min').innerText = totalMinutes;
                salvarProgressoAtual();
                gravarTudoInstantaneo();
                checkAllDone(); // Esta fun√ß√£o agora vai funcionar pois o contador subiu!
                mostrarAviso(title, msg, "üåü");
            }
        }

        // 3. Sistema de Leitura com 10 P√°ginas de 20 Linhas
        const stories = {
            advogada: [
                "P√°gina 1: Maria Luiza estava no sexto ano quando percebeu que as palavras eram como pe√ßas de um quebra-cabe√ßa que podiam montar a justi√ßa. Naquela manh√£ de abril, prestes a fazer 12 anos, ela se pegou observando uma injusti√ßa no p√°tio da escola. Um colega havia sido acusado de algo que n√£o fez, e ningu√©m parecia disposto a ouvir o seu lado. Malu, com sua voz firme e olhar atento, decidiu intervir. Ela n√£o gritou, apenas organizou os fatos com uma clareza que deixou at√© os professores impressionados. Naquele momento, no fundo de seu cora√ß√£o, uma chama se acendeu: o Direito n√£o seria apenas uma profiss√£o, seria sua miss√£o de vida. Ela voltou para casa pensando em como as leis podiam proteger as pessoas, e come√ßou a pesquisar sobre grandes nomes da advocacia. A biblioteca da escola virou seu ref√∫gio preferido, onde ela passava horas lendo sobre casos hist√≥ricos.",
                "P√°gina 2: Com o passar dos meses, Maria Luiza se tornou a 'advogada oficial' da turma. Se algu√©m tinha um conflito, procurava a Malu. Ela adorava o desafio de entender os dois lados e encontrar uma solu√ß√£o que fosse justa para todos. Seu pai, Hayden, percebeu esse talento logo cedo e come√ßou a incentiv√°-la com livros sobre orat√≥ria e l√≥gica. Malu lia cada p√°gina com sede de conhecimento, sublinhando frases importantes e treinando seus discursos na frente do espelho. Ela sabia que, como uma jovem negra, precisaria ser duas vezes melhor, e isso n√£o a assustava, pelo contr√°rio, dava a ela um combust√≠vel extra. Ela come√ßou a entender que a advocacia exigia n√£o apenas falar bem, mas ouvir com o cora√ß√£o. Cada leitura era um degrau a mais na escada que ela estava construindo rumo ao seu futuro brilhante no tribunal.",
                "P√°gina 3: Os anos de ensino fundamental e m√©dio foram marcados por muita dedica√ß√£o. Malu nunca perdia um debate na escola. Ela se destacava pela forma como respeitava seus oponentes, mas destru√≠a argumentos fracos com fatos s√≥lidos. Seus professores diziam que ela tinha uma 'presen√ßa de palco' natural. Ela come√ßou a participar de simula√ß√µes da ONU para jovens, onde representava diferentes pa√≠ses e defendia direitos humanos globais. Foi nessas simula√ß√µes que ela percebeu que o mundo era vasto e cheio de problemas que precisavam de mentes brilhantes para serem resolvidos. Maria Luiza n√£o queria apenas ser uma advogada comum; ela queria ser a voz daqueles que a sociedade tentava silenciar. O Direito Penal e os Direitos Humanos tornaram-se suas √°reas favoritas, pois ali ela via a chance real de mudar vidas e corrigir erros sist√™micos.",
                "P√°gina 4: Quando chegou a hora do vestibular, Malu n√£o teve d√∫vidas. Ela queria a melhor faculdade de Direito do pa√≠s. Foram meses de estudo intenso, muitas vezes abdicando de festas para resolver quest√µes de hist√≥ria e filosofia. Ela se lembrava das palavras de seu pai sobre a import√¢ncia do foco. No dia da prova, ela estava calma. Ela sabia que estava preparada. Quando a lista de aprovados saiu, o nome 'Maria Luiza' estava no topo. A comemora√ß√£o em casa foi gigante! Ela seria a primeira da fam√≠lia a ingressar em uma carreira jur√≠dica t√£o prestigiada. Ao entrar na universidade, ela sentiu o peso da responsabilidade, mas tamb√©m a alegria da conquista. Ela agora era oficialmente uma estudante de Direito, pronta para desbravar os c√≥digos e as leis que regem a na√ß√£o, sempre mantendo seus princ√≠pios e sua identidade.",
                "P√°gina 5: A faculdade foi um desafio constante. Malu se deparou com teorias complexas e textos em latim que pareciam indecifr√°veis no in√≠cio. Mas ela n√£o desistiu. Ela formou um grupo de estudos com outros estudantes negros e juntos criaram um coletivo jur√≠dico para discutir o racismo estrutural nas leis brasileiras. Ela percebeu que a lei, muitas vezes, era aplicada de forma desigual, e decidiu que sua carreira seria pautada pela equidade. Ela conseguiu um est√°gio em um dos escrit√≥rios mais renomados da cidade, onde come√ßou arquivando processos, mas logo chamou a aten√ß√£o dos s√≥cios por suas an√°lises jur√≠dicas precisas. Ela passava as noites na biblioteca da faculdade, mergulhada em jurisprud√™ncias e doutrinas, preparando-se para o dia em que estaria do outro lado da bancada, defendendo seus pr√≥prios clientes com a mesma garra que demonstrava no est√°gio.",
                "P√°gina 6: Ap√≥s cinco anos de estudo intenso, chegou o momento do Exame da Ordem (OAB). Era a prova final que definiria se ela poderia ou n√£o exercer a profiss√£o. Malu se isolou do mundo por dois meses, revisando todo o conte√∫do acumulado. Ela sentia a press√£o, mas tamb√©m a confian√ßa de quem fez o dever de casa. No dia do exame, ela respondeu cada quest√£o com seguran√ßa. O resultado n√£o poderia ser diferente: aprovada de primeira! Agora, ela era a Dra. Maria Luiza. Ela comprou sua primeira beca e sentiu um orgulho imenso ao ver seu reflexo no espelho. Ela n√£o era mais apenas a menina que defendia os colegas no p√°tio; ela agora tinha o poder legal de lutar pela justi√ßa. Seu primeiro escrit√≥rio foi pequeno, mas sua reputa√ß√£o cresceu r√°pido devido √† sua √©tica inabal√°vel e sua dedica√ß√£o total a cada caso que aceitava.",
                "P√°gina 7: O primeiro grande caso da Dra. Maria Luiza foi uma a√ß√£o civil p√∫blica contra uma empresa que estava poluindo o rio de uma comunidade carente. Ningu√©m acreditava que uma jovem advogada rec√©m-formada pudesse vencer uma gigante corporativa com centenas de advogados experientes. Mas Malu tinha algo que eles n√£o tinham: a verdade e uma conex√£o real com as v√≠timas. Ela passou semanas na comunidade, ouvindo as hist√≥rias das fam√≠lias e coletando evid√™ncias. No tribunal, seu discurso foi emocionante e tecnicamente impec√°vel. Ela falou sobre o direito √† vida e √† sa√∫de, e como o lucro n√£o poderia estar acima da dignidade humana. O juiz proferiu a senten√ßa em favor da comunidade, e a not√≠cia se espalhou por todo o pa√≠s. Malu havia se tornado um s√≠mbolo de esperan√ßa e resist√™ncia no meio jur√≠dico.",
                "P√°gina 8: Com o sucesso do caso ambiental, a Dra. Maria Luiza foi convidada para dar palestras em universidades e eventos internacionais. Ela viajou para Nova York e Genebra, levando a voz do Brasil e das mulheres negras para os palcos globais. Ela nunca esqueceu suas ra√≠zes e sempre mencionava o apoio da fam√≠lia em seus discursos. Ela decidiu abrir seu pr√≥prio escrit√≥rio, focado em causas sociais e defesa de minorias. O escrit√≥rio 'Maria Luiza Advocacia' tornou-se um porto seguro para aqueles que se sentiam desamparados pelo sistema. Ela contratava jovens estagi√°rios de periferias, dando a eles a mesma oportunidade que um dia recebeu. Malu sabia que o sucesso s√≥ fazia sentido se ela pudesse abrir portas para outros que viessem depois dela, criando um ciclo de prosperidade e justi√ßa.",
                "P√°gina 9: A carreira da Dra. Maria Luiza atingiu um novo patamar quando ela foi indicada para ser Desembargadora. Era um cargo de extrema import√¢ncia no tribunal de justi√ßa. Ela analisou o convite com cuidado, sabendo que sua presen√ßa naquele tribunal seria hist√≥rica. Ao assumir o cargo, ela se tornou uma das poucas mulheres negras a ocupar um assento t√£o alto na magistratura. Seus votos eram conhecidos por serem t√©cnicos, humanos e profundamente fundamentados em princ√≠pios de igualdade. Ela n√£o apenas julgava processos; ela moldava o pensamento jur√≠dico do pa√≠s. Ela escreveu livros que se tornaram best-sellers, usados em faculdades de todo o mundo. Maria Luiza era agora uma autoridade m√°xima, respeitada por colegas, opositores e pelo povo, mantendo sempre a humildade e a vontade de aprender.",
                "P√°gina 10: Hoje, ao olhar para tr√°s, a Dra. Maria Luiza v√™ a menina de 11 anos que um dia resolveu uma briga de escola. Ela entende que cada hora de leitura, cada lou√ßa lavada e cada ajuda dada √† sua tia e aos seus av√≥s foram fundamentais para formar seu car√°ter e sua disciplina. Ela √© agora uma Ministra do Supremo Tribunal Federal, o cargo mais alto que um jurista pode alcan√ßar. Ela olha para o horizonte e sabe que o c√©u nunca foi o limite, pois ela aprendeu a voar atrav√©s do conhecimento. Sua hist√≥ria √© um farol para todas as meninas que, como ela, sonham grande. Malu provou que com amor, dedica√ß√£o e o apoio da fam√≠lia, qualquer sonho √© poss√≠vel de ser realizado. Ela termina o dia lendo um processo importante, mas com um sorriso no rosto, sabendo que a justi√ßa est√° em boas m√£os: as m√£os de Maria Luiza."
            ],
            medica: [
                "P√°gina 1: Maria Luiza sempre teve um carinho especial pela vida. Desde pequena, ela observava como a natureza se regenerava e como o corpo humano era uma m√°quina perfeita. Quando a pequena Lis nasceu, Malu sentiu uma responsabilidade nova. Ela queria entender cada choro, cada movimento e garantir que sua irm√£zinha crescesse com sa√∫de. No sexto ano, ela j√° se destacava nas feiras de ci√™ncias, apresentando projetos sobre o sistema circulat√≥rio com uma paix√£o que contagiava a todos. Ela come√ßou a sonhar com um estetosc√≥pio de verdade pendurado no pesco√ßo. Malu n√£o queria apenas ser m√©dica por status; ela queria curar as dores que via no mundo. Ela passava as tardes lendo sobre a hist√≥ria da medicina e sobre como as vacinas salvaram bilh√µes de pessoas. O conhecimento era como um rem√©dio que ela tomava todos os dias para fortalecer seu sonho.",
                "P√°gina 2: A disciplina de Malu em casa refletia seu desejo de ser cirurgi√£. Ela sabia que uma cirurgia exigia precis√£o e m√£os firmes, ent√£o ela treinava sua coordena√ß√£o motora em tudo o que fazia. Lavar a lou√ßa sem deixar um pingo de gordura era como limpar um campo cir√∫rgico. Ajudar sua tia acamada era sua primeira pr√°tica cl√≠nica, onde ela aprendia sobre empatia e paci√™ncia. Ela percebeu que a medicina come√ßava no cuidado di√°rio e no olhar atento √†s necessidades do outro. Hayden, seu pai, sempre dizia que uma grande m√©dica precisa ser, antes de tudo, uma grande pessoa. Malu levava isso a s√©rio. Ela come√ßou a estudar biologia avan√ßada por conta pr√≥pria, devorando enciclop√©dias e v√≠deos sobre anatomia. Cada nova descoberta sobre o corpo humano era uma vit√≥ria pessoal que a deixava mais pr√≥xima do seu jaleco branco.",
                "P√°gina 3: No ensino m√©dio, o foco de Maria Luiza era inabal√°vel. Enquanto muitos colegas se distra√≠am, ela estava focada em dominar a qu√≠mica e a f√≠sica, bases essenciais para a medicina moderna. Ela se tornou volunt√°ria em um hospital local nos fins de semana, apenas para observar a rotina dos profissionais. Ela via a correria do pronto-socorro e a calma necess√°ria nos centros cir√∫rgicos. Em vez de se assustar com o sangue ou com a press√£o, ela se sentia em casa. Ela descobriu que tinha uma calma natural em situa√ß√µes de emerg√™ncia. Malu come√ßou a escrever artigos para o jornal da escola sobre h√°bitos saud√°veis, incentivando seus colegas a se cuidarem. Ela j√° agia como uma m√©dica antes mesmo de entrar na faculdade, pois entendia que a preven√ß√£o era o melhor caminho para a sa√∫de coletiva. Sua determina√ß√£o era vis√≠vel para todos.",
                "P√°gina 4: O vestibular de medicina √© conhecido por ser um dos mais dif√≠ceis do mundo. Malu sabia disso e se preparou como uma verdadeira atleta. Ela criou um cronograma de estudos rigoroso, revisando conte√∫dos de manh√£, √† tarde e √† noite. Ela abriu m√£o de muitos momentos de lazer, mas sempre com um sorriso no rosto, pois sabia o que estava em jogo. No dia da prova, ela respirou fundo e lembrou de toda a dedica√ß√£o que teve em casa com suas miss√µes di√°rias. Quando saiu o resultado, seu nome estava na lista dos aprovados de uma universidade federal. Foi um dia de choro e alegria em fam√≠lia. Maria Luiza agora era uma futura m√©dica. Ela recebeu seu primeiro jaleco em uma cerim√¥nia emocionante, onde jurou dedicar sua vida ao servi√ßo da humanidade. A jornada estava apenas come√ßando, e ela estava pronta para os desafios da faculdade.",
                "P√°gina 5: A faculdade de medicina foi um per√≠odo de imers√£o total. Malu passava horas no laborat√≥rio de anatomia, estudando cada nervo e cada art√©ria do corpo humano. Ela se encantou com a complexidade da gen√©tica e com a precis√£o da farmacologia. No terceiro ano, ela come√ßou a frequentar as alas hospitalares como interna. Foi ali que ela teve seu primeiro contato real com pacientes graves. Dra. Maria Luiza, como os pacientes j√° a chamavam carinhosamente, destacava-se pela humanidade. Ela n√£o via apenas doen√ßas; ela via pessoas com hist√≥rias e fam√≠lias. Ela decidiu se especializar em Cirurgia Card√≠aca, a √°rea mais desafiadora da medicina. Ela passava as noites de plant√£o estudando t√©cnicas cir√∫rgicas inovadoras e treinando em simuladores de alta tecnologia. Ela queria ser a melhor para dar aos seus pacientes as melhores chances de vida.",
                "P√°gina 6: Ap√≥s a formatura e anos de resid√™ncia m√©dica exaustiva, Maria Luiza finalmente se tornou uma Cirurgi√£ Card√≠aca titulada. O caminho foi longo e exigiu sacrif√≠cios, mas cada vida salva compensava tudo. Ela se tornou especialista em cirurgias minimamente invasivas, usando pequenos rob√¥s para operar cora√ß√µes com uma precis√£o milim√©trica. Malu era uma das poucas mulheres negras nesse campo de elite, e ela usava sua posi√ß√£o para inspirar outros estudantes. Ela publicou pesquisas em revistas cient√≠ficas internacionais sobre novas formas de tratar arritmias complexas. Ela n√£o parava de estudar, pois a medicina evolu√≠a a cada segundo. Seu pai Hayden assistia orgulhoso √†s palestras da filha, lembrando-se de quando ela ganhava minutos de internet por ajudar em casa. A disciplina da inf√¢ncia havia se transformado em uma carreira de excel√™ncia mundial.",
                "P√°gina 7: Um momento marcante na carreira da Dra. Maria Luiza foi quando ela liderou o primeiro transplante de cora√ß√£o artificial em uma crian√ßa no pa√≠s. O caso era desesperador, e a tecnologia era nova. Muitos m√©dicos hesitaram, mas Malu, ap√≥s noites analisando os riscos e as possibilidades, decidiu prosseguir. A cirurgia durou 12 horas seguidas. Sob as luzes do centro cir√∫rgico, ela comandou sua equipe com uma serenidade impressionante. Cada movimento era calculado, cada ponto era perfeito. Quando o novo cora√ß√£o come√ßou a bater ritmicamente, um sil√™ncio de al√≠vio tomou conta da sala. A cirurgia foi um sucesso total e virou capa de jornais ao redor do mundo. Maria Luiza n√£o era apenas uma cirurgi√£; ela era uma pioneira, abrindo fronteiras na medicina e dando esperan√ßa a milhares de fam√≠lias que aguardavam por milagres.",
                "P√°gina 8: O reconhecimento internacional levou a Dra. Maria Luiza a chefiar o departamento de cirurgia de um dos maiores hospitais de Nova York. Ela agora gerenciava equipes de m√©dicos de todo o mundo, mas nunca perdeu sua ess√™ncia brasileira e o carinho com que tratava cada paciente. Ela criou um programa de interc√¢mbio para m√©dicos de pa√≠ses em desenvolvimento, permitindo que eles aprendessem as t√©cnicas mais modernas para levar de volta √†s suas comunidades. Malu tamb√©m se tornou uma defensora da sa√∫de p√∫blica, lutando para que as tecnologias que ela usava em hospitais de luxo chegassem tamb√©m aos hospitais comunit√°rios. Ela acreditava que o acesso √† sa√∫de de qualidade era um direito humano fundamental e usava sua influ√™ncia para pressionar governos a investirem mais em ci√™ncia e tecnologia para todos.",
                "P√°gina 9: Maria Luiza tornou-se Diretora da Organiza√ß√£o Mundial da Sa√∫de (OMS). Agora, sua influ√™ncia n√£o era apenas sobre pacientes individuais, mas sobre a sa√∫de de todo o planeta. Ela coordenou respostas globais a pandemias e liderou campanhas de erradica√ß√£o de doen√ßas em continentes inteiros. Ela era respeitada por l√≠deres mundiais e amada pelas popula√ß√µes que ela protegia. Mesmo com uma agenda lotada, ela fazia quest√£o de voltar ao Brasil todos os anos para visitar sua fam√≠lia e realizar cirurgias gratuitas em crian√ßas carentes. Ela nunca esqueceu que sua jornada come√ßou com o cuidado com a pequena Lis e com a aten√ß√£o dada √† sua tia e av√¥. Maria Luiza era a prova viva de que a medicina mais poderosa √© aquela feita com conhecimento t√©cnico de ponta e um cora√ß√£o transbordando de amor ao pr√≥ximo.",
                "P√°gina 10: Ao se aposentar da vida p√∫blica, Maria Luiza fundou a 'Funda√ß√£o Malu', dedicada a dar bolsas de estudo para meninas negras que sonham em seguir carreiras cient√≠ficas. Ela olha para as fotos de sua formatura e sente que cumpriu seu prop√≥sito. Ela √© agora uma lenda viva na medicina, com hospitais e universidades levando seu nome. Mas para ela, o maior t√≠tulo ainda √© o de filha e irm√£. Ela senta em sua varanda, olha para as estrelas e sorri, lembrando daquela p√°gina de HTML que seu pai criou para incentiv√°-la a ler. Ela sabe que cada minuto de leitura daquela √©poca foi o alicerce para as d√©cadas de sucesso que vieram depois. Maria Luiza termina sua hist√≥ria como come√ßou: sendo uma fonte de luz, cura e inspira√ß√£o para o mundo inteiro. Sua jornada √© eterna, pois vive em cada cora√ß√£o que ela ajudou a bater mais forte."
            ]
        };

        function startReading(key) {
            if (storyReadToday) {
                // EM VEZ DO ALERT, CHAMA O MODAL L√öDICO:
                document.getElementById('leitura-concluida-modal').style.display = 'flex';
                return;
            }
            currentStoryKey = key;
            currentPage = 1;
            timeLeft = 20 * 60;

            document.getElementById('book-title').innerText = "Lendo: " + key.toUpperCase();
            updatePage();
            document.getElementById('reading-modal').style.display = 'flex';
            document.getElementById('finish-btn').disabled = true;

            startTimers();
        }

        document.addEventListener("visibilitychange", function () {
            if (document.hidden && !attentionActive && timeLeft > 0 && currentStoryKey !== '') {
                triggerAttentionPopup("Malu, n√£o saia da p√°gina! üå∏", "A leitura precisa ser feita sem trocar de aba para contar o tempo.");
            }
        });

        // Registra qualquer intera√ß√£o (Toque, Mouse ou Teclado)
        function registrarInteracao() {
            lastInteractionTime = Date.now();
        }

        document.addEventListener("mousemove", registrarInteracao);
        document.addEventListener("keydown", registrarInteracao);
        document.addEventListener("touchstart", registrarInteracao);

        // O cron√¥metro agora s√≥ funciona se isRecording for true
        function startTimers() {
            clearInterval(readingTimer);
            readingTimer = setInterval(() => {
                if (!attentionActive && isRecording && timeLeft > 0) { // TRAVA: isRecording obrigat√≥rio
                    timeLeft--;
                    updateTimerDisplay();

                    if (Date.now() - lastInteractionTime > INACTIVITY_LIMIT) {
                        triggerAttentionPopup("Malu, voc√™ ainda est√° lendo? üëÄ", "O tempo parou porque n√£o detectamos movimento.");
                    }
                }
            }, 1000);
        }

        let timerInterval;

        // Altera√ß√£o na fun√ß√£o do Timer para respeitar a grava√ß√£o
        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                // O tempo s√≥ desce se estiver gravando!
                if (isRecording && timeLeft > 0) {
                    timeLeft--;
                    updateTimerDisplay();
                }
            }, 1000);
        }

        // 1. Bloqueio de Atualiza√ß√£o/Fechamento
        window.addEventListener('beforeunload', (event) => {
            if (podeSairDaPagina) return; // Se for uma a√ß√£o permitida, n√£o mostra o aviso
            event.preventDefault();
            event.returnValue = "Malu, voc√™ ainda n√£o terminou suas miss√µes! Quer mesmo sair?";
        });

        // 2. L√≥gica de Grava√ß√£o
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        let audioUrlParaEnviar = null;

        async function toggleRecording() {
            if (!isRecording) {
                try {
                    // Verifica se o navegador suporta getUserMedia
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        alert("Seu navegador n√£o suporta grava√ß√£o de √°udio ou voc√™ est√° em um site sem HTTPS (seguran√ßa).");
                        return;
                    }

                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                        audioUrlParaEnviar = URL.createObjectURL(audioBlob);
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    document.getElementById('btn-gravacao').innerText = "üõë Parar Leitura";
                    document.getElementById('rec-indicator').style.display = 'flex';
                } catch (err) {
                    console.error("Erro ao acessar microfone:", err);
                    // Se o erro for de permiss√£o negada
                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        mostrarAviso("Microfone Bloqueado", "Malu, clique no cadeado l√° em cima perto do endere√ßo do site e permita o uso do microfone! üéôÔ∏è", "‚ö†Ô∏è");
                    } else {
                        alert("Erro ao ligar o microfone. Verifique se o site tem HTTPS.");
                    }
                }
            } else {
                if (mediaRecorder && mediaRecorder.state !== "inactive") {
                    mediaRecorder.stop();
                }
                isRecording = false;
                document.getElementById('btn-gravacao').innerText = "‚úÖ Leitura Gravada!";
                document.getElementById('btn-gravacao').style.background = "#2ecc71";
                document.getElementById('rec-indicator').style.display = 'none';
                checkReadyToFinish();
            }
        }

        // 3. Efeito de P√°gina e Ergonomia
        function changePage(direction) {
            const content = document.getElementById('page-content');
            content.classList.add('page-flip-anim');

            setTimeout(() => {
                if (direction === 1 && currentPage < 10) currentPage++;
                if (direction === -1 && currentPage > 1) currentPage--;

                updatePage();
                content.scrollTop = 0; // Volta o scroll pro topo na nova p√°gina
                content.classList.remove('page-flip-anim');
            }, 300);
        }

        function checkReadyToFinish() {
            if (timeLeft <= 0 && audioChunks.length > 0) {
                document.getElementById('finish-btn').disabled = false;
            }
        }

        // Atualize o updateTimerDisplay original para chamar o checkReadyToFinish
        function updateTimerDisplay() {
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            const display = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            document.getElementById('timer-count').innerText = display;

            if (timeLeft <= 0) {
                clearInterval(readingTimer);
                const btnConcluir = document.getElementById('finish-btn');
                btnConcluir.disabled = false; // Habilita o bot√£o
                btnConcluir.style.opacity = "1";
                btnConcluir.style.background = "var(--purple)"; // Garante que fique colorido
                btnConcluir.innerText = "Concluir e Ganhar Recompensa! üèÜ";
            }
        }

        function triggerAttentionPopup(titulo, mensagem) {
            if (attentionActive) return; // Evita abrir v√°rios popups

            attentionActive = true;
            const attModal = `
            <div id="attention-modal" class="modal" style="display:flex; z-index:3000;">
                <div class="modal-content" style="border-color: var(--yellow);">
                    <h1 style="font-size: 3rem;">üëÄ</h1>
                    <h2 style="font-family: 'Fredoka One'; color: var(--purple);">${titulo}</h2>
                    <p>${mensagem}</p>
                    <button class="btn" style="background: var(--purple);" onclick="resumeReading()">Estou aqui! Continuar üìñ</button>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', attModal);
        }

        function resumeReading() {
            attentionActive = false;
            registrarInteracao(); // Reseta o contador de inatividade ao voltar
            const modal = document.getElementById('attention-modal');
            if (modal) modal.remove();
        }

        // Substitui√ß√£o do Alert
        function mostrarAviso(titulo, mensagem, emoji = "üå∏") {
            document.getElementById('custom-alert-title').innerText = titulo;
            document.getElementById('custom-alert-message').innerText = mensagem;
            document.getElementById('custom-alert-emoji').innerText = emoji;
            document.getElementById('custom-alert-modal').style.display = 'flex';
        }

        // Substitui√ß√£o da fun√ß√£o fecharLeitura (Imagem 4)
        function fecharLeitura() {
            const msg = "Malu, se fechar agora o tempo da hist√≥ria vai recome√ßar. Quer mesmo sair? ü•∫";
            document.getElementById('custom-confirm-message').innerText = msg;
            document.getElementById('custom-confirm-modal').style.display = 'flex';

            document.getElementById('confirm-yes').onclick = function () {
                clearInterval(readingTimer);
                timeLeft = 1200; // Alterado para 1200 segundos (20 minutos)
                updateTimerDisplay();

                if (isRecording) {
                    toggleRecording();
                }

                closeModal('custom-confirm-modal');
                closeModal('reading-modal');
            };
        }

        // Ajuste na fun√ß√£o perderJogo (Para n√£o usar alert nativo)
        function perderJogo() {
            mostrarAviso("Tempo Esgotado!", "Voc√™ perdeu 30 minutos. Tente ser mais r√°pida na pr√≥xima! ‚è≥", "üò¢");
            totalMinutes = Math.max(0, totalMinutes - 30);
            document.getElementById('total-min').innerText = totalMinutes;
            closeModal('game-modal');
        }

        // Fun√ß√µes auxiliares (reutilizadas do seu c√≥digo original)
        function updatePage() {
            const storyArr = stories[currentStoryKey] || stories['advogada'];
            document.getElementById('page-content').innerHTML = `<p style="text-align: justify; margin: 0;">${storyArr[currentPage - 1]}</p>`;
            document.getElementById('current-page').innerText = currentPage;
        }
        function nextPage() { if (currentPage < 10) { currentPage++; updatePage(); } }
        function prevPage() { if (currentPage > 1) { currentPage--; updatePage(); } }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openCuriosities() { updateCuriosityHeader(); document.getElementById('curiosity-display').style.display = 'none'; document.getElementById('curiosity-buttons').style.display = 'grid'; document.getElementById('curiosity-modal').style.display = 'flex'; }
        function updateCuriosityHeader() {
            const modalContent = document.querySelector('#curiosity-modal .modal-content');
            let limitInfo = document.getElementById('limit-info');
            if (!limitInfo) {
                limitInfo = document.createElement('div');
                limitInfo.id = 'limit-info';
                limitInfo.className = 'daily-limit-info';
                modalContent.insertBefore(limitInfo, document.getElementById('curiosity-buttons'));
            }
            limitInfo.innerText = `Voc√™ j√° viu ${curiositiesViewedToday} de ${MAX_CURIOSITIES_PER_DAY} curiosidades de hoje!`;
        }

        function nextPage() { if (currentPage < 10) { currentPage++; updatePage(); } }
        function prevPage() { if (currentPage > 1) { currentPage--; updatePage(); } }

        function rewardReading() {
            totalMinutes += 30;
            storyReadToday = true;
            document.getElementById('total-min').innerText = totalMinutes;
            closeModal('reading-modal');
            salvarProgressoAtual();
            gravarTudoInstantaneo(); // Salva no Supabase
            checkAllDone();
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // Vari√°veis de controle para o limite di√°rio

        const curiosidadesReais = {
            direito1: `Voc√™ sabia que a advocacia √© uma das profiss√µes mais antigas da humanidade? O primeiro c√≥digo de leis escrito foi o C√≥digo de Hamurabi, h√° quase 4.000 anos, na Mesopot√¢mia! Imagine viver numa √©poca onde n√£o existiam advogados. Se algu√©m pegasse seu brinquedo, n√£o tinha para quem reclamar! Hamurabi decidiu que o mundo precisava de ordem. Na Roma Antiga, os advogados eram t√£o respeitados que n√£o podiam cobrar dinheiro; eles trabalhavam pela honra e pela gl√≥ria de ajudar as pessoas. Malu, uma advogada n√£o apenas l√™ livros, ela √© uma "detetive das palavras". Ela precisa encontrar o erro que ningu√©m mais viu para provar a verdade. Hoje em dia, existem advogados especialistas em coisas que voc√™ nem imagina, como Direito Espacial (leis para quem vai para a Lua!) e Direito Digital (leis para a internet). Ser advogada exige que voc√™ seja uma excelente leitora, porque cada p√°gina de um processo pode esconder a pe√ßa do quebra-cabe√ßa que salva uma pessoa inocente. Imagine-se num tribunal, com uma beca preta elegante, falando para um juiz e convencendo todo mundo com a sua intelig√™ncia. Isso n√£o √© apenas um trabalho, √© o superpoder de usar a voz para trazer justi√ßa ao mundo!`,

            medicina1: `A medicina √© cheia de mist√©rios! Sabia que o primeiro estetosc√≥pio foi inventado por um m√©dico que tinha vergonha de encostar o ouvido no peito das pacientes? Em 1816, o Dr. Ren√© Laennec enrolou um peda√ßo de papel e percebeu que o som do cora√ß√£o ficava muito mais forte! Antes disso, os m√©dicos eram quase "adivinhos". Dra. Malu, voc√™ sabia que dentro do seu corpo existe um ex√©rcito de c√©lulas que nunca dorme? Os m√©dicos s√£o como os generais desse ex√©rcito. Uma curiosidade incr√≠vel: as cirurgias hoje podem ser feitas por rob√¥s controlados por m√©dicos a quil√¥metros de dist√¢ncia! Um m√©dico no Brasil pode operar algu√©m no Jap√£o. Isso exige que a m√©dica tenha m√£os de artista e nervos de a√ßo. Cada batida do cora√ß√£o de um paciente √© uma m√∫sica que s√≥ o m√©dico entende. Na faculdade de medicina, voc√™ aprende que o corpo humano √© mais complexo que qualquer computador do mundo. O c√©rebro tem bilh√µes de neur√¥nios mandando mensagens na velocidade da luz! Estudar medicina √© como aprender uma l√≠ngua m√°gica que permite que voc√™ entenda o que o corpo est√° dizendo sem ele usar palavras. √â a ci√™ncia de salvar o amanh√£ de algu√©m.`,

            arquitetura1: `Arquitetos s√£o os verdadeiros magos que transformam papel em montanhas de concreto! Voc√™ sabia que existem cidades inteiras sendo projetadas para flutuar no oceano? Com o n√≠vel do mar subindo, arquitetos na Coreia do Sul est√£o criando ilhas artificiais que sobem e descem com as ondas. Um arquiteto n√£o pensa s√≥ em paredes, Malu. Ele pensa em como o sol vai bater na sua janela de manh√£ para te acordar feliz. Sabia que a Grande Muralha da China foi constru√≠da usando arroz doce na mistura do cimento? Isso a deixou t√£o forte que dura milhares de anos! Arquitetura √© a mistura perfeita de matem√°tica, arte e psicologia. Voc√™ precisa saber se as pessoas v√£o se sentir abra√ßadas por um pr√©dio ou se v√£o se sentir perdidas. Existem pr√©dios em Dubai que giram 360 graus! Cada morador pode escolher a vista que quer ter da janela naquele dia. Ser arquiteta do futuro, como voc√™, significa criar casas que produzem sua pr√≥pria energia e que podem at√© ser impressas em impressoras 3D gigantes!`,

            piloto1: `Voc√™ j√° se perguntou como um avi√£o de 500 toneladas consegue ficar no ar como se fosse um passarinho? A resposta √© pura ci√™ncia e coragem! Os pilotos de avi√£o precisam entender de f√≠sica, clima e at√© um pouco de psicologia para manter todo mundo calmo. Sabia que o vidro da frente de um avi√£o √© t√£o forte que pode aguentar o impacto de um p√°ssaro a 800 km/h sem quebrar? E uma curiosidade que quase ningu√©m sabe: os pilotos e os copilotos nunca comem a mesma comida durante o voo! Isso √© para garantir que, se um passar mal, o outro esteja bem para pousar. Voar √© como dirigir em um mapa 3D onde n√£o existem estradas vis√≠veis, apenas rios de ar chamados correntes de jato. Quando voc√™ √© piloto, o mundo inteiro vira o seu quintal. Voc√™ pode tomar caf√© em Paris e jantar em Nova York. O painel de um avi√£o tem centenas de bot√µes, mas o mais importante √© o c√©rebro do piloto, que precisa tomar decis√µes r√°pidas em segundos. √â a profiss√£o de quem quer ver o mundo de cima!`,

            direito2: `Malu, voc√™ sabia que existem leis t√£o antigas e estranhas que ainda est√£o nos livros? Na Inglaterra, por exemplo, existe uma lei de centenas de anos que diz que todos os cisnes do pa√≠s pertencem √† Rainha (ou ao Rei)! Ser advogada √© entender que as leis mudam conforme a sociedade cresce. Antigamente, as mulheres nem podiam votar, e foram advogadas corajosas que lutaram para mudar isso. O Direito protege at√© as suas ideias! Se voc√™ criar um desenho ou uma hist√≥ria, o Direito Autoral garante que ningu√©m possa copiar sem sua permiss√£o. Uma advogada de sucesso precisa ser muito curiosa e gostar de investigar. √Äs vezes, a solu√ß√£o de um caso n√£o est√° no que as pessoas dizem, mas num pequeno detalhe num documento esquecido. Voc√™ sabia que a primeira advogada do Brasil foi uma mulher negra chamada Esperan√ßa Garcia? Ela escreveu uma carta ao governador pedindo direitos e justi√ßa muito antes de ser comum mulheres estudarem. Isso mostra que o Direito √© a ferramenta mais forte que temos para mudar o mundo e defender quem n√£o pode se defender sozinho!`,

            medicina2: `Prepare o seu estetosc√≥pio, Dra. Malu, porque essa √© de arrepiar: o c√©rebro humano √© o "mestre" do corpo, mas ele mesmo n√£o sente dor! Se um m√©dico tocasse no c√©rebro durante uma cirurgia, o paciente n√£o sentiria nada, porque o c√©rebro n√£o tem receptores de dor. Ele sente a dor de todo o resto do corpo, mas se esquece de si mesmo. Sabia que o seu cora√ß√£o bate cerca de 100 mil vezes por dia? Ele √© o motor que nunca para. E tem mais: os m√©dicos descobriram que o riso realmente √© um rem√©dio! Quando voc√™ ri, seu corpo solta subst√¢ncias que ajudam a curar doen√ßas e relaxar os m√∫sculos. Na medicina do futuro, os m√©dicos usar√£o min√∫sculas c√¢meras que voc√™ engole como se fosse uma p√≠lula para ver tudo por dentro sem precisar de cortes. Ser m√©dica exige que voc√™ seja uma eterna estudante, pois cada pessoa √© um universo diferente. Voc√™ sabia que temos mais bact√©rias no corpo do que estrelas na nossa gal√°xia? Mas n√£o se assuste, a maioria delas s√£o nossas amigas e nos ajudam a crescer fortes!`,

            arquitetura2: `Malu, imagine construir um castelo inteirinho sem usar um pingo de cimento ou cola. Os antigos Incas faziam isso! Eles cortavam as pedras com tanta perfei√ß√£o que elas se encaixavam como um Lego gigante, e nem uma folha de papel passava entre elas. Isso √© arquitetura de alto n√≠vel! Hoje, os arquitetos est√£o criando pr√©dios que "respiram". Em Mil√£o, existem pr√©dios chamados "Bosque Vertical", que s√£o cobertos por centenas de √°rvores e plantas que limpam o ar da cidade. Sabia que a cor das paredes da sua escola ou do seu quarto pode mudar o seu humor? Arquitetos estudam a psicologia das cores: o azul acalma, o amarelo d√° energia e o verde ajuda a focar nos estudos. Um arquiteto tamb√©m precisa ser um pouco engenheiro espacial: j√° existem projetos de casas para Marte que seriam feitas de gelo ou solo de l√° mesmo para proteger os astronautas da radia√ß√£o. Desenhar uma casa √© desenhar o cen√°rio onde a vida de uma fam√≠lia vai acontecer. √â criar um lugar seguro, bonito e m√°gico para as pessoas viverem seus sonhos!`,

            piloto2: `Malu, voc√™ tem medo de tempestades? Pois saiba que os avi√µes s√£o atingidos por raios o tempo todo e nada acontece com quem est√° dentro! Isso acontece porque o avi√£o funciona como uma "Gaiola de Faraday" ‚Äì a eletricidade corre por fora da fuselagem e vai embora sem dar nem um choquinho nos passageiros. Incr√≠vel, n√©? Outra curiosidade: os pneus de um avi√£o s√£o cheios de nitrog√™nio para n√£o explodirem com o calor imenso do pouso. E voc√™ sabia que o ar que voc√™ respira dentro do avi√£o √© mais limpo que o ar de muitos escrit√≥rios, porque passa por filtros super potentes iguais aos dos hospitais? Ser piloto √© ter uma vis√£o de √°guia. Eles usam radares que mostram as nuvens de chuva a quil√¥metros de dist√¢ncia, permitindo que o avi√£o desvie e o voo continue calmo. Quando um piloto decola, ele entra em um mundo onde as nuvens s√£o o ch√£o e o sol brilha quase o tempo todo acima delas. √â uma profiss√£o de liberdade, mas de muita responsabilidade, pois o piloto √© o guardi√£o de todas as vidas que est√£o l√° no c√©u com ele!`,

            extra1: `Voc√™ j√° ouviu falar em Engenharia de Minas Espacial? Malu, no futuro, os profissionais v√£o minerar asteroides para buscar diamantes e metais preciosos! O espa√ßo √© a nova fronteira das profiss√µes. Existem pessoas que trabalham hoje apenas para criar comidas que n√£o flutuam no espa√ßo, para que os astronautas possam comer sem fazer bagun√ßa. Sabia que no espa√ßo os astronautas ficam mais altos? Sem a gravidade da Terra empurrando para baixo, a coluna estica um pouquinho! No Direito, j√° existem discuss√µes sobre quem seria o "dono" de um terreno na Lua. Na Medicina, estudam como o cora√ß√£o se comporta quando n√£o existe peso. O futuro est√° cheio de profiss√µes que ainda nem t√™m nome, e todas elas precisam de algu√©m que goste de ler, pesquisar e nunca parar de perguntar "por que?". Quem sabe voc√™ n√£o ser√° a primeira advogada ou m√©dica a trabalhar em uma esta√ß√£o espacial fora da Terra? O universo √© literalmente o limite!`,

            extra2: `Voc√™ sabia que existem "Designers de Sonhos" na vida real? S√£o os arquitetos e engenheiros que criam os parques da Disney! Eles s√£o chamados de "Imagineers". Eles misturam contos de fadas com alta tecnologia para criar experi√™ncias que parecem m√°gicas. Para ser um deles, voc√™ precisa ser bom em matem√°tica, mas tamb√©m ter uma imagina√ß√£o gigante. Eles estudam at√© o cheiro dos lugares! Sabia que na Disney eles soltam cheiro de pipoca e baunilha nas ruas para que voc√™ se sinta feliz e com fome? Isso √© design sensorial. Outra profiss√£o incr√≠vel √© a de Arque√≥logo Subaqu√°tico, que explora cidades que afundaram h√° milhares de anos. Ser um profissional de sucesso √© saber que voc√™ pode misturar seus hobbies com o seu trabalho. Se voc√™ gosta de desenhar e de justi√ßa, pode ser uma arquiteta de tribunais. Se gosta de beb√™s e de ci√™ncia, pode ser uma m√©dica pediatra. O mundo √© como uma tela em branco, e seus estudos s√£o os pinc√©is que voc√™ vai usar para pintar o seu futuro!`,
        };

        function openCuriosities() {
            updateCuriosityHeader();
            document.getElementById('curiosity-display').style.display = 'none';
            document.getElementById('curiosity-buttons').style.display = 'grid';
            document.getElementById('curiosity-modal').style.display = 'flex';
        }

        function updateCuriosityHeader() {
            const modalContent = document.querySelector('#curiosity-modal .modal-content');
            let limitInfo = document.getElementById('limit-info');

            if (!limitInfo) {
                limitInfo = document.createElement('div');
                limitInfo.id = 'limit-info';
                limitInfo.className = 'daily-limit-info';
                modalContent.insertBefore(limitInfo, document.getElementById('curiosity-buttons'));
            }

            limitInfo.innerText = `Voc√™ j√° viu ${curiositiesViewedToday} de ${MAX_CURIOSITIES_PER_DAY} curiosidades de hoje!`;
        }

        function showCuriosity(key) {
            if (curiositiesViewedToday >= MAX_CURIOSITIES_PER_DAY) {
                alert("Malu, voc√™ j√° aprendeu 2 curiosidades hoje! Amanh√£ tem mais. üåü");
                return;
            }

            const display = document.getElementById('curiosity-display');
            const buttons = document.getElementById('curiosity-buttons');
            curiosityTimeLeft = 4 * 60; // 4 minutos obrigat√≥rios

            display.innerHTML = `
            <p>${curiosidadesReais[key]}</p>
            <div id="curiosity-timer-box" style="color:var(--dark-pink); font-weight:bold; margin: 10px 0;">
                Aguarde <span id="c-timer">4:00</span> para resgatar seu pr√™mio...
            </div>
            <button id="claim-c-btn" class="btn" style="display:none; background:var(--yellow); color:#333;" onclick="claimCuriosityReward()">
                Pegar meu pr√™mio (+10 min) üéÅ
            </button>`;

            buttons.style.display = 'none';
            display.style.display = 'block';

            clearInterval(curiosityTimer);
            curiosityTimer = setInterval(() => {
                curiosityTimeLeft--;
                let m = Math.floor(curiosityTimeLeft / 60);
                let s = curiosityTimeLeft % 60;
                document.getElementById('c-timer').innerText = `${m}:${s < 10 ? '0' + s : s}`;

                if (curiosityTimeLeft <= 0) {
                    clearInterval(curiosityTimer);
                    document.getElementById('curiosity-timer-box').style.display = 'none';
                    document.getElementById('claim-c-btn').style.display = 'inline-block';
                }
            }, 1000);
        }

        async function claimCuriosityReward() {
            if (!currentCuriosity || !usuarioLogado) return;

            // 1. Busca os dados mais recentes do banco para garantir sincronia
            const { data } = await supabaseClient
                .from('usuarios_malu')
                .select('dados_progresso')
                .eq('id', usuarioLogado.id)
                .single();

            let leiturasNuvem = data.dados_progresso.leituras || [];

            // 2. Verifica se este ID j√° foi lido hoje
            if (!leiturasNuvem.includes(currentCuriosity.id)) {
                leiturasNuvem.push(currentCuriosity.id);

                // Atualiza localmente
                totalMinutes += 5;
                document.getElementById('total-min').innerText = totalMinutes;
                localStorage.setItem('curiosidadesLidas', JSON.stringify(leiturasNuvem));

                // 3. Grava no banco instantaneamente
                await gravarTudoInstantaneo();
                await registrarLogPai("Leitura", `Malu leu: ${currentCuriosity.titulo}`, 5);

                fecharCuriosidade();
                mostrarAviso("Incr√≠vel!", "Voc√™ aprendeu algo novo e ganhou 5 minutos!", "üí°");
            } else {
                alert("Voc√™ j√° ganhou o b√¥nus por esta leitura hoje! ‚ú®");
            }
        }

        async function gerarECompartilharCertificado() {
            const { jsPDF } = window.jspdf || {};
            if (!jsPDF) {
                alert("Erro: Biblioteca de PDF n√£o carregada!");
                return;
            }

            // --- MELHORIA AQUI: Limpa o nome para n√£o vir "Boa noite, Hayden!" ---
            let nomeUsuario = nomeUsuarioLogado || "";

            // Se a vari√°vel estiver vazia, pega do HTML e remove sauda√ß√µes comuns
            if (!nomeUsuario) {
                nomeUsuario = document.getElementById('welcome-name').innerText
                    .replace(/Bom dia, |Boa tarde, |Boa noite, |Bem-vinda, /gi, "")
                    .replace(/!/g, "")
                    .trim();
            }

            // Formata√ß√£o especial para a Malu ou nome limpo para os outros
            const nomeExibicao = (nomeUsuario.toLowerCase().includes("malu"))
                ? "Dra. Maria Luiza Ba√≠a Fernandes"
                : nomeUsuario;

            const doc = new jsPDF({ orientation: "landscape", unit: "mm", format: "a5" });

            const hoje = new Date().toLocaleDateString('pt-BR');

            // --- FUNDO E BORDAS ---
            doc.setFillColor(255, 240, 245);
            doc.rect(0, 0, 210, 148, 'F');
            doc.setDrawColor(255, 133, 162);
            doc.setLineWidth(2);
            doc.rect(5, 5, 200, 138);
            doc.setLineWidth(0.5);
            doc.rect(7, 7, 196, 134);

            // --- T√çTULO ---
            doc.setTextColor(125, 95, 255);
            doc.setFont("helvetica", "bold");
            doc.text(String(nomeExibicao), 105, 45, { align: "center" });
            doc.text("CERTIFICADO DE EXCEL√äNCIA", 105, 25, { align: "center" });

            // --- NOME COMPLETO (ALTERADO AQUI) ---
            doc.setTextColor(255, 71, 126);
            doc.setFontSize(22);
            doc.text(nomeExibicao, 105, 45, { align: "center" }); // <--- Usando o nome din√¢mico

            // --- TEXTO DE M√âRITO (ALTERADO AQUI) ---
            doc.setTextColor(60, 60, 60);
            doc.setFontSize(13);
            doc.setFont("helvetica", "normal");
            // Substitu√≠mos "Maria Luiza" por ${nomeUsuario} na mensagem
            const mensagem = `Certificamos que nesta data, ${nomeUsuario} completou com distin√ß√£o todas as suas miss√µes di√°rias, demonstrando os valores de responsabilidade e dedica√ß√£o necess√°rios, acumulando ${totalMinutes} minutos de b√¥nus.`;
            const splitText = doc.splitTextToSize(mensagem, 160);
            doc.text(splitText, 105, 60, { align: "center" });

            // ... (restante do c√≥digo de miss√µes e assinatura) ...
            // --- LISTA DE CONQUISTAS ---
            doc.setFontSize(10);
            doc.setTextColor(125, 95, 255);
            doc.text("‚Ä¢ Miss√µes de Car√°ter OK", 45, 85);
            doc.text("‚Ä¢ Leitura Educativa OK", 45, 92);
            doc.text("‚Ä¢ Curiosidades Profissionais OK", 45, 99);

            // --- √ÅREA DA ASSINATURA ---
            doc.setDrawColor(150, 150, 150);
            doc.setLineWidth(0.5);
            doc.line(120, 110, 180, 110);
            doc.setTextColor(30, 30, 90);
            doc.setFont("times", "italic");
            doc.setFontSize(16);
            doc.text("Hayden Fernandes", 150, 107, { align: "center" });
            doc.setTextColor(100, 100, 100);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(8);
            doc.text("Assinatura do Respons√°vel", 150, 115, { align: "center" });
            doc.text(`Emitido em: ${hoje}`, 150, 119, { align: "center" });

            // --- SELO DOURADO ---
            doc.setDrawColor(254, 202, 87);
            doc.setFillColor(254, 202, 87);
            doc.setLineWidth(1);
            doc.circle(35, 115, 12, 'FD');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.text("TOP", 35, 114, { align: "center" });
            doc.text("ALUNA", 35, 118, { align: "center" });

            doc.save(`Certificado_${nomeLimpo}_${hoje.replace(/\//g, '-')}.pdf`);

            // --- SALVAMENTO (ALTERADO AQUI) ---
            const nomeArquivo = `Certificado_${nomeUsuario.replace(/\s/g, '_')}_${hoje.replace(/\//g, '-')}.pdf`;
            doc.save(nomeArquivo);

            // --- WHATSAPP (ALTERADO AQUI) ---
            let msgZap = `‚ú® MISS√ÉO CUMPRIDA! ‚ú®\n\nEu, ${nomeExibicao}, acabo de gerar meu certificado oficial!\nConquistei ${totalMinutes} minutos de pr√™mio hoje!\n\nOrgulho da fam√≠lia! üöÄ`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msgZap)}`, '_blank');

            // ... (resto do c√≥digo de hist√≥rico e popup final) ...
            let historico = JSON.parse(localStorage.getItem('historicoCertificados')) || [];
            historico.push(new Date().toLocaleString());
            localStorage.setItem('historicoCertificados', JSON.stringify(historico));

            const finalModal = `
            div id="parabens-final" class="modal" style="display:flex; z-index: 9999;">
                <div class="modal-content" style="border-color: var(--yellow); text-align: center;">
                    <h1>üåà</h1>
                    <h2 style="font-family: 'Fredoka One'; color: var(--purple);">VOC√ä √â INCR√çVEL!</h2>
                    <p>O certificado foi gerado e o aviso enviado para o Papai!</p>
                    <button class="btn" onclick="reiniciarSistema()">At√© amanh√£! üëã</button>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', finalModal);

            totalMinutes = 0;
            document.getElementById('total-min').innerText = "0";
        }



        // Fun√ß√£o nova para limpar tudo e evitar o erro do navegador
        function reiniciarSistema() {
            localStorage.removeItem('progressoMalu'); // Limpa as tarefas marcadas
            // Redireciona para a pr√≥pria p√°gina para limpar o estado do JS de forma limpa
            window.location.href = window.location.pathname + '?reset=' + Date.now();
        }


        // Backup Autom√°tico JSON
        function fazerBackupAuto() {
            // Mostra o popup l√∫dico
            document.getElementById('backup-modal').style.display = 'flex';

            setTimeout(() => {
                const dados = {
                    totalMinutes: totalMinutes,
                    data: new Date().toLocaleDateString(),
                    missoes: missionsCompletedCount
                };

                const blob = new Blob([JSON.stringify(dados)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `memorias_da_malu.json`;
                a.click();

                // Esconde o popup ap√≥s 2.5 segundos
                setTimeout(() => {
                    closeModal('backup-modal');
                }, 500);
            }, 2000);
        }

        // Chame fazerBackupAuto() dentro da sua fun√ß√£o gerarECompartilharCertificado()

        // --- FUN√á√ÉO DE RESTAURA√á√ÉO CORRIGIDA ---
        function restaurarBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const dados = JSON.parse(e.target.result);

                    // Se o backup veio do seu formato antigo ou novo, ele tenta ler
                    totalMinutes = dados.totalMinutes || dados.minutos || 0;
                    missionsCompletedCount = dados.missoes || dados.missoesCount || 0;

                    // Atualiza a tela
                    document.getElementById('total-min').innerText = totalMinutes;

                    // Salva no LocalStorage imediatamente ap√≥s restaurar
                    salvarProgressoAtual();

                    mostrarAviso("Backup Restaurado!", "Suas mem√≥rias voltaram, Malu! ‚ú®", "‚òÅÔ∏è");
                    setTimeout(() => { location.reload(); }, 1500); // Recarrega para aplicar visual
                } catch (err) {
                    console.error("Erro na restaura√ß√£o:", err);
                    alert("Erro ao ler o arquivo de backup. Verifique se o arquivo est√° correto.");
                }
            };
            reader.readAsText(file);
        }

        // Altere sua l√≥gica de mostrarBloqueioTempoRestante para verificar as 08:00
        function mostrarBloqueioTempoRestante(ultimaConclusao) {
            const agora = new Date();
            const amanha = new Date();
            amanha.setDate(amanha.getDate() + 1);
            amanha.setHours(8, 0, 0, 0); // Define 08:00 do dia seguinte

            const tempoRestante = amanha - agora;

            if (tempoRestante <= 0) {
                // Se j√° passou das 08:00 do dia seguinte, libera!
                localStorage.removeItem('ultimaConclusaoData');
                return;
            }

            const horas = Math.floor(tempoRestante / (1000 * 60 * 60));
            const minutos = Math.floor((tempoRestante % (1000 * 60 * 60)) / (1000 * 60));

            // Criar o HTML do bloqueio com a Lua e Estrelas
            const bloqueioHTML = `
                < div id = "bloqueio-modal" class="modal night-bg" style = "display:flex" >
                <div class="moon">üåô</div>
                <div id="stars-container"></div>
                
                <div class="modal-content" style="border: 10px solid #7d5fff; background: rgba(255, 255, 255, 0.9); z-index: 10;">
                    <h1 style="font-size: 4rem; margin: 0;">‚ú®</h1>
                    <h2 style="color: #302b63; font-family: 'Fredoka One';">Malu, Miss√£o Cumprida!</h2>
                    <p style="font-size: 1.1rem; font-weight: bold; color: #444;">Voc√™ j√° conquistou seus minutos de hoje. Agora √© hora de relaxar!</p>
                    
                    <div style="background: #eef2ff; padding: 20px; border-radius: 25px; margin: 20px 0; border: 3px dashed #7d5fff;">
                        <p style="margin: 0; color: #302b63;">Novas miss√µes surgir√£o em:</p>
                        <h3 style="color: #ff477e; font-size: 2.2rem; margin: 10px 0;">${horas}h e ${minutos}min</h3>
                    </div>
                    
                    <p style="font-style: italic; color: #666;">"O sucesso √© a soma de pequenos esfor√ßos repetidos dia ap√≥s dia."</p>
                </div>
            </div > `;

            document.body.innerHTML = bloqueioHTML;

            // Gerar 50 estrelas aleat√≥rias
            const container = document.getElementById('stars-container');
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 3 + 1 + 'px';
                star.style.width = size;
                star.style.height = size;
                star.style.top = Math.random() * 100 + '%';
                star.style.left = Math.random() * 100 + '%';
                star.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
                container.appendChild(star);
            }
        }

        function spawnShootingStar() {
            const star = document.createElement('div');
            star.className = 'shooting-star';
            // Posi√ß√£o aleat√≥ria no topo/direita
            star.style.top = Math.random() * 40 + '%';
            star.style.right = '0px';
            star.style.animationDuration = (Math.random() * 2 + 1) + 's';

            document.querySelector('.bg-elements').appendChild(star);

            // Remove do HTML ap√≥s a anima√ß√£o
            setTimeout(() => star.remove(), 3000);
        }

        // Lan√ßa uma estrela a cada 5 a 10 segundos aleatoriamente
        setInterval(() => {
            if (Math.random() > 0.5) spawnShootingStar();
        }, 5000);

        function criarEstrelaCadente() {
            const star = document.createElement('div');
            star.className = 'shooting-star';

            // Define uma altura aleat√≥ria entre 0% e 50% da tela
            star.style.top = Math.random() * 50 + '%';
            star.style.right = '-100px'; // Come√ßa fora da tela √† direita

            document.querySelector('.bg-elements').appendChild(star);

            // Remove o elemento ap√≥s a anima√ß√£o para n√£o pesar o navegador
            setTimeout(() => star.remove(), 3500);
        }

        // Lan√ßa uma estrela em intervalos aleat√≥rios entre 10 e 20 segundos
        setInterval(() => {
            if (Math.random() > 0.4) criarEstrelaCadente();
        }, 10000);

        // Salva tudo no LocalStorage
        function salvarProgressoAtual() {
            const estado = {
                minutos: totalMinutes,
                missoesCount: missionsCompletedCount,
                leituraFeita: storyReadToday,
                curiositiesCount: curiositiesViewedToday,
                // Isso grava exatamente quais cards foram clicados
                missoesEstado: Array.from(document.querySelectorAll('.missions-grid .card')).map(card => card.classList.contains('complete')),
                dataSalva: new Date().toLocaleDateString()
            };
            localStorage.setItem('progressoMalu', JSON.stringify(estado));
        }
        // Carrega ao abrir a p√°gina
        function carregarProgresso() {
            const salvo = localStorage.getItem('progressoMalu');
            if (salvo) {
                const dados = JSON.parse(salvo);
                const hoje = new Date().toLocaleDateString();

                // S√≥ restaura se for o mesmo dia
                if (dados.dataSalva === hoje) {
                    totalMinutes = dados.minutos || 0;
                    missionsCompletedCount = dados.missoesCount || 0;
                    storyReadToday = dados.leituraFeita || false;
                    curiositiesViewedToday = dados.curiositiesCount || 0;

                    document.getElementById('total-min').innerText = totalMinutes;

                    // Pinta os cards de verde novamente para a Malu ver o que j√° fez
                    const cards = document.querySelectorAll('.missions-grid .card');
                    if (dados.missoesEstado) {
                        missionsCompletedCount = 0; // Reseta para contar do zero ao carregar
                        dados.missoesEstado.forEach((foiConcluido, index) => {
                            if (foiConcluido && cards[index]) {
                                cards[index].classList.add('complete');
                                missionsCompletedCount++; // Conta as miss√µes que j√° estavam prontas
                            }
                        });
                    }
                    checkAllDone();
                }
            }
        }

        // --- BOT√ÉO BACKUP MANUAL ---
        function fazerBackupManual() {
            salvarProgressoAtual();
            fazerBackupAuto(); // Usa sua fun√ß√£o j√° existente para baixar o arquivo
        }

        // Fun√ß√µes de Rastreamento
        function registrarGastoApp(app, minutos) {
            let uso = JSON.parse(localStorage.getItem('usoAppsMalu')) || { 'Netflix': 0, 'YouTube': 0, 'WhatsApp': 0 };
            if (app.includes('Netflix')) uso['Netflix'] += minutos;
            else if (app.includes('YouTube')) uso['YouTube'] += minutos;
            else if (app.includes('WhatsApp')) uso['WhatsApp'] += minutos;
            localStorage.setItem('usoAppsMalu', JSON.stringify(uso));
        }

        function registrarDiaRua() {
            const diasNomes = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            const hoje = diasNomes[new Date().getDay()];
            let historicoRua = JSON.parse(localStorage.getItem('historicoRuaMalu')) || [];
            if (!historicoRua.includes(hoje)) historicoRua.push(hoje);
            localStorage.setItem('historicoRuaMalu', JSON.stringify(historicoRua));
        }

        // Abre o Painel e renderiza os dados
        function abrirControlePai() {
            document.getElementById('pai-modal').style.display = 'flex';
            document.getElementById('saldo-admin').innerText = totalMinutes;

            carregarUsuariosNoSelect();

            // --- 1. ATUALIZAR BANCO SEMANAL ---
            // Registra o saldo atual no dia de hoje antes de exibir
            const diasNomes = ['dom', 'seg', 'ter', 'qua', 'qui', 'sex', 'sab'];
            const hojeNome = diasNomes[new Date().getDay()];
            let banco = obterBancoHoras();
            banco[hojeNome] = totalMinutes; // Atualiza o valor do dia atual
            localStorage.setItem('bancoHorasMalu', JSON.stringify(banco));

            const diasExibicao = [
                { n: 'Seg', v: banco.seg }, { n: 'Ter', v: banco.ter }, { n: 'Qua', v: banco.qua },
                { n: 'Qui', v: banco.qui }, { n: 'Sex', v: banco.sex }, { n: 'S√°b', v: banco.sab }, { n: 'Dom', v: banco.dom }
            ];

            const maxMinutos = Math.max(...diasExibicao.map(d => d.v), 1);
            let htmlSemana = "";
            diasExibicao.forEach(d => {
                const perc = (d.v / (maxMinutos * 1.2)) * 100;
                htmlSemana += `
            <div class="bar-container">
                <div class="bar-label"><span>${d.n}</span> <b>${d.v}m</b></div>
                <div class="bar-bg"><div class="bar-fill" style="width:${perc}%; background:var(--purple)"></div></div>
            </div>`;
            });
            document.getElementById('chart-semanal').innerHTML = htmlSemana;

            // --- 2. RENDERIZAR GR√ÅFICO DE APPS ---
            const uso = JSON.parse(localStorage.getItem('usoAppsMalu')) || { 'Netflix': 0, 'YouTube': 0, 'WhatsApp': 0 };
            const totalGasto = Object.values(uso).reduce((a, b) => a + b, 0) || 0;
            let htmlApps = "";
            const cores = { 'Netflix': '#E50914', 'YouTube': '#FF0000', 'WhatsApp': '#25D366' };

            Object.keys(uso).forEach(app => {
                const perc = totalGasto > 0 ? Math.round((uso[app] / totalGasto) * 100) : 0;
                htmlApps += `
            <div class="bar-container">
                <div class="bar-label"><span>${app}</span> <b>${uso[app]}m (${perc}%)</b></div>
                <div class="bar-bg"><div class="bar-fill" style="width:${perc}%; background:${cores[app]}"></div></div>
            </div>`;
            });
            document.getElementById('chart-apps').innerHTML = htmlApps;

            // --- 3. DIAS DE RUA ---
            const historicoRua = JSON.parse(localStorage.getItem('historicoRuaMalu')) || [];
            document.getElementById('dias-rua').innerText = historicoRua.length > 0 ? historicoRua.join(', ') : "Nenhum ainda";
        }

        // ATUALIZA√á√ÉO: Chame as fun√ß√µes de registro nos locais certos:
        // Dentro de processarGastoApp(), adicione: registrarGastoApp(appSelecionadoAtualmente, minutosGastar);
        // Dentro de confirmarGastoRua(), adicione: registrarDiaRua();

        // --- FUN√á√ÉO DE AJUSTE MANUAL PELO PAI ---
        // --- FUN√á√ÉO DE AJUSTE MANUAL PELO PAI ---
        function ajustarMinutosManual() {
            const input = document.getElementById('input-ajuste-minutos');
            const valor = parseInt(input.value);

            if (isNaN(valor)) {
                alert("Papai Hayden, por favor digite um n√∫mero v√°lido de minutos! üõ†Ô∏è");
                return;
            }

            // Aplica o ajuste (soma ou subtrai se for negativo)
            totalMinutes += valor;

            // Garante que n√£o fique negativo
            if (totalMinutes < 0) totalMinutes = 0;

            // Atualiza a tela e salva em tempo real
            document.getElementById('total-min').innerText = totalMinutes;
            salvarProgressoAtual();

            // Limpa o campo e avisa
            input.value = "";
            mostrarAviso("Tempo Ajustado!", `Voc√™ ${valor > 0 ? 'adicionou' : 'removeu'} ${Math.abs(valor)} minutos com sucesso.`, "üõ†Ô∏è");

            // Verifica se com o novo valor ela completou tudo
            checkAllDone();
        }

        function abrirConfirmacaoZerar() {
            closeModal('pai-modal');
            document.getElementById('modal-confirmar-zerar').style.display = 'flex';
        }

        function ajustarMinutosManual() {
            const input = document.getElementById('input-ajuste-minutos');
            const valor = parseInt(input.value);
            if (isNaN(valor)) return alert("Digite um n√∫mero!");

            totalMinutes += valor;
            if (totalMinutes < 0) totalMinutes = 0;

            document.getElementById('total-min').innerText = totalMinutes;
            salvarProgressoAtual();
            input.value = "";
            mostrarAviso("Tempo Alterado!", `O tempo foi ajustado para ${totalMinutes} minutos.`, "üõ†Ô∏è");
        }

        let senhaDigitada = "";
        const SENHA_CORRETA = "271223";

        function abrirModalSenha() {
            senhaDigitada = "";
            document.getElementById('senha-display').innerText = "";
            document.getElementById('senha-modal').style.display = 'flex';
        }

        // --- FUN√á√ïES DE ACESSO DO PAPAI ---

        function limparSenha() {
            senhaDigitada = "";
            document.getElementById('senha-display').innerText = "";
        }

        function digitarSenha(num) {
            if (senhaDigitada.length < 6) {
                senhaDigitada += num;
                document.getElementById('senha-display').innerText = "*".repeat(senhaDigitada.length);

                if (senhaDigitada === SENHA_CORRETA) {
                    setTimeout(() => {
                        closeModal('senha-modal');
                        document.getElementById('pai-modal').style.display = 'flex';
                        atualizarHistoricoNoPainel();
                        limparSenha();
                    }, 300);
                } else if (senhaDigitada.length === 6) {
                    setTimeout(() => {
                        const modalErro = document.getElementById('erro-senha-modal');
                        const shakeBox = document.getElementById('erro-shake-box');

                        // Abre o modal
                        modalErro.style.display = 'flex';

                        // Aplica a anima√ß√£o de tremer
                        shakeBox.classList.add('shake-anim');

                        // Remove a classe ap√≥s a anima√ß√£o para poder repetir depois
                        setTimeout(() => {
                            shakeBox.classList.remove('shake-anim');
                        }, 400);

                        limparSenha();
                    }, 200);
                }
            }
        }

        function liberarLeituraManual() {
            if (confirm("Papai Hayden, deseja liberar os minutos de leitura para a Malu agora?")) {
                // Simula a conclus√£o da leitura
                storyReadToday = true;
                totalMinutes += 50; // Valor da recompensa de leitura
                document.getElementById('total-min').innerText = totalMinutes;

                salvarProgressoAtual();
                closeModal('pai-modal');

                mostrarAviso("Recompensa Liberada!", "O Papai Hayden te deu um b√¥nus de leitura hoje! ‚ú®", "üéÅ");

                // Se o modal de leitura estiver aberto, fecha ele
                closeModal('reading-modal');
                checkAllDone();
            }
        }

        function atualizarHistoricoNoPainel() {
            const historico = JSON.parse(localStorage.getItem('historicoCertificados')) || [];
            const divH = document.getElementById('historico-certificados');
            if (divH) {
                divH.innerHTML = historico.length ?
                    historico.map(d => `‚úÖ Conclu√≠do: ${d}`).join('<br>') :
                    "Nenhum certificado hoje.";
            }
        }

        function liberarCuriosidadesManual() {
            if (confirm("Papai Hayden, deseja liberar as curiosidades de hoje para a Malu? Isso contar√° como se ela tivesse aprendido as 2 curiosidades.")) {
                // Define que ela j√° viu o m√°ximo de curiosidades permitidas
                curiositiesViewedToday = MAX_CURIOSITIES_PER_DAY;

                // Adiciona a recompensa (10 min por curiosidade = 20 min)
                totalMinutes += 20;
                document.getElementById('total-min').innerText = totalMinutes;

                salvarProgressoAtual();
                closeModal('pai-modal');

                mostrarAviso("Conhecimento Liberado!", "O Papai Hayden liberou o b√¥nus de curiosidades para voc√™! ‚ú®", "üí°");

                // Se o modal de curiosidades estiver aberto, fecha ele
                closeModal('curiosity-modal');
                checkAllDone();
            }
        }

        // --- LOGICA DE BANCO DE HORAS SEMANAL ---
        function obterBancoHoras() {
            const padrao = { seg: 0, ter: 0, qua: 0, qui: 0, sex: 0, sab: 0, dom: 0, ruaSemanaAcumulado: 0 };
            return JSON.parse(localStorage.getItem('bancoHorasMalu')) || padrao;
        }

        // --- FUN√á√ÉO √öNICA DE RESET (BANCO + LOCAL) ---
        async function executarResetTotal(comBonusRua = false) {
            console.log("Iniciando reset total do sistema...");

            // 1. Limpeza Local (Vari√°veis na mem√≥ria)
            totalMinutes = comBonusRua ? 0 : 0;
            missionsCompletedCount = 0;
            storyReadToday = false;
            curiositiesViewedToday = 0;

            // 2. Limpeza do LocalStorage (Navegador)
            localStorage.removeItem('progressoMalu');
            localStorage.removeItem('usoAppsMalu');
            localStorage.removeItem('saldoTeveGastoHoje');
            localStorage.removeItem('curiosidadesLidas');

            // 3. Sincroniza√ß√£o com o Banco de Dados (Supabase)
            if (usuarioLogado) {
                const payload = {
                    total_minutos: 0,
                    dados_progresso: {
                        missoes: {}, // Linha que "exclui" as tarefas no banco
                        leituras: [],
                        bonusRuaAgendado: comBonusRua ? 60 : 0, // Define se ganha b√¥nus ou n√£o
                        dataDoDesafio: new Date().toISOString().split('T')[0],
                        ultimaSincronia: new Date().toISOString()
                    },
                    ultima_atualizacao: new Date().toISOString()
                };

                const { error } = await supabaseClient
                    .from('usuarios_malu')
                    .update(payload)
                    .eq('id', usuarioLogado.id);

                if (error) {
                    console.error("Erro ao resetar banco:", error);
                } else {
                    const evento = comBonusRua ? "DESAFIO DA NATUREZA" : "RESET MANUAL";
                    await registrarLogPai(evento, "Sistema zerado e tarefas exclu√≠das.", 0);
                }
            }

            // 4. Atualiza√ß√£o Visual
            document.getElementById('total-min').innerText = "0";
            document.querySelectorAll('.card').forEach(card => card.classList.remove('complete'));
        }

        function gastarTempoTela() {
            const input = document.getElementById('input-gasto-tela');
            const valor = parseInt(input.value);

            if (isNaN(valor) || valor <= 0) {
                mostrarAviso("Ops!", "Digite quantos minutos voc√™ quer usar! üòä", "üì±");
                return;
            }

            if (valor > totalMinutes) {
                mostrarAviso("Saldo Insuficiente", `Malu, voc√™ s√≥ tem ${totalMinutes} minutos. Fa√ßa mais miss√µes! üí™`, "‚ùå");
                return;
            }

            totalMinutes -= valor;
            document.getElementById('total-min').innerText = totalMinutes;
            document.getElementById('minutos-disponiveis').innerText = totalMinutes;
            input.value = "";

            salvarProgressoAtual();
            mostrarAviso("Aproveite!", `Voc√™ gastou ${valor} minutos. Bom divertimento! üçø`, "üì∫");
        }
        // Esta vers√£o substitui as duas anteriores e garante o reset no banco e no local
        async function confirmarGastoRua() {
            // Valida√ß√£o de saldo
            if (totalMinutes <= 0) {
                mostrarAviso("Poxa!", "Voc√™ precisa de minutos para trocar pela rua! üå∏", "üå≥");
                return;
            }

            // Trava de seguran√ßa: s√≥ ganha b√¥nus se n√£o gastou nada em apps hoje
            let saldoJaFoiGasto = localStorage.getItem('saldoTeveGastoHoje') === 'true';
            if (saldoJaFoiGasto) {
                document.getElementById('modal-rua-bloqueada').style.display = 'flex';
                return;
            }

            if (confirm("Malu, voc√™ vai zerar seu tempo de hoje para brincar na rua, mas ganhar√° 60 MINUTOS EXTRAS amanh√£. Aceita?")) {
                // CHAMA A FUN√á√ÉO √öNICA DE RESET QUE CRIAMOS
                await executarResetTotal(true);

                closeModal('gastos-modal');
                document.getElementById('rua-bonus-modal').style.display = 'flex';
            }
        }

        // Fun√ß√£o para abrir o Shopping do Tempo
        let travaAtivaGlobal = true;

        // Fun√ß√£o que a Malu clica
        async function abrirModalGasto() {
            try {
                const { data } = await supabaseClient
                    .from('configuracoes_sistema')
                    .select('shopping_aberto_hora, trava_ativa')
                    .eq('id', 1)
                    .single();

                // Se o pai desativou a trava OU se j√° passou do hor√°rio de abertura
                if (data && (data.trava_ativa === false || new Date().getHours() >= data.shopping_aberto_hora)) {
                    document.getElementById('minutos-disponiveis').innerText = totalMinutes;
                    document.getElementById('gastos-modal').style.display = 'flex';
                } else {
                    const hora = data ? data.shopping_aberto_hora : 17;
                    mostrarAviso("Hor√°rio de Estudo!", `O shopping abre √†s ${hora}h. Continue focada! üöÄ`, "üè´");
                }
            } catch (err) {
                console.error("Erro ao validar trava:", err);
                // Fallback: se o banco falhar, abre se for ap√≥s 17h
                if (new Date().getHours() >= 17) {
                    document.getElementById('gastos-modal').style.display = 'flex';
                }
            }
        }

        // Fun√ß√£o que VOC√ä usa no Painel do Pai
        async function toggleTravaShopping() {
            travaAtivaGlobal = !travaAtivaGlobal;

            const { error } = await supabaseClient
                .from('configuracoes_sistema')
                .update({ trava_ativa: travaAtivaGlobal })
                .eq('id', 1);

            if (!error) {
                const btn = document.getElementById('btn-trava-global');
                const status = document.getElementById('status-trava');

                btn.innerText = travaAtivaGlobal ? "LIBERAR SHOPPING AGORA üîì" : "ATIVAR TRAVA DE HOR√ÅRIO üîí";
                btn.style.background = travaAtivaGlobal ? "#2ecc71" : "#e67e22";
                status.innerText = travaAtivaGlobal ? "Protegido (Abre √†s 17h)" : "Liberado 24h";

                mostrarAviso("Sucesso!", "Configura√ß√£o de acesso atualizada na nuvem!", "‚òÅÔ∏è");
            }
        }

        let appSelecionadoAtualmente = "";

        function gastarApp(nomeApp) {
            appSelecionadoAtualmente = nomeApp;

            // Define o √≠cone baseado no app para o visual ficar bonito
            let icone = "üì±";
            if (nomeApp.includes("Netflix")) icone = "üé¨";
            if (nomeApp.includes("YouTube")) icone = "üì∫";
            if (nomeApp.includes("WhatsApp")) icone = "üí¨";

            document.getElementById('icone-app-gasto').innerText = icone;
            document.getElementById('titulo-app-gasto').innerText = nomeApp;
            document.getElementById('saldo-atual-modal').innerText = totalMinutes;
            document.getElementById('minutos-para-gastar').value = ""; // Limpa o campo

            openModal('modal-selecionar-tempo');
        }

        function processarGastoApp() {
            const input = document.getElementById('minutos-para-gastar');
            const minutosGastar = parseInt(input.value);

            if (isNaN(minutosGastar) || minutosGastar <= 0) {
                alert("Digite um valor v√°lido, Malu! üòä");
                return;
            }

            if (minutosGastar > totalMinutes) {
                mostrarAviso("Saldo Insuficiente", `Voc√™ tentou usar ${minutosGastar} min, mas s√≥ tem ${totalMinutes}.`, "‚ùå");
            } else {
                totalMinutes -= minutosGastar;
                document.getElementById('total-min').innerText = totalMinutes;

                salvarProgressoAtual();

                // === ESTA √â A LINHA QUE ESTAVA FALTANDO ===
                registrarGastoApp(appSelecionadoAtualmente, minutosGastar);
                // =========================================

                localStorage.setItem('saldoTeveGastoHoje', 'true'); // Bloqueia o b√¥nus da rua

                closeModal('modal-selecionar-tempo');
                mostrarAviso("Aproveite!", `O Papai autorizou ${minutosGastar} minutos de ${appSelecionadoAtualmente}. Divirta-se! ‚ú®`, "‚úÖ");
            }
        }



        // Adicione esta linha dentro da fun√ß√£o processarGastoApp(), logo ap√≥s subtrair os minutos:
        // localStorage.setItem('saldoTeveGastoHoje', 'true');


        function resetManualTotal() {
            // Limpa os dados principais
            localStorage.removeItem('progressoMalu');
            localStorage.removeItem('usoAppsMalu');
            localStorage.removeItem('saldoTeveGastoHoje');

            // Opcional: Se quiser manter o hist√≥rico da rua e banco semanal, n√£o remova esses dois abaixo
            // localStorage.removeItem('historicoRuaMalu');
            // localStorage.removeItem('bancoHorasMalu');

            // Recarrega a p√°gina para resetar o visual
            window.location.reload();
        }

        // --- CONFIGURA√á√ÉO SUPABASE ---
        // --- CONFIGURA√á√ÉO SUPABASE CORRIGIDA ---
        const supabaseUrl = 'https://laheqcuxwoypkyihweaq.supabase.co';
        const supabaseKey = 'sb_publishable__XcntHRJaOQ1WmsEVNcd7w_mAbecFjQ';
        // Use apenas uma vari√°vel constante para o cliente
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let usuarioLogado = null;

        // --- FUN√á√ÉO DE LOGIN ATUALIZADA ---
        async function realizarLogin() {
            const senha = document.getElementById('pass-input').value;
            const btn = document.querySelector('#login-overlay button');

            btn.innerText = "VERIFICANDO...";
            btn.disabled = true;

            try {
                const { data, error } = await supabaseClient
                    .from('usuarios_malu')
                    .select('*')
                    .eq('nome', 'Malu')
                    .eq('senha', senha)
                    .single();

                if (data) {
                    usuarioLogado = data;

                    // --- L√ìGICA DE RESET AUTOM√ÅTICO DA MEIA-NOITE ---
                    const hoje = new Date().toLocaleDateString();
                    const ultimaData = data.dados_progresso?.dataSalva;

                    if (ultimaData !== hoje) {
                        console.log("üåû Bom dia! Resetando miss√µes para o novo dia...");

                        // Mantemos o saldo total_minutos, mas limpamos o progresso das miss√µes
                        totalMinutes = data.total_minutos;


                        // Criamos um novo progresso, mas MANTEMOS o aviso_ajuste se ele existir
                        let novoProgresso = {
                            dataSalva: hoje,
                            missoes: {},
                            leituras: [],
                            aviso_ajuste: data.dados_progresso?.aviso_ajuste // PRESERVA O AVISO
                        };

                        // Limpamos o LocalStorage e preparamos novo payload
                        localStorage.removeItem('progressoMalu');
                        localStorage.removeItem('curiosidadesLidas');

                        // Atualiza o banco com o novo progresso (que ainda tem o aviso)
                        await supabaseClient
                            .from('usuarios_malu')
                            .update({ dados_progresso: novoProgresso })
                            .eq('id', data.id);

                        // Atualiza o objeto local para a verifica√ß√£o abaixo funcionar
                        data.dados_progresso = novoProgresso;
                    } else {
                        totalMinutes = data.total_minutos;
                        if (data.dados_progresso?.missoes) {
                            localStorage.setItem('progressoMalu', JSON.stringify(data.dados_progresso.missoes));
                        }
                    }

                    await verificarBonusPendente(data);

                    verificarAvisoPai(data);

                    // Atualiza interface
                    document.getElementById('total-min').innerText = totalMinutes;
                    carregarProgresso();
                    document.getElementById('login-overlay').style.display = 'none';

                    mostrarBoasVindasPersonalizado(usuarioLogado.nome);

                } else {
                    document.getElementById('login-error').style.display = 'block';
                    btn.innerText = "ACESSAR MEU MUNDO üöÄ";
                    btn.disabled = false;
                }



            } catch (err) {
                console.error("Erro:", err);
                btn.disabled = false;
            }


        }

        // FUN√á√ÉO PARA CARREGAR TUDO DA NUVEM
        async function carregarDoSupabase() {
            try {
                const { data, error } = await supabaseClient
                    .from('usuarios_malu')
                    .select('*')
                    .eq('id', 1)
                    .single();

                if (data && data.dados_progresso) {
                    const dp = data.dados_progresso;

                    // 1. Restaura o Saldo
                    totalMinutes = data.total_minutos || 0;
                    document.getElementById('total-min').innerText = totalMinutes;

                    // 2. Restaura o LocalStorage com os dados da nuvem
                    if (dp.progressoMalu) localStorage.setItem('progressoMalu', JSON.stringify(dp.progressoMalu));
                    if (dp.usoAppsMalu) localStorage.setItem('usoAppsMalu', JSON.stringify(dp.usoAppsMalu));
                    if (dp.bancoHorasMalu) localStorage.setItem('bancoHorasMalu', JSON.stringify(dp.bancoHorasMalu));

                    // 3. Atualiza a interface (marcar os cards verdes)
                    carregarProgresso();
                    console.log("üöÄ Sistema restaurado via Nuvem!");
                }
            } catch (err) {
                console.error("Erro ao carregar banco:", err);
            }
        }

        // --- FUN√á√ÉO DE GRAVA√á√ÉO INSTANT√ÇNEA ---
        async function gravarTudoInstantaneo() {
            if (!usuarioLogado) return;

            // Captura o estado atual de tudo
            const payload = {
                total_minutos: totalMinutes,
                dados_progresso: {
                    missoes: JSON.parse(localStorage.getItem('progressoMalu')) || {},
                    leituras: JSON.parse(localStorage.getItem('curiosidadesLidas')) || [],
                    usoApps: JSON.parse(localStorage.getItem('usoAppsMalu')) || {},
                    bonusRuaResgatado: storyReadToday, // Exemplo de persist√™ncia
                    ultimaSincronia: new Date().toISOString()
                },
                ultima_atualizacao: new Date().toISOString()
            };

            const { error } = await supabaseClient
                .from('usuarios_malu')
                .update(payload)
                .eq('id', usuarioLogado.id);

            if (error) console.error("Erro na sincroniza√ß√£o:", error);
        }

        // --- FUN√á√ïES DO PAINEL DO PAI (100% SINCRONIZADAS) ---

        async function ajustarMinutosManual() {
            const input = document.getElementById('input-ajuste-minutos');
            const valor = parseInt(input.value);

            if (isNaN(valor)) {
                alert("Papai Hayden, digite um n√∫mero v√°lido! üõ†Ô∏è");
                return;
            }

            // Aplica o ajuste localmente
            totalMinutes += valor;
            if (totalMinutes < 0) totalMinutes = 0;

            // Atualiza a Interface
            document.getElementById('total-min').innerText = totalMinutes;
            document.getElementById('saldo-admin').innerText = totalMinutes;

            // Grava√ß√£o Instant√¢nea no Supabase
            await gravarTudoInstantaneo();
            await registrarLogPai("Ajuste Manual", `Papai Hayden ajustou o saldo em ${valor} minutos.`, valor);

            input.value = "";
            mostrarAviso("Tempo Ajustado!", `Saldo atualizado para ${totalMinutes} minutos na nuvem.`, "üõ†Ô∏è");
        }

        async function liberarLeituraManual() {
            if (confirm("Deseja liberar o b√¥nus de leitura para a Malu agora?")) {
                storyReadToday = true;
                totalMinutes += 50; // B√¥nus de leitura

                document.getElementById('total-min').innerText = totalMinutes;
                document.getElementById('saldo-admin').innerText = totalMinutes;

                // Grava√ß√£o Instant√¢nea
                await gravarTudoInstantaneo();
                await registrarLogPai("B√¥nus Manual", "Papai Hayden liberou b√¥nus de leitura.", 50);

                closeModal('pai-modal');
                mostrarAviso("B√¥nus Liberado!", "O b√¥nus de leitura j√° est√° na nuvem! ‚ú®", "üéÅ");
                checkAllDone();
            }
        }

        async function liberarCuriosidadesManual() {
            if (confirm("Deseja liberar o b√¥nus de curiosidades?")) {
                curiositiesViewedToday = MAX_CURIOSITIES_PER_DAY;
                totalMinutes += 20;

                document.getElementById('total-min').innerText = totalMinutes;
                document.getElementById('saldo-admin').innerText = totalMinutes;

                // Grava√ß√£o Instant√¢nea
                await gravarTudoInstantaneo();
                await registrarLogPai("B√¥nus Manual", "Papai Hayden liberou b√¥nus de curiosidades.", 20);

                closeModal('pai-modal');
                mostrarAviso("Conhecimento Liberado!", "As curiosidades foram marcadas como conclu√≠das no banco! üí°", "‚ú®");
                checkAllDone();
            }
        }

        async function resetManualTotal() {
            if (!confirm("ISSO APAGAR√Å TUDO NA NUVEM. Confirmar reset di√°rio?")) return;

            // Reseta vari√°veis locais
            totalMinutes = 0;
            missionsCompletedCount = 0;
            storyReadToday = false;
            curiositiesViewedToday = 0;

            // Limpa LocalStorage
            localStorage.removeItem('progressoMalu');
            localStorage.removeItem('usoAppsMalu');
            localStorage.removeItem('saldoTeveGastoHoje');

            // Sincroniza o "Zerar" com o Banco
            await gravarTudoInstantaneo();
            await registrarLogPai("Reset Geral", "O sistema foi zerado para um novo dia.", 0);

            location.reload(); // Recarrega para limpar a interface
        }

        async function registrarLogPai(evento, detalhes, minutos) {
            if (!usuarioLogado) return;

            await supabaseClient
                .from('controle_pai_logs')
                .insert({
                    usuario_id: usuarioLogado.id,
                    evento: evento,
                    detalhes: detalhes,
                    valor_minutos: minutos
                });
        }

        async function alterarHoraShopping(novaHora) {
            const { error } = await supabaseClient
                .from('configuracoes_sistema')
                .update({ shopping_aberto_hora: parseInt(novaHora) })
                .eq('id', 1);

            if (!error) {
                mostrarAviso("Configura√ß√£o Salva!", `O Shopping agora abrir√° √†s ${novaHora}h`, "‚è∞");
                await registrarLogPai("Configura√ß√£o", `Hora do shopping alterada para ${novaHora}h`, 0);
            }
        }

        async function registrarResetDiario(novaData, saldoAtual) {
            const payload = {
                total_minutos: saldoAtual,
                dados_progresso: {
                    missoes: {},
                    leituras: [],
                    dataSalva: novaData,
                    bonusRuaResgatado: false
                },
                ultima_atualizacao: new Date().toISOString()
            };

            await supabaseClient
                .from('usuarios_malu')
                .update(payload)
                .eq('id', usuarioLogado.id);

            await registrarLogPai("Reset Autom√°tico", "O sistema detectou um novo dia e limpou as miss√µes.", 0);
        }

        // --- FUN√á√ÉO PARA GASTAR TEMPO EM APPS (NETFLIX, YOUTUBE, ETC) ---
        async function processarGastoApp() {
            const input = document.getElementById('minutos-para-gastar');
            const minutosAGastar = parseInt(input.value);

            // 1. Valida√ß√µes b√°sicas
            if (isNaN(minutosAGastar) || minutosAGastar <= 0) {
                alert("Malu, digite quantos minutos voc√™ quer usar! üòä");
                return;
            }

            if (minutosAGastar > totalMinutes) {
                mostrarAviso("Saldo Insuficiente", `Voc√™ tentou usar ${minutosAGastar} min, mas s√≥ tem ${totalMinutes} min.`, "‚ùå");
                return;
            }

            // 2. Atualiza√ß√£o local
            totalMinutes -= minutosAGastar;
            document.getElementById('total-min').innerText = totalMinutes;

            // Marca que o saldo foi gasto (isso bloqueia o b√¥nus de 1h da rua hoje)
            localStorage.setItem('saldoTeveGastoHoje', 'true');
            salvarProgressoAtual();

            // 3. Sincroniza√ß√£o Ass√≠ncrona com o Supabase
            try {
                await gravarTudoInstantaneo(); // O 'await' agora funciona porque a fun√ß√£o √© 'async'
                if (typeof registrarLogPai === "function") {
                    await registrarLogPai("Gasto Shopping", `Usou ${minutosAGastar} min em: ${appSelecionadoAtualmente}`, -minutosAGastar);
                }

                closeModal('modal-selecionar-tempo');
                closeModal('gastos-modal');
                mostrarAviso("Aproveite!", `Voc√™ liberou ${minutosAGastar} minutos de ${appSelecionadoAtualmente}. Divirta-se! ‚ú®`, "‚úÖ");
            } catch (err) {
                console.error("Erro ao sincronizar gasto:", err);
            }
        }

        // Adicione esta fun√ß√£o ao seu bloco de <script>
        function openModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.style.display = 'flex';
            } else {
                console.error("Modal n√£o encontrado: " + id);
            }
        }

        async function verificarBonusPendente(dadosBanco) {
            const dp = dadosBanco.dados_progresso;
            const dataHoje = new Date().toISOString().split('T')[0];

            // Verifica se existe o b√¥nus agendado dentro do JSON e se o desafio foi antes de hoje
            if (dp && dp.bonusRuaAgendado > 0 && dp.dataDoDesafio < dataHoje) {
                const novoSaldo = (dadosBanco.total_minutos || 0) + dp.bonusRuaAgendado;

                // Limpa o b√¥nus do JSON para n√£o ganhar duas vezes
                dp.bonusRuaAgendado = 0;

                const { error } = await supabaseClient
                    .from('usuarios_malu')
                    .update({
                        total_minutos: novoSaldo,
                        dados_progresso: dp // Salva o JSON limpo
                    })
                    .eq('id', dadosBanco.id);

                if (!error) {
                    totalMinutes = novoSaldo;
                    document.getElementById('total-min').innerText = totalMinutes;

                    mostrarAviso("B√¥nus de Rua! üéÅ", "Voc√™ ganhou 60 minutos extras por ter brincado na rua ontem!", "üå≥");
                }
            }
        }

        function reiniciarComSeguranca() {
            podeSairDaPagina = true; // Impede o popup "As altera√ß√µes talvez n√£o sejam salvas"

            // Em vez de window.location.reload() (que desloga), apenas limpamos a tela
            document.getElementById('total-min').innerText = "0";
            closeModal('rua-bonus-modal');

            // Opcional: Desmarca as miss√µes visualmente
            document.querySelectorAll('.card').forEach(card => card.classList.remove('complete'));

            mostrarAviso("Tudo pronto!", "V√° brincar! Seus 60 minutos b√¥nus estar√£o aqui amanh√£ √†s 08:00! üå≥", "üëã");
        }

        function alternarFormulario(tipo) {
            if (tipo === 'cadastro') {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('signup-form').style.display = 'block';
            } else {
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('signup-form').style.display = 'none';
            }
        }

        async function criarConta() {
            const email = document.getElementById('reg-email').value;
            const senha = document.getElementById('reg-pass').value;
            const nick = document.getElementById('reg-nick').value;

            const { data, error } = await supabaseClient.auth.signUp({
                email: email,
                password: senha,
                options: {
                    data: {
                        display_name: nick // Salva o nome/nick aqui
                    }
                }
            });

            if (error) alert("Erro: " + error.message);
            else alert("Verifique seu e-mail para confirmar a conta! üìß");
        }

        // --- SISTEMA DE SESS√ÉO PERMANENTE ---

        // Esta fun√ß√£o roda assim que a p√°gina abre
        window.onload = async function () {
            // 1. Verifica se j√° existe um usu√°rio conectado no Supabase
            const { data: { session } } = await supabaseClient.auth.getSession();

            if (session) {
                console.log("Sess√£o recuperada com sucesso! üöÄ");
                usuarioLogado = session.user;
                await inicializarDadosAposLogin(session.user);
                document.getElementById('login-overlay').style.display = 'none';
            } else {
                console.log("Nenhum usu√°rio conectado. Mostrando tela de login.");
                document.getElementById('login-overlay').style.display = 'flex';
            }

            // Inicia o rel√≥gio e carrega o progresso visual
            updateClock();
            setInterval(updateClock, 1000);
        };

        // --- FUN√á√ÉO DE LOGIN MELHORADA ---
        async function fazerLogin() {
            const email = document.getElementById('email-input').value;
            const senha = document.getElementById('pass-input').value;
            const btn = document.querySelector('#login-form button');

            if (!email || !senha) {
                alert("Malu, preencha o e-mail e a senha! ‚ú®");
                return;
            }

            btn.innerText = "ENTRANDO... üöÄ";
            btn.disabled = true;

            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email: email,
                password: senha,
            });

            if (error) {
                alert("Erro no login: " + error.message);
                btn.innerText = "ACESSAR üöÄ";
                btn.disabled = false;
            } else {
                usuarioLogado = data.user;
                await inicializarDadosAposLogin(data.user);
                document.getElementById('login-overlay').style.display = 'none';

                // Mensagem de boas-vindas
                mostrarBoasVindasPersonalizado(data.user.user_metadata.display_name || "Malu");
            }
        }

        // Fun√ß√£o para buscar o progresso na tabela ap√≥s o login
        async function inicializarDadosAposLogin(user) {
            const { data, error } = await supabaseClient
                .from('usuarios_malu')
                .select('*')
                .eq('id', user.id) // O ID aqui deve bater com o ID da tabela Auth
                .single();

            if (data) {
                totalMinutes = data.total_minutos || 0;
                document.getElementById('total-min').innerText = totalMinutes;

                if (data.dados_progresso) {
                    localStorage.setItem('progressoMalu', JSON.stringify(data.dados_progresso.missoes || {}));
                }
                carregarProgresso();

                mostrarBoasVindasPersonalizado(data.nome);
            } else {
                // Se for o primeiro login da amiga, cria um registro inicial para ela
                console.log("Criando registro inicial para nova usu√°ria...");
                await criarRegistroInicial(user);
            }
        }

        async function criarRegistroInicial(user) {
            const novoRegistro = {
                id: user.id,
                nome: user.user_metadata.display_name || 'Amiga da Malu',
                total_minutos: 0,
                dados_progresso: { missoes: {}, leituras: [] },
                ultima_atualizacao: new Date().toISOString()
            };

            const { error } = await supabaseClient
                .from('usuarios_malu')
                .insert([novoRegistro]);

            if (!error) {
                console.log("Perfil criado com sucesso!");
                location.reload(); // Recarrega para aplicar os dados zerados
            }
        }

        // Fun√ß√£o para confirmar e executar o logout
        async function confirmarSair() {
            if (confirm("Malu, deseja realmente sair da sua conta? üåü")) {
                podeSairDaPagina = true; // Libera a trava de seguran√ßa da aba

                await supabaseClient.auth.signOut();

                // Limpa tudo para o pr√≥ximo usu√°rio
                usuarioLogado = null;
                totalMinutes = 0;
                localStorage.clear();

                window.location.reload(); // Recarrega para voltar √† tela de login
            }
        }

        async function ajustarMinutosGlobal() {
            const input = document.getElementById('input-ajuste-global');
            const valor = parseInt(input.value);

            if (isNaN(valor)) {
                alert("Papai Hayden, digite um valor para o ajuste global! üåç");
                return;
            }

            if (!confirm(`Deseja mesmo aplicar ${valor} minutos para TODOS os usu√°rios cadastrados?`)) return;

            try {
                // 1. Primeiro, buscamos todos os usu√°rios para calcular o novo saldo individualmente
                // (Isso evita que saldos fiquem negativos e garante a integridade dos dados)
                const { data: usuarios, error: fetchError } = await supabaseClient
                    .from('usuarios_malu')
                    .select('id, total_minutos');

                if (fetchError) throw fetchError;

                // 2. Executamos a atualiza√ß√£o para cada um
                const promises = usuarios.map(u => {
                    let novoSaldo = (u.total_minutos || 0) + valor;
                    if (novoSaldo < 0) novoSaldo = 0;

                    return supabaseClient
                        .from('usuarios_malu')
                        .update({ total_minutos: novoSaldo, ultima_atualizacao: new Date().toISOString() })
                        .eq('id', u.id);
                });

                await Promise.all(promises);

                // 3. Registra a a√ß√£o no log do Pai
                await registrarLogPai("Ajuste Global", `Papai Hayden ajustou o saldo de todos em ${valor} min.`, valor);

                // 4. Atualiza o saldo local se o usu√°rio atual estiver na lista
                if (usuarioLogado) {
                    totalMinutes += valor;
                    if (totalMinutes < 0) totalMinutes = 0;
                    document.getElementById('total-min').innerText = totalMinutes;
                    document.getElementById('saldo-admin').innerText = totalMinutes;
                }

                input.value = "";
                mostrarAviso("Sucesso Global!", `Tempo ajustado para todas as amigas na nuvem! üåç`, "‚ú®");

            } catch (err) {
                console.error("Erro no ajuste global:", err);
                alert("Erro ao atualizar todos os usu√°rios. Verifique a conex√£o.");
            }
        }


        // Carrega a lista de usu√°rios no select ao abrir o painel
        // Carrega a lista de todos os usu√°rios no select ao abrir o painel
        async function carregarUsuariosNoSelect() {
            console.log("üîÑ Buscando usu√°rios no banco...");
            try {
                const { data: usuarios, error } = await supabaseClient
                    .from('usuarios_malu')
                    .select('id, nome')
                    .order('nome', { ascending: true });

                if (error) {
                    console.error("Erro Supabase:", error);
                    alert("Erro ao buscar usu√°rios: " + error.message);
                    return;
                }

                const select = document.getElementById('select-usuario-ajuste');

                // Limpa e mant√©m a op√ß√£o global
                select.innerHTML = '<option value="todos">üåç Aplicar em Todos (Malu + Amigas)</option>';

                if (usuarios && usuarios.length > 0) {
                    console.log(`${usuarios.length} usu√°rios encontrados.`);
                    usuarios.forEach(u => {
                        const opt = document.createElement('option');
                        opt.value = u.id;
                        opt.innerText = `üë§ ${u.nome}`;
                        select.appendChild(opt);
                    });
                } else {
                    console.warn("Nenhum usu√°rio encontrado na tabela 'usuarios_malu'.");
                }
            } catch (err) {
                console.error("Erro cr√≠tico na fun√ß√£o:", err);
            }
        }

        // Sobrescreva ou chame esta fun√ß√£o ao abrir o painel
        const originalAbrirControlePai = abrirControlePai;
        abrirControlePai = function () {
            if (typeof originalAbrirControlePai === 'function') {
                originalAbrirControlePai();
            }
            // For√ßa o carregamento dos usu√°rios toda vez que abrir
            carregarUsuariosNoSelect();
        };


        async function executarAjusteDirecionado() {
            const alvo = document.getElementById('select-usuario-ajuste').value;
            const valor = parseInt(document.getElementById('input-ajuste-direcionado').value);

            if (isNaN(valor)) return alert("Digite um valor v√°lido!");

            try {
                let query = supabaseClient.from('usuarios_malu').select('id, total_minutos, dados_progresso, nome');

                if (alvo !== 'todos') query = query.eq('id', alvo);
                const { data: usuarios } = await query;

                const promises = usuarios.map(u => {
                    let novoSaldo = (u.total_minutos || 0) + valor;
                    let dp = u.dados_progresso || {};

                    // Marca que h√° um aviso pendente para este usu√°rio
                    dp.aviso_ajuste = {
                        valor: valor,
                        data: new Date().toLocaleString(),
                        lido: false
                    };

                    return supabaseClient
                        .from('usuarios_malu')
                        .update({
                            total_minutos: novoSaldo < 0 ? 0 : novoSaldo,
                            dados_progresso: dp,
                            ultima_atualizacao: new Date().toISOString()
                        })
                        .eq('id', u.id);
                });

                await Promise.all(promises);
                mostrarAviso("Sucesso!", `Ajuste de ${valor}m enviado!`, "üéØ");
                if (usuarioLogado) carregarDoSupabase(); // Atualiza se for voc√™
            } catch (err) { console.error(err); }
        }

        let canvas, ctx, desenhando = false;

        function abrirColorir() {
            openModal('modal-colorir');
            if (!canvas) initCanvas(); // Inicializa apenas uma vez
        }

        function initCanvas() {
            canvas = document.getElementById('canvas-colorir');
            ctx = canvas.getContext('2d');

            // Ajusta o tamanho real do canvas para o tamanho da tela do celular
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight || 350;

            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = document.getElementById('range-tamanho').value;

            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                // Se for touch, pega a posi√ß√£o do primeiro dedo, sen√£o pega do mouse
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }

            function start(e) {
                desenhando = true;
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            }

            function move(e) {
                if (!desenhando) return;
                const pos = getPos(e);
                ctx.strokeStyle = document.getElementById('cor-pincel').value;
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }

            function stop() { desenhando = false; }

            // Eventos Unificados (Mouse + Touch)
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('touchstart', (e) => { start(e); e.preventDefault(); }, { passive: false });

            canvas.addEventListener('mousemove', move);
            canvas.addEventListener('touchmove', (e) => { move(e); e.preventDefault(); }, { passive: false });

            canvas.addEventListener('mouseup', stop);
            canvas.addEventListener('touchend', stop);
        }

        function iniciarDesenho(e) {
            desenhando = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function desenhar(e) {
            if (!desenhando) return;
            const rect = canvas.getBoundingClientRect();
            ctx.strokeStyle = document.getElementById('cor-pincel').value;
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        }

        function pararDesenho() {
            desenhando = false;
        }

        function limparTela() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        const moldesUrls = {
            medica: 'https://cdn-icons-png.flaticon.com/512/3306/3306560.png',
            advogada: 'https://cdn-icons-png.flaticon.com/512/3133/3133606.png',
            arquiteta: 'https://cdn-icons-png.flaticon.com/512/1033/1033282.png'
        };

        function carregarMolde(tipo) {
            const img = document.getElementById('img-molde');
            limparTela();

            if (tipo === 'limpo') {
                img.style.display = 'none';
                img.src = '';
            } else {
                img.src = moldesUrls[tipo];
                img.style.display = 'block';
                mostrarAviso("Lindo Molde!", `Agora voc√™ pode colorir sua futura profiss√£o de ${tipo}!`, "üé®");
            }
        }

        // Modifique sua fun√ß√£o baixarDesenho para incluir o fundo se quiser
        function baixarDesenho() {
            // Para salvar com o molde junto, precisar√≠amos desenhar a imagem no canvas antes de exportar
            // Por enquanto, salva apenas o que ela pintou (transparente por baixo)
            const link = document.createElement('a');
            link.download = `arte_da_malu_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL();
            link.click();

            // Pequena recompensa por ser criativa
            totalMinutes += 2;
            document.getElementById('total-min').innerText = totalMinutes;
            gravarTudoInstantaneo();

            mostrarAviso("Artista de Sucesso!", "Sua obra foi salva e voc√™ ganhou 2 minutos de b√¥nus por sua criatividade! üé®", "üíñ");
        }

        // Atualize sua fun√ß√£o carregarFotoPropria para resetar a barra se desejar
        function carregarFotoPropria(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const img = document.getElementById('img-molde');
                const range = document.getElementById('range-opacidade');
                const label = document.getElementById('val-opacidade');

                limparTela();

                img.src = e.target.result;
                img.style.display = 'block';

                // Reseta para 50% ao carregar nova foto
                img.style.opacity = '0.5';
                range.value = 50;
                label.innerText = 50;

                mostrarAviso("Foto Carregada!", "Ajuste a transpar√™ncia na barra roxa para facilitar sua pintura! ‚ú®", "üì∏");
            };
            reader.readAsDataURL(file);
        }

        function ajustarOpacidade(valor) {
            const img = document.getElementById('img-molde');
            const label = document.getElementById('val-opacidade');

            // Converte o valor de 0-100 para 0-1 (formato CSS)
            const opacidadeCSS = valor / 100;

            img.style.opacity = opacidadeCSS;
            label.innerText = valor;
        }

        function ajustarTamanhoPincel(valor) {
            if (!ctx) return;

            // Atualiza a espessura da linha no contexto do Canvas
            ctx.lineWidth = valor;

            // Atualiza o texto para a Malu ver o n√∫mero
            document.getElementById('val-tamanho').innerText = valor;
        }

        // Fun√ß√£o para abrir o jogo sem precisar das miss√µes
        function abrirTreinoMemoria() {
            // Criamos um modal simples para o treino se ele n√£o existir
            let treinoModal = document.getElementById('treino-modal');
            if (!treinoModal) {
                const html = `
        <div id="treino-modal" class="modal">
            <div class="modal-content">
                <span class="close-popup" onclick="closeModal('treino-modal')">√ó</span>
                <h2 style="font-family: 'Fredoka One'; color: var(--purple);">üß† Treino de Mem√≥ria</h2>
                <p>Pratique para o grande desafio!</p>
                <div id="treino-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px auto; max-width: 300px;"></div>
                <button class="btn" style="background: var(--purple); width: 100%; margin-top: 10px;" onclick="initTreino()">Reiniciar Treino</button>
            </div>
        </div>`;
                document.body.insertAdjacentHTML('beforeend', html);
            }
            document.getElementById('treino-modal').style.display = 'flex';
            initTreino();
        }

        function initTreino() {
            const grid = document.getElementById('treino-grid');
            grid.innerHTML = '';
            const icons = ['‚öñÔ∏è', 'ü©∫', 'üèóÔ∏è', '‚úàÔ∏è', 'üé®', 'üèê'];
            const deck = [...icons, ...icons].sort(() => Math.random() - 0.5);

            // 1. Criar as cartas j√° viradas (Preview)
            deck.forEach(icon => {
                const card = document.createElement('div');
                card.className = 'memory-card preview'; // Come√ßa com classe de visualiza√ß√£o
                card.style.height = '80px';
                card.style.display = 'flex';
                card.style.alignItems = 'center';
                card.style.justifyContent = 'center';
                card.style.fontSize = '2rem';
                card.dataset.icon = icon;
                card.innerText = icon; // Mostra o √≠cone imediatamente
                grid.appendChild(card);
            });

            // 2. Aguardar 3 segundos e virar as cartas para come√ßar o jogo
            setTimeout(() => {
                const allCards = document.querySelectorAll('#treino-grid .memory-card');
                allCards.forEach(card => {
                    card.classList.remove('preview');
                    card.innerText = ''; // Esconde o √≠cone

                    // Ativa o clique apenas ap√≥s os 3 segundos
                    card.onclick = () => {
                        if (flippedCards.length < 2 && !card.classList.contains('flipped')) {
                            card.classList.add('flipped');
                            card.innerText = card.dataset.icon;
                            flippedCards.push(card);
                            if (flippedCards.length === 2) {
                                setTimeout(() => {
                                    const [c1, c2] = flippedCards;
                                    if (c1.dataset.icon === c2.dataset.icon) {
                                        c1.classList.add('matched');
                                        c2.classList.add('matched');
                                        if (document.querySelectorAll('#treino-grid .matched').length === 12) {
                                            mostrarAviso("Muito bem!", "Treino conclu√≠do! Voc√™ est√° pronta para o desafio real!", "üèÜ");
                                        }
                                    } else {
                                        c1.classList.remove('flipped');
                                        c2.classList.remove('flipped');
                                        c1.innerText = '';
                                        c2.innerText = '';
                                    }
                                    flippedCards = [];
                                }, 800);
                            }
                        }
                    };
                });
            }, 3000); // 3000ms = 3 segundos
        }

        let snake, food, dx, dy, snakeScore, snakeInterval, speed;

        function abrirSnakeGame() {
            let modal = document.getElementById('snake-modal');
            if (!modal) {
                const html = `
                <div id="snake-modal" class="modal">
                    <div class="modal-content">
                        <span class="close-popup" onclick="fecharSnake()">√ó</span>
                        <h2 style="font-family:'Fredoka One'; color:#2ecc71">üêç Super Cobra</h2>
                        <div class="game-score">Pts: <span id="snake-score">0</span></div>
                        <canvas id="snake-canvas" width="280" height="280"></canvas>
                
                        <div class="mobile-controls">
                            <div style="grid-column: 2;"><button class="ctrl-btn" onclick="changeDir(0,-10)">‚¨ÜÔ∏è</button></div>
                            <button class="ctrl-btn" onclick="changeDir(-10,0)">‚¨ÖÔ∏è</button>
                            <button class="ctrl-btn" onclick="changeDir(0,10)">‚¨áÔ∏è</button>
                            <button class="ctrl-btn" onclick="changeDir(10,0)">‚û°Ô∏è</button>
                        </div>
                    </div>
                </div>`;
                document.body.insertAdjacentHTML('beforeend', html);
            }
            document.getElementById('snake-modal').style.display = 'flex';
            initSnake();
        }

        function changeDir(newDx, newDy) {
            // Impede a cobra de voltar para dentro de si mesma
            if ((newDx === -dx) || (newDy === -dy)) return;
            dx = newDx;
            dy = newDy;
        }

        function initSnake() {
            snake = [{ x: 150, y: 150 }, { x: 140, y: 150 }, { x: 130, y: 150 }];
            dx = 10; dy = 0;
            snakeScore = 0;
            speed = 100;
            createFood();
            if (snakeInterval) clearInterval(snakeInterval);
            snakeInterval = setInterval(mainSnake, speed);

            // Aumenta velocidade a cada 10 segundos
            setInterval(() => {
                if (speed > 30) {
                    speed -= 5;
                    clearInterval(snakeInterval);
                    snakeInterval = setInterval(mainSnake, speed);
                }
            }, 10000);
        }

        function mainSnake() {
            if (didGameEnd()) {
                // 1. Para o cron√¥metro IMEDIATAMENTE
                clearInterval(snakeInterval);
                snakeInterval = null; // Limpa a refer√™ncia

                // 2. Chama a fun√ß√£o de salvamento e aviso
                finalizarSnake(snakeScore);
                return;
            }
            advanceSnake();
            drawSnake();
        }

        function advanceSnake() {
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };
            snake.unshift(head);
            if (head.x === food.x && head.y === food.y) {
                snakeScore += 10;
                document.getElementById('snake-score').innerText = snakeScore;
                vibrarDispositivo(40);
                createFood();
            } else {
                snake.pop();
            }
        }

        function drawSnake() {
            const canvas = document.getElementById('snake-canvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "#1a1a2e";
            ctx.fillRect(0, 0, 300, 300);
            ctx.fillStyle = "#2ecc71";
            snake.forEach(part => ctx.fillRect(part.x, part.y, 10, 10));
            ctx.fillStyle = "#ff477e";
            ctx.fillRect(food.x, food.y, 10, 10);
        }

        function createFood() {
            food = {
                x: Math.floor(Math.random() * 29) * 10,
                y: Math.floor(Math.random() * 29) * 10
            };
        }

        function didGameEnd() {
            const head = snake[0];
            const hitWall = head.x < 0 || head.x > 290 || head.y < 0 || head.y > 290;
            const hitSelf = snake.slice(1).some(p => p.x === head.x && p.y === head.y);
            return hitWall || hitSelf;
        }

        function fecharSnake() {
            clearInterval(snakeInterval);
            closeModal('snake-modal');
        }

        // Controles (Teclado)
        document.addEventListener('keydown', e => {
            if (e.key === "ArrowUp" && dy === 0) { dx = 0; dy = -10; }
            if (e.key === "ArrowDown" && dy === 0) { dx = 0; dy = 10; }
            if (e.key === "ArrowLeft" && dx === 0) { dx = -10; dy = 0; }
            if (e.key === "ArrowRight" && dx === 0) { dx = 10; dy = 0; }
        });




        let tetrisInterval, tetrisCanvas, tetrisCtx, board, piece, tetrisScore;

        function abrirTetrisGame() {
            let modal = document.getElementById('tetris-modal');
            if (!modal) {
                const html = `
                <div id="tetris-modal" class="modal">
                    <div class="modal-content" style="max-height: 98vh;">
                        <span class="close-popup" onclick="fecharTetris()">√ó</span>
                        <h2 style="font-family:'Fredoka One'; color:var(--purple); margin:0;">üß± Tetris Master</h2>
                        <div class="game-score">Score: <span id="tetris-score">0</span></div>
                        <canvas id="tetris-canvas" width="200" height="360"></canvas>
                        
                        <div class="mobile-controls">
                            <div style="grid-column: 2;"><button class="ctrl-btn" onclick="rotateTetris()">üîÑ</button></div>
                            <button class="ctrl-btn" onclick="moveTetris(-1)">‚¨ÖÔ∏è</button>
                            <button class="ctrl-btn" onclick="dropTetris()">‚¨áÔ∏è</button>
                            <button class="ctrl-btn" onclick="moveTetris(1)">‚û°Ô∏è</button>
                        </div>
                    </div>
                </div>`;
                document.body.insertAdjacentHTML('beforeend', html);
            }
            document.getElementById('tetris-modal').style.display = 'flex';
            initTetris();
        }

        // Fun√ß√µes de movimenta√ß√£o que voc√™ deve adicionar
        function moveTetris(dir) {
            piece.pos.x += dir;
            if (collide()) piece.pos.x -= dir;
            drawTetris();
        }

        function rotateTetris() {
            const pos = piece.pos.x;
            let offset = 1;
            rotate(piece.matrix);
            while (collide()) {
                piece.pos.x += offset;
                offset = -(offset + (offset > 0 ? 1 : -1));
                if (offset > piece.matrix[0].length) {
                    rotate(piece.matrix, -1);
                    piece.pos.x = pos;
                    return;
                }
            }
            drawTetris();
        }


        function dropTetris() {
            piece.pos.y++;
            if (collide()) {
                piece.pos.y--;
                merge();
                newPiece();
                clearLines();
            }
            drawTetris();
        }


        function rotate(matrix, dir = 1) {
            for (let y = 0; y < matrix.length; ++y) {
                for (let x = 0; x < y; ++x) {
                    [matrix[x][y], matrix[y][x]] = [matrix[y][x], matrix[x][y]];
                }
            }
            if (dir > 0) matrix.forEach(row => row.reverse());
            else matrix.reverse();
        }

        // Ouvir teclado para Desktop
        document.addEventListener('keydown', e => {
            if (document.getElementById('tetris-modal')?.style.display === 'flex') {
                if (e.key === "ArrowLeft") moveTetris(-1);
                if (e.key === "ArrowRight") moveTetris(1);
                if (e.key === "ArrowDown") dropTetris();
                if (e.key === "ArrowUp") rotateTetris();
            }
        });



        function initTetris() {
            const canvas = document.getElementById('tetris-canvas');
            const ctx = canvas.getContext('2d');
            const scale = 20;

            // Cria tabuleiro 10x18
            board = Array.from({ length: 18 }, () => Array(10).fill(0));
            tetrisScore = 0;
            document.getElementById('tetris-score').innerText = "0";

            newPiece();
            if (tetrisInterval) clearInterval(tetrisInterval);
            tetrisInterval = setInterval(updateTetris, 500);
        }

        function newPiece() {
            const shapes = 'ILJOTSZ';
            const type = shapes[Math.floor(Math.random() * shapes.length)];
            piece = {
                pos: { x: 3, y: 0 },
                matrix: createPiece(type),
                color: Math.floor(Math.random() * 7) + 1
            };

            if (collide()) {
                // Game Over - Salva recorde e limpa
                salvarRecorde('tetris', tetrisScore);
                mostrarAviso("Fim de Jogo!", `Pontua√ß√£o: ${tetrisScore}`, "üß±");
                fecharTetris();
            }
        }

        function createPiece(type) {
            if (type === 'I') return [[0, 1, 0, 0], [0, 1, 0, 0], [0, 1, 0, 0], [0, 1, 0, 0]];
            if (type === 'L') return [[0, 2, 0], [0, 2, 0], [0, 2, 2]];
            if (type === 'J') return [[0, 3, 0], [0, 3, 0], [3, 3, 0]];
            if (type === 'O') return [[4, 4], [4, 4]];
            if (type === 'T') return [[0, 5, 0], [5, 5, 5], [0, 0, 0]];
            if (type === 'S') return [[0, 6, 6], [6, 6, 0], [0, 0, 0]];
            if (type === 'Z') return [[7, 7, 0], [0, 7, 7], [0, 0, 0]];
        }

        function collide() {
            const [m, o] = [piece.matrix, piece.pos];
            for (let y = 0; y < m.length; ++y) {
                for (let x = 0; x < m[y].length; ++x) {
                    if (m[y][x] !== 0 && (board[y + o.y] && board[y + o.y][x + o.x]) !== 0) {
                        return true;
                    }
                }
            }
            return false;
        }

        function updateTetris() {
            piece.pos.y++;
            if (collide()) {
                piece.pos.y--;
                merge();
                newPiece();
                clearLines();
            }
            drawTetris();
        }

        function drawTetris() {
            tetrisCtx.fillStyle = "#1a1a2e";
            tetrisCtx.fillRect(0, 0, 200, 400);
            board.forEach((row, y) => row.forEach((val, x) => {
                if (val) { tetrisCtx.fillStyle = val; tetrisCtx.fillRect(x * 20, y * 20, 19, 19); }
            }));
            piece.matrix.forEach((row, y) => row.forEach((val, x) => {
                if (val) { tetrisCtx.fillStyle = piece.color; tetrisCtx.fillRect((x + piece.pos.x) * 20, (y + piece.pos.y) * 20, 19, 19); }
            }));
        }

        function merge() {
            piece.matrix.forEach((row, y) => {
                row.forEach((value, x) => {
                    if (value !== 0) {
                        board[y + piece.pos.y][x + piece.pos.x] = piece.color;
                    }
                });
            });
        }


        function rotatePiece() {
            const matrix = piece.matrix;
            for (let y = 0; y < matrix.length; ++y) {
                for (let x = 0; x < y; ++x) {
                    [matrix[x][y], matrix[y][x]] = [matrix[y][x], matrix[x][y]];
                }
            }
            matrix.forEach(row => row.reverse());

            // Ajuste para n√£o girar dentro da parede
            let offset = 1;
            const pos = piece.pos.x;
            while (collide()) {
                piece.pos.x += offset;
                offset = -(offset + (offset > 0 ? 1 : -1));
                if (offset > matrix[0].length) {
                    // Se n√£o der pra girar, volta ao normal
                    matrix.forEach(row => row.reverse());
                    for (let y = 0; y < matrix.length; ++y) {
                        for (let x = 0; x < y; ++x) {
                            [matrix[x][y], matrix[y][x]] = [matrix[y][x], matrix[x][y]];
                        }
                    }
                    piece.pos.x = pos;
                    return;
                }
            }
            vibrarDispositivo(30);
            drawTetris();
        }

        function clearLines() {
            let linesCleared = 0;
            outer: for (let y = board.length - 1; y > 0; --y) {
                for (let x = 0; x < board[y].length; ++x) {
                    if (board[y][x] === 0) continue outer;
                }
                const row = board.splice(y, 1)[0].fill(0);
                board.unshift(row);
                ++y;
                linesCleared++;
            }
            if (linesCleared > 0) {
                tetrisScore += linesCleared * 100;
                document.getElementById('tetris-score').innerText = tetrisScore;
                vibrarDispositivo(100 * linesCleared);
            }
        }

        function drawTetris() {
            const canvas = document.getElementById('tetris-canvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawMatrix(ctx, board, { x: 0, y: 0 });
            drawMatrix(ctx, piece.matrix, piece.pos, COLORS[piece.color]);
        }

        function drawMatrix(ctx, matrix, offset, colorOverride) {
            matrix.forEach((row, y) => {
                row.forEach((value, x) => {
                    if (value !== 0) {
                        ctx.fillStyle = colorOverride || COLORS[value];
                        ctx.fillRect((x + offset.x) * 20, (y + offset.y) * 20, 19, 19);
                        ctx.strokeStyle = 'rgba(255,255,255,0.1)';
                        ctx.strokeRect((x + offset.x) * 20, (y + offset.y) * 20, 20, 20);
                    }
                });
            });
        }

        function updateTetris() {
            piece.pos.y++;
            if (collide()) {
                piece.pos.y--;
                merge();
                newPiece();
                clearLines();
            }
            drawTetris();
        }

        // Fun√ß√µes de comando para os bot√µes e teclado
        function moveTetris(dir) {
            piece.pos.x += dir;
            if (collide()) piece.pos.x -= dir;
            vibrarDispositivo(20);
            drawTetris();
        }

        function dropTetris() {
            piece.pos.y++;
            if (collide()) {
                piece.pos.y--;
                merge();
                newPiece();
                clearLines();
            }
            vibrarDispositivo(20);
            drawTetris();
        }

        function fecharTetris() { clearInterval(tetrisInterval); closeModal('tetris-modal'); }




        // --- SISTEMA DE RANKING GLOBAL ---

        async function salvarRecorde(jogo, pontuacao) {
            if (!usuarioLogado) return;

            // 1. Busca os dados atuais para n√£o sobrescrever outras informa√ß√µes do progresso
            const { data, error } = await supabaseClient
                .from('usuarios_malu')
                .select('dados_progresso')
                .eq('id', usuarioLogado.id)
                .single();

            if (error) return console.error("Erro ao buscar recordes:", error);

            let progressoAtual = data.dados_progresso || {};
            let recordes = progressoAtual.recordes || { snake: 0, tetris: 0 };

            // 2. S√≥ atualiza o banco se a pontua√ß√£o atual for maior que o recorde antigo
            if (pontuacao > (recordes[jogo] || 0)) {
                recordes[jogo] = pontuacao;
                progressoAtual.recordes = recordes;

                const { error: updateError } = await supabaseClient
                    .from('usuarios_malu')
                    .update({
                        dados_progresso: progressoAtual,
                        ultima_atualizacao: new Date().toISOString()
                    })
                    .eq('id', usuarioLogado.id);

                if (!updateError) {
                    console.log(`üèÜ Novo recorde em ${jogo} salvo na nuvem!`);
                }
            }
        }

        async function abrirRanking() {
            document.getElementById('ranking-modal').style.display = 'flex';
            renderizarRanking('snake'); // Abre por padr√£o no Snake
        }

        async function renderizarRanking(jogo) {
            const lista = document.getElementById('ranking-lista');
            lista.innerHTML = "Carregando campe√£s... ‚è≥";

            // Busca todos os usu√°rios e seus recordes
            const { data: usuarios, error } = await supabaseClient
                .from('usuarios_malu')
                .select('nome, dados_progresso');

            if (error) return lista.innerHTML = "Erro ao carregar.";

            // Mapeia e ordena do maior para o menor
            // Dentro da fun√ß√£o renderizarRanking(jogo)
            const ranking = usuarios
                .map(u => ({
                    nome: u.nome,
                    // Busca o recorde dentro do objeto que voc√™ me mostrou
                    score: (u.dados_progresso && u.dados_progresso.recordes && u.dados_progresso.recordes[jogo]) || 0
                }))
                .sort((a, b) => b.score - a.score); // Ordena do maior para o menor

            lista.innerHTML = "";
            ranking.forEach((user, index) => {
                const medalha = index === 0 ? "ü•á" : (index === 1 ? "ü•à" : (index === 2 ? "ü•â" : ""));
                lista.innerHTML += `
            <div class="ranking-item">
                <span class="ranking-pos">${index + 1}¬∫</span>
                <span class="ranking-name">${user.nome} ${medalha}</span>
                <span class="ranking-score">${user.score} pts</span>
            </div>
        `;
            });
        }

        // --- ATUALIZA√á√ÉO NOS JOGOS PARA SALVAR PONTOS ---

        // No final da fun√ß√£o mainSnake(), onde d√° Game Over:
        // Substitua: mostrarAviso("Game Over!", ...); por:
        function finalizarSnake(score) {
            salvarRecorde('snake', score);
            closeModal('snake-modal');
            mostrarAviso("Game Over!", `A cobra bateu! Pontos: ${score}`, "üêç");
        }

        // No final da fun√ß√£o newPiece() do Tetris, onde d√° Fim de Jogo:
        function finalizarTetris(score) {
            salvarRecorde('tetris', score);
            fecharTetris();
        }


        // Fun√ß√£o para vibrar o celular (milisegundos)
        function vibrarDispositivo(tempo = 50) {
            if (navigator.vibrate) {
                navigator.vibrate(tempo);
            }
        }

    </script>

    <button class="floating-btn btn-curiosidades" onclick="openCuriosities()">
        üí° <span>Curiosidades</span>
    </button>

    <button class="floating-btn btn-desenho" onclick="abrirColorir()"
        style="right: 30px; bottom: 90px; background: #ff758c; color: white;">
        üé® <span>Colorir</span>
    </button>

    <div id="curiosity-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h2 style="font-family: 'Fredoka One'; color: var(--purple);">‚ú® Segredos das Profiss√µes</h2>
            <p>Escolha um tema para descobrir algo incr√≠vel!</p>

            <div class="curiosity-grid" id="curiosity-buttons">
                <button class="curiosity-item-btn" onclick="showCuriosity('direito1')">‚öñÔ∏è O Tribunal de 4 mil
                    Anos</button>
                <button class="curiosity-item-btn" onclick="showCuriosity('medicina1')">ü©∫ O Primeiro
                    Estetosc√≥pio</button>
                <button class="curiosity-item-btn" onclick="showCuriosity('arquitetura1')">üèóÔ∏è Cidades que
                    Flutuam</button>
                <button class="curiosity-item-btn" onclick="showCuriosity('piloto1')">‚úàÔ∏è Por que Avi√µes n√£o
                    Caem?</button>
                <button class="curiosity-item-btn" onclick="showCuriosity('direito2')">üìú A Lei mais Estranha</button>
                <button class="curiosity-item-btn" onclick="showCuriosity('medicina2')">üß† O C√©rebro n√£o Sente
                    Dor</button>
                <button class="curiosity-item-btn" onclick="showCuriosity('arquitetura2')">üè∞ Castelos sem
                    Cimento</button>
                <button class="curiosity-item-btn" onclick="showCuriosity('piloto2')">üå©Ô∏è Raios no Avi√£o</button>
                <button class="curiosity-item-btn" onclick="showCuriosity('extra1')">üíé A Profiss√£o do Espa√ßo</button>
                <button class="curiosity-item-btn" onclick="showCuriosity('extra2')">üé® Designers de Sonhos</button>
            </div>

            <div id="curiosity-display" class="curiosity-text-area"></div>

            <button class="btn" style="margin-top:20px; width:100%" onclick="closeModal('curiosity-modal')">Fechar
                Curiosidades</button>
        </div>
    </div>

    <div id="welcome-modal" class="modal" style="display:flex">
        <div class="modal-content" style="border: 10px solid var(--sky); background: #fff;">
            <h1 style="font-size: 5rem; margin-bottom: 10px;">‚òÄÔ∏è</h1>
            <h2 id="welcome-name" style="color: var(--purple); font-family: 'Fredoka One'; font-size: 2.5rem;">
                Bem-vinda!</h2>
            <p style="font-size: 1.3rem; font-weight: bold; color: var(--dark-pink);">
                O sol j√° nasceu no seu mundo m√°gico! ‚ú®
            </p>
            <p style="font-size: 1.1rem; margin: 20px 0;">
                Voc√™ est√° pronta para brilhar hoje e completar suas miss√µes super divertidas?
                Cada tarefa conclu√≠da te deixa mais perto dos seus sonhos de ser uma grande profissional!
            </p>
            <button class="btn" style="font-size: 1.5rem; padding: 15px 40px; background: var(--yellow); color: #333;"
                onclick="closeModal('welcome-modal')">
                SIM, ESTOU PRONTA! üöÄ
            </button>
        </div>
    </div>

    <div id="game-modal" class="modal">
        <div class="modal-content">
            <h2 style="font-family: 'Fredoka One'; color: var(--purple);">üß† Desafio Inteligente</h2>
            <p id="game-instruction">Fase 1: Monte o Quebra-Cabe√ßa (10 pe√ßas)</p>
            <div id="game-timer">15:00</div>

            <div id="puzzle-container"></div>
            <div id="memory-grid" style="display:none;"></div>

            <div style="margin-top: 15px;">
                <button class="btn" style="background:var(--dark-pink)" onclick="desistirJogo()">Desistir
                    (-30min)</button>
            </div>
        </div>
    </div>

    <div id="game-locked-modal" class="modal">
        <div class="modal-content" style="border-color: var(--yellow);">
            <h1 style="font-size: 3rem; margin: 0;">üöß</h1>
            <h2 style="color: var(--purple); font-family: 'Fredoka One';">Quase l√°, Malu!</h2>
            <p>Para liberar o <b>Jogo Inteligente</b>, voc√™ precisa completar:</p>

            <div id="check-list-container"
                style="text-align: left; background: #f9f9f9; padding: 15px; border-radius: 20px; margin: 10px 0; border: 2px dashed var(--sky);">
                <div id="check-missions" style="margin-bottom: 8px;">‚è≥ Miss√µes (0/5)</div>
                <div id="check-reading" style="margin-bottom: 8px;">‚è≥ Leitura da Hist√≥ria</div>
                <div id="check-curiosity" style="margin-bottom: 8px;">‚è≥ 2 Curiosidades Reais</div>
            </div>

            <button class="btn" style="background: var(--yellow); color: #333; width: 100%;"
                onclick="closeModal('game-locked-modal')">
                Vou terminar agora! üöÄ
            </button>
        </div>
        <span class="close-popup" onclick="fecharLeitura()">√ó</span>

        <button class="btn-restore-hidden" onclick="document.getElementById('fileInput').click()">‚öôÔ∏è</button>
        <input type="file" id="fileInput" style="display:none" onchange="restaurarBackup(event)">
    </div>
    <div id="custom-alert-modal" class="modal">
        <div class="modal-content" style="border-color: var(--pink);">
            <h1 id="custom-alert-emoji" style="font-size: 3rem; margin: 0;">üåü</h1>
            <h2 id="custom-alert-title" style="color: var(--purple); font-family: 'Fredoka One';">Aviso</h2>
            <p id="custom-alert-message" style="font-size: 1.1rem;"></p>
            <button class="btn" style="width: 100%;" onclick="closeModal('custom-alert-modal')">OK!</button>
        </div>
    </div>

    <div id="custom-confirm-modal" class="modal">
        <div class="modal-content" style="border-color: var(--yellow);">
            <h1 style="font-size: 3rem; margin: 0;">ü§î</h1>
            <h2 style="color: var(--purple); font-family: 'Fredoka One';">Tem certeza?</h2>
            <p id="custom-confirm-message" style="font-size: 1.1rem;"></p>
            <div style="display: flex; gap: 10px; width: 100%;">
                <button id="confirm-yes" class="btn" style="background: var(--dark-pink); flex: 1;">Sim, quero
                    sair</button>
                <button class="btn" style="background: var(--sky); color: #333; flex: 1;"
                    onclick="closeModal('custom-confirm-modal')">N√£o, vou ficar</button>
            </div>
        </div>
    </div>

    <div id="pai-modal" class="modal">
        <div class="modal-content" style="border: 8px solid var(--purple);">
            <span class="close-popup" onclick="closeModal('pai-modal')">√ó</span>
            <h2 style="font-family: 'Fredoka One'; color: var(--purple); margin-top: 0;">üìä Painel de Controle Hayden
            </h2>

            <div class="dashboard-grid">



                <div class="dash-card">
                    <div class="dash-title" style="font-size: 0.9rem; color: var(--dark-pink);">üéØ Ajuste Direcionado
                    </div>
                    <div
                        style="display: flex; flex-direction: column; gap: 10px; background: #fff0f5; padding: 15px; border-radius: 15px;">

                        <select id="select-usuario-ajuste"
                            style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid var(--pink);">
                            <option value="todos">üåç Aplicar em Todos</option>
                        </select>

                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="input-ajuste-direcionado" placeholder="Minutos (Ex: 30)"
                                style="flex:1; padding:12px; border-radius:15px; border:2px solid var(--pink);">
                            <button class="btn" style="margin:0; background:var(--dark-pink);"
                                onclick="executarAjusteDirecionado()">Aplicar Ajuste</button>
                        </div>
                    </div>
                </div>

                <div class="dash-card">
                    <div class="dash-title">üì± Onde ela gasta mais tempo?</div>
                    <div id="chart-apps">
                    </div>
                    <div
                        style="margin-top: 15px; padding: 10px; background: #fff9f0; border-radius: 10px; border: 1px dashed #ffb74d;">
                        <small><b>üå≥ Desafio da Natureza:</b> Escolhido nos dias: <br><span id="dias-rua"
                                style="color:#2ecc71; font-weight:bold;">Nenhum ainda</span></small>
                    </div>
                </div>

                <div class="dash-card">
                    <div class="dash-title">üõ†Ô∏è Ajuste Manual de Saldo</div>
                    <p style="font-size: 0.8rem; color: #666;">Saldo Atual: <b id="saldo-admin">0</b> min</p>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="input-ajuste-minutos" placeholder="Ex: 60 ou -30"
                            style="flex:1; padding:12px; border-radius:15px; border:2px solid #ddd;">
                        <button class="btn" style="margin:0; background:var(--purple);"
                            onclick="ajustarMinutosManual()">Aplicar</button>
                    </div>
                    <div class="admin-actions">
                        <button class="btn" style="background: #ffb74d; color: #333; font-size: 0.75rem;"
                            onclick="liberarLeituraManual()">üéÅ Liberar Leitura</button>
                        <button class="btn" style="background: #03a9f4; font-size: 0.75rem;"
                            onclick="liberarCuriosidadesManual()">üí° Liberar Curiosidades</button>
                    </div>
                </div>

                <div class="dash-card">
                    <div class="dash-title">‚öôÔ∏è Gest√£o do Sistema</div>
                    <div class="admin-actions" style="grid-template-columns: 1fr;">
                        <button class="btn" style="background: var(--sky); color: #333;"
                            onclick="fazerBackupManual()">üíæ Sincronizar & Backup</button>
                        <button class="btn" style="background: var(--dark-pink);" onclick="abrirConfirmacaoZerar()">üî•
                            Zerar Tudo (Novo Dia)</button>
                    </div>
                    <p style="font-size: 0.7rem; color: #999; margin-top: 10px; text-align: center;">Dra. Maria Luiza -
                        Sistema v2.0</p>
                </div>

                <div class="dash-card">
                    <div class="dash-title">üîí Controle de Acesso</div>
                    <p style="font-size: 0.8rem; color: #666;">Status do Shopping: <b
                            id="status-trava">Carregando...</b></p>
                    <button id="btn-trava-global" class="btn" style="width: 100%; background: #2ecc71;"
                        onclick="toggleTravaShopping()">
                        LIBERAR SHOPPING AGORA üîì
                    </button>
                </div>

            </div>
        </div>
    </div>

    <div id="modal-confirmar-zerar" class="modal">
        <div class="modal-content" style="border-color: var(--dark-pink);">
            <h1 style="font-size: 4rem;">‚ö†Ô∏è</h1>
            <h2>Aten√ß√£o, Papai!</h2>
            <p>Tem certeza que deseja zerar o tempo e todas as tarefas da Malu agora?</p>
            <div style="display: flex; gap: 10px; width: 100%;">
                <button class="btn" style="background: var(--dark-pink); flex: 1;" onclick="resetManualTotal()">Sim,
                    Zerar!</button>
                <button class="btn" style="background: #ccc; flex: 1;"
                    onclick="closeModal('modal-confirmar-zerar')">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="senha-modal" class="modal">
        <div class="modal-content"
            style="max-width: 320px; border-color: var(--purple); background: #1a1a2e; color: white;">
            <h3 style="font-family: 'Fredoka One'; color: var(--sky); margin-bottom: 5px;">Acesso Restrito</h3>
            <p style="font-size: 0.8rem; opacity: 0.8; margin-bottom: 15px;">Papai Hayden, digite sua chave:</p>

            <div id="senha-display"
                style="background: #16213e; padding: 15px; border-radius: 15px; font-size: 1.8rem; letter-spacing: 8px; margin-bottom: 20px; min-height: 65px; border: 2px solid var(--purple); color: var(--yellow); display: flex; align-items: center; justify-content: center;">
            </div>

            <div class="teclado-numerico">
                <button class="btn-num" onclick="digitarSenha('1')">1</button>
                <button class="btn-num" onclick="digitarSenha('2')">2</button>
                <button class="btn-num" onclick="digitarSenha('3')">3</button>
                <button class="btn-num" onclick="digitarSenha('4')">4</button>
                <button class="btn-num" onclick="digitarSenha('5')">5</button>
                <button class="btn-num" onclick="digitarSenha('6')">6</button>
                <button class="btn-num" onclick="digitarSenha('7')">7</button>
                <button class="btn-num" onclick="digitarSenha('8')">8</button>
                <button class="btn-num" onclick="digitarSenha('9')">9</button>

                <button class="btn-num btn-danger" onclick="limparSenha()">C</button>
                <button class="btn-num" onclick="digitarSenha('0')">0</button>
                <button class="btn-num btn-cancel" onclick="closeModal('senha-modal')">‚úï</button>
            </div>
        </div>
    </div>

    <div id="erro-senha-modal" class="modal">
        <div id="erro-shake-box" class="modal-content" style="border-color: var(--dark-pink); max-width: 350px;">
            <h1 style="font-size: 4rem; margin: 0;">üõë</h1>
            <h2 style="font-family: 'Fredoka One'; color: var(--dark-pink);">Acesso Negado!</h2>
            <p style="font-weight: bold;">Papai Hayden, essa chave n√£o abriu o cofre. Tente novamente! üõ†Ô∏è</p>
            <button class="btn" style="background: var(--purple); width: 100%;"
                onclick="closeModal('erro-senha-modal')">Tentar de Novo üîÑ</button>
        </div>
    </div>

    <div id="gastos-modal" class="modal">
        <div class="modal-content" style="max-width: 600px; border-color: var(--yellow);">
            <h2 style="font-family: 'Fredoka One'; color: var(--purple);">üõçÔ∏è Shopping do Tempo</h2>

            <p>Voc√™ tem <b style="color: var(--dark-pink); font-size: 1.5rem;"><span
                        id="minutos-disponiveis">0</span></b> minutos!</p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%;">
                <div class="card-gasto"
                    style="background: #E50914; color: white; padding: 15px; border-radius: 20px; cursor: pointer;"
                    onclick="gastarApp('Netflix (TV) üé¨')">
                    <span style="font-size: 2rem;">üé¨</span><br><b>Netflix</b>
                </div>
                <div class="card-gasto"
                    style="background: #FF0000; color: white; padding: 15px; border-radius: 20px; cursor: pointer;"
                    onclick="gastarApp('YouTube (TV/Celular) üì∫')">
                    <span style="font-size: 2rem;">üì∫</span><br><b>YouTube</b>
                </div>
                <div class="card-gasto"
                    style="background: #25D366; color: white; padding: 15px; border-radius: 20px; cursor: pointer; grid-column: span 2;"
                    onclick="gastarApp('WhatsApp üí¨')">
                    <span style="font-size: 2rem;">üí¨</span><br><b>WhatsApp</b>
                </div>
            </div>

            <hr style="width: 100%; margin: 20px 0; border: 1px dashed #ccc;">

            <div
                style="background: #d1ffdb; padding: 20px; border-radius: 25px; border: 4px solid #2ecc71; width: 100%; animation: glow-green 2s infinite;">
                <h3 style="margin: 0; color: #157347;">üå≥ DESAFIO DA NATUREZA</h3>
                <p style="font-size: 0.9rem; color: #157347;">Troque seus minutos por divers√£o na rua e <b>ganhe 1 hora
                        extra amanh√£!</b> üéÅ</p>
                <button class="btn" style="background: #2ecc71; color: white; width: 100%; font-size: 1.2rem;"
                    onclick="confirmarGastoRua()">
                    QUERO BRINCAR NA RUA! üèÉ‚Äç‚ôÄÔ∏è
                </button>
            </div>

            <button class="btn" style="margin-top:20px; background: #ccc; color: #333;"
                onclick="closeModal('gastos-modal')">Voltar</button>
        </div>
    </div>

    <div id="rua-bonus-modal" class="modal">
        <div class="modal-content" style="border-color: #2ecc71;">
            <h1 style="font-size: 5rem;">üå≥</h1>
            <h2 style="font-family: 'Fredoka One'; color: #2ecc71;">DECIS√ÉO DE CAMPE√É!</h2>
            <p style="font-size: 1.1rem;">Voc√™ escolheu a divers√£o real! Por causa disso, o Papai Hayden j√° guardou
                <b>60 minutos b√¥nus</b> para o seu celular amanh√£! üéÅ
            </p>
            <button class="btn" style="background: #2ecc71; width: 100%;" onclick="reiniciarComSeguranca()">
                DIVIRTA-SE NA RUA! üëã
            </button>
        </div>
    </div>

    <button class="floating-btn btn-gastos" onclick="abrirModalGasto()">
        üéÆ <span>Gastar Minutos</span>
    </button>

    <div id="modal-selecionar-tempo" class="modal">
        <div class="modal-content" style="border-color: var(--pink); max-width: 400px;">
            <h1 id="icone-app-gasto" style="font-size: 3rem; margin: 0;">üì±</h1>
            <h2 id="titulo-app-gasto" style="color: var(--purple); font-family: 'Fredoka One';">Nome do App</h2>

            <p>Quantos minutos voc√™ quer usar?</p>
            <p style="font-size: 0.8rem; color: #666;">(Saldo: <span id="saldo-atual-modal">0</span> min)</p>

            <input type="number" id="minutos-para-gastar" placeholder="Ex: 30"
                style="width: 100%; padding: 15px; border-radius: 15px; border: 2px solid var(--sky); font-size: 1.2rem; text-align: center; margin-bottom: 15px;">

            <div style="display: flex; gap: 10px; width: 100%;">
                <button class="btn" style="background: var(--pink); flex: 1;"
                    onclick="processarGastoApp()">Confirmar</button>
                <button class="btn" style="background: #ccc; flex: 1;"
                    onclick="closeModal('modal-selecionar-tempo')">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modal-rua-bloqueada" class="modal">
        <div class="modal-content" style="border-color: var(--yellow);">
            <h1 style="font-size: 4rem;">üèÉ‚Äç‚ôÄÔ∏è</h1>
            <h2 style="color: var(--purple); font-family: 'Fredoka One';">Quase l√°, Malu!</h2>
            <p>O <b>Desafio da Natureza</b> √© um pr√™mio especial para quem guarda todo o tempo para brincar na rua!</p>
            <div style="background: #f0fdf4; padding: 15px; border-radius: 20px; border: 2px dashed #2ecc71;">
                <p style="margin: 0; font-size: 0.9rem;">Para liberar, voc√™ precisa ter seu <b>saldo total</b>
                    dispon√≠vel.</p>
            </div>
            <button class="btn" style="background: var(--purple); width: 100%; margin-top: 15px;"
                onclick="closeModal('modal-rua-bloqueada')">Vou economizar! üí™</button>
        </div>
    </div>

    <div id="login-overlay">
        <div class="login-box">
            <h2>Mundo da Malu üåç</h2>

            <div id="login-form">
                <input type="email" id="email-input" placeholder="Seu e-mail">
                <input type="password" id="pass-input" placeholder="Sua senha">
                <button onclick="fazerLogin()">ACESSAR üöÄ</button>
                <p onclick="alternarFormulario('cadastro')">N√£o tem conta? Criar uma agora!</p>
            </div>

            <div id="signup-form" style="display: none;">
                <input type="text" id="reg-nick" placeholder="Seu Nickname (Apelido)">
                <input type="email" id="reg-email" placeholder="Seu e-mail">
                <input type="password" id="reg-pass" placeholder="Crie uma senha">
                <button onclick="criarConta()">CADASTRAR E VERIFICAR üìß</button>
                <p onclick="alternarFormulario('login')">J√° tenho conta. Fazer Login.</p>
            </div>
        </div>
    </div>

    <script>    // --- SCRIPT DE AUDITORIA DE BOT√ïES ---
        (function auditoriaBotoesMalu() {
            console.log("%cüß™ Verificando bot√µes do Mundo da Malu...", "color: purple; font-weight: bold; font-size: 14px;");

            const mapeamento = [
                { nome: "Cards de Miss√£o", seletor: ".card", funcEsperada: "gravarTudoInstantaneo" },
                { nome: "Bot√£o Concluir Leitura", seletor: "#finish-btn", funcEsperada: "gravarTudoInstantaneo" },
                { nome: "Shopping (Gasto Apps)", seletor: ".card-gasto", funcEsperada: "processarGastoApp" },
                { nome: "Painel do Pai (Ajuste)", seletor: "button[onclick*='ajustarMinutosManual']", funcEsperada: "ajustarMinutosManual" }
            ];

            mapeamento.forEach(item => {
                const elementos = document.querySelectorAll(item.seletor);
                if (elementos.length > 0) {
                    console.log(`‚úÖ %c${item.nome}:%c ${elementos.length} encontrado(s).`, "font-weight: bold;", "color: green;");
                } else {
                    console.error(`‚ùå %c${item.nome}:%c N√£o encontrado na p√°gina!`, "font-weight: bold;", "color: red;");
                }
            });

            // Sobrescreve a fun√ß√£o de gravar para avisar quando o banco for acionado
            const originalGravar = window.gravarTudoInstantaneo;
            window.gravarTudoInstantaneo = async function () {
                console.log("%cüì° BANCO DE DADOS: Tentando salvar dados agora...", "color: orange; font-weight: bold;");
                if (originalGravar) return await originalGravar.apply(this, arguments);
            };
        })();</script>



    <div id="modal-colorir" class="modal">
        <div class="modal-content">
            <span class="close-popup" onclick="closeModal('modal-colorir')">√ó</span>
            <h3 style="font-family: 'Fredoka One'; color: var(--purple); margin: 5px;">üé® Pincel M√°gico</h3>

            <div
                style="position: relative; width: 100%; border: 3px solid var(--pink); border-radius: 15px; overflow: hidden; background: white;">
                <img id="img-molde" src=""
                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 100%; max-height: 100%; pointer-events: none; opacity: 0.5; display: none;">
                <canvas id="canvas-colorir"></canvas>
            </div>

            <div style="padding: 10px 0;">
                <div class="ferramentas-mobile">
                    <div style="background: #f0f0f0; padding: 5px; border-radius: 10px;">
                        <label style="font-size: 0.7rem;">üíß Opacidade: <span id="val-opacidade">50</span>%</label>
                        <input type="range" id="range-opacidade" min="0" max="100" value="50" style="width: 100%;"
                            oninput="ajustarOpacidade(this.value)">
                    </div>
                    <div style="background: #eef2ff; padding: 5px; border-radius: 10px;">
                        <label style="font-size: 0.7rem;">üìè Tamanho: <span id="val-tamanho">5</span>px</label>
                        <input type="range" id="range-tamanho" min="1" max="50" value="5" style="width: 100%;"
                            oninput="ajustarTamanhoPincel(this.value)">
                    </div>
                </div>

                <div style="display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap;">
                    <input type="color" id="cor-pincel" value="#ff477e"
                        style="width: 40px; height: 40px; border: none;">
                    <button class="btn" style="padding: 5px 10px; font-size: 0.8rem; flex: 1;"
                        onclick="document.getElementById('input-foto-colorir').click()">üì∑ Foto</button>
                    <button class="btn"
                        style="padding: 5px 10px; font-size: 0.8rem; flex: 1; background: var(--yellow); color: #333;"
                        onclick="limparTela()">Limpar</button>
                    <button class="btn" style="padding: 5px 10px; font-size: 0.8rem; flex: 1; background: #2ecc71;"
                        onclick="baixarDesenho()">Salvar</button>
                </div>
                <input type="file" id="input-foto-colorir" accept="image/*" style="display:none"
                    onchange="carregarFotoPropria(event)">
            </div>
        </div>
    </div>

    <div id="ranking-modal" class="modal">
        <div class="modal-content" style="border-color: var(--yellow); max-width: 400px;">
            <span class="close-popup" onclick="closeModal('ranking-modal')">√ó</span>
            <h2 style="font-family: 'Fredoka One'; color: var(--purple);">üèÜ Ranking de Campe√£s</h2>
            <div id="ranking-tabs" style="display: flex; gap: 5px; margin-bottom: 15px;">
                <button class="btn" style="font-size: 0.7rem; flex: 1; padding: 5px;"
                    onclick="renderizarRanking('snake')">üêç Snake</button>
                <button class="btn" style="font-size: 0.7rem; flex: 1; padding: 5px;"
                    onclick="renderizarRanking('tetris')">üß± Tetris</button>
            </div>
            <div id="ranking-lista" style="width: 100%; background: #f9f9f9; border-radius: 15px; padding: 10px;">
            </div>
            <button class="btn" style="width: 100%; margin-top: 15px; background: var(--sky); color: #333;"
                onclick="closeModal('ranking-modal')">Voltar ao Mundo</button>
        </div>
    </div>


</body>

</html>
