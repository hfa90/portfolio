<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hayden LPR Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src='https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .scan-anim {
            animation: scanLine 2s linear infinite;
        }

        @keyframes scanLine {
            0% {
                top: 0%;
            }

            100% {
                top: 100%;
            }
        }

        #video-preview {
            transform: scaleX(1);
        }
    </style>
</head>

<body class="bg-slate-900 text-white overflow-hidden h-screen flex flex-col">

    <header class="p-6 flex justify-between items-center bg-slate-800/50 backdrop-blur-md">
        <div>
            <h1 class="text-xl font-black tracking-tighter">HAYDEN <span class="text-indigo-500">LPR</span></h1>
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Sistema Ativo</span>
            </div>
        </div>
        <button onclick="location.reload()" class="p-2 bg-slate-700 rounded-full"><i data-lucide="refresh-cw"
                class="w-5 h-5"></i></button>
    </header>

    <main class="flex-1 overflow-y-auto p-4 space-y-3" id="mobile-patio-list">
    </main>

    <div class="p-8 bg-gradient-to-t from-slate-900 via-slate-900 to-transparent">
        <button onclick="abrirCamera()"
            class="w-full bg-indigo-600 hover:bg-indigo-500 h-20 rounded-3xl flex items-center justify-center gap-4 shadow-[0_20px_50px_rgba(79,70,229,0.4)] active:scale-95 transition-all">
            <div class="bg-white/20 p-3 rounded-2xl"><i data-lucide="camera" class="w-8 h-8"></i></div>
            <span class="text-lg font-black uppercase tracking-tight">Escanear Placa</span>
        </button>
    </div>

    <div id="camera-popup" class="fixed inset-0 bg-black z-[100] hidden flex-col">
        <div class="relative flex-1 flex items-center justify-center overflow-hidden">
            <video id="video" class="w-full h-full object-cover" autoplay playsinline></video>

            <div class="absolute inset-0 flex items-center justify-center p-10">
                <div
                    class="w-full aspect-[3/1] border-2 border-indigo-500 rounded-3xl relative overflow-hidden shadow-[0_0_0_1000px_rgba(0,0,0,0.7)]">
                    <div class="absolute w-full h-0.5 bg-indigo-400 shadow-[0_0_15px_#6366f1] scan-anim"></div>
                </div>
            </div>

            <button onclick="fecharCamera()"
                class="absolute top-10 right-6 p-4 bg-white/10 rounded-full backdrop-blur-md text-white">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
        </div>

        <div id="scan-status" class="p-8 bg-slate-900 text-center">
            <p class="text-indigo-400 font-bold animate-pulse uppercase tracking-widest text-xs">Aguardando
                enquadramento...</p>
        </div>
    </div>

    <div id="alert-security-mobile"
        class="fixed inset-0 bg-red-600 z-[200] hidden flex-col items-center justify-center p-8 text-center animate-pulse">
        <div class="bg-white text-red-600 p-6 rounded-full mb-6">
            <i data-lucide="shield-alert" class="w-16 h-16"></i>
        </div>
        <h2 class="text-4xl font-black text-white uppercase mb-2">Placa Suspeita!</h2>
        <p id="alert-plate-display"
            class="text-6xl font-mono font-black text-white border-y-4 border-white py-4 my-6 tracking-widest">-------
        </p>
        <p class="text-red-100 font-bold mb-10">VEÍCULO COM ALERTA NO SISTEMA.<br>PROCEDA COM CAUTELA.</p>
        <button onclick="fecharAlertaSeguranca()"
            class="w-full bg-white text-red-600 py-6 rounded-3xl font-black uppercase text-xl shadow-2xl">Entendido /
            Voltar</button>
    </div>

    <script>
        // 1. Inicialização segura
        let videoStream = null;
        const _supabase = supabase.createClient('https://rwrlhccfltspvqwivuem.supabase.co/', 'sb_publishable_ybAZuMlyoJkPC0g4dRWvfg_IGj0Z7MG');

        async function abrirCamera() {
            const popup = document.getElementById('camera-popup');
            const video = document.getElementById('video');

            // Reset de estado inicial
            popup.classList.replace('hidden', 'flex');

            try {
                // 2. Solicitação da stream com restrições ideais para LPR
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment", // Câmera traseira
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                // 3. Atribuição segura
                videoStream = stream;
                video.srcObject = stream;

                // Garante que o vídeo começou a tocar antes de processar
                video.onloadedmetadata = () => {
                    video.play();
                    iniciarProcessamentoLPR();
                };

            } catch (err) {
                console.error("Falha na Câmera:", err);
                alert("Permissão de câmera negada ou erro de inicialização.");
                fecharCamera();
            }
        }

        function fecharCamera() {
            // 4. Verificação robusta antes de parar os tracks
            if (videoStream) {
                const tracks = videoStream.getTracks();
                tracks.forEach(track => {
                    track.stop();
                    console.log("Track parado:", track.label);
                });
            }

            videoStream = null; // Limpa a referência
            document.getElementById('camera-popup').classList.replace('flex', 'hidden');
            document.getElementById('scan-status').innerHTML = `<p class="text-indigo-400 font-bold animate-pulse uppercase tracking-widest text-xs">Aguardando enquadramento...</p>`;
        }

        async function iniciarProcessamentoLPR() {
            const video = document.getElementById('video');
            const status = document.getElementById('scan-status');

            // Captura um frame a cada 1.5 segundos para não travar o mobile
            const interval = setInterval(async () => {
                if (document.getElementById('camera-popup').classList.contains('hidden')) {
                    clearInterval(interval);
                    return;
                }

                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);

                status.innerHTML = `<p class="text-white font-bold uppercase tracking-widest text-xs">Analisando Imagem...</p>`;

                // OCR via Tesseract
                const result = await Tesseract.recognize(canvas, 'eng');
                const placaIdentificada = limparTextoPlaca(result.data.text);

                if (validarPlaca(placaIdentificada)) {
                    clearInterval(interval);
                    status.innerHTML = `<p class="text-emerald-400 font-black text-xl">${placaIdentificada}</p>`;
                    confirmarEntradaAutomatica(placaIdentificada);
                }
            }, 1500);
        }

        function limparTextoPlaca(txt) {
            // Remove espaços e foca no padrão 7 caracteres
            return txt.replace(/[^A-Z0-9]/ig, "").toUpperCase().slice(0, 7);
        }

        function validarPlaca(p) {
            const regexAntigo = /^[A-Z]{3}[0-9]{4}$/;
            const regexMercosul = /^[A-Z]{3}[0-9][A-Z][0-9]{2}$/;
            return regexAntigo.test(p) || regexMercosul.test(p);
        }

        async function confirmarEntradaAutomatica(placa) {
            const status = document.getElementById('scan-status');
            const { data: { user } } = await _supabase.auth.getUser();

            // 1. CHECAGEM DE SEGURANÇA (Placas Clonadas/Suspeitas)
            const { data: incidente } = await _supabase
                .from('log_seguranca')
                .select('*')
                .eq('placa', placa)
                .maybeSingle();

            if (incidente) {
                dispararAlertaSeguranca(placa);
                return;
            }

            // 2. CHECAGEM DE PÁTIO (Já está dentro?)
            const { data: noPatio } = await _supabase
                .from('veiculos_ativos')
                .select('*')
                .eq('placa', placa)
                .maybeSingle();

            if (noPatio) {
                alert(`O veículo ${placa} já está no pátio desde ${new Date(noPatio.entrada).toLocaleTimeString()}.`);
                fecharCamera();
                return;
            }

            // 3. CHECAGEM DE MENSALISTA / INADIMPLÊNCIA
            const { data: mensalista } = await _supabase
                .from('mensalistas')
                .select('*')
                .eq('placa', placa)
                .maybeSingle();

            if (mensalista) {
                const hoje = new Date().toISOString().split('T')[0];
                const isInadimplente = mensalista.vencimento < hoje;

                if (isInadimplente) {
                    fecharCamera();
                    alert(`BLOQUEADO: Mensalista ${mensalista.nome} está INADIMPLENTE (Venceu em ${new Date(mensalista.vencimento).toLocaleDateString()}).`);
                    return;
                } else {
                    // VIP EM DIA: Cadastra com tag de Mensalista
                    cadastrarFinal(placa, `MENSALISTA: ${mensalista.nome}`, user.id);
                    return;
                }
            }

            // 4. SE TUDO OK: CADASTRO NORMAL
            cadastrarFinal(placa, "SCAN MOBILE LPR", user.id);
        }


        // Função auxiliar para cadastro no Supabase
        async function cadastrarFinal(placa, modelo, userId) {
            const { error } = await _supabase.from('veiculos_ativos').insert([{
                modelo: modelo,
                placa: placa,
                entrada: new Date().toISOString(),
                user_id: userId
            }]);

            if (!error) {
                fecharCamera();
                carregarPatioMobile();
                if (navigator.vibrate) navigator.vibrate(150);
                console.log(`Entrada confirmada: ${placa}`);
            } else {
                alert("Erro ao salvar no banco.");
            }
        }



        function dispararAlertaSeguranca(placa) {
            fecharCamera();
            const alertModal = document.getElementById('alert-security-mobile');
            document.getElementById('alert-plate-display').innerText = placa;
            alertModal.classList.replace('hidden', 'flex');

            // Vibração agressiva (Padrão de Alerta Crítico)
            if (navigator.vibrate) {
                navigator.vibrate([500, 200, 500, 200, 500]);
            }

            lucide.createIcons();
        }

        function fecharAlertaSeguranca() {
            document.getElementById('alert-security-mobile').classList.replace('flex', 'hidden');
            carregarPatioMobile();
        }



        async function carregarPatioMobile() {
            const { data } = await _supabase.from('veiculos_ativos').select('*').order('entrada', { ascending: false });
            const list = document.getElementById('mobile-patio-list');

            list.innerHTML = data.map(v => `
                <div class="bg-slate-800 p-5 rounded-[2rem] border border-slate-700 flex justify-between items-center">
                    <div>
                        <p class="text-xs font-bold text-slate-500 uppercase">${v.modelo}</p>
                        <h3 class="text-xl font-black font-mono text-indigo-400">${v.placa}</h3>
                    </div>
                    <button onclick="removerVeiculo(${v.id})" class="bg-rose-500/10 text-rose-500 p-4 rounded-2xl">
                        <i data-lucide="trash-2"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function removerVeiculo(id) {
            if (!confirm("Deseja remover este veículo?")) return;
            await _supabase.from('veiculos_ativos').delete().eq('id', id);
            carregarPatioMobile();
        }

        window.onload = () => {
            carregarPatioMobile();
            lucide.createIcons();
        }
    </script>
</body>

</html>
