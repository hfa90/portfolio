<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MELÃO RODAS | Gestão</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #1e3a8a;
            --primary-dark: #1e40af;
            --primary-light: #3b82f6;
            --accent: #0ea5e9;
            --accent-hover: #0284c7;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --bg: #f9fafb;
            --bg-secondary: #f3f4f6;
            --bg-card: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Navbar Corporativa Profissional */
        .navbar-custom {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 1.25rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-bottom: 3px solid var(--accent);
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.025em;
            color: white !important;
            text-transform: uppercase;
        }

        .navbar-brand i {
            color: var(--accent);
            margin-right: 0.75rem;
            font-size: 1.75rem;
        }

        .navbar-brand .text-accent {
            color: var(--accent);
            font-weight: 700;
        }

        /* Botões Modernos */
        .btn-modern {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary-modern {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none;
            box-shadow: 0 2px 4px rgba(30, 58, 138, 0.2);
            transition: all 0.2s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            font-size: 0.813rem;
        }

        .btn-primary-modern:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(30, 58, 138, 0.3);
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
        }

        .btn-outline-modern {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-primary-modern:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.2);
        }

        /* Botão Flutuante (FAB) Animado */
        .btn-fab-bolt {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
            z-index: 1050;
            transition: all 0.4s ease;
            animation: pulse-orange 2s infinite;
        }

        .btn-fab-bolt:hover {
            transform: rotate(15deg) scale(1.1);
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }


        @keyframes pulse-orange {
            0% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(245, 158, 11, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
            }
        }

        /* Tela de Bloqueio de Licença */
        .license-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.95) 0%, rgba(30, 64, 175, 0.98) 100%);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .license-box {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .license-icon {
            font-size: 5rem;
            color: var(--warning);
            margin-bottom: 1.5rem;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .license-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .license-message {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .btn-activate-license {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
        }

        .btn-activate-license:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
        }

        /* Modal de Planos - Z-INDEX MAIOR QUE A TELA DE BLOQUEIO */
        #modalLicensePlans {
            z-index: 9999 !important;
        }

        #modalLicensePlans .modal-backdrop {
            z-index: 9998 !important;
        }

        /* Pricing Cards */
        .pricing-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .pricing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .pricing-card.featured {
            border: 3px solid var(--accent);
            box-shadow: 0 10px 30px rgba(14, 165, 233, 0.2);
        }

        .pricing-card.featured::before {
            content: "MAIS VENDIDO";
            position: absolute;
            top: 15px;
            right: -35px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 5px 40px;
            transform: rotate(45deg);
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .pricing-period {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .pricing-price {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .pricing-price-old {
            font-size: 1.2rem;
            color: var(--text-secondary);
            text-decoration: line-through;
            margin-bottom: 1rem;
        }

        .pricing-economy {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            display: inline-block;
        }

        .pricing-features {
            list-style: none;
            padding: 0;
            margin: 1.5rem 0;
            text-align: left;
        }

        .pricing-features li {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .pricing-features li:last-child {
            border-bottom: none;
        }

        .pricing-features i {
            color: var(--success);
            font-size: 1.1rem;
        }

        .btn-select-plan {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-select-plan.plan-basic {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
        }

        .btn-select-plan.plan-featured {
            background: linear-gradient(135deg, var(--accent) 0%, #0284c7 100%);
            color: white;
        }

        .btn-select-plan.plan-premium {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-select-plan:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .license-input-section {
            margin-top: 3rem;
            padding-top: 3rem;
            border-top: 2px solid var(--border);
        }

        .license-input-box {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .license-input {
            flex: 1;
            min-width: 250px;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }

        .license-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-validate-license {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--success) 0%, #047857 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-validate-license:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3);
        }

        .whatsapp-support {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .btn-whatsapp {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-whatsapp:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.3);
        }

        .days-remaining {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, var(--success) 0%, #047857 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
            font-weight: 600;
            z-index: 1000;
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .days-remaining i {
            margin-right: 0.5rem;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .license-input-box {
                flex-direction: column;
            }

            .license-input {
                min-width: 100%;
            }

            .btn-validate-license {
                width: 100%;
            }

            .whatsapp-support {
                flex-direction: column;
            }

            .days-remaining {
                top: 70px;
                right: 10px;
                left: 10px;
                text-align: center;
            }
        }

        /* Tela de Bloqueio de Licença */
        .license-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.95) 0%, rgba(30, 64, 175, 0.98) 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .license-box {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .license-icon {
            font-size: 5rem;
            color: var(--warning);
            margin-bottom: 1.5rem;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .license-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .license-message {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .btn-activate-license {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
        }

        .btn-activate-license:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
        }

        /* Modal de Planos */
        .pricing-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .pricing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .pricing-card.featured {
            border: 3px solid var(--accent);
            box-shadow: 0 10px 30px rgba(14, 165, 233, 0.2);
        }

        .pricing-card.featured::before {
            content: "MAIS VENDIDO";
            position: absolute;
            top: 15px;
            right: -35px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 5px 40px;
            transform: rotate(45deg);
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .pricing-period {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .pricing-price {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .pricing-price-old {
            font-size: 1.2rem;
            color: var(--text-secondary);
            text-decoration: line-through;
            margin-bottom: 1rem;
        }

        .pricing-economy {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            display: inline-block;
        }

        .pricing-features {
            list-style: none;
            padding: 0;
            margin: 1.5rem 0;
            text-align: left;
        }

        .pricing-features li {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .pricing-features li:last-child {
            border-bottom: none;
        }

        .pricing-features i {
            color: var(--success);
            font-size: 1.1rem;
        }

        .btn-select-plan {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-select-plan.plan-basic {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
        }

        .btn-select-plan.plan-featured {
            background: linear-gradient(135deg, var(--accent) 0%, #0284c7 100%);
            color: white;
        }

        .btn-select-plan.plan-premium {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-select-plan:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .license-input-section {
            margin-top: 3rem;
            padding-top: 3rem;
            border-top: 2px solid var(--border);
        }

        .license-input-box {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .license-input {
            flex: 1;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }

        .license-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-validate-license {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--success) 0%, #047857 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-validate-license:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3);
        }

        .whatsapp-support {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .btn-whatsapp {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-whatsapp:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.3);
        }

        .days-remaining {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, var(--success) 0%, #047857 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
            font-weight: 600;
            z-index: 1000;
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .days-remaining i {
            margin-right: 0.5rem;
        }

        /* Botões de Ação na Tabela (Ajuste de Hover) */
        .btn-action-modern {
            transition: all 0.2s ease;
            border: 1px solid var(--border);
        }

        .btn-action-modern:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .btn-outline-modern:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 0.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Cards Modernos */
        .card-modern {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .card-modern:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-1px);
            border-color: var(--primary-light);
        }

        .card-header-modern {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 1.5rem;
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--text-primary);
        }

        /* Busca Moderna */
        .search-box {
            position: relative;
            width: 100%;
            max-width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            background: white;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* Tabela Moderna */
        .table-modern {
            width: 100%;
            background: white;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .table-modern thead {
            background: var(--bg-secondary);
        }

        .table-modern thead th {
            padding: 1rem 1.5rem;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
        }

        .table-modern tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.15s ease;
        }

        .table-modern tbody tr:hover {
            background: var(--bg);
        }

        .table-modern tbody tr:last-child {
            border-bottom: none;
        }

        .table-modern tbody td {
            padding: 1.25rem 1.5rem;
            vertical-align: middle;
            font-size: 0.875rem;
        }

        /* Status Badges */
        .badge-modern {
            padding: 0.375rem 0.875rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .badge-modern:hover {
            transform: scale(1.05);
        }

        .badge-pendente {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-andamento {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-concluido {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-pago {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-cancelado {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Action Buttons */
        .btn-action-modern {
            width: 36px;
            height: 36px;
            border-radius: 0.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            background: white;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn-action-modern:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-action-whatsapp:hover {
            background: #25d366;
            color: white;
            border-color: #25d366;
        }

        .btn-action-print:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .btn-action-edit:hover {
            background: var(--warning);
            color: white;
            border-color: var(--warning);
        }

        .btn-action-delete:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .btn-action-pix:hover {
            background: #00aaa1;
            color: white;
            border-color: #00aaa1;
        }

        .btn-action-orcamento:hover {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }

        .btn-os-cliente:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .btn-os-interno:hover {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }

        /* Imagens */
        .img-thumbnail-modern {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 0.75rem;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .img-thumbnail-modern:hover {
            transform: scale(1.1);
            border-color: var(--accent);
            box-shadow: var(--shadow-lg);
        }

        /* Modal Moderno */
        .modal-content {
            border: none;
            border-radius: 1rem;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
        }

        .modal-title {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            background: var(--bg);
        }

        /* Form Controls Modernos */
        .form-label-modern {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .form-control-modern {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-control-modern:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Toast Moderno */
        .toast-modern {
            border-radius: 0.75rem;
            border: none;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }

        /* Login Screen */
        .login-overlay {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .login-card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border);
        }

        /* Stats Cards */
        .stat-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Empty State */
        .empty-state {
            padding: 4rem 2rem;
            text-align: center;
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--text-secondary);
            opacity: 0.3;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--text-secondary);
        }

        /* Dashboard Toggle */
        #dashboard {
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        /* ========================================
           RESPONSIVIDADE MOBILE - VERSÃO COMPLETA
           ======================================== */

        /* Tablets e dispositivos médios */
        @media (max-width: 992px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            .btn-fab-bolt {
                width: 55px;
                height: 55px;
                bottom: 20px;
                right: 20px;
                font-size: 1.5rem;
            }

            .btn-fab-search {
                width: 55px;
                height: 55px;
                bottom: 85px;
                right: 20px;
                font-size: 1.3rem;
            }
        }

        /* Mobile - 768px e abaixo */
        @media (max-width: 768px) {

            /* Navbar Mobile */
            .navbar-custom {
                padding: 1rem 0;
            }

            .navbar-brand {
                font-size: 1.1rem;
            }

            .navbar-brand i {
                font-size: 1.3rem;
                margin-right: 0.5rem;
            }

            /* Botões da navbar mobile */
            .navbar .d-flex.gap-2 {
                gap: 0.25rem !important;
                flex-wrap: wrap;
            }

            .btn-icon {
                width: 36px !important;
                height: 36px !important;
                font-size: 0.875rem;
            }

            /* Esconde botões secundários em mobile */
            .d-none.d-md-flex {
                display: none !important;
            }

            /* Botões flutuantes mobile */
            .btn-fab-bolt {
                width: 50px;
                height: 50px;
                bottom: 15px;
                right: 15px;
                font-size: 1.3rem;
            }

            .btn-fab-search {
                width: 50px;
                height: 50px;
                bottom: 75px;
                right: 15px;
                font-size: 1.1rem;
            }

            /* Stats cards mobile */
            .stat-card {
                margin-bottom: 1rem;
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .stat-label {
                font-size: 0.75rem;
            }

            .stat-icon {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            /* Dashboard mobile */
            #dashboard {
                padding: 1rem;
            }

            /* Tabela mobile - modo scroll horizontal */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table-modern {
                font-size: 0.75rem;
                min-width: 600px;
            }

            .table-modern thead th {
                padding: 0.5rem 0.25rem;
                font-size: 0.7rem;
            }

            .table-modern tbody td {
                padding: 0.75rem 0.5rem;
                font-size: 0.75rem;
            }

            /* Botões de ação na tabela - mobile */
            .btn-action-modern {
                width: 32px;
                height: 32px;
                font-size: 0.75rem;
            }

            /* Cards mobile */
            .card-modern {
                margin-bottom: 1rem;
            }

            /* Modal mobile */
            .modal-dialog {
                margin: 0.5rem;
            }

            .modal-content {
                border-radius: 0.75rem;
            }

            .modal-header,
            .modal-footer {
                padding: 1rem;
            }

            .modal-body {
                padding: 1rem;
            }

            .modal-title {
                font-size: 1.1rem;
            }

            /* Forms mobile */
            .form-control-modern {
                font-size: 1rem;
                /* Previne zoom no iOS */
                padding: 0.875rem 1rem;
            }

            .form-label-modern {
                font-size: 0.875rem;
                margin-bottom: 0.375rem;
            }

            /* Botões mobile */
            .btn-primary-modern {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }

            .btn-modern {
                padding: 0.5rem 1rem;
                font-size: 0.813rem;
            }

            /* Search box mobile */
            .search-box {
                max-width: 100%;
            }

            .search-box input {
                font-size: 1rem;
                padding: 0.75rem 1rem 0.75rem 2.75rem;
            }

            /* Badges mobile */
            .badge-modern {
                font-size: 0.65rem;
                padding: 0.25rem 0.5rem;
            }

            /* Grid responsivo */
            .row.g-3,
            .row.g-4 {
                margin-left: -0.5rem;
                margin-right: -0.5rem;
            }

            .row.g-3>*,
            .row.g-4>* {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
        }

        /* Mobile pequeno - 576px e abaixo */
        @media (max-width: 576px) {

            /* Container mobile pequeno */
            .container {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }

            /* Navbar ultra mobile */
            .navbar-brand {
                font-size: 1rem;
            }

            .navbar-brand i {
                display: none;
                /* Esconde ícone em telas muito pequenas */
            }

            /* Stats em coluna única */
            .stat-card {
                text-align: center;
            }

            /* Tabela mobile pequeno */
            .table-modern {
                font-size: 0.7rem;
            }

            .table-modern thead th {
                padding: 0.4rem 0.2rem;
                font-size: 0.65rem;
            }

            .table-modern tbody td {
                padding: 0.5rem 0.25rem;
            }

            /* Botões de ação menores */
            .btn-action-modern {
                width: 28px;
                height: 28px;
                font-size: 0.7rem;
            }

            /* Modal fullscreen em mobile muito pequeno */
            .modal-dialog {
                margin: 0;
                max-width: 100%;
                height: 100vh;
            }

            .modal-content {
                height: 100%;
                border-radius: 0;
            }

            /* Forms em mobile pequeno */
            .row.g-2>*,
            .row.g-3>* {
                margin-bottom: 0.75rem;
            }

            /* Botões full width em mobile */
            .btn-modern,
            .btn-primary-modern {
                width: 100%;
                justify-content: center;
            }

            /* Gráficos mobile */
            canvas {
                max-height: 250px !important;
            }
        }

        /* Landscape mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .modal-dialog {
                max-height: 90vh;
                overflow-y: auto;
            }

            .btn-fab-bolt,
            .btn-fab-search {
                right: 10px;
            }

            .btn-fab-bolt {
                bottom: 10px;
            }

            .btn-fab-search {
                bottom: 70px;
            }
        }

        /* Touch targets mínimos (acessibilidade) */
        @media (max-width: 768px) {

            button,
            .btn,
            a.btn,
            input[type="button"],
            input[type="submit"] {
                min-height: 44px;
                /* Padrão Apple HIG */
                min-width: 44px;
            }

            /* Aumenta área de toque de checkboxes e radios */
            input[type="checkbox"],
            input[type="radio"] {
                min-width: 22px;
                min-height: 22px;
            }
        }

        /* Previne zoom em inputs no iOS */
        @media (max-width: 768px) {

            input[type="text"],
            input[type="email"],
            input[type="tel"],
            input[type="number"],
            input[type="password"],
            input[type="date"],
            select,
            textarea {
                font-size: 16px !important;
            }
        }

        /* Esconde scrollbars desnecessárias em mobile */
        @media (max-width: 768px) {
            ::-webkit-scrollbar {
                width: 4px;
                height: 4px;
            }

            ::-webkit-scrollbar-track {
                background: transparent;
            }

            ::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.2);
                border-radius: 4px;
            }
        }

        /* Botões de Emissão de OS */
        .os-print-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-os-cliente {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-os-cliente:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
        }

        .btn-os-interno {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .btn-os-interno:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: white;
        }

        /* Animações Suaves */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }




        /* Botão Flutuante de Pesquisa (Dossiê) */
        .btn-fab-search {
            position: fixed;
            bottom: 105px;
            /* Fica acima do botão de Nova OS */
            right: 30px;
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
            z-index: 1050;
            transition: all 0.4s ease;
        }

        .btn-fab-search:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.5);
        }

        /* ========================================
           MENU MOBILE HAMBURGER
           ======================================== */
        .mobile-menu-btn {
            display: none;
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .mobile-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .mobile-menu.active {
            right: 0;
        }

        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: none;
        }

        .mobile-menu-overlay.active {
            display: block;
        }

        .mobile-menu-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mobile-menu-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 0.5rem;
            font-size: 1.25rem;
            cursor: pointer;
        }

        .mobile-menu-items {
            padding: 1rem;
        }

        .mobile-menu-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .mobile-menu-item:hover {
            background: var(--bg-secondary);
        }

        .mobile-menu-item i {
            width: 24px;
            font-size: 1.25rem;
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .navbar .btn-icon.d-none {
                display: none !important;
            }
        }

        /* Ajustes adicionais para mobile */
        @media (max-width: 768px) {

            /* Login mobile */
            .login-card {
                padding: 2rem !important;
                margin: 1rem;
            }

            /* Melhora visualização de gráficos em mobile */
            #graficoFaturamento,
            #graficoServicos {
                height: 250px !important;
            }
        }

        #countdown-bar {
            display: none;
            background: #212529;
            color: #fff;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 9999;
            border-bottom: 2px solid #ffc107;
        }

        #countdown-timer {
            color: #ffc107;
            margin-left: 5px;
        }
    </style>
</head>

<body>
    <div id="countdown-bar">
        <i class="fa-solid fa-clock-rotate-left me-2"></i>
        Tempo de Licença Restante: <span id="countdown-timer">--:--:--</span>
    </div>
    <!-- Tela de Bloqueio de Licença -->
    <div id="licenseOverlay" class="license-overlay" style="display: none;">
        <div class="license-box">
            <!-- Ícone do cadeado com contador secreto -->
            <div class="license-icon" id="lockIconBtn" onclick="masterClickHandler()"
                style="cursor:pointer; user-select:none;">
                <i class="fa-solid fa-lock" id="lockIconGlyph"></i>
            </div>
            <!-- Indicador sutil de cliques -->
            <div id="masterClickDots" style="display:none; margin-bottom:0.5rem; height:12px; text-align:center;">
                <span id="dot1"
                    style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#e5e7eb;margin:0 3px;transition:background 0.2s;"></span>
                <span id="dot2"
                    style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#e5e7eb;margin:0 3px;transition:background 0.2s;"></span>
                <span id="dot3"
                    style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#e5e7eb;margin:0 3px;transition:background 0.2s;"></span>
                <span id="dot4"
                    style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#e5e7eb;margin:0 3px;transition:background 0.2s;"></span>
                <span id="dot5"
                    style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#e5e7eb;margin:0 3px;transition:background 0.2s;"></span>
            </div>

            <!-- Painel normal -->
            <div id="licenseNormalPanel">
                <h2 class="license-title">Sistema Bloqueado</h2>
                <p class="license-message">
                    Para continuar usando o sistema, é necessário ativar uma licença válida.
                    Escolha um de nossos planos ou insira sua chave de licença.
                </p>
                <button class="btn-activate-license" onclick="showLicensePlans()">
                    <i class="fa-solid fa-key me-2"></i>Ativar Licença
                </button>
            </div>

            <!-- Painel Master (oculto até 5 cliques) -->
            <div id="masterLoginPanel" style="display:none; margin-top:0.5rem;">
                <div style="border-top:2px dashed #dc2626; padding-top:1.25rem; margin-top:0.5rem;">
                    <p
                        style="font-size:0.8rem; color:#dc2626; font-weight:700; text-transform:uppercase; letter-spacing:1px; margin-bottom:1rem;">
                        <i class="fa-solid fa-shield-halved me-1"></i> Acesso Master
                    </p>
                    <input type="text" id="masterUser" class="form-control mb-2" placeholder="Usuário master"
                        style="font-size:0.9rem; border:2px solid #dc2626;" autocomplete="off">
                    <input type="password" id="masterPass" class="form-control mb-3" placeholder="Senha master"
                        style="font-size:0.9rem; border:2px solid #dc2626;" autocomplete="off"
                        onkeydown="if(event.key==='Enter') confirmarMasterLogin()">
                    <div id="masterLoginErro"
                        style="display:none; color:#dc2626; font-size:0.8rem; margin-bottom:0.75rem;">
                        <i class="fa-solid fa-circle-xmark me-1"></i> Usuário ou senha incorretos.
                    </div>
                    <div style="display:flex; gap:0.5rem;">
                        <button onclick="confirmarMasterLogin()"
                            style="flex:1; padding:0.75rem; background:linear-gradient(135deg,#dc2626,#991b1b); color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer;">
                            <i class="fa-solid fa-right-to-bracket me-1"></i> Entrar
                        </button>
                        <button onclick="fecharMasterPanel()"
                            style="padding:0.75rem 1rem; background:#f3f4f6; color:#6b7280; border:none; border-radius:8px; font-weight:600; cursor:pointer;">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicador de Dias Restantes -->
    <div id="daysRemaining" class="days-remaining" style="display: none;">
        <i class="fa-solid fa-clock"></i>
        <span id="daysRemainingText">30 dias restantes</span>
    </div>

    <!-- Modal de Planos de Licença -->
    <div class="modal fade" id="modalLicensePlans" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fa-solid fa-crown me-2"></i>Escolha seu Plano de Licença
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        id="closeLicenseModal"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Planos -->
                    <div class="row g-4 mb-5">
                        <!-- Plano 30 Dias -->
                        <div class="col-md-4">
                            <div class="pricing-card">
                                <div class="pricing-period">Plano Mensal</div>
                                <div class="pricing-price">R$ 39,90</div>
                                <div class="pricing-price-old">R$ 59,90</div>
                                <ul class="pricing-features">
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Acesso total por 30 dias</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Todas as funcionalidades</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Suporte via WhatsApp</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Atualizações incluídas</span>
                                    </li>
                                </ul>
                                <button class="btn-select-plan plan-basic" onclick="selectPlan(30, 39.90)">
                                    Escolher Mensal
                                </button>
                            </div>
                        </div>

                        <!-- Plano 6 Meses (MAIS VENDIDO) -->
                        <div class="col-md-4">
                            <div class="pricing-card featured">
                                <div class="pricing-period">Plano Semestral</div>
                                <div class="pricing-price">R$ 179,90</div>
                                <div class="pricing-price-old">R$ 359,40</div>
                                <div class="pricing-economy">
                                    <i class="fa-solid fa-piggy-bank me-1"></i>
                                    ECONOMIZE 50%
                                </div>
                                <ul class="pricing-features">
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Acesso total por 6 meses</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Todas as funcionalidades</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Suporte prioritário</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Atualizações incluídas</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span><strong>R$ 29,98/mês</strong></span>
                                    </li>
                                </ul>
                                <button class="btn-select-plan plan-featured" onclick="selectPlan(180, 179.90)">
                                    Escolher Semestral
                                </button>
                            </div>
                        </div>

                        <!-- Plano 1 Ano (MELHOR CUSTO-BENEFÍCIO) -->
                        <div class="col-md-4">
                            <div class="pricing-card">
                                <div class="pricing-period">Plano Anual</div>
                                <div class="pricing-price">R$ 299,90</div>
                                <div class="pricing-price-old">R$ 718,80</div>
                                <div class="pricing-economy">
                                    <i class="fa-solid fa-star me-1"></i>
                                    ECONOMIZE 58%
                                </div>
                                <ul class="pricing-features">
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Acesso total por 1 ano</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Todas as funcionalidades</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Suporte VIP 24/7</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Atualizações incluídas</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span><strong>R$ 24,99/mês</strong></span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-gift"></i>
                                        <span><strong>2 meses GRÁTIS</strong></span>
                                    </li>
                                </ul>
                                <button class="btn-select-plan plan-premium" onclick="selectPlan(365, 299.90)">
                                    Escolher Anual
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Seção de Pagamento -->
                    <div id="paymentSection" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fa-solid fa-qrcode me-2"></i>
                            <strong>Pagamento via PIX</strong><br>
                            Após escolher seu plano, entre em contato pelo WhatsApp para receber a chave PIX e
                            instruções de pagamento.
                        </div>
                    </div>

                    <!-- Seção de Inserir Licença -->
                    <div class="license-input-section">
                        <h6 class="fw-bold mb-3 text-center">Já possui uma licença?</h6>
                        <div class="license-input-box">
                            <input type="text" id="licenseKeyInput" class="license-input"
                                placeholder="XXXX-XXXX-XXXX-XXXX-XXXX" maxlength="500">
                            <button class="btn-validate-license" onclick="validateLicense()">
                                <i class="fa-solid fa-check me-2"></i>Ativar
                            </button>
                        </div>

                        <div class="whatsapp-support">
                            <span>Não tem uma licença?</span>
                            <button class="btn-whatsapp" onclick="contactWhatsApp()">
                                <i class="fa-brands fa-whatsapp"></i>
                                Solicitar no WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="closeMobileMenu()"></div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <div>
                <h5 class="mb-0 fw-bold">Menu</h5>
                <small>MELÃO RODAS</small>
            </div>
            <button class="mobile-menu-close" onclick="closeMobileMenu()">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <div class="mobile-menu-items">
            <button class="mobile-menu-item" onclick="toggleDashboard(); closeMobileMenu();">
                <i class="fa-solid fa-chart-line"></i>
                <span>Dashboard</span>
            </button>
            <button class="mobile-menu-item" data-bs-toggle="modal" data-bs-target="#modalCadastro"
                onclick="closeMobileMenu()">
                <i class="fa-solid fa-user-plus"></i>
                <span>Novo Cliente</span>
            </button>
            <button class="mobile-menu-item" data-bs-toggle="modal" data-bs-target="#modalEstoque"
                onclick="closeMobileMenu()">
                <i class="fa-solid fa-box-open"></i>
                <span>Estoque</span>
            </button>
            <button class="mobile-menu-item" data-bs-toggle="modal" data-bs-target="#modalConfiguracoes"
                onclick="closeMobileMenu()">
                <i class="fa-solid fa-gear"></i>
                <span>Configurações</span>
            </button>
            <hr class="my-2">
            <button class="mobile-menu-item" onclick="abrirOSRapida(); closeMobileMenu();">
                <i class="fa-solid fa-bolt"></i>
                <span>Nova Ordem de Serviço</span>
            </button>
            <button class="mobile-menu-item" onclick="abrirBuscadorCliente(); closeMobileMenu();">
                <i class="fa-solid fa-magnifying-glass"></i>
                <span>Buscar Cliente</span>
            </button>
            <hr class="my-2">
            <button class="mobile-menu-item" onclick="logout()">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span>Sair</span>
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 10000;">
        <div id="customToast" class="toast toast-modern align-items-center text-white bg-dark border-0" role="alert"
            aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body d-flex align-items-center">
                    <i id="toastIcon" class="fa-solid fa-circle-check me-2 fs-5"></i>
                    <span id="toastMessage" class="fw-semibold">Mensagem aqui</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <!-- Login Overlay -->
    <div id="loginOverlay"
        class="login-overlay position-fixed vh-100 vw-100 top-0 start-0 d-flex align-items-center justify-content-center"
        style="z-index: 9999;">
        <div class="login-card p-5" style="width: 100%; max-width: 420px;">

            <!-- Cabeçalho -->
            <div class="text-center mb-4">
                <i class="fa-solid fa-screwdriver-wrench text-primary fs-1 mb-3"
                    style="color: var(--accent) !important;"></i>
                <h2 class="fw-bold mb-2">MELÃO <span class="text-accent">RODAS</span></h2>
                <p class="text-muted mb-0" id="loginSubtitle">Sistema de Gestão de Serviços</p>
            </div>

            <!-- ===== PAINEL DE LOGIN ===== -->
            <div id="painelLogin">
                <form id="loginForm">
                    <div class="mb-3">
                        <label class="form-label-modern">E-mail</label>
                        <input type="email" id="loginEmail" class="form-control form-control-modern"
                            placeholder="seu@email.com" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label-modern">Senha</label>
                        <input type="password" id="loginSenha" class="form-control form-control-modern"
                            placeholder="••••••••" required>
                    </div>
                    <div id="loginErro" class="alert alert-danger py-2 mb-3"
                        style="display: none; border-radius: 0.5rem;"></div>
                    <button type="submit" class="btn btn-primary-modern w-100 py-3 fw-bold"
                        style="border-radius: 0.75rem;">
                        <i class="fa-solid fa-right-to-bracket me-2"></i>ENTRAR NO SISTEMA
                    </button>
                </form>
                <div class="text-center mt-3">
                    <span class="text-muted" style="font-size:0.875rem;">Não tem uma conta?</span>
                    <button onclick="alternarParaCadastro()" class="btn btn-link p-0 ms-1 fw-bold"
                        style="font-size:0.875rem; color:var(--accent); text-decoration:none;">
                        Criar conta
                    </button>
                </div>
            </div>

            <!-- ===== PAINEL DE CADASTRO ===== -->
            <div id="painelCadastro" style="display:none;">
                <form id="cadastroForm">
                    <div class="mb-3">
                        <label class="form-label-modern">Nome completo</label>
                        <input type="text" id="cadNome" class="form-control form-control-modern" placeholder="Seu nome"
                            required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label-modern">E-mail</label>
                        <input type="email" id="cadEmail" class="form-control form-control-modern"
                            placeholder="seu@email.com" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label-modern">Senha</label>
                        <input type="password" id="cadSenha" class="form-control form-control-modern"
                            placeholder="Mínimo 6 caracteres" required minlength="6">
                    </div>
                    <div class="mb-4">
                        <label class="form-label-modern">Confirmar senha</label>
                        <input type="password" id="cadSenhaConf" class="form-control form-control-modern"
                            placeholder="Repita a senha" required minlength="6">
                    </div>
                    <div id="cadErro" class="alert alert-danger py-2 mb-3" style="display:none; border-radius:0.5rem;">
                    </div>
                    <div id="cadSucesso" class="alert alert-success py-2 mb-3"
                        style="display:none; border-radius:0.5rem;"></div>
                    <button type="submit" id="btnCadastrar" class="btn btn-primary-modern w-100 py-3 fw-bold"
                        style="border-radius:0.75rem;">
                        <i class="fa-solid fa-user-plus me-2"></i>CRIAR CONTA
                    </button>
                </form>
                <div class="text-center mt-3">
                    <span class="text-muted" style="font-size:0.875rem;">Já tem uma conta?</span>
                    <button onclick="alternarParaLogin()" class="btn btn-link p-0 ms-1 fw-bold"
                        style="font-size:0.875rem; color:var(--accent); text-decoration:none;">
                        Fazer login
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-custom navbar-dark">
        <div class="container">
            <div class="d-flex align-items-center justify-content-between w-100">
                <a class="navbar-brand" href="#" id="logoClick" style="cursor: default; user-select: none;">
                    <i class="fa-solid fa-screwdriver-wrench"></i>MELÃO <span class="text-accent">RODAS</span>
                </a>
                <div class="d-flex align-items-center gap-2">
                    <!-- Menu Mobile Hamburger -->
                    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                        <i class="fa-solid fa-bars"></i>
                    </button>

                    <button class="btn btn-outline-modern btn-icon d-none d-md-flex" data-bs-toggle="modal"
                        data-bs-target="#modalEstoque" title="Estoque">
                        <i class="fa-solid fa-box-open"></i>
                    </button>
                    <button class="btn btn-outline-modern btn-icon d-none d-md-flex" onclick="toggleDashboard()"
                        title="Dashboard">
                        <i class="fa-solid fa-chart-line"></i>
                    </button>
                    <button class="btn btn-outline-modern btn-icon d-none d-md-flex" data-bs-toggle="modal"
                        data-bs-target="#modalConfiguracoes" title="Configurações">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                    <button class="btn-fab-bolt" onclick="abrirOSRapida()" title="Atalho: ALT + N">
                        <i class="fa-solid fa-bolt"></i>
                    </button>

                    <button class="btn-fab-search" onclick="abrirBuscadorCliente()" title="Pesquisar Cliente (ALT + H)">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                    <button class="btn btn-outline-modern btn-icon" onclick="logout()" title="Sair">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container mt-4 mb-5">
        <!-- Dashboard -->
        <div id="dashboard" style="display: none;">
            <h3 class="fw-bold mb-4">Dashboard Financeiro</h3>

            <!-- Filtro de Datas -->
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label class="form-label-modern">Data Inicial</label>
                    <input type="date" id="dataInicio" class="form-control form-control-modern"
                        onchange="atualizarDashboard()">
                </div>
                <div class="col-md-4">
                    <label class="form-label-modern">Data Final</label>
                    <input type="date" id="dataFim" class="form-control form-control-modern"
                        onchange="atualizarDashboard()">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button class="btn btn-primary-modern w-100" onclick="exportarExcel()">
                        <i class="fa-solid fa-file-excel me-2"></i>Exportar Excel
                    </button>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #d1fae5; color: #10b981;">
                            <i class="fa-solid fa-check-circle"></i>
                        </div>
                        <div class="stat-value" style="color: #10b981;" id="dashPago">R$ 0,00</div>
                        <div class="stat-label">Pagos</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #fef3c7; color: #f59e0b;">
                            <i class="fa-solid fa-clock"></i>
                        </div>
                        <div class="stat-value" style="color: #f59e0b;" id="dashPendente">R$ 0,00</div>
                        <div class="stat-label">Pendentes</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #dbeafe; color: #3b82f6;">
                            <i class="fa-solid fa-spinner"></i>
                        </div>
                        <div class="stat-value" style="color: #3b82f6;" id="dashAndamento">R$ 0,00</div>
                        <div class="stat-label">Em Andamento</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #e0e7ff; color: #6366f1;">
                            <i class="fa-solid fa-dollar-sign"></i>
                        </div>
                        <div class="stat-value" style="color: #6366f1;" id="dashTotal">R$ 0,00</div>
                        <div class="stat-label">Total Geral</div>
                    </div>

                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #ede9fe; color: #7c3aed;">
                            <i class="fa-solid fa-vault"></i>
                        </div>
                        <div class="stat-value" style="color: #7c3aed;" id="dashEstoqueTotal">R$ 0,00</div>
                        <div class="stat-label">Valor em Estoque (Custo)</div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #dcfce7; color: #15803d;">
                            <i class="fa-solid fa-chart-line"></i>
                        </div>
                        <div class="stat-value" style="color: #15803d;" id="dashLucro">R$ 0,00</div>
                        <div class="stat-label">Lucro (Serviços Pagos)</div>
                    </div>
                </div>
            </div>
            <div class="card-modern p-4">
                <h5 class="fw-bold mb-3">Serviços Mais Realizados</h5>
                <canvas id="graficoVendas" style="max-height: 300px;"></canvas>
            </div>
            <div class="card-modern p-4 mt-4">
                <h5 class="fw-bold mb-3"><i class="fa-solid fa-hand-holding-dollar me-2"></i>Rentabilidade por Tipo de
                    Serviço</h5>
                <canvas id="graficoLucroServico" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- Header com Busca -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <h3 class="fw-bold mb-0">Ordens de Serviço</h3>
            <div class="search-box">
                <i class="fa-solid fa-search"></i>
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar por cliente, veículo...">
            </div>
        </div>

        <!-- Tabela de O.S. -->
        <div class="card-modern">
            <div class="table-responsive">
                <table class="table table-modern mb-0">
                    <thead>
                        <tr>
                            <th>Foto</th>
                            <th>Cliente</th>
                            <th>Veículo</th>
                            <th>Serviço</th>
                            <th>Status</th>
                            <th>Valor</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaOS">
                        <!-- Dados serão inseridos aqui -->
                    </tbody>
                </table>
            </div>
            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fa-solid fa-clipboard-list"></i>
                <h3>Nenhuma ordem de serviço</h3>
                <p>Comece criando sua primeira O.S. clicando em "Nova O.S."</p>
            </div>
        </div>
    </div>

    <!-- Modal Cadastro O.S. -->
    <div class="modal fade" id="modalCadastro" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fa-solid fa-plus-circle me-2"></i>Nova Ordem de Serviço</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="formCadastro">
                    <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label-modern">Nome do Cliente</label>
                                <input type="text" id="nome" class="form-control form-control-modern form-control-sm"
                                    required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">WhatsApp</label>
                                <input type="tel" id="whatsapp" class="form-control form-control-modern form-control-sm"
                                    required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">Veículo (Placa)</label>
                                <input type="text" id="veiculo" class="form-control form-control-modern form-control-sm"
                                    required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">Status</label>
                                <select id="status" class="form-select form-control-modern form-control-sm" required>
                                    <option value="Pendente">Pendente</option>
                                    <option value="Em Andamento">Em Andamento</option>
                                    <option value="Pago">Pago</option>
                                </select>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label-modern">Adicionar Produto ou Serviço</label>
                                <select id="selectProduto" class="form-select form-control-modern form-control-sm">
                                    <option value="">Selecione um item...</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">Foto (opcional)</label>
                                <input type="file" id="fotoInput"
                                    class="form-control form-control-modern form-control-sm" accept="image/*">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">Valor (R$)</label>
                                <input type="number" id="valor" class="form-control form-control-modern form-control-sm"
                                    step="0.01" value="0" required>
                            </div>
                            <div class="col-12" id="listaPecas" style="min-height: 30px;">
                                <!-- Produtos e serviços adicionados aparecerão aqui -->
                            </div>
                            <div class="col-12">
                                <label class="form-label-modern">Observações (campo livre - opcional)</label>
                                <textarea id="observacoes" class="form-control form-control-modern form-control-sm"
                                    rows="2"
                                    placeholder="Notas adicionais, informações extras para o cliente..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-modern btn-sm" data-bs-dismiss="modal"
                            style="color: var(--text-secondary); border-color: var(--border);">Cancelar</button>
                        <button type="submit" id="btnSalvar" class="btn btn-primary-modern btn-sm">
                            <i class="fa-solid fa-save me-2"></i>Salvar O.S.
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Edição O.S. -->
    <div class="modal fade" id="modalEdicao" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fa-solid fa-edit me-2"></i>Editar Ordem de Serviço</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="formEdicao">
                    <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
                        <input type="hidden" id="editId">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label-modern">Nome do Cliente</label>
                                <input type="text" id="editNome"
                                    class="form-control form-control-modern form-control-sm" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">WhatsApp</label>
                                <input type="tel" id="editWhatsapp"
                                    class="form-control form-control-modern form-control-sm" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">Veículo (Placa)</label>
                                <input type="text" id="editVeiculo"
                                    class="form-control form-control-modern form-control-sm" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">Status</label>
                                <select id="editStatus" class="form-select form-control-modern form-control-sm"
                                    required>
                                    <option value="Pendente">Pendente</option>
                                    <option value="Em Andamento">Em Andamento</option>
                                    <option value="Pago">Pago</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">Valor (R$)</label>
                                <input type="number" id="editValor"
                                    class="form-control form-control-modern form-control-sm" step="0.01" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">Adicionar Produtos</label>
                                <select id="selectProdutoEdit" class="form-select form-control-modern form-control-sm">
                                    <option value="">Selecione um produto...</option>
                                </select>
                            </div>
                            <div class="col-12" id="listaPecasEdit" style="min-height: 30px;">
                                <!-- Produtos adicionados aparecerão aqui -->
                            </div>
                            <div class="col-12">
                                <label class="form-label-modern">Observações (campo livre - opcional)</label>
                                <textarea id="editObservacoes" class="form-control form-control-modern form-control-sm"
                                    rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-modern btn-sm" data-bs-dismiss="modal"
                            style="color: var(--text-secondary); border-color: var(--border);">Cancelar</button>
                        <button type="submit" class="btn btn-primary-modern btn-sm">
                            <i class="fa-solid fa-save me-2"></i>Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Estoque Unificado -->
    <div class="modal fade" id="modalEstoque" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fa-solid fa-box-open me-2"></i>Produtos &amp; Serviços</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="estoqueForm" class="mb-4 p-4" style="background: var(--bg); border-radius: 0.75rem;">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label-modern">Tipo</label>
                                <select id="prodTipo" class="form-select form-control-modern"
                                    onchange="alternarCamposTipo()">
                                    <option value="produto">📦 Produto</option>
                                    <option value="servico">🔧 Serviço</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label-modern" id="labelProdNome">Nome</label>
                                <input type="text" id="prodNome" class="form-control form-control-modern" required>
                            </div>
                            <div class="col-md-2" id="campoCusto">
                                <label class="form-label-modern">Custo (R$)</label>
                                <input type="number" id="prodCusto" class="form-control form-control-modern"
                                    step="0.01">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label-modern">Preço Venda (R$)</label>
                                <input type="number" id="prodVenda" class="form-control form-control-modern" step="0.01"
                                    required>
                            </div>
                            <div class="col-md-1" id="campoQtd">
                                <label class="form-label-modern">Qtd</label>
                                <input type="number" id="prodQtd" class="form-control form-control-modern" min="0">
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary-modern w-100">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                    <div class="table-responsive">
                        <table class="table table-modern mb-0">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Nome</th>
                                    <th>Custo</th>
                                    <th>Venda</th>
                                    <th class="text-center">Estoque</th>
                                    <th class="text-end">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="corpoTabelaEstoque"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal PIX -->
    <div class="modal fade" id="modalPix" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fa-solid fa-qrcode me-2"></i>Pagamento via PIX</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-4">
                    <div id="pixDetails" class="mb-3 small text-muted"></div>
                    <div class="d-flex justify-content-center mb-3">
                        <div id="qrcode" class="p-3 bg-white border rounded-3"></div>
                    </div>
                    <div class="input-group mb-3">
                        <input type="text" id="pixCopiaCola" class="form-control form-control-modern" readonly>
                        <button class="btn btn-outline-primary" onclick="copiarPix()">Copiar</button>
                    </div>
                    <button id="btnEnviarPixWhats" class="btn btn-success w-100 fw-bold">
                        <i class="fa-brands fa-whatsapp me-2"></i>ENVIAR PARA CLIENTE
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ================================================================
        // MIGRAÇÃO NECESSÁRIA NO SUPABASE (execute uma vez no SQL Editor):
        // ================================================================
        // -- Adiciona operador_id na tabela configuracoes (se ainda não existir)
        // ALTER TABLE configuracoes ADD COLUMN IF NOT EXISTS operador_id TEXT;
        //
        // -- Todas as outras tabelas já têm operador_id:
        // -- ordens_servico.operador_id  ✅
        // -- produtos.operador_id        ✅
        // -- servicos_catalogo.operador_id ✅
        // ================================================================

        // CONFIGURAÇÃO SUPABASE - MIGRADO DO sistemadeservicos.html
        const SUPABASE_URL = 'https://oxqbhmblreprbeaflfld.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94cWJobWJscmVwcmJlYWZsZmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5OTUyNDUsImV4cCI6MjA4NjU3MTI0NX0.jZSFtEdXt1h9knqTZLSmKD72hx8x9oRir1Cs8hL65xI';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function verificarSessao() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            const overlay = document.getElementById('loginOverlay');

            if (session) {
                // Garante que operador_id está sempre disponível mesmo após reabrir o browser
                if (!localStorage.getItem('operador_id')) {
                    const email = session.user.email;
                    const { data: op } = await supabaseClient
                        .from('operadores')
                        .select('id, nome, status')
                        .eq('email', email)
                        .maybeSingle();

                    if (op && op.status !== 'bloqueado') {
                        localStorage.setItem('operador_id', op.id);
                        localStorage.setItem('operador_nome', op.nome);
                    } else if (op && op.status === 'bloqueado') {
                        // Operador bloqueado pelo admin - forçar logout
                        await supabaseClient.auth.signOut();
                        localStorage.removeItem('operador_id');
                        localStorage.removeItem('operador_nome');
                        overlay.style.display = 'flex';
                        overlay.classList.add('d-flex');
                        alert('Sua conta foi bloqueada. Contate o administrador.');
                        return;
                    }
                }

                overlay.style.display = 'none';
                overlay.classList.remove('d-flex');
                carregarOS();
                carregarProdutos();
                popularSelectServicos();
            } else {
                overlay.style.display = 'flex';
                overlay.classList.add('d-flex');
            }
        }

        // Executa a verificação assim que a página carrega
        window.onload = verificarSessao;

        let todasOS = [];
        let pecasSelecionadas = [];

        // Máscaras
        IMask(document.getElementById('whatsapp'), { mask: '(00) 00000-0000' });
        IMask(document.getElementById('veiculo'), { mask: 'AAA-0*00', prepare: s => s.toUpperCase(), definitions: { '0': /[0-9A-Z]/, 'A': /[a-zA-Z]/ } });
        IMask(document.getElementById('editWhatsapp'), { mask: '(00) 00000-0000' });
        IMask(document.getElementById('editVeiculo'), { mask: 'AAA-0*00', prepare: s => s.toUpperCase(), definitions: { '0': /[0-9A-Z]/, 'A': /[a-zA-Z]/ } });

        // Autenticação gerenciada por verificarSessao()

        // Login
        // Localize essa parte no seu código e ajuste para ver o erro:
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const senha = document.getElementById('loginSenha').value;
            const btn = e.target.querySelector('button');

            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Entrando...';

                // ETAPA 1: Validar email+senha direto na tabela operadores
                const { data: operador, error: dbError } = await supabaseClient
                    .from('operadores')
                    .select('id, nome, senha, status')
                    .eq('email', email)
                    .maybeSingle();

                if (dbError || !operador) {
                    document.getElementById('loginErro').textContent = "Erro: Usuário não encontrado.";
                    document.getElementById('loginErro').style.display = 'block';
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-right-to-bracket me-2"></i>ENTRAR NO SISTEMA';
                } else if (operador.status === 'bloqueado') {
                    document.getElementById('loginErro').textContent = "Erro: Conta bloqueada. Contate o administrador.";
                    document.getElementById('loginErro').style.display = 'block';
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-right-to-bracket me-2"></i>ENTRAR NO SISTEMA';
                } else if (operador.senha !== senha) {
                    document.getElementById('loginErro').textContent = "Erro: Senha incorreta.";
                    document.getElementById('loginErro').style.display = 'block';
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-right-to-bracket me-2"></i>ENTRAR NO SISTEMA';
                } else {
                    // ETAPA 2: Login no Supabase Auth para obter JWT (necessário para o RLS das tabelas)
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email,
                        password: senha
                    });

                    if (error) {
                        // Senha na tabela OK, mas Auth desatualizado (admin pode ter mudado a senha)
                        document.getElementById('loginErro').textContent = "Acesso bloqueado: solicite ao administrador que reenvie sua senha de acesso.";
                        document.getElementById('loginErro').style.display = 'block';
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fa-solid fa-right-to-bracket me-2"></i>ENTRAR NO SISTEMA';
                    } else {
                        localStorage.setItem('operador_id', operador.id);
                        localStorage.setItem('operador_nome', operador.nome);
                        await verificarSessao();
                        showNotify("Login realizado com sucesso!");
                        setTimeout(() => { abrirSelecaoAtendente(); }, 500);
                    }
                }
            } catch (err) {
                console.error("Erro inesperado:", err);
                btn.disabled = false;
                btn.innerHTML = 'ENTRAR NO SISTEMA';
            }
        });

        // ================================================
        // ALTERNAR ENTRE LOGIN E CADASTRO
        // ================================================
        function alternarParaCadastro() {
            document.getElementById('painelLogin').style.display = 'none';
            document.getElementById('painelCadastro').style.display = 'block';
            document.getElementById('loginSubtitle').textContent = 'Criar nova conta';
            document.getElementById('cadNome').focus();
        }

        function alternarParaLogin() {
            document.getElementById('painelCadastro').style.display = 'none';
            document.getElementById('painelLogin').style.display = 'block';
            document.getElementById('loginSubtitle').textContent = 'Sistema de Gestão de Serviços';
            document.getElementById('cadErro').style.display = 'none';
            document.getElementById('cadSucesso').style.display = 'none';
        }

        // ================================================
        // CADASTRO DE NOVO USUÁRIO
        // ================================================
        document.getElementById('cadastroForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const nome = document.getElementById('cadNome').value.trim();
            const email = document.getElementById('cadEmail').value.trim();
            const senha = document.getElementById('cadSenha').value;
            const conf = document.getElementById('cadSenhaConf').value;
            const btn = document.getElementById('btnCadastrar');
            const erroEl = document.getElementById('cadErro');
            const sucessoEl = document.getElementById('cadSucesso');

            erroEl.style.display = 'none';
            sucessoEl.style.display = 'none';

            // Validações locais
            if (senha !== conf) {
                erroEl.textContent = 'As senhas não coincidem.';
                erroEl.style.display = 'block';
                return;
            }
            if (senha.length < 6) {
                erroEl.textContent = 'A senha deve ter no mínimo 6 caracteres.';
                erroEl.style.display = 'block';
                return;
            }

            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Criando conta...';

                // 1. Criar usuário no Supabase Auth
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email,
                    password: senha,
                    options: { data: { nome } }
                });

                if (authError) {
                    erroEl.textContent = 'Erro: ' + authError.message;
                    erroEl.style.display = 'block';
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-user-plus me-2"></i>CRIAR CONTA';
                    return;
                }

                // 2. Inserir na tabela operadores para vincular ao sistema
                const novoUserId = authData?.user?.id;
                const { data: novoOp, error: dbError } = await supabaseClient
                    .from('operadores')
                    .insert([{
                        nome: nome,
                        email: email,
                        usuario: email.split('@')[0],
                        senha: senha,
                        nivel_acesso: 'operador',
                        status: 'ativo'
                    }])
                    .select('id, nome')
                    .maybeSingle();

                if (dbError) {
                    console.warn('Aviso ao inserir em operadores:', dbError.message);
                }

                // Salva operador_id imediatamente (usa id da tabela ou UUID do auth como fallback)
                const opIdNovo = novoOp?.id || novoUserId;
                if (opIdNovo) {
                    localStorage.setItem('operador_id', opIdNovo);
                    localStorage.setItem('operador_nome', nome);
                }

                // 3. Feedback de sucesso
                const precisaConfirmar = authData?.user && !authData.session;
                if (precisaConfirmar) {
                    sucessoEl.innerHTML = '<i class="fa-solid fa-envelope me-2"></i>Conta criada! Verifique seu e-mail para confirmar o cadastro.';
                    sucessoEl.style.display = 'block';
                    btn.innerHTML = '<i class="fa-solid fa-check me-2"></i>CONTA CRIADA';
                    setTimeout(() => {
                        alternarParaLogin();
                        document.getElementById('loginEmail').value = email;
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fa-solid fa-user-plus me-2"></i>CRIAR CONTA';
                    }, 3000);
                } else {
                    // Sessão já ativa (confirmação de email desabilitada no Supabase)
                    sucessoEl.innerHTML = '<i class="fa-solid fa-check-circle me-2"></i>Conta criada com sucesso! Entrando...';
                    sucessoEl.style.display = 'block';
                    setTimeout(async () => {
                        await verificarSessao();
                        showNotify('Bem-vindo, ' + nome + '!');
                    }, 1200);
                }

            } catch (err) {
                console.error('Erro inesperado no cadastro:', err);
                erroEl.textContent = 'Erro inesperado. Tente novamente.';
                erroEl.style.display = 'block';
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-user-plus me-2"></i>CRIAR CONTA';
            }
        });

        // Logout
        async function logout() {
            if (confirm("Deseja realmente sair do sistema?")) {
                await supabaseClient.auth.signOut();
                location.reload();
            }
        }

        // Toast Notification
        function showNotify(mensagem, tipo = 'success') {
            const toast = document.getElementById('customToast');
            const msg = document.getElementById('toastMessage');
            const icon = document.getElementById('toastIcon');

            msg.textContent = mensagem;

            if (tipo === 'success') {
                icon.className = 'fa-solid fa-circle-check me-2 fs-5';
                toast.classList.remove('bg-danger');
                toast.classList.add('bg-success');
            } else {
                icon.className = 'fa-solid fa-circle-xmark me-2 fs-5';
                toast.classList.remove('bg-success');
                toast.classList.add('bg-danger');
            }

            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // Toggle Dashboard
        function toggleDashboard() {
            const dash = document.getElementById('dashboard');
            if (dash.style.display === 'none') {
                dash.style.display = 'block';
                renderizarGraficoVendas();
                atualizarDashboard();
            } else {
                dash.style.display = 'none';
            }
        }

        // Atualizar Dashboard
        function atualizarDashboard() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;

            let dadosFiltrados = todasOS;

            if (dataInicio && dataFim) {
                dadosFiltrados = todasOS.filter(os => {
                    const dataCriacao = new Date(os.created_at).toISOString().split('T')[0];
                    return dataCriacao >= dataInicio && dataCriacao <= dataFim;
                });
            }

            const pago = dadosFiltrados.filter(os => os.status === 'Pago').reduce((acc, os) => acc + (os.valor || 0), 0);
            const pendente = dadosFiltrados.filter(os => os.status === 'Pendente').reduce((acc, os) => acc + (os.valor || 0), 0);
            const andamento = dadosFiltrados.filter(os => os.status === 'Em Andamento').reduce((acc, os) => acc + (os.valor || 0), 0);
            const total = pago + pendente + andamento;

            document.getElementById('dashPago').innerText = pago.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            document.getElementById('dashPendente').innerText = pendente.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            document.getElementById('dashAndamento').innerText = andamento.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            document.getElementById('dashTotal').innerText = total.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            renderizarRelatorioLucroServico();
        }

        // Exportar Excel
        function exportarExcel() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;

            let dadosParaExportar = todasOS;
            if (dataInicio && dataFim) {
                dadosParaExportar = todasOS.filter(os => {
                    const data = new Date(os.created_at).toISOString().split('T')[0];
                    return data >= dataInicio && data <= dataFim;
                });
            }

            const ws = XLSX.utils.json_to_sheet(dadosParaExportar.map(os => ({
                Data: new Date(os.created_at).toLocaleDateString(),
                Cliente: os.nome,
                WhatsApp: os.whatsapp,
                Veículo: os.veiculo,
                Serviço: os.servico,
                Valor: os.valor,
                Status: os.status,
                Observações: os.observacoes
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Relatório Financeiro");
            XLSX.writeFile(wb, `Relatorio_HaydenWheels_${new Date().toLocaleDateString()}.xlsx`);
        }

        // Carregar O.S.
        async function carregarOS() {
            const operadorId = localStorage.getItem('operador_id'); // Pega seu ID salvo no login

            const { data, error } = await supabaseClient
                .from('ordens_servico')
                .select('*')
                .eq('operador_id', operadorId) // FILTRO ESSENCIAL
                .order('created_at', { ascending: false });

            if (error) {
                console.error(error);
                return;
            }

            todasOS = data || [];
            renderizarTabela(todasOS);
            atualizarDashboard();
        }

        // Renderizar tabela
        function renderizarTabela(dados) {
            const tbody = document.getElementById('tabelaOS');
            const emptyState = document.getElementById('emptyState');

            if (!dados || dados.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            tbody.innerHTML = dados.map(os => {
                const statusClass =
                    os.status === 'Pendente' ? 'badge-pendente' :
                        os.status === 'Em Andamento' ? 'badge-andamento' :
                            os.status === 'Pago' ? 'badge-pago' :
                                'badge-cancelado';

                const fotoHtml = os.foto_url
                    ? `<img src="${os.foto_url}" class="img-thumbnail-modern" onclick="window.open('${os.foto_url}')">`
                    : `<div class="d-flex align-items-center justify-content-center bg-light" style="width:70px;height:70px;border-radius:0.75rem;"><i class="fa-solid fa-image text-muted"></i></div>`;

                return `
                    <tr class="fade-in">
                        <td>${fotoHtml}</td>
                        <td>
                            <div class="fw-semibold">${os.nome}</div>
                            <div class="text-muted small">${os.whatsapp}</div>
                        </td>
                        <td>
                            <span class="badge badge-modern" style="background: var(--primary); color: white;">${os.veiculo}</span>
                        </td>
                        <td>
                            <div class="text-truncate" style="max-width: 200px;" title="${os.servico || os.observacoes}">${os.servico || os.observacoes || '-'}</div>
                        </td>
                        <td>
                            <span class="badge badge-modern ${statusClass}" onclick="proximoStatus('${os.id}', '${os.status}')" title="Clique para mudar status">${os.status}</span>
                        </td>
                        <td class="fw-bold">R$ ${parseFloat(os.valor).toFixed(2)}</td>
                        <td>
                            <div class="d-flex justify-content-center gap-2 flex-wrap">
                                <button class="btn-action-modern btn-action-pix" onclick='abrirPix(${JSON.stringify(os).replace(/'/g, "&apos;")})' title="Pagar com PIX"><i class="fa-solid fa-qrcode"></i></button>
                                <button class="btn-action-modern btn-action-whatsapp" onclick='enviarWhats(${JSON.stringify(os).replace(/'/g, "&apos;")})' title="WhatsApp"><i class="fa-brands fa-whatsapp"></i></button>
                                <button class="btn-action-modern btn-action-orcamento" onclick="gerarOrcamento('${os.id}')" title="Gerar Orçamento"><i class="fa-solid fa-file-invoice-dollar"></i></button>
                                <button class="btn-action-modern btn-os-cliente" onclick="imprimirOSCliente('${os.id}')" title="O.S. Cliente"><i class="fa-solid fa-file-pdf"></i></button>
                                <button class="btn-action-modern btn-os-interno" onclick="imprimirOSInterno('${os.id}')" title="O.S. Interno"><i class="fa-solid fa-file-invoice"></i></button>
                                <button class="btn-action-modern btn-action-edit" onclick="editarOS('${os.id}')" title="Editar"><i class="fa-solid fa-edit"></i></button>
                                <button class="btn-action-modern btn-action-delete" onclick="deletarOS('${os.id}')" title="Deletar"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Próximo Status (clicar no badge)
        async function proximoStatus(id, statusAtual) {
            const ordem = ['Pendente', 'Em Andamento', 'Pago', 'Cancelado'];
            let novoStatus = ordem[(ordem.indexOf(statusAtual) + 1) % ordem.length];

            const { error } = await supabaseClient.from('ordens_servico').update({ status: novoStatus }).eq('id', id);

            if (!error) {
                carregarOS();
                showNotify(`Status alterado para: ${novoStatus}`);
            }
        }

        // Busca
        document.getElementById('searchInput')?.addEventListener('input', (e) => {
            const termo = e.target.value.toLowerCase();
            const filtrados = todasOS.filter(os =>
                os.nome.toLowerCase().includes(termo) ||
                os.veiculo.toLowerCase().includes(termo) ||
                (os.whatsapp && os.whatsapp.toLowerCase().includes(termo))
            );
            renderizarTabela(filtrados);
        });

        // Comprimir imagem
        async function comprimirImagem(arquivo) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(arquivo);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                        ctx.canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', 0.7);
                    };
                };
            });
        }

        // Cadastrar O.S.
        // Cadastrar O.S.
        document.getElementById('formCadastro')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btnSalvar = document.getElementById('btnSalvar');

            btnSalvar.innerHTML = '<span class="spinner-grow spinner-grow-sm me-2"></span>ENVIANDO...';
            btnSalvar.style.letterSpacing = '2px';

            try {
                let fotoUrl = null;
                const fotoInput = document.getElementById('fotoInput');
                const fotoFile = fotoInput ? fotoInput.files[0] : null;

                if (fotoFile) {
                    const fotoComprimida = await comprimirImagem(fotoFile);
                    const fileName = `${Date.now()}_os.jpg`;

                    const { data: uploadData, error: uploadError } = await supabaseClient.storage
                        .from('fotos_os')
                        .upload(fileName, fotoComprimida);

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabaseClient.storage.from('fotos_os').getPublicUrl(fileName);
                    fotoUrl = urlData.publicUrl;
                }

                // Coleta apenas os nomes dos badges (serviços catálogo + produtos estoque)
                // Procura essa linha dentro do evento de salvar (por volta da linha 1045)
                const servicosSelecionados = Array.from(document.querySelectorAll('#listaPecas .badge-modern'))
                    .map(badge => badge.dataset.nome)
                    .filter(s => s);

                // servico = itens selecionados pelos selects (badges) — usado no PDF como tabela de itens
                // observacoes = texto livre do campo textarea — usado como nota extra no PDF
                const dados = {
                    nome: document.getElementById('nome').value,
                    whatsapp: document.getElementById('whatsapp').value,
                    veiculo: document.getElementById('veiculo').value.toUpperCase(),
                    servico: servicosSelecionados.length > 0 ? servicosSelecionados.join(', ') : (document.getElementById('observacoes').value.trim() || 'Servico Geral'),
                    valor: parseFloat(document.getElementById('valor').value) || 0,
                    status: document.getElementById('status').value,
                    observacoes: document.getElementById('observacoes').value,
                    foto_url: fotoUrl,
                    atendente: atendenteLogado || 'SISTEMA',
                    operador_id: localStorage.getItem('operador_id')
                };

                // 1. Envia a O.S. para o banco
                const { error } = await supabaseClient.from('ordens_servico').insert([dados]);
                if (error) throw error;

                // ==========================================================
                // O CÓDIGO ENTRA EXATAMENTE AQUI:
                // Se a O.S. salvou com sucesso, agora baixamos o estoque real
                // ==========================================================
                if (pecasSelecionadas.length > 0) {
                    await processarBaixaEstoque(pecasSelecionadas);
                }

                // Limpa o array global de peças para a próxima O.S.
                pecasSelecionadas = [];
                // ==========================================================

                showNotify('Ordem de Serviço salva com sucesso!');
                document.getElementById('formCadastro').reset();
                document.getElementById('listaPecas').innerHTML = '';
                bootstrap.Modal.getInstance(document.getElementById('modalCadastro')).hide();
                await carregarOS();

            } catch (err) {
                console.error("Erro no salvamento:", err);
                showNotify('Erro na operação: ' + err.message, 'error');
            } finally {
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = '<i class="fa-solid fa-save me-2"></i>Salvar O.S.';
            }
        });

        // Editar O.S.
        async function editarOS(id) {
            const { data } = await supabaseClient.from('ordens_servico').select('*').eq('id', id).single();

            if (data) {
                document.getElementById('editId').value = data.id;
                document.getElementById('editNome').value = data.nome;
                document.getElementById('editWhatsapp').value = data.whatsapp;
                document.getElementById('editVeiculo').value = data.veiculo;
                document.getElementById('editObservacoes').value = data.observacoes || data.servico;
                document.getElementById('editStatus').value = data.status;
                document.getElementById('editValor').value = data.valor;

                // Limpa a lista de badges antes de abrir para não acumular
                document.getElementById('listaPecasEdit').innerHTML = '';

                // Recarrega os produtos no select de edição
                carregarProdutosNoSelect('selectProdutoEdit');

                new bootstrap.Modal(document.getElementById('modalEdicao')).show();
            }
        }

        // Salvar edição
        document.getElementById('formEdicao')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('editId').value;
            const dadosAtualizados = {
                nome: document.getElementById('editNome').value,
                whatsapp: document.getElementById('editWhatsapp').value,
                veiculo: document.getElementById('editVeiculo').value.toUpperCase(),
                servico: document.getElementById('editObservacoes').value,
                observacoes: document.getElementById('editObservacoes').value,
                status: document.getElementById('editStatus').value,
                valor: parseFloat(document.getElementById('editValor').value)
            };

            const { error } = await supabaseClient.from('ordens_servico').update(dadosAtualizados).eq('id', id);

            if (error) {
                showNotify('Erro ao atualizar O.S.', 'error');
            } else {
                showNotify('O.S. atualizada com sucesso!');
                bootstrap.Modal.getInstance(document.getElementById('modalEdicao')).hide();
                carregarOS();
            }
        });

        // Deletar O.S.
        async function deletarOS(id) {
            if (confirm('Deseja realmente excluir esta O.S.?')) {
                const { error } = await supabaseClient.from('ordens_servico').delete().eq('id', id);

                if (error) {
                    showNotify('Erro ao excluir O.S.', 'error');
                } else {
                    showNotify('O.S. excluída com sucesso!');
                    carregarOS();
                }
            }
        }

        // WhatsApp
        function enviarWhats(os) {
            const msg = `Olá ${os.nome}, sua Ordem de Serviço na MELÃO RODAS foi registrada!\n\n🚗 Veículo: ${os.veiculo}\n🛠️ Serviço: ${os.servico}\n💰 Valor: R$ ${os.valor.toFixed(2)}\n\nObrigado pela preferência!`;
            const fone = os.whatsapp.replace(/\D/g, '');
            window.open(`https://api.whatsapp.com/send?phone=55${fone}&text=${encodeURIComponent(msg)}`);
        }

        // PIX
        function abrirPix(os) {
            document.getElementById('pixDetails').innerHTML = `<strong>${os.nome}</strong> - R$ ${os.valor.toFixed(2)}`;

            const pixKey = "sua-chave-pix@exemplo.com"; // ALTERE PARA SUA CHAVE PIX
            const pixCode = `00020126580014br.gov.bcb.pix0136${pixKey}52040000530398654${os.valor.toFixed(2)}5802BR5925MELAORODAS6009SAO PAULO62070503***6304`;

            document.getElementById('pixCopiaCola').value = pixCode;

            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), {
                text: pixCode,
                width: 200,
                height: 200
            });

            document.getElementById('btnEnviarPixWhats').onclick = () => {
                const msg = `💳 *PIX PARA PAGAMENTO*\n\nOlá ${os.nome}!\n\nValor: R$ ${os.valor.toFixed(2)}\n\nChave PIX:\n${pixKey}\n\nCódigo Copia e Cola:\n${pixCode}`;
                const fone = os.whatsapp.replace(/\D/g, '');
                window.open(`https://api.whatsapp.com/send?phone=55${fone}&text=${encodeURIComponent(msg)}`);
            };

            new bootstrap.Modal(document.getElementById('modalPix')).show();
        }

        function copiarPix() {
            const pixInput = document.getElementById('pixCopiaCola');
            pixInput.select();
            document.execCommand('copy');
            showNotify('Código PIX copiado!');
        }

        // Imprimir O.S. Cliente (Melhorado e Profissional)
        async function imprimirOSCliente(id) {
            showNotify('Preparando documento com os dados da empresa...', 'success');
            const { data: os } = await supabaseClient.from('ordens_servico').select('*').eq('id', id).single();
            if (!os) return;

            // Carregar configurações da empresa
            // Dentro de imprimirOSCliente ou gerarOrcamento
            const empresa = await obterDadosEmpresa();

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Cabeçalho (Exemplo O.S. Cliente)
            doc.setFillColor(30, 58, 138);
            doc.rect(0, 0, 210, 45, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.text(empresa.nome.toUpperCase(), 105, 20, { align: 'center' }); // DADO DINÂMICO
            doc.setFontSize(10);
            doc.text(`CNPJ: ${empresa.cnpj} | Tel: ${empresa.tel}`, 105, 35, { align: 'center' }); // DADO DINÂMICO
            doc.text(empresa.end, 105, 40, { align: 'center' }); // DADO DINÂMICO
            // Título do Documento
            doc.setTextColor(0, 0, 0);
            doc.setFillColor(243, 244, 246);
            doc.rect(15, 52, 180, 12, 'F');
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('ORDEM DE SERVIÇO', 105, 60, { align: 'center' });

            // Número da OS
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text(`OS Nº: ${os.id.substring(0, 8).toUpperCase()}`, 15, 72);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text(`Data de Emissão: ${new Date(os.created_at).toLocaleDateString('pt-BR')}`, 140, 72);

            // Localize onde você adicionou o texto do atendente e use estas coordenadas:
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`ATENDENTE: ${os.atendente || atendenteLogado || 'SISTEMA'}`, 15, 272); // CORREÇÃO: Usa atendente salvo na OS

            // Dados do Cliente
            let yPos = 82;
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos - 5, 180, 37, 'F');

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('DADOS DO CLIENTE', 20, yPos);
            yPos += 8;

            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text('Nome:', 20, yPos);
            doc.text(os.nome, 50, yPos);
            yPos += 7;

            doc.text('Contato:', 20, yPos);
            doc.text(os.whatsapp, 50, yPos);
            yPos += 7;

            doc.text('Veículo:', 20, yPos);
            doc.text(os.veiculo, 50, yPos);
            yPos += 7;

            doc.text('Atendente Responsável:', 20, yPos);
            doc.text(os.atendente || atendenteLogado || 'Sistema', 75, yPos);

            // Serviços Realizados
            yPos += 15;
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos - 5, 180, 10, 'F');
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('SERVIÇOS REALIZADOS', 20, yPos);
            yPos += 8;

            // Tabela de Serviços
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);

            // Dividir serviços por vírgula ou ponto e vírgula
            const servicos = (os.servico || 'Serviço Geral').split(/,/).map(s => s.trim()).filter(s => s);

            // Cabeçalho da tabela
            doc.setFillColor(230, 230, 230);
            doc.rect(15, yPos - 3, 180, 8, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('Descrição do Serviço/Produto', 18, yPos + 2);
            doc.text('Valor Unit.', 155, yPos + 2);
            yPos += 10;

            // Linhas de serviços
            doc.setFont(undefined, 'normal');
            let subtotal = 0;

            if (servicos.length > 1) {
                // Se tem múltiplos serviços, divide o valor
                const valorPorItem = parseFloat(os.valor) / servicos.length;
                servicos.forEach((servico, idx) => {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 30;
                    }

                    const servicoWrapped = doc.splitTextToSize(servico, 130);
                    doc.text(servicoWrapped, 18, yPos);
                    doc.text(`R$ ${valorPorItem.toFixed(2)}`, 155, yPos);
                    yPos += (servicoWrapped.length * 5) + 3;
                    subtotal += valorPorItem;

                    // Linha divisória
                    doc.setDrawColor(220, 220, 220);
                    doc.line(15, yPos, 195, yPos);
                    yPos += 3;
                });
            } else {
                // Serviço único
                const servicoWrapped = doc.splitTextToSize(servicos[0], 130);
                doc.text(servicoWrapped, 18, yPos);
                doc.text(`R$ ${parseFloat(os.valor).toFixed(2)}`, 155, yPos);
                yPos += (servicoWrapped.length * 5) + 3;
                subtotal = parseFloat(os.valor);
            }

            // Total
            yPos += 5;
            doc.setFillColor(59, 130, 246);
            doc.rect(15, yPos - 5, 180, 15, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(`VALOR TOTAL: R$ ${parseFloat(os.valor).toFixed(2)}`, 105, yPos + 5, { align: 'center' });
            doc.setTextColor(0, 0, 0);

            // Status do Pagamento
            yPos += 20;
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text(`Status: ${os.status}`, 20, yPos);

            // Observações adicionais (campo livre, não entra na tabela de itens)
            if (os.observacoes && os.observacoes.trim()) {
                yPos += 8;
                doc.setFontSize(8);
                doc.setFont(undefined, 'bold');
                doc.text('OBSERVAÇÕES:', 20, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 5;
                const obsLines = doc.splitTextToSize(os.observacoes.trim(), 170);
                doc.text(obsLines, 20, yPos);
                yPos += obsLines.length * 4;
            }

            // Informações Legais e Políticas da Loja
            yPos += 15;
            doc.setFillColor(250, 250, 250);
            doc.rect(15, yPos - 5, 180, 50, 'F');

            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            doc.text('TERMOS E CONDIÇÕES - CÓDIGO DE DEFESA DO CONSUMIDOR', 20, yPos);
            yPos += 5;

            doc.setFont(undefined, 'normal');
            doc.setFontSize(7);

            const termos = [
                '• Art. 26 CDC: O direito de reclamar por vícios aparentes ou de fácil constatação caduca em 30 dias para serviços.',
                '• Art. 18 CDC: Os serviços possuem garantia legal de 90 dias. Vícios ocultos devem ser reportados dentro deste prazo.',
                '• Garantia válida apenas para defeitos de execução. Não cobre mau uso, desgaste natural ou danos externos.',
                '• Peças substituídas têm garantia do fabricante. Consulte-nos para mais detalhes.',
                '• Prazo de validade deste orçamento: 15 dias corridos a partir da data de emissão.',
                '• O veículo permanecerá sob nossa responsabilidade durante a execução do serviço contratado.',
                '• Em caso de dúvidas ou reclamações, entre em contato conosco antes de acionar órgãos de defesa do consumidor.'
            ];

            termos.forEach(termo => {
                const termoLines = doc.splitTextToSize(termo, 170);
                doc.text(termoLines, 20, yPos);
                yPos += termoLines.length * 3.5;
            });

            // Posicionamento no rodapé, acima da linha de assinatura
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.setFont(undefined, 'bold');
            doc.text(`ATENDENTE RESPONSÁVEL: ${os.atendente || atendenteLogado || 'SISTEMA'}`, 15, 265);

            // Assinatura
            yPos += 8;
            doc.setDrawColor(100, 100, 100);
            doc.line(20, yPos, 90, yPos);
            doc.line(120, yPos, 190, yPos);
            yPos += 5;
            doc.setFontSize(8);
            doc.text('Assinatura do Cliente', 20, yPos);
            doc.text('Assinatura do Responsável', 120, yPos);

            // Rodapé
            doc.setFontSize(7);
            doc.setTextColor(120, 120, 120);
            doc.text('Este documento é uma via do cliente. Guarde-o para garantia e referência futura.', 105, 285, { align: 'center' });

            doc.save(`OS_Cliente_${os.id.substring(0, 8)}.pdf`);
            showNotify('Ordem de Serviço gerada com sucesso!', 'success');
        }

        // Imprimir O.S. Interno
        async function imprimirOSInterno(id) {
            showNotify('Preparando documento com os dados da empresa...', 'success');
            const { data: os } = await supabaseClient.from('ordens_servico').select('*').eq('id', id).single();
            if (!os) return;

            // Carregar configurações da empresa
            const dadosEmpresaInterna = await obterDadosEmpresa();
            const nomeEmpresa = dadosEmpresaInterna.nome;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Cabeçalho Interno (cor diferente)
            doc.setFillColor(139, 92, 246);
            doc.rect(0, 0, 210, 45, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(26);
            doc.setFont(undefined, 'bold');
            doc.text(nomeEmpresa.toUpperCase(), 105, 20, { align: 'center' });

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('ORDEM DE SERVIÇO - USO INTERNO', 105, 28, { align: 'center' });
            doc.text('DOCUMENTO CONFIDENCIAL', 105, 35, { align: 'center' });

            // Título do Documento
            doc.setTextColor(0, 0, 0);
            doc.setFillColor(243, 244, 246);
            doc.rect(15, 52, 180, 12, 'F');
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('CONTROLE INTERNO', 105, 60, { align: 'center' });

            // Número da OS
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text(`OS ID: ${os.id}`, 15, 72);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text(`Data: ${new Date(os.created_at).toLocaleDateString('pt-BR')}`, 140, 72);

            // Dados do Cliente
            let yPos = 82;
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos - 5, 180, 37, 'F');

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('DADOS DO CLIENTE', 20, yPos);
            yPos += 8;

            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text('Nome:', 20, yPos);
            doc.text(os.nome, 50, yPos);
            yPos += 7;

            doc.text('Contato:', 20, yPos);
            doc.text(os.whatsapp, 50, yPos);
            yPos += 7;

            doc.text('Veículo:', 20, yPos);
            doc.text(os.veiculo, 50, yPos);
            yPos += 7;

            doc.text('Atendente Responsável:', 20, yPos);
            doc.text(os.atendente || atendenteLogado || 'Sistema', 75, yPos);

            // Serviços Realizados
            yPos += 15;
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos - 5, 180, 10, 'F');
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('SERVIÇOS REALIZADOS', 20, yPos);
            yPos += 8;

            // Tabela de Serviços
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);

            const servicos = (os.servico || 'Serviço Geral').split(/,/).map(s => s.trim()).filter(s => s);

            // Cabeçalho da tabela
            doc.setFillColor(230, 230, 230);
            doc.rect(15, yPos - 3, 180, 8, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('Descrição do Serviço/Produto', 18, yPos + 2);
            doc.text('Valor Unit.', 155, yPos + 2);
            yPos += 10;

            // Linhas de serviços
            doc.setFont(undefined, 'normal');
            if (servicos.length > 1) {
                const valorPorItem = parseFloat(os.valor) / servicos.length;
                servicos.forEach((servico) => {
                    const servicoWrapped = doc.splitTextToSize(servico, 130);
                    doc.text(servicoWrapped, 18, yPos);
                    doc.text(`R$ ${valorPorItem.toFixed(2)}`, 155, yPos);
                    yPos += (servicoWrapped.length * 5) + 3;
                    doc.setDrawColor(220, 220, 220);
                    doc.line(15, yPos, 195, yPos);
                    yPos += 3;
                });
            } else {
                const servicoWrapped = doc.splitTextToSize(servicos[0], 130);
                doc.text(servicoWrapped, 18, yPos);
                doc.text(`R$ ${parseFloat(os.valor).toFixed(2)}`, 155, yPos);
                yPos += (servicoWrapped.length * 5) + 3;
            }


            // Observações do cliente (texto livre, separado da tabela de itens)
            if (os.observacoes && os.observacoes.trim()) {
                yPos += 5;
                doc.setFontSize(8);
                doc.setFont(undefined, 'bold');
                doc.text('OBSERVAÇÕES:', 20, yPos);
                yPos += 5;
                doc.setFont(undefined, 'normal');
                const obsLines = doc.splitTextToSize(os.observacoes.trim(), 170);
                doc.text(obsLines, 20, yPos);
                yPos += obsLines.length * 4;
            }

            // Status e Informações Internas
            yPos += 5;
            doc.setFillColor(250, 250, 250);
            doc.rect(15, yPos - 5, 180, 25, 'F');

            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('STATUS INTERNO', 20, yPos);
            yPos += 7;

            doc.setFont(undefined, 'normal');
            doc.text(`Status do Pagamento: ${os.status}`, 20, yPos);
            yPos += 6;
            doc.text(`Data de Cadastro: ${new Date(os.created_at).toLocaleString('pt-BR')}`, 20, yPos);

            // Total
            yPos += 15;
            doc.setFillColor(139, 92, 246);
            doc.rect(15, yPos - 5, 180, 15, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(`VALOR TOTAL: R$ ${parseFloat(os.valor).toFixed(2)}`, 105, yPos + 5, { align: 'center' });
            doc.setTextColor(0, 0, 0);

            // Rodapé
            doc.setFontSize(7);
            doc.setTextColor(120, 120, 120);
            doc.text('DOCUMENTO DE USO INTERNO - CONFIDENCIAL - NÃO ENTREGAR AO CLIENTE', 105, 285, { align: 'center' });

            doc.save(`OS_Interno_${os.id.substring(0, 8)}.pdf`);
            showNotify('O.S. interna gerada com sucesso!', 'success');
        }

        // Gerar Orçamento Profissional
        async function gerarOrcamento(id) {
            showNotify('Preparando documento com os dados da empresa...', 'success');
            const { data: os } = await supabaseClient.from('ordens_servico').select('*').eq('id', id).single();
            if (!os) return;

            // Carregar configurações da empresa (filtrado por operador)
            const dadosEmpOrc = await obterDadosEmpresa();
            const nomeEmpresa = dadosEmpOrc.nome;
            const cnpj = dadosEmpOrc.cnpj;
            const telefone = dadosEmpOrc.tel;
            const endereco = dadosEmpOrc.end;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Cabeçalho Verde (cor de dinheiro/orçamento)
            doc.setFillColor(16, 185, 129); // verde
            doc.rect(0, 0, 210, 45, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(26);
            doc.setFont(undefined, 'bold');
            doc.text(nomeEmpresa.toUpperCase(), 105, 20, { align: 'center' });

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Centro Automotivo Especializado', 105, 28, { align: 'center' });
            doc.text(`CNPJ: ${cnpj} | Tel: ${telefone}`, 105, 35, { align: 'center' });
            doc.text(endereco, 105, 40, { align: 'center' });

            // Título ORÇAMENTO
            doc.setTextColor(0, 0, 0);
            doc.setFillColor(243, 244, 246);
            doc.rect(15, 52, 180, 12, 'F');
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('ORÇAMENTO', 105, 60, { align: 'center' });

            // Número do Orçamento
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text(`Orçamento Nº: ${os.id.substring(0, 8).toUpperCase()}`, 15, 72);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 140, 72);
            doc.text(`Validade: 15 dias`, 140, 78);

            doc.setFontSize(9);
            doc.text(`CONSULTOR TÉCNICO: ${os.atendente || atendenteLogado || 'SISTEMA'}`, 15, 260);

            // Dados do Cliente
            let yPos = 88;
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos - 5, 180, 37, 'F');

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('DADOS DO CLIENTE', 20, yPos);
            yPos += 8;

            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text('Nome:', 20, yPos);
            doc.text(os.nome, 50, yPos);
            yPos += 7;

            doc.text('Contato:', 20, yPos);
            doc.text(os.whatsapp, 50, yPos);
            yPos += 7;

            doc.text('Veículo:', 20, yPos);
            doc.text(os.veiculo, 50, yPos);
            yPos += 7;

            doc.text('Atendente Responsável:', 20, yPos);
            doc.text(os.atendente || atendenteLogado || 'Sistema', 75, yPos);

            // Serviços Orçados
            yPos += 15;
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos - 5, 180, 10, 'F');
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('SERVIÇOS E PRODUTOS ORÇADOS', 20, yPos);
            yPos += 8;

            // Tabela de Serviços
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);

            const servicos = (os.servico || 'Serviço a definir').split(/,/).map(s => s.trim()).filter(s => s);

            // Cabeçalho da tabela
            doc.setFillColor(16, 185, 129);
            doc.rect(15, yPos - 3, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text('Descrição', 18, yPos + 2);
            doc.text('Valor Unit.', 155, yPos + 2);
            doc.setTextColor(0, 0, 0);
            yPos += 10;

            // Linhas de serviços
            doc.setFont(undefined, 'normal');
            let subtotal = 0;

            if (servicos.length > 1) {
                const valorPorItem = parseFloat(os.valor) / servicos.length;
                servicos.forEach((servico) => {
                    const servicoWrapped = doc.splitTextToSize(servico, 130);
                    doc.text(servicoWrapped, 18, yPos);
                    doc.text(`R$ ${valorPorItem.toFixed(2)}`, 155, yPos);
                    yPos += (servicoWrapped.length * 5) + 3;
                    subtotal += valorPorItem;
                    doc.setDrawColor(220, 220, 220);
                    doc.line(15, yPos, 195, yPos);
                    yPos += 3;
                });
            } else {
                const servicoWrapped = doc.splitTextToSize(servicos[0], 130);
                doc.text(servicoWrapped, 18, yPos);
                doc.text(`R$ ${parseFloat(os.valor).toFixed(2)}`, 155, yPos);
                yPos += (servicoWrapped.length * 5) + 3;
                subtotal = parseFloat(os.valor);
            }

            // Observações do cliente (texto livre) + notas padrão do orçamento
            yPos += 5;
            doc.setFillColor(255, 251, 235);
            const obsHeight = (os.observacoes && os.observacoes.trim()) ? 35 : 22;
            doc.rect(15, yPos - 5, 180, obsHeight, 'F');
            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            doc.text('OBSERVAÇÕES IMPORTANTES:', 20, yPos);
            yPos += 5;
            doc.setFont(undefined, 'normal');
            if (os.observacoes && os.observacoes.trim()) {
                const obsLines = doc.splitTextToSize('• ' + os.observacoes.trim(), 170);
                doc.text(obsLines, 20, yPos);
                yPos += obsLines.length * 4;
            }
            doc.text('• Este orçamento tem validade de 15 dias corridos a partir da data de emissão.', 20, yPos);
            yPos += 4;
            doc.text('• Os valores podem sofrer alterações conforme disponibilidade de peças e mão de obra.', 20, yPos);
            yPos += 4;
            doc.text('• Após aprovação, será gerado um documento formal de ordem de serviço.', 20, yPos);

            // Total com destaque
            yPos += 15;
            doc.setFillColor(16, 185, 129);
            doc.rect(15, yPos - 5, 180, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(`VALOR TOTAL ESTIMADO: R$ ${parseFloat(os.valor).toFixed(2)}`, 105, yPos + 6, { align: 'center' });
            doc.setTextColor(0, 0, 0);

            // Termos de aceitação
            yPos += 30;
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('ACEITE DO CLIENTE', 20, yPos);
            yPos += 8;

            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
            doc.text('Declaro estar ciente dos serviços orçados e seus respectivos valores.', 20, yPos);
            yPos += 10;

            // Linhas de assinatura
            doc.setDrawColor(100, 100, 100);
            doc.line(20, yPos, 90, yPos);
            doc.line(120, yPos, 190, yPos);
            yPos += 5;
            doc.setFontSize(8);
            doc.text('Assinatura do Cliente', 35, yPos);
            doc.text(`Data: ___/___/___`, 140, yPos);

            // Posicionamento para Orçamento (Logo abaixo dos termos)
            doc.setFontSize(8);
            doc.setTextColor(0, 0, 0);
            doc.text(`Consultor Técnico: ${os.atendente || atendenteLogado || 'Vendedor Padrão'}`, 15, 270);

            // Rodapé
            doc.setFontSize(7);
            doc.setTextColor(120, 120, 120);
            doc.text('Este é um orçamento sem compromisso. Entre em contato para mais informações.', 105, 285, { align: 'center' });

            doc.save(`Orcamento_${os.id.substring(0, 8)}.pdf`);

            showNotify('Orçamento gerado com sucesso!', 'success');
        }

        // Produtos
        // ============================================================
        // PRODUTOS & SERVIÇOS — LÓGICA UNIFICADA (tabela: produtos)
        // Serviços usam tipo='servico' e estoque=-1 (ilimitado)
        // ============================================================

        // Alterna campos do formulário conforme o tipo selecionado
        function alternarCamposTipo() {
            const tipo = document.getElementById('prodTipo').value;
            const campoCusto = document.getElementById('campoCusto');
            const campoQtd = document.getElementById('campoQtd');
            const prodCusto = document.getElementById('prodCusto');
            const prodQtd = document.getElementById('prodQtd');
            if (tipo === 'servico') {
                campoCusto.style.display = 'none';
                campoQtd.style.display = 'none';
                prodCusto.removeAttribute('required');
                prodQtd.removeAttribute('required');
            } else {
                campoCusto.style.display = '';
                campoQtd.style.display = '';
                prodCusto.setAttribute('required', '');
                prodQtd.setAttribute('required', '');
            }
        }

        // Carrega itens (produtos com estoque > 0 + serviços) nos selects da OS
        async function carregarProdutos() {
            const operadorId = localStorage.getItem('operador_id');
            let q = supabaseClient.from('produtos').select('*').order('nome');
            if (operadorId) q = q.eq('operador_id', operadorId);
            const { data } = await q;
            if (!data) return;

            const produtos = data.filter(d => d.tipo !== 'servico' && d.estoque > 0);
            const servicos = data.filter(d => d.tipo === 'servico');

            ['selectProduto', 'selectProdutoEdit'].forEach(selectId => {
                const sel = document.getElementById(selectId);
                if (!sel) return;
                sel.innerHTML = '<option value="">Selecione um item...</option>';

                if (servicos.length) {
                    const grpS = document.createElement('optgroup');
                    grpS.label = '🔧 Serviços';
                    servicos.forEach(s => {
                        const o = document.createElement('option');
                        o.value = s.id;
                        o.dataset.preco = s.preco_venda;
                        o.dataset.nome = s.nome;
                        o.dataset.tipo = 'servico';
                        o.textContent = `${s.nome} — R$ ${parseFloat(s.preco_venda).toFixed(2)}`;
                        grpS.appendChild(o);
                    });
                    sel.appendChild(grpS);
                }

                if (produtos.length) {
                    const grpP = document.createElement('optgroup');
                    grpP.label = '📦 Produtos';
                    produtos.forEach(p => {
                        const o = document.createElement('option');
                        o.value = p.id;
                        o.dataset.preco = p.preco_venda;
                        o.dataset.nome = p.nome;
                        o.dataset.tipo = 'produto';
                        o.textContent = `${p.nome} — R$ ${parseFloat(p.preco_venda).toFixed(2)}`;
                        grpP.appendChild(o);
                    });
                    sel.appendChild(grpP);
                }
            });
        }

        // Mantida para compatibilidade com chamadas existentes
        async function carregarProdutosNoSelect(idSelect) { await carregarProdutos(); }

        // Helper: cria badge e adiciona na lista visual
        function criarBadgeItem(nome, preco, tipo, listaId, campoValorId) {
            const lista = document.getElementById(listaId);
            if (!lista) return;
            const icone = tipo === 'servico' ? 'fa-wrench' : 'fa-box';
            const badge = document.createElement('span');
            badge.className = 'badge badge-modern bg-primary text-white position-relative pe-4 me-2 mb-2';
            badge.dataset.preco = preco;
            badge.dataset.nome = nome;
            badge.dataset.tipo = tipo;
            badge.innerHTML = `
                <i class="fa-solid ${icone} me-1"></i> ${nome} (+R$ ${parseFloat(preco).toFixed(2)})
                <button type="button" class="btn-close btn-close-white position-absolute top-50 end-0 translate-middle-y me-1"
                    style="font-size:0.6rem;cursor:pointer;" onclick="removerItemLista(this)"></button>
            `;
            lista.appendChild(badge);
            // Soma ao campo valor
            const campoValor = document.getElementById(campoValorId);
            if (campoValor) {
                campoValor.value = (parseFloat(campoValor.value) || 0) + parseFloat(preco);
                campoValor.value = parseFloat(campoValor.value).toFixed(2);
            }
        }

        // Select unificado — Modal Nova OS
        const selectProd = document.getElementById('selectProduto');
        if (selectProd) {
            selectProd.addEventListener('change', function () {
                if (!this.value) return;
                const opt = this.options[this.selectedIndex];
                const nome = opt.dataset.nome;
                const preco = parseFloat(opt.dataset.preco) || 0;
                const tipo = opt.dataset.tipo || 'produto';
                // Só entra no array de baixa de estoque se for produto
                if (tipo === 'produto') {
                    pecasSelecionadas.push({ id: this.value, nome, preco });
                }
                criarBadgeItem(nome, preco, tipo, 'listaPecas', 'valor');
                this.value = '';
            });
        }

        // Select unificado — Modal Edição OS
        document.getElementById('selectProdutoEdit')?.addEventListener('change', function () {
            if (!this.value) return;
            const opt = this.options[this.selectedIndex];
            const nome = opt.dataset.nome;
            const preco = parseFloat(opt.dataset.preco) || 0;
            const tipo = opt.dataset.tipo || 'produto';
            criarBadgeItem(nome, preco, tipo, 'listaPecasEdit', 'editValor');
            this.value = '';
        });

        // Submit do formulário unificado de estoque
        document.getElementById('estoqueForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const operadorId = localStorage.getItem('operador_id');
            const tipo = document.getElementById('prodTipo').value;

            const dadosProd = {
                nome: document.getElementById('prodNome').value.trim(),
                preco_custo: tipo === 'servico' ? 0 : parseFloat(document.getElementById('prodCusto').value) || 0,
                preco_venda: parseFloat(document.getElementById('prodVenda').value),
                estoque: tipo === 'servico' ? -1 : parseInt(document.getElementById('prodQtd').value) || 0,
                tipo: tipo,
                operador_id: operadorId
            };

            const { error } = await supabaseClient.from('produtos').insert([dadosProd]);
            if (error) {
                showNotify('Erro ao cadastrar: ' + error.message, 'error');
            } else {
                showNotify(tipo === 'servico' ? 'Serviço cadastrado!' : 'Produto adicionado!');
                document.getElementById('estoqueForm').reset();
                alternarCamposTipo();
                listarProdutosEstoque();
                carregarProdutos();
            }
        });

        document.getElementById('modalEstoque')?.addEventListener('shown.bs.modal', listarProdutosEstoque);

        async function listarProdutosEstoque() {
            const operadorId = localStorage.getItem('operador_id');
            let q = supabaseClient.from('produtos').select('*').order('tipo').order('nome');
            if (operadorId) q = q.eq('operador_id', operadorId);
            const { data, error } = await q;
            const tbody = document.getElementById('corpoTabelaEstoque');
            tbody.innerHTML = '';
            if (error) return showNotify('Erro ao carregar', 'error');

            data.forEach(item => {
                const isServico = item.tipo === 'servico';
                const estoqueCell = isServico
                    ? `<span class="badge badge-modern badge-andamento">Ilimitado</span>`
                    : `<span class="badge badge-modern ${item.estoque < 3 ? 'badge-pendente' : 'badge-concluido'}">${item.estoque}</span>`;
                const acoesEstoque = isServico ? '' : `
                    <button onclick="ajustarEstoque('${item.id}', 1)" class="btn btn-sm btn-outline-success me-1" title="Entrada (+1)">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                    <button onclick="ajustarEstoque('${item.id}', -1)" class="btn btn-sm btn-outline-warning me-1" title="Saída (-1)">
                        <i class="fa-solid fa-minus"></i>
                    </button>`;
                tbody.innerHTML += `
                    <tr>
                        <td><span class="badge ${isServico ? 'bg-info' : 'bg-secondary'} text-white">${isServico ? '🔧 Serviço' : '📦 Produto'}</span></td>
                        <td class="fw-semibold">${item.nome}</td>
                        <td class="text-muted">${isServico ? '—' : 'R$ ' + parseFloat(item.preco_custo).toFixed(2)}</td>
                        <td class="text-success fw-bold">R$ ${parseFloat(item.preco_venda).toFixed(2)}</td>
                        <td class="text-center">${estoqueCell}</td>
                        <td class="text-end">
                            ${acoesEstoque}
                            <button onclick="deletarProduto('${item.id}')" class="btn btn-sm btn-outline-danger" title="Deletar">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>`;
            });
        }

        async function ajustarEstoque(id, qtd) {
            const { data: prod } = await supabaseClient.from('produtos').select('estoque').eq('id', id).single();
            const novaQtd = (prod.estoque || 0) + qtd;
            if (novaQtd < 0) return showNotify('Estoque não pode ser negativo!', 'error');
            const { error } = await supabaseClient.from('produtos').update({ estoque: novaQtd }).eq('id', id);
            if (!error) { listarProdutosEstoque(); carregarProdutos(); }
        }

        async function deletarProduto(id) {
            if (confirm('Deseja remover este item permanentemente?')) {
                const { error } = await supabaseClient.from('produtos').delete().eq('id', id);
                if (!error) { showNotify('Item removido!'); listarProdutosEstoque(); carregarProdutos(); }
            }
        }

        // Stub vazio para não quebrar chamadas antigas
        async function popularSelectServicos() { await carregarProdutos(); }
        async function carregarCatalogoServicos() { }
        function prepararEdicaoServico() { }
        function cancelarEdicaoServico() { }
        window.adicionarServicoCatalogo = function () { };



        // Gráfico
        let meuGrafico = null;

        async function renderizarGraficoVendas() {
            const contagemServicos = {};

            todasOS.forEach(os => {
                const servico = os.servico || 'Serviço Geral';
                contagemServicos[servico] = (contagemServicos[servico] || 0) + 1;
            });

            const labels = Object.keys(contagemServicos).slice(0, 5);
            const valores = Object.values(contagemServicos).slice(0, 5);

            const ctx = document.getElementById('graficoVendas').getContext('2d');

            if (meuGrafico) meuGrafico.destroy();

            meuGrafico = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantidade Realizada',
                        data: valores,
                        backgroundColor: '#3b82f6',
                        borderRadius: 10,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false } }
                    }
                }
            });

        }

        async function processarBaixaEstoque(pecas) {
            const operadorIdBaixa = localStorage.getItem('operador_id');
            for (const peca of pecas) {
                const qBaixa = supabaseClient.from('produtos').select('id, estoque, nome').eq('nome', peca.nome);
                if (operadorIdBaixa) qBaixa.eq('operador_id', operadorIdBaixa);
                const { data: prod } = await qBaixa.maybeSingle();

                if (prod && prod.estoque > 0) {
                    const novaQtd = prod.estoque - 1;
                    await supabaseClient
                        .from('produtos')
                        .update({ estoque: novaQtd })
                        .eq('id', prod.id);

                    if (novaQtd <= 2) {
                        showNotify(`Alerta: Estoque crítico de ${prod.nome}!`, 'error');
                    }
                }
            }
        }

        // Localize a função atualizarDashboard e substitua por esta:
        // Procure a sua função atualizarDashboard e ajuste para ficar assim:
        async function atualizarDashboard() { // Adicione 'async' aqui se não tiver
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;

            let dadosFiltrados = todasOS;

            if (dataInicio && dataFim) {
                dadosFiltrados = todasOS.filter(os => {
                    const dataCriacao = new Date(os.created_at).toISOString().split('T')[0];
                    return dataCriacao >= dataInicio && dataCriacao <= dataFim;
                });
            }

            const pago = dadosFiltrados.filter(os => os.status === 'Pago').reduce((acc, os) => acc + (os.valor || 0), 0);
            const pendente = dadosFiltrados.filter(os => os.status === 'Pendente').reduce((acc, os) => acc + (os.valor || 0), 0);
            const andamento = dadosFiltrados.filter(os => os.status === 'Em Andamento').reduce((acc, os) => acc + (os.valor || 0), 0);
            const total = pago + pendente + andamento;

            document.getElementById('dashPago').innerText = pago.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            document.getElementById('dashPendente').innerText = pendente.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            document.getElementById('dashAndamento').innerText = andamento.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            document.getElementById('dashTotal').innerText = total.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });

            // ======================================================
            // COLOQUE O CÓDIGO DE LUCRO E ESTOQUE EXATAMENTE AQUI:
            // ======================================================
            const opId = localStorage.getItem('operador_id');
            const prodQuery = supabaseClient.from('produtos').select('preco_custo, preco_venda, estoque, nome');
            if (opId) prodQuery.eq('operador_id', opId);
            const { data: dataProdutos } = await prodQuery;

            if (dataProdutos && todasOS) {
                // 1. Valor Total em Estoque (Patrimonial)
                const valorEmEstoque = dataProdutos.reduce((acc, p) => acc + (p.preco_custo * p.estoque), 0);
                document.getElementById('dashEstoqueTotal').innerText = valorEmEstoque.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });

                // 2. Cálculo do Lucro Presumido
                const osPagas = dadosFiltrados.filter(os => os.status === 'Pago');
                let custoTotalPecasPagas = 0;
                let faturamentoTotalPago = osPagas.reduce((acc, os) => acc + (os.valor || 0), 0);

                osPagas.forEach(os => {
                    dataProdutos.forEach(prod => {
                        if (os.servico && os.servico.includes(prod.nome)) {
                            custoTotalPecasPagas += prod.preco_custo;
                        }
                    });
                });

                const lucroReal = faturamentoTotalPago - custoTotalPecasPagas;
                const campoLucro = document.getElementById('dashLucro');
                if (campoLucro) {
                    campoLucro.innerText = lucroReal.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
                }
            }
            // ======================================================
            // FIM DO BLOCO INSERIDO
        }


        // 1. Primeiro defina a função que o atalho vai chamar
        async function abrirOSRapida() {
            // 1. Limpa o formulário (campos de texto, número e selects)
            document.getElementById('formCadastro').reset();

            // 2. Limpa especificamente o campo de arquivo (foto)
            const fotoInput = document.getElementById('fotoInput');
            if (fotoInput) fotoInput.value = "";

            // 3. Reseta o array de peças e a visualização na tela
            pecasSelecionadas = [];
            document.getElementById('listaPecas').innerHTML = '';
            await popularSelectServicos();

            const modalCadastro = bootstrap.Modal.getOrCreateInstance(document.getElementById('modalCadastro'));
            modalCadastro.show();

            // 4. Define os valores padrão de segurança
            document.getElementById('status').value = 'Pendente';
            document.getElementById('valor').value = '0';

            // 5. Foca no primeiro campo para agilizar a digitação
            setTimeout(() => {
                document.getElementById('nome').focus();
            }, 500);

        }

        // 2. ADICIONE O ATALHO AQUI (Final do Script)
        document.addEventListener('keydown', function (event) {
            // ALT + N abre Nova O.S.
            if (event.altKey && (event.key === 'n' || event.key === 'N')) {
                event.preventDefault();
                abrirOSRapida();
            }
        });

        // ===== CONFIGURAÇÕES DA EMPRESA =====

        async function carregarConfiguracoes() {
            const operadorId = localStorage.getItem('operador_id');

            const { data, error } = await supabaseClient
                .from('configuracoes')
                .select('*')
                .eq('operador_id', operadorId)
                .maybeSingle();

            if (data) {
                document.getElementById('configNomeEmpresa').value = data.nome_empresa || '';
                document.getElementById('configCNPJ').value = data.cnpj || '';
                document.getElementById('configTelefone').value = data.telefone || '';
                document.getElementById('configEndereco').value = data.endereco || '';
            }
        }

        document.getElementById('formConfiguracoes').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const operadorId = localStorage.getItem('operador_id');

            if (!operadorId) {
                showNotify("Erro: Usuário não identificado. Faça login novamente.", "error");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>GRAVANDO...';

            const dados = {
                nome_empresa: document.getElementById('configNomeEmpresa').value,
                cnpj: document.getElementById('configCNPJ').value,
                telefone: document.getElementById('configTelefone').value,
                endereco: document.getElementById('configEndereco').value,
                operador_id: operadorId
            };

            try {
                const { data: existe } = await supabaseClient.from('configuracoes').select('id').eq('operador_id', operadorId).maybeSingle();

                let erro;
                if (existe) {
                    const { error } = await supabaseClient.from('configuracoes').update(dados).eq('operador_id', operadorId);
                    erro = error;
                } else {
                    const { error } = await supabaseClient.from('configuracoes').insert([dados]);
                    erro = error;
                }

                if (erro) throw erro;

                showNotify('Configurações salvas com sucesso!');
                bootstrap.Modal.getInstance(document.getElementById('modalConfiguracoes')).hide();
            } catch (err) {
                console.error(err);
                showNotify('Erro ao salvar no banco: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-save me-2"></i>SALVAR CONFIGURAÇÕES';
            }
        });

        // Carregar configurações ao abrir o modal
        document.getElementById('modalConfiguracoes')?.addEventListener('show.bs.modal', carregarConfiguracoes);

        // ===== LISTA DE CLIENTES NO MODAL DE BUSCA =====
        function carregarListaClientes() {
            // Pega clientes únicos
            const clientesUnicos = {};
            todasOS.forEach(os => {
                if (!clientesUnicos[os.nome]) {
                    clientesUnicos[os.nome] = {
                        nome: os.nome,
                        whatsapp: os.whatsapp,
                        ultimaVisita: os.created_at
                    };
                } else {
                    // Atualiza se for mais recente
                    if (new Date(os.created_at) > new Date(clientesUnicos[os.nome].ultimaVisita)) {
                        clientesUnicos[os.nome].ultimaVisita = os.created_at;
                    }
                }
            });

            const clientes = Object.values(clientesUnicos).sort((a, b) =>
                new Date(b.ultimaVisita) - new Date(a.ultimaVisita)
            ).slice(0, 12); // Mostra os 12 mais recentes

            const grid = document.getElementById('gridClientes');
            grid.innerHTML = clientes.map(cliente => {
                // Escapar aspas no nome para não quebrar o HTML
                const nomeSeguro = cliente.nome.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                    <div class="col-md-4">
                        <div class="card-modern p-3" style="cursor: pointer;" onclick="buscarClientePorNome('${nomeSeguro}')">
                            <div class="d-flex align-items-center">
                                <div class="me-3" style="width: 45px; height: 45px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    ${cliente.nome.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-bold">${cliente.nome}</h6>
                                    <small class="text-muted">${cliente.whatsapp}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function buscarClientePorNome(nome) {
            // Limpa a busca e mostra o resultado
            const inputBusca = document.getElementById('inputBuscaFicha');
            inputBusca.value = nome;

            // Esconde a lista de clientes
            document.getElementById('listaClientesInicial').style.display = 'none';

            // Busca o cliente
            const historico = todasOS.filter(os => os.nome.toLowerCase() === nome.toLowerCase());

            if (historico.length > 0) {
                document.getElementById('fichaVazia').style.display = 'none';
                document.getElementById('resultadoFicha').style.display = 'block';

                const cliente = historico[0];
                document.getElementById('fichaNome').innerText = cliente.nome;
                document.getElementById('fichaWhats').innerText = cliente.whatsapp;

                const totalGasto = historico.reduce((acc, os) => acc + (os.valor || 0), 0);
                document.getElementById('fichaTotalGasto').innerText = totalGasto.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });

                const tbody = document.getElementById('fichaTabelaHistorio');
                tbody.innerHTML = historico.map(os => {
                    const btnAcao = os.status !== 'Pago'
                        ? `<button class="btn btn-sm btn-success" onclick="finalizarOSRapido('${os.id}')"><i class="fa-solid fa-check"></i> Receber</button>`
                        : `<span class="badge bg-light text-success"><i class="fa-solid fa-check-double"></i> Pago</span>`;

                    return `
                <tr>
                    <td>${new Date(os.created_at).toLocaleDateString()}</td>
                    <td><span class="badge bg-dark">${os.veiculo}</span></td>
                    <td><small>${os.servico || 'Geral'}</small></td>
                    <td class="fw-bold">R$ ${parseFloat(os.valor).toFixed(2)}</td>
                    <td class="text-center">${btnAcao}</td>
                </tr>
            `;
                }).join('');
            }
        }

        verificarSessao();
        carregarCatalogoServicos();

        // ===== MÁSCARAS DE CAMPOS =====
        // Criar tabela de configurações se não existir
        async function criarTabelaConfiguracoes() {
            const { error } = await supabaseClient.rpc('create_configuracoes_table');
            if (error && !error.message.includes('already exists')) {
                console.log('Nota: Execute este SQL no Supabase para criar a tabela de configurações:');
                console.log(`
                    CREATE TABLE IF NOT EXISTS configuracoes (
                        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
                        nome_empresa TEXT,
                        cnpj TEXT,
                        telefone TEXT,
                        endereco TEXT,
                        created_at TIMESTAMP DEFAULT NOW()
                    );
                `);
            }
        }

        criarTabelaConfiguracoes();

        // ===== INICIALIZAR TUDO APÓS DOM CARREGAR =====
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🚀 DOM carregado! Inicializando event listeners...');

            // Aplicar máscaras
            setTimeout(() => {
                const cnpjInput = document.getElementById('configCNPJ');
                const telefoneInput = document.getElementById('configTelefone');

                if (cnpjInput && typeof IMask !== 'undefined') {
                    console.log('✅ Aplicando máscara CNPJ');
                    IMask(cnpjInput, { mask: '00.000.000/0000-00' });
                }

                if (telefoneInput && typeof IMask !== 'undefined') {
                    console.log('✅ Aplicando máscara Telefone');
                    IMask(telefoneInput, {
                        mask: [
                            { mask: '(00) 0000-0000' },
                            { mask: '(00) 00000-0000' }
                        ]
                    });
                }
            }, 500);
        });

        // Remove badge da lista e subtrai valor
        window.removerItemLista = function (btnClose) {
            const badge = btnClose.closest('.badge');
            if (!badge) return;
            const preco = parseFloat(badge.dataset.preco) || 0;
            const tipo = badge.dataset.tipo;
            const nome = badge.dataset.nome;

            const isEdicao = btnClose.closest('#modalEdicao') !== null;
            const idValor = isEdicao ? 'editValor' : 'valor';

            if (tipo === 'produto' && !isEdicao) {
                pecasSelecionadas = pecasSelecionadas.filter(p => p.nome !== nome);
            }

            const campoValor = document.getElementById(idValor);
            if (campoValor) {
                campoValor.value = Math.max(0, (parseFloat(campoValor.value) || 0) - preco).toFixed(2);
            }
            badge.remove();
        };

        let graficoLucro = null;

        async function renderizarRelatorioLucroServico() {
            const lucrosPorServico = {};

            // Filtra as OS pagas para calcular o lucro real
            const osPagas = todasOS.filter(os => os.status === 'Pago');

            osPagas.forEach(os => {
                const descricao = os.servico || 'Geral';
                // Divide os serviços se houver mais de um na mesma OS (separados por vírgula)
                const listaS = descricao.split(',').map(s => s.trim());

                listaS.forEach(serv => {
                    // Atribui o valor da OS proporcionalmente ou integralmente ao serviço
                    lucrosPorServico[serv] = (lucrosPorServico[serv] || 0) + (os.valor / listaS.length);
                });
            });

            const labels = Object.keys(lucrosPorServico);
            const valores = Object.values(lucrosPorServico);

            const ctx = document.getElementById('graficoLucroServico').getContext('2d');
            if (graficoLucro) graficoLucro.destroy();

            graficoLucro = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: valores,
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        document.addEventListener('keydown', function (e) {
            // ALT + S (Search) para abrir o buscador/dossiê
            if (e.altKey && e.key.toLowerCase() === 's') {
                e.preventDefault();
                abrirBuscadorCliente();
            }
        });
        // --- CENTRAL DE BUSCA E DOSSIÊ (CORRIGIDO) ---

        // 1. Função para abrir o modal e dar foco automático
        function abrirBuscadorCliente() {
            const modalElement = document.getElementById('modalBuscaCliente');
            const modalBusca = bootstrap.Modal.getOrCreateInstance(modalElement);

            // Limpeza reforçada para evitar o e-mail automático
            const inputBusca = document.getElementById('inputBuscaFicha');
            inputBusca.value = '';

            document.getElementById('resultadoFicha').style.display = 'none';
            document.getElementById('fichaVazia').style.display = 'none';
            document.getElementById('listaClientesInicial').style.display = 'block';

            carregarListaClientes();
            modalBusca.show();

            // Foco automático e limpeza após abertura total
            modalElement.addEventListener('shown.bs.modal', function () {
                inputBusca.value = ''; // Limpa novamente caso o navegador insira após abrir
                inputBusca.focus();
            }, { once: true });
        }

        // 2. Lógica de Pesquisa em Tempo Real
        document.getElementById('inputBuscaFicha')?.addEventListener('input', function (e) {
            const busca = e.target.value.toLowerCase();

            // Inicia a busca a partir de 2 caracteres para ser mais rápido
            if (busca.length < 2) {
                document.getElementById('resultadoFicha').style.display = 'none';
                document.getElementById('fichaVazia').style.display = 'none';
                document.getElementById('listaClientesInicial').style.display = 'block';
                return;
            }

            // Esconde a lista de clientes quando há busca
            document.getElementById('listaClientesInicial').style.display = 'none';

            const historico = todasOS.filter(os =>
                os.nome.toLowerCase().includes(busca) ||
                os.veiculo.toLowerCase().includes(busca)
            );

            if (historico.length > 0) {
                document.getElementById('fichaVazia').style.display = 'none';
                document.getElementById('resultadoFicha').style.display = 'block';

                const cliente = historico[0];
                document.getElementById('fichaNome').innerText = cliente.nome;
                document.getElementById('fichaWhats').innerText = cliente.whatsapp;

                const totalGasto = historico.reduce((acc, os) => acc + (os.valor || 0), 0);
                document.getElementById('fichaTotalGasto').innerText = totalGasto.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });

                const tbody = document.getElementById('fichaTabelaHistorio');
                tbody.innerHTML = historico.map(os => {
                    const btnAcao = os.status !== 'Pago'
                        ? `<button class="btn btn-sm btn-success" onclick="finalizarOSRapido('${os.id}')"><i class="fa-solid fa-check"></i> Receber</button>`
                        : `<span class="badge bg-light text-success"><i class="fa-solid fa-check-double"></i> Pago</span>`;

                    return `
                <tr>
                    <td>${new Date(os.created_at).toLocaleDateString()}</td>
                    <td><span class="badge bg-dark">${os.veiculo}</span></td>
                    <td><small>${os.servico || 'Geral'}</small></td>
                    <td class="fw-bold">R$ ${parseFloat(os.valor).toFixed(2)}</td>
                    <td class="text-center">${btnAcao}</td>
                </tr>
            `;
                }).join('');
            } else {
                document.getElementById('resultadoFicha').style.display = 'none';
                document.getElementById('fichaVazia').innerHTML = `<i class="fa-solid fa-user-slash"></i><p>Nenhum cliente encontrado com "${busca}"</p>`;
                document.getElementById('fichaVazia').style.display = 'block';
            }
        });

        // 3. Atalho ALT + H para busca rápida
        document.addEventListener('keydown', function (e) {
            if (e.altKey && e.key.toLowerCase() === 'h') {
                e.preventDefault();
                abrirBuscadorCliente();
            }
        });

        // Garantir que a função seja chamada corretamente ao clicar no botão
        document.addEventListener('DOMContentLoaded', function () {
            // Adiciona listener no botão flutuante
            const btnFabSearch = document.querySelector('.btn-fab-search');
            if (btnFabSearch) {
                btnFabSearch.addEventListener('click', function (e) {
                    e.preventDefault();
                    abrirBuscadorCliente();
                });
            }

            // Adiciona listener no campo de pesquisa da navbar (ID CORRETO)
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('click', function (e) {
                    e.preventDefault();
                    abrirBuscadorCliente();
                });
                searchInput.addEventListener('focus', function (e) {
                    e.preventDefault();
                    abrirBuscadorCliente();
                    setTimeout(() => this.blur(), 100);
                });
            }
        });
        // 2. Função para finalizar o serviço direto pelo Dossiê
        async function finalizarOSRapido(id) {
            if (confirm("Confirmar recebimento e finalizar serviço?")) {
                const { error } = await supabaseClient
                    .from('ordens_servico')
                    .update({ status: 'Pago' })
                    .eq('id', id);

                if (!error) {
                    showNotify("Serviço finalizado e pagamento registrado!");

                    // Fecha o modal de busca
                    bootstrap.Modal.getInstance(document.getElementById('modalBuscaCliente')).hide();

                    // Atualiza a tela principal e o dashboard
                    carregarOS();
                } else {
                    showNotify("Erro ao finalizar: " + error.message, "error");
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Máscara para o CNPJ
            const cnpjInput = document.getElementById('configCNPJ');
            if (cnpjInput) {
                IMask(cnpjInput, {
                    mask: '00.000.000/0000-00'
                });
            }

            // Máscara para o Telefone (Dinâmica: Fixo ou Celular)
            const telefoneInput = document.getElementById('configTelefone');
            if (telefoneInput) {
                IMask(telefoneInput, {
                    mask: [
                        { mask: '(00) 0000-0000' },
                        { mask: '(00) 00000-0000' }
                    ]
                });
            }
        });

        async function obterDadosEmpresa() {
            const operadorId = localStorage.getItem('operador_id');
            const qEmp = supabaseClient.from('configuracoes').select('*').limit(1);
            if (operadorId) qEmp.eq('operador_id', operadorId);
            const { data } = await qEmp.maybeSingle();
            return {
                nome: data?.nome_empresa || 'MELÃO RODAS E PNEUS',
                cnpj: data?.cnpj || '31.447.084./0001-30',
                tel: data?.telefone || '(14)xxxxx-xxxx',
                end: data?.endereco || 'Av. Duque de Caxias,1316'
            };
        }

        // ========================================
        // FUNÇÕES DO MENU MOBILE
        // ========================================
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('mobileMenuOverlay');

            menu.classList.toggle('active');
            overlay.classList.toggle('active');

            // Previne scroll do body quando menu está aberto
            if (menu.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        function closeMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('mobileMenuOverlay');

            menu.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Fecha menu ao pressionar ESC
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeMobileMenu();
            }
        });


        // Atalho Secreto: ALT + L (abre o campo para colar a chave de comando/licença)
        document.addEventListener('keydown', function (e) {
            // Verifica se a tecla ALT e L foram pressionadas
            if (e.altKey && e.key.toLowerCase() === 'l') {
                e.preventDefault();
                console.log("Atalho ALT+L detectado. Abrindo planos...");

                // Se o usuário estiver logado, abrimos o modal de planos que contém o campo de input
                const modalElement = document.getElementById('modalLicensePlans');
                const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
                modal.show();

                // Dá foco automático no campo de input após o modal abrir
                setTimeout(() => {
                    document.getElementById('licenseKeyInput').focus();
                }, 500);
            }
        });

        // Valida e ativa a licença
        async function validateLicense() {
            const input = document.getElementById('licenseKeyInput');
            const licenseKey = input.value.trim();

            if (!licenseKey) return;

            try {
                // Decodifica a chave de Base64 para String e depois para Objeto
                const decodedString = atob(licenseKey);
                const decodedData = JSON.parse(decodedString);

                // --- LÓGICA DE BLOQUEIO TOTAL (KILL SWITCH) ---
                if (decodedData.tipo === "REVOGAR") {
                    // Remove a licença local
                    localStorage.removeItem(getLicenseKey());

                    // Pega o motivo enviado pelo gerador ou usa um padrão
                    const motivo = decodedData.motivo || "Acesso interrompido pelo administrador.";

                    // Desloga do Supabase
                    if (window.supabaseClient) {
                        await supabaseClient.auth.signOut();
                    }

                    Swal.fire({
                        icon: 'error',
                        title: 'ACESSO BLOQUEADO',
                        text: motivo,
                        confirmButtonText: 'Sair'
                    }).then(() => {
                        location.reload();
                    });
                    return;
                }

                // --- LÓGICA DE ATIVAÇÃO NORMAL ---
                const expirationDate = new Date(decodedData.expira_em);

                if (new Date() > expirationDate) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Licença Expirada',
                        text: 'Esta chave não é mais válida.'
                    });
                    return;
                }

                localStorage.setItem(getLicenseKey(), JSON.stringify(decodedData));

                Swal.fire({
                    icon: 'success',
                    title: 'Sistema Ativado!',
                    text: `Válido até: ${expirationDate.toLocaleString('pt-BR')}`
                }).then(() => {
                    location.reload();
                });

            } catch (error) {
                console.error('Erro:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Chave Inválida',
                    text: 'Verifique se copiou o código corretamente.'
                });
            }
        }

    </script>


    <!-- Modal de Configurações -->
    <div class="modal fade" id="modalConfiguracoes" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fa-solid fa-gear me-2"></i>Configurações da Empresa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="formConfiguracoes">
                    <div class="modal-body">
                        <div class="alert alert-info mb-4">
                            <i class="fa-solid fa-circle-info me-2"></i>
                            Estas informações aparecerão nas Ordens de Serviço geradas para o cliente.
                        </div>
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label-modern">Nome da Empresa</label>
                                <input type="text" id="configNomeEmpresa" class="form-control form-control-modern"
                                    placeholder="Ex: MELÃO RODAS Centro Automotivo" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label-modern">CNPJ</label>
                                <input type="text" id="configCNPJ" class="form-control form-control-modern"
                                    placeholder="00.000.000/0001-00" maxlength="18" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label-modern">Telefone</label>
                                <input type="tel" id="configTelefone" class="form-control form-control-modern"
                                    placeholder="(00) 00000-0000" maxlength="15" required>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label-modern">Endereço Completo</label>
                                <input type="text" id="configEndereco" class="form-control form-control-modern"
                                    placeholder="Rua, Número, Bairro - Cidade/UF" required>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-modern" data-bs-dismiss="modal"
                            style="color: var(--text-secondary); border-color: var(--border);">Cancelar</button>
                        <button type="submit" class="btn btn-primary-modern">
                            <i class="fa-solid fa-save me-2"></i>Salvar Configurações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalBuscaCliente" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fa-solid fa-address-card me-2"></i>Dossiê do Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="search-box mb-4 mx-auto" style="max-width: 600px;">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="search" id="inputBuscaFicha" class="form-control form-control-lg"
                            placeholder="Digite o nome do cliente para pesquisar..." autocomplete="chrome-off"
                            name="campo_pesquisa_aleatorio_99">
                    </div>

                    <!-- Lista de Clientes (quando não há busca) -->
                    <div id="listaClientesInicial" class="mb-4">
                        <h6 class="fw-bold mb-3">Clientes Recentes</h6>
                        <div class="row g-3" id="gridClientes">
                            <!-- Será preenchido via JS -->
                        </div>
                    </div>

                    <div id="resultadoFicha" style="display: none;">
                        <div class="row g-4">
                            <div class="col-md-4">
                                <div class="card-modern p-4 h-100 bg-light">
                                    <h6 class="fw-bold border-bottom pb-2 mb-3">Informações Cadastrais</h6>
                                    <p class="mb-1 text-muted small">NOME COMPLETO</p>
                                    <h5 id="fichaNome" class="fw-bold text-primary mb-3">-</h5>
                                    <p class="mb-1 text-muted small">CONTATO</p>
                                    <h5 id="fichaWhats" class="fw-bold mb-3">-</h5>
                                    <div class="stat-card p-3 mt-4">
                                        <div class="stat-label">Total Investido na Loja</div>
                                        <div class="stat-value text-success" id="fichaTotalGasto">R$ 0,00</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="card-modern p-4">
                                    <h6 class="fw-bold mb-3">Histórico de Visitas e Compras</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Data</th>
                                                    <th>Veículo</th>
                                                    <th>Serviços/Produtos</th>
                                                    <th>Valor</th>
                                                    <th class="text-center">Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody id="fichaTabelaHistorio"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="fichaVazia" class="empty-state" style="display: none;">
                        <i class="fa-solid fa-user-slash"></i>
                        <p>Nenhum cliente encontrado com essa busca.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // SISTEMA DE LICENCIAMENTO
        // ========================================

        // Chave secreta para validação (deve ser a mesma do gerador Python)
        // Esta é a assinatura pública - a chave privada está no servidor Python
        const LICENSE_PUBLIC_KEY = "MELAO_RODAS_2025";

        // Função para calcular hash SHA-256
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Verifica se existe uma licença válida
        let countdownInterval;

        // Retorna a chave de licença única por operador
        function getLicenseKey() {
            const operadorId = localStorage.getItem('operador_id');
            return operadorId ? `melaoRodasLicense_${operadorId}` : 'melaoRodasLicense';
        }

        // Sincroniza a licença com o banco de dados (Supabase)
        async function sincronizarLicencaComBanco() {
            const operadorId = localStorage.getItem('operador_id');
            if (!operadorId) return;

            try {
                const { data, error } = await supabaseClient
                    .from('operadores')
                    .select('expira_em, status, nome')
                    .eq('id', operadorId)
                    .single();

                if (error || !data) return;

                // Se operador estiver bloqueado no banco, remove licença
                if (data.status === 'bloqueado') {
                    localStorage.removeItem(getLicenseKey());
                    return;
                }

                if (!data.expira_em) return;

                // Atualiza o localStorage com a data real do banco
                const licenseAtual = JSON.parse(localStorage.getItem(getLicenseKey()) || '{}');

                // Não sobrescreve licença master temporária
                if (licenseAtual.master) return;

                const novaExpiracao = new Date(data.expira_em).toISOString();
                licenseAtual.expira_em = novaExpiracao;
                licenseAtual.tipo = licenseAtual.tipo || 'ATIVACAO';
                localStorage.setItem(getLicenseKey(), JSON.stringify(licenseAtual));

            } catch (e) {
                console.warn('Falha ao sincronizar licença com banco:', e);
            }
        }

        function iniciarCountdown(expirationDate) {
            const bar = document.getElementById('countdown-bar');
            if (countdownInterval) clearInterval(countdownInterval);

            countdownInterval = setInterval(() => {
                const agora = new Date().getTime();
                const distancia = expirationDate.getTime() - agora;

                if (distancia < 0) {
                    clearInterval(countdownInterval);
                    localStorage.removeItem(getLicenseKey());
                    location.reload();
                    return;
                }

                const dias = Math.floor(distancia / (1000 * 60 * 60 * 24));
                const horas = Math.floor((distancia % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutos = Math.floor((distancia % (1000 * 60 * 60)) / (1000 * 60));
                const segundos = Math.floor((distancia % (1000 * 60)) / 1000);

                bar.style.display = 'block';
                document.getElementById('countdown-timer').innerHTML =
                    `${dias}d ${horas}h ${minutos}m ${segundos}s`;
            }, 1000);
        }

        async function checkLicense() {
            const bar = document.getElementById('countdown-bar');

            // Primeiro sincroniza com o banco para pegar a data real
            await sincronizarLicencaComBanco();

            const licenseData = JSON.parse(localStorage.getItem(getLicenseKey()));

            if (!licenseData || !licenseData.expira_em) {
                showLicenseBlock();
                bar.style.display = 'none';
                return;
            }

            const expirationDate = new Date(licenseData.expira_em);

            if (new Date() > expirationDate) {
                localStorage.removeItem(getLicenseKey());
                showLicenseBlock();
                bar.style.display = 'none';
                return;
            }

            iniciarCountdown(expirationDate);
        }

        // Mostra tela de bloqueio
        function showLicenseBlock() {
            document.getElementById('licenseOverlay').style.display = 'flex';
        }

        // Esconde tela de bloqueio
        function hideLicenseBlock() {
            document.getElementById('licenseOverlay').style.display = 'none';
        }

        // ================================================
        // MODO MASTER - Acesso secreto pelo cadeado
        // ================================================
        const MASTER_USER = 'master';
        const MASTER_PASS = 'melao@2025';
        let masterClicks = 0;
        let masterClickTimer = null;

        function masterClickHandler() {
            masterClicks++;

            // Mostra os dots a partir do 1º clique
            const dotsEl = document.getElementById('masterClickDots');
            dotsEl.style.display = 'block';

            // Preenche os dots conforme os cliques
            for (let i = 1; i <= 5; i++) {
                const dot = document.getElementById('dot' + i);
                if (dot) {
                    dot.style.background = i <= masterClicks ? '#dc2626' : '#e5e7eb';
                    dot.style.transform = i <= masterClicks ? 'scale(1.3)' : 'scale(1)';
                }
            }

            // Vibração visual do cadeado
            const icon = document.getElementById('lockIconGlyph');
            icon.style.transform = 'scale(1.2)';
            setTimeout(() => { icon.style.transform = 'scale(1)'; }, 150);

            // Resetar timer de inatividade (5s sem clicar reseta)
            if (masterClickTimer) clearTimeout(masterClickTimer);
            masterClickTimer = setTimeout(() => {
                masterClicks = 0;
                dotsEl.style.display = 'none';
                for (let i = 1; i <= 5; i++) {
                    const d = document.getElementById('dot' + i);
                    if (d) { d.style.background = '#e5e7eb'; d.style.transform = 'scale(1)'; }
                }
            }, 5000);

            // 5 cliques -> abre o painel master
            if (masterClicks >= 5) {
                clearTimeout(masterClickTimer);
                masterClicks = 0;
                dotsEl.style.display = 'none';
                for (let i = 1; i <= 5; i++) {
                    const d = document.getElementById('dot' + i);
                    if (d) { d.style.background = '#e5e7eb'; d.style.transform = 'scale(1)'; }
                }
                // Muda cadeado para cor vermelha indicando modo master
                document.getElementById('lockIconGlyph').style.color = '#dc2626';
                document.getElementById('masterLoginPanel').style.display = 'block';
                document.getElementById('masterLoginErro').style.display = 'none';
                document.getElementById('masterUser').value = '';
                document.getElementById('masterPass').value = '';
                setTimeout(() => document.getElementById('masterUser').focus(), 50);
            }
        }

        function confirmarMasterLogin() {
            const user = document.getElementById('masterUser').value.trim();
            const pass = document.getElementById('masterPass').value;

            if (user === MASTER_USER && pass === MASTER_PASS) {
                // Sucesso: cria uma licença temporária de sessão (não salva no localStorage permanentemente)
                const tempLicense = {
                    tipo: 'ATIVACAO',
                    master: true,
                    expira_em: new Date(Date.now() + 8 * 60 * 60 * 1000).toISOString() // 8h de sessão
                };
                sessionStorage.setItem('masterSession', JSON.stringify(tempLicense));
                localStorage.setItem(getLicenseKey(), JSON.stringify(tempLicense));

                document.getElementById('licenseOverlay').style.display = 'none';
                document.getElementById('lockIconGlyph').style.color = '';
                document.getElementById('masterLoginPanel').style.display = 'none';

                if (typeof showNotify === 'function') {
                    showNotify('Modo master ativado! Acesso liberado por 8h.', 'success');
                }
                // Carrega o sistema normalmente
                if (typeof carregarOS === 'function') carregarOS();
                if (typeof carregarProdutos === 'function') carregarProdutos();
            } else {
                document.getElementById('masterLoginErro').style.display = 'block';
                document.getElementById('masterPass').value = '';
                document.getElementById('masterPass').focus();
                // Shake visual no painel
                const panel = document.getElementById('masterLoginPanel');
                panel.style.animation = 'none';
                panel.style.transform = 'translateX(-8px)';
                setTimeout(() => { panel.style.transform = 'translateX(8px)'; }, 80);
                setTimeout(() => { panel.style.transform = 'translateX(-5px)'; }, 160);
                setTimeout(() => { panel.style.transform = 'translateX(0)'; }, 240);
            }
        }

        function fecharMasterPanel() {
            document.getElementById('masterLoginPanel').style.display = 'none';
            document.getElementById('lockIconGlyph').style.color = '';
            masterClicks = 0;
        }

        // Mostra modal de planos
        function showLicensePlans() {
            const modalElement = document.getElementById('modalLicensePlans');
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',
                keyboard: false
            });

            // Garantir que o modal tenha z-index maior que a tela de bloqueio
            modalElement.style.zIndex = '9999';

            // Quando o modal abrir, ajustar o backdrop também
            modalElement.addEventListener('shown.bs.modal', function () {
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.style.zIndex = '9998';
                }
            });

            modal.show();
        }

        // Mostra dias restantes
        function showDaysRemaining(days) {
            const element = document.getElementById('daysRemaining');
            const textElement = document.getElementById('daysRemainingText');

            if (days <= 7) {
                element.style.background = 'linear-gradient(135deg, #dc2626 0%, #991b1b 100%)';
            } else if (days <= 30) {
                element.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            }

            textElement.textContent = days === 1 ? '1 dia restante' : `${days} dias restantes`;
            element.style.display = 'block';
        }

        // Seleciona um plano
        function selectPlan(days, price) {
            const planName = days === 30 ? 'Mensal' : days === 180 ? 'Semestral' : 'Anual';
            const message = `Olá! Gostaria de adquirir o plano *${planName}* (${days} dias) por *R$ ${price.toFixed(2)}*.`;
            const whatsappUrl = `https://wa.me/5592995258724?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Contato via WhatsApp
        function contactWhatsApp() {
            const message = 'Olá! Gostaria de solicitar uma licença para o sistema MELÃO RODAS.';
            const whatsappUrl = `https://wa.me/5592995258724?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Adicionar evento de Enter no campo de licença
        document.getElementById('licenseKeyInput')?.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                validateLicense();
            }
        });

        // Permitir fechar modal apenas se houver licença válida
        document.getElementById('closeLicenseModal')?.addEventListener('click', function (e) {
            const licenseData = localStorage.getItem(getLicenseKey());
            if (!licenseData) {
                e.preventDefault();
                e.stopPropagation();
                Swal.fire({
                    icon: 'warning',
                    title: 'Licença Necessária',
                    text: 'Para usar o sistema, você precisa ativar uma licença.',
                    confirmButtonText: 'Entendi'
                });
            }
        });

        // Verificar licença ao carregar a página
        document.addEventListener('DOMContentLoaded', function () {
            // Aguardar 500ms para garantir que todos os elementos foram carregados
            setTimeout(() => {
                checkLicense();
            }, 500);
        });

        // Sincronizar licença com banco a cada 5 minutos
        setInterval(async function () {
            await sincronizarLicencaComBanco();
        }, 5 * 60 * 1000);


        function skipLicense() {
            const testLicense = {
                dias: 30,
                criado_em: new Date().toISOString(),
                expira_em: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                cliente_id: "TESTE",
                observacao: "Licença de teste",
                versao: "1.0",
                assinatura: "test"
            };
            localStorage.setItem(getLicenseKey(), JSON.stringify(testLicense));
            location.reload();
        }
        // Para usar: abra o console e digite: skipLicense()

        let atendenteLogado = null;
        let logoClicks = 0;

        // Certifique-se de que o ID 'logoClick' está exatamente na tag <a> da logo
        document.getElementById('logoClick')?.addEventListener('click', (e) => {
            e.preventDefault(); // Evita que a página recarregue ao clicar
            logoClicks++;
            console.log("Cliques na logo:", logoClicks); // Para você testar no console (F12)
            if (logoClicks >= 5) {
                document.getElementById('adminArea').style.setProperty('display', 'block', 'important');
                showNotify("Menu de Administrador liberado!", "success");
            }
        });

        // Função para abrir seleção de atendente após login bem-sucedido
        async function abrirSelecaoAtendente() {
            const { data, error } = await supabaseClient.from('atendentes').select('*');
            const lista = document.getElementById('listaAtendentesLogin');

            if (data && data.length > 0) {
                lista.innerHTML = data.map(at => `
            <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                onclick="verificarSenhaAtendente('${at.id}', '${at.nome}')">
                ${at.nome} <i class="fa-solid fa-chevron-right"></i>
            </button>
        `).join('');
                new bootstrap.Modal(document.getElementById('modalSelecaoAtendente')).show();
            } else {
                showNotify("Nenhum atendente cadastrado. Use o segredo da logo para cadastrar.", "error");
            }
        }

        async function verificarSenhaAtendente(id, nome) {
            // Fecha o modal de seleção de atendente primeiro
            const modalElement = document.getElementById('modalSelecaoAtendente');
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
                modalInstance.hide();
            }

            // Aguarda o modal fechar completamente antes de abrir o SweetAlert
            setTimeout(async () => {
                const { value: senha } = await Swal.fire({
                    title: `Senha de ${nome}`,
                    input: 'password',
                    inputLabel: 'Digite sua senha de 6 dígitos',
                    inputPlaceholder: '******',
                    inputAttributes: {
                        maxlength: 6,
                        autocomplete: 'off',
                        inputmode: 'numeric'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Confirmar',
                    cancelButtonText: 'Cancelar',
                    allowOutsideClick: false,
                    didOpen: () => {
                        // Força o foco no input assim que o SweetAlert abrir
                        setTimeout(() => {
                            const input = Swal.getInput();
                            if (input) {
                                input.focus();
                                input.click(); // Garante que o input está clicável
                            }
                        }, 100);
                    },
                    preConfirm: (senha) => {
                        if (!senha || senha.length !== 6) {
                            Swal.showValidationMessage('A senha deve ter 6 dígitos');
                            return false;
                        }
                        return senha;
                    }
                });

                if (senha) {
                    const { data } = await supabaseClient.from('atendentes').select('*').eq('id', id).eq('senha_numerica', senha).single();
                    if (data) {
                        atendenteLogado = nome;
                        showNotify(`Bem-vindo, ${nome}!`, "success");
                    } else {
                        showNotify("Senha incorreta", "error");
                        // Reabre o modal de seleção se a senha estiver incorreta
                        setTimeout(() => {
                            new bootstrap.Modal(modalElement).show();
                        }, 300);
                    }
                } else {
                    // Se cancelar, reabre o modal de seleção
                    setTimeout(() => {
                        new bootstrap.Modal(modalElement).show();
                    }, 300);
                }
            }, 400);
        }

        async function salvarAtendente() {
            const nome = document.getElementById('novoAtendenteNome').value;
            const senha = document.getElementById('novoAtendenteSenha').value;

            if (nome && senha.length === 6) {
                const { error } = await supabaseClient.from('atendentes').insert([{ nome, senha_numerica: senha }]);
                if (!error) {
                    showNotify("Atendente cadastrado!");
                    bootstrap.Modal.getInstance(document.getElementById('modalCadastroAtendente')).hide();
                }
            } else {
                showNotify("Preencha o nome e senha de 6 dígitos", "error");
            }
        }

        // Chame abrirSelecaoAtendente() dentro da sua função verificarSessao() 
        // quando detectar que o usuário está logado.

    </script>

    <div id="adminArea" style="display: none;" class="text-center mb-3">
        <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalCadastroAtendente">
            <i class="fa-solid fa-user-shield me-2"></i>Gerenciar Atendentes
        </button>
    </div>

    <div class="modal fade" id="modalSelecaoAtendente" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Quem está operando o sistema?</h5>
                </div>
                <div class="modal-body">
                    <div class="list-group" id="listaAtendentesLogin">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalCadastroAtendente" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cadastrar Novo Atendente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nome do Atendente</label>
                        <input type="text" id="novoAtendenteNome" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Senha Numérica (6 dígitos)</label>
                        <input type="password" id="novoAtendenteSenha" class="form-control" maxlength="6">
                    </div>
                    <button class="btn btn-primary w-100" onclick="salvarAtendente()">Salvar Atendente</button>
                </div>
            </div>
        </div>
    </div>

</body>


</html>
