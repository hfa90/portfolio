<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MELÃO RODAS
        | Gestão</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #1e3a8a;
            --primary-dark: #1e40af;
            --primary-light: #3b82f6;
            --accent: #0ea5e9;
            --accent-hover: #0284c7;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --bg: #f9fafb;
            --bg-secondary: #f3f4f6;
            --bg-card: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Navbar Corporativa Profissional */
        .navbar-custom {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 1.25rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-bottom: 3px solid var(--accent);
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.025em;
            color: white !important;
            text-transform: uppercase;
        }

        .navbar-brand i {
            color: var(--accent);
            margin-right: 0.75rem;
            font-size: 1.75rem;
        }

        .navbar-brand .text-accent {
            color: var(--accent);
            font-weight: 700;
        }

        /* Botões Modernos */
        .btn-modern {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary-modern {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none;
            box-shadow: 0 2px 4px rgba(30, 58, 138, 0.2);
            transition: all 0.2s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            font-size: 0.813rem;
        }

        .btn-primary-modern:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(30, 58, 138, 0.3);
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
        }

        .btn-outline-modern {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-primary-modern:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.2);
        }

        /* Botão Flutuante (FAB) Animado */
        .btn-fab-bolt {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
            z-index: 1050;
            transition: all 0.4s ease;
            animation: pulse-orange 2s infinite;
        }

        .btn-fab-bolt:hover {
            transform: rotate(15deg) scale(1.1);
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }


        @keyframes pulse-orange {
            0% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(245, 158, 11, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
            }
        }

        /* Tela de Bloqueio de Licença */
        .license-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.95) 0%, rgba(30, 64, 175, 0.98) 100%);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .license-box {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .license-icon {
            font-size: 5rem;
            color: var(--warning);
            margin-bottom: 1.5rem;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .license-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .license-message {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .btn-activate-license {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
        }

        .btn-activate-license:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
        }

        /* Modal de Planos - Z-INDEX MAIOR QUE A TELA DE BLOQUEIO */
        #modalLicensePlans {
            z-index: 9999 !important;
        }

        #modalLicensePlans .modal-backdrop {
            z-index: 9998 !important;
        }

        /* Pricing Cards */
        .pricing-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .pricing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .pricing-card.featured {
            border: 3px solid var(--accent);
            box-shadow: 0 10px 30px rgba(14, 165, 233, 0.2);
        }

        .pricing-card.featured::before {
            content: "MAIS VENDIDO";
            position: absolute;
            top: 15px;
            right: -35px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 5px 40px;
            transform: rotate(45deg);
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .pricing-period {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .pricing-price {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .pricing-price-old {
            font-size: 1.2rem;
            color: var(--text-secondary);
            text-decoration: line-through;
            margin-bottom: 1rem;
        }

        .pricing-economy {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            display: inline-block;
        }

        .pricing-features {
            list-style: none;
            padding: 0;
            margin: 1.5rem 0;
            text-align: left;
        }

        .pricing-features li {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .pricing-features li:last-child {
            border-bottom: none;
        }

        .pricing-features i {
            color: var(--success);
            font-size: 1.1rem;
        }

        .btn-select-plan {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-select-plan.plan-basic {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
        }

        .btn-select-plan.plan-featured {
            background: linear-gradient(135deg, var(--accent) 0%, #0284c7 100%);
            color: white;
        }

        .btn-select-plan.plan-premium {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-select-plan:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .license-input-section {
            margin-top: 3rem;
            padding-top: 3rem;
            border-top: 2px solid var(--border);
        }

        .license-input-box {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .license-input {
            flex: 1;
            min-width: 250px;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }

        .license-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-validate-license {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--success) 0%, #047857 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-validate-license:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3);
        }

        .whatsapp-support {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .btn-whatsapp {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-whatsapp:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.3);
        }

        .days-remaining {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, var(--success) 0%, #047857 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
            font-weight: 600;
            z-index: 1000;
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .days-remaining i {
            margin-right: 0.5rem;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .license-input-box {
                flex-direction: column;
            }

            .license-input {
                min-width: 100%;
            }

            .btn-validate-license {
                width: 100%;
            }

            .whatsapp-support {
                flex-direction: column;
            }

            .days-remaining {
                top: 70px;
                right: 10px;
                left: 10px;
                text-align: center;
            }
        }

        /* Tela de Bloqueio de Licença */
        .license-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.95) 0%, rgba(30, 64, 175, 0.98) 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .license-box {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .license-icon {
            font-size: 5rem;
            color: var(--warning);
            margin-bottom: 1.5rem;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .license-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .license-message {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .btn-activate-license {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
        }

        .btn-activate-license:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
        }

        /* Modal de Planos */
        .pricing-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .pricing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .pricing-card.featured {
            border: 3px solid var(--accent);
            box-shadow: 0 10px 30px rgba(14, 165, 233, 0.2);
        }

        .pricing-card.featured::before {
            content: "MAIS VENDIDO";
            position: absolute;
            top: 15px;
            right: -35px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 5px 40px;
            transform: rotate(45deg);
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .pricing-period {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .pricing-price {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .pricing-price-old {
            font-size: 1.2rem;
            color: var(--text-secondary);
            text-decoration: line-through;
            margin-bottom: 1rem;
        }

        .pricing-economy {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            display: inline-block;
        }

        .pricing-features {
            list-style: none;
            padding: 0;
            margin: 1.5rem 0;
            text-align: left;
        }

        .pricing-features li {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .pricing-features li:last-child {
            border-bottom: none;
        }

        .pricing-features i {
            color: var(--success);
            font-size: 1.1rem;
        }

        .btn-select-plan {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-select-plan.plan-basic {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
        }

        .btn-select-plan.plan-featured {
            background: linear-gradient(135deg, var(--accent) 0%, #0284c7 100%);
            color: white;
        }

        .btn-select-plan.plan-premium {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-select-plan:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .license-input-section {
            margin-top: 3rem;
            padding-top: 3rem;
            border-top: 2px solid var(--border);
        }

        .license-input-box {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .license-input {
            flex: 1;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }

        .license-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-validate-license {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--success) 0%, #047857 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-validate-license:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3);
        }

        .whatsapp-support {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .btn-whatsapp {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-whatsapp:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.3);
        }

        .days-remaining {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, var(--success) 0%, #047857 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
            font-weight: 600;
            z-index: 1000;
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .days-remaining i {
            margin-right: 0.5rem;
        }

        /* Botões de Ação na Tabela (Ajuste de Hover) */
        .btn-action-modern {
            transition: all 0.2s ease;
            border: 1px solid var(--border);
        }

        .btn-action-modern:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .btn-outline-modern:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 0.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Cards Modernos */
        .card-modern {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .card-modern:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-1px);
            border-color: var(--primary-light);
        }

        .card-header-modern {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 1.5rem;
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--text-primary);
        }

        /* Busca Moderna */
        .search-box {
            position: relative;
            width: 100%;
            max-width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            background: white;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* Tabela Moderna */
        .table-modern {
            width: 100%;
            background: white;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .table-modern thead {
            background: var(--bg-secondary);
        }

        .table-modern thead th {
            padding: 1rem 1.5rem;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
        }

        .table-modern tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.15s ease;
        }

        .table-modern tbody tr:hover {
            background: var(--bg);
        }

        .table-modern tbody tr:last-child {
            border-bottom: none;
        }

        .table-modern tbody td {
            padding: 1.25rem 1.5rem;
            vertical-align: middle;
            font-size: 0.875rem;
        }

        /* Status Badges */
        .badge-modern {
            padding: 0.375rem 0.875rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .badge-modern:hover {
            transform: scale(1.05);
        }

        .badge-pendente {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-andamento {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-concluido {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-pago {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-cancelado {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Action Buttons */
        .btn-action-modern {
            width: 36px;
            height: 36px;
            border-radius: 0.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            background: white;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn-action-modern:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-action-whatsapp:hover {
            background: #25d366;
            color: white;
            border-color: #25d366;
        }

        .btn-action-print:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .btn-action-edit:hover {
            background: var(--warning);
            color: white;
            border-color: var(--warning);
        }

        .btn-action-delete:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .btn-action-pix:hover {
            background: #00aaa1;
            color: white;
            border-color: #00aaa1;
        }

        .btn-action-orcamento:hover {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }

        .btn-os-cliente:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .btn-os-interno:hover {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }

        /* Imagens */
        .img-thumbnail-modern {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 0.75rem;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .img-thumbnail-modern:hover {
            transform: scale(1.1);
            border-color: var(--accent);
            box-shadow: var(--shadow-lg);
        }

        /* Modal Moderno */
        .modal-content {
            border: none;
            border-radius: 1rem;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
        }

        .modal-title {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            background: var(--bg);
        }

        /* Form Controls Modernos */
        .form-label-modern {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .form-control-modern {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-control-modern:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Toast Moderno */
        .toast-modern {
            border-radius: 0.75rem;
            border: none;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }

        /* Login Screen */
        .login-overlay {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .login-card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border);
        }

        /* Stats Cards */
        .stat-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Empty State */
        .empty-state {
            padding: 4rem 2rem;
            text-align: center;
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--text-secondary);
            opacity: 0.3;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--text-secondary);
        }

        /* Dashboard Toggle */
        #dashboard {
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        /* ========================================
           RESPONSIVIDADE MOBILE - VERSÃO COMPLETA
           ======================================== */

        /* Tablets e dispositivos médios */
        @media (max-width: 992px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            .btn-fab-bolt {
                width: 55px;
                height: 55px;
                bottom: 20px;
                right: 20px;
                font-size: 1.5rem;
            }

            .btn-fab-search {
                width: 55px;
                height: 55px;
                bottom: 85px;
                right: 20px;
                font-size: 1.3rem;
            }
        }

        /* Mobile - 768px e abaixo */
        @media (max-width: 768px) {

            /* Navbar Mobile */
            .navbar-custom {
                padding: 1rem 0;
            }

            .navbar-brand {
                font-size: 1.1rem;
            }

            .navbar-brand i {
                font-size: 1.3rem;
                margin-right: 0.5rem;
            }

            /* Botões da navbar mobile */
            .navbar .d-flex.gap-2 {
                gap: 0.25rem !important;
                flex-wrap: wrap;
            }

            .btn-icon {
                width: 36px !important;
                height: 36px !important;
                font-size: 0.875rem;
            }

            /* Esconde botões secundários em mobile */
            .d-none.d-md-flex {
                display: none !important;
            }

            /* Botões flutuantes mobile */
            .btn-fab-bolt {
                width: 50px;
                height: 50px;
                bottom: 15px;
                right: 15px;
                font-size: 1.3rem;
            }

            .btn-fab-search {
                width: 50px;
                height: 50px;
                bottom: 75px;
                right: 15px;
                font-size: 1.1rem;
            }

            /* Stats cards mobile */
            .stat-card {
                margin-bottom: 1rem;
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .stat-label {
                font-size: 0.75rem;
            }

            .stat-icon {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            /* Dashboard mobile */
            #dashboard {
                padding: 1rem;
            }

            /* Tabela mobile - modo scroll horizontal */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table-modern {
                font-size: 0.75rem;
                min-width: 600px;
            }

            .table-modern thead th {
                padding: 0.5rem 0.25rem;
                font-size: 0.7rem;
            }

            .table-modern tbody td {
                padding: 0.75rem 0.5rem;
                font-size: 0.75rem;
            }

            /* Botões de ação na tabela - mobile */
            .btn-action-modern {
                width: 32px;
                height: 32px;
                font-size: 0.75rem;
            }

            /* Cards mobile */
            .card-modern {
                margin-bottom: 1rem;
            }

            /* Modal mobile */
            .modal-dialog {
                margin: 0.5rem;
            }

            .modal-content {
                border-radius: 0.75rem;
            }

            .modal-header,
            .modal-footer {
                padding: 1rem;
            }

            .modal-body {
                padding: 1rem;
            }

            .modal-title {
                font-size: 1.1rem;
            }

            /* Forms mobile */
            .form-control-modern {
                font-size: 1rem;
                /* Previne zoom no iOS */
                padding: 0.875rem 1rem;
            }

            .form-label-modern {
                font-size: 0.875rem;
                margin-bottom: 0.375rem;
            }

            /* Botões mobile */
            .btn-primary-modern {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }

            .btn-modern {
                padding: 0.5rem 1rem;
                font-size: 0.813rem;
            }

            /* Search box mobile */
            .search-box {
                max-width: 100%;
            }

            .search-box input {
                font-size: 1rem;
                padding: 0.75rem 1rem 0.75rem 2.75rem;
            }

            /* Badges mobile */
            .badge-modern {
                font-size: 0.65rem;
                padding: 0.25rem 0.5rem;
            }

            /* Grid responsivo */
            .row.g-3,
            .row.g-4 {
                margin-left: -0.5rem;
                margin-right: -0.5rem;
            }

            .row.g-3>*,
            .row.g-4>* {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
        }

        /* Mobile pequeno - 576px e abaixo */
        @media (max-width: 576px) {

            /* Container mobile pequeno */
            .container {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }

            /* Navbar ultra mobile */
            .navbar-brand {
                font-size: 1rem;
            }

            .navbar-brand i {
                display: none;
                /* Esconde ícone em telas muito pequenas */
            }

            /* Stats em coluna única */
            .stat-card {
                text-align: center;
            }

            /* Tabela mobile pequeno */
            .table-modern {
                font-size: 0.7rem;
            }

            .table-modern thead th {
                padding: 0.4rem 0.2rem;
                font-size: 0.65rem;
            }

            .table-modern tbody td {
                padding: 0.5rem 0.25rem;
            }

            /* Botões de ação menores */
            .btn-action-modern {
                width: 28px;
                height: 28px;
                font-size: 0.7rem;
            }

            /* Modal fullscreen em mobile muito pequeno */
            .modal-dialog {
                margin: 0;
                max-width: 100%;
                height: 100vh;
            }

            .modal-content {
                height: 100%;
                border-radius: 0;
            }

            /* Forms em mobile pequeno */
            .row.g-2>*,
            .row.g-3>* {
                margin-bottom: 0.75rem;
            }

            /* Botões full width em mobile */
            .btn-modern,
            .btn-primary-modern {
                width: 100%;
                justify-content: center;
            }

            /* Gráficos mobile */
            canvas {
                max-height: 250px !important;
            }
        }

        /* Landscape mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .modal-dialog {
                max-height: 90vh;
                overflow-y: auto;
            }

            .btn-fab-bolt,
            .btn-fab-search {
                right: 10px;
            }

            .btn-fab-bolt {
                bottom: 10px;
            }

            .btn-fab-search {
                bottom: 70px;
            }
        }

        /* Touch targets mínimos (acessibilidade) */
        @media (max-width: 768px) {

            button,
            .btn,
            a.btn,
            input[type="button"],
            input[type="submit"] {
                min-height: 44px;
                /* Padrão Apple HIG */
                min-width: 44px;
            }

            /* Aumenta área de toque de checkboxes e radios */
            input[type="checkbox"],
            input[type="radio"] {
                min-width: 22px;
                min-height: 22px;
            }
        }

        /* Previne zoom em inputs no iOS */
        @media (max-width: 768px) {

            input[type="text"],
            input[type="email"],
            input[type="tel"],
            input[type="number"],
            input[type="password"],
            input[type="date"],
            select,
            textarea {
                font-size: 16px !important;
            }
        }

        /* Esconde scrollbars desnecessárias em mobile */
        @media (max-width: 768px) {
            ::-webkit-scrollbar {
                width: 4px;
                height: 4px;
            }

            ::-webkit-scrollbar-track {
                background: transparent;
            }

            ::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.2);
                border-radius: 4px;
            }
        }

        /* Botões de Emissão de OS */
        .os-print-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-os-cliente {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-os-cliente:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
        }

        .btn-os-interno {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .btn-os-interno:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: white;
        }

        /* Animações Suaves */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        #listaServicosCatalogo tr {
            transition: all 0.2s ease;
        }

        #listaServicosCatalogo tr:hover {
            background-color: #f1f5f9;
            transform: scale(1.01);
        }

        tr[id^="linha-servico-"] input {
            border-color: var(--warning);
            background-color: #fffbeb;
        }


        /* Botão Flutuante de Pesquisa (Dossiê) */
        .btn-fab-search {
            position: fixed;
            bottom: 105px;
            /* Fica acima do botão de Nova OS */
            right: 30px;
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
            z-index: 1050;
            transition: all 0.4s ease;
        }

        .btn-fab-search:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.5);
        }

        /* ========================================
           MENU MOBILE HAMBURGER
           ======================================== */
        .mobile-menu-btn {
            display: none;
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .mobile-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .mobile-menu.active {
            right: 0;
        }

        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: none;
        }

        .mobile-menu-overlay.active {
            display: block;
        }

        .mobile-menu-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mobile-menu-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 0.5rem;
            font-size: 1.25rem;
            cursor: pointer;
        }

        .mobile-menu-items {
            padding: 1rem;
        }

        .mobile-menu-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .mobile-menu-item:hover {
            background: var(--bg-secondary);
        }

        .mobile-menu-item i {
            width: 24px;
            font-size: 1.25rem;
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .navbar .btn-icon.d-none {
                display: none !important;
            }
        }

        /* Ajustes adicionais para mobile */
        @media (max-width: 768px) {

            /* Login mobile */
            .login-card {
                padding: 2rem !important;
                margin: 1rem;
            }

            /* Melhora visualização de gráficos em mobile */
            #graficoFaturamento,
            #graficoServicos {
                height: 250px !important;
            }
        }

        #countdown-bar {
            display: none;
            background: #212529;
            color: #fff;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 9999;
            border-bottom: 2px solid #ffc107;
        }

        #countdown-timer {
            color: #ffc107;
            margin-left: 5px;
        }
    </style>
</head>

<body>
    <div id="countdown-bar">
        <i class="fa-solid fa-clock-rotate-left me-2"></i>
        Tempo de Licença Restante: <span id="countdown-timer">--:--:--</span>
    </div>
    <!-- Tela de Bloqueio de Licença -->
    <div id="licenseOverlay" class="license-overlay" style="display: none;">
        <div class="license-box">
            <div class="license-icon">
                <i class="fa-solid fa-lock"></i>
            </div>
            <h2 class="license-title">Sistema Bloqueado</h2>
            <p class="license-message">
                Para continuar usando o sistema, é necessário ativar uma licença válida.
                Escolha um de nossos planos ou insira sua chave de licença.
            </p>
            <button class="btn-activate-license" onclick="showLicensePlans()">
                <i class="fa-solid fa-key me-2"></i>Ativar Licença
            </button>
        </div>
    </div>

    <!-- Indicador de Dias Restantes -->
    <div id="daysRemaining" class="days-remaining" style="display: none;">
        <i class="fa-solid fa-clock"></i>
        <span id="daysRemainingText">30 dias restantes</span>
    </div>

    <!-- Modal de Planos de Licença -->
    <div class="modal fade" id="modalLicensePlans" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fa-solid fa-crown me-2"></i>Escolha seu Plano de Licença
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        id="closeLicenseModal"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Planos -->
                    <div class="row g-4 mb-5">
                        <!-- Plano 30 Dias -->
                        <div class="col-md-4">
                            <div class="pricing-card">
                                <div class="pricing-period">Plano Mensal</div>
                                <div class="pricing-price">R$ 39,90</div>
                                <div class="pricing-price-old">R$ 59,90</div>
                                <ul class="pricing-features">
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Acesso total por 30 dias</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Todas as funcionalidades</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Suporte via WhatsApp</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Atualizações incluídas</span>
                                    </li>
                                </ul>
                                <button class="btn-select-plan plan-basic" onclick="selectPlan(30, 39.90)">
                                    Escolher Mensal
                                </button>
                            </div>
                        </div>

                        <!-- Plano 6 Meses (MAIS VENDIDO) -->
                        <div class="col-md-4">
                            <div class="pricing-card featured">
                                <div class="pricing-period">Plano Semestral</div>
                                <div class="pricing-price">R$ 179,90</div>
                                <div class="pricing-price-old">R$ 359,40</div>
                                <div class="pricing-economy">
                                    <i class="fa-solid fa-piggy-bank me-1"></i>
                                    ECONOMIZE 50%
                                </div>
                                <ul class="pricing-features">
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Acesso total por 6 meses</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Todas as funcionalidades</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Suporte prioritário</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Atualizações incluídas</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span><strong>R$ 29,98/mês</strong></span>
                                    </li>
                                </ul>
                                <button class="btn-select-plan plan-featured" onclick="selectPlan(180, 179.90)">
                                    Escolher Semestral
                                </button>
                            </div>
                        </div>

                        <!-- Plano 1 Ano (MELHOR CUSTO-BENEFÍCIO) -->
                        <div class="col-md-4">
                            <div class="pricing-card">
                                <div class="pricing-period">Plano Anual</div>
                                <div class="pricing-price">R$ 299,90</div>
                                <div class="pricing-price-old">R$ 718,80</div>
                                <div class="pricing-economy">
                                    <i class="fa-solid fa-star me-1"></i>
                                    ECONOMIZE 58%
                                </div>
                                <ul class="pricing-features">
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Acesso total por 1 ano</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Todas as funcionalidades</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Suporte VIP 24/7</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span>Atualizações incluídas</span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-check-circle"></i>
                                        <span><strong>R$ 24,99/mês</strong></span>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-gift"></i>
                                        <span><strong>2 meses GRÁTIS</strong></span>
                                    </li>
                                </ul>
                                <button class="btn-select-plan plan-premium" onclick="selectPlan(365, 299.90)">
                                    Escolher Anual
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Seção de Pagamento -->
                    <div id="paymentSection" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fa-solid fa-qrcode me-2"></i>
                            <strong>Pagamento via PIX</strong><br>
                            Após escolher seu plano, entre em contato pelo WhatsApp para receber a chave PIX e
                            instruções de pagamento.
                        </div>
                    </div>

                    <!-- Seção de Inserir Licença -->
                    <div class="license-input-section">
                        <h6 class="fw-bold mb-3 text-center">Já possui uma licença?</h6>
                        <div class="license-input-box">
                            <input type="text" id="licenseKeyInput" class="license-input"
                                placeholder="XXXX-XXXX-XXXX-XXXX-XXXX" maxlength="500">
                            <button class="btn-validate-license" onclick="validateLicense()">
                                <i class="fa-solid fa-check me-2"></i>Ativar
                            </button>
                        </div>

                        <div class="whatsapp-support">
                            <span>Não tem uma licença?</span>
                            <button class="btn-whatsapp" onclick="contactWhatsApp()">
                                <i class="fa-brands fa-whatsapp"></i>
                                Solicitar no WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="closeMobileMenu()"></div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <div>
                <h5 class="mb-0 fw-bold">Menu</h5>
                <small>MELÃO RODAS</small>
            </div>
            <button class="mobile-menu-close" onclick="closeMobileMenu()">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <div class="mobile-menu-items">
            <button class="mobile-menu-item" onclick="toggleDashboard(); closeMobileMenu();">
                <i class="fa-solid fa-chart-line"></i>
                <span>Dashboard</span>
            </button>
            <button class="mobile-menu-item" data-bs-toggle="modal" data-bs-target="#modalCadastro"
                onclick="closeMobileMenu()">
                <i class="fa-solid fa-user-plus"></i>
                <span>Novo Cliente</span>
            </button>
            <button class="mobile-menu-item" data-bs-toggle="modal" data-bs-target="#modalServicos"
                onclick="closeMobileMenu()">
                <i class="fa-solid fa-bell-concierge"></i>
                <span>Catálogo de Serviços</span>
            </button>
            <button class="mobile-menu-item" data-bs-toggle="modal" data-bs-target="#modalEstoque"
                onclick="closeMobileMenu()">
                <i class="fa-solid fa-box-open"></i>
                <span>Estoque</span>
            </button>
            <button class="mobile-menu-item" data-bs-toggle="modal" data-bs-target="#modalConfiguracoes"
                onclick="closeMobileMenu()">
                <i class="fa-solid fa-gear"></i>
                <span>Configurações</span>
            </button>
            <hr class="my-2">
            <button class="mobile-menu-item" onclick="abrirOSRapida(); closeMobileMenu();">
                <i class="fa-solid fa-bolt"></i>
                <span>Nova Ordem de Serviço</span>
            </button>
            <button class="mobile-menu-item" onclick="abrirBuscadorCliente(); closeMobileMenu();">
                <i class="fa-solid fa-magnifying-glass"></i>
                <span>Buscar Cliente</span>
            </button>
            <hr class="my-2">
            <button class="mobile-menu-item" onclick="logout()">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span>Sair</span>
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 10000;">
        <div id="customToast" class="toast toast-modern align-items-center text-white bg-dark border-0" role="alert"
            aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body d-flex align-items-center">
                    <i id="toastIcon" class="fa-solid fa-circle-check me-2 fs-5"></i>
                    <span id="toastMessage" class="fw-semibold">Mensagem aqui</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <!-- Login Overlay -->
    <div id="loginOverlay"
        class="login-overlay position-fixed vh-100 vw-100 top-0 start-0 d-flex align-items-center justify-content-center"
        style="z-index: 9999;">
        <div class="login-card p-5" style="width: 100%; max-width: 420px;">
            <div class="text-center mb-4">
                <i class="fa-solid fa-screwdriver-wrench text-primary fs-1 mb-3"
                    style="color: var(--accent) !important;"></i>
                <h2 class="fw-bold mb-2">MELÃO <span class="text-accent">RODAS</span></h2>
                <p class="text-muted mb-0">Sistema de Gestão de Serviços</p>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label-modern">E-mail</label>
                    <input type="email" id="loginEmail" class="form-control form-control-modern"
                        placeholder="seu@email.com" required>
                </div>
                <div class="mb-4">
                    <label class="form-label-modern">Senha</label>
                    <input type="password" id="loginSenha" class="form-control form-control-modern"
                        placeholder="••••••••" required>
                </div>
                <div id="loginErro" class="alert alert-danger py-2 mb-3" style="display: none; border-radius: 0.5rem;">
                </div>
                <button type="submit" class="btn btn-primary-modern w-100 py-3 fw-bold" style="border-radius: 0.75rem;">
                    <i class="fa-solid fa-right-to-bracket me-2"></i>ENTRAR NO SISTEMA
                </button>
            </form>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-custom navbar-dark">
        <div class="container">
            <div class="d-flex align-items-center justify-content-between w-100">
                <a class="navbar-brand" href="#" id="logoClick" style="cursor: default; user-select: none;">
                    <i class="fa-solid fa-screwdriver-wrench"></i>MELÃO <span class="text-accent">RODAS</span>
                </a>
                <div class="d-flex align-items-center gap-2">
                    <!-- Menu Mobile Hamburger -->
                    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                        <i class="fa-solid fa-bars"></i>
                    </button>

                    <button class="btn btn-outline-modern btn-icon d-none d-md-flex" data-bs-toggle="modal"
                        data-bs-target="#modalEstoque" title="Estoque">
                        <i class="fa-solid fa-box-open"></i>
                    </button>
                    <button class="btn btn-outline-modern btn-icon d-none d-md-flex" data-bs-toggle="modal"
                        data-bs-target="#modalServicos" title="Catálogo de Serviços">
                        <i class="fa-solid fa-bell-concierge"></i>
                    </button>
                    <button class="btn btn-outline-modern btn-icon d-none d-md-flex" onclick="toggleDashboard()"
                        title="Dashboard">
                        <i class="fa-solid fa-chart-line"></i>
                    </button>
                    <button class="btn btn-outline-modern btn-icon d-none d-md-flex" data-bs-toggle="modal"
                        data-bs-target="#modalConfiguracoes" title="Configurações">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                    <button class="btn-fab-bolt" onclick="abrirOSRapida()" title="Atalho: ALT + N">
                        <i class="fa-solid fa-bolt"></i>
                    </button>

                    <button class="btn-fab-search" onclick="abrirBuscadorCliente()" title="Pesquisar Cliente (ALT + H)">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                    <button class="btn btn-outline-modern btn-icon" onclick="logout()" title="Sair">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container mt-4 mb-5">
        <!-- Dashboard -->
        <div id="dashboard" style="display: none;">
            <h3 class="fw-bold mb-4">Dashboard Financeiro</h3>

            <!-- Filtro de Datas -->
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label class="form-label-modern">Data Inicial</label>
                    <input type="date" id="dataInicio" class="form-control form-control-modern"
                        onchange="atualizarDashboard()">
                </div>
                <div class="col-md-4">
                    <label class="form-label-modern">Data Final</label>
                    <input type="date" id="dataFim" class="form-control form-control-modern"
                        onchange="atualizarDashboard()">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button class="btn btn-primary-modern w-100" onclick="exportarExcel()">
                        <i class="fa-solid fa-file-excel me-2"></i>Exportar Excel
                    </button>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #d1fae5; color: #10b981;">
                            <i class="fa-solid fa-check-circle"></i>
                        </div>
                        <div class="stat-value" style="color: #10b981;" id="dashPago">R$ 0,00</div>
                        <div class="stat-label">Pagos</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #fef3c7; color: #f59e0b;">
                            <i class="fa-solid fa-clock"></i>
                        </div>
                        <div class="stat-value" style="color: #f59e0b;" id="dashPendente">R$ 0,00</div>
                        <div class="stat-label">Pendentes</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #dbeafe; color: #3b82f6;">
                            <i class="fa-solid fa-spinner"></i>
                        </div>
                        <div class="stat-value" style="color: #3b82f6;" id="dashAndamento">R$ 0,00</div>
                        <div class="stat-label">Em Andamento</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #e0e7ff; color: #6366f1;">
                            <i class="fa-solid fa-dollar-sign"></i>
                        </div>
                        <div class="stat-value" style="color: #6366f1;" id="dashTotal">R$ 0,00</div>
                        <div class="stat-label">Total Geral</div>
                    </div>

                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #ede9fe; color: #7c3aed;">
                            <i class="fa-solid fa-vault"></i>
                        </div>
                        <div class="stat-value" style="color: #7c3aed;" id="dashEstoqueTotal">R$ 0,00</div>
                        <div class="stat-label">Valor em Estoque (Custo)</div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #dcfce7; color: #15803d;">
                            <i class="fa-solid fa-chart-line"></i>
                        </div>
                        <div class="stat-value" style="color: #15803d;" id="dashLucro">R$ 0,00</div>
                        <div class="stat-label">Lucro (Serviços Pagos)</div>
                    </div>
                </div>
            </div>
            <div class="card-modern p-4">
                <h5 class="fw-bold mb-3">Serviços Mais Realizados</h5>
                <canvas id="graficoVendas" style="max-height: 300px;"></canvas>
            </div>
            <div class="card-modern p-4 mt-4">
                <h5 class="fw-bold mb-3"><i class="fa-solid fa-hand-holding-dollar me-2"></i>Rentabilidade por Tipo de
                    Serviço</h5>
                <canvas id="graficoLucroServico" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- Header com Busca -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <h3 class="fw-bold mb-0">Ordens de Serviço</h3>
            <div class="search-box">
                <i class="fa-solid fa-search"></i>
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar por cliente, veículo...">
            </div>
        </div>

        <!-- Tabela de O.S. -->
        <div class="card-modern">
            <div class="table-responsive">
                <table class="table table-modern mb-0">
                    <thead>
                        <tr>
                            <th>Foto</th>
                            <th>Cliente</th>
                            <th>Veículo</th>
                            <th>Serviço</th>
                            <th>Status</th>
                            <th>Valor</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaOS">
                        <!-- Dados serão inseridos aqui -->
                    </tbody>
                </table>
            </div>
            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fa-solid fa-clipboard-list"></i>
                <h3>Nenhuma ordem de serviço</h3>
                <p>Comece criando sua primeira O.S. clicando em "Nova O.S."</p>
            </div>
        </div>
    </div>

    <!-- Modal Cadastro O.S. -->
    <div class="modal fade" id="modalCadastro" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fa-solid fa-plus-circle me-2"></i>Nova Ordem de Serviço</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="formCadastro">
                    <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label-modern">Nome do Cliente</label>
                                <input type="text" id="nome" class="form-control form-control-modern form-control-sm"
                                    required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">WhatsApp</label>
                                <input type="tel" id="whatsapp" class="form-control form-control-modern form-control-sm"
                                    required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">Veículo (Placa)</label>
                                <input type="text" id="veiculo" class="form-control form-control-modern form-control-sm"
                                    required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">Status</label>
                                <select id="status" class="form-select form-control-modern form-control-sm" required>
                                    <option value="Pendente">Pendente</option>
                                    <option value="Em Andamento">Em Andamento</option>
                                    <option value="Pago">Pago</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label-modern">Adicionar Serviços do Catálogo</label>
                                <select id="selectServicoRapido"
                                    class="form-select form-control-modern form-control-sm">
                                    <option value="">Selecione um serviço...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label-modern">Adicionar Produtos do Estoque</label>
                                <select id="selectProduto" class="form-select form-control-modern form-control-sm">
                                    <option value="">Selecione um produto...</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">Foto (opcional)</label>
                                <input type="file" id="fotoInput"
                                    class="form-control form-control-modern form-control-sm" accept="image/*">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">Valor (R$)</label>
                                <input type="number" id="valor" class="form-control form-control-modern form-control-sm"
                                    step="0.01" value="0" required>
                            </div>
                            <div class="col-12" id="listaPecas" style="min-height: 30px;">
                                <!-- Produtos e serviços adicionados aparecerão aqui -->
                            </div>
                            <div class="col-12">
                                <label class="form-label-modern">Observações / Serviço</label>
                                <textarea id="observacoes" class="form-control form-control-modern form-control-sm"
                                    rows="2" placeholder="Descreva os detalhes do serviço..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-modern btn-sm" data-bs-dismiss="modal"
                            style="color: var(--text-secondary); border-color: var(--border);">Cancelar</button>
                        <button type="submit" id="btnSalvar" class="btn btn-primary-modern btn-sm">
                            <i class="fa-solid fa-save me-2"></i>Salvar O.S.
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Edição O.S. -->
    <div class="modal fade" id="modalEdicao" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fa-solid fa-edit me-2"></i>Editar Ordem de Serviço</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="formEdicao">
                    <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
                        <input type="hidden" id="editId">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label-modern">Nome do Cliente</label>
                                <input type="text" id="editNome"
                                    class="form-control form-control-modern form-control-sm" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">WhatsApp</label>
                                <input type="tel" id="editWhatsapp"
                                    class="form-control form-control-modern form-control-sm" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">Veículo (Placa)</label>
                                <input type="text" id="editVeiculo"
                                    class="form-control form-control-modern form-control-sm" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">Status</label>
                                <select id="editStatus" class="form-select form-control-modern form-control-sm"
                                    required>
                                    <option value="Pendente">Pendente</option>
                                    <option value="Em Andamento">Em Andamento</option>
                                    <option value="Pago">Pago</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">Valor (R$)</label>
                                <input type="number" id="editValor"
                                    class="form-control form-control-modern form-control-sm" step="0.01" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-modern">Adicionar Produtos</label>
                                <select id="selectProdutoEdit" class="form-select form-control-modern form-control-sm">
                                    <option value="">Selecione um produto...</option>
                                </select>
                            </div>
                            <div class="col-12" id="listaPecasEdit" style="min-height: 30px;">
                                <!-- Produtos adicionados aparecerão aqui -->
                            </div>
                            <div class="col-12">
                                <label class="form-label-modern">Serviço / Observações</label>
                                <textarea id="editObservacoes" class="form-control form-control-modern form-control-sm"
                                    rows="2" required></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-modern btn-sm" data-bs-dismiss="modal"
                            style="color: var(--text-secondary); border-color: var(--border);">Cancelar</button>
                        <button type="submit" class="btn btn-primary-modern btn-sm">
                            <i class="fa-solid fa-save me-2"></i>Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Estoque -->
    <div class="modal fade" id="modalEstoque" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fa-solid fa-box-open me-2"></i>Gestão de Estoque</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="estoqueForm" class="mb-4 p-4" style="background: var(--bg); border-radius: 0.75rem;">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label-modern">Nome do Produto</label>
                                <input type="text" id="prodNome" class="form-control form-control-modern" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label-modern">Custo (R$)</label>
                                <input type="number" id="prodCusto" class="form-control form-control-modern" step="0.01"
                                    required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label-modern">Venda (R$)</label>
                                <input type="number" id="prodVenda" class="form-control form-control-modern" step="0.01"
                                    required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label-modern">Quantidade</label>
                                <input type="number" id="prodQtd" class="form-control form-control-modern" required>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary-modern w-100">
                                    <i class="fa-solid fa-plus me-2"></i>Adicionar
                                </button>
                            </div>
                        </div>
                    </form>
                    <div class="table-responsive">
                        <table class="table table-modern mb-0">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Custo</th>
                                    <th>Venda</th>
                                    <th class="text-center">Estoque</th>
                                    <th class="text-end">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="corpoTabelaEstoque"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal PIX -->
    <div class="modal fade" id="modalPix" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fa-solid fa-qrcode me-2"></i>Pagamento via PIX</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-4">
                    <div id="pixDetails" class="mb-3 small text-muted"></div>
                    <div class="d-flex justify-content-center mb-3">
                        <div id="qrcode" class="p-3 bg-white border rounded-3"></div>
                    </div>
                    <div class="input-group mb-3">
                        <input type="text" id="pixCopiaCola" class="form-control form-control-modern" readonly>
                        <button class="btn btn-outline-primary" onclick="copiarPix()">Copiar</button>
                    </div>
                    <button id="btnEnviarPixWhats" class="btn btn-success w-100 fw-bold">
                        <i class="fa-brands fa-whatsapp me-2"></i>ENVIAR PARA CLIENTE
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // CONFIGURAÇÃO SUPABASE - MIGRADO DO sistemadeservicos.html
        const SUPABASE_URL = 'https://oxqbhmblreprbeaflfld.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94cWJobWJscmVwcmJlYWZsZmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5OTUyNDUsImV4cCI6MjA4NjU3MTI0NX0.jZSFtEdXt1h9knqTZLSmKD72hx8x9oRir1Cs8hL65xI';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function verificarSessao() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            const overlay = document.getElementById('loginOverlay');

            if (session) {
                // Esconde a tela de login completamente
                overlay.style.display = 'none';
                overlay.classList.remove('d-flex');

                carregarOS();
                carregarProdutos();
            } else {
                // Se não houver sessão, mantém a tela de login visível
                overlay.style.display = 'flex';
                overlay.classList.add('d-flex');
            }
        }

        // Executa a verificação assim que a página carrega
        window.onload = verificarSessao;

        let todasOS = [];
        let pecasSelecionadas = [];

        // Máscaras
        IMask(document.getElementById('whatsapp'), { mask: '(00) 00000-0000' });
        IMask(document.getElementById('veiculo'), { mask: 'AAA-0*00', prepare: s => s.toUpperCase(), definitions: { '0': /[0-9A-Z]/, 'A': /[a-zA-Z]/ } });
        IMask(document.getElementById('editWhatsapp'), { mask: '(00) 00000-0000' });
        IMask(document.getElementById('editVeiculo'), { mask: 'AAA-0*00', prepare: s => s.toUpperCase(), definitions: { '0': /[0-9A-Z]/, 'A': /[a-zA-Z]/ } });

        // Verifica autenticação
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                document.getElementById('loginOverlay').style.display = 'none';
                carregarOS();
                carregarProdutos();
            }
        });

        // Login
        // Localize essa parte no seu código e ajuste para ver o erro:
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const senha = document.getElementById('loginSenha').value;
            const btn = e.target.querySelector('button');

            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Entrando...';

                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password: senha
                });

                if (error) {
                    document.getElementById('loginErro').textContent = "Erro: " + error.message;
                    document.getElementById('loginErro').style.display = 'block';
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-right-to-bracket me-2"></i>ENTRAR NO SISTEMA';
                } else {
                    // Login deu certo, forçamos a verificação de sessão para remover o bloqueio
                    await verificarSessao();
                    showNotify("Login realizado com sucesso!");

                    // Abre a seleção de atendente
                    setTimeout(() => {
                        abrirSelecaoAtendente();
                    }, 500);

                    // Reseta o botão após sucesso
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-right-to-bracket me-2"></i>ENTRAR NO SISTEMA';
                }
            } catch (err) {
                console.error("Erro inesperado:", err);
                btn.disabled = false;
                btn.innerHTML = 'ENTRAR NO SISTEMA';
            }
        });

        // Logout
        async function logout() {
            if (confirm("Deseja realmente sair do sistema?")) {
                await supabaseClient.auth.signOut();
                location.reload();
            }
        }

        // Toast Notification
        function showNotify(mensagem, tipo = 'success') {
            const toast = document.getElementById('customToast');
            const msg = document.getElementById('toastMessage');
            const icon = document.getElementById('toastIcon');

            msg.textContent = mensagem;

            if (tipo === 'success') {
                icon.className = 'fa-solid fa-circle-check me-2 fs-5';
                toast.classList.remove('bg-danger');
                toast.classList.add('bg-success');
            } else {
                icon.className = 'fa-solid fa-circle-xmark me-2 fs-5';
                toast.classList.remove('bg-success');
                toast.classList.add('bg-danger');
            }

            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // Toggle Dashboard
        function toggleDashboard() {
            const dash = document.getElementById('dashboard');
            if (dash.style.display === 'none') {
                dash.style.display = 'block';
                renderizarGraficoVendas();
                atualizarDashboard();
            } else {
                dash.style.display = 'none';
            }
        }

        // Atualizar Dashboard
        function atualizarDashboard() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;

            let dadosFiltrados = todasOS;

            if (dataInicio && dataFim) {
                dadosFiltrados = todasOS.filter(os => {
                    const dataCriacao = new Date(os.created_at).toISOString().split('T')[0];
                    return dataCriacao >= dataInicio && dataCriacao <= dataFim;
                });
            }

            const pago = dadosFiltrados.filter(os => os.status === 'Pago').reduce((acc, os) => acc + (os.valor || 0), 0);
            const pendente = dadosFiltrados.filter(os => os.status === 'Pendente').reduce((acc, os) => acc + (os.valor || 0), 0);
            const andamento = dadosFiltrados.filter(os => os.status === 'Em Andamento').reduce((acc, os) => acc + (os.valor || 0), 0);
            const total = pago + pendente + andamento;

            document.getElementById('dashPago').innerText = pago.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            document.getElementById('dashPendente').innerText = pendente.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            document.getElementById('dashAndamento').innerText = andamento.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            document.getElementById('dashTotal').innerText = total.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            renderizarRelatorioLucroServico();
        }

        // Exportar Excel
        function exportarExcel() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;

            let dadosParaExportar = todasOS;
            if (dataInicio && dataFim) {
                dadosParaExportar = todasOS.filter(os => {
                    const data = new Date(os.created_at).toISOString().split('T')[0];
                    return data >= dataInicio && data <= dataFim;
                });
            }

            const ws = XLSX.utils.json_to_sheet(dadosParaExportar.map(os => ({
                Data: new Date(os.created_at).toLocaleDateString(),
                Cliente: os.nome,
                WhatsApp: os.whatsapp,
                Veículo: os.veiculo,
                Serviço: os.servico,
                Valor: os.valor,
                Status: os.status,
                Observações: os.observacoes
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Relatório Financeiro");
            XLSX.writeFile(wb, `Relatorio_HaydenWheels_${new Date().toLocaleDateString()}.xlsx`);
        }

        // Carregar O.S.
        async function carregarOS() {
            const { data, error } = await supabaseClient.from('ordens_servico').select('*').order('created_at', { ascending: false });

            if (error) {
                console.error(error);
                return;
            }

            todasOS = data || [];
            renderizarTabela(todasOS);
            atualizarDashboard();
        }

        // Renderizar tabela
        function renderizarTabela(dados) {
            const tbody = document.getElementById('tabelaOS');
            const emptyState = document.getElementById('emptyState');

            if (!dados || dados.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            tbody.innerHTML = dados.map(os => {
                const statusClass =
                    os.status === 'Pendente' ? 'badge-pendente' :
                        os.status === 'Em Andamento' ? 'badge-andamento' :
                            os.status === 'Pago' ? 'badge-pago' :
                                'badge-cancelado';

                const fotoHtml = os.foto_url
                    ? `<img src="${os.foto_url}" class="img-thumbnail-modern" onclick="window.open('${os.foto_url}')">`
                    : `<div class="d-flex align-items-center justify-content-center bg-light" style="width:70px;height:70px;border-radius:0.75rem;"><i class="fa-solid fa-image text-muted"></i></div>`;

                return `
                    <tr class="fade-in">
                        <td>${fotoHtml}</td>
                        <td>
                            <div class="fw-semibold">${os.nome}</div>
                            <div class="text-muted small">${os.whatsapp}</div>
                        </td>
                        <td>
                            <span class="badge badge-modern" style="background: var(--primary); color: white;">${os.veiculo}</span>
                        </td>
                        <td>
                            <div class="text-truncate" style="max-width: 200px;" title="${os.servico || os.observacoes}">${os.servico || os.observacoes || '-'}</div>
                        </td>
                        <td>
                            <span class="badge badge-modern ${statusClass}" onclick="proximoStatus('${os.id}', '${os.status}')" title="Clique para mudar status">${os.status}</span>
                        </td>
                        <td class="fw-bold">R$ ${parseFloat(os.valor).toFixed(2)}</td>
                        <td>
                            <div class="d-flex justify-content-center gap-2 flex-wrap">
                                <button class="btn-action-modern btn-action-pix" onclick='abrirPix(${JSON.stringify(os).replace(/'/g, "&apos;")})' title="Pagar com PIX"><i class="fa-solid fa-qrcode"></i></button>
                                <button class="btn-action-modern btn-action-whatsapp" onclick='enviarWhats(${JSON.stringify(os).replace(/'/g, "&apos;")})' title="WhatsApp"><i class="fa-brands fa-whatsapp"></i></button>
                                <button class="btn-action-modern btn-action-orcamento" onclick="gerarOrcamento('${os.id}')" title="Gerar Orçamento"><i class="fa-solid fa-file-invoice-dollar"></i></button>
                                <button class="btn-action-modern btn-os-cliente" onclick="imprimirOSCliente('${os.id}')" title="O.S. Cliente"><i class="fa-solid fa-file-pdf"></i></button>
                                <button class="btn-action-modern btn-os-interno" onclick="imprimirOSInterno('${os.id}')" title="O.S. Interno"><i class="fa-solid fa-file-invoice"></i></button>
                                <button class="btn-action-modern btn-action-edit" onclick="editarOS('${os.id}')" title="Editar"><i class="fa-solid fa-edit"></i></button>
                                <button class="btn-action-modern btn-action-delete" onclick="deletarOS('${os.id}')" title="Deletar"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Próximo Status (clicar no badge)
        async function proximoStatus(id, statusAtual) {
            const ordem = ['Pendente', 'Em Andamento', 'Pago', 'Cancelado'];
            let novoStatus = ordem[(ordem.indexOf(statusAtual) + 1) % ordem.length];

            const { error } = await supabaseClient.from('ordens_servico').update({ status: novoStatus }).eq('id', id);

            if (!error) {
                carregarOS();
                showNotify(`Status alterado para: ${novoStatus}`);
            }
        }

        // Busca
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const termo = e.target.value.toLowerCase();
            const filtrados = todasOS.filter(os =>
                os.nome.toLowerCase().includes(termo) ||
                os.veiculo.toLowerCase().includes(termo) ||
                (os.whatsapp && os.whatsapp.toLowerCase().includes(termo))
            );
            renderizarTabela(filtrados);
        });

        // Comprimir imagem
        async function comprimirImagem(arquivo) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(arquivo);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                        ctx.canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', 0.7);
                    };
                };
            });
        }

        // Cadastrar O.S.
        document.getElementById('formCadastro').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btnSalvar = document.getElementById('btnSalvar');

            // Dentro do seu submit de cadastro, adicione este efeito visual:
            btnSalvar.innerHTML = '<span class="spinner-grow spinner-grow-sm me-2"></span>ENVIANDO...';
            btnSalvar.style.letterSpacing = '2px';

            try {
                let fotoUrl = null;
                const fotoInput = document.getElementById('fotoInput');
                const fotoFile = fotoInput ? fotoInput.files[0] : null;

                // Trecho corrigido para evitar erro de bucket se não houver foto
                if (fotoFile) {
                    const fotoComprimida = await comprimirImagem(fotoFile);
                    const fileName = `${Date.now()}_os.jpg`;

                    // O erro acontece aqui se o bucket 'fotos_os' não existir no painel
                    const { data: uploadData, error: uploadError } = await supabaseClient.storage
                        .from('fotos_os')
                        .upload(fileName, fotoComprimida);

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabaseClient.storage.from('fotos_os').getPublicUrl(fileName);
                    fotoUrl = urlData.publicUrl;
                }

                // Localize o evento de submit do formCadastro e ajuste esta parte:
                const servicosSelecionados = Array.from(document.querySelectorAll('#listaPecas .badge-concluido'))
                    .map(badge => badge.innerText.replace(/ \(\+R\$ .*\)/, '').trim());

                const dados = {
                    nome: document.getElementById('nome').value,
                    whatsapp: document.getElementById('whatsapp').value,
                    veiculo: document.getElementById('veiculo').value.toUpperCase(),
                    // Concatena o que foi digitado com os serviços selecionados do catálogo
                    servico: (document.getElementById('observacoes').value + " " + servicosSelecionados.join(', ')).trim(),
                    valor: parseFloat(document.getElementById('valor').value) || 0,
                    status: document.getElementById('status').value,
                    observacoes: document.getElementById('observacoes').value,
                    foto_url: fotoUrl
                };

                const { error } = await supabaseClient.from('ordens_servico').insert([dados]);
                if (error) throw error;

                showNotify('Ordem de Serviço salva com sucesso!');
                document.getElementById('formCadastro').reset();
                pecasSelecionadas = [];
                document.getElementById('listaPecas').innerHTML = '';
                bootstrap.Modal.getInstance(document.getElementById('modalCadastro')).hide();
                await carregarOS();

            } catch (err) {
                console.error("Erro no salvamento:", err);
                showNotify('Erro na operação: ' + err.message, 'error');
            } finally {
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = '<i class="fa-solid fa-save me-2"></i>Salvar O.S.';
            }
        });

        // Editar O.S.
        async function editarOS(id) {
            const { data } = await supabaseClient.from('ordens_servico').select('*').eq('id', id).single();

            if (data) {
                document.getElementById('editId').value = data.id;
                document.getElementById('editNome').value = data.nome;
                document.getElementById('editWhatsapp').value = data.whatsapp;
                document.getElementById('editVeiculo').value = data.veiculo;
                document.getElementById('editObservacoes').value = data.observacoes || data.servico;
                document.getElementById('editStatus').value = data.status;
                document.getElementById('editValor').value = data.valor;

                // Limpa a lista de badges antes de abrir para não acumular
                document.getElementById('listaPecasEdit').innerHTML = '';

                // Recarrega os produtos no select de edição
                carregarProdutosNoSelect('selectProdutoEdit');

                new bootstrap.Modal(document.getElementById('modalEdicao')).show();
            }
        }

        // Salvar edição
        document.getElementById('formEdicao').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('editId').value;
            const dadosAtualizados = {
                nome: document.getElementById('editNome').value,
                whatsapp: document.getElementById('editWhatsapp').value,
                veiculo: document.getElementById('editVeiculo').value.toUpperCase(),
                servico: document.getElementById('editObservacoes').value,
                observacoes: document.getElementById('editObservacoes').value,
                status: document.getElementById('editStatus').value,
                valor: parseFloat(document.getElementById('editValor').value)
            };

            const { error } = await supabaseClient.from('ordens_servico').update(dadosAtualizados).eq('id', id);

            if (error) {
                showNotify('Erro ao atualizar O.S.', 'error');
            } else {
                showNotify('O.S. atualizada com sucesso!');
                bootstrap.Modal.getInstance(document.getElementById('modalEdicao')).hide();
                carregarOS();
            }
        });

        // Deletar O.S.
        async function deletarOS(id) {
            if (confirm('Deseja realmente excluir esta O.S.?')) {
                const { error } = await supabaseClient.from('ordens_servico').delete().eq('id', id);

                if (error) {
                    showNotify('Erro ao excluir O.S.', 'error');
                } else {
                    showNotify('O.S. excluída com sucesso!');
                    carregarOS();
                }
            }
        }

        // WhatsApp
        function enviarWhats(os) {
            const msg = `Olá ${os.nome}, sua Ordem de Serviço na MELÃO RODAS foi registrada!\n\n🚗 Veículo: ${os.veiculo}\n🛠️ Serviço: ${os.servico}\n💰 Valor: R$ ${os.valor.toFixed(2)}\n\nObrigado pela preferência!`;
            const fone = os.whatsapp.replace(/\D/g, '');
            window.open(`https://api.whatsapp.com/send?phone=55${fone}&text=${encodeURIComponent(msg)}`);
        }

        // PIX
        function abrirPix(os) {
            document.getElementById('pixDetails').innerHTML = `<strong>${os.nome}</strong> - R$ ${os.valor.toFixed(2)}`;

            const pixKey = "sua-chave-pix@exemplo.com"; // ALTERE PARA SUA CHAVE PIX
            const pixCode = `00020126580014br.gov.bcb.pix0136${pixKey}52040000530398654${os.valor.toFixed(2)}5802BR5925MELAORODAS6009SAO PAULO62070503***6304`;

            document.getElementById('pixCopiaCola').value = pixCode;

            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), {
                text: pixCode,
                width: 200,
                height: 200
            });

            document.getElementById('btnEnviarPixWhats').onclick = () => {
                const msg = `💳 *PIX PARA PAGAMENTO*\n\nOlá ${os.nome}!\n\nValor: R$ ${os.valor.toFixed(2)}\n\nChave PIX:\n${pixKey}\n\nCódigo Copia e Cola:\n${pixCode}`;
                const fone = os.whatsapp.replace(/\D/g, '');
                window.open(`https://api.whatsapp.com/send?phone=55${fone}&text=${encodeURIComponent(msg)}`);
            };

            new bootstrap.Modal(document.getElementById('modalPix')).show();
        }

        function copiarPix() {
            const pixInput = document.getElementById('pixCopiaCola');
            pixInput.select();
            document.execCommand('copy');
            showNotify('Código PIX copiado!');
        }

        // Imprimir O.S. Cliente (Melhorado e Profissional)
        async function imprimirOSCliente(id) {
            showNotify('Preparando documento com os dados da empresa...', 'success');
            const { data: os } = await supabaseClient.from('ordens_servico').select('*').eq('id', id).single();
            if (!os) return;

            // Carregar configurações da empresa
            // Dentro de imprimirOSCliente ou gerarOrcamento
            const empresa = await obterDadosEmpresa();

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Cabeçalho (Exemplo O.S. Cliente)
            doc.setFillColor(30, 58, 138);
            doc.rect(0, 0, 210, 45, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.text(empresa.nome.toUpperCase(), 105, 20, { align: 'center' }); // DADO DINÂMICO
            doc.setFontSize(10);
            doc.text(`CNPJ: ${empresa.cnpj} | Tel: ${empresa.tel}`, 105, 35, { align: 'center' }); // DADO DINÂMICO
            doc.text(empresa.end, 105, 40, { align: 'center' }); // DADO DINÂMICO
            // Título do Documento
            doc.setTextColor(0, 0, 0);
            doc.setFillColor(243, 244, 246);
            doc.rect(15, 52, 180, 12, 'F');
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('ORDEM DE SERVIÇO', 105, 60, { align: 'center' });

            // Número da OS
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text(`OS Nº: ${os.id.substring(0, 8).toUpperCase()}`, 15, 72);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text(`Data de Emissão: ${new Date(os.created_at).toLocaleDateString('pt-BR')}`, 140, 72);

            // Localize onde você adicionou o texto do atendente e use estas coordenadas:
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`ATENDENTE: ${atendenteLogado || 'SISTEMA'}`, 15, 272); // Y=272 fica logo acima do rodapé final

            // Dados do Cliente
            let yPos = 82;
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos - 5, 180, 37, 'F');

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('DADOS DO CLIENTE', 20, yPos);
            yPos += 8;

            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text('Nome:', 20, yPos);
            doc.text(os.nome, 50, yPos);
            yPos += 7;

            doc.text('Contato:', 20, yPos);
            doc.text(os.whatsapp, 50, yPos);
            yPos += 7;

            doc.text('Veículo:', 20, yPos);
            doc.text(os.veiculo, 50, yPos);
            yPos += 7;

            doc.text('Atendente Responsável:', 20, yPos);
            doc.text(atendenteLogado || 'Sistema', 75, yPos);

            // Serviços Realizados
            yPos += 15;
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos - 5, 180, 10, 'F');
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('SERVIÇOS REALIZADOS', 20, yPos);
            yPos += 8;

            // Tabela de Serviços
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);

            // Dividir serviços por vírgula ou ponto e vírgula
            const servicos = (os.servico || os.observacoes || 'Serviço Geral').split(/[,;]/).map(s => s.trim()).filter(s => s);

            // Cabeçalho da tabela
            doc.setFillColor(230, 230, 230);
            doc.rect(15, yPos - 3, 180, 8, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('Descrição do Serviço/Produto', 18, yPos + 2);
            doc.text('Valor Unit.', 155, yPos + 2);
            yPos += 10;

            // Linhas de serviços
            doc.setFont(undefined, 'normal');
            let subtotal = 0;

            if (servicos.length > 1) {
                // Se tem múltiplos serviços, divide o valor
                const valorPorItem = parseFloat(os.valor) / servicos.length;
                servicos.forEach((servico, idx) => {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 30;
                    }

                    const servicoWrapped = doc.splitTextToSize(servico, 130);
                    doc.text(servicoWrapped, 18, yPos);
                    doc.text(`R$ ${valorPorItem.toFixed(2)}`, 155, yPos);
                    yPos += (servicoWrapped.length * 5) + 3;
                    subtotal += valorPorItem;

                    // Linha divisória
                    doc.setDrawColor(220, 220, 220);
                    doc.line(15, yPos, 195, yPos);
                    yPos += 3;
                });
            } else {
                // Serviço único
                const servicoWrapped = doc.splitTextToSize(servicos[0], 130);
                doc.text(servicoWrapped, 18, yPos);
                doc.text(`R$ ${parseFloat(os.valor).toFixed(2)}`, 155, yPos);
                yPos += (servicoWrapped.length * 5) + 3;
                subtotal = parseFloat(os.valor);
            }

            // Total
            yPos += 5;
            doc.setFillColor(59, 130, 246);
            doc.rect(15, yPos - 5, 180, 15, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(`VALOR TOTAL: R$ ${parseFloat(os.valor).toFixed(2)}`, 105, yPos + 5, { align: 'center' });
            doc.setTextColor(0, 0, 0);

            // Status do Pagamento
            yPos += 20;
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text(`Status: ${os.status}`, 20, yPos);

            // Informações Legais e Políticas da Loja
            yPos += 15;
            doc.setFillColor(250, 250, 250);
            doc.rect(15, yPos - 5, 180, 50, 'F');

            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            doc.text('TERMOS E CONDIÇÕES - CÓDIGO DE DEFESA DO CONSUMIDOR', 20, yPos);
            yPos += 5;

            doc.setFont(undefined, 'normal');
            doc.setFontSize(7);

            const termos = [
                '• Art. 26 CDC: O direito de reclamar por vícios aparentes ou de fácil constatação caduca em 30 dias para serviços.',
                '• Art. 18 CDC: Os serviços possuem garantia legal de 90 dias. Vícios ocultos devem ser reportados dentro deste prazo.',
                '• Garantia válida apenas para defeitos de execução. Não cobre mau uso, desgaste natural ou danos externos.',
                '• Peças substituídas têm garantia do fabricante. Consulte-nos para mais detalhes.',
                '• Prazo de validade deste orçamento: 15 dias corridos a partir da data de emissão.',
                '• O veículo permanecerá sob nossa responsabilidade durante a execução do serviço contratado.',
                '• Em caso de dúvidas ou reclamações, entre em contato conosco antes de acionar órgãos de defesa do consumidor.'
            ];

            termos.forEach(termo => {
                const termoLines = doc.splitTextToSize(termo, 170);
                doc.text(termoLines, 20, yPos);
                yPos += termoLines.length * 3.5;
            });

            // Posicionamento no rodapé, acima da linha de assinatura
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.setFont(undefined, 'bold');
            doc.text(`ATENDENTE RESPONSÁVEL: ${atendenteLogado || 'SISTEMA'}`, 15, 265);

            // Assinatura
            yPos += 8;
            doc.setDrawColor(100, 100, 100);
            doc.line(20, yPos, 90, yPos);
            doc.line(120, yPos, 190, yPos);
            yPos += 5;
            doc.setFontSize(8);
            doc.text('Assinatura do Cliente', 20, yPos);
            doc.text('Assinatura do Responsável', 120, yPos);

            // Rodapé
            doc.setFontSize(7);
            doc.setTextColor(120, 120, 120);
            doc.text('Este documento é uma via do cliente. Guarde-o para garantia e referência futura.', 105, 285, { align: 'center' });

            doc.save(`OS_Cliente_${os.id.substring(0, 8)}.pdf`);
            showNotify('Ordem de Serviço gerada com sucesso!', 'success');
        }

        // Imprimir O.S. Interno
        async function imprimirOSInterno(id) {
            showNotify('Preparando documento com os dados da empresa...', 'success');
            const { data: os } = await supabaseClient.from('ordens_servico').select('*').eq('id', id).single();
            if (!os) return;

            // Carregar configurações da empresa
            const { data: config } = await supabaseClient.from('configuracoes').select('*').limit(1).single();
            const nomeEmpresa = config?.nome_empresa || 'MELÃO RODAS';

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Cabeçalho Interno (cor diferente)
            doc.setFillColor(139, 92, 246);
            doc.rect(0, 0, 210, 45, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(26);
            doc.setFont(undefined, 'bold');
            doc.text(nomeEmpresa.toUpperCase(), 105, 20, { align: 'center' });

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('ORDEM DE SERVIÇO - USO INTERNO', 105, 28, { align: 'center' });
            doc.text('DOCUMENTO CONFIDENCIAL', 105, 35, { align: 'center' });

            // Título do Documento
            doc.setTextColor(0, 0, 0);
            doc.setFillColor(243, 244, 246);
            doc.rect(15, 52, 180, 12, 'F');
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('CONTROLE INTERNO', 105, 60, { align: 'center' });

            // Número da OS
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text(`OS ID: ${os.id}`, 15, 72);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text(`Data: ${new Date(os.created_at).toLocaleDateString('pt-BR')}`, 140, 72);

            // Dados do Cliente
            let yPos = 82;
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos - 5, 180, 37, 'F');

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('DADOS DO CLIENTE', 20, yPos);
            yPos += 8;

            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text('Nome:', 20, yPos);
            doc.text(os.nome, 50, yPos);
            yPos += 7;

            doc.text('Contato:', 20, yPos);
            doc.text(os.whatsapp, 50, yPos);
            yPos += 7;

            doc.text('Veículo:', 20, yPos);
            doc.text(os.veiculo, 50, yPos);
            yPos += 7;

            doc.text('Atendente Responsável:', 20, yPos);
            doc.text(atendenteLogado || 'Sistema', 75, yPos);

            // Serviços Realizados
            yPos += 15;
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos - 5, 180, 10, 'F');
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('SERVIÇOS REALIZADOS', 20, yPos);
            yPos += 8;

            // Tabela de Serviços
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);

            const servicos = (os.servico || os.observacoes || 'Serviço Geral').split(/[,;]/).map(s => s.trim()).filter(s => s);

            // Cabeçalho da tabela
            doc.setFillColor(230, 230, 230);
            doc.rect(15, yPos - 3, 180, 8, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('Descrição do Serviço/Produto', 18, yPos + 2);
            doc.text('Valor Unit.', 155, yPos + 2);
            yPos += 10;

            // Linhas de serviços
            doc.setFont(undefined, 'normal');
            if (servicos.length > 1) {
                const valorPorItem = parseFloat(os.valor) / servicos.length;
                servicos.forEach((servico) => {
                    const servicoWrapped = doc.splitTextToSize(servico, 130);
                    doc.text(servicoWrapped, 18, yPos);
                    doc.text(`R$ ${valorPorItem.toFixed(2)}`, 155, yPos);
                    yPos += (servicoWrapped.length * 5) + 3;
                    doc.setDrawColor(220, 220, 220);
                    doc.line(15, yPos, 195, yPos);
                    yPos += 3;
                });
            } else {
                const servicoWrapped = doc.splitTextToSize(servicos[0], 130);
                doc.text(servicoWrapped, 18, yPos);
                doc.text(`R$ ${parseFloat(os.valor).toFixed(2)}`, 155, yPos);
                yPos += (servicoWrapped.length * 5) + 3;
            }

            // Status e Informações Internas
            yPos += 5;
            doc.setFillColor(250, 250, 250);
            doc.rect(15, yPos - 5, 180, 25, 'F');

            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('STATUS INTERNO', 20, yPos);
            yPos += 7;

            doc.setFont(undefined, 'normal');
            doc.text(`Status do Pagamento: ${os.status}`, 20, yPos);
            yPos += 6;
            doc.text(`Data de Cadastro: ${new Date(os.created_at).toLocaleString('pt-BR')}`, 20, yPos);

            // Total
            yPos += 15;
            doc.setFillColor(139, 92, 246);
            doc.rect(15, yPos - 5, 180, 15, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(`VALOR TOTAL: R$ ${parseFloat(os.valor).toFixed(2)}`, 105, yPos + 5, { align: 'center' });
            doc.setTextColor(0, 0, 0);

            // Rodapé
            doc.setFontSize(7);
            doc.setTextColor(120, 120, 120);
            doc.text('DOCUMENTO DE USO INTERNO - CONFIDENCIAL - NÃO ENTREGAR AO CLIENTE', 105, 285, { align: 'center' });

            doc.save(`OS_Interno_${os.id.substring(0, 8)}.pdf`);
            showNotify('O.S. interna gerada com sucesso!', 'success');
        }

        // Gerar Orçamento Profissional
        async function gerarOrcamento(id) {
            showNotify('Preparando documento com os dados da empresa...', 'success');
            const { data: os } = await supabaseClient.from('ordens_servico').select('*').eq('id', id).single();
            if (!os) return;

            // Carregar configurações da empresa
            const { data: config } = await supabaseClient.from('configuracoes').select('*').limit(1).single();
            const nomeEmpresa = config?.nome_empresa || 'MELÃO RODAS';
            const cnpj = config?.cnpj || '00.000.000/0001-00';
            const telefone = config?.telefone || '(00) 0000-0000';
            const endereco = config?.endereco || 'Endereço não cadastrado';

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Cabeçalho Verde (cor de dinheiro/orçamento)
            doc.setFillColor(16, 185, 129); // verde
            doc.rect(0, 0, 210, 45, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(26);
            doc.setFont(undefined, 'bold');
            doc.text(nomeEmpresa.toUpperCase(), 105, 20, { align: 'center' });

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Centro Automotivo Especializado', 105, 28, { align: 'center' });
            doc.text(`CNPJ: ${cnpj} | Tel: ${telefone}`, 105, 35, { align: 'center' });
            doc.text(endereco, 105, 40, { align: 'center' });

            // Título ORÇAMENTO
            doc.setTextColor(0, 0, 0);
            doc.setFillColor(243, 244, 246);
            doc.rect(15, 52, 180, 12, 'F');
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('ORÇAMENTO', 105, 60, { align: 'center' });

            // Número do Orçamento
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text(`Orçamento Nº: ${os.id.substring(0, 8).toUpperCase()}`, 15, 72);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 140, 72);
            doc.text(`Validade: 15 dias`, 140, 78);

            doc.setFontSize(9);
            doc.text(`CONSULTOR TÉCNICO: ${atendenteLogado || 'SISTEMA'}`, 15, 260);

            // Dados do Cliente
            let yPos = 88;
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos - 5, 180, 37, 'F');

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('DADOS DO CLIENTE', 20, yPos);
            yPos += 8;

            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text('Nome:', 20, yPos);
            doc.text(os.nome, 50, yPos);
            yPos += 7;

            doc.text('Contato:', 20, yPos);
            doc.text(os.whatsapp, 50, yPos);
            yPos += 7;

            doc.text('Veículo:', 20, yPos);
            doc.text(os.veiculo, 50, yPos);
            yPos += 7;

            doc.text('Atendente Responsável:', 20, yPos);
            doc.text(atendenteLogado || 'Sistema', 75, yPos);

            // Serviços Orçados
            yPos += 15;
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos - 5, 180, 10, 'F');
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('SERVIÇOS E PRODUTOS ORÇADOS', 20, yPos);
            yPos += 8;

            // Tabela de Serviços
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);

            const servicos = (os.servico || os.observacoes || 'Serviço a definir').split(/[,;]/).map(s => s.trim()).filter(s => s);

            // Cabeçalho da tabela
            doc.setFillColor(16, 185, 129);
            doc.rect(15, yPos - 3, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text('Descrição', 18, yPos + 2);
            doc.text('Valor Unit.', 155, yPos + 2);
            doc.setTextColor(0, 0, 0);
            yPos += 10;

            // Linhas de serviços
            doc.setFont(undefined, 'normal');
            let subtotal = 0;

            if (servicos.length > 1) {
                const valorPorItem = parseFloat(os.valor) / servicos.length;
                servicos.forEach((servico) => {
                    const servicoWrapped = doc.splitTextToSize(servico, 130);
                    doc.text(servicoWrapped, 18, yPos);
                    doc.text(`R$ ${valorPorItem.toFixed(2)}`, 155, yPos);
                    yPos += (servicoWrapped.length * 5) + 3;
                    subtotal += valorPorItem;
                    doc.setDrawColor(220, 220, 220);
                    doc.line(15, yPos, 195, yPos);
                    yPos += 3;
                });
            } else {
                const servicoWrapped = doc.splitTextToSize(servicos[0], 130);
                doc.text(servicoWrapped, 18, yPos);
                doc.text(`R$ ${parseFloat(os.valor).toFixed(2)}`, 155, yPos);
                yPos += (servicoWrapped.length * 5) + 3;
                subtotal = parseFloat(os.valor);
            }

            // Observações do Orçamento
            yPos += 5;
            doc.setFillColor(255, 251, 235);
            doc.rect(15, yPos - 5, 180, 20, 'F');
            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            doc.text('OBSERVAÇÕES IMPORTANTES:', 20, yPos);
            yPos += 5;
            doc.setFont(undefined, 'normal');
            doc.text('• Este orçamento tem validade de 15 dias corridos a partir da data de emissão.', 20, yPos);
            yPos += 4;
            doc.text('• Os valores podem sofrer alterações conforme disponibilidade de peças e mão de obra.', 20, yPos);
            yPos += 4;
            doc.text('• Após aprovação, será gerado um documento formal de ordem de serviço.', 20, yPos);

            // Total com destaque
            yPos += 15;
            doc.setFillColor(16, 185, 129);
            doc.rect(15, yPos - 5, 180, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(`VALOR TOTAL ESTIMADO: R$ ${parseFloat(os.valor).toFixed(2)}`, 105, yPos + 6, { align: 'center' });
            doc.setTextColor(0, 0, 0);

            // Termos de aceitação
            yPos += 30;
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('ACEITE DO CLIENTE', 20, yPos);
            yPos += 8;

            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
            doc.text('Declaro estar ciente dos serviços orçados e seus respectivos valores.', 20, yPos);
            yPos += 10;

            // Linhas de assinatura
            doc.setDrawColor(100, 100, 100);
            doc.line(20, yPos, 90, yPos);
            doc.line(120, yPos, 190, yPos);
            yPos += 5;
            doc.setFontSize(8);
            doc.text('Assinatura do Cliente', 35, yPos);
            doc.text(`Data: ___/___/___`, 140, yPos);

            // Rodapé
            doc.setFontSize(7);
            doc.setTextColor(120, 120, 120);
            doc.text('Este é um orçamento sem compromisso. Entre em contato para mais informações.', 105, 285, { align: 'center' });

            doc.save(`Orcamento_${os.id.substring(0, 8)}.pdf`);
            // Posicionamento para Orçamento (Logo abaixo dos termos)
            doc.setFontSize(8);
            doc.setTextColor(0, 0, 0);
            doc.text(`Consultor Técnico: ${atendenteLogado || 'Vendedor Padrão'}`, 15, 270);

            showNotify('Orçamento gerado com sucesso!', 'success');
        }

        // Produtos
        async function carregarProdutos() {
            const { data } = await supabaseClient.from('produtos').select('*').gt('estoque', 0);
            const selects = ['selectProduto', 'selectProdutoEdit'];

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select && data) {
                    select.innerHTML = '<option value="">Selecione um produto...</option>';
                    data.forEach(prod => {
                        select.innerHTML += `<option value="${prod.id}" data-preco="${prod.preco_venda}" data-nome="${prod.nome}">
                            ${prod.nome} - R$ ${prod.preco_venda.toFixed(2)}
                        </option>`;
                    });
                }
            });
        }

        async function carregarProdutosNoSelect(idSelect) {
            const { data } = await supabaseClient.from('produtos').select('*').gt('estoque', 0);
            const select = document.getElementById(idSelect);
            if (select && data) {
                select.innerHTML = '<option value="">Selecione um produto...</option>';
                data.forEach(prod => {
                    select.innerHTML += `<option value="${prod.id}" data-preco="${prod.preco_venda}" data-nome="${prod.nome}">
                        ${prod.nome} - R$ ${prod.preco_venda.toFixed(2)}
                    </option>`;
                });
            }
        }

        // Adicionar produto ao cadastro
        // Configura o evento para quando você selecionar um PRODUTO (Estoque)
        // Localize o evento de change do selectProduto (por volta da linha 1170)
        const selectProd = document.getElementById('selectProduto');
        if (selectProd) {
            selectProd.addEventListener('change', function () {
                if (!this.value) return;

                const selectedOption = this.options[this.selectedIndex];
                const nomeProduto = selectedOption.dataset.nome;
                const precoProduto = parseFloat(selectedOption.dataset.preco) || 0;

                // 1. Atualiza o valor total
                const campoValor = document.getElementById('valor');
                if (campoValor) {
                    const valorAtual = parseFloat(campoValor.value) || 0;
                    campoValor.value = (valorAtual + precoProduto).toFixed(2);
                }

                // 2. ADICIONADO: Sincroniza com o campo de Observações
                const campoObs = document.getElementById('observacoes');
                if (campoObs) {
                    const prefixo = campoObs.value ? ", " : "";
                    campoObs.value += prefixo + nomeProduto;
                }

                // 3. Cria o badge visual
                const lista = document.getElementById('listaPecas');
                if (lista) {
                    const badge = document.createElement('span');
                    badge.className = 'badge badge-modern bg-primary text-white position-relative pe-4 me-2 mb-2';
                    badge.dataset.preco = precoProduto;
                    badge.dataset.nome = nomeProduto;
                    badge.dataset.tipo = 'produto';
                    badge.innerHTML = `
                        <i class="fa-solid fa-box me-1"></i> ${nomeProduto} (+R$ ${precoProduto.toFixed(2)})
                        <button type="button" class="btn-close btn-close-white position-absolute top-50 end-0 translate-middle-y me-1" 
                            style="font-size: 0.6rem;" onclick="removerItemLista(this)"></button>
                    `;
                    lista.appendChild(badge);
                }
                this.value = '';
            });
        }

        // Adicionar produto à edição
        document.getElementById('selectProdutoEdit').addEventListener('change', function () {
            if (!this.value) return;

            const nome = this.options[this.selectedIndex].dataset.nome;
            const preco = parseFloat(this.options[this.selectedIndex].dataset.preco);

            const valorAtual = parseFloat(document.getElementById('editValor').value) || 0;
            document.getElementById('editValor').value = (valorAtual + preco).toFixed(2);

            const lista = document.getElementById('listaPecasEdit');
            const badge = document.createElement('span');
            badge.className = 'badge badge-modern badge-andamento position-relative pe-4';
            badge.style.cursor = 'pointer';
            badge.dataset.preco = preco;
            badge.dataset.nome = nome;
            badge.dataset.tipo = 'produto';
            badge.innerHTML = `
                <i class="fa-solid fa-box me-1"></i> ${nome} (+R$ ${preco.toFixed(2)})
                <button type="button" class="btn-close btn-close-white position-absolute top-50 end-0 translate-middle-y me-1" 
                    style="font-size: 0.6rem;" onclick="removerItemLista(this)"></button>
            `;
            lista.appendChild(badge);

            this.value = '';
        });

        // Configura o evento para quando selecionar um PRODUTO no Modal de EDICAO
        const selectProdEdit = document.getElementById('selectProdutoEdit');
        if (selectProdEdit) {
            selectProdEdit.addEventListener('change', function () {
                if (!this.value) return;

                const selectedOption = this.options[this.selectedIndex];
                const nomeProduto = selectedOption.dataset.nome;
                const precoProduto = parseFloat(selectedOption.dataset.preco) || 0;

                // 1. Soma ao Valor de Edição
                const campoValor = document.getElementById('editValor');
                if (campoValor) {
                    const valorAtual = parseFloat(campoValor.value) || 0;
                    campoValor.value = (valorAtual + precoProduto).toFixed(2);
                }

                // 2. Adiciona o Badge visual na lista de edição
                const lista = document.getElementById('listaPecasEdit');
                if (lista) {
                    const badge = document.createElement('span');
                    badge.className = 'badge badge-modern bg-primary text-white position-relative pe-4 me-2 mb-2';
                    badge.dataset.preco = precoProduto;
                    badge.dataset.nome = nomeProduto;
                    badge.dataset.tipo = 'produto';
                    badge.innerHTML = `
                <i class="fa-solid fa-box me-1"></i> ${nomeProduto} (+R$ ${precoProduto.toFixed(2)})
                <button type="button" class="btn-close btn-close-white position-absolute top-50 end-0 translate-middle-y me-1" 
                    style="font-size: 0.6rem;" onclick="removerItemLista(this)"></button>
            `;
                    lista.appendChild(badge);
                }
                this.value = '';
            });
        }

        // Estoque
        document.getElementById('estoqueForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const dadosProd = {
                nome: document.getElementById('prodNome').value,
                preco_custo: parseFloat(document.getElementById('prodCusto').value),
                preco_venda: parseFloat(document.getElementById('prodVenda').value),
                estoque: parseInt(document.getElementById('prodQtd').value)
            };

            const { error } = await supabaseClient.from('produtos').insert([dadosProd]);

            if (error) {
                showNotify('Erro ao cadastrar produto', 'error');
            } else {
                showNotify('Produto adicionado com sucesso!');
                document.getElementById('estoqueForm').reset();
                listarProdutosEstoque();
                carregarProdutos();
            }
        });

        document.getElementById('modalEstoque').addEventListener('shown.bs.modal', listarProdutosEstoque);

        async function listarProdutosEstoque() {
            const { data, error } = await supabaseClient.from('produtos').select('*').order('nome', { ascending: true });
            const tbody = document.getElementById('corpoTabelaEstoque');
            tbody.innerHTML = '';

            if (error) return showNotify("Erro ao carregar estoque", "error");

            data.forEach(prod => {
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-semibold">${prod.nome}</td>
                        <td class="text-muted">R$ ${prod.preco_custo.toFixed(2)}</td>
                        <td class="text-success fw-bold">R$ ${prod.preco_venda.toFixed(2)}</td>
                        <td class="text-center">
                            <span class="badge badge-modern ${prod.estoque < 3 ? 'badge-pendente' : 'badge-concluido'}">
                                ${prod.estoque}
                            </span>
                        </td>
                        <td class="text-end">
                            <button onclick="ajustarEstoque('${prod.id}', 1)" class="btn btn-sm btn-outline-success me-1" title="Entrada (+1)">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                            <button onclick="ajustarEstoque('${prod.id}', -1)" class="btn btn-sm btn-outline-danger me-1" title="Saída (-1)">
                                <i class="fa-solid fa-minus"></i>
                            </button>
                            <button onclick="deletarProduto('${prod.id}')" class="btn btn-sm btn-outline-danger" title="Deletar">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        async function ajustarEstoque(id, qtd) {
            const { data: prod } = await supabaseClient.from('produtos').select('estoque').eq('id', id).single();
            const novaQtd = (prod.estoque || 0) + qtd;

            if (novaQtd < 0) return showNotify("Estoque não pode ser negativo!", "error");

            const { error } = await supabaseClient.from('produtos').update({ estoque: novaQtd }).eq('id', id);

            if (!error) {
                listarProdutosEstoque();
                carregarProdutos();
            }
        }

        async function deletarProduto(id) {
            if (confirm("Deseja remover este produto permanentemente do estoque?")) {
                const { error } = await supabaseClient.from('produtos').delete().eq('id', id);
                if (!error) {
                    showNotify("Produto removido!");
                    listarProdutosEstoque();
                }
            }
        }

        // Gráfico
        let meuGrafico = null;

        async function renderizarGraficoVendas() {
            const contagemServicos = {};

            todasOS.forEach(os => {
                const servico = os.servico || 'Serviço Geral';
                contagemServicos[servico] = (contagemServicos[servico] || 0) + 1;
            });

            const labels = Object.keys(contagemServicos).slice(0, 5);
            const valores = Object.values(contagemServicos).slice(0, 5);

            const ctx = document.getElementById('graficoVendas').getContext('2d');

            if (meuGrafico) meuGrafico.destroy();

            meuGrafico = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantidade Realizada',
                        data: valores,
                        backgroundColor: '#3b82f6',
                        borderRadius: 10,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false } }
                    }
                }
            });

        }

        async function processarBaixaEstoque(pecas) {
            for (const peca of pecas) {
                // Busca a quantidade atual
                const { data: prod } = await supabaseClient
                    .from('produtos')
                    .select('estoque, nome')
                    .eq('nome', peca.nome)
                    .single();

                if (prod && prod.estoque > 0) {
                    const novaQtd = prod.estoque - 1;
                    await supabaseClient
                        .from('produtos')
                        .update({ estoque: novaQtd })
                        .eq('nome', peca.nome);

                    if (novaQtd <= 2) { // Alerta de estoque baixo
                        showNotify(`Alerta: Estoque crítico de ${prod.nome}!`, 'error');
                    }
                }
            }
        }

        // Localize a função atualizarDashboard e substitua por esta:
        // Procure a sua função atualizarDashboard e ajuste para ficar assim:
        async function atualizarDashboard() { // Adicione 'async' aqui se não tiver
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;

            let dadosFiltrados = todasOS;

            if (dataInicio && dataFim) {
                dadosFiltrados = todasOS.filter(os => {
                    const dataCriacao = new Date(os.created_at).toISOString().split('T')[0];
                    return dataCriacao >= dataInicio && dataCriacao <= dataFim;
                });
            }

            const pago = dadosFiltrados.filter(os => os.status === 'Pago').reduce((acc, os) => acc + (os.valor || 0), 0);
            const pendente = dadosFiltrados.filter(os => os.status === 'Pendente').reduce((acc, os) => acc + (os.valor || 0), 0);
            const andamento = dadosFiltrados.filter(os => os.status === 'Em Andamento').reduce((acc, os) => acc + (os.valor || 0), 0);
            const total = pago + pendente + andamento;

            document.getElementById('dashPago').innerText = pago.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            document.getElementById('dashPendente').innerText = pendente.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            document.getElementById('dashAndamento').innerText = andamento.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            document.getElementById('dashTotal').innerText = total.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });

            // ======================================================
            // COLOQUE O CÓDIGO DE LUCRO E ESTOQUE EXATAMENTE AQUI:
            // ======================================================
            const { data: dataProdutos } = await supabaseClient.from('produtos').select('preco_custo, preco_venda, estoque, nome');

            if (dataProdutos && todasOS) {
                // 1. Valor Total em Estoque (Patrimonial)
                const valorEmEstoque = dataProdutos.reduce((acc, p) => acc + (p.preco_custo * p.estoque), 0);
                document.getElementById('dashEstoqueTotal').innerText = valorEmEstoque.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });

                // 2. Cálculo do Lucro Presumido
                const osPagas = dadosFiltrados.filter(os => os.status === 'Pago');
                let custoTotalPecasPagas = 0;
                let faturamentoTotalPago = osPagas.reduce((acc, os) => acc + (os.valor || 0), 0);

                osPagas.forEach(os => {
                    dataProdutos.forEach(prod => {
                        if (os.servico && os.servico.includes(prod.nome)) {
                            custoTotalPecasPagas += prod.preco_custo;
                        }
                    });
                });

                const lucroReal = faturamentoTotalPago - custoTotalPecasPagas;
                const campoLucro = document.getElementById('dashLucro');
                if (campoLucro) {
                    campoLucro.innerText = lucroReal.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
                }
            }
            // ======================================================
            // FIM DO BLOCO INSERIDO
        }


        // 1. Primeiro defina a função que o atalho vai chamar
        function abrirOSRapida() {
            // 1. Limpa o formulário (campos de texto, número e selects)
            document.getElementById('formCadastro').reset();

            // 2. Limpa especificamente o campo de arquivo (foto)
            const fotoInput = document.getElementById('fotoInput');
            if (fotoInput) fotoInput.value = "";

            // 3. Reseta o array de peças e a visualização na tela
            pecasSelecionadas = [];
            document.getElementById('listaPecas').innerHTML = '';
            pecasSelecionadas = [];
            popularSelectServicos();

            const modalCadastro = bootstrap.Modal.getOrCreateInstance(document.getElementById('modalCadastro'));
            modalCadastro.show();

            // 4. Define os valores padrão de segurança
            document.getElementById('status').value = 'Pendente';
            document.getElementById('valor').value = '0';

            // 5. Abre o modal programaticamente
            const modalElement = document.getElementById('modalCadastro');
            modalCadastro.show();

            // 6. Foca no primeiro campo para agilizar a digitação
            setTimeout(() => {
                document.getElementById('nome').focus();
            }, 500);

        }

        // 2. ADICIONE O ATALHO AQUI (Final do Script)
        document.addEventListener('keydown', function (event) {
            // ALT + N abre Nova O.S.
            if (event.altKey && (event.key === 'n' || event.key === 'N')) {
                event.preventDefault();
                abrirOSRapida();
            }
        });

        // Carregar serviços no modal e no select de O.S.
        async function carregarCatalogoServicos() {
            const { data, error } = await supabaseClient.from('servicos_catalogo').select('*').order('nome');
            if (error) return;

            const tbody = document.getElementById('listaServicosCatalogo');
            tbody.innerHTML = data.map(s => `
                <tr id="linha-servico-${s.id}">
                    <td class="fw-semibold nome-servico">${s.nome}</td>
                    <td class="preco-servico">R$ ${parseFloat(s.preco_sugerido).toFixed(2)}</td>
                    <td class="text-end">
                        <button onclick="prepararEdicaoServico('${s.id}', '${s.nome}', ${s.preco_sugerido})" class="btn btn-sm btn-outline-warning me-1">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button onclick="deletarServicoCatalogo('${s.id}')" class="btn btn-sm btn-outline-danger">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Salvar novo serviço
        // Localize e substitua/adicione este bloco no seu <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('formServicoCatalogo');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const nomeInput = document.getElementById('servNome');
                    const precoInput = document.getElementById('servPreco');
                    const btnSubmit = e.target.querySelector('button[type="submit"]');

                    const nome = nomeInput.value.trim();
                    const preco = parseFloat(precoInput.value);

                    if (!nome || !preco || preco <= 0) {
                        showNotify("Preencha o nome e o preço corretamente!", "error");
                        return;
                    }

                    // Feedback visual de carregamento
                    btnSubmit.disabled = true;
                    btnSubmit.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

                    try {
                        const { error } = await supabaseClient
                            .from('servicos_catalogo')
                            .insert([{ nome, preco_sugerido: preco }]);

                        if (error) throw error;

                        showNotify("Serviço adicionado ao catálogo!");
                        nomeInput.value = '';
                        precoInput.value = '';

                        // Recarrega a lista na tabela e no select da O.S.
                        await carregarCatalogoServicos();
                        await popularSelectServicos();
                    } catch (err) {
                        console.error("Erro ao salvar serviço:", err);
                        showNotify("Erro ao salvar: " + err.message, "error");
                    } finally {
                        btnSubmit.disabled = false;
                        btnSubmit.innerHTML = '<i class="fa-solid fa-plus"></i>';
                    }
                });
            }
        });

        async function deletarServicoCatalogo(id) {
            if (confirm("Remover este serviço do catálogo?")) {
                await supabaseClient.from('servicos_catalogo').delete().eq('id', id);
                carregarCatalogoServicos();
            }
        }

        // Chamar ao carregar a página
        document.addEventListener('DOMContentLoaded', carregarCatalogoServicos);

        // ===== CONFIGURAÇÕES DA EMPRESA =====
        async function carregarConfiguracoes() {
            const { data } = await supabaseClient.from('configuracoes').select('*').limit(1).single();

            if (data) {
                document.getElementById('configNomeEmpresa').value = data.nome_empresa || '';
                document.getElementById('configCNPJ').value = data.cnpj || '';
                document.getElementById('configTelefone').value = data.telefone || '';
                document.getElementById('configEndereco').value = data.endereco || '';
            }
        }

        // ===== CONFIGURAÇÕES DA EMPRESA - SALVAR E CARREGAR =====

        async function carregarConfiguracoes() {
            try {
                const { data, error } = await supabaseClient
                    .from('configuracoes')
                    .select('*')
                    .limit(1)
                    .maybeSingle(); // Busca apenas um registro ou nulo

                if (error) throw error;

                if (data) {
                    document.getElementById('configNomeEmpresa').value = data.nome_empresa || '';
                    document.getElementById('configCNPJ').value = data.cnpj || '';
                    document.getElementById('configTelefone').value = data.telefone || '';
                    document.getElementById('configEndereco').value = data.endereco || '';
                    // Armazena o ID num atributo oculto para facilitar o update
                    document.getElementById('formConfiguracoes').dataset.id = data.id;
                }
            } catch (err) {
                console.error('Erro ao carregar configurações:', err);
            }
        }

        document.getElementById('formConfiguracoes').addEventListener('submit', async (e) => {
            e.preventDefault();

            const btnSalvar = e.target.querySelector('button[type="submit"]');
            btnSalvar.disabled = true;
            btnSalvar.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Salvando...';

            const configId = e.target.dataset.id; // Tenta pegar o ID carregado anteriormente
            const dadosConfig = {
                nome_empresa: document.getElementById('configNomeEmpresa').value,
                cnpj: document.getElementById('configCNPJ').value,
                telefone: document.getElementById('configTelefone').value,
                endereco: document.getElementById('configEndereco').value
            };

            try {
                let resultado;

                if (configId) {
                    // Se já tem ID, atualiza o registro existente
                    resultado = await supabaseClient
                        .from('configuracoes')
                        .update(dadosConfig)
                        .eq('id', configId);
                } else {
                    // Se não tem ID, insere o primeiro registro
                    resultado = await supabaseClient
                        .from('configuracoes')
                        .insert([dadosConfig])
                        .select();
                }

                if (resultado.error) throw resultado.error;

                showNotify('Configurações salvas com sucesso!', 'success');

                // Fecha o modal após 1 segundo
                setTimeout(() => {
                    const modalEl = document.getElementById('modalConfiguracoes');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                }, 1000);

                // Recarrega os dados para atualizar o dataset.id caso tenha sido um insert
                await carregarConfiguracoes();

            } catch (err) {
                console.error('Erro ao salvar configurações:', err);
                showNotify('Erro ao salvar: ' + err.message, 'error');
            } finally {
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = '<i class="fa-solid fa-save me-2"></i>Salvar Configurações';
            }
        });

        // Garante que as configurações sejam carregadas ao abrir o modal
        document.getElementById('modalConfiguracoes').addEventListener('show.bs.modal', carregarConfiguracoes);

        // Carregar configurações ao abrir o modal
        document.getElementById('modalConfiguracoes').addEventListener('show.bs.modal', carregarConfiguracoes);

        // ===== LISTA DE CLIENTES NO MODAL DE BUSCA =====
        function carregarListaClientes() {
            // Pega clientes únicos
            const clientesUnicos = {};
            todasOS.forEach(os => {
                if (!clientesUnicos[os.nome]) {
                    clientesUnicos[os.nome] = {
                        nome: os.nome,
                        whatsapp: os.whatsapp,
                        ultimaVisita: os.created_at
                    };
                } else {
                    // Atualiza se for mais recente
                    if (new Date(os.created_at) > new Date(clientesUnicos[os.nome].ultimaVisita)) {
                        clientesUnicos[os.nome].ultimaVisita = os.created_at;
                    }
                }
            });

            const clientes = Object.values(clientesUnicos).sort((a, b) =>
                new Date(b.ultimaVisita) - new Date(a.ultimaVisita)
            ).slice(0, 12); // Mostra os 12 mais recentes

            const grid = document.getElementById('gridClientes');
            grid.innerHTML = clientes.map(cliente => {
                // Escapar aspas no nome para não quebrar o HTML
                const nomeSeguro = cliente.nome.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                    <div class="col-md-4">
                        <div class="card-modern p-3" style="cursor: pointer;" onclick="buscarClientePorNome('${nomeSeguro}')">
                            <div class="d-flex align-items-center">
                                <div class="me-3" style="width: 45px; height: 45px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    ${cliente.nome.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-bold">${cliente.nome}</h6>
                                    <small class="text-muted">${cliente.whatsapp}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function buscarClientePorNome(nome) {
            // Limpa a busca e mostra o resultado
            const inputBusca = document.getElementById('inputBuscaFicha');
            inputBusca.value = nome;

            // Esconde a lista de clientes
            document.getElementById('listaClientesInicial').style.display = 'none';

            // Busca o cliente
            const historico = todasOS.filter(os => os.nome.toLowerCase() === nome.toLowerCase());

            if (historico.length > 0) {
                document.getElementById('fichaVazia').style.display = 'none';
                document.getElementById('resultadoFicha').style.display = 'block';

                const cliente = historico[0];
                document.getElementById('fichaNome').innerText = cliente.nome;
                document.getElementById('fichaWhats').innerText = cliente.whatsapp;

                const totalGasto = historico.reduce((acc, os) => acc + (os.valor || 0), 0);
                document.getElementById('fichaTotalGasto').innerText = totalGasto.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });

                const tbody = document.getElementById('fichaTabelaHistorio');
                tbody.innerHTML = historico.map(os => {
                    const btnAcao = os.status !== 'Pago'
                        ? `<button class="btn btn-sm btn-success" onclick="finalizarOSRapido('${os.id}')"><i class="fa-solid fa-check"></i> Receber</button>`
                        : `<span class="badge bg-light text-success"><i class="fa-solid fa-check-double"></i> Pago</span>`;

                    return `
                <tr>
                    <td>${new Date(os.created_at).toLocaleDateString()}</td>
                    <td><span class="badge bg-dark">${os.veiculo}</span></td>
                    <td><small>${os.servico || 'Geral'}</small></td>
                    <td class="fw-bold">R$ ${parseFloat(os.valor).toFixed(2)}</td>
                    <td class="text-center">${btnAcao}</td>
                </tr>
            `;
                }).join('');
            }
        }

        verificarSessao();
        carregarCatalogoServicos();

        // ===== MÁSCARAS DE CAMPOS =====
        // Criar tabela de configurações se não existir
        async function criarTabelaConfiguracoes() {
            const { error } = await supabaseClient.rpc('create_configuracoes_table');
            if (error && !error.message.includes('already exists')) {
                console.log('Nota: Execute este SQL no Supabase para criar a tabela de configurações:');
                console.log(`
                    CREATE TABLE IF NOT EXISTS configuracoes (
                        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
                        nome_empresa TEXT,
                        cnpj TEXT,
                        telefone TEXT,
                        endereco TEXT,
                        created_at TIMESTAMP DEFAULT NOW()
                    );
                `);
            }
        }

        criarTabelaConfiguracoes();

        // ===== INICIALIZAR TUDO APÓS DOM CARREGAR =====
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🚀 DOM carregado! Inicializando event listeners...');

            // Aplicar máscaras
            setTimeout(() => {
                const cnpjInput = document.getElementById('configCNPJ');
                const telefoneInput = document.getElementById('configTelefone');

                if (cnpjInput && typeof IMask !== 'undefined') {
                    console.log('✅ Aplicando máscara CNPJ');
                    IMask(cnpjInput, { mask: '00.000.000/0000-00' });
                }

                if (telefoneInput && typeof IMask !== 'undefined') {
                    console.log('✅ Aplicando máscara Telefone');
                    IMask(telefoneInput, {
                        mask: [
                            { mask: '(00) 0000-0000' },
                            { mask: '(00) 00000-0000' }
                        ]
                    });
                }
            }, 500);

            // Event listener para select de serviços
            const selectServico = document.getElementById('selectServicoRapido');
            if (selectServico) {
                console.log('✅ Adicionando listener para selectServicoRapido');
                selectServico.addEventListener('change', function () {
                    if (!this.value) return;

                    const nomeServico = this.options[this.selectedIndex].dataset.nome;
                    const precoServico = parseFloat(this.options[this.selectedIndex].dataset.preco) || 0;

                    console.log('🔧 Serviço selecionado:', nomeServico, precoServico);

                    // Adiciona o nome do serviço ao campo de Observações/Serviço
                    const campoObs = document.getElementById('observacoes');
                    if (campoObs) {
                        if (campoObs.value) {
                            campoObs.value += `, ${nomeServico}`;
                        } else {
                            campoObs.value = nomeServico;
                        }
                    }

                    // Soma o valor ao campo de Valor Total
                    const campoValor = document.getElementById('valor');
                    if (campoValor) {
                        const valorAtual = parseFloat(campoValor.value) || 0;
                        campoValor.value = (valorAtual + precoServico).toFixed(2);
                    }

                    // Feedback visual (Badge com botão de remover)
                    const lista = document.getElementById('listaPecas');
                    if (lista) {
                        const badge = document.createElement('span');
                        badge.className = 'badge badge-modern bg-info text-white position-relative pe-4 me-2 mb-2';
                        badge.style.cursor = 'pointer';
                        badge.dataset.preco = precoServico;
                        badge.dataset.nome = nomeServico;
                        badge.dataset.tipo = 'servico';
                        badge.innerHTML = `
                            <i class="fa-solid fa-wrench me-1"></i> ${nomeServico} (+R$ ${precoServico.toFixed(2)})
                            <button type="button" class="btn-close btn-close-white position-absolute top-50 end-0 translate-middle-y me-1" 
                                style="font-size: 0.6rem;" onclick="removerItemLista(this)"></button>
                        `;
                        lista.appendChild(badge);
                    }

                    this.value = ''; // Reseta o select
                });
            } else {
                console.error('❌ selectServicoRapido não encontrado!');
            }
        });

        async function popularSelectServicos() {
            const { data, error } = await supabaseClient.from('servicos_catalogo').select('*').order('nome');
            const select = document.getElementById('selectServicoRapido');

            if (select && data) {
                select.innerHTML = '<option value="">Selecione um serviço...</option>';
                data.forEach(serv => {
                    select.innerHTML += `<option value="${serv.id}" data-preco="${serv.preco_sugerido}" data-nome="${serv.nome}">
                ${serv.nome} - R$ ${parseFloat(serv.preco_sugerido).toFixed(2)}
            </option>`;
                });

                // Configura o evento para quando você selecionar um SERVIÇO
                select.onchange = function () {
                    if (!this.value) return;

                    const selectedOption = this.options[this.selectedIndex];
                    const nomeServico = selectedOption.dataset.nome;
                    const precoServico = parseFloat(selectedOption.dataset.preco) || 0;

                    // 1. Soma ao Valor Total
                    const campoValor = document.getElementById('valor');
                    if (campoValor) {
                        const valorAtual = parseFloat(campoValor.value) || 0;
                        campoValor.value = (valorAtual + precoServico).toFixed(2);
                    }

                    // 2. Adiciona ao campo de Observações/Serviço
                    const campoObs = document.getElementById('observacoes');
                    if (campoObs) {
                        campoObs.value = campoObs.value ? `${campoObs.value}, ${nomeServico}` : nomeServico;
                    }

                    // 3. Adiciona o Badge visual na lista
                    const lista = document.getElementById('listaPecas');
                    if (lista) {
                        const badge = document.createElement('span');
                        badge.className = 'badge badge-modern bg-info text-white position-relative pe-4 me-2 mb-2';
                        badge.dataset.preco = precoServico;
                        badge.dataset.nome = nomeServico;
                        badge.dataset.tipo = 'servico'; // Identifica que é serviço
                        badge.innerHTML = `
                            <i class="fa-solid fa-wrench me-1"></i> ${nomeServico} (+R$ ${precoServico.toFixed(2)})
                            <button type="button" class="btn-close btn-close-white position-absolute top-50 end-0 translate-middle-y me-1" 
                                style="font-size: 0.6rem;" onclick="removerItemLista(this)"></button>
                        `;
                        lista.appendChild(badge);
                    }
                    this.value = '';
                };
            }
        }

        // Função para remover item da lista (produtos e serviços) - FUNCIONA EM AMBOS MODAIS
        window.removerItemLista = function (btnClose) {
            const badge = btnClose.closest('.badge');
            const preco = parseFloat(badge.dataset.preco);
            const nome = badge.dataset.nome;
            const tipo = badge.dataset.tipo;

            // Identifica se estamos no modal de cadastro ou de edição
            const isEdicao = btnClose.closest('#modalEdicao') !== null;

            const idValor = isEdicao ? 'editValor' : 'valor';
            const idObs = isEdicao ? 'editObservacoes' : 'observacoes';

            // 1. Subtrai do valor correto
            const campoValor = document.getElementById(idValor);
            if (campoValor) {
                const valorAtual = parseFloat(campoValor.value) || 0;
                campoValor.value = Math.max(0, valorAtual - preco).toFixed(2);
            }

            // 2. Se for serviço, remove das observações corretas
            if (tipo === 'servico') {
                const campoObs = document.getElementById(idObs);
                if (campoObs) {
                    let texto = campoObs.value;
                    texto = texto.split(',').map(s => s.trim()).filter(s => s !== nome).join(', ');
                    campoObs.value = texto;
                }
            }

            // 3. Se for produto e estivermos no cadastro, remove do array global
            if (tipo === 'produto' && !isEdicao) {
                pecasSelecionadas = pecasSelecionadas.filter(p => p.nome !== nome);
            }

            badge.remove();
        };

        function prepararEdicaoServico(id, nome, preco) {
            const linha = document.getElementById(`linha-servico-${id}`);

            linha.innerHTML = `
        <td><input type="text" id="edit-nome-${id}" class="form-control form-control-sm" value="${nome}"></td>
        <td><input type="number" id="edit-preco-${id}" class="form-control form-control-sm" value="${preco}" step="0.01"></td>
        <td class="text-end">
            <button onclick="salvarEdicaoServico('${id}')" class="btn btn-sm btn-success me-1">
                <i class="fa-solid fa-check"></i>
            </button>
            <button onclick="carregarCatalogoServicos()" class="btn btn-sm btn-outline-secondary">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </td>
    `;
        }

        async function salvarEdicaoServico(id) {
            const novoNome = document.getElementById(`edit-nome-${id}`).value;
            const novoPreco = parseFloat(document.getElementById(`edit-preco-${id}`).value);

            const { error } = await supabaseClient
                .from('servicos_catalogo')
                .update({ nome: novoNome, preco_sugerido: novoPreco })
                .eq('id', id);

            if (error) {
                showNotify("Erro ao atualizar serviço", "error");
            } else {
                showNotify("Serviço atualizado!");
                carregarCatalogoServicos();
                popularSelectServicos(); // Atualiza também o select da Nova O.S.
            }
        }

        let graficoLucro = null;

        async function renderizarRelatorioLucroServico() {
            const lucrosPorServico = {};

            // Filtra as OS pagas para calcular o lucro real
            const osPagas = todasOS.filter(os => os.status === 'Pago');

            osPagas.forEach(os => {
                const descricao = os.servico || 'Geral';
                // Divide os serviços se houver mais de um na mesma OS (separados por vírgula)
                const listaS = descricao.split(',').map(s => s.trim());

                listaS.forEach(serv => {
                    // Atribui o valor da OS proporcionalmente ou integralmente ao serviço
                    lucrosPorServico[serv] = (lucrosPorServico[serv] || 0) + (os.valor / listaS.length);
                });
            });

            const labels = Object.keys(lucrosPorServico);
            const valores = Object.values(lucrosPorServico);

            const ctx = document.getElementById('graficoLucroServico').getContext('2d');
            if (graficoLucro) graficoLucro.destroy();

            graficoLucro = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: valores,
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        document.addEventListener('keydown', function (e) {
            // ALT + S (Search) para abrir o buscador/dossiê
            if (e.altKey && e.key.toLowerCase() === 's') {
                e.preventDefault();
                abrirBuscadorCliente();
            }
        });
        // --- CENTRAL DE BUSCA E DOSSIÊ (CORRIGIDO) ---

        // 1. Função para abrir o modal e dar foco automático
        function abrirBuscadorCliente() {
            const modalElement = document.getElementById('modalBuscaCliente');
            const modalBusca = bootstrap.Modal.getOrCreateInstance(modalElement);

            // Limpeza reforçada para evitar o e-mail automático
            const inputBusca = document.getElementById('inputBuscaFicha');
            inputBusca.value = '';

            document.getElementById('resultadoFicha').style.display = 'none';
            document.getElementById('fichaVazia').style.display = 'none';
            document.getElementById('listaClientesInicial').style.display = 'block';

            carregarListaClientes();
            modalBusca.show();

            // Foco automático e limpeza após abertura total
            modalElement.addEventListener('shown.bs.modal', function () {
                inputBusca.value = ''; // Limpa novamente caso o navegador insira após abrir
                inputBusca.focus();
            }, { once: true });
        }

        // 2. Lógica de Pesquisa em Tempo Real
        document.getElementById('inputBuscaFicha').addEventListener('input', function (e) {
            const busca = e.target.value.toLowerCase();

            // Inicia a busca a partir de 2 caracteres para ser mais rápido
            if (busca.length < 2) {
                document.getElementById('resultadoFicha').style.display = 'none';
                document.getElementById('fichaVazia').style.display = 'none';
                document.getElementById('listaClientesInicial').style.display = 'block';
                return;
            }

            // Esconde a lista de clientes quando há busca
            document.getElementById('listaClientesInicial').style.display = 'none';

            const historico = todasOS.filter(os =>
                os.nome.toLowerCase().includes(busca) ||
                os.veiculo.toLowerCase().includes(busca)
            );

            if (historico.length > 0) {
                document.getElementById('fichaVazia').style.display = 'none';
                document.getElementById('resultadoFicha').style.display = 'block';

                const cliente = historico[0];
                document.getElementById('fichaNome').innerText = cliente.nome;
                document.getElementById('fichaWhats').innerText = cliente.whatsapp;

                const totalGasto = historico.reduce((acc, os) => acc + (os.valor || 0), 0);
                document.getElementById('fichaTotalGasto').innerText = totalGasto.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });

                const tbody = document.getElementById('fichaTabelaHistorio');
                tbody.innerHTML = historico.map(os => {
                    const btnAcao = os.status !== 'Pago'
                        ? `<button class="btn btn-sm btn-success" onclick="finalizarOSRapido('${os.id}')"><i class="fa-solid fa-check"></i> Receber</button>`
                        : `<span class="badge bg-light text-success"><i class="fa-solid fa-check-double"></i> Pago</span>`;

                    return `
                <tr>
                    <td>${new Date(os.created_at).toLocaleDateString()}</td>
                    <td><span class="badge bg-dark">${os.veiculo}</span></td>
                    <td><small>${os.servico || 'Geral'}</small></td>
                    <td class="fw-bold">R$ ${parseFloat(os.valor).toFixed(2)}</td>
                    <td class="text-center">${btnAcao}</td>
                </tr>
            `;
                }).join('');
            } else {
                document.getElementById('resultadoFicha').style.display = 'none';
                document.getElementById('fichaVazia').innerHTML = `<i class="fa-solid fa-user-slash"></i><p>Nenhum cliente encontrado com "${busca}"</p>`;
                document.getElementById('fichaVazia').style.display = 'block';
            }
        });

        // 3. Atalho ALT + H para busca rápida
        document.addEventListener('keydown', function (e) {
            if (e.altKey && e.key.toLowerCase() === 'h') {
                e.preventDefault();
                abrirBuscadorCliente();
            }
        });

        // Garantir que a função seja chamada corretamente ao clicar no botão
        document.addEventListener('DOMContentLoaded', function () {
            // Adiciona listener no botão flutuante
            const btnFabSearch = document.querySelector('.btn-fab-search');
            if (btnFabSearch) {
                btnFabSearch.addEventListener('click', function (e) {
                    e.preventDefault();
                    abrirBuscadorCliente();
                });
            }

            // Adiciona listener no campo de pesquisa da navbar (ID CORRETO)
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('click', function (e) {
                    e.preventDefault();
                    abrirBuscadorCliente();
                });
                searchInput.addEventListener('focus', function (e) {
                    e.preventDefault();
                    abrirBuscadorCliente();
                    setTimeout(() => this.blur(), 100);
                });
            }
        });
        // 2. Função para finalizar o serviço direto pelo Dossiê
        async function finalizarOSRapido(id) {
            if (confirm("Confirmar recebimento e finalizar serviço?")) {
                const { error } = await supabaseClient
                    .from('ordens_servico')
                    .update({ status: 'Pago' })
                    .eq('id', id);

                if (!error) {
                    showNotify("Serviço finalizado e pagamento registrado!");

                    // Fecha o modal de busca
                    bootstrap.Modal.getInstance(document.getElementById('modalBuscaCliente')).hide();

                    // Atualiza a tela principal e o dashboard
                    carregarOS();
                } else {
                    showNotify("Erro ao finalizar: " + error.message, "error");
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Máscara para o CNPJ
            const cnpjInput = document.getElementById('configCNPJ');
            if (cnpjInput) {
                IMask(cnpjInput, {
                    mask: '00.000.000/0000-00'
                });
            }

            // Máscara para o Telefone (Dinâmica: Fixo ou Celular)
            const telefoneInput = document.getElementById('configTelefone');
            if (telefoneInput) {
                IMask(telefoneInput, {
                    mask: [
                        { mask: '(00) 0000-0000' },
                        { mask: '(00) 00000-0000' }
                    ]
                });
            }
        });

        async function obterDadosEmpresa() {
            const { data } = await supabaseClient.from('configuracoes').select('*').limit(1).maybeSingle();
            return {
                nome: data?.nome_empresa || 'MELÃO RODAS',
                cnpj: data?.cnpj || '00.000.000/0001-00',
                tel: data?.telefone || '(00) 0000-0000',
                end: data?.endereco || 'Endereço não cadastrado'
            };
        }

        // ========================================
        // FUNÇÕES DO MENU MOBILE
        // ========================================
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('mobileMenuOverlay');

            menu.classList.toggle('active');
            overlay.classList.toggle('active');

            // Previne scroll do body quando menu está aberto
            if (menu.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        function closeMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('mobileMenuOverlay');

            menu.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Fecha menu ao pressionar ESC
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeMobileMenu();
            }
        });


        // Atalho Secreto: ALT + L (abre o campo para colar a chave de comando/licença)
        document.addEventListener('keydown', function (e) {
            // Verifica se a tecla ALT e L foram pressionadas
            if (e.altKey && e.key.toLowerCase() === 'l') {
                e.preventDefault();
                console.log("Atalho ALT+L detectado. Abrindo planos...");

                // Se o usuário estiver logado, abrimos o modal de planos que contém o campo de input
                const modalElement = document.getElementById('modalLicensePlans');
                const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
                modal.show();

                // Dá foco automático no campo de input após o modal abrir
                setTimeout(() => {
                    document.getElementById('licenseKeyInput').focus();
                }, 500);
            }
        });

        // Valida e ativa a licença
        async function validateLicense() {
            const input = document.getElementById('licenseKeyInput');
            const licenseKey = input.value.trim();

            if (!licenseKey) return;

            try {
                // Decodifica a chave de Base64 para String e depois para Objeto
                const decodedString = atob(licenseKey);
                const decodedData = JSON.parse(decodedString);

                // --- LÓGICA DE BLOQUEIO TOTAL (KILL SWITCH) ---
                if (decodedData.tipo === "REVOGAR") {
                    // Remove a licença local
                    localStorage.removeItem('melaoRodasLicense');

                    // Pega o motivo enviado pelo gerador ou usa um padrão
                    const motivo = decodedData.motivo || "Acesso interrompido pelo administrador.";

                    // Desloga do Supabase
                    if (window.supabaseClient) {
                        await supabaseClient.auth.signOut();
                    }

                    Swal.fire({
                        icon: 'error',
                        title: 'ACESSO BLOQUEADO',
                        text: motivo,
                        confirmButtonText: 'Sair'
                    }).then(() => {
                        location.reload();
                    });
                    return;
                }

                // --- LÓGICA DE ATIVAÇÃO NORMAL ---
                const expirationDate = new Date(decodedData.expira_em);

                if (new Date() > expirationDate) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Licença Expirada',
                        text: 'Esta chave não é mais válida.'
                    });
                    return;
                }

                localStorage.setItem('melaoRodasLicense', JSON.stringify(decodedData));

                Swal.fire({
                    icon: 'success',
                    title: 'Sistema Ativado!',
                    text: `Válido até: ${expirationDate.toLocaleString('pt-BR')}`
                }).then(() => {
                    location.reload();
                });

            } catch (error) {
                console.error('Erro:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Chave Inválida',
                    text: 'Verifique se copiou o código corretamente.'
                });
            }
        }

    </script>


    <div class="modal fade" id="modalServicos" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fa-solid fa-list-check me-2"></i>Catálogo de Serviços</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formServicoCatalogo" class="mb-4 p-3 bg-light rounded shadow-sm">
                        <div class="row g-2">
                            <div class="col-md-7">
                                <input type="text" id="servNome" class="form-control form-control-modern"
                                    placeholder="Ex: Alinhamento 3D" required>
                            </div>
                            <div class="col-md-3">
                                <input type="number" id="servPreco" class="form-control form-control-modern"
                                    placeholder="Preço R$" step="0.01" required>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary-modern w-100"><i
                                        class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>
                    </form>
                    <div class="table-responsive">
                        <table class="table table-modern">
                            <thead>
                                <tr>
                                    <th>Serviço</th>
                                    <th>Preço Sugerido</th>
                                    <th class="text-end">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="listaServicosCatalogo"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configurações -->
    <div class="modal fade" id="modalConfiguracoes" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fa-solid fa-gear me-2"></i>Configurações da Empresa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="formConfiguracoes">
                    <div class="modal-body">
                        <div class="alert alert-info mb-4">
                            <i class="fa-solid fa-circle-info me-2"></i>
                            Estas informações aparecerão nas Ordens de Serviço geradas para o cliente.
                        </div>
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label-modern">Nome da Empresa</label>
                                <input type="text" id="configNomeEmpresa" class="form-control form-control-modern"
                                    placeholder="Ex: MELÃO RODAS Centro Automotivo" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label-modern">CNPJ</label>
                                <input type="text" id="configCNPJ" class="form-control form-control-modern"
                                    placeholder="00.000.000/0001-00" maxlength="18" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label-modern">Telefone</label>
                                <input type="tel" id="configTelefone" class="form-control form-control-modern"
                                    placeholder="(00) 00000-0000" maxlength="15" required>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label-modern">Endereço Completo</label>
                                <input type="text" id="configEndereco" class="form-control form-control-modern"
                                    placeholder="Rua, Número, Bairro - Cidade/UF" required>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-modern" data-bs-dismiss="modal"
                            style="color: var(--text-secondary); border-color: var(--border);">Cancelar</button>
                        <button type="submit" class="btn btn-primary-modern">
                            <i class="fa-solid fa-save me-2"></i>Salvar Configurações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalBuscaCliente" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fa-solid fa-address-card me-2"></i>Dossiê do Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="search-box mb-4 mx-auto" style="max-width: 600px;">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="search" id="inputBuscaFicha" class="form-control form-control-lg"
                            placeholder="Digite o nome do cliente para pesquisar..." autocomplete="chrome-off"
                            name="campo_pesquisa_aleatorio_99">
                    </div>

                    <!-- Lista de Clientes (quando não há busca) -->
                    <div id="listaClientesInicial" class="mb-4">
                        <h6 class="fw-bold mb-3">Clientes Recentes</h6>
                        <div class="row g-3" id="gridClientes">
                            <!-- Será preenchido via JS -->
                        </div>
                    </div>

                    <div id="resultadoFicha" style="display: none;">
                        <div class="row g-4">
                            <div class="col-md-4">
                                <div class="card-modern p-4 h-100 bg-light">
                                    <h6 class="fw-bold border-bottom pb-2 mb-3">Informações Cadastrais</h6>
                                    <p class="mb-1 text-muted small">NOME COMPLETO</p>
                                    <h5 id="fichaNome" class="fw-bold text-primary mb-3">-</h5>
                                    <p class="mb-1 text-muted small">CONTATO</p>
                                    <h5 id="fichaWhats" class="fw-bold mb-3">-</h5>
                                    <div class="stat-card p-3 mt-4">
                                        <div class="stat-label">Total Investido na Loja</div>
                                        <div class="stat-value text-success" id="fichaTotalGasto">R$ 0,00</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="card-modern p-4">
                                    <h6 class="fw-bold mb-3">Histórico de Visitas e Compras</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Data</th>
                                                    <th>Veículo</th>
                                                    <th>Serviços/Produtos</th>
                                                    <th>Valor</th>
                                                    <th class="text-center">Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody id="fichaTabelaHistorio"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="fichaVazia" class="empty-state" style="display: none;">
                        <i class="fa-solid fa-user-slash"></i>
                        <p>Nenhum cliente encontrado com essa busca.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // SISTEMA DE LICENCIAMENTO
        // ========================================

        // Chave secreta para validação (deve ser a mesma do gerador Python)
        // Esta é a assinatura pública - a chave privada está no servidor Python
        const LICENSE_PUBLIC_KEY = "MELAO_RODAS_2025";

        // Função para calcular hash SHA-256
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Verifica se existe uma licença válida
        let countdownInterval;

        function checkLicense() {
            const licenseData = JSON.parse(localStorage.getItem('melaoRodasLicense'));
            const bar = document.getElementById('countdown-bar');

            if (!licenseData || !licenseData.expira_em) {
                showLicenseBlock();
                bar.style.display = 'none';
                return;
            }

            const expirationDate = new Date(licenseData.expira_em);

            // Iniciar contagem regressiva
            if (countdownInterval) clearInterval(countdownInterval);

            countdownInterval = setInterval(() => {
                const agora = new Date().getTime();
                const distancia = expirationDate.getTime() - agora;

                if (distancia < 0) {
                    clearInterval(countdownInterval);
                    localStorage.removeItem('melaoRodasLicense');
                    location.reload();
                    return;
                }

                const dias = Math.floor(distancia / (1000 * 60 * 60 * 24));
                const horas = Math.floor((distancia % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutos = Math.floor((distancia % (1000 * 60 * 60)) / (1000 * 60));
                const segundos = Math.floor((distancia % (1000 * 60)) / 1000);

                bar.style.display = 'block';
                document.getElementById('countdown-timer').innerHTML =
                    `${dias}d ${horas}h ${minutos}m ${segundos}s`;
            }, 1000);
        }

        // Mostra tela de bloqueio
        function showLicenseBlock() {
            document.getElementById('licenseOverlay').style.display = 'flex';
        }

        // Esconde tela de bloqueio
        function hideLicenseBlock() {
            document.getElementById('licenseOverlay').style.display = 'none';
        }

        // Mostra modal de planos
        function showLicensePlans() {
            const modalElement = document.getElementById('modalLicensePlans');
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',
                keyboard: false
            });

            // Garantir que o modal tenha z-index maior que a tela de bloqueio
            modalElement.style.zIndex = '9999';

            // Quando o modal abrir, ajustar o backdrop também
            modalElement.addEventListener('shown.bs.modal', function () {
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.style.zIndex = '9998';
                }
            });

            modal.show();
        }

        // Mostra dias restantes
        function showDaysRemaining(days) {
            const element = document.getElementById('daysRemaining');
            const textElement = document.getElementById('daysRemainingText');

            if (days <= 7) {
                element.style.background = 'linear-gradient(135deg, #dc2626 0%, #991b1b 100%)';
            } else if (days <= 30) {
                element.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            }

            textElement.textContent = days === 1 ? '1 dia restante' : `${days} dias restantes`;
            element.style.display = 'block';
        }

        // Seleciona um plano
        function selectPlan(days, price) {
            const planName = days === 30 ? 'Mensal' : days === 180 ? 'Semestral' : 'Anual';
            const message = `Olá! Gostaria de adquirir o plano *${planName}* (${days} dias) por *R$ ${price.toFixed(2)}*.`;
            const whatsappUrl = `https://wa.me/5592995258724?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Contato via WhatsApp
        function contactWhatsApp() {
            const message = 'Olá! Gostaria de solicitar uma licença para o sistema MELÃO RODAS.';
            const whatsappUrl = `https://wa.me/5592995258724?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Adicionar evento de Enter no campo de licença
        document.getElementById('licenseKeyInput')?.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                validateLicense();
            }
        });

        // Permitir fechar modal apenas se houver licença válida
        document.getElementById('closeLicenseModal')?.addEventListener('click', function (e) {
            const licenseData = localStorage.getItem('melaoRodasLicense');
            if (!licenseData) {
                e.preventDefault();
                e.stopPropagation();
                Swal.fire({
                    icon: 'warning',
                    title: 'Licença Necessária',
                    text: 'Para usar o sistema, você precisa ativar uma licença.',
                    confirmButtonText: 'Entendi'
                });
            }
        });

        // Verificar licença ao carregar a página
        document.addEventListener('DOMContentLoaded', function () {
            // Aguardar 500ms para garantir que todos os elementos foram carregados
            setTimeout(() => {
                checkLicense();
            }, 500);
        });

        // Verificar licença periodicamente (a cada 1 hora)
        setInterval(function () {
            checkLicense();
        }, 3600000);


        function skipLicense() {
            const testLicense = {
                dias: 30,
                criado_em: new Date().toISOString(),
                expira_em: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                cliente_id: "TESTE",
                observacao: "Licença de teste",
                versao: "1.0",
                assinatura: "test"
            };
            localStorage.setItem('melaoRodasLicense', JSON.stringify(testLicense));
            location.reload();
        }
        // Para usar: abra o console e digite: skipLicense()

        let atendenteLogado = null;
        let logoClicks = 0;

        // Certifique-se de que o ID 'logoClick' está exatamente na tag <a> da logo
        document.getElementById('logoClick').addEventListener('click', (e) => {
            e.preventDefault(); // Evita que a página recarregue ao clicar
            logoClicks++;
            console.log("Cliques na logo:", logoClicks); // Para você testar no console (F12)
            if (logoClicks >= 5) {
                document.getElementById('adminArea').style.setProperty('display', 'block', 'important');
                showNotify("Menu de Administrador liberado!", "success");
            }
        });

        // Função para abrir seleção de atendente após login bem-sucedido
        async function abrirSelecaoAtendente() {
            const { data, error } = await supabaseClient.from('atendentes').select('*');
            const lista = document.getElementById('listaAtendentesLogin');

            if (data && data.length > 0) {
                lista.innerHTML = data.map(at => `
            <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                onclick="verificarSenhaAtendente('${at.id}', '${at.nome}')">
                ${at.nome} <i class="fa-solid fa-chevron-right"></i>
            </button>
        `).join('');
                new bootstrap.Modal(document.getElementById('modalSelecaoAtendente')).show();
            } else {
                showNotify("Nenhum atendente cadastrado. Use o segredo da logo para cadastrar.", "error");
            }
        }

        async function verificarSenhaAtendente(id, nome) {
            // Fecha o modal de seleção de atendente primeiro
            const modalElement = document.getElementById('modalSelecaoAtendente');
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
                modalInstance.hide();
            }

            // Aguarda o modal fechar completamente antes de abrir o SweetAlert
            setTimeout(async () => {
                const { value: senha } = await Swal.fire({
                    title: `Senha de ${nome}`,
                    input: 'password',
                    inputLabel: 'Digite sua senha de 6 dígitos',
                    inputPlaceholder: '******',
                    inputAttributes: {
                        maxlength: 6,
                        autocomplete: 'off',
                        inputmode: 'numeric'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Confirmar',
                    cancelButtonText: 'Cancelar',
                    allowOutsideClick: false,
                    didOpen: () => {
                        // Força o foco no input assim que o SweetAlert abrir
                        setTimeout(() => {
                            const input = Swal.getInput();
                            if (input) {
                                input.focus();
                                input.click(); // Garante que o input está clicável
                            }
                        }, 100);
                    },
                    preConfirm: (senha) => {
                        if (!senha || senha.length !== 6) {
                            Swal.showValidationMessage('A senha deve ter 6 dígitos');
                            return false;
                        }
                        return senha;
                    }
                });

                if (senha) {
                    const { data } = await supabaseClient.from('atendentes').select('*').eq('id', id).eq('senha_numerica', senha).single();
                    if (data) {
                        atendenteLogado = nome;
                        showNotify(`Bem-vindo, ${nome}!`, "success");
                    } else {
                        showNotify("Senha incorreta", "error");
                        // Reabre o modal de seleção se a senha estiver incorreta
                        setTimeout(() => {
                            new bootstrap.Modal(modalElement).show();
                        }, 300);
                    }
                } else {
                    // Se cancelar, reabre o modal de seleção
                    setTimeout(() => {
                        new bootstrap.Modal(modalElement).show();
                    }, 300);
                }
            }, 400);
        }

        async function salvarAtendente() {
            const nome = document.getElementById('novoAtendenteNome').value;
            const senha = document.getElementById('novoAtendenteSenha').value;

            if (nome && senha.length === 6) {
                const { error } = await supabaseClient.from('atendentes').insert([{ nome, senha_numerica: senha }]);
                if (!error) {
                    showNotify("Atendente cadastrado!");
                    bootstrap.Modal.getInstance(document.getElementById('modalCadastroAtendente')).hide();
                }
            } else {
                showNotify("Preencha o nome e senha de 6 dígitos", "error");
            }
        }

        // Chame abrirSelecaoAtendente() dentro da sua função verificarSessao() 
        // quando detectar que o usuário está logado.

    </script>

    <div id="adminArea" style="display: none;" class="text-center mb-3">
        <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalCadastroAtendente">
            <i class="fa-solid fa-user-shield me-2"></i>Gerenciar Atendentes
        </button>
    </div>

    <div class="modal fade" id="modalSelecaoAtendente" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Quem está operando o sistema?</h5>
                </div>
                <div class="modal-body">
                    <div class="list-group" id="listaAtendentesLogin">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalCadastroAtendente" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cadastrar Novo Atendente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nome do Atendente</label>
                        <input type="text" id="novoAtendenteNome" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Senha Numérica (6 dígitos)</label>
                        <input type="password" id="novoAtendenteSenha" class="form-control" maxlength="6">
                    </div>
                    <button class="btn btn-primary w-100" onclick="salvarAtendente()">Salvar Atendente</button>
                </div>
            </div>
        </div>
    </div>

</body>


</html>
