<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Kanban - Gest√£o de Tarefas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --drogasil-red: #E31E24;
            --drogasil-red-dark: #C11119;
            --drogasil-red-light: #FF4449;
            --drogasil-white: #FFFFFF;
            --drogasil-gray: #F5F5F5;
            --success: #00C851;
            --success-dark: #00A041;
            --warning: #FF8900;
            --danger: #FF4444;
            --info: #3498db;
            --purple: #9C27B0;
            --orange: #FF9800;
            --text-dark: #2C3E50;
            --text-medium: #5A6C7D;
            --text-light: #8B9DC3;
            --shadow-light: 0 2px 10px rgba(227, 30, 36, 0.08);
            --shadow-medium: 0 4px 20px rgba(227, 30, 36, 0.12);
            --shadow-heavy: 0 10px 40px rgba(227, 30, 36, 0.15);
            --border-radius: 16px;
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #E31E24 0%, #C11119 35%, #A00E15 100%);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: auto;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* User Info Bar */
        .user-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-medium);
            z-index: 1000;
            animation: slideInRight 0.5s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .user-info i {
            color: var(--drogasil-red);
            font-size: 1.2rem;
        }

        .user-info span {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        .nav-btn {
            background: var(--drogasil-red);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Estilos para os alertas */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.1);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .alert-container {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            color: white;
            padding: 30px 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(255, 0, 0, 0.4);
            text-align: center;
            max-width: 500px;
            width: 90%;
            border: 3px solid white;
        }

        .alert-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .alert-title i {
            font-size: 2.5rem;
            animation: bellRing 0.5s ease-in-out infinite alternate;
        }

        .alert-message {
            font-size: 1.2rem;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .alert-task-list {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .alert-task-item {
            background: rgba(255, 255, 255, 0.9);
            color: #cc0000;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .alert-task-title {
            flex: 1;
            text-align: left;
        }

        .alert-task-status {
            background: #cc0000;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .alert-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .alert-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .alert-btn-primary {
            background: white;
            color: #cc0000;
        }

        .alert-btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
        }

        .alert-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }


        /* === ESTILOS PARA TIME TRACKING === */

        .time-tracking-container {
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            border: 2px solid var(--drogasil-gray);
        }

        .time-tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .time-tracking-title {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .time-tracking-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .time-stat {
            text-align: center;
            padding: 6px;
            background: var(--drogasil-gray);
            border-radius: 6px;
        }

        .time-stat-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--drogasil-red);
        }

        .time-stat-label {
            font-size: 0.7rem;
            color: var(--text-medium);
            margin-top: 2px;
        }

        .time-tracking-actions {
            display: flex;
            gap: 8px;
        }

        .btn-timer {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.8rem;
        }

        .btn-timer-start {
            background: var(--success);
            color: white;
        }

        .btn-timer-stop {
            background: var(--danger);
            color: white;
        }

        .btn-timer:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-timer:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-light);
        }

        .timer-active {
            background: rgba(255, 68, 68, 0.1) !important;
            border: 2px solid var(--danger) !important;
            animation: pulseTimer 2s infinite;
        }

        @keyframes pulseTimer {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(255, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0);
            }
        }

        .time-session-info {
            margin-top: 8px;
            padding: 6px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 6px;
            text-align: center;
            font-size: 0.8rem;
            color: var(--info);
            font-weight: 600;
        }

        /* Modal de Relat√≥rios */
        .reports-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .report-card {
            background: var(--drogasil-gray);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .report-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--drogasil-red);
            margin-bottom: 5px;
        }

        .report-label {
            font-size: 0.8rem;
            color: var(--text-medium);
        }

        .time-sessions-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid var(--info);
        }

        .session-time {
            font-weight: 600;
            color: var(--text-dark);
        }

        .session-duration {
            background: var(--success);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Painel de Tracking Ativo */
        .active-tracking-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            min-width: 250px;
            border: 2px solid var(--danger);
        }

        .active-tracking-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: var(--danger);
            font-weight: 600;
        }

        .active-tracking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--drogasil-gray);
        }

        .active-tracking-item:last-child {
            border-bottom: none;
        }

        .active-task-title {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .active-task-time {
            background: var(--danger);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }



        /* Anima√ß√µes */
        @keyframes bellRing {
            0% {
                transform: rotate(-15deg);
            }

            100% {
                transform: rotate(15deg);
            }
        }

        @keyframes alertPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 20px rgba(255, 68, 68, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0);
            }
        }

        @keyframes alertShake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-10px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(10px);
            }
        }

        .alert-pulse {
            animation: alertPulse 2s infinite, alertShake 0.5s ease-in-out;
        }

        .alert-show {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        /* Badge de urg√™ncia nas tarefas */
        .task-urgent {
            position: relative;
            border-left: 4px solid #ff4444 !important;
            animation: taskPulse 2s infinite;
        }

        .task-urgent::before {
            content: "URGENTE";
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4444;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            z-index: 2;
            animation: blink 1s infinite;
        }

        @keyframes taskPulse {
            0% {
                box-shadow: 0 2px 10px rgba(255, 68, 68, 0.3);
            }

            50% {
                box-shadow: 0 2px 20px rgba(255, 68, 68, 0.6);
            }

            100% {
                box-shadow: 0 2px 10px rgba(255, 68, 68, 0.3);
            }
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }





        /* Estilo opcional para o bot√£o Home */
        .nav-btn.home-btn {
            background: var(--success);
        }

        .nav-btn.home-btn:hover {
            background: var(--success-dark);
        }

        .nav-btn:hover {
            background: var(--drogasil-red-dark);
            transform: translateY(-2px);
        }

        .kanban-container {
            min-height: 100vh;
            padding: 80px 20px 20px 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .kanban-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 25px 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-heavy);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            animation: slideInDown 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title h1 {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--text-dark);
            margin: 0;
        }

        .header-title i {
            font-size: 2rem;
            color: var(--drogasil-red);
        }

        .header-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;


        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--drogasil-red);
            color: white;
            box-shadow: var(--shadow-light);
        }

        .btn-primary:hover {
            background: var(--drogasil-red-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            background: var(--info);
            color: white;
            box-shadow: var(--shadow-light);
        }

        .btn-secondary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: var(--shadow-light);
        }

        .btn-success:hover {
            background: var(--success-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* Filtros e Busca */
        .kanban-filters {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-medium);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid var(--drogasil-gray);
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--drogasil-red);
            box-shadow: 0 0 0 3px rgba(227, 30, 36, 0.1);
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-medium);
        }

        .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 12px 15px;
            border: 2px solid var(--drogasil-gray);
            border-radius: 10px;
            background: white;
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--drogasil-red);
            box-shadow: 0 0 0 3px rgba(227, 30, 36, 0.1);
        }

        /* Board */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            flex: 1;
            animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.4s both;
        }

        .kanban-column {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-heavy);
            display: flex;
            flex-direction: column;
            min-height: 600px;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .kanban-column:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(227, 30, 36, 0.15);
            border-color: rgba(227, 30, 36, 0.1);
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--drogasil-gray);
        }

        .column-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .column-title h3 {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0;
        }

        .task-count {
            background: var(--drogasil-red);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }

        .column-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 10px;
            background: var(--drogasil-gray);
            color: var(--text-dark);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: var(--drogasil-red);
            color: white;
            transform: scale(1.1);
        }

        /* Tasks */
        .tasks-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            max-height: 500px;
            padding-right: 5px;
        }

        .tasks-container::-webkit-scrollbar {
            width: 6px;
        }

        .tasks-container::-webkit-scrollbar-track {
            background: var(--drogasil-gray);
            border-radius: 10px;
        }

        .tasks-container::-webkit-scrollbar-thumb {
            background: var(--drogasil-red);
            border-radius: 10px;
        }

        .task-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: var(--shadow-light);
            cursor: grab;
            transition: var(--transition);
            border-left: 4px solid var(--drogasil-red);
            position: relative;
            animation: slideInUp 0.3s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }

        .task-card.dragging {
            opacity: 0.6;
            transform: rotate(5deg);
            box-shadow: 0 10px 30px rgba(227, 30, 36, 0.2);
        }

        .task-priority {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .priority-high {
            background: var(--danger);
            box-shadow: 0 0 0 2px rgba(255, 68, 68, 0.3);
        }

        .priority-medium {
            background: var(--warning);
            box-shadow: 0 0 0 2px rgba(255, 137, 0, 0.3);
        }

        .priority-low {
            background: var(--success);
            box-shadow: 0 0 0 2px rgba(0, 200, 81, 0.3);
        }

        .task-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--text-dark);
            line-height: 1.3;
        }

        .task-description {
            color: var(--text-medium);
            font-size: 0.9rem;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-medium);
        }

        .task-assignee {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .assignee-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--drogasil-red), var(--drogasil-red-dark));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            box-shadow: var(--shadow-light);
        }

        .task-due-date {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }

        .task-tags {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .task-tag {
            padding: 3px 8px;
            background: var(--drogasil-gray);
            border-radius: 12px;
            font-size: 0.75rem;
            color: var(--text-dark);
            font-weight: 500;
        }

        /* Status colors */
        .column-todo {
            border-top: 4px solid var(--drogasil-red);
        }

        .column-doing {
            border-top: 4px solid var(--warning);
        }

        .column-review {
            border-top: 4px solid var(--info);
        }

        .column-done {
            border-top: 4px solid var(--success);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--drogasil-gray);
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-medium);
            cursor: pointer;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            background: var(--drogasil-gray);
            color: var(--drogasil-red);
            transform: rotate(90deg);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--drogasil-gray);
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--drogasil-red);
            box-shadow: 0 0 0 3px rgba(227, 30, 36, 0.1);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Footer */
        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95rem;
            margin-top: 40px;
            padding-top: 20px;
            position: relative;
            z-index: 1;
            animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.8s both;
        }

        .footer p {
            margin: 5px 0;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-medium);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
            color: var(--drogasil-red);
        }

        .empty-state p {
            margin: 0;
            font-size: 1.1rem;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .user-info {
                top: 10px;
                right: 10px;
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .nav-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            .kanban-container {
                padding: 70px 15px 15px 15px;
            }

            .kanban-header {
                flex-direction: column;
                align-items: flex-start;
                padding: 20px;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between
            }

            .kanban-filters {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: auto;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .kanban-board {
                grid-template-columns: 1fr;
            }

            .header-title h1 {
                font-size: 1.8rem;
            }
        }

        @media (max-width: 480px) {
            .user-info {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }

            .header-title h1 {
                font-size: 1.5rem;
            }

            .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            .kanban-column {
                min-height: 500px;
            }
        }


        /* Indicadores visuais de permiss√£o */
        .no-permission {
            position: relative;
            opacity: 0.6;
            pointer-events: none;
            filter: grayscale(80%);
            cursor: not-allowed;
        }

        .no-permission::after {
            content: "üîí Sem Permiss√£o";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            z-index: 10;
            white-space: nowrap;
        }

        /* Badge de permiss√£o no usu√°rio */
        .permission-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .permission-admin {
            background: var(--drogasil-red);
            color: white;
        }

        .permission-gestor {
            background: var(--info);
            color: white;
        }

        .permission-supervisor {
            background: var(--warning);
            color: white;
        }

        .permission-analista {
            background: var(--teal);
            color: white;
        }

        .permission-operador {
            background: var(--text-medium);
            color: white;
        }

        -----------------------------------------------------------------------------
        /* === NOVOS ESTILOS PARA TIMER E ALERTAS - COLE AQUI === */

        /* Estilos para os alertas */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.1);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .alert-container {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            color: white;
            padding: 30px 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(255, 0, 0, 0.4);
            text-align: center;
            max-width: 500px;
            width: 90%;
            border: 3px solid white;
        }

        .alert-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .alert-title i {
            font-size: 2.5rem;
            animation: bellRing 0.5s ease-in-out infinite alternate;
        }

        .alert-message {
            font-size: 1.2rem;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .alert-task-list {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .alert-task-item {
            background: rgba(255, 255, 255, 0.9);
            color: #cc0000;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .alert-task-title {
            flex: 1;
            text-align: left;
        }

        .alert-task-status {
            background: #cc0000;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .alert-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .alert-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .alert-btn-primary {
            background: white;
            color: #cc0000;
        }

        .alert-btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
        }

        .alert-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Anima√ß√µes */
        @keyframes bellRing {
            0% {
                transform: rotate(-15deg);
            }

            100% {
                transform: rotate(15deg);
            }
        }

        @keyframes alertPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 20px rgba(255, 68, 68, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0);
            }
        }

        @keyframes alertShake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-10px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(10px);
            }
        }

        .alert-pulse {
            animation: alertPulse 2s infinite, alertShake 0.5s ease-in-out;
        }

        .alert-show {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        /* Badge de urg√™ncia nas tarefas */
        .task-urgent {
            position: relative;
            border-left: 4px solid #ff4444 !important;
            animation: taskPulse 2s infinite;
        }

        .task-urgent::before {
            content: "URGENTE";
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4444;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            z-index: 2;
            animation: blink 1s infinite;
        }

        @keyframes taskPulse {
            0% {
                box-shadow: 0 2px 10px rgba(255, 68, 68, 0.3);
            }

            50% {
                box-shadow: 0 2px 20px rgba(255, 68, 68, 0.6);
            }

            100% {
                box-shadow: 0 2px 10px rgba(255, 68, 68, 0.3);
            }
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        /* Estilos para o timer das tarefas */
        .task-timer {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            border-left: 3px solid var(--info);
            font-size: 0.85rem;
            font-weight: 600;
        }

        .timer-icon {
            color: var(--info);
            font-size: 0.9rem;
        }

        .timer-time {
            flex: 1;
            text-align: center;
        }

        .timer-progress {
            height: 4px;
            background: var(--drogasil-gray);
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }

        .timer-progress-bar {
            height: 100%;
            border-radius: 2px;
            transition: width 1s ease;
        }

        .timer-normal {
            border-left-color: var(--success);
        }

        .timer-normal .timer-icon {
            color: var(--success);
        }

        .timer-normal .timer-progress-bar {
            background: var(--success);
        }

        .timer-warning {
            border-left-color: var(--warning);
            background: rgba(255, 137, 0, 0.05);
        }

        .timer-warning .timer-icon {
            color: var(--warning);
        }

        .timer-warning .timer-progress-bar {
            background: var(--warning);
        }

        .timer-critical {
            border-left-color: var(--danger);
            background: rgba(255, 68, 68, 0.05);
            animation: pulseWarning 2s infinite;
        }

        .timer-critical .timer-icon {
            color: var(--danger);
        }

        .timer-critical .timer-progress-bar {
            background: var(--danger);
        }

        .timer-expired {
            border-left-color: #990000;
            background: rgba(153, 0, 0, 0.1);
            color: #990000;
        }

        .timer-expired .timer-icon {
            color: #990000;
        }

        .timer-expired .timer-progress-bar {
            background: #990000;
        }

        @keyframes pulseWarning {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0);
            }
        }

        /* Modal de configura√ß√£o de tempo */
        .time-config-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .time-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .time-input label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .time-input input {
            padding: 10px 12px;
            border: 2px solid var(--drogasil-gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .time-input input:focus {
            outline: none;
            border-color: var(--drogasil-red);
            box-shadow: 0 0 0 3px rgba(227, 30, 36, 0.1);
        }

        .time-summary {
            background: var(--drogasil-gray);
            padding: 12px 15px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
            font-weight: 600;
            color: var(--text-dark);
        }

        /* Painel de controle de tempo */
        .time-control-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            min-width: 200px;
        }

        .time-control-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .time-control-stats {
            font-size: 0.8rem;
            color: var(--text-medium);
        }

        .time-control-stats div {
            margin: 3px 0;
        }

        /* Badge de XP */
        .xp-badge {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 800;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Barra de progresso das subtarefas */
        .subtask-progress-container {
            margin-top: 10px;
            font-size: 0.7rem;
            color: var(--text-medium);
        }

        .subtask-bar {
            height: 6px;
            background: #eee;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }

        .subtask-bar-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }

        /* === FIM DOS NOVOS ESTILOS === */
    </style>
</head>

<body>
    <!-- User Info Bar -->
    <!-- User Info Bar -->
    <div class="user-info">
        <button class="nav-btn" onclick="goToHome()" title="Voltar para a p√°gina inicial">
            <i class="fas fa-home"></i> Home
        </button>
        <i class="fas fa-user-circle"></i>
        <span id="user-display-name">Carregando...</span>
        <button class="nav-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Sair
        </button>
    </div>

    <div class="kanban-container">
        <!-- Header -->
        <div class="kanban-header">
            <div class="header-title">
                <i class="fas fa-tasks"></i>
                <h1>Sistema Kanban - Gest√£o de Tarefas</h1>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openTaskModal()" id="newTaskBtn">
                    <i class="fas fa-plus"></i>
                    Nova Tarefa
                </button>
                <button class="btn btn-secondary" onclick="exportBoard()">
                    <i class="fas fa-download"></i>
                    Exportar
                </button>
                <button class="btn btn-success" onclick="loadBoard()">
                    <i class="fas fa-sync"></i>
                    Atualizar
                </button>
            </div>
        </div>





        <!-- Filtros -->
        <div class="kanban-filters">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Buscar tarefas..." onkeyup="searchTasks()">
                <i class="fas fa-search"></i>
            </div>
            <div class="filter-group">
                <select class="filter-select" id="priorityFilter" onchange="filterTasks()">
                    <option value="all">Todas as Prioridades</option>
                    <option value="high">Alta Prioridade</option>
                    <option value="medium">M√©dia Prioridade</option>
                    <option value="low">Baixa Prioridade</option>
                </select>
                <select class="filter-select" id="assigneeFilter" onchange="filterTasks()">
                    <option value="all">Todos os Respons√°veis</option>
                </select>
            </div>
        </div>

        <!-- Board -->
        <div class="kanban-board" id="kanbanBoard">
            <!-- Colunas ser√£o carregadas dinamicamente via JavaScript -->
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>¬© 2025 Sistema Core One - Todos os direitos reservados</p>
            <p>Kanban Board - Vers√£o 2.0.0 (Banco de Dados)</p>
        </div>
    </div>

    <!-- Modal para Criar/Editar Tarefa -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nova Tarefa</h2>
                <button class="close-modal" onclick="closeTaskModal()">&times;</button>
            </div>
            <form id="taskForm" onsubmit="saveTask(event)">
                <input type="hidden" id="taskId">
                <input type="hidden" id="taskColumnId">

                <div class="form-group">
                    <label for="taskTitle">T√≠tulo da Tarefa *</label>
                    <input type="text" class="form-control" id="taskTitle" required
                        placeholder="Digite o t√≠tulo da tarefa">
                </div>

                <div class="form-group">
                    <label for="taskDescription">Descri√ß√£o</label>
                    <textarea class="form-control" id="taskDescription" placeholder="Descreva a tarefa..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="taskPriority">Prioridade *</label>
                        <select class="form-control" id="taskPriority" required>
                            <option value="low">Baixa</option>
                            <option value="medium" selected>M√©dia</option>
                            <option value="high">Alta</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="taskDueDate">Data de Vencimento</label>
                        <input type="date" class="form-control" id="taskDueDate">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="taskAssignee">Respons√°vel</label>
                        <select class="form-control" id="taskAssignee">
                            <option value="">Selecione um respons√°vel</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="taskTags">Tags</label>
                        <input type="text" class="form-control" id="taskTags" placeholder="Separe por v√≠rgulas">
                    </div>
                </div>

                <div class="form-group">
                    <label for="taskEstimate">Estimativa (horas)</label>
                    <input type="number" class="form-control" id="taskEstimate" min="1" max="100"
                        placeholder="Horas estimadas">
                </div>

                <div class="form-group">
                    <label for="taskColumn">Coluna *</label>
                    <select class="form-control" id="taskColumn" required>
                        <option value="">Selecione uma coluna</option>
                    </select>
                </div>

                <div class="form-group" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn" onclick="closeTaskModal()"
                        style="background: var(--drogasil-gray); color: var(--text-dark);">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveTaskBtn">
                        <i class="fas fa-save"></i>
                        Salvar Tarefa
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Dados globais
        let currentUser = null;
        let tasks = [];
        let columns = [];
        let teamMembers = [];
        let currentSearch = '';
        let currentPriorityFilter = 'all';
        let currentAssigneeFilter = 'all';

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function () {
            loadUserInfo();
            initializeBoard();
            initializeTimeTracking(); // Adicione esta linha
        });

        async function loadUserInfo() {
            const user = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = user;
            document.getElementById('user-display-name').textContent =
                `${user.name} (${user.matricula}) - ${getPermissionLabel(user.permission)}`;
        }


        function goToHome() {
            // Registrar log de navega√ß√£o
            const user = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
            if (user) {
                fetch('/api/logs/registrar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        matricula: user.matricula,
                        action: 'NAVIGATION',
                        details: 'Navega√ß√£o para Home a partir do Kanban'
                    })
                }).catch(console.error);
            }

            window.location.href = '/home';
        }




        function getPermissionLabel(permission) {
            const labels = {
                'admin': 'Administrador',
                'gestor': 'Gestor',
                'supervisor': 'Supervisor',
                'analista': 'Analista',
                'operador': 'Operador'
            };
            return labels[permission] || permission;
        }

        async function initializeBoard() {
            try {
                await loadColumns();
                await loadTeamMembers();

                // Carregar tarefas com sistema de permiss√µes
                const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
                if (currentUser) {
                    tasks = await carregarTarefasComPermissao();
                } else {
                    tasks = [];
                }

                renderBoard();
            } catch (error) {
                console.error('Erro ao inicializar board:', error);
                showNotification('Erro ao carregar dados do Kanban', 'error');
            }
        }

        async function loadColumns() {
            try {
                const response = await fetch('/api/kanban/columns');
                const data = await response.json();

                if (data.success) {
                    columns = data.columns;
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Erro ao carregar colunas:', error);
                throw error;
            }
        }

        async function loadTeamMembers() {
            try {
                const response = await fetch('/api/kanban/usuarios');
                const data = await response.json();

                if (data.success) {
                    teamMembers = data.users;
                    populateAssignees();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Erro ao carregar membros da equipe:', error);
                throw error;
            }
        }


        // Adicione esta fun√ß√£o para carregar tarefas com permiss√µes
        async function carregarTarefasComPermissao() {
            const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
            if (!currentUser) return [];

            try {
                const authParams = `user_id=${currentUser.id}&user_permissao=${currentUser.permission}`;
                const response = await fetch(`/api/kanban/tasks?${authParams}`);
                const data = await response.json();

                if (data.success) {
                    return data.tasks;
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Erro ao carregar tarefas:', error);
                return [];
            }
        }


        async function loadTasks() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
                if (!currentUser) {
                    throw new Error('Usu√°rio n√£o autenticado');
                }

                // Adicionar par√¢metros de autentica√ß√£o
                const authParams = `user_id=${currentUser.id}&user_permissao=${currentUser.permission}`;
                const response = await fetch(`/api/kanban/tasks?${authParams}`);
                const data = await response.json();

                if (data.success) {
                    tasks = data.tasks;
                    console.log(`Carregadas ${tasks.length} tarefas para o usu√°rio ${currentUser.name}`);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Erro ao carregar tarefas:', error);
                showNotification('Erro ao carregar tarefas: ' + error.message, 'error');
                throw error;
            }
        }

        function populateAssignees() {
            const assigneeSelect = document.getElementById('taskAssignee');
            const assigneeFilter = document.getElementById('assigneeFilter');

            // Limpar op√ß√µes existentes
            assigneeSelect.innerHTML = '<option value="">Selecione um respons√°vel</option>';
            assigneeFilter.innerHTML = '<option value="all">Todos os Respons√°veis</option>';

            teamMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.nome;
                assigneeSelect.appendChild(option);

                const filterOption = document.createElement('option');
                filterOption.value = member.id;
                filterOption.textContent = member.nome;
                assigneeFilter.appendChild(filterOption);
            });
        }

        function populateColumns() {
            const columnSelect = document.getElementById('taskColumn');
            columnSelect.innerHTML = '<option value="">Selecione uma coluna</option>';

            columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.id;
                option.textContent = column.name;
                columnSelect.appendChild(option);
            });
        }

        function renderBoard() {
            const board = document.getElementById('kanbanBoard');
            board.innerHTML = '';

            columns.forEach(column => {
                const columnTasks = tasks.filter(task =>
                    task.column_id === column.id &&
                    isTaskVisible(task)
                );

                const columnElement = document.createElement('div');
                columnElement.className = `kanban-column column-${getColumnClass(column.name)}`;
                columnElement.setAttribute('data-column-id', column.id);
                columnElement.setAttribute('ondrop', 'drop(event)');
                columnElement.setAttribute('ondragover', 'allowDrop(event)');

                columnElement.innerHTML = `
            <div class="column-header">
                <div class="column-title">
                    <h3>${column.name}</h3>
                    <span class="task-count">${columnTasks.length}</span>
                </div>
                <div class="column-actions">
                    <button class="btn-icon" onclick="addTaskToColumn(${column.id})" title="Adicionar Tarefa">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="tasks-container" id="tasks-${column.id}">
                ${columnTasks.length === 0 ? `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>Nenhuma tarefa</p>
                    </div>
                ` : columnTasks.map(task => createTaskCard(task)).join('')}
            </div>
        `;

                board.appendChild(columnElement);
            });

            setupDragAndDrop();
            setupTaskPermissions(); // Aplicar permiss√µes nas tarefas

            // Na fun√ß√£o renderBoard(), ap√≥s criar as task cards, adicione:
            setTimeout(() => {
                tasks.forEach(task => {
                    enhanceTaskCardWithTimeTracking(task);
                    updateTimeTrackingButtons(task.id);
                });
            }, 100);
        }

        // Adicione verifica√ß√£o de permiss√µes nas a√ß√µes de tarefas
        function setupTaskPermissions() {
            const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
            if (!currentUser) return;

            // Admin tem acesso total
            if (currentUser.permission === 'admin') {
                return;
            }

            // Para n√£o-admins, verificar permiss√µes em cada tarefa
            document.querySelectorAll('.task-card').forEach(card => {
                const taskId = card.getAttribute('data-task-id');
                const task = tasks.find(t => t.id == taskId);

                if (task) {
                    // Verificar se o usu√°rio pode editar/excluir esta tarefa
                    const canEdit = task.created_by === currentUser.id || task.assignee_id === currentUser.id;
                    const canDelete = task.created_by === currentUser.id;

                    const editBtn = card.querySelector('button[onclick*="editTask"]');
                    const deleteBtn = card.querySelector('button[onclick*="deleteTask"]');

                    if (editBtn && !canEdit) {
                        editBtn.style.display = 'none';
                    }
                    if (deleteBtn && !canDelete) {
                        deleteBtn.style.display = 'none';
                    }
                }
            });
        }



        function getColumnClass(columnName) {
            const classes = {
                'A Fazer': 'todo',
                'Em Andamento': 'doing',
                'Em Revis√£o': 'review',
                'Conclu√≠do': 'done'
            };
            return classes[columnName] || 'todo';
        }

        function createTaskCard(task) {
            const assignee = teamMembers.find(m => m.id === task.assignee_id);
            const dueDate = task.due_date ? new Date(task.due_date).toLocaleDateString('pt-BR') : '';
            const tags = task.tags ? task.tags.split(',').map(tag => `<span class="task-tag">${tag.trim()}</span>`).join('') : '';
            const initials = assignee ? assignee.nome.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : '??';

            return `
        <div class="task-card" draggable="true" ondragstart="drag(event)" data-task-id="${task.id}">
            <div class="task-priority priority-${task.priority}"></div>
            <div class="task-title">${task.title}</div>
            <div class="task-description">${task.description || ''}</div>
            <div class="task-meta">
                <div class="task-assignee">
                    <div class="assignee-avatar">${initials}</div>
                    <span>${assignee ? assignee.nome : 'N√£o atribu√≠do'}</span>
                </div>
                ${dueDate ? `<div class="task-due-date"><i class="far fa-calendar"></i> ${dueDate}</div>` : ''}
            </div>
            ${tags ? `<div class="task-tags">${tags}</div>` : ''}
            
            <!-- Time Tracking ser√° inserido aqui via JavaScript -->
            
            <div style="margin-top: 10px; display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn-icon" onclick="editTask(${task.id})" style="font-size: 0.8rem;" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon" onclick="deleteTask(${task.id})" style="font-size: 0.8rem; color: var(--danger);" title="Excluir">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
        }

        // Modal Functions
        function openTaskModal(columnId = null) {
            if (!currentUser) {
                showNotification('Usu√°rio n√£o autenticado', 'error');
                return;
            }

            document.getElementById('modalTitle').textContent = 'Nova Tarefa';
            document.getElementById('taskForm').reset();
            document.getElementById('taskId').value = '';
            document.getElementById('taskColumnId').value = columnId || '';
            populateColumns();

            // PR√â-SELECIONAR O USU√ÅRIO LOGADO COMO RESPONS√ÅVEL
            const assigneeSelect = document.getElementById('taskAssignee');
            assigneeSelect.value = currentUser.id;

            // SE N√ÉO FOR ADMIN, DESABILITAR A SELE√á√ÉO DE OUTROS USU√ÅRIOS
            if (currentUser.permission !== 'admin') {
                assigneeSelect.disabled = true;
                assigneeSelect.title = 'Voc√™ s√≥ pode ser respons√°vel por suas pr√≥prias tarefas';
            } else {
                assigneeSelect.disabled = false;
                assigneeSelect.title = '';
            }
            if (columnId) {
                document.getElementById('taskColumn').value = columnId;
            }

            document.getElementById('taskModal').classList.add('show');
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('show');
        }
        async function editTask(taskId) {
            try {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    // VERIFICAR PERMISS√ÉO PARA EDITAR
                    if (!canUserEditTask(task)) {
                        showNotification('Voc√™ n√£o tem permiss√£o para editar esta tarefa!', 'error');
                        return;
                    }

                    document.getElementById('modalTitle').textContent = 'Editar Tarefa';
                    document.getElementById('taskId').value = task.id;
                    document.getElementById('taskTitle').value = task.title;
                    document.getElementById('taskDescription').value = task.description || '';
                    document.getElementById('taskPriority').value = task.priority;
                    document.getElementById('taskDueDate').value = task.due_date || '';
                    document.getElementById('taskAssignee').value = task.assignee_id || '';
                    document.getElementById('taskTags').value = task.tags || '';
                    document.getElementById('taskEstimate').value = task.estimate_hours || '';


                    populateColumns();
                    document.getElementById('taskColumn').value = task.column_id;

                    // CONTROLE DE PERMISS√ÉO NO EDITAR
                    const assigneeSelect = document.getElementById('taskAssignee');
                    if (currentUser.permission !== 'admin') {
                        assigneeSelect.disabled = true;
                        assigneeSelect.title = 'Voc√™ s√≥ pode ser respons√°vel por suas pr√≥prias tarefas';
                    } else {
                        assigneeSelect.disabled = false;
                        assigneeSelect.title = '';
                    }

                    document.getElementById('taskModal').classList.add('show');
                }
            } catch (error) {
                console.error('Erro ao editar tarefa:', error);
                showNotification('Erro ao carregar tarefa', 'error');
            }
        }


        //-----------------------------------------------------------------

        // ========== SISTEMA DE TIME TRACKING ==========

        let activeTrackings = new Map();
        let trackingUpdateInterval = null;

        // Inicializar sistema de time tracking
        function initializeTimeTracking() {
            // Verificar trackings ativos a cada 30 segundos
            setInterval(updateActiveTrackings, 30000);

            // Atualizar display a cada segundo
            trackingUpdateInterval = setInterval(updateTrackingDisplays, 1000);

            // Carregar trackings ativos
            loadActiveTrackings();
        }

        // Carregar trackings ativos do usu√°rio
        async function loadActiveTrackings() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
                if (!currentUser) return;

                const response = await fetch(`/api/timetracking/tarefas-ativas?user_id=${currentUser.id}`);
                const data = await response.json();

                if (data.success) {
                    activeTrackings.clear();
                    data.tarefas_ativas.forEach(tarefa => {
                        activeTrackings.set(tarefa.id, {
                            startTime: new Date(tarefa.start_time),
                            minutosAtivos: tarefa.minutos_ativos
                        });
                    });
                    updateTrackingDisplays();
                    updateActiveTrackingPanel();
                }
            } catch (error) {
                console.error('Erro ao carregar trackings ativos:', error);
            }
        }

        // Iniciar time tracking para uma tarefa
        async function startTimeTracking(taskId) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
                if (!currentUser) {
                    showNotification('Usu√°rio n√£o autenticado!', 'error');
                    return;
                }

                const response = await fetch('/api/timetracking/iniciar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        task_id: taskId,
                        user_id: currentUser.id
                    })
                });

                const data = await response.json();

                if (data.success) {
                    activeTrackings.set(taskId, {
                        startTime: new Date(),
                        trackingId: data.tracking_id
                    });
                    updateTrackingDisplays();
                    updateActiveTrackingPanel();
                    showNotification('Time tracking iniciado!', 'success');
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Erro ao iniciar time tracking:', error);
                showNotification('Erro ao iniciar time tracking', 'error');
            }
        }

        // Parar time tracking para uma tarefa
        async function stopTimeTracking(taskId) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
                if (!currentUser) {
                    showNotification('Usu√°rio n√£o autenticado!', 'error');
                    return;
                }

                const response = await fetch('/api/timetracking/parar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        task_id: taskId,
                        user_id: currentUser.id
                    })
                });

                const data = await response.json();

                if (data.success) {
                    activeTrackings.delete(taskId);
                    updateTrackingDisplays();
                    updateActiveTrackingPanel();

                    // Recarregar a tarefa para atualizar o tempo total
                    await loadTasks();
                    renderBoard();

                    showNotification(data.message, 'success');
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Erro ao parar time tracking:', error);
                showNotification('Erro ao parar time tracking', 'error');
            }
        }

        // Obter status do time tracking para uma tarefa
        async function getTimeTrackingStatus(taskId) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
                if (!currentUser) return null;

                const response = await fetch(`/api/timetracking/status/${taskId}?user_id=${currentUser.id}`);
                const data = await response.json();

                if (data.success) {
                    return data.status;
                }
                return null;
            } catch (error) {
                console.error('Erro ao obter status do time tracking:', error);
                return null;
            }
        }

        // Atualizar displays de tempo nas tarefas
        function updateTrackingDisplays() {
            const now = new Date();

            activeTrackings.forEach((tracking, taskId) => {
                const minutosDecorridos = Math.round((now - tracking.startTime) / (1000 * 60));
                tracking.minutosAtivos = minutosDecorridos;

                const timerElement = document.getElementById(`timer-display-${taskId}`);
                if (timerElement) {
                    const horas = Math.floor(minutosDecorridos / 60);
                    const minutos = minutosDecorridos % 60;
                    timerElement.textContent = `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;
                }
            });
        }

        // Atualizar painel de trackings ativos
        function updateActiveTrackingPanel() {
            const panel = document.getElementById('activeTrackingPanel');
            if (!panel) return;

            if (activeTrackings.size === 0) {
                panel.style.display = 'none';
                return;
            }

            panel.style.display = 'block';
            const list = document.getElementById('activeTrackingList');
            list.innerHTML = '';

            activeTrackings.forEach((tracking, taskId) => {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    const horas = Math.floor(tracking.minutosAtivos / 60);
                    const minutos = tracking.minutosAtivos % 60;

                    const item = document.createElement('div');
                    item.className = 'active-tracking-item';
                    item.innerHTML = `
                <div class="active-task-title">${task.title}</div>
                <div class="active-task-time">${horas}h ${minutos}m</div>
            `;
                    list.appendChild(item);
                }
            });
        }

        // Adicionar interface de time tracking √†s tarefas
        function enhanceTaskCardWithTimeTracking(task) {
            const taskElement = document.querySelector(`[data-task-id="${task.id}"]`);
            if (!taskElement) return;

            // Remover interface existente
            const existingInterface = taskElement.querySelector('.time-tracking-container');
            if (existingInterface) {
                existingInterface.remove();
            }

            const timeTrackingHTML = `
        <div class="time-tracking-container" id="time-tracking-${task.id}">
            <div class="time-tracking-header">
                <div class="time-tracking-title">‚è±Ô∏è Controle de Tempo</div>
                <div class="time-session-info" id="timer-display-${task.id}" style="display: none;">
                    Tempo atual: <span id="timer-time-${task.id}">00:00</span>
                </div>
            </div>
            
            <div class="time-tracking-stats">
                <div class="time-stat">
                    <div class="time-stat-value">${formatTimeMinutes(task.time_spent_minutes || 0)}</div>
                    <div class="time-stat-label">Total Gasto</div>
                </div>
                <div class="time-stat">
                    <div class="time-stat-value">${task.estimate_hours || 0}h</div>
                    <div class="time-stat-label">Estimado</div>
                </div>
            </div>
            
            <div class="time-tracking-actions">
                <button class="btn-timer btn-timer-start" 
                        onclick="startTimeTracking(${task.id})"
                        id="start-btn-${task.id}">
                    <i class="fas fa-play"></i> Iniciar
                </button>
                <button class="btn-timer btn-timer-stop" 
                        onclick="stopTimeTracking(${task.id})"
                        id="stop-btn-${task.id}"
                        disabled>
                    <i class="fas fa-stop"></i> Parar
                </button>
            </div>
        </div>
    `;

            // Inserir antes dos bot√µes de a√ß√£o
            const actionButtons = taskElement.querySelector('div[style*="margin-top: 10px"]');
            if (actionButtons) {
                actionButtons.insertAdjacentHTML('beforebegin', timeTrackingHTML);
            } else {
                taskElement.insertAdjacentHTML('beforeend', timeTrackingHTML);
            }

            // Atualizar estado dos bot√µes
            updateTimeTrackingButtons(task.id);
        }

        // Atualizar estado dos bot√µes de time tracking
        async function updateTimeTrackingButtons(taskId) {
            const status = await getTimeTrackingStatus(taskId);
            const startBtn = document.getElementById(`start-btn-${taskId}`);
            const stopBtn = document.getElementById(`stop-btn-${taskId}`);
            const timerDisplay = document.getElementById(`timer-display-${taskId}`);

            if (status && status.tracking_ativo) {
                startBtn.disabled = true;
                stopBtn.disabled = false;
                if (timerDisplay) timerDisplay.style.display = 'block';

                // Adicionar classe de anima√ß√£o ao card da tarefa
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskElement) {
                    taskElement.classList.add('timer-active');
                }
            } else {
                startBtn.disabled = false;
                stopBtn.disabled = true;
                if (timerDisplay) timerDisplay.style.display = 'none';

                // Remover classe de anima√ß√£o
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskElement) {
                    taskElement.classList.remove('timer-active');
                }
            }
        }

        // Formatar minutos para exibi√ß√£o
        function formatTimeMinutes(minutos) {
            const horas = Math.floor(minutos / 60);
            const mins = minutos % 60;

            if (horas > 0) {
                return `${horas}h ${mins}m`;
            } else {
                return `${mins}m`;
            }
        }

        // Abrir modal de relat√≥rios
        async function openTimeReports() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
                if (!currentUser) {
                    showNotification('Usu√°rio n√£o autenticado!', 'error');
                    return;
                }

                const response = await fetch(`/api/timetracking/relatorio?user_id=${currentUser.id}`);
                const data = await response.json();

                if (data.success) {
                    showTimeReportsModal(data.relatorio, data.estatisticas);
                } else {
                    showNotification('Erro ao carregar relat√≥rios', 'error');
                }
            } catch (error) {
                console.error('Erro ao abrir relat√≥rios:', error);
                showNotification('Erro ao carregar relat√≥rios', 'error');
            }
        }

        // Mostrar modal de relat√≥rios
        function showTimeReportsModal(relatorio, estatisticas) {
            const modalHTML = `
        <div class="modal show" id="timeReportsModal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2>üìä Relat√≥rio de Produtividade</h2>
                    <button class="close-modal" onclick="closeModal('timeReportsModal')">&times;</button>
                </div>
                
                <div class="reports-grid">
                    <div class="report-card">
                        <div class="report-value">${estatisticas.total_tarefas || 0}</div>
                        <div class="report-label">Tarefas Trabalhadas</div>
                    </div>
                    <div class="report-card">
                        <div class="report-value">${formatTimeMinutes(estatisticas.total_minutos_geral || 0)}</div>
                        <div class="report-label">Tempo Total</div>
                    </div>
                    <div class="report-card">
                        <div class="report-value">${estatisticas.total_sessoes_geral || 0}</div>
                        <div class="report-label">Sess√µes de Trabalho</div>
                    </div>
                    <div class="report-card">
                        <div class="report-value">${Math.round(estatisticas.media_por_sessao || 0)}m</div>
                        <div class="report-label">M√©dia por Sess√£o</div>
                    </div>
                </div>
                
                <h3 style="margin: 20px 0 10px 0;">Detalhamento por Tarefa</h3>
                <div class="time-sessions-list">
                    ${relatorio.length > 0 ? relatorio.map(item => `
                        <div class="session-item">
                            <div>
                                <strong>${item.task_title}</strong>
                                <div style="font-size: 0.8rem; color: var(--text-medium);">
                                    ${item.column_name} ‚Ä¢ ${new Date(item.data).toLocaleDateString('pt-BR')}
                                </div>
                            </div>
                            <div class="session-duration">
                                ${formatTimeMinutes(item.total_minutos)}
                            </div>
                        </div>
                    `).join('') : '<p style="text-align: center; color: var(--text-medium);">Nenhum dado encontrado</p>'}
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-primary" onclick="exportTimeReport()">
                        <i class="fas fa-download"></i> Exportar Relat√≥rio
                    </button>
                </div>
            </div>
        </div>
    `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Fechar modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        // Exportar relat√≥rio
        async function exportTimeReport() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
                if (!currentUser) return;

                const response = await fetch(`/api/timetracking/relatorio?user_id=${currentUser.id}`);
                const data = await response.json();

                if (data.success) {
                    const csvContent = generateCSV(data.relatorio, data.estatisticas);
                    downloadCSV(csvContent, `relatorio_produtividade_${new Date().toISOString().split('T')[0]}.csv`);
                    showNotification('Relat√≥rio exportado com sucesso!', 'success');
                }
            } catch (error) {
                console.error('Erro ao exportar relat√≥rio:', error);
                showNotification('Erro ao exportar relat√≥rio', 'error');
            }
        }

        // Gerar CSV
        function generateCSV(relatorio, estatisticas) {
            let csv = 'Relat√≥rio de Produtividade\n\n';
            csv += 'Estat√≠sticas Gerais:\n';
            csv += `Tarefas Trabalhadas,${estatisticas.total_tarefas || 0}\n`;
            csv += `Tempo Total,${formatTimeMinutes(estatisticas.total_minutos_geral || 0)}\n`;
            csv += `Sess√µes de Trabalho,${estatisticas.total_sessoes_geral || 0}\n`;
            csv += `M√©dia por Sess√£o,${Math.round(estatisticas.media_por_sessao || 0)} minutos\n\n`;

            csv += 'Detalhamento por Tarefa:\n';
            csv += 'Tarefa,Coluna,Data,Tempo Gasto,Sess√µes\n';

            relatorio.forEach(item => {
                csv += `"${item.task_title}","${item.column_name}","${item.data}","${formatTimeMinutes(item.total_minutos)}","${item.total_sessoes}"\n`;
            });

            return csv;
        }

        // Download CSV
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }



        async function saveTask(event) {
            event.preventDefault();

            // VERIFICA√á√ÉO DE SEGURAN√áA - evitar m√∫ltiplos envios
            const saveBtn = document.getElementById('saveTaskBtn');
            if (saveBtn.disabled) {
                return; // J√° est√° processando, n√£o fazer nada
            }

            saveBtn.innerHTML = '<div class="loading"></div> Salvando...';
            saveBtn.disabled = true;

            try {
                const taskId = document.getElementById('taskId').value;
                const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));

                let taskData = {
                    title: document.getElementById('taskTitle').value,
                    description: document.getElementById('taskDescription').value,
                    priority: document.getElementById('taskPriority').value,
                    due_date: document.getElementById('taskDueDate').value || null,
                    assignee_id: document.getElementById('taskAssignee').value || null,
                    tags: document.getElementById('taskTags').value,
                    estimate_hours: document.getElementById('taskEstimate').value || 0,
                    column_id: document.getElementById('taskColumn').value,
                    created_by: currentUser.id,
                    user_id: currentUser.id, // Adicionar user_id
                    user_permissao: currentUser.permission // Adicionar user_permissao
                };

                // PARA N√ÉO-ADMINS: FOR√áAR O USU√ÅRIO ATUAL COMO RESPONS√ÅVEL
                if (currentUser.permission !== 'admin') {
                    taskData.assignee_id = currentUser.id;
                }

                let response;
                let url;

                if (taskId) {
                    // VERIFICAR PERMISS√ÉO PARA EDITAR
                    const task = tasks.find(t => t.id == taskId);
                    if (task && !canUserEditTask(task)) {
                        throw new Error('Voc√™ n√£o tem permiss√£o para editar esta tarefa!');
                    }

                    url = `/api/kanban/tasks/editar/${taskId}`;
                    response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(taskData)
                    });
                } else {
                    url = '/api/kanban/tasks/adicionar';
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(taskData)
                    });
                }

                const data = await response.json();

                if (data.success) {
                    showNotification(data.message, 'success');
                    closeTaskModal();
                    await loadTasks();
                    renderBoard();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Erro ao salvar tarefa:', error);
                showNotification('Erro ao salvar tarefa: ' + error.message, 'error');
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        async function deleteTask(taskId) {
            if (confirm('Tem certeza que deseja excluir esta tarefa?')) {
                try {
                    const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));

                    // Verificar permiss√£o
                    const task = tasks.find(t => t.id === taskId);
                    if (task && !canUserEditTask(task)) {
                        showNotification('Voc√™ n√£o tem permiss√£o para excluir esta tarefa!', 'error');
                        return;
                    }

                    const response = await fetch(`/api/kanban/tasks/excluir/${taskId}?user_id=${currentUser.id}&user_permissao=${currentUser.permission}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (data.success) {
                        showNotification(data.message, 'success');
                        await loadTasks();
                        renderBoard();
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    console.error('Erro ao excluir tarefa:', error);
                    showNotification('Erro ao excluir tarefa', 'error');
                }
            }
        }

        function addTaskToColumn(columnId) {
            openTaskModal(columnId);
        }

        // Drag and Drop
        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.getAttribute('data-task-id'));
            ev.target.classList.add('dragging');
        }

        async function drop(ev) {
            ev.preventDefault();
            const taskId = ev.dataTransfer.getData("text");
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));

            if (taskElement) {
                taskElement.classList.remove('dragging');
                const columnElement = ev.currentTarget.closest('.kanban-column');
                const newColumnId = columnElement.getAttribute('data-column-id');
                const newColumnName = columnElement.querySelector('.column-title h3').innerText; // PEGANDO O NOME DA COLUNA

                const task = tasks.find(t => t.id == taskId);

                if (task && task.column_id != newColumnId) {
                    try {
                        // Verificar permiss√£o antes de mover
                        if (!canUserEditTask(task)) {
                            showNotification('Voc√™ n√£o tem permiss√£o para mover esta tarefa!', 'error');
                            return;
                        }

                        const response = await fetch(`/api/kanban/tasks/mover/${taskId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                column_id: newColumnId,
                                user_id: currentUser.id,
                                user_permissao: currentUser.permission
                            })
                        });

                        const data = await response.json();
                        if (data.success) {
                            // SE MOVEU PARA CONCLU√çDO, GERA XP (GAMIFICA√á√ÉO)
                            if (newColumnName === 'Conclu√≠do') {
                                rewardUserPoints(parseInt(taskId));
                            }
                            await loadTasks();
                            renderBoard();
                        }
                    } catch (error) {
                        console.error('Erro ao mover:', error);
                    }
                }
            }
        }

        function setupDragAndDrop() {
            document.querySelectorAll('.task-card').forEach(card => {
                card.addEventListener('dragend', function () {
                    this.classList.remove('dragging');
                });
            });
        }

        // Filtros e Busca
        function searchTasks() {
            currentSearch = document.getElementById('searchInput').value.toLowerCase();
            renderBoard();
        }

        function filterTasks() {
            currentPriorityFilter = document.getElementById('priorityFilter').value;
            currentAssigneeFilter = document.getElementById('assigneeFilter').value;
            renderBoard();
        }

        function isTaskVisible(task) {
            const matchesSearch = !currentSearch ||
                task.title.toLowerCase().includes(currentSearch) ||
                (task.description && task.description.toLowerCase().includes(currentSearch)) ||
                (task.tags && task.tags.toLowerCase().includes(currentSearch));

            const matchesPriority = currentPriorityFilter === 'all' || task.priority === currentPriorityFilter;
            const matchesAssignee = currentAssigneeFilter === 'all' || task.assignee_id == currentAssigneeFilter;

            return matchesSearch && matchesPriority && matchesAssignee;
        }

        // Fun√ß√µes auxiliares
        async function loadBoard() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div> Atualizando...';
            btn.disabled = true;

            try {
                await initializeBoard();
                showNotification('Quadro atualizado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao atualizar board:', error);
                showNotification('Erro ao atualizar quadro', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function exportBoard() {
            const dataStr = JSON.stringify({
                tasks: tasks,
                columns: columns,
                exported_at: new Date().toISOString()
            }, null, 2);

            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `kanban-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showNotification('Quadro exportado com sucesso!', 'success');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--drogasil-red)'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: var(--shadow-heavy);
                z-index: 3000;
                animation: slideInRight 0.3s ease-out;
                max-width: 400px;
                word-wrap: break-word;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 4000);
        }

        function logout() {
            const user = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
            if (user) {
                // Registrar log de logout
                fetch('/api/logs/registrar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        matricula: user.matricula,
                        action: 'LOGOUT',
                        details: 'Logout realizado do sistema Kanban'
                    })
                }).catch(console.error);
            }

            localStorage.removeItem('sistema_drogasil_usuario_atual');
            window.location.href =
                'login.html';
        }


        // Fun√ß√£o para verificar quais tarefas o usu√°rio pode ver
        function getVisibleTasks(allTasks) {
            if (currentUser.permission === 'admin') {
                return allTasks; // Admin v√™ todas as tarefas
            }

            // N√£o-admins veem apenas suas pr√≥prias tarefas
            return allTasks.filter(task =>
                task.created_by === currentUser.id ||
                task.assignee_id === currentUser.id
            );
        }

        // Atualizar a fun√ß√£o renderBoard para usar filtro de permiss√£o
        function renderBoard() {
            const board = document.getElementById('kanbanBoard');
            board.innerHTML = '';

            // FILTRAR TAREFAS VIS√çVEIS BASEADO NA PERMISS√ÉO
            const visibleTasks = getVisibleTasks(tasks);

            columns.forEach(column => {
                const columnTasks = visibleTasks.filter(task =>
                    task.column_id === column.id &&
                    isTaskVisible(task)
                );

                // Resto do c√≥digo permanece igual...
                const columnElement = document.createElement('div');
                columnElement.className = `kanban-column column-${getColumnClass(column.name)}`;
                columnElement.setAttribute('data-column-id', column.id);
                columnElement.setAttribute('ondrop', 'drop(event)');
                columnElement.setAttribute('ondragover', 'allowDrop(event)');

                columnElement.innerHTML = `
            <div class="column-header">
                <div class="column-title">
                    <h3>${column.name}</h3>
                    <span class="task-count">${columnTasks.length}</span>
                </div>
                <div class="column-actions">
                    <button class="btn-icon" onclick="addTaskToColumn(${column.id})" title="Adicionar Tarefa">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="tasks-container" id="tasks-${column.id}">
                ${columnTasks.length === 0 ? `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>Nenhuma tarefa</p>
                    </div>
                ` : columnTasks.map(task => createTaskCard(task)).join('')}
            </div>
        `;

                board.appendChild(columnElement);
            });

            setupDragAndDrop();
            setupTaskPermissions();
        }


        // ========== SISTEMA DE PERMISS√ïES MELHORADO ==========

        // Mapeamento de permiss√µes por n√≠vel
        const permissionLevels = {
            'admin': {
                name: 'Administrador',
                permissions: ['all'], // Acesso total
                can_manage_users: true,
                can_view_all_tasks: true,
                can_edit_all_tasks: true,
                can_delete_all_tasks: true
            },
            'gestor': {
                name: 'Gestor',
                permissions: ['gestao_cd', 'gestao_ti', 'kanban', 'projetos', 'inventario'],
                can_manage_users: false,
                can_view_all_tasks: true, // Gestores podem ver todas as tarefas do seu departamento
                can_edit_all_tasks: false,
                can_delete_all_tasks: false
            },
            'supervisor': {
                name: 'Supervisor',
                permissions: ['gestao_cd', 'kanban', 'checklist'],
                can_manage_users: false,
                can_view_all_tasks: false,
                can_edit_all_tasks: false,
                can_delete_all_tasks: false
            },
            'analista': {
                name: 'Analista',
                permissions: ['gestao_ti', 'inventario', 'projetos'],
                can_manage_users: false,
                can_view_all_tasks: false,
                can_edit_all_tasks: false,
                can_delete_all_tasks: false
            },
            'operador': {
                name: 'Operador',
                permissions: ['kanban', 'checklist'],
                can_manage_users: false,
                can_view_all_tasks: false,
                can_edit_all_tasks: false,
                can_delete_all_tasks: false
            }
        };

        // Fun√ß√£o para verificar permiss√µes
        function userHasPermission(module) {
            const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));

            if (!currentUser) return false;

            const userLevel = permissionLevels[currentUser.permission];
            if (!userLevel) return false;

            // Admin tem acesso a tudo
            if (userLevel.permissions.includes('all')) return true;

            // Verificar permiss√£o espec√≠fica
            return userLevel.permissions.includes(module);
        }

        // Fun√ß√£o para obter informa√ß√µes de permiss√£o do usu√°rio atual
        function getCurrentUserPermissions() {
            const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
            if (!currentUser) return null;

            return {
                id: currentUser.id,
                name: currentUser.name,
                matricula: currentUser.matricula,
                permission: currentUser.permission,
                ...permissionLevels[currentUser.permission]
            };
        }

        // Aplicar permiss√µes na interface
        function applyUserPermissions() {
            const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
            const userPerms = getCurrentUserPermissions();

            if (!currentUser || !userPerms) return;

            // Aplicar √†s se√ß√µes principais
            const sections = {
                'gestao_cd': document.querySelector('.gestao-cd'),
                'gestao_ti': document.querySelector('.gestao-ti')
            };

            Object.keys(sections).forEach(section => {
                if (sections[section]) {
                    if (!userHasPermission(section)) {
                        sections[section].classList.add('no-permission');
                    } else {
                        sections[section].classList.remove('no-permission');
                    }
                }
            });

            // Mostrar/ocultar bot√µes administrativos
            const adminButtons = [
                document.getElementById('adminFloatingBtn'),
                document.getElementById('listUsersBtn')
            ];

            adminButtons.forEach(btn => {
                if (btn) {
                    if (userPerms.can_manage_users) {
                        btn.classList.add('show');
                    } else {
                        btn.classList.remove('show');
                    }
                }
            });
        }

        // Fun√ß√£o para salvar informa√ß√µes do usu√°rio com permiss√µes completas
        function saveUserWithPermissions(userData) {
            const userWithPermissions = {
                ...userData,
                ...permissionLevels[userData.permission]
            };
            localStorage.setItem('sistema_drogasil_usuario_atual', JSON.stringify(userWithPermissions));
        }

        // Atualizar o carregamento inicial
        document.addEventListener('DOMContentLoaded', function () {
            const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
            if (currentUser) {
                // Garantir que as permiss√µes est√£o atualizadas
                saveUserWithPermissions(currentUser);

                document.getElementById('user-display-name').textContent =
                    `${currentUser.name} (${currentUser.matricula}) - ${getPermissionLabel(currentUser.permission)}`;

                // Aplicar permiss√µes
                applyUserPermissions();

                // Carregar permiss√µes dispon√≠veis
                loadAvailablePermissions();

                // Testar conex√£o
                testarConexao();
            }
        });

        // ========== ATUALIZA√á√ïES PARA O KANBAN ==========

        // Fun√ß√£o para obter par√¢metros de autentica√ß√£o para APIs
        function getAuthParams() {
            const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
            if (!currentUser) return '';

            return `user_id=${currentUser.id}&user_permissao=${currentUser.permission}`;
        }

        // Fun√ß√£o para verificar se usu√°rio pode editar tarefa espec√≠fica
        // Fun√ß√£o para verificar se usu√°rio pode editar tarefa espec√≠fica
        function canUserEditTask(task) {
            const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
            if (!currentUser) return false;

            // Admin pode editar todas as tarefas
            if (currentUser.permission === 'admin') return true;

            // N√£o-admins s√≥ podem editar tarefas que criaram ou das quais s√£o respons√°veis
            return task.created_by === currentUser.id || task.assignee_id === currentUser.id;
        }

        // Fun√ß√£o para verificar se usu√°rio pode excluir tarefa espec√≠fica
        function canUserDeleteTask(task) {
            const userPerms = getCurrentUserPermissions();
            if (!userPerms) return false;

            if (userPerms.can_delete_all_tasks) return true;

            // Apenas o criador pode excluir (se n√£o for admin)
            return task.created_by === userPerms.id;
        }

        // Exemplo de como usar nas chamadas do Kanban:
        async function carregarTarefasKanban() {
            try {
                const authParams = getAuthParams();
                const data = await apiRequest(`/api/kanban/tasks?${authParams}`);

                if (data.success) {
                    // Processar tarefas - o backend j√° filtra baseado na permiss√£o
                    console.log('Tarefas carregadas:', data.tasks);
                    return data.tasks;
                }
            } catch (error) {
                console.error('Erro ao carregar tarefas:', error);
            }
        }

        // Adicione no final do script para debug
        function debugPermissions() {
            const currentUser = JSON.parse(localStorage.getItem('sistema_drogasil_usuario_atual'));
            console.log('Usu√°rio atual:', currentUser);
            console.log('Total de tarefas carregadas:', tasks.length);
            console.log('Tarefas do usu√°rio:', tasks.filter(t =>
                t.created_by === currentUser.id || t.assignee_id === currentUser.id
            ).length);
        }

        // Chame esta fun√ß√£o ap√≥s carregar as tarefas
        // debugPermissions(); // Descomente para debug




        ///////////////////////////////////////////////////////////////////////////

        // Vari√°veis para controle de alertas
        let alertInterval = null;
        let lastAlertTime = 0;
        const ALERT_COOLDOWN = 2 * 60 * 1000; // 2 minutos em milissegundos
        let criticalTasks = [];

        // Vari√°veis para controle de tempo
        let taskTimers = new Map();
        let timeUpdateInterval = null;

        // Inicializar sistema de alertas
        function initializeAlertSystem() {
            // Verificar tarefas a cada 30 segundos
            setInterval(checkCriticalTasks, 30000);

            // Verificar imediatamente ao carregar
            setTimeout(checkCriticalTasks, 5000);
        }

        // Inicializar sistema de tempo
        function initializeTimeSystem() {
            // Iniciar atualiza√ß√£o cont√≠nua dos timers
            timeUpdateInterval = setInterval(updateAllTaskTimers, 1000);

            // Atualizar stats a cada 30 segundos
            setInterval(updateTimeStats, 30000);

            // Atualizar imediatamente
            updateAllTaskTimers();
            updateTimeStats();
        }

        // Verificar tarefas cr√≠ticas
        function checkCriticalTasks() {
            const now = new Date();
            criticalTasks = [];

            tasks.forEach(task => {
                if (task.due_date && !isTaskCompleted(task)) {
                    const dueDate = new Date(task.due_date);
                    const timeDiff = dueDate - now;
                    const tenMinutes = 10 * 60 * 1000; // 10 minutos em milissegundos

                    if (timeDiff < 0) {
                        // Tarefa atrasada
                        criticalTasks.push({
                            task: task,
                            status: 'ATRASADA',
                            urgency: 'high'
                        });
                    } else if (timeDiff <= tenMinutes) {
                        // Tarefa prestes a expirar (10 minutos ou menos)
                        criticalTasks.push({
                            task: task,
                            status: 'EXPIRANDO',
                            urgency: 'medium'
                        });
                    }
                }
            });

            // Atualizar indicadores visuais nas tarefas
            updateTaskUrgencyIndicators();

            // Mostrar alerta se houver tarefas cr√≠ticas
            if (criticalTasks.length > 0) {
                const currentTime = Date.now();
                if (currentTime - lastAlertTime >= ALERT_COOLDOWN) {
                    showCriticalAlert();
                }
            }
        }

        // Atualizar indicadores visuais de urg√™ncia nas tarefas
        function updateTaskUrgencyIndicators() {
            // Remover indicadores anteriores
            document.querySelectorAll('.task-urgent').forEach(task => {
                task.classList.remove('task-urgent');
            });

            // Adicionar indicadores nas tarefas cr√≠ticas
            criticalTasks.forEach(critical => {
                const taskElement = document.querySelector(`[data-task-id="${critical.task.id}"]`);
                if (taskElement) {
                    taskElement.classList.add('task-urgent');
                }
            });
        }

        // Verificar se tarefa est√° conclu√≠da
        function isTaskCompleted(task) {
            const doneColumn = columns.find(col => col.name === 'Conclu√≠do' || col.name === 'Done');
            return doneColumn && task.column_id === doneColumn.id;
        }

        // Mostrar alerta cr√≠tico
        function showCriticalAlert() {
            const overlay = document.getElementById('alertOverlay');
            const container = document.getElementById('alertContainer');
            const taskList = document.getElementById('alertTaskList');
            const message = document.getElementById('alertMessage');

            if (criticalTasks.length === 0) return;

            // Atualizar mensagem baseada na quantidade de tarefas
            if (criticalTasks.length === 1) {
                message.textContent = 'H√° 1 tarefa que requer aten√ß√£o imediata!';
            } else {
                message.textContent = `H√° ${criticalTasks.length} tarefas que requerem aten√ß√£o imediata!`;
            }

            // Limpar e preencher lista de tarefas
            taskList.innerHTML = '';
            criticalTasks.forEach(critical => {
                const assignee = teamMembers.find(m => m.id === critical.task.assignee_id);
                const assigneeName = assignee ? assignee.nome : 'N√£o atribu√≠do';

                const taskItem = document.createElement('div');
                taskItem.className = 'alert-task-item';
                taskItem.innerHTML = `
                    <div class="alert-task-title">
                        <strong>${critical.task.title}</strong>
                        <div style="font-size: 0.8rem; opacity: 0.8;">Respons√°vel: ${assigneeName}</div>
                    </div>
                    <div class="alert-task-status">${critical.status}</div>
                `;
                taskList.appendChild(taskItem);
            });

            // Mostrar overlay
            overlay.classList.add('alert-show');

            // Reiniciar anima√ß√£o
            container.classList.remove('alert-pulse');
            void container.offsetWidth; // Trigger reflow
            container.classList.add('alert-pulse');

            // Atualizar tempo do √∫ltimo alerta
            lastAlertTime = Date.now();

            // Fechar automaticamente ap√≥s 10 segundos
            setTimeout(() => {
                closeAlert();
            }, 10000);
        }

        // Fechar alerta
        function closeAlert() {
            const overlay = document.getElementById('alertOverlay');
            overlay.classList.remove('alert-show');
        }

        // Navegar para tarefas cr√≠ticas
        function goToCriticalTasks() {
            closeAlert();

            // Focar na primeira tarefa cr√≠tica
            if (criticalTasks.length > 0) {
                const firstTask = criticalTasks[0].task;
                const taskElement = document.querySelector(`[data-task-id="${firstTask.id}"]`);

                if (taskElement) {
                    taskElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });

                    // Destacar a tarefa
                    taskElement.style.animation = 'taskPulse 1s 3';
                    setTimeout(() => {
                        taskElement.style.animation = '';
                    }, 3000);
                }
            }
        }

        // Calcular tempo restante para uma tarefa
        function calculateTimeRemaining(task) {
            if (!task.due_date && !task.time_limit_hours) {
                return null;
            }

            const now = new Date();
            let endTime;

            if (task.due_date) {
                // Usar data de vencimento
                endTime = new Date(task.due_date);
            } else if (task.time_limit_hours && task.start_time) {
                // Usar limite de horas a partir do in√≠cio
                const startTime = new Date(task.start_time);
                endTime = new Date(startTime.getTime() + (task.time_limit_hours * 60 * 60 * 1000));
            } else {
                return null;
            }

            const totalTime = endTime - (task.start_time ? new Date(task.start_time) : now);
            const remainingTime = endTime - now;
            const elapsedTime = totalTime - remainingTime;

            return {
                remaining: remainingTime,
                elapsed: elapsedTime,
                total: totalTime,
                percentage: Math.max(0, Math.min(100, (elapsedTime / totalTime) * 100)),
                isExpired: remainingTime <= 0
            };
        }

        // Atualizar todos os timers das tarefas
        function updateAllTaskTimers() {
            tasks.forEach(task => {
                updateTaskTimer(task);
            });
        }

        // Atualizar timer de uma tarefa espec√≠fica
        function updateTaskTimer(task) {
            const timerElement = document.querySelector(`[data-task-id="${task.id}"] .task-timer`);
            const timeInfo = calculateTimeRemaining(task);

            if (!timeInfo) {
                if (timerElement) {
                    timerElement.remove();
                }
                return;
            }

            if (!timerElement) {
                createTaskTimer(task, timeInfo);
            } else {
                updateTimerDisplay(task.id, timeInfo);
            }
        }

        // Criar elemento de timer para uma tarefa
        function createTaskTimer(task, timeInfo) {
            const taskElement = document.querySelector(`[data-task-id="${task.id}"]`);
            if (!taskElement) return;

            // Remover timer existente se houver
            const existingTimer = taskElement.querySelector('.task-timer');
            if (existingTimer) {
                existingTimer.remove();
            }

            const timerHtml = `
                <div class="task-timer" id="timer-${task.id}">
                    <i class="fas fa-clock timer-icon"></i>
                    <div class="timer-time" id="timer-time-${task.id}">
                        ${formatTimeRemaining(timeInfo.remaining)}
                    </div>
                    <div class="timer-progress">
                        <div class="timer-progress-bar" id="timer-bar-${task.id}" 
                             style="width: ${timeInfo.percentage}%"></div>
                    </div>
                </div>
            `;

            // Inserir antes dos bot√µes de a√ß√£o
            const actionButtons = taskElement.querySelector('div[style*="margin-top: 10px"]');
            if (actionButtons) {
                actionButtons.insertAdjacentHTML('beforebegin', timerHtml);
            } else {
                taskElement.insertAdjacentHTML('beforeend', timerHtml);
            }

            updateTimerDisplay(task.id, timeInfo);
        }

        // Atualizar display do timer
        function updateTimerDisplay(taskId, timeInfo) {
            const timerElement = document.getElementById(`timer-${taskId}`);
            const timeElement = document.getElementById(`timer-time-${taskId}`);
            const barElement = document.getElementById(`timer-bar-${taskId}`);

            if (!timerElement || !timeElement || !barElement) return;

            // Atualizar texto do tempo
            timeElement.textContent = formatTimeRemaining(timeInfo.remaining);

            // Atualizar barra de progresso
            barElement.style.width = `${timeInfo.percentage}%`;

            // Atualizar classe baseada no status do tempo
            timerElement.className = 'task-timer';

            if (timeInfo.isExpired) {
                timerElement.classList.add('timer-expired');
            } else if (timeInfo.remaining <= 10 * 60 * 1000) { // 10 minutos
                timerElement.classList.add('timer-critical');
            } else if (timeInfo.remaining <= 60 * 60 * 1000) { // 1 hora
                timerElement.classList.add('timer-warning');
            } else {
                timerElement.classList.add('timer-normal');
            }
        }

        // Formatar tempo restante
        function formatTimeRemaining(milliseconds) {
            if (milliseconds <= 0) {
                return 'Expirado';
            }

            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) {
                return `${days}d ${hours % 24}h`;
            } else if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // Atualizar estat√≠sticas de tempo
        function updateTimeStats() {
            const statsElement = document.getElementById('timeStats');
            if (!statsElement) return;

            const now = new Date();
            const criticalTasks = tasks.filter(task => {
                const timeInfo = calculateTimeRemaining(task);
                return timeInfo && timeInfo.remaining > 0 && timeInfo.remaining <= 10 * 60 * 1000;
            });

            const expiredTasks = tasks.filter(task => {
                const timeInfo = calculateTimeRemaining(task);
                return timeInfo && timeInfo.isExpired;
            });

            const totalTimedTasks = tasks.filter(task => calculateTimeRemaining(task)).length;

            statsElement.innerHTML = `
                <div>Tarefas com tempo: ${totalTimedTasks}</div>
                <div style="color: var(--danger);">Cr√≠ticas: ${criticalTasks.length}</div>
                <div style="color: #990000;">Expiradas: ${expiredTasks.length}</div>
                <div style="margin-top: 5px; font-size: 0.7rem; opacity: 0.7;">
                    ${now.toLocaleTimeString('pt-BR')}
                </div>
            `;
        }

        // Adicionar campos de tempo no modal de tarefa
        function enhanceTaskModalWithTime() {
            // Adicionar campos de tempo no formul√°rio (ser√° chamado quando o modal for aberto)
            const form = document.getElementById('taskForm');

            // Verificar se os campos j√° existem
            if (!document.getElementById('timeLimitHours')) {
                const timeFieldsHtml = `
                    <div class="form-row">
                        <div class="form-group">
                            <label for="timeLimitHours">Tempo Limite (horas)</label>
                            <input type="number" class="form-control" id="timeLimitHours" 
                                   min="1" max="720" placeholder="Horas para conclus√£o">
                        </div>
                        <div class="form-group">
                            <label for="startTime">In√≠cio da Tarefa</label>
                            <input type="datetime-local" class="form-control" id="startTime">
                        </div>
                    </div>
                    <div class="time-summary" id="timeSummary" style="display: none;">
                        Tempo total: <span id="totalTimeDisplay">0 horas</span>
                    </div>
                `;

                // Inserir antes do campo de coluna
                const columnField = document.getElementById('taskColumn').closest('.form-group');
                columnField.insertAdjacentHTML('beforebegin', timeFieldsHtml);

                // Adicionar event listeners
                document.getElementById('timeLimitHours').addEventListener('input', updateTimeSummary);
                document.getElementById('startTime').addEventListener('change', updateTimeSummary);
            }
        }

        // Atualizar resumo de tempo
        function updateTimeSummary() {
            const hours = parseInt(document.getElementById('timeLimitHours').value) || 0;
            const startTime = document.getElementById('startTime').value;
            const summaryElement = document.getElementById('timeSummary');
            const totalTimeDisplay = document.getElementById('totalTimeDisplay');

            if (hours > 0) {
                summaryElement.style.display = 'block';
                totalTimeDisplay.textContent = `${hours} hora${hours !== 1 ? 's' : ''}`;

                if (startTime) {
                    const start = new Date(startTime);
                    const end = new Date(start.getTime() + (hours * 60 * 60 * 1000));
                    totalTimeDisplay.textContent += ` (at√© ${end.toLocaleString('pt-BR')})`;
                }
            } else {
                summaryElement.style.display = 'none';
            }
        }

        // Modificar a fun√ß√£o openTaskModal para incluir tempo
        const originalOpenTaskModal = openTaskModal;
        openTaskModal = function (columnId = null) {
            originalOpenTaskModal(columnId);
            enhanceTaskModalWithTime();

            // Preencher campos de tempo se estiver editando
            const taskId = document.getElementById('taskId').value;
            if (taskId) {
                const task = tasks.find(t => t.id == taskId);
                if (task) {
                    if (task.time_limit_hours) {
                        document.getElementById('timeLimitHours').value = task.time_limit_hours;
                    }
                    if (task.start_time) {
                        document.getElementById('startTime').value = task.start_time.substring(0, 16);
                    }
                    updateTimeSummary();
                }
            }
        };

        // Inicializar sistemas quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function () {
            // ... c√≥digo existente ...

            // Inicializar sistemas ap√≥s carregar as tarefas
            setTimeout(() => {
                initializeAlertSystem();
                initializeTimeSystem();
            }, 2000);
        });

        // Atualizar a fun√ß√£o loadTasks para iniciar timers
        const originalLoadTasks = loadTasks;


        // L√≥gica de Ganho de XP
        async function rewardUserPoints(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            // C√°lculo sugerido: Pontos base + B√¥nus de Prioridade 
            // XP = $ (Horas Estimadas \times 10) + (Prioridade \times 5) $
            let priorityBonus = task.priority === 'high' ? 20 : (task.priority === 'medium' ? 10 : 5);
            let xpGained = (task.estimate_hours * 10) + priorityBonus;

            // Chamar API para salvar progresso (Voc√™ precisar√° criar esta rota no app2.py)
            console.log(`Parab√©ns! Voc√™ ganhou ${xpGained} XP por concluir: ${task.title}`);
            showNotification(`+${xpGained} XP! Continue assim.`, 'success');
        }

        // Modificar a fun√ß√£o drop para disparar a recompensa
        async function drop(ev) {
            // ... (sua l√≥gica de movimento existente) 
            if (newColumnName === 'Conclu√≠do') {
                rewardUserPoints(taskId);
            }
        }

    </script>

    <!-- === NOVOS COMPONENTES HTML - COLE AQUI === -->

    <!-- Overlay de Alerta -->
    <div class="alert-overlay" id="alertOverlay">
        <div class="alert-container alert-pulse" id="alertContainer">
            <div class="alert-title">
                <i class="fas fa-exclamation-triangle"></i>
                SEU PREGUI√áOSO VAGABUNDO, VAI TRABALHAR!
            </div>
            <div class="alert-message" id="alertMessage">
                Existem tarefas que requerem aten√ß√£o imediata!
            </div>
            <div class="alert-task-list" id="alertTaskList">
                <!-- As tarefas cr√≠ticas ser√£o inseridas aqui -->
            </div>
            <div class="alert-actions">
                <button class="alert-btn alert-btn-primary" onclick="goToCriticalTasks()">
                    <i class="fas fa-tasks"></i> Ver Tarefas
                </button>
                <button class="alert-btn alert-btn-secondary" onclick="closeAlert()">
                    <i class="fas fa-times"></i> Fechar (2min)
                </button>
            </div>
        </div>
    </div>

    <!-- Painel de Controle de Tempo -->
    <div class="time-control-panel" id="timeControlPanel">
        <div class="time-control-header">
            <i class="fas fa-clock"></i>
            Controle de Tempo
        </div>
        <div class="time-control-stats" id="timeStats">
            Carregando...
        </div>
    </div>

    <!-- === FIM DOS NOVOS COMPONENTES HTML === -->

    <!-- Painel de Trackings Ativos -->
    <div class="active-tracking-panel" id="activeTrackingPanel" style="display: none;">
        <div class="active-tracking-header">
            <i class="fas fa-clock"></i>
            Trackings Ativos
        </div>
        <div id="activeTrackingList">
            <!-- Trackings ativos ser√£o inseridos aqui -->
        </div>
    </div>


</body>

</html>