<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hayden Estacionamentos | Gestão HYD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const _supabase = supabase.createClient('https://rwrlhccfltspvqwivuem.supabase.co/', 'sb_publishable_ybAZuMlyoJkPC0g4dRWvfg_IGj0Z7MG');
    </script>
    <link
        href="https://fonts.googleapis.com/css2?family=Overpass+Mono:wght@700&family=Overpass:wght@300;400;600;800;900&display=swap"
        rel="stylesheet">
    <style>
        /* Força visual de caixa alta em todos os inputs */
        input {
            text-transform: uppercase;
        }

        body {
            font-family: 'Overpass', sans-serif;
        }

        /* Fonte específica para placas e valores financeiros */
        .font-mono,
        input#placa,
        input#input-placa-busca,
        .text-emerald-600 {
            font-family: 'Overpass Mono', monospace !important;
            letter-spacing: -0.05em;
        }

        #input-placa-busca {
            letter-spacing: 0.15em;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .toast-active {
            transform: translateY(0);
            opacity: 1;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #print-section,
            #print-section * {
                visibility: visible;
            }

            #print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }

        @keyframes pulse-green {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .active-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse-green 2s infinite;
        }

        /* Scrollbar personalizada e elegante */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #cbd5e1;
        }

        /* Garante que o cabeçalho fixo não suma com o fundo */
        thead.sticky th {
            background: #f8fafc;
            /* Mesma cor do fundo da tabela */
            border-bottom: 1px solid #f1f5f9;
        }


        /* Classes de status para o tempo */
        .status-normal {
            color: #10b981;
        }

        /* Verde */
        .status-alerta {
            color: #f59e0b;
        }

        /* Laranja */
        .status-critico {
            color: #ef4444;
        }

        /* Vermelho */

        #placa.border-rose-500 {
            border-width: 2px !important;
            animation: shake 0.5s;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        @keyframes pulse-red-border {
            0% {
                border-color: #e11d48;
                box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.7);
            }

            70% {
                border-color: #fb7185;
                box-shadow: 0 0 0 20px rgba(225, 29, 72, 0);
            }

            100% {
                border-color: #e11d48;
                box-shadow: 0 0 0 0 rgba(225, 29, 72, 0);
            }
        }

        #modalAlertaInadimplente .animate-pulse {
            animation: pulse-red-border 1.5s infinite;
        }

        .animate-pulse-amber {
            animation: pulse-amber-border 1.5s infinite;
        }

        .animate-pulse-green-border {
            animation: pulse-green-border 1.5s infinite;
        }

        @keyframes pulse-amber-border {
            0% {
                border-color: #f59e0b;
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
            }

            70% {
                border-color: #fbbf24;
                box-shadow: 0 0 0 20px rgba(245, 158, 11, 0);
            }

            100% {
                border-color: #f59e0b;
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
            }
        }

        @keyframes pulse-green-border {
            0% {
                border-color: #10b981;
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            70% {
                border-color: #34d399;
                box-shadow: 0 0 0 20px rgba(16, 185, 129, 0);
            }

            100% {
                border-color: #10b981;
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        /* Animações de Fade para o Modal */
        .modal-overlay {
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }

        .modal-content-box {
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
        }

        /* Estado de fechamento (suave) */
        .modal-hidden {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none;
        }

        .modal-scale-down {
            transform: scale(0.9) !important;
            opacity: 0 !important;
        }


        .card-saida-rapida {
            animation: fadeInScale 0.3s ease forwards;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Efeito de hover suave no card */
        .card-saida-rapida:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(79, 70, 229, 0.3);
        }
    </style>
</head>

<body class="bg-[#f8fafc] text-slate-900 min-h-screen">
    <div id="toast"
        class="fixed top-5 right-5 z-[3000] transform translate-y-[-20px] opacity-0 transition-all duration-300 pointer-events-none">
        <div
            class="bg-slate-900 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 border border-slate-700">
            <div id="toast-icon" class="text-emerald-400"></div>
            <p id="toast-message" class="font-medium text-sm"></p>
        </div>
    </div>

    <div id="auth-container" class="fixed inset-0 bg-slate-900 z-[2000] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl animate-in zoom-in-95 duration-300">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-black text-slate-800">Hayden<span class="text-indigo-600">Parking</span></h2>
                <p id="auth-title" class="text-slate-400 text-sm font-medium uppercase tracking-widest">Login de
                    Parceiro</p>
            </div>
            <div class="space-y-4">
                <input type="email" id="auth-email" placeholder="E-mail"
                    class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none">
                <input type="password" id="auth-password" placeholder="Senha"
                    class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none">
                <button onclick="handleAuthAction()" id="btn-auth-submit"
                    class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black shadow-lg transition-all">
                    ENTRAR NO SISTEMA
                </button>
                <button onclick="toggleAuthMode()" id="btn-toggle-auth"
                    class="w-full text-xs text-slate-400 font-bold uppercase tracking-widest pt-4">
                    Não tem conta? Cadastre seu Estacionamento
                </button>

                <div class="text-right px-2">
                    <button onclick="handleForgotPassword()"
                        class="text-[10px] text-indigo-500 font-bold uppercase tracking-widest hover:underline">
                        Esqueci minha senha
                    </button>
                </div>


                <button onclick="handleAuthAction()" id="btn-auth-submit" ...>
            </div>
        </div>
    </div>

    <div class="flex flex-col lg:flex-row min-h-screen">

        <aside class="w-full lg:w-72 bg-slate-900 text-white p-6 flex flex-col">
            <div class="flex items-center gap-3 mb-10">
                <div class="bg-indigo-500 p-2.5 rounded-xl"><i data-lucide="shield-check" class="w-6 h-6"></i></div>
                <h1 class="text-xl font-bold">Hayden<span class="text-indigo-400">Parking</span></h1>
            </div>

            <nav class="flex-1 space-y-1.5">
                <button onclick="switchTab('dashboard')" id="nav-dashboard"
                    class="w-full flex items-center gap-3 bg-white/10 p-3.5 rounded-xl transition-all">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 text-indigo-400"></i> Pátio Ativo
                </button>
                <button onclick="switchTab('agendamentos')" id="nav-agendamentos"
                    class="w-full flex items-center gap-3 text-slate-400 p-3.5 rounded-xl transition-all">
                    <i data-lucide="calendar-days" class="w-5 h-5"></i> Agendamentos
                </button>
                <button onclick="switchTab('servicos')" id="nav-servicos"
                    class="w-full flex items-center gap-3 text-slate-400 p-3.5 rounded-xl transition-all">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i> Catálogo/Estoque
                </button>
                <button onclick="switchTab('historico')" id="nav-historico"
                    class="w-full flex items-center gap-3 text-slate-400 p-3.5 rounded-xl transition-all">
                    <i data-lucide="history" class="w-5 h-5"></i> Histórico
                </button>
                <button onclick="toggleModal('modalConfig')"
                    class="w-full flex items-center gap-3 text-slate-400 p-3.5 rounded-xl transition-all">
                    <i data-lucide="settings" class="w-5 h-5"></i> Configurações
                </button>

                <button onclick="switchTab('perfil')" id="nav-perfil"
                    class="w-full flex items-center gap-3 text-slate-400 p-3.5 rounded-xl transition-all">
                    <i data-lucide="user-cog" class="w-5 h-5"></i> Minha Conta
                </button>

                <button onclick="switchTab('mensalistas')" id="nav-mensalistas"
                    class="w-full flex items-center gap-3 text-slate-400 p-3.5 rounded-xl transition-all">
                    <i data-lucide="users" class="w-5 h-5"></i> Mensalistas
                </button>
                <button onclick="switchTab('insights')" id="nav-insights"
                    class="w-full flex items-center gap-3 text-slate-400 p-3.5 rounded-xl transition-all">
                    <i data-lucide="line-chart" class="w-5 h-5"></i> Insights & BI
                </button>

                <div class="pt-4 mt-4 border-t border-white/10">
                    <button onclick="handleLogout()"
                        class="w-full flex items-center gap-3 text-rose-400 hover:bg-rose-500/10 p-3.5 rounded-xl transition-all font-bold">
                        <i data-lucide="log-out" class="w-5 h-5"></i> Sair do Sistema
                    </button>
                </div>
            </nav>

            <div class="mb-6 px-4 py-3 bg-white/5 rounded-2xl border border-white/10 text-center">
                <p class="text-[10px] uppercase font-bold text-slate-500 mb-1">Hora Atual</p>
                <div id="sidebar-clock" class="text-3xl font-bold text-indigo-400 font-mono tracking-widest">00:00:00
                </div>
            </div>

            <div class="mt-auto bg-indigo-500/10 rounded-2xl p-4 border border-indigo-500/20">
                <p class="text-[10px] uppercase font-bold text-indigo-400 mb-2">Ocupação</p>
                <div class="w-full bg-slate-800 rounded-full h-2 mb-2">
                    <div id="progressBar" class="bg-indigo-50 h-2 rounded-full transition-all"></div>
                </div>
                <p class="text-xs text-slate-400" id="progressText">Calculando...</p>
            </div>
        </aside>

        <main class="flex-1 p-4 lg:p-10">
            ```

            <div class="mt-auto bg-indigo-500/10 rounded-2xl p-4 border border-indigo-500/20">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-[10px] uppercase font-bold text-indigo-400">STATUS DO SISTEMA</p>
                    <span id="licenca-timer"
                        class="text-[9px] font-mono font-bold text-slate-500 italic">CARREGANDO...</span>
                </div>
                <div class="pt-2 border-t border-white/5 mt-2 flex justify-between items-center">
                    <p class="text-[9px] text-slate-500 font-mono uppercase">ID MÁQUINA:</p>
                    <p id="display-id-maquina" class="text-[9px] text-indigo-300 font-mono font-bold">--------</p>
                </div>
            </div>

            </aside>

            <main class="flex-1 p-4 lg:p-10">
                <div id="tab-dashboard" class="tab-content active">
                    <header class="flex justify-between items-center mb-10">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Pátio Ativo</h2>
                            <p class="text-slate-500 text-sm">Monitoramento em tempo real.</p>
                        </div>
                        <div class="bg-white px-6 py-3 rounded-2xl shadow-sm border border-slate-200 text-right">
                            <p class="text-[10px] uppercase font-bold text-slate-400">Caixa Total</p>
                            <p class="text-xl font-bold text-emerald-600" id="totalFinanceiro">R$ 0,00</p>
                        </div>
                    </header>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div class="lg:col-span-4">
                            <section class="bg-white p-6 rounded-[2rem] shadow-xl border border-slate-100">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="font-bold text-slate-800 uppercase text-xs tracking-widest">Registrar
                                        Entrada
                                    </h3>
                                    <button onclick="toggleModoSupervisor()" id="btn-supervisor"
                                        class="opacity-10 hover:opacity-100 text-slate-400 transition-all">
                                        <i data-lucide="shield-alert" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <div class="space-y-4">
                                    <input type="text" id="modelo" placeholder="Modelo do Veículo"
                                        class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                                    <input type="text" id="placa" maxlength="7" placeholder="PLACA"
                                        oninput="aplicarMascaraPlaca(this); verificarClienteInteligente(this.value, 'placa')"
                                        class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none font-mono font-bold uppercase focus:ring-2 focus:ring-indigo-500 transition-all">
                                    <input type="tel" id="telefone"
                                        oninput="mascaraTelefone(this); verificarClienteInteligente(this.value, 'telefone')"
                                        placeholder="(92) 9 9525-8724"
                                        class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all font-mono">
                                    <button onclick="cadastrarVeiculo()"
                                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-2 shadow-lg shadow-indigo-100 transition-all active:scale-95"><i
                                            data-lucide="play" class="w-5 h-5"></i> Iniciar Tempo</button>
                                </div>
                            </section>
                        </div>


                        <div class="lg:col-span-8">
                            <div class="bg-white rounded-[2rem] shadow-xl border border-slate-100 overflow-hidden">
                                <div class="max-h-[600px] overflow-y-auto overflow-x-auto custom-scrollbar">
                                    <table class="w-full text-left border-separate border-spacing-0">
                                        <thead class="sticky top-0 z-20 text-slate-400 text-[10px] uppercase font-bold">
                                            <tr>
                                                <th class="px-6 py-4">Veículo</th>
                                                <th class="px-6 py-4 text-center">Entrada</th>
                                                <th class="px-6 py-4 text-center">Permanência</th>
                                                <th class="px-6 py-4 text-center">Total Atual</th>
                                                <th class="px-6 py-4 text-right">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="patio" class="divide-y divide-slate-50">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>



                    <div class="mt-10 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div
                            class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-lg flex items-center gap-5">
                            <div class="bg-indigo-100 text-indigo-600 p-4 rounded-2xl"><i data-lucide="car"></i></div>
                            <div>
                                <p class="text-[10px] uppercase font-bold text-slate-400">Total em Vagas</p>
                                <p id="resumo-vagas" class="text-xl font-black text-slate-800">R$ 0,00</p>
                            </div>
                        </div>
                        <div
                            class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-lg flex items-center gap-5">
                            <div class="bg-emerald-100 text-emerald-600 p-4 rounded-2xl"><i
                                    data-lucide="shopping-bag"></i>
                            </div>
                            <div>
                                <p class="text-[10px] uppercase font-bold text-slate-400">Total em Extras</p>
                                <p id="resumo-produtos" class="text-xl font-black text-slate-800">R$ 0,00</p>
                            </div>
                        </div>

                    </div>
                </div>

                <div id="tab-historico" class="tab-content">
                    <header class="mb-10">
                        <h2 class="text-2xl font-bold text-slate-800">Histórico de Saídas</h2>
                        <p class="text-slate-500 text-sm">Registros de veículos que já deixaram o pátio.</p>
                    </header>
                    <div class="bg-white rounded-[2rem] shadow-xl overflow-hidden border border-slate-100">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50/50 text-slate-400 text-[10px] uppercase font-bold">
                                <tr>
                                    <th class="px-6 py-4">Veículo</th>
                                    <th class="px-6 py-4">Entrada</th>
                                    <th class="px-6 py-4">Saída</th>
                                    <th class="px-6 py-4 text-center">Tempo Total</th>
                                    <th class="px-6 py-4 text-right">Valor Pago</th>
                                </tr>
                            </thead>
                            <tbody id="lista-historico" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-agendamentos" class="tab-content">
                    <header class="mb-10">
                        <h2 class="text-2xl font-bold text-slate-800">Agendamentos</h2>
                        <p class="text-slate-500 text-sm">Gerencie as reservas e entradas futuras.</p>
                    </header>
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div class="lg:col-span-4">
                            <section class="bg-white p-6 rounded-[2rem] shadow-xl border border-slate-100">
                                <h3 class="font-bold text-slate-800 uppercase text-xs mb-6 tracking-widest">Nova Reserva
                                </h3>
                                <div class="space-y-4">
                                    <input type="text" id="agenda-modelo" placeholder="Modelo"
                                        class="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                                    <input type="text" id="agenda-placa" placeholder="Placa" maxlength="7"
                                        oninput="aplicarMascaraPlaca(this)"
                                        class="w-full p-4 bg-slate-50 border rounded-2xl outline-none uppercase font-mono font-bold">
                                    <input type="datetime-local" id="agenda-data"
                                        class="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                                    <button onclick="agendarVeiculo()"
                                        class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-indigo-700 transition-all active:scale-95">
                                        Confirmar Reserva
                                    </button>
                                </div>
                            </section>
                        </div>

                        <div class="lg:col-span-8">
                            <div class="bg-white rounded-[2rem] shadow-xl border border-slate-100 overflow-hidden">
                                <div class="max-h-[600px] overflow-y-auto custom-scrollbar">
                                    <table class="w-full text-left border-separate border-spacing-0">
                                        <thead
                                            class="sticky top-0 z-20 bg-slate-50 text-slate-400 text-[10px] uppercase font-bold">
                                            <tr>
                                                <th class="px-6 py-4">Veículo / Placa</th>
                                                <th class="px-6 py-4 text-center">Data/Hora Prevista</th>
                                                <th class="px-6 py-4 text-right">Ação</th>
                                            </tr>
                                        </thead>
                                        <tbody id="lista-agendamentos" class="divide-y divide-slate-50">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-servicos" class="tab-content">
                    <header class="mb-10">
                        <h2 class="text-2xl font-bold text-slate-800">Catálogo & Estoque</h2>
                    </header>
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div class="lg:col-span-4">
                            <section class="bg-white p-6 rounded-[2rem] shadow-xl border border-slate-100">
                                <h3 class="font-bold text-slate-800 uppercase text-xs mb-6">Novo Item</h3>
                                <div class="space-y-4">
                                    <input type="text" id="serv-nome" placeholder="Ex: Lavagem"
                                        class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">
                                    <input type="number" id="serv-preco" placeholder="Preço (R$)"
                                        class="w-full p-4 bg-slate-50 border rounded-2xl outline-none font-bold">
                                    <div class="bg-slate-50 p-4 rounded-2xl">
                                        <label class="flex items-center gap-2 cursor-pointer mb-3"><input
                                                type="checkbox" id="possui-estoque"
                                                onchange="document.getElementById('campo-estoque').classList.toggle('hidden')"
                                                class="w-5 h-5 accent-indigo-600"><span
                                                class="text-sm font-medium text-slate-600">Controlar
                                                Estoque?</span></label>
                                        <div id="campo-estoque" class="hidden"><input type="number" id="serv-qtd"
                                                placeholder="Qtd. em Estoque"
                                                class="w-full p-3 bg-white border rounded-xl outline-none"></div>
                                    </div>
                                    <button onclick="cadastrarServicoCatalogo()"
                                        class="w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl shadow-lg transition-all">Salvar
                                        Item</button>
                                </div>
                            </section>
                        </div>
                        <div class="lg:col-span-8">
                            <div id="catalogo-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        </div>
                    </div>
                </div>

                <div id="tab-mensalistas" class="tab-content">
                    <header class="mb-10 flex justify-between items-end">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Gestão de Mensalistas</h2>
                            <p class="text-slate-500 text-sm">Controle de planos e clientes recorrentes.</p>
                        </div>
                        <button onclick="switchTab('inadimplentes')"
                            class="bg-rose-50 text-rose-600 px-6 py-3 rounded-2xl font-bold text-xs uppercase tracking-widest hover:bg-rose-600 hover:text-white transition-all flex items-center gap-2 shadow-sm border border-rose-100">
                            <i data-lucide="user-x" class="w-4 h-4"></i> Ver Inadimplentes
                        </button>
                        <button onclick="enviarLembretesVencimento()"
                            class="bg-amber-50 text-amber-600 px-6 py-3 rounded-2xl font-bold text-xs uppercase tracking-widest hover:bg-amber-600 hover:text-white transition-all flex items-center gap-2 shadow-sm border border-amber-100">
                            <i data-lucide="bell-ring" class="w-4 h-4"></i> Lembrete (2 dias)
                        </button>
                    </header>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div class="lg:col-span-4">
                            <section class="bg-white p-6 rounded-[2rem] shadow-xl border border-slate-100">
                                <h3 class="font-bold text-slate-800 uppercase text-xs mb-6 tracking-widest">Novo
                                    Mensalista
                                </h3>
                                <div class="space-y-4">
                                    <input type="text" id="mens-nome" placeholder="Nome do Cliente"
                                        class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">
                                    <input type="text" id="mens-placa" maxlength="7" placeholder="PLACA"
                                        class="w-full p-4 bg-slate-50 border rounded-2xl outline-none font-mono font-bold uppercase">
                                    <input type="tel" id="mens-telefone" oninput="mascaraTelefone(this)"
                                        placeholder="(92) 9 9525-8724"
                                        class="w-full p-4 bg-slate-50 border rounded-2xl outline-none font-mono">

                                    <input type="text" id="mens-cpf" oninput="mascaraCPF(this)"
                                        placeholder="000.000.000-00"
                                        class="w-full p-4 bg-slate-50 border rounded-2xl outline-none font-mono">

                                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                                        <label
                                            class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">Quantidade
                                            de Placas (Vagas)</label>
                                        <div class="flex items-center gap-4">
                                            <input type="number" id="mens-qtd-placas" value="1" min="1"
                                                oninput="calcularPrevisaoMensalidade()"
                                                class="w-20 bg-transparent outline-none font-bold text-indigo-900 text-xl">
                                            <div class="flex-1 text-right">
                                                <p class="text-[9px] text-slate-400 uppercase font-bold">Valor do Plano
                                                </p>
                                                <p id="previzao-valor-mensal" class="text-indigo-600 font-black">R$ 0,00
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
                                        <label
                                            class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider mb-2 block">Vencimento
                                            do Plano</label>
                                        <input type="date" id="mens-vencimento"
                                            class="w-full bg-transparent outline-none font-bold text-indigo-900">
                                    </div>
                                    <button onclick="salvarMensalista()"
                                        class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-indigo-700 transition-all">Ativar
                                        Plano</button>
                                </div>
                            </section>
                        </div>

                        <div class="lg:col-span-8">
                            <div class="bg-white rounded-[2rem] shadow-xl border border-slate-100 overflow-hidden">
                                <table class="w-full text-left border-separate border-spacing-0">
                                    <thead class="bg-slate-50/50 text-slate-400 text-[10px] uppercase font-bold">
                                        <tr>
                                            <th class="px-6 py-4">Cliente / Placa</th>
                                            <th class="px-6 py-4 text-center">Vencimento</th>
                                            <th class="px-6 py-4 text-center">Status</th>
                                            <th class="px-6 py-4 text-right">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-mensalistas" class="divide-y divide-slate-50"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-inadimplentes" class="tab-content">
                    <header class="mb-10">
                        <h2 class="text-2xl font-bold text-slate-800">Relatório de Inadimplentes</h2>
                        <p class="text-slate-500 text-sm">Mensalistas com atraso superior a 5 dias.</p>
                    </header>

                    <div class="bg-white rounded-[2rem] shadow-xl border border-rose-100 overflow-hidden">
                        <table class="w-full text-left border-separate border-spacing-0">
                            <thead class="bg-rose-50 text-rose-600 text-[10px] uppercase font-bold">
                                <tr>
                                    <th class="px-6 py-4">Mensalista</th>
                                    <th class="px-6 py-4 text-center">Vencimento</th>
                                    <th class="px-6 py-4 text-center">Dias de Atraso</th>
                                    <th class="px-6 py-4 text-right">Ação Urgente</th>
                                </tr>
                            </thead>
                            <tbody id="lista-inadimplentes" class="divide-y divide-rose-50"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-insights" class="tab-content">
                    <header class="mb-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Estatísticas & Performance</h2>
                            <p class="text-slate-500 text-sm">Análise detalhada do faturamento e fluxo.</p>
                        </div>

                        <div class="flex flex-wrap gap-2 bg-white p-2 rounded-2xl shadow-sm border border-slate-100">
                            <select id="filtro-mes"
                                class="bg-slate-50 border-none rounded-xl px-4 py-2 text-xs font-bold outline-none">
                                <option value="all">TODOS OS MESES</option>
                                <option value="0">Janeiro</option>
                                <option value="1">Fevereiro</option>
                                <option value="2">Março</option>
                                <option value="3">Abril</option>
                                <option value="4">Maio</option>
                                <option value="5">Junho</option>
                                <option value="6">Julho</option>
                                <option value="7">Agosto</option>
                                <option value="8">Setembro</option>
                                <option value="9">Outubro</option>
                                <option value="10">Novembro</option>
                                <option value="11">Dezembro</option>
                            </select>
                            <button onclick="gerarRelatorioFiltrado()"
                                class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-indigo-700 transition-all">
                                <i data-lucide="printer" class="w-3 h-3 inline mr-1"></i> Imprimir Mês
                            </button>
                            <button onclick="gerarRelatorioAnualPDF()"
                                class="bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-black transition-all">
                                <i data-lucide="file-text" class="w-3 h-3 inline mr-1"></i> Relatório Geral
                            </button>

                            <button onclick="baixarLogSeguranca()"
                                class="mt-2 w-full py-2 bg-red-50 text-red-600 font-bold rounded-xl text-[10px] uppercase border border-red-100 hover:bg-red-600 hover:text-white transition-all">
                                Baixar Log de Incidentes (Provas)
                            </button>
                        </div>
                    </header>

                    <div class="mt-8 bg-white p-8 rounded-[2.5rem] border border-rose-100 shadow-xl">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-xl font-black text-slate-800 uppercase tracking-tight">Últimos Alertas
                                    de Segurança</h3>
                                <p class="text-xs text-rose-500 font-bold uppercase tracking-widest italic">
                                    Monitoramento de placas clonadas e suspeitas</p>
                            </div>
                            <i data-lucide="shield-alert" class="text-rose-500 w-8 h-8"></i>
                        </div>
                        <div class="overflow-hidden rounded-2xl border border-slate-50">
                            <table class="w-full text-left">
                                <thead class="bg-rose-50 text-rose-600 text-[10px] font-bold uppercase">
                                    <tr>
                                        <th class="px-6 py-4">Data/Hora</th>
                                        <th class="px-6 py-4">Placa</th>
                                        <th class="px-6 py-4">Modelo Tentativa</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-incidentes-bi" class="divide-y divide-slate-50 text-sm">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
                        <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-lg">
                            <p class="text-[10px] uppercase font-bold text-slate-400">Ticket Médio (Hoje)</p>
                            <p id="bi-ticket-medio" class="text-2xl font-black text-indigo-600">R$ 0,00</p>
                        </div>
                        <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-lg">
                            <p class="text-[10px] uppercase font-bold text-slate-400">Veículos (Mês)</p>
                            <p id="bi-total-veiculos" class="text-2xl font-black text-slate-800">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-lg">
                            <p class="text-[10px] uppercase font-bold text-slate-400">Previsão Mensalistas</p>
                            <p id="bi-previsao-mensal" class="text-2xl font-black text-emerald-600">R$ 0,00</p>
                        </div>
                        <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-lg">
                            <p class="text-[10px] uppercase font-bold text-slate-400">Pico de Hoje</p>
                            <p id="bi-horario-pico" class="text-2xl font-black text-rose-600">--:00h</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl">
                            <div class="mb-6">
                                <h3 class="text-xl font-black text-slate-800 uppercase tracking-tight">Faturamento
                                    Semanal
                                </h3>
                                <p class="text-xs text-slate-400 font-bold uppercase tracking-widest italic">Últimos 7
                                    dias
                                    (Avulsos)</p>
                            </div>
                            <div class="h-[300px]"><canvas id="chartFaturamentoSemanal"></canvas></div>
                        </div>

                        <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl">
                            <div class="mb-6">
                                <h3 class="text-xl font-black text-slate-800 uppercase tracking-tight">Evolução Mensal
                                </h3>
                                <p class="text-xs text-slate-400 font-bold uppercase tracking-widest italic">Arrecadação
                                    acumulada por mês</p>
                            </div>
                            <div class="h-[300px]"><canvas id="chartFaturamentoMensal"></canvas></div>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl">
                        <div class="mb-6">
                            <h3 class="text-xl font-black text-slate-800 uppercase tracking-tight">Fluxo de Entradas
                            </h3>
                            <p class="text-xs text-slate-400 font-bold uppercase tracking-widest italic">Picos de
                                movimentação por hora (Hoje)</p>
                        </div>
                        <div class="h-[350px]"><canvas id="movimentacaoChart"></canvas></div>
                    </div>
                </div>

                <div id="tab-perfil" class="tab-content">
                    <header class="mb-10">
                        <h2 class="text-2xl font-bold text-slate-800">Minha Conta</h2>
                        <p class="text-slate-500 text-sm">Gerencie suas credenciais de acesso.</p>
                    </header>

                    <div class="max-w-md mx-auto">
                        <section class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100">
                            <div class="flex items-center gap-4 mb-8 pb-6 border-b border-slate-50">
                                <div class="bg-indigo-100 p-4 rounded-2xl text-indigo-600">
                                    <i data-lucide="lock" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-slate-800 uppercase tracking-tight">Alterar Senha</h3>
                                    <p id="user-email-display" class="text-xs text-slate-400 font-bold font-mono">
                                        carregando e-mail...</p>
                                </div>
                            </div>

                            <div class="space-y-5">
                                <div>
                                    <label
                                        class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 block">Nova
                                        Senha</label>
                                    <input type="password" id="new-password" placeholder="Mínimo 6 caracteres"
                                        class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                                </div>

                                <div>
                                    <label
                                        class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 block">Confirmar
                                        Nova Senha</label>
                                    <input type="password" id="confirm-new-password" placeholder="Repita a senha"
                                        class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                                </div>

                                <button onclick="handlePasswordReset()" id="btn-reset-password"
                                    class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black shadow-lg hover:bg-black transition-all active:scale-95 flex items-center justify-center gap-2">
                                    <i data-lucide="refresh-cw" class="w-5 h-5"></i> ATUALIZAR SENHA
                                </button>
                            </div>
                        </section>
                    </div>
                </div>


            </main>
    </div>

    <div id="modalConfig" onclick="closeOnOutsideClick(event, 'modalConfig')"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] hidden items-center justify-center p-4">

        <div
            class="bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-in zoom-in-95 duration-300">

            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white">
                <h3 class="font-black text-slate-800 text-2xl uppercase tracking-tighter">Configurações Gerais</h3>
                <button onclick="toggleModal('modalConfig')"
                    class="text-slate-400 hover:text-rose-500 transition-colors p-2">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="p-8 overflow-y-auto custom-scrollbar space-y-8">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 block">Valor
                            da Hora (R$)</label>
                        <input type="number" id="confValor" step="0.01"
                            class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-indigo-600 outline-none focus:ring-2 focus:ring-indigo-500 transition-all font-mono">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 block">Vagas
                            Totais</label>
                        <input type="number" id="confVagas"
                            class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-indigo-500 transition-all font-mono">
                    </div>
                </div>

                <div class="bg-indigo-50 p-6 rounded-[2rem] flex items-center justify-between border border-indigo-100">
                    <div>
                        <p class="text-sm font-black text-indigo-900 uppercase tracking-tight">Cobrança Proporcional</p>
                        <p class="text-[10px] text-indigo-600 font-bold uppercase tracking-wider">Cálculo minuto a
                            minuto ativado</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="confProporcional" class="sr-only peer">
                        <div
                            class="w-14 h-7 bg-slate-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                        </div>
                    </label>
                </div>

                <div class="pt-6 border-t border-slate-100">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Gestão de
                        Mensalistas</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Valor Mensal
                                (R$)</label>
                            <input type="number" id="confMensalValor" step="0.01"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-indigo-600 outline-none font-mono">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Multa Diária
                                (R$)</label>
                            <input type="number" id="confMensalMulta" step="0.01"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-rose-600 outline-none font-mono">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Limite de
                                Placas</label>
                            <input type="number" id="confMensalPlacas"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold outline-none font-mono">
                        </div>
                    </div>
                </div>

                <div class="pt-6 border-t border-slate-100">
                    <button onclick="document.getElementById('sessao-convenios').classList.toggle('hidden')"
                        class="w-full flex justify-between items-center py-2 text-[10px] font-black text-indigo-600 uppercase tracking-widest group">
                        <span>Gestão de Convênios (Parceiros)</span>
                        <i data-lucide="chevron-down"
                            class="w-4 h-4 group-hover:translate-y-0.5 transition-transform"></i>
                    </button>

                    <div id="sessao-convenios"
                        class="hidden space-y-4 mt-4 bg-slate-50 p-6 rounded-[2rem] border border-slate-100">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <input type="text" id="conv-nome" placeholder="NOME DO PARCEIRO"
                                class="w-full p-4 bg-white border border-slate-200 rounded-xl text-xs font-bold outline-none uppercase">
                            <div class="flex gap-2">
                                <select id="conv-tipo"
                                    class="flex-1 p-4 bg-white border border-slate-200 rounded-xl text-[10px] font-black outline-none">
                                    <option value="MINUTOS">DESC. MINUTOS</option>
                                    <option value="PERCENTUAL">DESC. % TOTAL</option>
                                </select>
                                <input type="number" id="conv-valor" placeholder="VALOR"
                                    class="w-24 p-4 bg-white border border-slate-200 rounded-xl text-xs font-bold text-center outline-none font-mono">
                            </div>
                        </div>
                        <button onclick="cadastrarNovoConvenio()"
                            class="w-full bg-indigo-100 text-indigo-700 py-4 rounded-xl text-[10px] font-black uppercase hover:bg-indigo-600 hover:text-white transition-all">
                            Adicionar Novo Parceiro
                        </button>
                        <div id="lista-convenios-config"
                            class="max-h-40 overflow-y-auto space-y-2 pt-2 custom-scrollbar">
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 bg-slate-50 border-t border-slate-100">
                <button onclick="salvarConfig()"
                    class="w-full bg-slate-900 text-white font-black py-5 rounded-2xl shadow-xl hover:bg-black active:scale-[0.98] transition-all uppercase tracking-widest">
                    Salvar e Aplicar Alterações
                </button>
            </div>
        </div>
    </div>

    <div id="modalAddServico" onclick="closeOnOutsideClick(event, 'modalAddServico')"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[120] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl">
            <h3 class="text-xl font-bold mb-4 tracking-tight">Lançar para: <span id="placa-servico-alvo"
                    class="text-indigo-600"></span></h3>
            <div id="opcoes-servicos" class="space-y-2 max-h-60 overflow-y-auto mb-6"></div>
            <button onclick="toggleModal('modalAddServico')"
                class="w-full py-4 bg-slate-100 font-bold rounded-2xl">Cancelar</button>
        </div>
    </div>

    <div id="modalCheckout" onclick="closeOnOutsideClick(event, 'modalCheckout')"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden">
            <div class="p-8 text-center">
                <div
                    class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="receipt" class="w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">Finalizar Checkout</h3>
                <div id="checkout-details"
                    class="text-slate-500 space-y-2 mb-8 bg-slate-50 p-4 rounded-2xl text-left font-medium"></div>
                <div class="flex gap-3"><button onclick="toggleModal('modalCheckout')"
                        class="flex-1 py-4 bg-slate-100 text-slate-600 font-bold rounded-2xl">Voltar</button><button
                        id="confirm-checkout-btn"
                        class="flex-1 py-4 bg-indigo-600 text-white font-bold rounded-2xl">Confirmar Pagamento</button>
                </div>
            </div>

            <div class="mb-4">
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 block">Aplicar
                    Convênio / Selo</label>
                <select id="select-convenio" onchange="recalcularComDesconto()"
                    class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm font-bold text-indigo-600">
                    <option value="">NENHUM CONVÊNIO</option>
                </select>
            </div>
        </div>
    </div>

    <script>
        let aguardandoEmail = false; // Controle de trava para o botão de recuperação
        // INICIALIZAÇÃO DE DADOS (AGORA VIA SUPABASE)
        let config = {
            valorHora: 15.00,
            tolerancia: 5,
            vagasTotais: 15,
            cobrancaProporcional: true,
            mensalValor: 200.00,
            mensalMulta: 5.00,
            mensalLimitePlacas: 1
        };
        let catalogo = [];
        let resumoVendas = { vagas: 0, produtos: 0 };
        let mensalistas = [];
        let historico = [];
        let patioAtivo = [];
        let agenda = []; // Adicione esta para os agendamentos
        // Sons do sistema (Efeitos discretos)
        const sfx = {
            entrada: new Audio('https://www.soundjay.com/buttons/sounds/button-3.mp3'),
            saida: new Audio('https://www.soundjay.com/buttons/sounds/button-10.mp3'),
            sucesso: new Audio('https://www.soundjay.com/buttons/sounds/button-4.mp3')
        };

        function playSfx(tipo) {
            sfx[tipo].currentTime = 0;
            sfx[tipo].volume = 0.4;
            sfx[tipo].play().catch(() => { }); // Evita erro se o navegador bloquear áudio sem interação
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').innerText = message;
            const iconEl = document.getElementById('toast-icon');
            iconEl.innerHTML = type === 'success' ? '<i data-lucide="check-circle-2"></i>' : '<i data-lucide="alert-circle"></i>';
            iconEl.className = type === 'success' ? 'text-emerald-400' : 'text-rose-400';
            lucide.createIcons();
            toast.classList.add('toast-active');
            setTimeout(() => toast.classList.remove('toast-active'), 3000);
        }

        function toggleModal(id) {
            const m = document.getElementById(id);
            m.classList.toggle('hidden');
            m.classList.toggle('flex');
            if (id === 'modalConfig') {
                document.getElementById('confValor').value = config.valorHora;
                document.getElementById('confVagas').value = config.vagasTotais;
                document.getElementById('confProporcional').checked = config.cobrancaProporcional;
                // Adicione dentro do if(id === 'modalConfig')
                document.getElementById('confMensalValor').value = config.mensalValor || 200;
                document.getElementById('confMensalMulta').value = config.mensalMulta || 5;
                document.getElementById('confMensalPlacas').value = config.mensalLimitePlacas || 1;
            }
        }

        function closeOnOutsideClick(event, modalId) { if (event.target.id === modalId) toggleModal(modalId); }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.querySelectorAll('nav button').forEach(b => b.classList.replace('bg-white/10', 'text-slate-400'));
            const activeBtn = document.getElementById(`nav-${tabId}`);
            if (activeBtn) activeBtn.classList.replace('text-slate-400', 'bg-white/10');

            renderizar();

            // ADICIONE ESTA LINHA AQUI:
            if (tabId === 'dashboard') {
                atualizarGrafico();
            }
        }

        function calcularCobranca(veiculo) {
            const entrada = new Date(veiculo.entrada);
            const agora = new Date();
            const diffMs = agora - entrada;
            const diffSegundos = Math.floor(diffMs / 1000);
            const diffMinutos = Math.floor(diffMs / 60000);

            const mensalista = mensalistas.find(m => m.placa === veiculo.placa);
            const hoje = new Date().toISOString().split('T')[0];
            const isMensalistaAtivo = mensalista && mensalista.vencimento >= hoje;

            let valorTempo = 0;
            // Mapeamento correto das chaves vindas do Supabase
            const precoHora = config.valor_hora || config.valorHora || 0;
            const isProporcional = config.cobranca_proporcional ?? config.cobrancaProporcional;
            const toleranciaMin = config.tolerancia || 0;

            if (!isMensalistaAtivo && diffMinutos >= toleranciaMin) {
                if (isProporcional) {
                    // Cálculo: (segundos totais / 3600 segundos de 1h) * valor da hora
                    valorTempo = (diffSegundos / 3600) * precoHora;
                } else {
                    // Cobrança por hora cheia (arredonda para cima)
                    valorTempo = Math.ceil(diffMinutos / 60) * precoHora;
                }
            }

            const valorExtras = (veiculo.servicos || []).reduce((acc, s) => acc + s.preco, 0);
            return {
                horas: Math.floor(diffMinutos / 60),
                minutos: diffMinutos % 60,
                segundos: diffSegundos % 60,
                valorTempo,
                valorExtras,
                total: valorTempo + valorExtras,
                isMensalista: isMensalistaAtivo
            };
        }

        async function removerMensalista(id) {
            if (confirm("Deseja realmente excluir este mensalista permanentemente da nuvem?")) {
                const { error } = await _supabase
                    .from('mensalistas')
                    .delete()
                    .eq('id', id);

                if (error) return showToast("Erro ao excluir do banco!", "error");

                await carregarDadosIniciais();
                showToast("Registro removido com sucesso!");
                renderizar();
            }
        }

        let clienteParaCobrarGlobal = null;

        function verificarClienteInteligente(valor, tipo) {
            const termo = valor.toUpperCase();
            if (termo.length < 3) return;

            // 1. BUSCAR NO PÁTIO (AMARELO)

            const noPatio = patio.find(v => tipo === 'placa' ? v.placa === termo : v.telefone === termo.replace(/\D/g, ''));

            if (noPatio) {
                document.getElementById('alerta-patio-modelo').innerText = noPatio.modelo;
                document.getElementById('alerta-patio-hora').innerText = new Date(noPatio.entrada).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                document.getElementById('modalAlertaNoPatio').classList.replace('hidden', 'flex');
                playSfx('saida');
                return; // Para aqui, não precisa checar mensalista
            }

            // 2. BUSCAR MENSALISTA
            const mensalista = mensalistas.find(m =>
                tipo === 'placa' ? m.placa === termo : (m.telefone && m.telefone.replace(/\D/g, '') === termo.replace(/\D/g, ''))
            );

            if (mensalista) {
                const hoje = new Date();
                const dataVenc = new Date(mensalista.vencimento);

                if (dataVenc < hoje) {
                    // VERMELHO: INADIMPLENTE
                    const diffMs = hoje - dataVenc;
                    const diasAtraso = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                    const valorTotalDivida = (mensalista.valorPlano || config.mensalValor) + (diasAtraso * config.mensalMulta);

                    clienteParaCobrarGlobal = { ...mensalista, diasAtraso };
                    document.getElementById('alerta-nome').innerText = mensalista.nome;
                    document.getElementById('alerta-valor').innerText = `R$ ${valorTotalDivida.toFixed(2)}`;
                    document.getElementById('alerta-detalhe').innerText = `Vencido há ${diasAtraso} dias`;
                    document.getElementById('modalAlertaInadimplente').classList.replace('hidden', 'flex');
                    playSfx('saida');
                } else {
                    // VERDE: VIP EM DIA
                    document.getElementById('alerta-vip-nome').innerText = mensalista.nome;
                    document.getElementById('alerta-vip-placa').innerText = mensalista.placa;
                    document.getElementById('alerta-vip-venc').innerText = `Vencimento: ${dataVenc.toLocaleDateString('pt-BR')}`;
                    document.getElementById('modalAlertaVip').classList.replace('hidden', 'flex');
                    playSfx('sucesso');

                    // Auto-preenchimento
                    if (tipo === 'placa') {
                        document.getElementById('modelo').value = "MENSALISTA: " + mensalista.nome;
                        document.getElementById('telefone').value = mensalista.telefone;
                    }
                }
            }
        }

        // Função auxiliar para o botão do popup
        function cobrarInadimplentePeloAlerta() {
            if (clienteParaCobrarGlobal) {
                cobrarInadimplente(clienteParaCobrarGlobal.id, clienteParaCobrarGlobal.diasAtraso);
            }
        }

        async function cadastrarVeiculo() {
            const plaInput = document.getElementById('placa');
            const modInput = document.getElementById('modelo');
            const telInput = document.getElementById('telefone');

            const pla = plaInput.value.toUpperCase().trim();
            const mod = modInput.value.toUpperCase().trim();
            const tel = telInput.value.replace(/\D/g, '');

            // 1. TRAVA DE SEGURANÇA: Verificação de Duplicidade no Pátio Ativo
            const veiculoExistente = patioAtivo.find(v => v.placa === pla);

            if (veiculoExistente) {
                await registrarLogSeguranca(pla, mod);
                // Dispara o alerta de segurança
                document.getElementById('alerta-placa-clonada').innerText = pla;
                document.getElementById('modalAlertaSeguranca').classList.replace('hidden', 'flex');
                playSfx('saida'); // Som de alerta
                await registrarLogSeguranca(pla, mod);
                lucide.createIcons();
                return; // CANCELA O CADASTRO IMEDIATAMENTE
            }

            // 2. Validações normais
            if (!validarPlacaReal(pla)) {
                showToast("Placa inválida!", "error");
                return;
            }

            if (!mod) {
                showToast("Informe o modelo!", "error");
                return;
            }

            // ... restante do código de insert do Supabase ...
            const novoVeiculo = {
                modelo: mod,
                placa: pla,
                telefone: tel,
                entrada: new Date().toISOString(),
                servicos: [],
                user_id: (await _supabase.auth.getUser()).data.user.id
            };

            const { data, error } = await _supabase.from('veiculos_ativos').insert([novoVeiculo]).select();
            if (error) return showToast("Erro ao salvar!", "error");

            await carregarDadosIniciais();
            modInput.value = ''; plaInput.value = ''; telInput.value = '';
            showToast("Entrada registrada!");
            renderizar();
        }


        // Variável global para rastrear o valor do desconto no momento do checkout
        let descontoAtual = 0;

        function openCheckoutModal(id) {
            const v = patioAtivo.find(x => x.id === id);
            if (!v) return;

            window.clienteCheckoutAtualId = id;
            descontoAtual = 0;
            let processandoCheckout = false; // TRAVA DE SEGURANÇA

            const infoInicial = calcularCobranca(v);

            document.getElementById('checkout-details').innerHTML = `
                <p><strong>Veículo:</strong> ${v.modelo} (${v.placa})</p>
                <p><strong>Permanência:</strong> ${infoInicial.horas}h ${infoInicial.minutos}m ${infoInicial.segundos}s</p>
                <div class="mt-4 pt-4 border-t border-slate-200">
                    <div class="flex justify-between text-sm"><span>Vaga:</span> <span>R$ ${infoInicial.valorTempo.toFixed(2)}</span></div>
                    <div class="flex justify-between text-sm"><span>Extras:</span> <span>R$ ${infoInicial.valorExtras.toFixed(2)}</span></div>
            
                    <p id="valor-total-display" class="text-emerald-600 text-3xl font-black text-center mt-2">
                        TOTAL: R$ ${infoInicial.total.toFixed(2)}
                    </p>
                    <p class="text-[9px] text-center text-slate-400 font-bold uppercase mt-2">[ Pressione ENTER para confirmar ]</p>
                </div>`;

            const btnConfirmar = document.getElementById('confirm-checkout-btn');
            btnConfirmar.innerText = "Confirmar Pagamento"; // Reset de texto
            btnConfirmar.disabled = false;

            // Função interna para executar a saída
            const executarSaida = async () => {
                if (processandoCheckout) return; // Se já estiver processando, ignora o segundo comando
                processandoCheckout = true;

                btnConfirmar.innerText = "PROCESSANDO...";
                btnConfirmar.disabled = true;

                const idConvenio = document.getElementById('select-convenio').value;
                const infoFinal = obterInfoComDesconto(v, idConvenio);

                // 1. Salva no Histórico
                const { error: errHist } = await _supabase.from('historico_saidas').insert([{
                    modelo: v.modelo,
                    placa: v.placa,
                    entrada: v.entrada,
                    saida: new Date().toISOString(),
                    tempo: `${infoFinal.horas}h ${infoFinal.minutos}m`,
                    valor: infoFinal.total,
                    convenio_id: idConvenio || null,
                    valor_desconto_aplicado: descontoAtual
                }]);

                if (errHist) {
                    processandoCheckout = false;
                    btnConfirmar.innerText = "Confirmar Pagamento";
                    btnConfirmar.disabled = false;
                    return showToast("Erro ao salvar histórico!", "error");
                }

                // 2. Remove do Pátio
                const { error: errDel } = await _supabase.from('veiculos_ativos').delete().eq('id', id);

                if (errDel) {
                    processandoCheckout = false;
                    return showToast("Erro ao remover do pátio!", "error");
                }

                // 3. Sucesso: Fecha modal e limpa ouvintes
                window.removeEventListener('keydown', listenerEnter); // Remove o ouvinte IMEDIATAMENTE
                toggleModal('modalCheckout');

                await carregarDadosIniciais();
                showToast("Pagamento confirmado!");
                renderizar();
                prepararReciboSaida(v, infoFinal);
            };

            // Define o clique do botão
            btnConfirmar.onclick = executarSaida;

            // Função do teclado (Enter)
            const listenerEnter = (e) => {
                const modal = document.getElementById('modalCheckout');
                // Só executa se o modal estiver visível
                if (e.key === 'Enter' && !modal.classList.contains('hidden')) {
                    e.preventDefault();
                    executarSaida();
                }
                if (e.key === 'Escape') {
                    window.removeEventListener('keydown', listenerEnter);
                }
            };

            // Adiciona o ouvinte de teclado
            window.addEventListener('keydown', listenerEnter);

            // Reseta convênio
            const selConv = document.getElementById('select-convenio');
            if (selConv) selConv.value = "";

            toggleModal('modalCheckout');
            setTimeout(() => btnConfirmar.focus(), 100);
        }

        // Função auxiliar para calcular o valor considerando o convênio selecionado
        function obterInfoComDesconto(veiculo, idConvenio) {
            let infoOriginal = calcularCobranca(veiculo);
            let infoComDesconto = { ...infoOriginal };
            const convenio = listaConvenios.find(c => c.id == idConvenio);

            if (convenio) {
                if (convenio.tipo_desconto === 'MINUTOS') {
                    const entradaOriginal = new Date(veiculo.entrada);
                    const entradaComDesconto = new Date(entradaOriginal.getTime() + (convenio.valor_desconto * 60000));
                    const entradaFinal = entradaComDesconto > new Date() ? new Date() : entradaComDesconto;
                    infoComDesconto = calcularCobranca({ ...veiculo, entrada: entradaFinal.toISOString() });
                } else if (convenio.tipo_desconto === 'PERCENTUAL') {
                    infoComDesconto.total = infoOriginal.total * (1 - (convenio.valor_desconto / 100));
                }
            }

            descontoAtual = infoOriginal.total - infoComDesconto.total;
            return infoComDesconto;
        }

        function renderizar() {
            const patio = patioAtivo;
            const containerPatio = document.getElementById('patio');
            // Dentro da função renderizar()
            // Filtra apenas checkouts realizados hoje para o Caixa Total
            const hoje = new Date().toISOString().split('T')[0];
            const checkoutsDeHoje = historico.filter(h => h.saida.startsWith(hoje));
            const totalHistorico = historico.reduce((acc, h) => acc + (h.valor || 0), 0);
            const totalFinanceiroHoje = checkoutsDeHoje.reduce((acc, h) => acc + (h.valor || 0), 0);
            document.getElementById('totalFinanceiro').innerText = `R$ ${totalFinanceiroHoje.toFixed(2)}`;
            document.getElementById('resumo-vagas').innerText = `R$ ${totalHistorico.toFixed(2)}`;
            document.getElementById('resumo-vagas').innerText = `R$ ${totalFinanceiroHoje.toFixed(2)}`
            document.getElementById('resumo-produtos').innerText = `R$ 0,00`;

            // Define a filtragem para evitar erro de referência
            const searchQuery = document.getElementById('search-patio') ? document.getElementById('search-patio').value.toUpperCase() : '';
            const patioFiltrado = patio.filter(v => v.placa.includes(searchQuery) || v.modelo.toUpperCase().includes(searchQuery));


            // Desenha o Pátio Ativo (Limitado a 4 ou total)
            const listaParaExibir = exibirTodosPatio ? patioFiltrado : patioFiltrado.slice(0, 4);

            containerPatio.innerHTML = listaParaExibir.map(v => {
                const info = calcularCobranca(v);
                const totalMinutos = (info.horas * 60) + info.minutos;
                let classeStatus = "status-normal";
                if (totalMinutos > 360) classeStatus = "status-critico";
                else if (totalMinutos > 120) classeStatus = "status-alerta";

                const seloMensalista = info.isMensalista ? '<span class="ml-2 text-[8px] bg-indigo-600 text-white px-1.5 py-0.5 rounded-full uppercase font-black">Mensalista</span>' : '';

                return `<tr class="group hover:bg-indigo-50/30 transition-all duration-300">
                    <td class="px-6 py-5"><div class="flex items-center gap-3"><div class="active-dot"></div><div><strong class="text-slate-800 text-lg">${v.modelo}</strong><br><span class="text-[11px] bg-slate-200 text-slate-700 px-2 py-0.5 rounded font-bold font-mono">${v.placa}</span></div></div></td>
                    <td class="px-6 py-5 text-center text-sm font-semibold text-slate-500">${new Date(v.entrada).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
                    <td class="px-6 py-5 text-center font-black text-indigo-600 font-mono tracking-tighter ${classeStatus}">${info.horas}h ${info.minutos}m <span class="text-[10px] text-indigo-300">${info.segundos}s</span></td>
                    <td class="px-6 py-5 text-center font-black text-emerald-600 text-2xl tracking-tighter tabular-nums">R$ ${info.total.toFixed(2)}</td>
                    <td class="px-6 py-5 text-right flex gap-2 justify-end">
                        <button onclick="abrirModalServico(${v.id})" class="bg-indigo-50 text-indigo-700 border border-indigo-100 px-4 py-2.5 rounded-xl text-xs font-bold hover:bg-indigo-600 hover:text-white transition-all"><i data-lucide="plus-circle" class="w-4 h-4"></i></button>
                        <button onclick="openCheckoutModal(${v.id})" class="bg-rose-600 text-white px-5 py-2.5 rounded-xl text-xs font-black shadow-lg shadow-rose-200 hover:bg-rose-700 transition-all">SAIR</button>
                    </td>
                </tr>`;
            }).join('');

            renderizarBotaoVerTodos(patioFiltrado.length);

            // Renderiza o Histórico se a aba estiver ativa
            if (document.getElementById('tab-historico').classList.contains('active')) {
                document.getElementById('lista-historico').innerHTML = historico.map(h => `
            <tr>
                <td class="px-6 py-4 font-bold">${h.modelo} <span class="text-[10px] bg-slate-100 px-1 ml-2">${h.placa}</span></td>
                <td class="px-6 py-4 text-xs">${new Date(h.entrada).toLocaleString()}</td>
                <td class="px-6 py-4 text-xs">${new Date(h.saida).toLocaleString()}</td>
                <td class="px-6 py-4 text-center font-mono text-xs">${h.tempo}</td>
                <td class="px-6 py-4 text-right font-bold text-emerald-600">R$ ${h.valor.toFixed(2)}</td>
            </tr>
        `).join('');
            }

            // Atualiza widgets e renderiza as demais abas
            document.getElementById('resumo-vagas').innerText = `R$ ${resumoVendas.vagas.toFixed(2)}`;
            document.getElementById('resumo-produtos').innerText = `R$ ${resumoVendas.produtos.toFixed(2)}`;
            document.getElementById('totalFinanceiro').innerText = `R$ ${(resumoVendas.vagas + resumoVendas.produtos).toFixed(2)}`;
            const perc = (patio.length / config.vagasTotais) * 100;
            document.getElementById('progressBar').style.width = `${perc}%`;
            document.getElementById('progressText').innerText = `${patio.length} de ${config.vagasTotais} vagas ocupadas`;

            if (document.getElementById('tab-servicos').classList.contains('active')) renderCatalogo();
            if (document.getElementById('tab-agendamentos').classList.contains('active')) renderAgenda();
            if (document.getElementById('tab-mensalistas').classList.contains('active')) renderMensalistas();
            if (document.getElementById('tab-mensalistas').classList.contains('active')) renderMensalistas();

            // COLOQUE ESTA LINHA ABAIXO:
            if (document.getElementById('tab-inadimplentes').classList.contains('active')) renderInadimplentes();
            lucide.createIcons();
        }

        function renderizarBotaoVerTodos(total) {
            let btn = document.getElementById('btn-ver-todos');
            if (total <= 4) {
                if (btn) btn.remove();
                return;
            }

            if (!btn) {
                btn = document.createElement('button');
                btn.id = 'btn-ver-todos';
                btn.className = "w-full py-4 text-slate-400 text-[10px] font-bold uppercase tracking-widest hover:text-indigo-600 transition-colors border-t border-slate-50";
                // Insere o botão logo após o fim da div de scroll da tabela
                document.querySelector('.custom-scrollbar').after(btn);
            }

            btn.innerText = exibirTodosPatio ? "↑ Recolher lista" : `↓ Ver todos (${total} veículos)`;
            btn.onclick = () => { exibirTodosPatio = !exibirTodosPatio; renderizar(); };
        }

        // FUNÇÕES DE SUPORTE
        async function cadastrarServicoCatalogo() {
            const n = document.getElementById('serv-nome'), p = document.getElementById('serv-preco'), c = document.getElementById('possui-estoque'), q = document.getElementById('serv-qtd');

            const novoItem = {
                nome: n.value,
                preco: parseFloat(p.value),
                estoque: c.checked ? parseInt(q.value) : -1
            };

            const { error } = await _supabase.from('catalogo').insert([novoItem]);

            if (error) return showToast("Erro ao salvar item!", "error");

            await carregarDadosIniciais();
            showToast("Item salvo no catálogo online!");
            renderizar();
        }

        function renderCatalogo() {
            document.getElementById('catalogo-grid').innerHTML = catalogo.map(s => `<div class="bg-white p-4 rounded-2xl border flex justify-between items-center shadow-sm"><div><p class="font-bold text-slate-800">${s.nome}</p><p class="text-emerald-600 font-bold text-sm">R$ ${s.preco.toFixed(2)}</p><p class="text-[10px] font-bold ${s.estoque === 0 ? 'text-rose-500' : 'text-slate-400'} uppercase">${s.estoque === -1 ? 'Serviço' : `Estoque: ${s.estoque} un`}</p></div><button onclick="deletarItemCatalogo(${s.id})" class="text-slate-300 hover:text-rose-500 transition-all"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`).join('');
        }

        function abrirModalServico(veiculoId) {
            // Ajustado de 'patio' para 'patioAtivo'
            const v = patioAtivo.find(x => x.id === veiculoId);
            if (!v) return;

            document.getElementById('placa-servico-alvo').innerText = v.placa;

            let html = catalogo.map(s => `
        <button onclick="lancarServicoNoVeiculo(${veiculoId}, ${s.id})" 
            class="w-full flex justify-between p-4 bg-slate-50 hover:bg-indigo-50 rounded-xl border border-transparent hover:border-indigo-200 transition-all">
            <span class="font-bold">${s.nome}</span>
            <span class="font-bold text-indigo-600">R$ ${s.preco.toFixed(2)}</span>
        </button>`).join('');

            document.getElementById('opcoes-servicos').innerHTML = html || '<p class="text-center text-slate-400 py-4">Catálogo vazio.</p>';
            toggleModal('modalAddServico');
        }

        async function lancarServicoNoVeiculo(veiculoId, servicoId) {
            const v = patioAtivo.find(x => x.id === veiculoId);
            const serv = catalogo.find(s => s.id === servicoId);

            if (!serv) return;
            if (serv.estoque !== -1 && serv.estoque <= 0) return showToast("Produto esgotado!", "error");

            // Prepara a nova lista de serviços do veículo
            const servicosAtualizados = [...(v.servicos || []), { nome: serv.nome, preco: serv.preco }];

            // Atualiza no Supabase para persistência real
            const { error } = await _supabase
                .from('veiculos_ativos')
                .update({ servicos: servicosAtualizados })
                .eq('id', veiculoId);

            if (error) return showToast("Erro ao lançar serviço!", "error");

            // Se for produto, subtrai do estoque no banco
            if (serv.estoque !== -1) {
                await _supabase.from('catalogo').update({ estoque: serv.estoque - 1 }).eq('id', servicoId);
            }

            await carregarDadosIniciais();
            toggleModal('modalAddServico');
            showToast("Item lançado com sucesso!");
            renderizar();
        }

        async function salvarConfig() {
            const { data: { user } } = await _supabase.auth.getUser();

            if (!user) {
                return showToast("Erro: Você precisa estar logado!", "error");
            }

            const btn = document.querySelector('[onclick="salvarConfig()"]');
            const originalText = btn.innerText;

            // Mapeamento exato com as colunas do SQL
            const novosDados = {
                id: 1, // Mantém a regra de linha única
                user_id: user.id,
                valor_hora: parseFloat(document.getElementById('confValor').value),
                vagas_totais: parseInt(document.getElementById('confVagas').value),
                cobranca_proporcional: document.getElementById('confProporcional').checked,
                mensal_valor: parseFloat(document.getElementById('confMensalValor').value),
                mensal_multa: parseFloat(document.getElementById('confMensalMulta').value),
                mensal_limite_placas: parseInt(document.getElementById('confMensalPlacas').value)
            };

            btn.innerText = "SALVANDO...";
            btn.disabled = true;

            // O upsert garante que ele atualize a linha existente (id: 1) ou crie se não houver
            const { error } = await _supabase.from('configuracoes').upsert([novosDados]);

            if (error) {
                console.error("Erro Supabase:", error);
                btn.innerText = originalText;
                btn.disabled = false;
                return showToast("Erro ao salvar no banco!", "error");
            }

            // Atualiza a variável global local para refletir as mudanças sem precisar recarregar
            config = { ...config, ...novosDados };

            btn.innerText = originalText;
            btn.disabled = false;
            toggleModal('modalConfig');
            showToast("Configurações sincronizadas com a nuvem!");
        }



        function zerarRelatorio() {
            // Sugestão de backup antes de apagar
            if (confirm("Deseja baixar um BACKUP de segurança antes de zerar o financeiro?")) {
                exportarBackup();
            }

            if (confirm("Tem certeza que deseja ZERAR o financeiro e o histórico? Esta ação não pode ser desfeita.")) {
                resumoVendas = { vagas: 0, produtos: 0 };
                historico = [];
                localStorage.setItem('park_resumo', JSON.stringify(resumoVendas));
                localStorage.setItem('park_pro_historico', JSON.stringify(historico));
                renderizar();
                showToast("Sistema zerado com segurança!", "success");
            }
            if (confirm("Tem certeza que deseja ZERAR...")) {
                // ... (limpeza do localStorage)
                renderizar();
                // Limpa o gráfico
                atualizarGrafico();
                showToast("Sistema zerado com segurança!", "success");
            }
        }

        function deletarItemCatalogo(id) { catalogo = catalogo.filter(i => i.id !== id); localStorage.setItem('park_catalogo', JSON.stringify(catalogo)); renderizar(); }

        async function iniciarDaReserva(id) {
            const res = agenda.find(x => x.id === id);
            if (!res) return;

            if (patioAtivo.length >= config.vagas_totais) return showToast("Pátio lotado!", "error");

            const novoVeiculo = {
                modelo: res.modelo,
                placa: res.placa,
                entrada: new Date().toISOString(),
                servicos: []
            };

            // 1. Insere no Pátio Ativo do Supabase
            const { error: errInsert } = await _supabase.from('veiculos_ativos').insert([novoVeiculo]);
            if (errInsert) return showToast("Erro ao iniciar entrada!", "error");

            // 2. Remove do Agendamento do Supabase
            const { error: errDel } = await _supabase.from('agendamentos').delete().eq('id', id);
            if (errDel) return showToast("Erro ao remover reserva!", "error");

            await carregarDadosIniciais(); // Atualiza a memória local com os dados da nuvem
            switchTab('dashboard');
            showToast("Entrada da reserva confirmada!");
        }

        async function agendarVeiculo() {
            // 1. Captura os elementos e valores
            const inputModelo = document.getElementById('agenda-modelo');
            const inputPlaca = document.getElementById('agenda-placa');
            const inputData = document.getElementById('agenda-data');

            const mod = inputModelo.value.toUpperCase();
            const pla = inputPlaca.value.toUpperCase();
            const dataPrevisa = inputData.value;

            // 2. Validação simples
            if (!mod || !pla || !dataPrevisa) {
                return showToast("Preencha todos os campos da reserva!", "error");
            }

            // 3. Envio para o Supabase
            const { error } = await _supabase.from('agendamentos').insert([{
                modelo: mod,
                placa: pla,
                data_prevista: dataPrevisa
            }]);

            if (error) {
                console.error("Erro ao agendar:", error);
                return showToast("Erro ao salvar reserva na nuvem!", "error");
            }

            // 4. Sucesso: Limpa campos e atualiza interface
            inputModelo.value = '';
            inputPlaca.value = '';
            inputData.value = '';

            await carregarDadosIniciais(); // Recarrega os dados da nuvem para a memória local
            showToast("Reserva confirmada e salva no banco!");
            renderizar(); // Atualiza a tabela de agendamentos na tela
        }


        function updateSidebarClock() { document.getElementById('sidebar-clock').innerText = new Date().toLocaleTimeString('pt-BR'); }


        // Função para realizar o Login
        async function handleLogin() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const btn = document.getElementById('btn-auth-submit');

            if (!email || !password) return showToast("Preencha e-mail e senha!", "error");

            btn.innerText = "CARREGANDO...";
            btn.disabled = true;

            // Tentativa de login no Supabase
            const { data, error } = await _supabase.auth.signInWithPassword({ email, password });

            if (error) {
                btn.innerText = "ENTRAR NO SISTEMA";
                btn.disabled = false;
                return alert("Erro no login: " + error.message);
            }

            // SE CHEGOU AQUI, O LOGIN FOI SUCESSO
            showToast("Acesso autorizado!");

            // Esconde a tela de login
            document.getElementById('auth-container').classList.add('hidden');

            // Carrega os dados do banco vinculados a este usuário
            await carregarDadosIniciais();
            renderizar();
            lucide.createIcons();
        }

        // Função para encerrar a sessão no Supabase
        async function handleLogout() {
            if (confirm("Deseja realmente sair e encerrar sua sessão?")) {
                const { error } = await _supabase.auth.signOut();

                if (error) {
                    return showToast("Erro ao sair: " + error.message, "error");
                }

                // Limpa os dados da memória e mostra a tela de login novamente
                mensalistas = [];
                historico = [];
                patioAtivo = [];

                document.getElementById('auth-container').classList.remove('hidden');
                showToast("Sessão encerrada com sucesso!");

                // Foca no campo de e-mail para o próximo acesso
                document.getElementById('auth-email').value = '';
                document.getElementById('auth-password').value = '';
                document.getElementById('auth-email').focus();
            }
        }

        // Verifica se o usuário já está logado ao abrir a página
        async function checkUserSession() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (user) {
                document.getElementById('auth-container').classList.add('hidden');
                await carregarDadosIniciais();
                renderizar();
            }
        }


        window.onload = async () => {
            // 1. Verifica sessão ativa
            await checkUserSession();

            // 2. Escuta mudanças (Recuperação de Senha)
            _supabase.auth.onAuthStateChange(async (event, session) => {
                // Quando o usuário volta do e-mail, o evento disparado é 'PASSWORD_RECOVERY'
                if (event === "PASSWORD_RECOVERY") {
                    // Esconde o login se estiver visível
                    const authContainer = document.getElementById('auth-container');
                    if (authContainer) authContainer.classList.add('hidden');

                    // Muda para a aba de perfil/senha que criamos
                    switchTab('perfil');

                    // Feedback visual para o usuário
                    setTimeout(() => {
                        showToast("Modo de recuperação: Digite sua nova senha abaixo.", "success");
                        const passInput = document.getElementById('new-password');
                        if (passInput) passInput.focus();
                    }, 500);
                }
            });

            // 3. Inicializações de interface
            setInterval(updateSidebarClock, 1000);
            lucide.createIcons();

            // 4. Foco no login (apenas se não estiver em recuperação)
            const authContainer = document.getElementById('auth-container');
            const isRecovery = window.location.hash.includes('type=recovery');

            if (authContainer && !authContainer.classList.contains('hidden') && !isRecovery) {
                const emailInput = document.getElementById('auth-email');
                if (emailInput) emailInput.focus();
            }
        };

        async function carregarDadosIniciais() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) return;

            // Busca os dados e substitui os valores das variáveis globais
            const [resConf, resCat, resMens, resHist, resPatio, resAgenda] = await Promise.all([
                _supabase.from('configuracoes').select('*').single(),
                _supabase.from('catalogo').select('*'),
                _supabase.from('mensalistas').select('*'),
                _supabase.from('historico_saidas').select('*').order('saida', { ascending: false }),
                _supabase.from('veiculos_ativos').select('*'),
                _supabase.from('agendamentos').select('*')
            ]);

            // Se houver dados no banco, usamos eles. Se não, mantemos o padrão.
            if (resConf.data) config = resConf.data;
            catalogo = resCat.data || [];
            mensalistas = resMens.data || [];
            historico = resHist.data || [];
            patioAtivo = resPatio.data || [];
            agenda = resAgenda.data || [];


            // Dentro da sua função carregarDadosIniciais()
            if (resConf.data) {
                config = {
                    valorHora: resConf.data.valor_hora,
                    vagasTotais: resConf.data.vagas_totais,
                    cobrancaProporcional: resConf.data.cobranca_proporcional,
                    mensalValor: resConf.data.mensal_valor,
                    mensalMulta: resConf.data.mensal_multa,
                    mensalLimitePlacas: resConf.data.mensal_limite_placas
                };
            }
        }


        async function buscarVeiculoPelaPlaca() {
            const placaDigitada = document.getElementById('input-placa-busca').value.toUpperCase();
            if (placaDigitada.length < 3) return;

            // Busca dados em todas as frentes
            const veiculoNoPatio = patioAtivo.find(v => v.placa === placaDigitada);
            const mensalista = mensalistas.find(m => m.placa === placaDigitada);
            // Conta quantas vezes essa placa aparece no histórico (Usos Totais)
            const totalUsos = historico.filter(h => h.placa === placaDigitada).length;

            const boxResultado = document.getElementById('resultado-busca-placa');
            const resModelo = document.getElementById('res-modelo');
            const resTempo = document.getElementById('res-tempo');
            const resValor = document.getElementById('res-valor');
            const btnSair = document.getElementById('btn-sair-res');
            const btnServ = document.getElementById('btn-add-serv-res');

            // Reset padrão
            resValor.className = "text-2xl font-black text-emerald-600 tracking-tighter";
            btnServ.classList.remove('hidden');
            boxResultado.classList.replace('hidden', 'flex');

            // Lógica de Identificação
            if (veiculoNoPatio) {
                const info = calcularCobranca(veiculoNoPatio);
                resModelo.innerHTML = `${veiculoNoPatio.modelo} <span class="text-[10px] bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded ml-2">ESTACIONADO</span>`;
                resTempo.innerText = `TEMPO: ${info.horas}h ${info.minutos}m | JÁ ESTEVE AQUI: ${totalUsos}x`;
                resValor.innerText = `TOTAL: R$ ${info.total.toFixed(2)}`;

                btnSair.innerText = "FINALIZAR SAÍDA";
                btnSair.onclick = () => { toggleModal('modalBuscaPlaca'); openCheckoutModal(veiculoNoPatio.id); };
                btnServ.onclick = () => { toggleModal('modalBuscaPlaca'); abrirModalServico(veiculoNoPatio.id); };
            }
            else if (mensalista) {
                const hoje = new Date().toISOString().split('T')[0];
                const isInadimplente = mensalista.vencimento < hoje;

                resModelo.innerHTML = `MENSALISTA: ${mensalista.nome} <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded ml-2">FORA DO PÁTIO</span>`;
                resTempo.innerText = `TOTAL DE VISITAS: ${totalUsos}x | VENCIMENTO: ${new Date(mensalista.vencimento).toLocaleDateString()}`;

                if (isInadimplente) {
                    resValor.innerText = "INADIMPLENTE";
                    resValor.className = "text-2xl font-black text-rose-600";
                    btnSair.innerText = "COBRAR WHATSAPP";
                    btnSair.onclick = () => cobrarInadimplente(mensalista.id, 0); // Ajuste a lógica de dias se necessário
                } else {
                    resValor.innerText = "PLANO EM DIA";
                    resValor.className = "text-2xl font-black text-indigo-600";
                    btnSair.innerText = "INICIAR ENTRADA";
                    btnSair.onclick = () => {
                        document.getElementById('placa').value = mensalista.placa;
                        document.getElementById('modelo').value = "MENSALISTA: " + mensalista.nome;
                        cadastrarVeiculo();
                        toggleModal('modalBuscaPlaca');
                    };
                }
                btnServ.classList.add('hidden');
            }
            else {
                // Placa nova ou apenas histórico
                resModelo.innerText = totalUsos > 0 ? "CLIENTE RECORRENTE" : "NOVO CLIENTE";
                resTempo.innerText = `ESTEVE AQUI ${totalUsos} VEZES ANTERIORMENTE.`;
                resValor.innerText = "PLACA LIVRE";
                btnSair.innerText = "REGISTRAR ENTRADA";
                btnSair.onclick = () => {
                    document.getElementById('placa').value = placaDigitada;
                    switchTab('dashboard');
                    toggleModal('modalBuscaPlaca');
                    document.getElementById('modelo').focus();
                };
                btnServ.classList.add('hidden');
            }
        }

        // Funções de ponte para o novo modal
        function prepararEntradaRapida() {
            const placa = document.getElementById('span-nova-placa').innerText;
            toggleModal('modalDecisaoNovaPlaca');
            switchTab('dashboard');
            document.getElementById('placa').value = placa;
            document.getElementById('modelo').focus();
            showToast("Informe o modelo para iniciar.");
        }

        function prepararAgendamentoRapido() {
            const placa = document.getElementById('span-nova-placa').innerText;
            toggleModal('modalDecisaoNovaPlaca');
            switchTab('agendamentos');
            document.getElementById('agenda-placa').value = placa;
            document.getElementById('agenda-modelo').focus();
        }

        // Resetar o campo quando abrir o modal
        const originalToggle = toggleModal;
        toggleModal = function (id) {
            originalToggle(id);
            if (id === 'modalBuscaPlaca' && !document.getElementById(id).classList.contains('hidden')) {
                document.getElementById('input-placa-busca').value = '';
                document.getElementById('input-placa-busca').focus();
                document.getElementById('resultado-busca-placa').classList.add('hidden');
            }
        }

        // Atalho F2 para abrir a busca rápida
        // Atalho de Segurança Manual: ALT + S
        window.addEventListener('keydown', (e) => {
            // Verifica se a tecla Alt está pressionada E a tecla S
            if (e.altKey && e.key.toLowerCase() === 's') {
                e.preventDefault(); // Impede ações do navegador

                const modalAlerta = document.getElementById('modalAlertaSeguranca');
                if (modalAlerta) {
                    // Define uma placa genérica para o alerta manual
                    document.getElementById('alerta-placa-clonada').innerText = "SUSPEITO";

                    // Abre o modal
                    modalAlerta.classList.replace('hidden', 'flex');

                    // Registra o log silencioso no banco de dados
                    registrarLogSeguranca("ACIONAMENTO MANUAL", "OPERADOR IDENTIFICOU ATITUDE SUSPEITA");

                    // Efeitos sonoros e ícones
                    playSfx('saida');
                    lucide.createIcons();

                    console.log("Alerta de segurança manual ativado via ALT+S");
                }
            }
        });

        function prepararTicket(veiculo) {
            const dataFormatada = new Date(veiculo.entrada).toLocaleString('pt-BR');
            document.getElementById('info-veiculo-sucesso').innerText = `${veiculo.modelo} - ${veiculo.placa}`;

            // CONFIGURAÇÃO DA IMPRESSÃO TÉRMICA
            document.getElementById('btn-imprimir-ticket').onclick = () => {
                const printSec = document.getElementById('print-section');

                // Removemos a classe 'hidden' para o navegador "enxergar" o conteúdo antes de imprimir
                printSec.classList.remove('hidden');

                printSec.innerHTML = `
            <div style="width: 80mm; padding: 5mm; font-family: 'Overpass Mono', monospace; color: #000; background: #fff;">
                <div style="text-align: center; border-bottom: 1px dashed #000; padding-bottom: 5px; margin-bottom: 10px;">
                    <h2 style="margin: 0; font-size: 18px;">HAYDEN PARKING</h2>
                    <p style="font-size: 10px; margin: 2px 0;">Controle de Acesso</p>
                </div>
                
                <div style="text-align: center; font-size: 24px; font-weight: 900; margin: 10px 0;">
                    ${veiculo.placa}
                </div>
                
                <div style="font-size: 12px; line-height: 1.5;">
                    <p><strong>MOD:</strong> ${veiculo.modelo}</p>
                    <p><strong>DATA:</strong> ${dataFormatada}</p>
                    <p><strong>VALOR HORA:</strong> R$ ${config.valorHora.toFixed(2)}</p>
                </div>

                <div style="text-align: center; border-top: 1px dashed #000; margin-top: 10px; padding-top: 5px; font-size: 9px;">
                    NÃO SOMOS RESPONSÁVEIS POR OBJETOS DEIXADOS NO INTERIOR DO VEÍCULO.
                </div>
            </div>`;

                window.print();

                // Ocultamos novamente após enviar para a fila de impressão
                setTimeout(() => printSec.classList.add('hidden'), 500);
            };

            // CONFIGURAÇÃO DO WHATSAPP DIRETO
            document.getElementById('btn-whatsapp-ticket').onclick = () => {
                const texto = `*TICKET DE ENTRADA - HAYDEN PARKING*\n\n` +
                    `🚗 *Veículo:* ${veiculo.modelo}\n` +
                    `🆔 *Placa:* ${veiculo.placa}\n` +
                    `🕒 *Entrada:* ${dataFormatada}\n` +
                    `💰 *Valor Hora:* R$ ${config.valorHora.toFixed(2)}\n\n` +
                    `_Conserve este ticket para a sua saída._`;

                const urlBase = veiculo.telefone
                    ? `https://api.whatsapp.com/send?phone=55${veiculo.telefone}&text=${encodeURIComponent(texto)}`
                    : `https://api.whatsapp.com/send?text=${encodeURIComponent(texto)}`;

                window.open(urlBase, '_blank');
            };

            toggleModal('modalSucessoEntrada');
        }

        function prepararReciboSaida(veiculo, info) {
            const dataSaida = new Date().toLocaleString('pt-BR');
            const dataEntrada = new Date(veiculo.entrada).toLocaleString('pt-BR');

            document.getElementById('info-veiculo-saida').innerText = `${veiculo.modelo} - ${veiculo.placa}`;

            // CONFIGURAÇÃO DA IMPRESSÃO TÉRMICA DE SAÍDA
            document.getElementById('btn-imprimir-recibo').onclick = () => {
                const printSec = document.getElementById('print-section');
                printSec.classList.remove('hidden');

                printSec.innerHTML = `
            <div style="width: 80mm; padding: 5mm; font-family: 'Overpass Mono', monospace; color: #000; background: #fff;">
                <div style="text-align: center; border-bottom: 1px dashed #000; padding-bottom: 5px; margin-bottom: 10px;">
                    <h2 style="margin: 0; font-size: 18px;">HAYDEN PARKING</h2>
                    <p style="font-size: 10px; margin: 2px 0;">Recibo de Pagamento</p>
                </div>
                
                <div style="text-align: center; font-size: 20px; font-weight: 900; margin: 10px 0;">
                    ${veiculo.placa}
                </div>
                
                <div style="font-size: 11px; line-height: 1.4;">
                    <p><strong>ENTRADA:</strong> ${dataEntrada}</p>
                    <p><strong>SAÍDA:</strong> ${dataSaida}</p>
                    <p><strong>TEMPO:</strong> ${info.horas}h ${info.minutos}m</p>
                    <hr style="border: 0; border-top: 1px dashed #000; margin: 10px 0;">
                    <div style="display: flex; justify-content: space-between;"><span>VAGA:</span> <span>R$ ${info.valorTempo.toFixed(2)}</span></div>
                    <div style="display: flex; justify-content: space-between;"><span>EXTRAS:</span> <span>R$ ${info.valorExtras.toFixed(2)}</span></div>
                    <div style="display: flex; justify-content: space-between; font-weight: 900; font-size: 14px; margin-top: 5px;">
                        <span>TOTAL PAGO:</span> <span>R$ ${info.total.toFixed(2)}</span>
                    </div>
                </div>

                <div style="text-align: center; border-top: 1px dashed #000; margin-top: 10px; padding-top: 5px; font-size: 9px;">
                    OBRIGADO PELA PREFERÊNCIA! VOLTE SEMPRE.
                </div>
            </div>`;

                window.print();
                setTimeout(() => printSec.classList.add('hidden'), 500);
            };

            // CONFIGURAÇÃO DO WHATSAPP DE SAÍDA
            document.getElementById('btn-whatsapp-recibo').onclick = () => {
                const texto = `*RECIBO DE PAGAMENTO - HAYDEN PARKING*\n\n` +
                    `🚗 *Veículo:* ${veiculo.modelo} (${veiculo.placa})\n` +
                    `🕒 *Entrada:* ${dataEntrada}\n` +
                    `🕒 *Saída:* ${dataSaida}\n` +
                    `⌛ *Permanência:* ${info.horas}h ${info.minutos}m\n` +
                    `------------------------------\n` +
                    `💰 *Valor Vaga:* R$ ${info.valorTempo.toFixed(2)}\n` +
                    `➕ *Serviços/Extras:* R$ ${info.valorExtras.toFixed(2)}\n` +
                    `✅ *TOTAL PAGO:* R$ ${info.total.toFixed(2)}\n\n` +
                    `_Obrigado pela preferência!_`;

                const urlBase = veiculo.telefone
                    ? `https://api.whatsapp.com/send?phone=55${veiculo.telefone}&text=${encodeURIComponent(texto)}`
                    : `https://api.whatsapp.com/send?text=${encodeURIComponent(texto)}`;

                window.open(urlBase, '_blank');
            };

            toggleModal('modalSucessoSaida');
        }

        // Estado global para controlar a exibição da tabela
        let exibirTodosPatio = false;

        function mascaraTelefone(input) {
            let v = input.value.replace(/\D/g, ''); // Remove tudo que não é número
            if (v.length > 11) v = v.slice(0, 11);

            if (v.length <= 2) {
                input.value = v.length > 0 ? `(${v}` : v;
            } else if (v.length <= 3) {
                input.value = `(${v.slice(0, 2)}) ${v.slice(2)}`;
            } else if (v.length <= 7) {
                input.value = `(${v.slice(0, 2)}) ${v.slice(2, 3)} ${v.slice(3)}`;
            } else {
                input.value = `(${v.slice(0, 2)}) ${v.slice(2, 3)} ${v.slice(3, 7)}-${v.slice(7)}`;
            }
        }


        function exportarBackup() {
            const dados = {
                config: localStorage.getItem('park_config'),

                catalogo: localStorage.getItem('park_catalogo'),
                resumo: localStorage.getItem('park_resumo'),
                historico: localStorage.getItem('park_pro_historico')
            };
            const blob = new Blob([JSON.stringify(dados)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_hayden_${new Date().toLocaleDateString()}.json`;
            a.click();
            showToast("Backup baixado com sucesso!");
        }

        function exportarBackup() {
            // Reúne todos os dados do sistema
            const dadosParaBackup = {
                configuracoes: localStorage.getItem('park_config'),

                catalogoItens: localStorage.getItem('park_catalogo'),
                financeiro: localStorage.getItem('park_resumo'),
                historicoGeral: localStorage.getItem('park_pro_historico'),
                dataExportacao: new Date().toISOString()
            };

            // Cria o arquivo JSON
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dadosParaBackup, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `HAYDEN_BACKUP_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`);
            document.body.appendChild(downloadAnchorNode);

            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            showToast("Backup gerado com sucesso!");
        }

        function importarBackup(event) {
            const arquivo = event.target.files[0];
            if (!arquivo) return;

            const leitor = new FileReader();
            leitor.onload = function (e) {
                try {
                    const dados = JSON.parse(e.target.result);

                    // Validação básica: verifica se existem chaves essenciais
                    if (!dados.configuracoes && !dados.patioAtivo) {
                        throw new Error("Arquivo de backup inválido.");
                    }

                    // Mapeia os dados do arquivo de volta para o LocalStorage
                    if (dados.configuracoes) localStorage.setItem('park_config', dados.configuracoes);
                    if (dados.patioAtivo) localStorage.setItem('park_pro_patio', dados.patioAtivo);
                    if (dados.catalogoItens) localStorage.setItem('park_catalogo', dados.catalogoItens);
                    if (dados.financeiro) localStorage.setItem('park_resumo', dados.financeiro);
                    if (dados.historicoGeral) localStorage.setItem('park_pro_historico', dados.historicoGeral);

                    showToast("Backup restaurado com sucesso!", "success");

                    // Recarrega as variáveis globais e a tela
                    setTimeout(() => {
                        location.reload(); // Recarrega a página para aplicar todas as configurações
                    }, 1500);

                } catch (erro) {
                    showToast("Erro ao importar: Arquivo corrompido ou inválido.", "error");
                }
            };
            leitor.readAsText(arquivo);
        }

        let meuGrafico = null; // Armazena a instância do gráfico

        let chartSemanal = null;
        let chartMensal = null;

        function atualizarGrafico() {
            // 1. DADOS BASE
            const historicoGeral = JSON.parse(localStorage.getItem('park_pro_historico')) || [];

            const hoje = new Date();
            const hojeStr = hoje.toLocaleDateString();

            // 2. CÁLCULO FLUXO POR HORA (HOJE)
            const ctxFluxo = document.getElementById('movimentacaoChart').getContext('2d');
            // Altere para usar a variável que alimentamos do Supabase
            const todasEntradasHoje = [
                ...patioAtivo.map(v => ({ entrada: v.entrada })), // Use patioAtivo aqui
                ...historico.filter(h => new Date(h.entrada).toLocaleDateString() === hojeStr)
            ];
            const contagemHoras = Array(24).fill(0);
            todasEntradasHoje.forEach(item => contagemHoras[new Date(item.entrada).getHours()]++);

            // Identificar Pico
            const maiorVolume = Math.max(...contagemHoras);
            const horaPico = contagemHoras.indexOf(maiorVolume);
            document.getElementById('bi-horario-pico').innerText = maiorVolume > 0 ? `${horaPico.toString().padStart(2, '0')}:00h` : "--:00h";

            // 3. CÁLCULO FATURAMENTO SEMANAL (Últimos 7 dias)
            const ctxSemanal = document.getElementById('chartFaturamentoSemanal').getContext('2d');
            const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            const labelsSemana = [];
            const valoresSemana = [];

            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dataStr = d.toLocaleDateString();
                labelsSemana.push(diasSemana[d.getDay()]);

                const totalDia = historicoGeral
                    .filter(h => new Date(h.saida).toLocaleDateString() === dataStr)
                    .reduce((acc, h) => acc + h.valor, 0);
                valoresSemana.push(totalDia);
            }

            // 4. CÁLCULO FATURAMENTO MENSAL (Ano Atual)
            const ctxMensal = document.getElementById('chartFaturamentoMensal').getContext('2d');
            const mesesLabel = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const valoresMensal = Array(12).fill(0);

            historicoGeral.forEach(h => {
                const dataSaida = new Date(h.saida);
                if (dataSaida.getFullYear() === hoje.getFullYear()) {
                    valoresMensal[dataSaida.getMonth()] += h.valor;
                }
            });

            // 5. ATUALIZAR INDICADORES
            const atendidosMes = historicoGeral.filter(h => new Date(h.saida).getMonth() === hoje.getMonth());
            const totalMes = atendidosMes.reduce((acc, h) => acc + h.valor, 0);
            const ticketMédio = atendidosMes.length > 0 ? totalMes / atendidosMes.length : 0;
            const totalMensalistas = mensalistas.reduce((acc, m) => acc + (m.valorPlano || config.mensalValor), 0);

            document.getElementById('bi-ticket-medio').innerText = `R$ ${ticketMédio.toFixed(2)}`;
            document.getElementById('bi-total-veiculos').innerText = atendidosMes.length;
            document.getElementById('bi-previsao-mensal').innerText = `R$ ${totalMensalistas.toFixed(2)}`;

            // 6. RENDERIZAR GRÁFICOS (Chart.js)
            renderizarChart(ctxFluxo, 'Entradas', contagemHoras, '#6366f1', true);
            if (chartSemanal) chartSemanal.destroy();
            chartSemanal = new Chart(ctxSemanal, {
                type: 'bar',
                data: {
                    labels: labelsSemana,
                    datasets: [{ label: 'Faturamento R$', data: valoresSemana, backgroundColor: '#10b981', borderRadius: 8 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            if (chartMensal) chartMensal.destroy();
            chartMensal = new Chart(ctxMensal, {
                type: 'line',
                data: {
                    labels: mesesLabel,
                    datasets: [{ label: 'Faturamento R$', data: valoresMensal, borderColor: '#4f46e5', tension: 0.4, fill: true, backgroundColor: 'rgba(79, 70, 229, 0.1)' }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function renderizarChart(ctx, label, data, color, isLine = false) {
            if (window.meuGrafico) window.meuGrafico.destroy();
            window.meuGrafico = new Chart(ctx, {
                type: isLine ? 'line' : 'bar',
                data: {
                    labels: data.map((_, i) => `${i}h`),
                    datasets: [{ label: label, data: data, borderColor: color, backgroundColor: color + '20', borderWidth: 3, fill: true, tension: 0.4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function calcularPrevisaoMensalidade() {
            const qtd = parseInt(document.getElementById('mens-qtd-placas').value) || 1;
            const total = qtd * config.mensalValor;
            document.getElementById('previzao-valor-mensal').innerText = `R$ ${total.toFixed(2)}`;
            return total;
        }

        // Inicialização do banco de mensalistas


        // 2. Atualizar função de Salvar Mensalista
        async function salvarMensalista() {
            const nome = document.getElementById('mens-nome').value.toUpperCase();
            const placa = document.getElementById('mens-placa').value.toUpperCase();
            const tel = document.getElementById('mens-telefone').value;
            const cpf = document.getElementById('mens-cpf').value;
            const venc = document.getElementById('mens-vencimento').value;
            const qtdPlacas = parseInt(document.getElementById('mens-qtd-placas').value) || 1;
            const telInput = document.getElementById('mens-telefone');

            if (tel.length < 11) {
                showToast("O telefone do mensalista deve ter 11 dígitos!", "error");
                telInput.focus();
                return;
            }

            if (!nome || !placa || !venc) return showToast("Preencha os campos obrigatórios!", "error");

            // Objeto formatado para o banco de dados Supabase
            const novoMensalista = {
                nome: nome,
                placa: placa,
                telefone: tel,
                cpf: cpf,
                vencimento: venc,
                limite_placas: qtdPlacas,
                valor_plano: qtdPlacas * config.mensalValor
            };

            // --- COMUNICAÇÃO COM SUPABASE ---
            const { error } = await _supabase
                .from('mensalistas')
                .insert([novoMensalista]);

            if (error) {
                console.error("Erro ao salvar mensalista:", error);
                return showToast("Erro ao salvar no banco de dados!", "error");
            }

            // Atualiza as variáveis globais carregando os dados novos do banco
            await carregarDadosIniciais();

            // Limpar campos da interface
            ['mens-nome', 'mens-placa', 'mens-telefone', 'mens-cpf', 'mens-vencimento'].forEach(id => {
                document.getElementById(id).value = '';
            });

            showToast("Mensalista salvo na nuvem!");
            renderizar();
        }

        function editarMensalista(id) {
            const m = mensalistas.find(x => x.id === id);
            if (!m) return;

            // Preenche os inputs com os dados atuais
            document.getElementById('mens-nome').value = m.nome;
            document.getElementById('mens-placa').value = m.placa;
            document.getElementById('mens-telefone').value = m.telefone || '';
            document.getElementById('mens-vencimento').value = m.vencimento;
            document.getElementById('mens-qtd-placas').value = m.limitePlacas || 1;

            // Atualiza o valor visual do plano no formulário
            calcularPrevisaoMensalidade();

            // Remove o registro antigo para que, ao clicar em "Ativar Plano", ele salve como novo/atualizado
            // Ou você pode mudar o texto do botão para "Atualizar"
            mensalistas = mensalistas.filter(x => x.id !== id);

            showToast("Dados carregados para edição!");
            document.getElementById('mens-nome').focus();
        }

        function renderMensalistas() {
            const container = document.getElementById('lista-mensalistas');
            if (!container) return;

            container.innerHTML = mensalistas.map(m => {
                return `
            <tr class="hover:bg-slate-50/50 transition-all">
                <td class="px-6 py-4">
                    <strong class="text-slate-800">${m.nome}</strong>
                    <span class="ml-2 text-[9px] bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full font-bold">
                        ${m.limitePlacas || 1} Placa(s)
                    </span>
                    <br>
                    <span class="text-[11px] bg-slate-200 px-2 py-0.5 rounded font-bold font-mono">${m.placa}</span>
                </td>
                <td class="px-6 py-4 text-center">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Vencimento</p>
                    <span class="font-bold text-sm text-slate-600">${new Date(m.vencimento).toLocaleDateString('pt-BR')}</span>
                </td>
                <td class="px-6 py-4 text-center">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Valor Mensal</p>
                    <span class="font-black text-indigo-600">R$ ${(m.valorPlano || config.mensalValor).toFixed(2)}</span>
                </td>
                <td class="px-6 py-4 text-right flex justify-end gap-2">
                    <button onclick="visualizarMensalista(${m.id})" class="text-slate-400 hover:text-indigo-600 p-2 rounded-lg transition-all" title="Visualizar Detalhes">
                        <i data-lucide="eye" class="w-5 h-5"></i>
                    </button>

                    <button onclick="editarMensalista(${m.id})" class="text-amber-500 hover:bg-amber-50 p-2 rounded-lg transition-all" title="Editar Cadastro">
                        <i data-lucide="edit-3" class="w-5 h-5"></i>
                    </button>
                    
                    <button onclick="renovarMensalista(${m.id})" class="text-indigo-500 hover:bg-indigo-50 p-2 rounded-lg transition-all" title="Renovar 30 dias">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                    </button>
                    
                    <button onclick="removerMensalista(${m.id})" class="text-slate-300 hover:text-rose-500 p-2 rounded-lg transition-all">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </td>
            </tr>
        `;
            }).join('');
            lucide.createIcons();
        }

        async function renovarMensalista(id) {
            const index = mensalistas.findIndex(m => m.id === id);
            if (index === -1) return;

            const hoje = new Date();
            let dataAtual = new Date(mensalistas[index].vencimento);

            if (dataAtual < hoje) dataAtual = hoje;

            dataAtual.setDate(dataAtual.getDate() + 30);
            const novaDataStr = dataAtual.toISOString().split('T')[0];

            // --- ATUALIZAÇÃO NO SUPABASE ---
            const { error } = await _supabase
                .from('mensalistas')
                .update({ vencimento: novaDataStr })
                .eq('id', id);

            if (error) {
                return showToast("Erro ao renovar no banco!", "error");
            }

            await carregarDadosIniciais();
            showToast(`Plano de ${mensalistas[index].nome} renovado no sistema!`);
            renderizar();

            // Lógica de envio de WhatsApp permanece a mesma...
            enviarNotificacaoWpp(mensalistas[index], novaDataStr);
        }

        function cobrarInadimplente(id, dias) {
            const m = mensalistas.find(x => x.id === id);
            if (!m || !m.telefone) return showToast("Telefone não cadastrado!", "error");

            const texto = `*AVISO DE COBRANÇA - HAYDEN PARKING*\n\n` +
                `⚠️ Olá, *${m.nome}*.\n` +
                `Identificamos que seu plano (Placa: *${m.placa}*) está vencido há *${dias} dias*.\n\n` +
                `Por favor, regularize sua situação para evitar a cobrança de tarifa avulsa por hora.\n\n` +
                `_Dúvidas? Entre em contato conosco._`;

            const telLimpo = m.telefone.replace(/\D/g, '');
            const url = `https://wa.me/55${telLimpo}?text=${encodeURIComponent(texto)}`;

            const win = window.open(url, '_blank');
            if (!win) showToast("Pop-up bloqueado pelo navegador!", "error");
        }

        function renderInadimplentes() {
            const container = document.getElementById('lista-inadimplentes');
            const hoje = new Date();

            // Filtra mensalistas vencidos há mais de 5 dias
            const inadimplentes = mensalistas.filter(m => {
                const dataVenc = new Date(m.vencimento);
                const diffMs = hoje - dataVenc;
                const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                return diffDias > 5;
            });

            if (inadimplentes.length === 0) {
                container.innerHTML = `<tr><td colspan="4" class="px-6 py-10 text-center text-slate-400 font-medium">Nenhum inadimplente crítico encontrado.</td></tr>`;
                return;
            }

            container.innerHTML = inadimplentes.map(m => {
                const dataVenc = new Date(m.vencimento);
                const diffDias = Math.floor((hoje - dataVenc) / (1000 * 60 * 60 * 24));

                return `
            <tr class="bg-rose-50/30 hover:bg-rose-50 transition-all">
                <td class="px-6 py-5">
                    <strong class="text-rose-900">${m.nome}</strong><br>
                    <span class="text-[11px] bg-rose-200 text-rose-700 px-2 py-0.5 rounded font-bold font-mono">${m.placa}</span>
                </td>
                <td class="px-6 py-5 text-center font-bold text-rose-600">${dataVenc.toLocaleDateString('pt-BR')}</td>
                <td class="px-6 py-5 text-center font-black text-rose-700 text-lg">${diffDias} DIAS</td>
                <td class="px-6 py-5 text-right">
                    <button onclick="cobrarInadimplente(${m.id}, ${diffDias})" class="bg-rose-600 text-white px-4 py-2 rounded-xl text-xs font-black shadow-lg shadow-rose-200 hover:bg-rose-700 transition-all flex items-center gap-2 ml-auto">
                        <i data-lucide="message-square" class="w-4 h-4"></i> COBRAR AGORA
                    </button>
                </td>
            </tr>
        `;
            }).join('');
            lucide.createIcons();
        }

        function cobrarInadimplente(id, dias) {
            const m = mensalistas.find(x => x.id === id);
            const texto = `*AVISO DE COBRANÇA - HAYDEN PARKING*\n\n` +
                `⚠️ Olá, *${m.nome}*.\n` +
                `Identificamos que seu plano (Placa: *${m.placa}*) está vencido há *${dias} dias*.\n\n` +
                `Por favor, regularize sua situação para evitar a cobrança de tarifa avulsa por hora.\n\n` +
                `_Dúvidas? Entre em contato conosco._`;

            const telLimpo = m.telefone.replace(/\D/g, '');
            window.open(`https://api.whatsapp.com/send?phone=55${telLimpo}&text=${encodeURIComponent(texto)}`, '_blank');
        }

        // --- SISTEMA DE SEGURANÇA HAYDEN PARKING PRO 2.0 ---
        // Certifique-se de que este objeto está no topo do seu script
        const SEGURANCA_PRO = {
            TEMPO_DEMO_TOTAL: 30 * 60, // 30 minutos
            // Gera um ID baseado no hardware/navegador
            ID_MAQUINA: btoa(navigator.userAgent + screen.colorDepth).slice(5, 15).toUpperCase()
        };

        let tempoRestante = parseInt(localStorage.getItem('park_demo_timer')) || SEGURANCA_PRO.TEMPO_DEMO_TOTAL;
        let licencaAtiva = localStorage.getItem('park_licenca_permanente') === 'true';

        // Função consolidada de Inicialização
        window.onload = () => {
            // 1. Mostrar o ID no Modal e na Sidebar
            const idModal = document.getElementById('display-id-modal');
            const idSidebar = document.getElementById('display-id-maquina');

            if (idModal) idModal.innerText = SEGURANCA_PRO.ID_MAQUINA;
            if (idSidebar) idSidebar.innerText = SEGURANCA_PRO.ID_MAQUINA;

            // 2. Configurar o Atalho Secreto (5 cliques na Chave)
            const iconeChave = document.getElementById('chave-secreta-ativa');
            let cliquesChave = 0;

            if (iconeChave) {
                iconeChave.onclick = () => {
                    cliquesChave++;
                    console.log("Cliques na chave:", cliquesChave); // Para você testar no F12
                    if (cliquesChave === 5) {
                        document.getElementById('modalGeradorHayden').classList.replace('hidden', 'flex');
                        cliquesChave = 0;
                        showToast("Acesso Administrativo Liberado");
                        lucide.createIcons();
                    }
                };
            }

            // 3. Verificar status da licença ao abrir
            if (licencaAtiva) {
                configurarInterfaceAtivada();
            } else {
                if (tempoRestante <= 0) encerrarSessao();
            }

            // 4. Funções Padrão do Sistema
            renderizar();
            atualizarGrafico();
            setInterval(renderizar, 1000);
            setInterval(updateSidebarClock, 1000);
            lucide.createIcons();

            // Foco inicial
            const campoModelo = document.getElementById('modelo');
            if (campoModelo) campoModelo.focus();
        };

        // Funções de Suporte à Licença
        function configurarInterfaceAtivada() {
            const modal = document.getElementById('modalLicenca');
            if (modal) modal.classList.add('hidden');

            const timer = document.getElementById('licenca-timer');
            if (timer) {
                timer.innerText = "VERSÃO PROFISSIONAL";
                timer.classList.replace('text-slate-500', 'text-emerald-500');
            }
        }

        // --- SISTEMA DE GERAÇÃO E VALIDAÇÃO CORRIGIDO ---

        function processarGeracao() {
            const idCliente = document.getElementById('gen-id-cliente').value.trim().toUpperCase();
            if (idCliente.length < 5) return showToast("ID do Cliente Inválido!", "error");

            // O segredo (SALT) deve ser exatamente o mesmo na geração e na validação
            const segredo = "HAYDEN_PRO_2026";
            const payload = btoa(idCliente + segredo);

            // Formata a chave final
            const chave = "HP-" + payload.slice(0, 4) + "-" + payload.slice(8, 12) + "-" + payload.slice(14, 18).toUpperCase();

            document.getElementById('gen-chave-resultado').value = chave;
            showToast("Licença gerada com sucesso!");
        }

        function copiarChaveGerada() {
            const input = document.getElementById('gen-chave-resultado');
            if (!input.value) return showToast("Gere uma chave primeiro!", "error");

            input.select();
            document.execCommand('copy');
            showToast("Chave copiada para o WhatsApp!");
        }

        function ativarLicencaPeloModal() {
            const input = document.getElementById('input-chave-licenca').value.trim().toUpperCase();
            const idLocal = SEGURANCA_PRO.ID_MAQUINA;

            // Recria a lógica exata do gerador para validar
            const segredo = "HAYDEN_PRO_2026";
            const payloadEsperado = btoa(idLocal + segredo);
            const chaveCorreta = "HP-" + payloadEsperado.slice(0, 4) + "-" + payloadEsperado.slice(8, 12) + "-" + payloadEsperado.slice(14, 18).toUpperCase();

            // Chave Mestra para seu uso pessoal ou Chave Gerada pelo algoritmo
            if (input === "2026HAYDENPARKING" || input.toUpperCase() === chaveCorreta.toUpperCase()) {
                licencaAtiva = true;
                localStorage.setItem('park_licenca_permanente', 'true');
                configurarInterfaceAtivada();
                showToast("Sistema Hayden Parking Ativado!", "success");
            } else {
                showToast("Esta chave não serve para este PC!", "error");
                console.log("ID Local:", idLocal);
                console.log("Chave que deveria ser usada:", chaveCorreta);
            }
        }

        // Adicione também a função de Modo Demo que estava faltando:
        function iniciarModoDemo() {
            if (tempoRestante <= 0) return encerrarSessao();
            document.getElementById('modalLicenca').classList.add('hidden');
            showToast("Modo Demo: 30 minutos liberados!", "success");

            const countdown = setInterval(() => {
                if (licencaAtiva) return clearInterval(countdown);

                tempoRestante--;
                localStorage.setItem('park_demo_timer', tempoRestante);

                if (tempoRestante <= 0) {
                    clearInterval(countdown);
                    encerrarSessao();
                }
            }, 1000);
        }

        function encerrarSessao() {
            location.reload(); // Força o bloqueio ao recarregar com tempo zerado
        }

        // 1. Máscara de CPF
        function mascaraCPF(input) {
            let v = input.value.replace(/\D/g, '');
            if (v.length > 11) v = v.slice(0, 11);
            if (v.length <= 11) {
                v = v.replace(/(\itud{3})(\d)/, "$1.$2");
                v = v.replace(/(\itud{3})(\d)/, "$1.$2");
                v = v.replace(/(\itud{3})(\d{1,2})$/, "$1-$2");
            }
            input.value = v;
        }
        // 3. Função para Visualizar Detalhes e Contar Usos
        function visualizarMensalista(id) {
            const m = mensalistas.find(x => x.id === id);
            if (!m) return;

            // Lógica para contar usos no mês atual
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();

            const usosNoMes = historico.filter(h => {
                const dataSaida = new Date(h.saida);
                return h.placa === m.placa &&
                    dataSaida.getMonth() === mesAtual &&
                    dataSaida.getFullYear() === anoAtual;
            }).length;

            // Preencher o modal
            document.getElementById('det-nome').innerText = m.nome;
            document.getElementById('det-cpf').innerText = m.cpf || 'Não informado';
            document.getElementById('det-placa').innerText = m.placa;
            document.getElementById('det-usos-mes').innerText = usosNoMes;

            toggleModal('modalDetalhesMensalista');
        }

        function gerarRelatorioMensalPDF() {
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();
            const nomeMes = hoje.toLocaleString('pt-BR', { month: 'long' }).toUpperCase();

            // 1. Filtrar histórico do mês atual
            const historicoMes = historico.filter(h => {
                const data = new Date(h.saida);
                return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
            });

            // 2. Cálculo de Horário de Pico Mensal
            const contagemHorasMensal = Array(24).fill(0);
            historicoMes.forEach(h => {
                const hora = new Date(h.entrada).getHours();
                contagemHorasMensal[hora]++;
            });
            const maiorVolumeMes = Math.max(...contagemHorasMensal);
            const horaPicoMes = contagemHorasMensal.indexOf(maiorVolumeMes);
            const strHoraPico = maiorVolumeMes > 0 ? `${horaPicoMes.toString().padStart(2, '0')}:00h` : "--:00h";

            const totalAvulso = historicoMes.reduce((acc, h) => acc + h.valor, 0);
            const totalMensalistas = mensalistas.reduce((acc, m) => acc + (m.valorPlano || config.mensalValor), 0);
            const totalGeral = totalAvulso + totalMensalistas;

            const printSec = document.getElementById('print-section');
            if (!printSec) return alert("Erro: Área de impressão não encontrada.");

            printSec.classList.remove('hidden');

            printSec.innerHTML = `
        <div style="width: 210mm; padding: 15mm; font-family: 'Overpass', sans-serif; color: #1e293b; background: #fff;">
            <div style="display: flex; justify-content: space-between; border-bottom: 4px solid #6366f1; padding-bottom: 15px; margin-bottom: 25px;">
                <div>
                    <h1 style="font-size: 26px; font-weight: 900; margin: 0;">RELATÓRIO DE PERFORMANCE</h1>
                    <p style="font-size: 14px; font-weight: 700; color: #6366f1; margin: 5px 0;">REF: ${nomeMes} / ${anoAtual}</p>
                </div>
                <div style="text-align: right;">
                    <h2 style="font-size: 18px; font-weight: 900; margin: 0;">HAYDEN PARKING</h2>
                    <p style="font-size: 10px; color: #64748b;">ID MÁQUINA: ${SEGURANCA_PRO.ID_MAQUINA}</p>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                <div style="background: #f8fafc; padding: 15px; border-radius: 15px; border: 1px solid #e2e8f0; text-align: center;">
                    <p style="font-size: 9px; font-weight: 800; color: #64748b; text-transform: uppercase;">Receita Mensalistas</p>
                    <p style="font-size: 18px; font-weight: 900; color: #4f46e5; margin: 5px 0;">R$ ${totalMensalistas.toFixed(2)}</p>
                </div>
                <div style="background: #f8fafc; padding: 15px; border-radius: 15px; border: 1px solid #e2e8f0; text-align: center;">
                    <p style="font-size: 9px; font-weight: 800; color: #64748b; text-transform: uppercase;">Receita Avulsos</p>
                    <p style="font-size: 18px; font-weight: 900; color: #10b981; margin: 5px 0;">R$ ${totalAvulso.toFixed(2)}</p>
                </div>
                <div style="background: #fff1f2; padding: 15px; border-radius: 15px; border: 1px solid #fecdd3; text-align: center;">
                    <p style="font-size: 9px; font-weight: 800; color: #e11d48; text-transform: uppercase;">Horário de Pico</p>
                    <p style="font-size: 18px; font-weight: 900; color: #e11d48; margin: 5px 0;">${strHoraPico}</p>
                </div>
            </div>

            <div style="background: #1e293b; color: #fff; padding: 20px; text-align: center; border-radius: 20px; margin-bottom: 30px;">
                <p style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7;">Faturamento Bruto Consolidado</p>
                <p style="font-size: 32px; font-weight: 900; margin: 5px 0;">R$ ${totalGeral.toFixed(2)}</p>
            </div>

            <h3 style="font-size: 13px; font-weight: 900; border-bottom: 2px solid #f1f5f9; padding-bottom: 8px; margin-bottom: 12px; text-transform: uppercase;">Detalhamento de Fluxo Mensal</h3>
            <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                <thead>
                    <tr style="background: #f8fafc; text-align: left;">
                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0;">DATA/HORA SAÍDA</th>
                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0;">VEÍCULO</th>
                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0;">PLACA</th>
                        <th style="padding: 10px; border-bottom: 2px solid #e2e8f0; text-align: right;">VALOR</th>
                    </tr>
                </thead>
                <tbody>
                    ${historicoMes.length > 0 ? historicoMes.map(h => `
                        <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #f1f5f9;">${new Date(h.saida).toLocaleString('pt-BR')}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #f1f5f9; font-weight: 700;">${h.modelo}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #f1f5f9;">${h.placa}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: right; font-weight: 800; color: #10b981;">R$ ${h.valor.toFixed(2)}</td>
                        </tr>
                    `).join('') : '<tr><td colspan="4" style="padding: 20px; text-align: center;">Nenhum registro no período.</td></tr>'}
                </tbody>
            </table>

            <div style="margin-top: 40px; border-top: 1px solid #e2e8f0; padding-top: 15px; text-align: center; font-size: 9px; color: #94a3b8;">
                Relatório gerado automaticamente via Hayden Parking Pro.
            </div>
        </div>
    `;

            setTimeout(() => {
                window.print();
                printSec.classList.add('hidden');
                printSec.innerHTML = '';
            }, 250);

        }


        function gerarRelatorioFiltrado() {
            const mesFiltro = document.getElementById('filtro-mes').value;
            if (mesFiltro === "all") {
                return alert("Para imprimir todos os meses, use o botão 'Relatório Geral'.");
            }

            // Reutiliza a lógica existente mas com o mês selecionado
            const dataFalsa = new Date();
            dataFalsa.setMonth(parseInt(mesFiltro));

            // Chamamos a função de geração alterando temporariamente o contexto (se necessário) ou criando uma nova
            gerarRelatorioEspecifico(parseInt(mesFiltro), dataFalsa.getFullYear());
        }

        function gerarRelatorioAnualPDF() {
            const historicoGeral = JSON.parse(localStorage.getItem('park_pro_historico')) || [];
            const hoje = new Date();
            const ano = hoje.getFullYear();

            const printSec = document.getElementById('print-section');
            printSec.classList.remove('hidden');

            let htmlTabelaMeses = "";
            let totalAnual = 0;

            for (let m = 0; m < 12; m++) {
                const hMes = historicoGeral.filter(h => {
                    const d = new Date(h.saida);
                    return d.getMonth() === m && d.getFullYear() === ano;
                });
                const total = hMes.reduce((acc, h) => acc + h.valor, 0);
                if (total > 0 || m <= hoje.getMonth()) {
                    totalAnual += total;
                    const nomeMes = new Date(2000, m, 1).toLocaleString('pt-BR', { month: 'long' }).toUpperCase();
                    htmlTabelaMeses += `
                <tr style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 12px; font-weight: 800;">${nomeMes}</td>
                    <td style="padding: 12px; text-align: center;">${hMes.length} Veículos</td>
                    <td style="padding: 12px; text-align: right; font-weight: 900; color: #4f46e5;">R$ ${total.toFixed(2)}</td>
                </tr>
            `;
                }
            }

            printSec.innerHTML = `
        <div style="width: 210mm; padding: 20mm; font-family: 'Overpass', sans-serif;">
            <div style="display: flex; justify-content: space-between; border-bottom: 5px solid #1e293b; padding-bottom: 20px; margin-bottom: 30px;">
                <h1 style="font-size: 32px; font-weight: 900; margin: 0;">RELATÓRIO ANUAL GERAL</h1>
                <div style="text-align: right;">
                    <p style="font-weight: 900; margin: 0;">HAYDEN PARKING ${ano}</p>
                    <p style="font-size: 10px; color: #64748b;">CONSOLIDADO DE FATURAMENTO</p>
                </div>
            </div>
            
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 40px;">
                <thead style="background: #f8fafc;">
                    <tr style="text-align: left; font-size: 10px; color: #64748b;">
                        <th style="padding: 12px;">MÊS DE REFERÊNCIA</th>
                        <th style="padding: 12px; text-align: center;">VOLUME</th>
                        <th style="padding: 12px; text-align: right;">TOTAL ARRECADADO</th>
                    </tr>
                </thead>
                <tbody>${htmlTabelaMeses}</tbody>
            </table>

            <div style="background: #1e293b; color: #fff; padding: 30px; border-radius: 25px; text-align: center;">
                <p style="font-size: 12px; font-weight: 700; opacity: 0.7; margin-bottom: 5px;">FATURAMENTO BRUTO ANUAL (AVULSOS)</p>
                <p style="font-size: 42px; font-weight: 900; margin: 0;">R$ ${totalAnual.toFixed(2)}</p>
            </div>
        </div>
    `;

            setTimeout(() => {
                window.print();
                printSec.classList.add('hidden');
            }, 250);
        }

        // Função para gerar relatório de um mês específico (filtrado)
        function gerarRelatorioEspecifico(mes, ano) {
            const historicoGeral = JSON.parse(localStorage.getItem('park_pro_historico')) || [];
            const nomeMes = new Date(ano, mes, 1).toLocaleString('pt-BR', { month: 'long' }).toUpperCase();

            const historicoFiltrado = historicoGeral.filter(h => {
                const d = new Date(h.saida);
                return d.getMonth() === mes && d.getFullYear() === ano;
            });

            const total = historicoFiltrado.reduce((acc, h) => acc + h.valor, 0);
            const printSec = document.getElementById('print-section');
            printSec.classList.remove('hidden');

            printSec.innerHTML = `
        <div style="width: 210mm; padding: 20mm; font-family: 'Overpass', sans-serif;">
            <h1 style="border-bottom: 4px solid #10b981; padding-bottom: 10px;">RELATÓRIO MENSAL: ${nomeMes}</h1>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0;">
                <div style="background: #f0fdf4; p: 20px; border-radius: 20px; border: 1px solid #bbf7d0; padding: 20px;">
                    <p style="font-size: 10px; font-weight: 800; color: #166534;">TOTAL ARRECADADO</p>
                    <p style="font-size: 28px; font-weight: 900; color: #10b981;">R$ ${total.toFixed(2)}</p>
                </div>
                <div style="background: #f8fafc; p: 20px; border-radius: 20px; border: 1px solid #e2e8f0; padding: 20px;">
                    <p style="font-size: 10px; font-weight: 800; color: #64748b;">VEÍCULOS ATENDIDOS</p>
                    <p style="font-size: 28px; font-weight: 900; color: #1e293b;">${historicoFiltrado.length}</p>
                </div>
            </div>
            <h3>Detalhamento de Saídas:</h3>
            <table style="width: 100%; font-size: 10px; border-collapse: collapse;">
                <tr style="background: #f1f5f9; text-align: left;">
                    <th style="padding: 8px;">DATA</th><th style="padding: 8px;">PLACA</th><th style="padding: 8px;">VALOR</th>
                </tr>
                ${historicoFiltrado.map(h => `<tr><td style="padding: 5px; border-bottom: 1px solid #eee;">${new Date(h.saida).toLocaleDateString()}</td><td style="padding: 5px; border-bottom: 1px solid #eee;">${h.placa}</td><td style="padding: 5px; border-bottom: 1px solid #eee;">R$ ${h.valor.toFixed(2)}</td></tr>`).join('')}
            </table>
        </div>
    `;

            setTimeout(() => {
                window.print();
                printSec.classList.add('hidden');
            }, 250);
        }


        let isSignUpMode = false;

        // Alterna entre Login e Cadastro na interface
        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            const title = document.getElementById('auth-title');
            const btnSubmit = document.getElementById('btn-auth-submit');
            const btnToggle = document.getElementById('btn-toggle-auth');

            if (isSignUpMode) {
                title.innerText = "Novo Estacionamento";
                btnSubmit.innerText = "CRIAR MINHA CONTA";
                btnToggle.innerText = "Já tenho conta? Fazer Login";
            } else {
                title.innerText = "Login de Parceiro";
                btnSubmit.innerText = "ENTRAR NO SISTEMA";
                btnToggle.innerText = "Não tem conta? Cadastre seu Estacionamento";
            }
        }

        // Decide qual ação tomar (Login ou Cadastro)
        async function handleAuthAction() {
            if (isSignUpMode) {
                await handleSignUp();
            } else {
                await handleLogin(); // Aquela que já criamos
            }
        }

        // Função de Cadastro Real
        async function handleSignUp() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;

            if (password.length < 6) return alert("A senha deve ter no mínimo 6 caracteres!");

            const { data, error } = await _supabase.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        role: 'owner' // Metadado para identificar que é um dono
                    }
                }
            });

            if (error) return alert("Erro no cadastro: " + error.message);

            alert("Sucesso! Verifique seu e-mail para confirmar o cadastro e começar a usar.");
            toggleAuthMode(); // Volta para o login
        }

        // Função para atualizar a senha no Supabase
        async function handlePasswordReset() {
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-new-password').value;
            const btn = document.getElementById('btn-reset-password');

            if (newPass.length < 6) return showToast("A senha deve ter no mínimo 6 dígitos!", "error");
            if (newPass !== confirmPass) return showToast("As senhas não conferem!", "error");

            btn.innerText = "PROCESSANDO...";
            btn.disabled = true;

            const { data, error } = await _supabase.auth.updateUser({
                password: newPass
            });

            if (error) {
                btn.innerText = "ATUALIZAR SENHA";
                btn.disabled = false;
                return showToast("Erro: " + error.message, "error");
            }

            showToast("Senha atualizada com sucesso!", "success");
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-new-password').value = '';
            btn.innerText = "ATUALIZAR SENHA";
            btn.disabled = false;

            // Opcional: Desloga o usuário após trocar a senha para segurança
            // handleLogout();
        }

        // Atualiza o e-mail exibido na tela de perfil
        async function updateProfileDisplay() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (user) {
                const display = document.getElementById('user-email-display');
                if (display) display.innerText = user.email.toUpperCase();
            }
        }

        // Modifique sua função switchTab existente para incluir a atualização do perfil:
        const originalSwitchTab = switchTab;
        switchTab = function (tabId) {
            originalSwitchTab(tabId);
            if (tabId === 'perfil') {
                updateProfileDisplay();
            }
        }

        async function handleForgotPassword() {
            const email = document.getElementById('auth-email').value;
            const btn = document.querySelector('[onclick="handleForgotPassword()"]');

            if (!email) {
                return showToast("Digite seu e-mail para recuperar a senha!", "error");
            }

            if (aguardandoEmail) {
                return showToast("Aguarde um momento antes de solicitar novamente!", "error");
            }

            // Inicia bloqueio e feedback visual
            aguardandoEmail = true;
            const textoOriginal = btn.innerText;
            btn.innerText = "ENVIANDO...";
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            const { error } = await _supabase.auth.resetPasswordForEmail(email, {
                // Altere para a URL exata onde o arquivo reset_password_parking.html está hospedado
                redirectTo: 'http://haydenfernandes.com.br/reset_password_parking.html',
            });

            if (error) {
                aguardandoEmail = false;
                btn.innerText = textoOriginal;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                return showToast("Erro: " + error.message, "error");
            }

            // Sucesso: Mostra o popup personalizado que já criamos
            toggleModal('modalEmailEnviado');
            lucide.createIcons();

            // Inicia contagem regressiva de 60 segundos para liberar o botão
            let segundos = 60;
            const intervalo = setInterval(() => {
                segundos--;
                btn.innerText = `AGUARDE (${segundos}s)`;

                if (segundos <= 0) {
                    clearInterval(intervalo);
                    aguardandoEmail = false;
                    btn.innerText = textoOriginal;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }, 1000);
        }

        function renderAgenda() {
            const container = document.getElementById('lista-agendamentos');
            if (!container) return;

            container.innerHTML = agenda.map(res => `
                <tr class="border-b border-slate-50 hover:bg-indigo-50/30 transition-all">
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-800">${res.modelo}</div>
                        <div class="text-[11px] font-mono bg-slate-100 text-slate-600 px-2 py-0.5 rounded inline-block">${res.placa}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-500 text-center">
                        ${new Date(res.data_prevista).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}
                    </td>
                    <td class="px-6 py-4 text-right flex justify-end gap-2">
                        <button onclick="iniciarDaReserva(${res.id})" 
                            class="bg-emerald-500 text-white px-3 py-2 rounded-xl text-[10px] font-black hover:bg-emerald-600 transition-all uppercase tracking-tighter">
                            INICIAR
                        </button>
                
                        <button onclick="cancelarReserva(${res.id})" 
                            class="bg-rose-50 text-rose-600 border border-rose-100 px-3 py-2 rounded-xl hover:bg-rose-600 hover:text-white transition-all shadow-sm"
                            title="Excluir Reserva">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            // Inicializa os ícones do Lucide após renderizar
            lucide.createIcons();
        }

        async function cancelarReserva(id) {
            if (!confirm("Deseja realmente excluir este agendamento permanentemente?")) return;

            // Remove do Supabase
            const { error } = await _supabase
                .from('agendamentos')
                .delete()
                .eq('id', id);

            if (error) {
                console.error("Erro ao excluir reserva:", error);
                return showToast("Erro ao excluir do banco!", "error");
            }

            // Atualiza a memória local e a tela
            await carregarDadosIniciais();
            showToast("Reserva removida com sucesso!");
            renderizar();
        }

        // Adicione ou atualize esta função no seu script
        function aplicarMascaraPlaca(input) {
            let valor = input.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
            if (valor.length > 7) valor = valor.slice(0, 7);
            input.value = valor;

            // Remove classes anteriores
            input.classList.remove('border-blue-500', 'border-emerald-500', 'border-rose-500');

            if (valor.length === 7) {
                const regexAntigo = /^[A-Z]{3}[0-9]{4}$/;
                const regexMercosul = /^[A-Z]{3}[0-9][A-Z][0-9]{2}$/;

                if (regexMercosul.test(valor)) {
                    input.classList.add('border-blue-500'); // Cor padrão Mercosul
                    showToast("Placa Mercosul Detectada", "success");
                } else if (regexAntigo.test(valor)) {
                    input.classList.add('border-emerald-500'); // Cor padrão Antiga
                    showToast("Placa Padrão Antigo Detectada", "success");
                } else {
                    input.classList.add('border-rose-500');
                    showToast("Formato de Placa Inválido", "error");
                }
            }
        }

        function validarPlacaReal(placa) {
            // Remove qualquer caractere que não seja letra ou número antes de validar
            const p = placa.replace(/[^A-Z0-9]/ig, "").toUpperCase();

            // Regex Antiga: 3 Letras + 4 Números
            const regexAntigo = /^[A-Z]{3}[0-9]{4}$/;

            // Regex Mercosul: 3 Letras + 1 Número + 1 Letra + 2 Números
            const regexMercosul = /^[A-Z]{3}[0-9][A-Z][0-9]{2}$/;

            return regexAntigo.test(p) || regexMercosul.test(p);
        }

        async function enviarLembretesVencimento() {
            const hoje = new Date();
            let lembretesEnviados = 0;

            mensalistas.forEach(m => {
                const dataVenc = new Date(m.vencimento);
                const diffMs = dataVenc - hoje;
                const diffDias = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

                // Se vencer em exatamente 2 dias (ou entre 1 e 2)
                if (diffDias === 2 || diffDias === 1) {
                    const texto = `*LEMBRETE DE PAGAMENTO - HAYDEN PARKING*\n\n` +
                        `Olá, *${m.nome}*! 🚗\n` +
                        `Passando para lembrar que seu plano mensal vence em *${diffDias} dia(s)* (${new Date(m.vencimento).toLocaleDateString()}).\n\n` +
                        `Garanta a continuidade do seu acesso VIP. 🎟️`;

                    const telLimpo = m.telefone.replace(/\D/g, '');
                    window.open(`https://api.whatsapp.com/send?phone=55${telLimpo}&text=${encodeURIComponent(texto)}`, '_blank');
                    lembretesEnviados++;
                }
            });

            if (lembretesEnviados === 0) {
                showToast("Nenhum plano vencendo em 2 dias.", "info");
            }
        }

        // Variável global para armazenar os convênios
        let listaConvenios = [];

        // Carregar convênios do Supabase (adicione isso ao seu carregarDadosIniciais)
        async function carregarConvenios() {
            const { data, error } = await _supabase.from('convenios').select('*');
            if (!error) {
                listaConvenios = data;
                const select = document.getElementById('select-convenio');
                if (select) {
                    select.innerHTML = '<option value="">NENHUM CONVÊNIO</option>' +
                        data.map(c => `<option value="${c.id}">${c.nome_loja} (${c.valor_desconto}${c.tipo_desconto === 'PERCENTUAL' ? '%' : ' min'})</option>`).join('');
                }
            }
        }

        function recalcularComDesconto() {
            const idConvenio = document.getElementById('select-convenio').value;
            const veiculo = patioAtivo.find(v => v.id === window.clienteCheckoutAtualId);

            let infoOriginal = calcularCobranca(veiculo);
            let infoComDesconto = { ...infoOriginal };
            const convenio = listaConvenios.find(c => c.id == idConvenio);

            if (convenio) {
                if (convenio.tipo_desconto === 'MINUTOS') {
                    const entradaOriginal = new Date(veiculo.entrada);
                    const entradaComDesconto = new Date(entradaOriginal.getTime() + (convenio.valor_desconto * 60000));
                    const entradaFinal = entradaComDesconto > new Date() ? new Date() : entradaComDesconto;
                    infoComDesconto = calcularCobranca({ ...veiculo, entrada: entradaFinal.toISOString() });
                } else if (convenio.tipo_desconto === 'PERCENTUAL') {
                    infoComDesconto.total = infoOriginal.total * (1 - (convenio.valor_desconto / 100));
                }
            }

            descontoAtual = infoOriginal.total - infoComDesconto.total;
            document.getElementById('valor-total-display').innerText = `R$ ${infoComDesconto.total.toFixed(2)}`;
        }


        // Adicione 'carregarConvenios()' dentro do seu window.onload
        async function cadastrarNovoConvenio() {
            const nome = document.getElementById('conv-nome').value.toUpperCase();
            const tipo = document.getElementById('conv-tipo').value;
            const valor = parseFloat(document.getElementById('conv-valor').value);

            if (!nome || isNaN(valor)) return showToast("Preencha os dados do convênio!", "error");

            const { data: { user } } = await _supabase.auth.getUser();

            const { error } = await _supabase.from('convenios').insert([{
                user_id: user.id,
                nome_loja: nome,
                tipo_desconto: tipo,
                valor_desconto: valor
            }]);

            if (error) return showToast("Erro ao salvar convênio!", "error");

            document.getElementById('conv-nome').value = '';
            document.getElementById('conv-valor').value = '';
            showToast("Parceiro cadastrado!");
            await carregarConvenios(); // Recarrega a lista e o select do checkout
        }

        // Atualiza a lista visual dentro do modal de configurações
        async function renderListaConveniosConfig() {
            const container = document.getElementById('lista-convenios-config');
            if (!container) return;

            container.innerHTML = listaConvenios.map(c => `
                <div class="flex justify-between items-center bg-white p-2 rounded-lg border border-slate-100 text-[10px]">
                    <span class="font-bold text-slate-700">${c.nome_loja}</span>
                    <div class="flex items-center gap-2">
                        <span class="text-indigo-600 font-black">${c.valor_desconto}${c.tipo_desconto === 'PERCENTUAL' ? '%' : 'min'}</span>
                        <button onclick="excluirConvenio(${c.id})" class="text-rose-400 hover:text-rose-600"><i data-lucide="x" class="w-3 h-3"></i></button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function excluirConvenio(id) {
            if (!confirm("Remover este parceiro?")) return;
            const { error } = await _supabase.from('convenios').delete().eq('id', id);
            if (!error) {
                await carregarConvenios();
                showToast("Convênio removido.");
            }
        }


        // Monitor de Teclado para F3
        window.addEventListener('keydown', (e) => {
            if (e.key === 'F3') {
                e.preventDefault();
                abrirSaidaRapida();
            }
            if (e.key === 'Escape') {
                document.getElementById('modalSaidaRapida').classList.replace('flex', 'hidden');
            }

            // Atalho Numérico (Se o modal estiver aberto, digita 1, 2, 3... para selecionar)
            const modalSaida = document.getElementById('modalSaidaRapida');
            if (!modalSaida.classList.contains('hidden') && e.key >= '1' && e.key <= '9') {
                const index = parseInt(e.key) - 1;
                const cards = document.querySelectorAll('.card-saida-rapida');
                if (cards[index]) cards[index].click();
            }
        });

        function abrirSaidaRapida() {
            const modal = document.getElementById('modalSaidaRapida');
            const grid = document.getElementById('grid-saida-rapida');
            modal.classList.replace('hidden', 'flex');

            // Ordenar: Primeiro que chegou (mais tempo) para o último
            const ordenados = [...patioAtivo].sort((a, b) => new Date(a.entrada) - new Date(b.entrada));

            document.getElementById('atalho-count').innerText = `${ordenados.length} Veículos`;

            grid.innerHTML = ordenados.map((v, i) => {
                const info = calcularCobranca(v);
                return `
                    <div onclick="fecharEAbrirCheckout(${v.id})" 
                        class="card-saida-rapida group bg-white/5 hover:bg-indigo-600 border-2 border-white/10 hover:border-indigo-400 p-6 rounded-[2rem] transition-all cursor-pointer relative flex flex-col items-center text-center">
                
                        <span class="absolute top-4 left-4 bg-white/20 text-white w-8 h-8 flex items-center justify-center rounded-full font-black text-sm group-hover:bg-white group-hover:text-indigo-600 transition-colors">
                            ${i + 1}
                        </span>

                        <div class="text-indigo-400 group-hover:text-white mb-4 transition-colors">
                            <i data-lucide="car" class="w-16 h-16"></i>
                        </div>

                        <h4 class="text-white font-black text-xl leading-tight uppercase">${v.modelo}</h4>
                        <p class="text-indigo-300 font-mono font-bold text-sm mb-3 tracking-widest">${v.placa}</p>
                
                        <div class="mt-auto w-full pt-4 border-t border-white/10 group-hover:border-white/20 text-white/70">
                            <p class="text-[10px] font-black uppercase opacity-60">Permanência</p>
                            <p class="font-mono font-bold">${info.horas}h ${info.minutos}m</p>
                        </div>
                    </div>
                `;
            }).join('');

            lucide.createIcons();
        }

        function fecharEAbrirCheckout(id) {
            document.getElementById('modalSaidaRapida').classList.replace('flex', 'hidden');
            openCheckoutModal(id);
        }


        // Variável de controle para evitar duplicidade
        let processandoEntradaF1 = false;

        window.addEventListener('keydown', (e) => {
            // Tecla F1 abre o modal
            if (e.key === 'F1') {
                e.preventDefault();
                abrirF1();
            }

            // Controle de fluxo interno do Modal F1
            const modalF1 = document.getElementById('modalEntradaRapida');
            if (!modalF1.classList.contains('hidden')) {
                const inputPlaca = document.getElementById('f1-placa');
                const inputModelo = document.getElementById('f1-modelo');

                if (e.key === 'Enter') {
                    e.preventDefault();
                    // Se estiver na placa e ela for válida, pula pro modelo
                    if (document.activeElement === inputPlaca) {
                        if (validarPlacaReal(inputPlaca.value)) {
                            inputModelo.focus();
                        } else {
                            showToast("Placa inválida!", "error");
                        }
                    }
                    // Se estiver no modelo, confirma a entrada
                    else if (document.activeElement === inputModelo || document.activeElement === document.getElementById('btn-f1-confirmar')) {
                        executarEntradaF1();
                    }
                }

                if (e.key === 'Escape') {
                    fecharF1();
                }
            }
        });

        function abrirF1() {
            document.getElementById('modalEntradaRapida').classList.replace('hidden', 'flex');
            const inputPlaca = document.getElementById('f1-placa');
            inputPlaca.value = '';
            document.getElementById('f1-modelo').value = '';
            processandoEntradaF1 = false;
            setTimeout(() => inputPlaca.focus(), 100);
            lucide.createIcons();
        }

        function fecharF1() {
            document.getElementById('modalEntradaRapida').classList.replace('flex', 'hidden');
        }

        async function executarEntradaF1() {
            if (processandoEntradaF1) return;

            const pla = document.getElementById('f1-placa').value.toUpperCase().trim();
            const mod = document.getElementById('f1-modelo').value.toUpperCase().trim();

            // TRAVA DE SEGURANÇA F1
            if (patioAtivo.some(v => v.placa === pla)) {
                await registrarLogSeguranca(pla, mod);
                document.getElementById('alerta-placa-clonada').innerText = pla;
                document.getElementById('modalAlertaSeguranca').classList.replace('hidden', 'flex');
                fecharF1(); // Fecha o modal de entrada para mostrar o de alerta
                lucide.createIcons();
                return;
            }

            if (!validarPlacaReal(pla) || !mod) return showToast("Dados inválidos!", "error");

            processandoEntradaF1 = true;

            if (!validarPlacaReal(pla)) return showToast("Placa inválida!", "error");
            if (!mod) return showToast("Informe o modelo!", "error");

            processandoEntradaF1 = true;
            const btn = document.getElementById('btn-f1-confirmar');
            btn.innerText = "PROCESSANDO...";
            btn.disabled = true;

            try {
                const { data: { user } } = await _supabase.auth.getUser();

                const { data, error } = await _supabase.from('veiculos_ativos').insert([{
                    modelo: mod,
                    placa: pla,
                    entrada: new Date().toISOString(),
                    servicos: [],
                    user_id: user.id
                }]).select();

                if (error) throw error;

                fecharF1();
                await carregarDadosIniciais();
                renderizar();
                playSfx('entrada');
                showToast("Entrada F1 realizada!");

                if (data && data[0]) prepararTicket(data[0]);

            } catch (error) {
                showToast("Erro ao salvar entrada!", "error");
                console.error(error);
            } finally {
                processandoEntradaF1 = false;
                btn.innerText = "CONFIRMAR ENTRADA [ENTER]";
                btn.disabled = false;
            }
        }


        window.addEventListener('keydown', (e) => {
            if (e.key === 'F4') {
                e.preventDefault();
                abrirResumoF4();
            }
        });

        // Abre o resumo e calcula o ticket médio
        function abrirResumoF4() {
            const hoje = new Date().toISOString().split('T')[0];
            // Filtramos o histórico que ainda não foi "fechado" (neste caso, as saídas de hoje)
            const historicoHoje = historico.filter(h => h.saida.startsWith(hoje));
            const total = historicoHoje.reduce((acc, h) => acc + (h.valor || 0), 0);
            const ticket = historicoHoje.length > 0 ? total / historicoHoje.length : 0;

            document.getElementById('f4-qtd').innerText = historicoHoje.length;
            document.getElementById('f4-ticket').innerText = `R$ ${ticket.toFixed(2)}`;
            document.getElementById('f4-total').innerText = `R$ ${total.toFixed(2)}`;

            toggleModal('modalResumoF4');
            lucide.createIcons();
        }

        async function executarFechamentoCompleto() {
            const total = document.getElementById('f4-total').innerText;
            const qtd = document.getElementById('f4-qtd').innerText;

            if (!confirm(`ATENÇÃO: Deseja realizar o FECHAMENTO REAL de ${total}?\n\nIsso irá gerar um backup automático e registrar o encerramento do turno.`)) return;

            // 1. BACKUP AUTOMÁTICO (Download do JSON)
            exportarBackup();

            // 2. REGISTRO NO BANCO (Opcional: você pode criar uma tabela 'fechamentos' no Supabase)
            const { data: { user } } = await _supabase.auth.getUser();
            const { error } = await _supabase.from('historico_saidas').select('*'); // Apenas para validar conexão

            // 3. LIMPEZA VISUAL / REINÍCIO
            showToast("FECHAMENTO REALIZADO! Backup salvo.");

            // Pequeno delay para o download iniciar
            setTimeout(() => {
                // Opcional: Aqui você pode redirecionar para o dashboard ou imprimir um cupom de fechamento
                gerarRelatorioFiltrado(); // Usa sua função de imprimir o mês/dia
                toggleModal('modalResumoF4');
            }, 1000);
        }

        // Função de Backup aprimorada
        function exportarBackup() {
            const dadosParaBackup = {
                configuracoes: config,
                patio_no_momento: patioAtivo,
                catalogo: catalogo,
                historico_completo: historico,
                data_fechamento: new Date().toLocaleString('pt-BR'),
                id_maquina: SEGURANCA_PRO.ID_MAQUINA
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dadosParaBackup, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `FECHAMENTO_HAYDEN_${new Date().toLocaleDateString().replace(/\//g, '-')}_${new Date().getHours()}h.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        async function baixarLogSeguranca() {
            const { data, error } = await _supabase
                .from('log_seguranca')
                .select('data_hora, placa, modelo_tentativa')
                .order('data_hora', { ascending: false });

            if (error || !data) return showToast("Erro ao buscar logs", "error");

            // Converte para CSV
            const cabecalho = "Data/Hora;Placa;Modelo Tentativa\n";
            const corpo = data.map(item =>
                `${new Date(item.data_hora).toLocaleString()};${item.placa};${item.modelo_tentativa}`
            ).join("\n");

            const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + encodeURIComponent(cabecalho + corpo);
            const link = document.createElement("a");
            link.setAttribute("href", csvContent);
            link.setAttribute("download", `LOG_SEGURANCA_HAYDEN_${new Date().toLocaleDateString()}.csv`);
            document.body.appendChild(link);
            link.click();
            link.remove();
        }

        // Função para registrar o incidente silenciosamente no banco de dados
        async function registrarLogSeguranca(placa, modelo) {
            try {
                const { data: { user } } = await _supabase.auth.getUser();
                const { error } = await _supabase.from('log_seguranca').insert([{
                    placa: placa,
                    modelo_tentativa: modelo,
                    tipo_alerta: 'DUPLICIDADE_INTERNA',
                    user_id: user ? user.id : null
                }]);

                if (error) console.error("Erro ao gravar log de segurança:", error);
            } catch (err) {
                console.error("Falha crítica no sistema de log:", err);
            }
        }


        // Função para registrar o incidente silenciosamente no banco de dados
        async function registrarLogSeguranca(placa, modelo) {
            try {
                const { data: { user } } = await _supabase.auth.getUser();
                const { error } = await _supabase.from('log_seguranca').insert([{
                    placa: placa,
                    modelo_tentativa: modelo,
                    tipo_alerta: 'DUPLICIDADE_INTERNA',
                    user_id: user ? user.id : null
                }]);

                if (error) console.error("Erro ao gravar log de segurança:", error);
            } catch (err) {
                console.error("Falha crítica no sistema de log:", err);
            }
        }


        // Atalho de Segurança Manual: CTRL + SHIFT + S
        window.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key.toUpperCase() === 'S') {
                e.preventDefault();

                // Define uma placa genérica para o alerta manual
                document.getElementById('alerta-placa-clonada').innerText = "SUSPEITO";
                document.getElementById('modalAlertaSeguranca').classList.replace('hidden', 'flex');

                // Registra o log como ALERTA_MANUAL
                registrarLogSeguranca("MANUAL", "ACIONAMENTO MANUAL OPERADOR");

                playSfx('saida');
                lucide.createIcons();
            }
        });


        async function renderizarIncidentesBI() {
            const container = document.getElementById('lista-incidentes-bi');
            if (!container) return;

            const { data, error } = await _supabase
                .from('log_seguranca')
                .select('*')
                .order('data_hora', { ascending: false })
                .limit(5);

            if (error || !data) return;

            container.innerHTML = data.map(log => `
                <tr class="hover:bg-rose-50/20 transition-all">
                    <td class="px-6 py-4 font-mono text-xs text-slate-500">${new Date(log.data_hora).toLocaleString()}</td>
                    <td class="px-6 py-4"><span class="bg-rose-100 text-rose-700 px-2 py-1 rounded font-black font-mono">${log.placa}</span></td>
                    <td class="px-6 py-4 font-bold text-slate-700 uppercase">${log.modelo_tentativa}</td>
                </tr>
            `).join('');
        }

        // Atualize o seu switchTab para chamar esta função
        const originalSwitchTabInsights = switchTab;
        switchTab = function (tabId) {
            originalSwitchTabInsights(tabId);
            if (tabId === 'insights') {
                renderizarIncidentesBI();
            }
        }


    </script>

    <div id="modalSucessoSaida" onclick="closeOnOutsideClick(event, 'modalSucessoSaida')"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[160] hidden items-center justify-center p-4 no-print">
        <div
            class="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl p-8 text-center animate-in zoom-in-95 duration-300">
            <div
                class="w-20 h-20 bg-indigo-50 text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="receipt" class="w-10 h-10"></i>
            </div>
            <h3 class="text-2xl font-black text-slate-800 mb-2">Pagamento Recebido!</h3>
            <p id="info-veiculo-saida" class="text-slate-500 text-sm mb-8 font-medium italic"></p>

            <div class="space-y-3">
                <button id="btn-imprimir-recibo"
                    class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-3 hover:bg-black transition-all">
                    <i data-lucide="printer" class="w-5 h-5"></i> IMPRIMIR RECIBO
                </button>
                <button id="btn-whatsapp-recibo"
                    class="w-full bg-[#25D366] text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-3 hover:opacity-90 transition-all">
                    <i data-lucide="message-circle" class="w-5 h-5"></i> ENVIAR RECIBO WHATSAPP
                </button>
                <button onclick="toggleModal('modalSucessoSaida')"
                    class="w-full text-slate-400 text-xs font-bold uppercase tracking-widest pt-4">Fechar</button>
            </div>
        </div>
    </div>

    <div id="modalSucessoEntrada" onclick="closeOnOutsideClick(event, 'modalSucessoEntrada')"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[160] hidden items-center justify-center p-4 no-print">
        <div
            class="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl p-8 text-center animate-in zoom-in-95 duration-300">
            <div
                class="w-20 h-20 bg-emerald-50 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="check-circle" class="w-10 h-10"></i>
            </div>
            <h3 class="text-2xl font-black text-slate-800 mb-2">Entrada Confirmada!</h3>
            <p id="info-veiculo-sucesso" class="text-slate-500 text-sm mb-8 font-medium italic"></p>

            <div class="space-y-3">
                <button id="btn-imprimir-ticket"
                    class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-3 hover:bg-black transition-all">
                    <i data-lucide="printer" class="w-5 h-5"></i> IMPRIMIR TICKET
                </button>
                <button id="btn-whatsapp-ticket"
                    class="w-full bg-[#25D366] text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-3 hover:opacity-90 transition-all">
                    <i data-lucide="message-circle" class="w-5 h-5"></i> ENVIAR WHATSAPP
                </button>
                <button onclick="toggleModal('modalSucessoEntrada')"
                    class="w-full text-slate-400 text-xs font-bold uppercase tracking-widest pt-4">FECHAR</button>
            </div>
        </div>
    </div>
    <div id="modalAlertaInadimplente"
        class="fixed inset-0 bg-rose-900/90 backdrop-blur-md z-[300] hidden items-center justify-center p-4">
        <div
            class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden animate-pulse border-[8px] border-rose-600">
            <div class="bg-rose-600 p-6 text-white text-center">
                <i data-lucide="shield-alert" class="w-16 h-16 mx-auto mb-2"></i>
                <h3 class="text-2xl font-black uppercase tracking-tighter">Acesso Bloqueado</h3>
            </div>
            <div class="p-8 text-center">
                <p class="text-slate-400 text-xs font-bold uppercase mb-1">Mensalista Identificado</p>
                <h4 id="alerta-nome" class="text-2xl font-black text-slate-800 mb-4">---</h4>

                <div class="bg-rose-50 p-6 rounded-3xl border border-rose-100 mb-6">
                    <p class="text-rose-600 text-sm font-bold uppercase mb-2">Débito Pendente</p>
                    <p id="alerta-valor" class="text-4xl font-black text-rose-700 tracking-tighter">R$ 0,00</p>
                    <p id="alerta-detalhe" class="text-rose-500 text-xs font-medium mt-2">Vencido desde: --/--/----</p>
                </div>

                <div class="flex flex-col gap-3">
                    <button onclick="cobrarInadimplentePeloAlerta()"
                        class="w-full bg-[#25D366] text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2">
                        <i data-lucide="message-circle" class="w-5 h-5"></i> COBRAR VIA WHATSAPP
                    </button>
                    <button
                        onclick="document.getElementById('modalAlertaInadimplente').classList.replace('flex', 'hidden')"
                        class="w-full py-4 text-slate-400 text-xs font-bold uppercase tracking-widest">Fechar
                        Alerta</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modalAlertaNoPatio"
        class="fixed inset-0 bg-amber-900/90 backdrop-blur-md z-[300] hidden items-center justify-center p-4">
        <div
            class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden animate-pulse-amber border-[8px] border-amber-500">
            <div class="bg-amber-500 p-6 text-white text-center">
                <i data-lucide="copy" class="w-16 h-16 mx-auto mb-2"></i>
                <h3 class="text-2xl font-black uppercase tracking-tighter">Veículo já no Pátio</h3>
            </div>
            <div class="p-8 text-center">
                <h4 id="alerta-patio-modelo" class="text-2xl font-black text-slate-800 mb-2">---</h4>
                <div class="bg-amber-50 p-6 rounded-3xl border border-amber-100 mb-6">
                    <p class="text-amber-700 text-sm font-bold uppercase">Entrada registrada às:</p>
                    <p id="alerta-patio-hora" class="text-3xl font-black text-amber-700">00:00</p>
                </div>
                <button onclick="document.getElementById('modalAlertaNoPatio').classList.replace('flex', 'hidden')"
                    class="w-full py-4 bg-amber-500 text-white font-bold rounded-2xl uppercase">Entendido</button>
            </div>
        </div>
    </div>

    <div id="modalAlertaVip"
        class="fixed inset-0 bg-emerald-900/90 backdrop-blur-md z-[300] hidden items-center justify-center p-4">
        <div
            class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden animate-pulse-green-border border-[8px] border-emerald-500">
            <div class="bg-emerald-500 p-6 text-white text-center">
                <i data-lucide="crown" class="w-16 h-16 mx-auto mb-2"></i>
                <h3 class="text-2xl font-black uppercase tracking-tighter">Mensalista VIP</h3>
            </div>
            <div class="p-8 text-center">
                <h4 id="alerta-vip-nome" class="text-2xl font-black text-slate-800 mb-1">---</h4>
                <p id="alerta-vip-placa" class="text-sm font-bold text-emerald-600 mb-4 font-mono">---</p>
                <div class="bg-emerald-50 p-6 rounded-3xl border border-emerald-100 mb-6">
                    <p class="text-emerald-700 text-xs font-bold uppercase">Status do Plano</p>
                    <p class="text-xl font-black text-emerald-700">PAGAMENTO EM DIA</p>
                    <p id="alerta-vip-venc" class="text-[10px] text-emerald-600 font-bold mt-1 uppercase">Vence em:
                        --/--</p>
                </div>
                <button onclick="document.getElementById('modalAlertaVip').classList.replace('flex', 'hidden')"
                    class="w-full py-4 bg-emerald-500 text-white font-bold rounded-2xl">LIBERAR ENTRADA</button>
            </div>
        </div>
    </div>

    <div id="modalLicenca"
        class="fixed inset-0 bg-slate-900/95 backdrop-blur-md z-[400] flex items-center justify-center p-4">
        <div
            class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden border-t-8 border-indigo-500 animate-in zoom-in-95 duration-300">
            <div class="p-8 text-center">
                <div id="chave-secreta-ativa" class="...">
                    <i data-lucide="key-round" class="w-10 h-10"></i>
                </div>

                <h3 class="text-2xl font-black text-slate-800 mb-2 uppercase">Ativação do Sistema</h3>

                <div class="mb-6 bg-slate-50 p-3 rounded-xl border border-dashed border-slate-300">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">ID desta Máquina</p>
                    <p id="display-id-modal" class="font-mono font-bold text-indigo-600 tracking-tighter">--------</p>
                </div>

                <p class="text-slate-500 text-sm mb-8 leading-relaxed">
                    Envie o ID acima para o desenvolvedor para obter sua chave permanente ou use o modo demo (30 min).
                </p>

                <div class="space-y-4">
                    <input type="text" id="input-chave-licenca" placeholder="Sua Chave Aqui"
                        class="w-full p-5 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all font-mono text-center font-bold tracking-widest uppercase">

                    <div class="flex gap-3">
                        <button onclick="ativarLicencaPeloModal()"
                            class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all">
                            ATIVAR AGORA
                        </button>
                        <button onclick="iniciarModoDemo()"
                            class="flex-1 bg-slate-100 text-slate-600 py-4 rounded-2xl font-bold hover:bg-slate-200 transition-all">
                            MODO DEMO
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalGeradorHayden"
        class="fixed inset-0 bg-indigo-950/95 backdrop-blur-xl z-[500] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-[3rem] shadow-2xl overflow-hidden border-4 border-indigo-500">
            <div class="bg-indigo-600 p-6 text-white flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-black uppercase tracking-tighter">Gerador de Licenças</h3>
                    <p class="text-[10px] opacity-80 font-bold uppercase">Acesso Restrito: Hayden Fernandes</p>
                </div>
                <button onclick="document.getElementById('modalGeradorHayden').classList.replace('flex', 'hidden')"
                    class="bg-white/10 p-2 rounded-full hover:bg-white/20">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-8 space-y-6">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">ID da Máquina do
                        Cliente</label>
                    <input type="text" id="gen-id-cliente" placeholder="Cole o ID enviado pelo cliente"
                        class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl outline-none focus:border-indigo-500 font-mono text-center font-bold">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Chave Gerada</label>
                    <div class="relative">
                        <input type="text" id="gen-chave-resultado" readonly
                            class="w-full p-5 bg-indigo-50 text-indigo-700 border-2 border-indigo-100 rounded-2xl font-mono text-center font-black tracking-widest text-xl">
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="processarGeracao()"
                        class="flex-1 bg-indigo-600 text-white py-5 rounded-2xl font-black hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all">GERAR
                        LICENÇA</button>
                    <button onclick="copiarChaveGerada()"
                        class="bg-slate-900 text-white px-6 rounded-2xl hover:bg-black transition-all">
                        <i data-lucide="copy" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="modalDecisaoNovaPlaca" onclick="closeOnOutsideClick(event, 'modalDecisaoNovaPlaca')"
        class="fixed inset-0 bg-indigo-900/60 backdrop-blur-sm z-[200] hidden items-center justify-center p-4">
        <div
            class="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl overflow-hidden border-t-8 border-indigo-500 animate-in zoom-in-95 duration-300">
            <div class="p-8 text-center">
                <div
                    class="w-20 h-20 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="help-circle" class="w-10 h-10"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-800 mb-2">Placa Livre</h3>
                <p class="text-slate-500 text-sm mb-8">A placa <span id="span-nova-placa"
                        class="font-mono font-bold text-indigo-600"></span> não possui registros ativos. O que deseja
                    fazer?</p>

                <div class="space-y-3">
                    <button onclick="prepararEntradaRapida()"
                        class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-3 hover:bg-indigo-700 transition-all">
                        <i data-lucide="play" class="w-5 h-5"></i> ADICIONAR AO PÁTIO
                    </button>
                    <button onclick="prepararAgendamentoRapido()"
                        class="w-full bg-slate-100 text-slate-600 py-4 rounded-2xl font-bold flex items-center justify-center gap-3 hover:bg-slate-200 transition-all">
                        <i data-lucide="calendar" class="w-5 h-5"></i> AGENDAR RESERVA
                    </button>
                    <button onclick="toggleModal('modalDecisaoNovaPlaca')"
                        class="w-full text-slate-400 text-xs font-bold uppercase tracking-widest pt-4">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modalDetalhesMensalista" onclick="closeOnOutsideClick(event, 'modalDetalhesMensalista')"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] hidden items-center justify-center p-4">
        <div
            class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden animate-in zoom-in-95 duration-300">
            <div class="bg-indigo-600 p-6 text-white text-center">
                <i data-lucide="user" class="w-12 h-12 mx-auto mb-2"></i>
                <h3 class="text-xl font-black uppercase tracking-tighter">Detalhes do Cliente</h3>
            </div>
            <div class="p-8">
                <div class="space-y-4 mb-6">
                    <div class="flex justify-between border-b pb-2"><span
                            class="text-slate-400 text-xs font-bold uppercase">Nome:</span> <span id="det-nome"
                            class="font-bold text-slate-800"></span></div>
                    <div class="flex justify-between border-b pb-2"><span
                            class="text-slate-400 text-xs font-bold uppercase">CPF:</span> <span id="det-cpf"
                            class="font-mono text-slate-800"></span></div>
                    <div class="flex justify-between border-b pb-2"><span
                            class="text-slate-400 text-xs font-bold uppercase">Placa Principal:</span> <span
                            id="det-placa" class="font-bold text-indigo-600"></span></div>

                    <div class="bg-indigo-50 p-6 rounded-3xl text-center mt-6">
                        <p class="text-indigo-600 text-[10px] font-bold uppercase mb-1">Uso no mês atual</p>
                        <p id="det-usos-mes" class="text-5xl font-black text-indigo-900 tracking-tighter">0</p>
                        <p class="text-indigo-400 text-[10px] font-bold uppercase mt-1">Vezes estacionado</p>
                    </div>
                </div>
                <button onclick="toggleModal('modalDetalhesMensalista')"
                    class="w-full py-4 bg-slate-100 text-slate-600 font-bold rounded-2xl">Fechar Visualização</button>
            </div>
        </div>
    </div>

    <div id="print-section" class="hidden"></div>

    <div id="modalEmailEnviado" onclick="closeOnOutsideClick(event, 'modalEmailEnviado')"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[2100] hidden items-center justify-center p-4">
        <div
            class="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl p-8 text-center animate-in zoom-in-95 duration-300 border-t-8 border-indigo-600">
            <div
                class="w-20 h-20 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="mail-check" class="w-10 h-10"></i>
            </div>
            <h3 class="text-2xl font-black text-slate-800 mb-2">E-mail Enviado!</h3>
            <p class="text-slate-500 text-sm mb-8 leading-relaxed">
                Enviamos um link de recuperação para o seu e-mail. <br>
                <strong>Verifique sua caixa de entrada e spam.</strong>
            </p>

            <button onclick="toggleModal('modalEmailEnviado')"
                class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-black transition-all shadow-lg active:scale-95">
                ENTENDI
            </button>
        </div>
    </div>


    <div id="modalSaidaRapida" onclick="closeOnOutsideClick(event, 'modalSaidaRapida')"
        class="fixed inset-0 bg-slate-900/95 backdrop-blur-xl z-[600] hidden flex-col p-8">

        <header class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-4xl font-black text-white uppercase tracking-tighter">Saída Rápida <span
                        class="text-indigo-500">[F3]</span></h2>
                <p class="text-slate-400 font-bold uppercase tracking-widest text-sm">Selecione o veículo digitando o
                    número ou usando as setas</p>
            </div>
            <div class="bg-white/10 px-6 py-3 rounded-2xl border border-white/20">
                <span class="text-white font-mono text-2xl font-bold" id="atalho-count">0 Veículos</span>
            </div>
        </header>

        <div id="grid-saida-rapida"
            class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6 overflow-y-auto custom-scrollbar p-2">
        </div>

        <footer class="mt-auto pt-8 border-t border-white/10 flex justify-center gap-10">
            <div class="flex items-center gap-2 text-white/50 font-bold text-xs uppercase">
                <kbd class="bg-white/20 px-3 py-1 rounded text-white">ESC</kbd> Sair
            </div>
            <div class="flex items-center gap-2 text-white/50 font-bold text-xs uppercase">
                <kbd class="bg-white/20 px-3 py-1 rounded text-white">1-9</kbd> Selecionar Carro
            </div>
            <div class="flex items-center gap-2 text-white/50 font-bold text-xs uppercase">
                <kbd class="bg-indigo-500 px-3 py-1 rounded text-white">ENTER</kbd> Confirmar Seleção
            </div>
        </footer>
    </div>


    <div id="modalResumoF4" onclick="closeOnOutsideClick(event, 'modalResumoF4')"
        class="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-[800] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden border-t-8 border-emerald-500">
            <div class="p-8">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-black text-slate-800 uppercase tracking-tighter">Fechamento de Caixa [F4]
                    </h3>
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Resumo do período atual
                    </p>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-slate-50 p-4 rounded-2xl text-center">
                        <p class="text-[9px] font-bold text-slate-400 uppercase">Veículos</p>
                        <p id="f4-qtd" class="text-xl font-black text-slate-800">0</p>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-2xl text-center">
                        <p class="text-[9px] font-bold text-indigo-400 uppercase">Ticket Médio</p>
                        <p id="f4-ticket" class="text-xl font-black text-indigo-600">R$ 0,00</p>
                    </div>
                </div>

                <div class="bg-emerald-50 p-6 rounded-[2rem] text-center border border-emerald-100 mb-8">
                    <p class="text-xs font-bold text-emerald-600 uppercase mb-1">Total em Caixa</p>
                    <p id="f4-total" class="text-4xl font-black text-emerald-600 tracking-tighter">R$ 0,00</p>
                </div>

                <div class="space-y-3">
                    <button onclick="executarFechamentoCompleto()"
                        class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-sm shadow-xl hover:bg-black transition-all flex items-center justify-center gap-3">
                        <i data-lucide="lock" class="w-5 h-5"></i> REALIZAR FECHAMENTO REAL
                    </button>
                    <button onclick="toggleModal('modalResumoF4')"
                        class="w-full py-3 text-slate-400 font-bold uppercase text-[10px] tracking-widest">Continuar
                        Expediente</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modalAlertaSeguranca"
        class="fixed inset-0 bg-red-950/95 backdrop-blur-xl z-[4000] hidden items-center justify-center p-4">
        <div
            class="bg-white w-full max-w-lg rounded-[3rem] shadow-[0_0_100px_rgba(220,38,38,0.8)] overflow-hidden border-[12px] border-red-600 animate-bounce-short">
            <div class="bg-red-600 p-8 text-white text-center">
                <i data-lucide="shield-alert" class="w-24 h-24 mx-auto mb-4 animate-pulse"></i>
                <h3 class="text-4xl font-black uppercase tracking-tighter leading-none">ALERTA DE SEGURANÇA!</h3>
            </div>
            <div class="p-10 text-center">
                <p class="text-slate-500 font-bold uppercase mb-4 tracking-widest text-sm">Placa já identificada no
                    pátio</p>
                <h4 id="alerta-placa-clonada" class="text-6xl font-black text-red-600 mb-6 font-mono tracking-tighter">
                    ---</h4>

                <div class="bg-red-50 p-6 rounded-[2rem] border-2 border-red-200 mb-8">
                    <p class="text-red-700 text-xl font-black uppercase leading-tight">
                        PLACA CLONADA OU FURTADA DETECTADA!
                    </p>
                    <p class="text-red-600 text-sm font-bold mt-2">
                        NÃO LIBERE O VEÍCULO. ACIONE O BOTÃO ABAIXO.
                    </p>
                </div>

                <div class="space-y-4">
                    <a href="tel:190"
                        class="w-full bg-red-600 text-white py-6 rounded-2xl font-black text-2xl flex items-center justify-center gap-4 hover:bg-red-700 transition-all shadow-xl">
                        <i data-lucide="phone-forwarded" class="w-8 h-8"></i> LIGAR PARA 190
                    </a>
                    <button
                        onclick="document.getElementById('modalAlertaSeguranca').classList.replace('flex', 'hidden')"
                        class="w-full py-4 text-slate-400 font-bold uppercase text-xs tracking-widest">Ignorar e Fechar
                        Alerta</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes bounce-short {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .animate-bounce-short {
            animation: bounce-short 0.5s ease-in-out infinite;
        }
    </style>

</body>

<button onclick="toggleModal('modalBuscaPlaca')"
    class="fixed bottom-8 right-8 w-16 h-16 bg-slate-900 text-white rounded-full shadow-2xl flex items-center justify-center hover:scale-110 hover:bg-indigo-600 transition-all z-[100] group">
    <i data-lucide="search" class="w-7 h-7"></i>
    <span
        class="absolute right-20 bg-slate-800 text-white text-[10px] px-3 py-1.5 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity font-bold uppercase tracking-wider whitespace-nowrap pointer-events-none">Busca
        Rápida</span>
</button>

<div id="modalBuscaPlaca" onclick="closeOnOutsideClick(event, 'modalBuscaPlaca')"
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[150] hidden items-center justify-center p-4">
    <div class="flex flex-col items-center gap-6 w-full max-w-md">
        <div class="w-full bg-white border-[6px] border-slate-900 rounded-2xl overflow-hidden shadow-2xl">
            <div class="bg-[#003399] p-3 flex justify-between items-center text-white px-6">
                <div class="flex items-center gap-2">
                    <div class="w-6 h-4 bg-white/20 rounded-sm overflow-hidden flex flex-col">
                        <div class="h-1/2 bg-blue-600"></div>
                        <div class="h-1/2 bg-yellow-400"></div>
                    </div>
                    <span class="text-xs font-bold tracking-widest uppercase">Brasil</span>
                </div>
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/05/Flag_of_Brazil.svg/2000px-Flag_of_Brazil.svg.png"
                    class="w-6 h-4 object-cover rounded-sm">
            </div>
            <div class="p-8 bg-white flex flex-col items-center">
                <input type="text" id="input-placa-busca" maxlength="7" placeholder="ABC1D23"
                    oninput="if(this.value.length === 7) buscarVeiculoPelaPlaca()"
                    onkeydown="if(event.key === 'Enter') buscarVeiculoPelaPlaca()"
                    class="w-full text-center text-6xl font-black font-mono uppercase tracking-[0.2em] outline-none border-none placeholder-slate-200 text-slate-900">
            </div>
        </div>

        <div id="resultado-busca-placa"
            class="hidden w-full bg-white p-6 rounded-[2rem] shadow-xl border border-slate-100 flex-col gap-4 animate-in fade-in slide-in-from-bottom-4">
            <div class="flex justify-between items-center border-b border-slate-50 pb-4">
                <div>
                    <h4 id="res-modelo" class="text-xl font-black text-slate-800 uppercase">---</h4>
                    <p id="res-tempo" class="text-xs font-bold text-indigo-500 uppercase">Tempo: --:--</p>
                </div>
                <div class="text-right">
                    <p id="res-valor" class="text-2xl font-black text-emerald-600 tracking-tighter">R$ 0,00</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button id="btn-add-serv-res"
                    class="flex-1 bg-indigo-50 text-indigo-700 py-4 rounded-2xl font-bold text-sm hover:bg-indigo-600 hover:text-white transition-all">ADICIONAR
                    SERVIÇO</button>
                <button id="btn-sair-res"
                    class="flex-1 bg-rose-600 text-white py-4 rounded-2xl font-bold text-sm shadow-lg shadow-rose-200 hover:bg-rose-700 transition-all">FINALIZAR
                    (SAIR)</button>
            </div>
        </div>
    </div>
</div>

<div id="modalEntradaRapida" onclick="closeOnOutsideClick(event, 'modalEntradaRapida')"
    class="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-[700] hidden items-center justify-center p-4">
    <div
        class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden border-t-8 border-indigo-600 animate-in zoom-in-95 duration-300">
        <div class="p-8 text-center">
            <div
                class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="zap" class="w-8 h-8"></i>
            </div>
            <h3 class="text-2xl font-black text-slate-800 uppercase tracking-tighter">Entrada Instantânea <span
                    class="text-indigo-600">[F1]</span></h3>
            <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-8">Preencha e aperte ENTER para
                confirmar</p>

            <div class="space-y-4 text-left">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-4">Placa do Veículo</label>
                    <input type="text" id="f1-placa" maxlength="7" placeholder="ABC1D23"
                        oninput="aplicarMascaraPlaca(this)"
                        class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-2xl outline-none focus:border-indigo-500 font-mono text-3xl text-center font-black uppercase tracking-widest">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-4">Modelo</label>
                    <input type="text" id="f1-modelo" placeholder="EX: TOYOTA COROLLA"
                        class="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-2xl outline-none focus:border-indigo-500 font-bold text-center uppercase">
                </div>
                <div class="pt-4">
                    <button id="btn-f1-confirmar"
                        class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black text-lg shadow-xl hover:bg-indigo-700 transition-all active:scale-95">
                        CONFIRMAR ENTRADA [ENTER]
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

</html>
