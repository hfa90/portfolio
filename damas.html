<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Damas Elite | Online P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #4CAF50;
            --bg: #0f172a;
            --surface: rgba(30, 41, 59, 0.9);
            --board-light: #f1f5f9;
            --board-dark: #334155;
            --white-skin: radial-gradient(circle, #00d2ff, #3a7bd5);
            --black-skin: radial-gradient(circle, #f5af19, #f12711);
        }

        body {
            background: radial-gradient(circle at top right, #1e293b, #0f172a);
            color: white;
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        #login-screen {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(15px);
        }

        .login-box {
            background: var(--surface);
            padding: 3rem;
            border-radius: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .game-layout {
            display: flex;
            gap: 2rem;
            opacity: 0;
            transition: opacity 1s;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(8, 65px);
            grid-template-rows: repeat(8, 65px);
            border: 10px solid #1e293b;
            border-radius: 10px;
            background: #1e293b;
            position: relative;
        }

        .square {
            width: 65px;
            height: 65px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dark {
            background-color: var(--board-dark);
        }

        .light {
            background-color: var(--board-light);
        }

        .piece {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: grab;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s;
        }

        .white-piece {
            background: var(--white-skin);
            box-shadow: 0 0 10px #00d2ff;
        }

        .black-piece {
            background: var(--black-skin);
            box-shadow: 0 0 10px #f12711;
        }

        .king::after {
            content: 'ðŸ‘‘';
            font-size: 20px;
        }

        .trash-talk {
            position: absolute;
            font-weight: 900;
            color: #ff3e3e;
            font-size: 1.8rem;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 1);
            pointer-events: none;
            z-index: 1000;
            animation: floatIn 0.5s ease-out forwards;
        }

        @keyframes floatIn {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.5);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .shake {
            animation: shake 0.4s ease-in-out;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translate(0, 0);
            }

            20% {
                transform: translate(-10px, 5px);
            }

            40% {
                transform: translate(10px, -5px);
            }

            60% {
                transform: translate(-10px, -5px);
            }

            80% {
                transform: translate(10px, 5px);
            }
        }

        .sidebar {
            width: 250px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-invite {
            background: #6366f1;
            color: white;
        }

        .btn-rematch {
            background: #f59e0b;
            color: white;
            display: none;
        }

        .btn-exit {
            background: #ef4444;
            color: white;
            margin-top: auto;
        }

        .chat-container {
            width: 250px;
            background: var(--surface);
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
            height: 520px;
        }

        #chat-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 0.85rem;
        }
    </style>
</head>

<body>

    <div id="login-screen">
        <div class="login-box">
            <h1>DAMAS ELITE ONLINE ðŸ’€</h1>
            <p id="status-text">Conectando ao servidor de elite...</p>
            <input type="text" id="username" placeholder="Seu Nick"
                style="padding:10px; border-radius:5px; border:none;"><br><br>
            <button id="start-btn" class="btn"
                style="background:var(--primary); color:white; width:100%; opacity: 0.5; cursor: not-allowed;" disabled
                onclick="initGame()">CARREGANDO...</button>
        </div>
    </div>

    <div class="game-layout" id="game-ui">
        <div class="sidebar">
            <div id="timer" style="font-size:1.8rem; text-align:center; color:#94a3b8">Aguardando...</div>
            <button class="btn btn-invite" id="invite-btn" onclick="copyInvite()">ðŸ”— CONVIDAR AMIGO</button>
            <button class="btn btn-rematch" id="rematch-btn" onclick="requestRematch()">ðŸ”¥ PEDIR REVANCHE</button>
            <div id="info"
                style="font-size:0.9rem; padding:10px; background:rgba(255,255,255,0.05); border-radius:10px;">
                Status: <b id="connection-status">Conectando...</b><br>
                Cor: <b id="my-color">...</b>
            </div>
            <button class="btn btn-exit" onclick="location.reload()">ABANDONAR PARTIDA</button>
        </div>

        <div id="board-container">
            <div id="board" class="board"></div>
        </div>

        <div class="chat-container">
            <div id="chat-content"></div>
            <div style="padding:10px; display:flex; gap:5px; justify-content: center;">
                <button onclick="sendEmoji('ðŸ¤¡')"
                    style="font-size:1.5rem; background:none; border:none; cursor:pointer">ðŸ¤¡</button>
                <button onclick="sendEmoji('ðŸ˜‚')"
                    style="font-size:1.5rem; background:none; border:none; cursor:pointer">ðŸ˜‚</button>
                <button onclick="sendEmoji('ðŸ”¥')"
                    style="font-size:1.5rem; background:none; border:none; cursor:pointer">ðŸ”¥</button>
            </div>
            <input type="text" id="chat-input" placeholder="Provocar..." onkeydown="if(event.key==='Enter') sendMsg()"
                style="background:rgba(0,0,0,0.2); border:none; padding:15px; color:white">
        </div>
    </div>

    <script>
        let peer, conn, myId;
        let myColor = 'white';
        let isMyTurn = true;
        let gameStarted = false;
        let seconds = 0;
        let timerInterval;
        let boardState = Array(8).fill(null).map(() => Array(8).fill(null));

        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');

        // Inicializa o Peer imediatamente para carregar o ID
        peer = new Peer();

        peer.on('open', (id) => {
            myId = id;
            const btn = document.getElementById('start-btn');
            btn.disabled = false;
            btn.style.opacity = "1";
            btn.style.cursor = "pointer";
            btn.innerText = "ENTRAR NA ARENA";
            document.getElementById('status-text').innerText = "Servidor pronto!";
        });

        peer.on('error', (err) => {
            console.error('Erro no PeerJS:', err);
            alert("Erro de conexÃ£o: " + err.type);
        });

        function initGame() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-ui').style.opacity = '1';

            if (roomId) {
                // Se eu entrei pelo link, eu tento conectar no ID da URL
                conn = peer.connect(roomId);
                myColor = 'black';
                isMyTurn = false;
                setupConn();
            } else {
                document.getElementById('connection-status').innerText = "Esperando amigo...";
            }

            // O dono da sala recebe a conexÃ£o aqui
            peer.on('connection', (c) => {
                conn = c;
                setupConn();
                resetBoard();
                startGame();
                // Envia o tabuleiro inicial para quem acabou de conectar
                conn.send({ type: 'init', board: boardState });
            });

            resetBoard();
            render();
        }

        function setupConn() {
            conn.on('open', () => {
                document.getElementById('connection-status').innerText = "Conectado!";
                document.getElementById('my-color').innerText = myColor === 'white' ? 'Brancas' : 'Pretas';
                document.getElementById('rematch-btn').style.display = 'block';
                addChatMessage('Sistema', 'Oponente entrou na sala!');
                if (myColor === 'black') startGame();
            });

            conn.on('data', (data) => {
                if (data.type === 'move') {
                    boardState = data.board;
                    isMyTurn = true;
                    if (data.captured) triggerShatterEffect(data.capX, data.capY, data.phrase);
                    render();
                }
                if (data.type === 'chat') addChatMessage('Oponente', data.msg);
                if (data.type === 'init') {
                    boardState = data.board;
                    render();
                    addChatMessage('Sistema', 'Partida sincronizada!');
                }
                if (data.type === 'rematch_request') {
                    if (confirm("O oponente pediu uma revanche! Aceitar?")) {
                        resetBoard();
                        render();
                        conn.send({ type: 'rematch_accept' });
                        addChatMessage('Sistema', 'Revanche iniciada!');
                    }
                }
                if (data.type === 'rematch_accept') {
                    resetBoard();
                    render();
                    addChatMessage('Sistema', 'Revanche aceita!');
                }
            });

            conn.on('close', () => {
                document.getElementById('connection-status').innerText = "Oponente saiu.";
                addChatMessage('Sistema', 'A conexÃ£o foi perdida.');
            });
        }

        // FunÃ§Ãµes de Jogo
        function resetBoard() {
            boardState = Array(8).fill(null).map(() => Array(8).fill(null));
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    if ((r + c) % 2 !== 0) {
                        if (r < 3) boardState[r][c] = { color: 'black', king: false };
                        else if (r > 4) boardState[r][c] = { color: 'white', king: false };
                    }
                }
            }
            seconds = 0;
            isMyTurn = (myColor === 'white');
        }

        function startGame() {
            if (gameStarted) return;
            gameStarted = true;
            document.getElementById('timer').style.color = '#4CAF50';
            timerInterval = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        function render() {
            const b = document.getElementById('board');
            if (!b) return;
            b.innerHTML = '';
            boardState.forEach((row, r) => {
                row.forEach((piece, c) => {
                    const s = document.createElement('div');
                    s.className = `square ${(r + c) % 2 !== 0 ? 'dark' : 'light'}`;
                    s.dataset.r = r; s.dataset.c = c;
                    s.ondragover = e => e.preventDefault();
                    s.ondrop = handleDrop;

                    if (piece) {
                        const p = document.createElement('div');
                        p.className = `piece ${piece.color}-piece ${piece.king ? 'king' : ''}`;
                        p.draggable = (piece.color === myColor && isMyTurn && gameStarted);
                        p.ondragstart = (e) => { window.dragged = { r, c }; };
                        s.appendChild(p);
                    }
                    b.appendChild(s);
                });
            });
        }

        function handleDrop(e) {
            const tr = parseInt(this.dataset.r);
            const tc = parseInt(this.dataset.c);
            const fr = window.dragged.r;
            const fc = window.dragged.c;

            const move = validate(fr, fc, tr, tc);
            if (move) {
                const captured = !!move.cap;
                boardState[tr][tc] = boardState[fr][fc];
                boardState[fr][fc] = null;
                if (captured) boardState[move.cap.r][move.cap.c] = null;

                if ((myColor === 'white' && tr === 0) || (myColor === 'black' && tr === 7)) boardState[tr][tc].king = true;

                isMyTurn = false;
                const phrases = ["BOOOM! ðŸ’€", "VARRIDO! ðŸ§¹", "FRACO!", "APRENDE!", "JÃ ERA!"];
                const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];

                conn.send({
                    type: 'move',
                    board: boardState,
                    captured: captured,
                    capX: e.clientX,
                    capY: e.clientY,
                    phrase: randomPhrase
                });

                if (captured) triggerShatterEffect(e.clientX, e.clientY, randomPhrase);
                render();
            }
        }

        function validate(fr, fc, tr, tc) {
            if (boardState[tr][tc]) return null;
            const rd = tr - fr;
            const cd = Math.abs(tc - fc);
            const dir = myColor === 'white' ? -1 : 1;
            const isKing = boardState[fr][fc].king;

            if (cd === 1 && (isKing ? Math.abs(rd) === 1 : rd === dir)) return { cap: null };
            if (cd === 2 && (isKing ? Math.abs(rd) === 2 : rd === dir * 2)) {
                const mr = fr + (rd / 2);
                const mc = fc + (tc - fc) / 2;
                if (boardState[mr][mc] && boardState[mr][mc].color !== myColor) return { cap: { r: mr, c: mc } };
            }
            return null;
        }

        function triggerShatterEffect(x, y, phrase) {
            const old = document.querySelector('.trash-talk');
            if (old) old.remove();
            document.getElementById('board-container').classList.add('shake');
            setTimeout(() => document.getElementById('board-container').classList.remove('shake'), 400);
            const t = document.createElement('div');
            t.className = 'trash-talk';
            t.innerText = phrase;
            t.style.left = (x - 60) + 'px'; t.style.top = (y - 60) + 'px';
            document.body.appendChild(t);
        }

        function copyInvite() {
            if (!myId) { alert("Aguarde o servidor iniciar..."); return; }
            const url = window.location.origin + window.location.pathname + '?room=' + myId;

            const el = document.createElement('textarea');
            el.value = url;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            document.getElementById('invite-btn').innerText = "âœ… LINK COPIADO!";
            setTimeout(() => document.getElementById('invite-btn').innerText = "ðŸ”— CONVIDAR AMIGO", 2000);
        }

        function requestRematch() {
            if (!conn) return;
            conn.send({ type: 'rematch_request' });
            addChatMessage('Sistema', 'Pedido de revanche enviado...');
        }

        function sendMsg() {
            const i = document.getElementById('chat-input');
            if (!i.value || !conn) return;
            conn.send({ type: 'chat', msg: i.value });
            addChatMessage('VocÃª', i.value);
            i.value = '';
        }

        function sendEmoji(e) {
            if (!conn) return;
            conn.send({ type: 'chat', msg: e });
            addChatMessage('VocÃª', e);
        }

        function addChatMessage(user, msg) {
            const c = document.getElementById('chat-content');
            if (!c) return;
            c.innerHTML += `<div><b>${user}:</b> ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }
    </script>
</body>

</html>
