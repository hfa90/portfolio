<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cora√ß√£o Acolhido - IA Amiga</title>
    <style>
        :root {
            --cor-fundo: #fdf6f2;
            --cor-primaria: #e8a598;
            --cor-secundaria: #f9e4dc;
            --cor-texto: #5a4a42;
            --cor-balao-bot: #ffffff;
            --cor-balao-user: #f2d5ce;
        }

        .tema-homem {
            --cor-fundo: #f0f4f8;
            --cor-primaria: #4a90e2;
            --cor-secundaria: #d1e3f8;
            --cor-texto: #2c3e50;
            --cor-balao-bot: #ffffff;
            --cor-balao-user: #cfe2f3;
        }

        body {
            background-color: var(--cor-fundo);
            font-family: 'Segoe UI', sans-serif;
            color: var(--cor-texto);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            transition: all 0.5s ease;
        }

        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .modal {
            background: white;
            padding: 35px;
            border-radius: 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .modal input,
        .modal select,
        .modal button {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border-radius: 15px;
            border: 1px solid #eee;
            font-size: 1rem;
            box-sizing: border-box;
            outline: none;
        }

        .modal button {
            background: var(--cor-primaria);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
        }

        .app-container {
            width: 100%;
            max-width: 450px;
            height: 90vh;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 40px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.05);
        }

        header {
            padding: 25px;
            text-align: center;
            background: var(--cor-secundaria);
        }

        .chat-box {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message-wrapper {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .message {
            max-width: 85%;
            padding: 15px 20px;
            border-radius: 20px;
            font-size: 1rem;
            line-height: 1.6;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bot {
            align-self: flex-start;
            background: var(--cor-balao-bot);
            border-radius: 20px 20px 20px 5px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.02);
        }

        .user {
            align-self: flex-end;
            background: var(--cor-balao-user);
            border-radius: 20px 20px 5px 20px;
        }

        /* Estilo da Rea√ß√£o */
        .reaction {
            position: absolute;
            bottom: -10px;
            right: 10px;
            background: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            animation: bounceIn 0.5s cubic-bezier(0.36, 0, 0.66, -0.56) both;
            z-index: 10;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0);
            }

            100% {
                transform: scale(1);
            }
        }

        .typing {
            font-size: 0.85rem;
            color: var(--cor-primaria);
            margin-left: 20px;
            margin-bottom: 10px;
            display: none;
        }

        .input-area {
            padding: 20px;
            display: flex;
            gap: 10px;
            background: white;
        }

        input#userInput {
            flex: 1;
            padding: 15px 25px;
            border: 1px solid var(--cor-secundaria);
            border-radius: 30px;
            outline: none;
        }

        button#sendBtn {
            background: var(--cor-primaria);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
        }

        /* Lista de hist√≥rico discreta */
        .historico-lista {
            position: absolute;
            top: 60px;
            right: 15px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 200px;
            display: none;
            /* Escondido por padr√£o */
            z-index: 100;
            padding: 10px;
            border: 1px solid var(--cor-secundaria);
        }

        .historico-item {
            padding: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.3s;
        }

        .historico-item:hover {
            background: var(--cor-fundo);
        }


        .historico-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 4px;
        }

        .historico-item span {
            font-size: 0.9rem;
            opacity: 0.6;
        }

        /* Bot√£o Flutuante Discreto */
        .floating-menu-btn {
            position: fixed;
            bottom: 85px;
            /* Acima da √°rea de input */
            left: 20px;
            width: 45px;
            height: 45px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            z-index: 99;
            border: 1px solid var(--cor-secundaria);
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .floating-menu-btn:hover {
            transform: scale(1.1);
            background: var(--cor-secundaria);
        }

        /* Painel de Op√ß√µes */
        .menu-aconselhadores {
            position: fixed;
            bottom: 140px;
            left: 20px;
            background: white;
            border-radius: 20px;
            width: 220px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: none;
            /* Escondido por padr√£o */
            flex-direction: column;
            padding: 10px;
            z-index: 100;
            border: 1px solid var(--cor-secundaria);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .opcao-aconselhador {
            padding: 12px 15px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
            font-size: 0.9rem;
            color: var(--cor-texto);
        }

        .opcao-aconselhador:hover {
            background: var(--cor-fundo);
        }

        .opcao-aconselhador span {
            font-size: 1.2rem;
        }

        .opcao-aconselhador.ativo {
            background: var(--cor-secundaria);
            font-weight: bold;
        }



        /* Tema Religioso (Dourado/Bege) */
        .tema-religioso {
            --cor-fundo: #fffcf0;
            --cor-primaria: #d4af37;
            --cor-secundaria: #fdf2d0;
            --cor-texto: #5c4d1a;
            --cor-balao-user: #f9ecc2;
        }

        /* Tema Direto (Cinza Moderno/Focado) */
        .tema-direto {
            --cor-fundo: #f2f4f5;
            --cor-primaria: #607d8b;
            --cor-secundaria: #cfd8dc;
            --cor-texto: #263238;
            --cor-balao-user: #eceff1;
        }

        /* Tema Amig√°vel (Verde Suave) */
        .tema-amigavel {
            --cor-fundo: #f1f8e9;
            --cor-primaria: #8bc34a;
            --cor-secundaria: #dcedc8;
            --cor-texto: #33691e;
            --cor-balao-user: #f1f8e9;
        }

        /* Tema de Carreira (Azul Profissional) */
        .tema-carreira {
            --cor-fundo: #f0f7ff;
            --cor-primaria: #2c5282;
            --cor-secundaria: #ebf8ff;
            --cor-texto: #1a365d;
            --cor-balao-user: #bee3f8;
        }

        /* Estilo do Popup de Sele√ß√£o */
        .modal-conselheiro {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            /* Ativado via JS */
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(8px);
        }

        .card-selecao {
            background: white;
            padding: 30px;
            border-radius: 25px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .grid-conselheiros {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-escolha {
            padding: 15px;
            border-radius: 15px;
            border: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s;
            background: #fdfdfd;
        }

        .btn-escolha:hover {
            background: var(--cor-secundaria);
            transform: translateY(-3px);
        }

        .btn-escolha span {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 5px;
        }

        .btn-escolha label {
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
        }


        .grid-humor {
            display: flex;
            justify-content: space-around;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-humor {
            flex: 1;
            padding: 10px;
            border-radius: 15px;
            border: 1px solid #eee;
            cursor: pointer;
            background: #fdfdfd;
            transition: all 0.3s;
            font-size: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .btn-humor:hover {
            background: var(--cor-secundaria);
            transform: scale(1.1);
        }

        .btn-humor span {
            font-size: 0.7rem;
            font-weight: bold;
            color: #666;
            margin-top: 5px;
        }

        .btn-humor.selecionado {
            border-color: var(--cor-primaria);
            background: var(--cor-secundaria);
        }
    </style>
</head>

<body>

    <div id="modal-overlay">
        <div class="modal">
            <h2 id="modal-title">Entrar</h2>

            <input type="email" id="email" placeholder="Seu e-mail">
            <input type="password" id="password" placeholder="Sua senha">

            <div id="perfil-extra" style="display:none;">
                <input type="text" id="user-name" placeholder="Seu nome ou apelido...">
                <select id="select-genero">
                    <option value="mulher">Sou Mulher</option>
                    <option value="homem">Sou Homem</option>
                </select>
                <select id="select-status">
                    <option value="casada(o)">Casada(o)</option>
                    <option value="namorando">Namorando</option>
                    <option value="ficando">Ficando</option>
                    <option value="terminou recentemente">Terminei recentemente</option>
                </select>
            </div>

            <button id="auth-btn" onclick="handleAuth()">Entrar</button>
            <p id="toggle-text" style="font-size: 0.8rem; cursor: pointer; color: var(--cor-primaria);"
                onclick="toggleAuthMode()">
                N√£o tem conta? Cadastre-se
            </p>
        </div>
    </div>

    <div id="popup-selecao" class="modal-conselheiro">
        <div class="card-selecao">
            <div id="etapa-conselheiro">
                <h2 style="margin-top:0; color: #333;">Como posso te ajudar hoje?</h2>
                <div class="grid-conselheiros">
                    <div class="btn-escolha" onclick="proximaEtapaMood('psicologo')">
                        <span>üåø</span><label>Terapia</label>
                    </div>
                    <div class="btn-escolha" onclick="proximaEtapaMood('carreira')">
                        <span>üíº</span><label>Carreira</label>
                    </div>
                    <div class="btn-escolha" onclick="proximaEtapaMood('religioso')">
                        <span>üôè</span><label>Espiritual</label>
                    </div>
                    <div class="btn-escolha" onclick="proximaEtapaMood('direto')"><span>‚ö°</span><label>Pr√°tico</label>
                    </div>
                </div>
            </div>

            <div id="etapa-humor" style="display: none;">
                <h2 style="margin-top:0; color: #333;">Como voc√™ est√° se sentindo?</h2>
                <div class="grid-humor">
                    <div class="btn-humor" onclick="finalizarSelecao('Feliz')">üòä<span>Feliz</span></div>
                    <div class="btn-humor" onclick="finalizarSelecao('Ansioso')">üòü<span>Ansioso</span></div>
                    <div class="btn-humor" onclick="finalizarSelecao('Triste')">üò¢<span>Triste</span></div>
                    <div class="btn-humor" onclick="finalizarSelecao('Estressado')">ü§Ø<span>Exausto</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <header
            style="position: relative; padding: 40px 20px; background: var(--cor-secundaria); border-radius: 0 0 35px 35px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; gap: 15px;">



            <h1 id="titulo-app"
                style="margin: 0; font-size: 1.9rem; text-align: center; letter-spacing: -0.5px; width: 100%;">
                Cora√ß√£o Acolhido
            </h1>

            <div
                style="display: flex; gap: 20px; align-items: center; background: rgba(255,255,255,0.5); padding: 8px 20px; border-radius: 30px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.3);">
                <button onclick="toggleHistorico()" title="Hist√≥rico"
                    style="background: none; border: none; cursor: pointer; color: var(--cor-texto); font-size: 1.3rem; opacity: 0.7; padding: 5px; transition: transform 0.2s;"
                    onmouseover="this.style.transform='scale(1.1)'"
                    onmouseout="this.style.transform='scale(1)'">üïí</button>

                <button onclick="limparConversa()" title="Limpar Chat"
                    style="background: none; border: none; cursor: pointer; color: #cc0000; font-size: 1.3rem; opacity: 0.7; padding: 5px; transition: transform 0.2s;"
                    onmouseover="this.style.transform='scale(1.1)'"
                    onmouseout="this.style.transform='scale(1)'">üóëÔ∏è</button>

                <button onclick="logout()" title="Sair"
                    style="background: none; border: none; cursor: pointer; color: var(--cor-texto); font-size: 1.3rem; opacity: 0.7; padding: 5px; transition: transform 0.2s;"
                    onmouseover="this.style.transform='scale(1.1)'"
                    onmouseout="this.style.transform='scale(1)'">üö™</button>
            </div>

            <button id="btn-hoje" onclick="voltarParaHoje()"
                style="display: none; background: white; border: 1px solid var(--cor-primaria); color: var(--cor-primaria); padding: 8px 20px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; font-weight: bold; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                ‚Ü∫ Voltar para Hoje
            </button>

            <div id="listaHistorico" class="historico-lista"
                style="top: auto; bottom: -180px; left: 50%; transform: translateX(-50%); width: 220px;">
                <div
                    style="font-weight: bold; font-size: 0.75rem; margin-bottom: 8px; color: var(--cor-primaria); border-bottom: 1px solid #eee; padding-bottom: 5px; text-align: center;">
                    Conversas anteriores:
                </div>
                <div id="itensHistorico"></div>
            </div>
        </header>
        <div class="chat-box" id="chatBox">
            <div class="message-wrapper">
                <div class="message bot" id="welcome-msg">Ol√°! Estou aqui para te ouvir.</div>
            </div>
        </div>
        <div id="typing" class="typing">Digitando com carinho...</div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Desabafe aqui..." autocomplete="off">
            <button id="sendBtn" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "https://klfysmzrohyvvrxeyjgy.supabase.co";
        const SUPABASE_KEY = "sb_publishable_9oMW9dFmLxNK1PoFqsDPhg_q0RA1JdW";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const API_KEY = "AIzaSyAykg2ViXj9INRp9BqTJXpE0jMzyOhGl0E";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;

        let chatHistory = [];
        let usuario = {};

        // Inicializa o hist√≥rico e instru√ß√µes da IA
        function configurarGemini() {
            let personaPrompt = "";

            // Define a personalidade baseada na escolha do usu√°rio
            if (tipoAconselhador === 'carreira') {
                personaPrompt = `Voc√™ √© um mentor de carreira e especialista em mercado de trabalho. Ajude o usu√°rio ${usuario.nome} com conselhos sobre entrevistas, curr√≠culos, produtividade e transi√ß√£o de carreira. Seja motivador, profissional e estrat√©gico.`;
            } else if (tipoAconselhador === 'religioso') {
                personaPrompt = `Voc√™ √© um conselheiro espiritual acolhedor para ${usuario.nome}. Use palavras de f√©, esperan√ßa e compaix√£o. Cite conceitos de paz interior sem ser impositivo.`;
            } else if (tipoAconselhador === 'direto') {
                personaPrompt = `Voc√™ √© um mentor pragm√°tico. D√™ conselhos diretos, l√≥gicos e focados em solu√ß√µes imediatas para ${usuario.nome}. Sem rodeios.`;
            } else if (tipoAconselhador === 'amigavel') {
                personaPrompt = `Voc√™ √© o melhor amigo de ${usuario.nome}. Use linguagem informal, carinhosa e seja um √≥timo ouvinte, como se estivessem conversando em um caf√©.`;
            } else {
                personaPrompt = `Voc√™ √© um terapeuta chamado "Cora√ß√£o Acolhido". Paciente: ${usuario.nome}, ${usuario.genero}, ${usuario.status}. Foco em empatia e acolhimento emocional.`;
            }

            chatHistory = [{
                role: "user",
                parts: [{
                    text: `${personaPrompt}
            CONTEXTO ADICIONAL:
            - O usu√°rio relatou estar se sentindo: ${humorAtual}.
            - Abaixo est√° o que foi conversado ONTEM (use apenas se o usu√°rio perguntar ou demonstrar que n√£o lembra):
            --- IN√çCIO DO HIST√ìRICO DE ONTEM ---
            ${conteudoOntem}
            --- FIM DO HIST√ìRICO DE ONTEM ---

            REGRAS DE RESPOSTA:
            1. Se o usu√°rio disser que n√£o lembra de ontem ou perguntar "o que falamos?", fa√ßa um resumo muito breve e acolhedor em 2 frases no m√°ximo.
            2. Se ele n√£o mencionar ontem, ignore o hist√≥rico acima e foque no agora.
            3. Comece SEMPRE com UM emoji e '#'.
            4. Use '|' para separar par√°grafos.`
                }]
            }];
        }

        async function salvarMensagemNoBanco(role, content) {
            try {
                const { data: { session } } = await _supabase.auth.getSession();
                if (!session?.user) return;

                // O await aqui √© importante, mas envolvemos em um try/catch interno
                const { error } = await _supabase.from('historico_conversas').insert([
                    { user_id: session.user.id, role: role, content: content }
                ]);

                if (error) console.error("Erro Supabase:", error.message);
            } catch (e) {
                console.warn("Falha ao salvar hist√≥rico, mas a conversa continua...");
            }
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            const typingIndicator = document.getElementById('typing');

            if (!message) return;

            // 1. Exibe na tela
            const userMsgElement = appendMessage(message, 'user');
            input.value = "";
            typingIndicator.style.display = "block";

            // 2. SALVA NO BANCO DE DADOS (Mensagem do Usu√°rio)
            await salvarMensagemNoBanco('user', message);

            chatHistory.push({ role: "user", parts: [{ text: message }] });

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: chatHistory })
                });

                const data = await response.json();
                let fullBotReply = data.candidates[0].content.parts[0].text;

                // 3. SALVA NO BANCO DE DADOS (Resposta completa do Bot)
                await salvarMensagemNoBanco('model', fullBotReply);

                chatHistory.push({ role: "model", parts: [{ text: fullBotReply }] });

                // Extrai o emoji de rea√ß√£o
                const [reactionEmoji, botText] = fullBotReply.split('#');

                if (reactionEmoji && userMsgElement) {
                    const reactionDiv = document.createElement('div');
                    reactionDiv.className = 'reaction';
                    reactionDiv.innerText = reactionEmoji.trim();
                    userMsgElement.appendChild(reactionDiv);
                }

                const chunks = botText.split(/[|\n]+/).filter(c => c.trim().length > 0);
                typingIndicator.style.display = "none";

                for (const chunk of chunks) {
                    typingIndicator.style.display = "block";
                    await new Promise(r => setTimeout(r, 800 + (chunk.length * 15)));
                    typingIndicator.style.display = "none";
                    appendMessage(chunk.trim(), 'bot');
                }

            } catch (error) {
                typingIndicator.style.display = "none";
                appendMessage(`Sinto muito, ${usuario.nome}, tive um erro na conex√£o.`, 'bot');
            }
        }

        function appendMessage(text, side, buttons = []) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message-wrapper';

            const div = document.createElement('div');
            div.className = `message ${side}`;
            div.innerText = text;

            wrapper.appendChild(div);

            // Se houver bot√µes, adiciona-os logo abaixo da bolha de texto
            if (buttons.length > 0) {
                const btnContainer = document.createElement('div');
                btnContainer.style.display = 'flex';
                btnContainer.style.gap = '8px';
                btnContainer.style.marginTop = '10px';
                btnContainer.style.flexWrap = 'wrap';

                buttons.forEach(btn => {
                    const button = document.createElement('button');
                    button.innerText = btn.label;
                    button.style.cssText = `
                padding: 8px 16px;
                border-radius: 20px;
                border: 1px solid var(--cor-primaria);
                background: white;
                color: var(--cor-primaria);
                cursor: pointer;
                font-size: 0.85rem;
                font-weight: bold;
                transition: all 0.3s;
            `;
                    button.onclick = () => {
                        btnContainer.remove(); // Remove os bot√µes ap√≥s o clique
                        btn.action();
                    };
                    btnContainer.appendChild(button);
                });
                wrapper.appendChild(btnContainer);
            }

            const chatBox = document.getElementById('chatBox');
            chatBox.appendChild(wrapper);
            chatBox.scrollTop = chatBox.scrollHeight;

            return div;
        }




        async function carregarHistoricoDoBanco() {
            const { data: { user } } = await _supabase.auth.getUser();

            if (user) {
                const { data: mensagens, error } = await _supabase
                    .from('historico_conversas')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (!error && mensagens) {
                    mensagens.forEach(msg => {
                        // Se for do bot, precisamos tratar o formato emoji#texto
                        if (msg.role === 'model') {
                            const [_, botText] = msg.content.split('#');
                            const chunks = (botText || msg.content).split(/[|\n]+/).filter(c => c.trim().length > 0);
                            chunks.forEach(chunk => appendMessage(chunk.trim(), 'bot'));
                        } else {
                            appendMessage(msg.content, 'user');
                        }

                        // Alimenta o chatHistory para a IA ter contexto
                        chatHistory.push({ role: msg.role, parts: [{ text: msg.content }] });
                    });
                }
            }
        }

        document.getElementById('userInput').addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage());

        let isSignUpMode = false;

        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            document.getElementById('modal-title').innerText = isSignUpMode ? "Criar Conta" : "Entrar";
            document.getElementById('auth-btn').innerText = isSignUpMode ? "Cadastrar" : "Entrar";
            document.getElementById('perfil-extra').style.display = isSignUpMode ? "block" : "none";
            document.getElementById('toggle-text').innerText = isSignUpMode ? "J√° tem conta? Entre aqui" : "N√£o tem conta? Cadastre-se";
        }

        // 1. Deixe o window.onload FORA de qualquer fun√ß√£o, no escopo principal do script
        window.onload = async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) {
                carregarDadosEIniciar(session.user);
            }
        };

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                if (isSignUpMode) {
                    const { data, error } = await _supabase.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                nome: document.getElementById('user-name').value,
                                genero: document.getElementById('select-genero').value,
                                status: document.getElementById('select-status').value
                            }
                        }
                    });
                    if (error) throw error;
                    alert("Verifique seu e-mail para confirmar o cadastro!");
                } else {
                    const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    if (data.user) carregarDadosEIniciar(data.user);
                }
            } catch (error) {
                alert("Erro na autentica√ß√£o: " + error.message);
            }
        }

        function carregarDadosEIniciar(user) {
            usuario = {
                nome: user.user_metadata.nome || "Amigo",
                genero: user.user_metadata.genero || "mulher",
                status: user.user_metadata.status || "solteiro"
            };

            if (usuario.genero === 'homem') {
                document.body.classList.add('tema-homem');
                document.getElementById('titulo-app').innerText = "Amigo Conselheiro";
            }

            document.getElementById('welcome-msg').innerText = `Oi, ${usuario.nome}. Que bom te ver de novo.`;
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'none';
            // Abre o popup de sele√ß√£o de conselheiro
            document.getElementById('popup-selecao').style.display = 'flex';

            configurarGemini();
            carregarHistoricoDoBanco(); // Adicionado par√™nteses
            iniciarTemporizadorSessao();
        }



        // Fun√ß√£o para sair
        async function logout() {
            const { error } = await _supabase.auth.signOut();
            if (error) alert("Erro ao sair: " + error.message);
            window.location.reload(); // Recarrega a p√°gina para voltar ao modal de login
        }

        // L√≥gica de tempo de sess√£o (1h 30min)
        function iniciarTemporizadorSessao() {
            const noventaMinutos = 90 * 60 * 1000; // milissegundos
            setTimeout(() => {
                alert("Sua sess√£o de 1h30 expirou por seguran√ßa.");
                logout();
            }, noventaMinutos);
        }


        async function limparConversa() {
            if (!confirm("Tem certeza que deseja apagar todo o hist√≥rico de conversas?")) return;

            const { data: { user } } = await _supabase.auth.getUser();
            if (user) {
                const { error } = await _supabase
                    .from('historico_conversas')
                    .delete()
                    .eq('user_id', user.id);

                if (error) {
                    alert("Erro ao limpar conversa: " + error.message);
                } else {
                    // Limpa a tela e o hist√≥rico local
                    document.getElementById('chatBox').innerHTML = `
                <div class="message-wrapper">
                    <div class="message bot" id="welcome-msg">Hist√≥rico limpo. Como posso te ajudar agora?</div>
                </div>`;
                    chatHistory = [];
                    configurarGemini(); // Reinicia as instru√ß√µes do sistema
                }
            }
        }

        // Alterna a exibi√ß√£o do menu de hist√≥rico
        async function toggleHistorico() {
            const lista = document.getElementById('listaHistorico');
            if (lista.style.display === 'block') {
                lista.style.display = 'none';
            } else {
                lista.style.display = 'block';
                await carregarDiasComConversa();
            }
        }

        // Busca no Supabase as datas √∫nicas das conversas
        // Busca no Supabase as datas √∫nicas das conversas
        async function carregarDiasComConversa() {
            const container = document.getElementById('itensHistorico');
            container.innerHTML = "<div style='font-size:0.7rem; padding:5px;'>Carregando...</div>";

            const { data: { user } } = await _supabase.auth.getUser();

            const { data, error } = await _supabase
                .from('historico_conversas')
                .select('created_at')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });

            if (error || !data || data.length === 0) {
                container.innerHTML = "<div style='font-size:0.7rem; padding:5px;'>Nenhum hist√≥rico encontrado.</div>";
                return;
            }

            // Filtra para mostrar apenas datas √∫nicas (dia/m√™s/ano)
            const diasUnicos = [...new Set(data.map(item =>
                new Date(item.created_at).toLocaleDateString('pt-BR')
            ))].slice(0, 7); // Mostra at√© a √∫ltima semana

            container.innerHTML = "";
            diasUnicos.forEach(dia => {
                const div = document.createElement('div');
                div.className = 'historico-item';
                div.innerHTML = `<span>üìÖ</span> ${dia}`;
                // Ao clicar, chama a fun√ß√£o de carregar aquele dia espec√≠fico
                div.onclick = () => carregarMensagensPorData(dia);
                container.appendChild(div);
            });
        }

        async function voltarParaHoje() {
            document.getElementById('chatBox').innerHTML = ""; // Limpa a vis√£o do passado
            chatHistory = []; // Limpa o hist√≥rico de mem√≥ria da IA
            configurarGemini(); // Reseta instru√ß√µes

            // Esconde o bot√£o de voltar
            document.getElementById('btn-hoje').style.display = 'none';

            // Recarrega as mensagens do banco
            await carregarHistoricoDoBanco();

            // Mensagem de boas-vindas atualizada
            appendMessage(`Voltamos para agora, ${usuario.nome}. Como voc√™ est√° se sentindo neste momento?`, 'bot');
        }

        // Carrega as mensagens de um dia espec√≠fico
        // Atualize sua fun√ß√£o existente para mostrar o bot√£o quando carregar um dia antigo:
        async function carregarMensagensPorData(dataString) {
            const chatBox = document.getElementById('chatBox');
            const lista = document.getElementById('listaHistorico');
            const btnHoje = document.getElementById('btn-hoje');

            // Mostra o bot√£o "Voltar para Hoje"
            btnHoje.style.display = 'block';

            chatBox.innerHTML = `<div style="text-align:center; font-size:0.8rem; color:var(--cor-primaria); margin:10px 0; font-style: italic;">‚Äî Olhando para o passado: ${dataString} ‚Äî</div>`;
            chatHistory = [];
            configurarGemini();
            lista.style.display = 'none';

            const [dia, mes, ano] = dataString.split('/');
            const dataInicio = `${ano}-${mes}-${dia}T00:00:00Z`;
            const dataFim = `${ano}-${mes}-${dia}T23:59:59Z`;

            const { data: mensagens, error } = await _supabase
                .from('historico_conversas')
                .select('*')
                .gte('created_at', dataInicio)
                .lte('created_at', dataFim)
                .order('created_at', { ascending: true });

            if (error) return alert("Erro ao carregar dia: " + error.message);

            mensagens.forEach(msg => {
                if (msg.role === 'model') {
                    const parts = msg.content.split('#');
                    const botText = parts.length > 1 ? parts[1] : parts[0];
                    const chunks = botText.split(/[|\n]+/).filter(c => c.trim().length > 0);
                    chunks.forEach(chunk => appendMessage(chunk.trim(), 'bot'));
                } else {
                    appendMessage(msg.content, 'user');
                }
                chatHistory.push({ role: msg.role, parts: [{ text: msg.content }] });
            });
        }

        // Fecha o hist√≥rico se clicar fora dele
        window.onclick = function (event) {
            if (!event.target.matches('button')) {
                const lista = document.getElementById('listaHistorico');
                if (lista) lista.style.display = 'none';
            }
        }



        let tipoAconselhador = 'psicologo';

        function toggleMenuAconselhadores() {
            const menu = document.getElementById('menuAconselhadores');
            menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
        }

        function mudarAconselhador(tipo, elemento, isInitial = false) {
            tipoAconselhador = tipo;

            // Limpa absolutamente todos os temas poss√≠veis
            document.body.classList.remove('tema-religioso', 'tema-direto', 'tema-amigavel', 'tema-carreira', 'tema-homem');

            // Aplica o novo tema visual
            const temas = {
                'religioso': 'tema-religioso',
                'direto': 'tema-direto',
                'amigavel': 'tema-amigavel',
                'carreira': 'tema-carreira'
            };

            if (temas[tipo]) {
                document.body.classList.add(temas[tipo]);
            } else if (tipo === 'psicologo' && usuario.genero === 'homem') {
                document.body.classList.add('tema-homem');
            }

            // Fecha os menus/popups
            document.getElementById('popup-selecao').style.display = 'none';
            const menuLat = document.getElementById('menuAconselhadores');
            if (menuLat) menuLat.style.display = 'none';

            // Reinicia a IA com a nova instru√ß√£o
            configurarGemini();

            // Se n√£o for a escolha inicial do login, avisa no chat
            if (!isInitial) {
                const nomes = {
                    'psicologo': 'Terapia',
                    'carreira': 'Foco em Carreira',
                    'religioso': 'Espiritualidade',
                    'direto': 'Modo Pr√°tico',
                    'amigavel': 'Modo Amigo'
                };
                appendMessage(`Abordagem alterada para: ${nomes[tipo]}.`, 'bot');
            }
        }

        // ATUALIZE sua fun√ß√£o configurarGemini() existente para incluir as novas personas:
        function configurarGemini() {
            let personaPrompt = "";

            if (tipoAconselhador === 'carreira') {
                personaPrompt = `Voc√™ √© um mentor de carreira e especialista em mercado de trabalho. Ajude com conselhos sobre entrevistas, produtividade, transi√ß√£o de carreira e lideran√ßa. Seja motivador, profissional e estrat√©gico.`;
            } else if (tipoAconselhador === 'religioso') {
                personaPrompt = `Voc√™ √© um conselheiro espiritual acolhedor. Use palavras de f√© e compaix√£o.`;
            } else if (tipoAconselhador === 'direto') {
                personaPrompt = `Voc√™ √© um mentor direto e pr√°tico. Foque em solu√ß√µes, passos acion√°veis e l√≥gica, mantendo a educa√ß√£o, mas sem rodeios.`;
            } else if (tipoAconselhador === 'amigavel') {
                personaPrompt = `Voc√™ √© um melhor amigo de longa data. Use uma linguagem mais informal, carinhosa e focada em "estar junto" e ouvir, como se estivessem tomando um caf√©.`;
            } else {
                personaPrompt = `Voc√™ √© um terapeuta chamado "Cora√ß√£o Acolhido". Paciente: ${usuario.nome}, ${usuario.genero}, ${usuario.status}. Foco em psicologia humanista e empatia.`;
            }

            chatHistory = [{
                role: "user",
                parts: [{
                    text: `${personaPrompt}
            REGRAS DE RESPOSTA:
            1. Comece SEMPRE sua resposta com apenas UM emoji e '#'. Exemplo: ‚ù§Ô∏è#
            2. Nunca use t√≥picos ou listas.
            3. Responda com no m√°ximo 3 par√°grafos curtos usando '|' para separar.`
                }]
            }];
        }


        let humorAtual = "Neutro"; // Vari√°vel global para guardar o humor

        function proximaEtapaMood(tipo) {
            // Primeiro aplicamos o tipo e o tema (como j√° faz√≠amos)
            tipoAconselhador = tipo;
            document.body.classList.remove('tema-religioso', 'tema-direto', 'tema-amigavel', 'tema-carreira', 'tema-homem');

            const temas = { 'religioso': 'tema-religioso', 'direto': 'tema-direto', 'amigavel': 'tema-amigavel', 'carreira': 'tema-carreira' };
            if (temas[tipo]) document.body.classList.add(temas[tipo]);
            else if (tipo === 'psicologo' && usuario.genero === 'homem') document.body.classList.add('tema-homem');

            // Troca a tela do popup
            document.getElementById('etapa-conselheiro').style.display = 'none';
            document.getElementById('etapa-humor').style.display = 'block';
        }

        async function finalizarSelecao(humor) {
            humorAtual = humor;
            document.getElementById('popup-selecao').style.display = 'none';

            configurarGemini();

            const pendencia = await verificarUltimaMensagemPendente();
            let saudacao = "";
            let botoes = [];

            const boasVindasHumor = {
                'Feliz': `Que maravilha te ver feliz, ${usuario.nome}!`,
                'Ansioso': `Respire fundo, ${usuario.nome}. Estou aqui com voc√™.`,
                'Triste': `Sinto muito que as coisas estejam dif√≠ceis hoje, ${usuario.nome}.`,
                'Estressado': `Pare um minuto, ${usuario.nome}. Deixe o peso do mundo l√° fora.`
            };

            saudacao = boasVindasHumor[humor] || `Oi ${usuario.nome}, que bom te ver.`;

            if (pendencia && pendencia.foiUsuario) {
                saudacao += ` | Notei que nossa √∫ltima conversa parou em: "${pendencia.texto.substring(0, 30)}...". Como prefere seguir?`;

                botoes = [
                    {
                        label: "üîÑ Continuar de onde paramos",
                        action: () => {
                            document.getElementById('userInput').value = "Vamos continuar nossa √∫ltima conversa?";
                            sendMessage();
                        }
                    },
                    {
                        label: "üÜï Iniciar novo assunto",
                        action: () => {
                            appendMessage("Entendido! Vamos focar no agora. O que est√° em sua mente?", 'bot');
                        }
                    }
                ];
            } else {
                const teveConversaOntem = await verificarConversaOntem();
                if (teveConversaOntem) {
                    saudacao += ` | A nossa conversa de ontem te ajudou de alguma forma?`;
                } else {
                    saudacao += ` Como posso te ouvir agora?`;
                }
            }

            appendMessage(saudacao, 'bot', botoes);
        }

        // ATUALIZE sua fun√ß√£o configurarGemini para usar o humorAtual:
        function configurarGemini() {
            let personaPrompt = "";

            // Personalidades (mantendo o que voc√™ j√° tinha)
            if (tipoAconselhador === 'carreira') {
                personaPrompt = `Voc√™ √© um mentor de carreira.`;
            } else if (tipoAconselhador === 'religioso') {
                personaPrompt = `Voc√™ √© um conselheiro espiritual.`;
            } // ... (resto das suas personas)

            chatHistory = [{
                role: "user",
                parts: [{
                    text: `${personaPrompt} 
            IMPORTANTE: O usu√°rio ${usuario.nome} relatou que hoje se sente: ${humorAtual}. 
            Adapte seu tom de voz a esse sentimento.
            REGRAS DE RESPOSTA:
            1. Comece SEMPRE sua resposta com apenas UM emoji e '#'.
            2. Nunca use t√≥picos ou listas.
            3. Responda com no m√°ximo 3 par√°grafos curtos usando '|'.`
                }]
            }];
        }

        async function verificarConversaOntem() {
            const { data: { user } } = await _supabase.auth.getUser();

            // Calcula a data de ontem (in√≠cio e fim do dia)
            const ontem = new Date();
            ontem.setDate(ontem.getDate() - 1);
            const dataInicio = new Date(ontem.setHours(0, 0, 0, 0)).toISOString();
            const dataFim = new Date(ontem.setHours(23, 59, 59, 999)).toISOString();

            const { data, error } = await _supabase
                .from('historico_conversas')
                .select('id')
                .eq('user_id', user.id)
                .gte('created_at', dataInicio)
                .lte('created_at', dataFim)
                .limit(1);

            return data && data.length > 0;
        }


        async function buscarResumoOntem() {
            const { data: { user } } = await _supabase.auth.getUser();

            const ontem = new Date();
            ontem.setDate(ontem.getDate() - 1);
            const dataInicio = new Date(ontem.setHours(0, 0, 0, 0)).toISOString();
            const dataFim = new Date(ontem.setHours(23, 59, 59, 999)).toISOString();

            const { data, error } = await _supabase
                .from('historico_conversas')
                .select('content, role')
                .eq('user_id', user.id)
                .gte('created_at', dataInicio)
                .lte('created_at', dataFim)
                .order('created_at', { ascending: true });

            if (error || !data || data.length === 0) return "N√£o encontrei registros da nossa conversa de ontem.";

            // Formata as mensagens para a IA entender o contexto
            return data.map(m => `${m.role === 'user' ? 'Usu√°rio' : 'IA'}: ${m.content}`).join('\n');
        }

        async function verificarUltimaMensagemPendente() {
            const { data: { user } } = await _supabase.auth.getUser();

            // Busca a √∫ltima mensagem enviada no hist√≥rico geral
            const { data, error } = await _supabase
                .from('historico_conversas')
                .select('content, role, created_at')
                .eq('user_id', user.id)
                .order('created_at', { descending: true })
                .limit(1);

            if (error || !data || data.length === 0) return null;

            const ultimaMsg = data[0];
            const agora = new Date();
            const dataMsg = new Date(ultimaMsg.created_at);
            const diffMinutos = Math.floor((agora - dataMsg) / (1000 * 60));

            // Se a √∫ltima mensagem foi do usu√°rio, ele saiu sem resposta
            // Ou se foi da IA mas faz pouco tempo (ex: menos de 2 horas), pode ser uma continua√ß√£o
            return {
                foiUsuario: ultimaMsg.role === 'user',
                texto: ultimaMsg.content,
                tempo: diffMinutos
            };
        }

    </script>




    <div class="floating-menu-btn" onclick="toggleMenuAconselhadores()" title="Mudar Aconselhador">
        ‚ú®
    </div>

    <div id="menuAconselhadores" class="menu-aconselhadores">
        <div style="font-size: 0.75rem; color: var(--cor-primaria); font-weight: bold; padding: 5px 15px;">MUDAR
            ABORDAGEM:</div>

        <div class="opcao-aconselhador" onclick="mudarAconselhador('psicologo', this)">
            <span>üåø</span> Terapia Tradicional
        </div>

        <div class="opcao-aconselhador" onclick="mudarAconselhador('carreira', this)">
            <span>üíº</span> Carreira e Trabalho
        </div>

        <div class="opcao-aconselhador" onclick="mudarAconselhador('religioso', this)">
            <span>üôè</span> Aconselhamento Espiritual
        </div>

        <div class="opcao-aconselhador" onclick="mudarAconselhador('direto', this)">
            <span>‚ö°</span> Conselhos Pr√°ticos
        </div>

        <div class="opcao-aconselhador" onclick="mudarAconselhador('amigavel', this)">
            <span>üß∏</span> Apenas um Amigo
        </div>
    </div>
</body>

</html>
