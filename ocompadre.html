<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Cora√ß√£o Acolhido">
    <meta name="theme-color" content="#fdf6f2">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíó</text></svg>">
    <title>Cora√ß√£o Acolhido - IA Amiga</title>
    <style>
        * {
            box-sizing: border-box;
        }

        /* Remove estilos nativos de bot√£o no iOS */
        button {
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
        }

        /* Scroll suave global */
        html {
            /* Garante que o scroll seja sempre suave */
            scroll-behavior: smooth;
            /* Ocupa a tela inteira no iOS */
            height: -webkit-fill-available;
        }

        :root {
            --cor-fundo: #fdf6f2;
            --cor-primaria: #e8a598;
            --cor-secundaria: #f9e4dc;
            --cor-texto: #5a4a42;
            --cor-balao-bot: #ffffff;
            --cor-balao-user: #f2d5ce;
        }

        .tema-homem {
            --cor-fundo: #f0f4f8;
            --cor-primaria: #4a90e2;
            --cor-secundaria: #d1e3f8;
            --cor-texto: #2c3e50;
            --cor-balao-bot: #ffffff;
            --cor-balao-user: #cfe2f3;
        }

        body {
            background-color: var(--cor-fundo);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif;
            color: var(--cor-texto);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            /* dvh = dynamic viewport height: corrige o bug do Safari com a barra de endere√ßo */
            height: 100dvh;
            min-height: 100dvh;
            /* Fallback para browsers sem suporte a dvh */
            height: -webkit-fill-available;
            transition: background-color 0.5s ease, color 0.5s ease;
            /* Evita bounce scroll nativo no iOS */
            overscroll-behavior: none;
            /* Previne sele√ß√£o acidental de texto ao tocar */
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .modal {
            background: white;
            padding: 35px;
            border-radius: 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .modal input,
        .modal select,
        .modal button {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border-radius: 15px;
            border: 1px solid #eee;
            /* 16px OBRIGAT√ìRIO para evitar zoom autom√°tico no iOS */
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .modal button {
            background: var(--cor-primaria);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
        }

        .app-container {
            width: 100%;
            max-width: 450px;
            /* Ocupa toda a altura din√¢mica dispon√≠vel */
            height: 100dvh;
            height: -webkit-fill-available;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Em tablets/desktop: volta ao card flutuante */
        @media (min-width: 500px) {
            .app-container {
                height: 92dvh;
                max-height: 820px;
                border-radius: 40px;
                border: 1px solid rgba(255, 255, 255, 0.5);
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
                background: rgba(255, 255, 255, 0.88);
            }
        }

        header {
            padding: 25px;
            text-align: center;
            background: var(--cor-secundaria);
        }

        .chat-box {
            flex: 1;
            padding: 16px 16px 8px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 15px;
            /* Scroll momentum nativo do iOS */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }

        .message-wrapper {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .message {
            max-width: 85%;
            padding: 15px 20px;
            border-radius: 20px;
            font-size: 1rem;
            line-height: 1.6;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bot {
            align-self: flex-start;
            background: var(--cor-balao-bot);
            border-radius: 20px 20px 20px 5px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.02);
        }

        .user {
            align-self: flex-end;
            background: var(--cor-balao-user);
            border-radius: 20px 20px 5px 20px;
        }

        /* Estilo da Rea√ß√£o */
        .reaction {
            position: absolute;
            bottom: -10px;
            right: 10px;
            background: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            animation: bounceIn 0.5s cubic-bezier(0.36, 0, 0.66, -0.56) both;
            z-index: 10;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0);
            }

            100% {
                transform: scale(1);
            }
        }

        .typing {
            font-size: 0.85rem;
            color: var(--cor-primaria);
            margin-left: 20px;
            margin-bottom: 10px;
            display: none;
        }

        .input-area {
            padding: 12px 16px;
            /* env(safe-area-inset-bottom) = espa√ßo do home indicator iPhone X+ */
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
            display: flex;
            gap: 10px;
            background: white;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
        }

        input#userInput {
            flex: 1;
            padding: 13px 20px;
            border: 1px solid var(--cor-secundaria);
            border-radius: 30px;
            outline: none;
            /* CR√çTICO: font-size abaixo de 16px causa zoom autom√°tico no iOS Safari */
            font-size: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            background: var(--cor-fundo);
            /* Remove o estilo padr√£o do iOS */
            -webkit-appearance: none;
            appearance: none;
        }

        input#userInput:focus {
            border-color: var(--cor-primaria);
            background: white;
            box-shadow: 0 0 0 3px rgba(232, 165, 152, 0.15);
        }

        button#sendBtn {
            background: var(--cor-primaria);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
        }

        /* Lista de hist√≥rico discreta */
        .historico-lista {
            position: absolute;
            top: 60px;
            right: 15px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 200px;
            display: none;
            /* Escondido por padr√£o */
            z-index: 100;
            padding: 10px;
            border: 1px solid var(--cor-secundaria);
        }

        .historico-item {
            padding: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.3s;
        }

        .historico-item:hover {
            background: var(--cor-fundo);
        }


        .historico-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 4px;
        }

        .historico-item span {
            font-size: 0.9rem;
            opacity: 0.6;
        }

        /* Bot√£o Flutuante Discreto */
        .floating-menu-btn {
            position: fixed;
            bottom: calc(85px + env(safe-area-inset-bottom));
            left: 20px;
            width: 45px;
            height: 45px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            z-index: 99;
            border: 1px solid var(--cor-secundaria);
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .floating-menu-btn:hover {
            transform: scale(1.1);
            background: var(--cor-secundaria);
        }

        /* Painel de Op√ß√µes */
        .menu-aconselhadores {
            position: fixed;
            bottom: calc(140px + env(safe-area-inset-bottom));
            left: 20px;
            background: white;
            border-radius: 20px;
            width: 220px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: none;
            /* Escondido por padr√£o */
            flex-direction: column;
            padding: 10px;
            z-index: 100;
            border: 1px solid var(--cor-secundaria);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .opcao-aconselhador {
            padding: 12px 15px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
            font-size: 0.9rem;
            color: var(--cor-texto);
        }

        .opcao-aconselhador:hover {
            background: var(--cor-fundo);
        }

        .opcao-aconselhador span {
            font-size: 1.2rem;
        }

        .opcao-aconselhador.ativo {
            background: var(--cor-secundaria);
            font-weight: bold;
        }



        /* Tema Religioso (Dourado/Bege) */
        .tema-religioso {
            --cor-fundo: #fffcf0;
            --cor-primaria: #d4af37;
            --cor-secundaria: #fdf2d0;
            --cor-texto: #5c4d1a;
            --cor-balao-user: #f9ecc2;
        }

        /* Tema Direto (Cinza Moderno/Focado) */
        .tema-direto {
            --cor-fundo: #f2f4f5;
            --cor-primaria: #607d8b;
            --cor-secundaria: #cfd8dc;
            --cor-texto: #263238;
            --cor-balao-user: #eceff1;
        }

        /* Tema Amig√°vel (Verde Suave) */
        .tema-amigavel {
            --cor-fundo: #f1f8e9;
            --cor-primaria: #8bc34a;
            --cor-secundaria: #dcedc8;
            --cor-texto: #33691e;
            --cor-balao-user: #f1f8e9;
        }

        /* Tema de Carreira (Azul Profissional) */
        .tema-carreira {
            --cor-fundo: #f0f7ff;
            --cor-primaria: #2c5282;
            --cor-secundaria: #ebf8ff;
            --cor-texto: #1a365d;
            --cor-balao-user: #bee3f8;
        }


        /* Tema Luto (Violeta suave) */
        .tema-luto {
            --cor-fundo: #f5f0fa;
            --cor-primaria: #7c5cbf;
            --cor-secundaria: #ede8f7;
            --cor-texto: #3b2a5a;
            --cor-balao-bot: #ffffff;
            --cor-balao-user: #ddd5f5;
        }

        /* Tema Doenca (Verde-sage) */
        .tema-doenca {
            --cor-fundo: #f0f7f4;
            --cor-primaria: #4a8c6f;
            --cor-secundaria: #d9eeea;
            --cor-texto: #1f3d2f;
            --cor-balao-bot: #ffffff;
            --cor-balao-user: #c3e0d6;
        }

        /* Estilo do Popup de Sele√ß√£o */
        .modal-conselheiro {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            /* Ativado via JS */
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(8px);
        }

        .card-selecao {
            background: white;
            padding: 30px;
            border-radius: 25px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .grid-conselheiros {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-escolha {
            padding: 15px;
            border-radius: 15px;
            border: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s;
            background: #fdfdfd;
        }

        .btn-escolha:hover {
            background: var(--cor-secundaria);
            transform: translateY(-3px);
        }

        .btn-escolha span {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 5px;
        }

        .btn-escolha label {
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
        }


        .grid-humor {
            display: flex;
            justify-content: space-around;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-humor {
            flex: 1;
            padding: 10px;
            border-radius: 15px;
            border: 1px solid #eee;
            cursor: pointer;
            background: #fdfdfd;
            transition: all 0.3s;
            font-size: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .btn-humor:hover {
            background: var(--cor-secundaria);
            transform: scale(1.1);
        }

        .btn-humor span {
            font-size: 0.7rem;
            font-weight: bold;
            color: #666;
            margin-top: 5px;
        }

        .btn-humor.selecionado {
            border-color: var(--cor-primaria);
            background: var(--cor-secundaria);
        }

        /* Estilo do Alerta de Erro */
        .error-toast {
            background-color: #ffeded;
            color: #c0392b;
            border: 1px solid #ffcccc;
            padding: 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            margin-top: 10px;
            display: none;
            /* Escondido por padr√£o */
            animation: shake 0.4s ease-in-out;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        /* Estilo para o bot√£o em estado de carregamento */
        .btn-loading {
            background: #d1d1d1 !important;
            cursor: not-allowed !important;
            position: relative;
            pointer-events: none;
        }

        .loader-fofo {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Efeito de pulsa√ß√£o suave no bot√£o */
        .pulse-fofo {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Bot√£o Google */
        .btn-google {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 13px 14px;
            margin: 4px 0 10px 0;
            border-radius: 15px;
            border: 1.5px solid #dadce0;
            background: #ffffff;
            color: #3c4043;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            box-sizing: border-box;
            transition: background 0.2s, box-shadow 0.2s;
            font-family: 'Segoe UI', sans-serif;
        }

        .btn-google:hover {
            background: #f8f9fa;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.12);
        }

        .auth-divider {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 6px 0;
            color: #bbb;
            font-size: 0.8rem;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #eee;
        }

        /* Bot√£o TTS */
        #tts-btn {
            width: 50px;
            height: 50px;
            background: var(--cor-secundaria);
            border: 1.5px solid var(--cor-primaria);
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        #tts-btn:hover {
            background: var(--cor-primaria);
        }

        #tts-btn.falando {
            background: var(--cor-primaria);
            animation: pulso-voz 1.2s ease-in-out infinite;
        }

        #tts-btn.mudo {
            opacity: 0.45;
        }

        @keyframes pulso-voz {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(232, 165, 152, 0.6);
            }

            50% {
                transform: scale(1.08);
                box-shadow: 0 0 0 8px rgba(232, 165, 152, 0);
            }
        }

        /* ‚îÄ‚îÄ Check-in di√°rio ‚îÄ‚îÄ */
        .checkin-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            backdrop-filter: blur(6px);
        }

        .checkin-card {
            background: white;
            border-radius: 28px;
            padding: 32px 28px;
            width: 90%;
            max-width: 380px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.18);
            animation: fadeIn 0.35s ease;
        }

        .checkin-card h3 {
            margin: 0 0 6px;
            font-size: 1.3rem;
            color: #333;
        }

        .checkin-card p {
            margin: 0 0 20px;
            font-size: 0.9rem;
            color: #888;
        }

        .checkin-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, var(--cor-primaria) 0%, var(--cor-primaria) 50%, #eee 50%, #eee 100%);
            outline: none;
            margin: 10px 0 6px;
        }

        .checkin-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--cor-primaria);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .checkin-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #aaa;
            margin-bottom: 18px;
        }

        .checkin-valor {
            font-size: 2rem;
            font-weight: bold;
            color: var(--cor-primaria);
            margin: 4px 0 16px;
        }

        .checkin-perguntas {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkin-opcao {
            padding: 11px 16px;
            border-radius: 14px;
            border: 1.5px solid #eee;
            cursor: pointer;
            font-size: 0.92rem;
            background: #fdfdfd;
            transition: all 0.25s;
            text-align: left;
        }

        .checkin-opcao:hover,
        .checkin-opcao.sel {
            background: var(--cor-secundaria);
            border-color: var(--cor-primaria);
            font-weight: 600;
        }

        .checkin-btn-ok {
            width: 100%;
            padding: 14px;
            border-radius: 16px;
            border: none;
            background: var(--cor-primaria);
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .checkin-btn-ok:hover {
            opacity: 0.88;
        }

        .checkin-step {
            display: none;
        }

        .checkin-step.ativo {
            display: block;
        }
    </style>
</head>

<body>

    <div id="modal-overlay">
        <div class="modal">
            <h2 id="modal-title">Entrar</h2>

            <input type="email" id="email" placeholder="Seu e-mail">
            <input type="password" id="password" placeholder="Sua senha">
            <div id="error-message" class="error-toast"></div>


            <div id="perfil-extra" style="display:none;">
                <input type="text" id="user-name" placeholder="Seu nome ou apelido...">
                <select id="select-genero">
                    <option value="mulher">Sou Mulher</option>
                    <option value="homem">Sou Homem</option>
                </select>
                <select id="select-status">
                    <option value="casada(o)">Casada(o)</option>
                    <option value="namorando">Namorando</option>
                    <option value="ficando">Ficando</option>
                    <option value="terminou recentemente">Terminei recentemente</option>
                </select>
            </div>

            <button id="auth-btn" onclick="handleAuth()">Entrar</button>

            <div class="auth-divider">ou</div>

            <button class="btn-google" onclick="loginComGoogle()">
                <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                    <g fill="none" fill-rule="evenodd">
                        <path
                            d="M17.64 9.205c0-.639-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"
                            fill="#4285F4" />
                        <path
                            d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z"
                            fill="#34A853" />
                        <path
                            d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"
                            fill="#FBBC05" />
                        <path
                            d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"
                            fill="#EA4335" />
                    </g>
                </svg>
                Continuar com Google
            </button>

            <p id="toggle-text" style="font-size: 0.8rem; cursor: pointer; color: var(--cor-primaria);"
                onclick="toggleAuthMode()">
                N√£o tem conta? Cadastre-se
            </p>
        </div>
    </div>

    <!-- CHECK-IN DIARIO -->
    <div id="checkin-overlay" class="checkin-overlay" style="display:none;">
        <div class="checkin-card">
            <div id="checkin-step-1" class="checkin-step ativo">
                <h3>&#127769; Como voc√™ dormiu?</h3>
                <p>Sua noite influencia muito como voc√™ se sente hoje</p>
                <div class="checkin-perguntas">
                    <div class="checkin-opcao" onclick="selecionarOpcaoCheckin(this,'sono')">&#128564; Muito bem ‚Äî
                        acordei descansado(a)</div>
                    <div class="checkin-opcao" onclick="selecionarOpcaoCheckin(this,'sono')">&#128528; Razo√°vel ‚Äî
                        poderia ser melhor</div>
                    <div class="checkin-opcao" onclick="selecionarOpcaoCheckin(this,'sono')">&#128553; Mal ‚Äî acordei
                        v√°rias vezes</div>
                    <div class="checkin-opcao" onclick="selecionarOpcaoCheckin(this,'sono')">&#9749; Quase n√£o dormi
                    </div>
                </div>
                <button class="checkin-btn-ok" onclick="proximoCheckin(2)">Continuar &#8594;</button>
            </div>
            <div id="checkin-step-2" class="checkin-step">
                <h3>&#128149; N√≠vel de ansiedade hoje</h3>
                <p>Arraste para indicar como est√° agora</p>
                <div class="checkin-valor" id="checkin-anx-val">5</div>
                <input type="range" class="checkin-slider" id="checkin-anx" min="1" max="10" value="5"
                    oninput="atualizarSlider(this)">
                <div class="checkin-labels"><span>1 ‚Äî Tranquilo(a)</span><span>10 ‚Äî Muito ansioso(a)</span></div>
                <button class="checkin-btn-ok" onclick="finalizarCheckin()">Come√ßar sess√£o &#10024;</button>
            </div>
        </div>
    </div>

    <div id="popup-selecao" class="modal-conselheiro">
        <div class="card-selecao">
            <div id="etapa-conselheiro">
                <h2 style="margin-top:0; color: #333;">Como posso te ajudar hoje?</h2>
                <div class="grid-conselheiros" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="btn-escolha" onclick="proximaEtapaMood('psicologo')">
                        <span>&#127807;</span><label>Terapia</label>
                    </div>
                    <div class="btn-escolha" onclick="proximaEtapaMood('carreira')">
                        <span>&#128188;</span><label>Carreira</label>
                    </div>
                    <div class="btn-escolha" onclick="proximaEtapaMood('religioso')">
                        <span>&#128591;</span><label>Espiritual</label>
                    </div>
                    <div class="btn-escolha" onclick="proximaEtapaMood('direto')">
                        <span>&#9889;</span><label>Pr&#225;tico</label>
                    </div>
                    <div class="btn-escolha" onclick="proximaEtapaMood('luto')">
                        <span>&#129489;&#8205;&#9877;&#65039;</span><label>Luto</label>
                    </div>
                    <div class="btn-escolha" onclick="proximaEtapaMood('doenca')">
                        <span>&#129505;</span><label>Sa&#250;de</label>
                    </div>
                </div>
            </div>

            <div id="etapa-humor" style="display: none;">
                <h2 style="margin-top:0; color: #333;">Como voc√™ est√° se sentindo?</h2>
                <div class="grid-humor">
                    <div class="btn-humor" onclick="finalizarSelecao('Feliz')">üòä<span>Feliz</span></div>
                    <div class="btn-humor" onclick="finalizarSelecao('Ansioso')">üòü<span>Ansioso</span></div>
                    <div class="btn-humor" onclick="finalizarSelecao('Triste')">üò¢<span>Triste</span></div>
                    <div class="btn-humor" onclick="finalizarSelecao('Estressado')">ü§Ø<span>Exausto</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <header
            style="position: relative; padding: calc(env(safe-area-inset-top, 0px) + 16px) 20px 20px; background: var(--cor-secundaria); border-radius: 0 0 30px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; gap: 12px;">



            <h1 id="titulo-app"
                style="margin: 0; font-size: 1.9rem; text-align: center; letter-spacing: -0.5px; width: 100%;">
                Cora√ß√£o Acolhido
            </h1>

            <div
                style="display: flex; gap: 20px; align-items: center; background: rgba(255,255,255,0.5); padding: 8px 20px; border-radius: 30px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.3);">
                <button onclick="toggleHistorico()" title="Hist√≥rico"
                    style="background: none; border: none; cursor: pointer; color: var(--cor-texto); font-size: 1.3rem; opacity: 0.7; padding: 5px; transition: transform 0.2s;"
                    onmouseover="this.style.transform='scale(1.1)'"
                    onmouseout="this.style.transform='scale(1)'">üïí</button>

                <button onclick="limparConversa()" title="Limpar Chat"
                    style="background: none; border: none; cursor: pointer; color: #cc0000; font-size: 1.3rem; opacity: 0.7; padding: 5px; transition: transform 0.2s;"
                    onmouseover="this.style.transform='scale(1.1)'"
                    onmouseout="this.style.transform='scale(1)'">üóëÔ∏è</button>

                <button onclick="logout()" title="Sair"
                    style="background: none; border: none; cursor: pointer; color: var(--cor-texto); font-size: 1.3rem; opacity: 0.7; padding: 5px; transition: transform 0.2s;"
                    onmouseover="this.style.transform='scale(1.1)'"
                    onmouseout="this.style.transform='scale(1)'">üö™</button>
            </div>

            <button id="btn-hoje" onclick="voltarParaHoje()"
                style="display: none; background: white; border: 1px solid var(--cor-primaria); color: var(--cor-primaria); padding: 8px 20px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; font-weight: bold; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                ‚Ü∫ Voltar para Hoje
            </button>

            <div id="listaHistorico" class="historico-lista"
                style="top: auto; bottom: -180px; left: 50%; transform: translateX(-50%); width: 220px;">
                <div
                    style="font-weight: bold; font-size: 0.75rem; margin-bottom: 8px; color: var(--cor-primaria); border-bottom: 1px solid #eee; padding-bottom: 5px; text-align: center;">
                    Conversas anteriores:
                </div>
                <div id="itensHistorico"></div>
            </div>
        </header>
        <div class="chat-box" id="chatBox">
            <div class="message-wrapper">
                <div class="message bot" id="welcome-msg">Ol√°! Estou aqui para te ouvir.</div>
            </div>
        </div>
        <div id="typing" class="typing">Digitando com carinho...</div>
        <div class="input-area">
            <button id="tts-btn" onclick="toggleVoz()" title="Ativar/desativar voz">&#128266;</button>
            <input type="text" id="userInput" placeholder="Desabafe aqui..." autocomplete="off">
            <button id="sendBtn" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "https://klfysmzrohyvvrxeyjgy.supabase.co";
        const SUPABASE_KEY = "sb_publishable_9oMW9dFmLxNK1PoFqsDPhg_q0RA1JdW";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const API_KEY = "AIzaSyAP-IBAQ0yy8tC6BTiGwKRLtpDuKNjs_QU";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;

        let chatHistory = [];
        let usuario = {};
        let dadosCheckin = { sono: '', ansiedade: 5 };
        let memoriaUsuario = '';

        // ‚îÄ‚îÄ Check-in ‚îÄ‚îÄ
        function selecionarOpcaoCheckin(el, campo) {
            el.closest('.checkin-perguntas').querySelectorAll('.checkin-opcao')
                .forEach(o => o.classList.remove('sel'));
            el.classList.add('sel');
            dadosCheckin[campo] = el.textContent.trim();
        }
        function atualizarSlider(input) {
            const v = input.value;
            document.getElementById('checkin-anx-val').textContent = v;
            dadosCheckin.ansiedade = parseInt(v);
            const pct = ((v - 1) / 9) * 100;
            input.style.background = `linear-gradient(to right, var(--cor-primaria) 0%, var(--cor-primaria) ${pct}%, #eee ${pct}%, #eee 100%)`;
        }
        function proximoCheckin(etapa) {
            document.querySelectorAll('.checkin-step').forEach(s => s.classList.remove('ativo'));
            const prox = document.getElementById('checkin-step-' + etapa);
            if (prox) prox.classList.add('ativo');
        }
        async function finalizarCheckin() {
            document.getElementById('checkin-overlay').style.display = 'none';
            await salvarCheckinNoPerfil();
            document.getElementById('popup-selecao').style.display = 'flex';
        }
        async function salvarCheckinNoPerfil() {
            try {
                const { data: { user } } = await _supabase.auth.getUser();
                if (!user) return;
                await _supabase.from('profiles').upsert(
                    { id: user.id, ultima_sessao: new Date().toISOString().split('T')[0] },
                    { onConflict: 'id' }
                );
            } catch (e) { console.warn('Perfil n√£o salvo:', e); }
        }
        async function verificarCheckinHoje() {
            try {
                const { data: { user } } = await _supabase.auth.getUser();
                if (!user) return false;
                const { data } = await _supabase.from('profiles').select('ultima_sessao').eq('id', user.id).single();
                return data?.ultima_sessao === new Date().toISOString().split('T')[0];
            } catch (e) { return false; }
        }

        // ‚îÄ‚îÄ Mem√≥ria de longo prazo ‚îÄ‚îÄ
        async function carregarMemoria() {
            try {
                const { data: { user } } = await _supabase.auth.getUser();
                if (!user) return;
                const { data: msgs } = await _supabase
                    .from('historico_conversas')
                    .select('content, created_at')
                    .eq('user_id', user.id)
                    .eq('role', 'user')
                    .order('created_at', { ascending: false })
                    .limit(30);
                if (!msgs || msgs.length === 0) return;
                const porData = {};
                msgs.forEach(m => {
                    const d = m.created_at.split('T')[0];
                    if (!porData[d]) porData[d] = [];
                    porData[d].push(m.content);
                });
                const datas = Object.keys(porData).sort().reverse();
                memoriaUsuario = datas.slice(0, 5).map(d => {
                    const df = new Date(d + 'T12:00:00').toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
                    return `- ${df}: "${porData[d][0].substring(0, 80)}..."`;
                }).join('\n');
            } catch (e) { console.warn('Mem√≥ria:', e); }
        }

        // Inicializa o hist√≥rico e instru√ß√µes da IA
        function configurarGemini() {
            let personaPrompt = "";

            // Define a personalidade baseada na escolha do usu√°rio
            if (tipoAconselhador === 'carreira') {
                personaPrompt = `Voc√™ √© um mentor de carreira e especialista em mercado de trabalho. Ajude o usu√°rio ${usuario.nome} com conselhos sobre entrevistas, curr√≠culos, produtividade e transi√ß√£o de carreira. Seja motivador, profissional e estrat√©gico.`;
            } else if (tipoAconselhador === 'religioso') {
                personaPrompt = `Voc√™ √© um conselheiro espiritual acolhedor para ${usuario.nome}. Use palavras de f√©, esperan√ßa e compaix√£o. Cite conceitos de paz interior sem ser impositivo.`;
            } else if (tipoAconselhador === 'direto') {
                personaPrompt = `Voc√™ √© um mentor pragm√°tico. D√™ conselhos diretos, l√≥gicos e focados em solu√ß√µes imediatas para ${usuario.nome}. Sem rodeios.`;
            } else if (tipoAconselhador === 'amigavel') {
                personaPrompt = `Voc√™ √© o melhor amigo de ${usuario.nome}. Use linguagem informal, carinhosa e seja um √≥timo ouvinte, como se estivessem conversando em um caf√©.`;
            } else if (tipoAconselhador === 'luto') {
                personaPrompt = `Voc√™ √© um terapeuta especialista em luto e perda para ${usuario.nome}. Seu papel √© oferecer presen√ßa, n√£o solu√ß√µes. Siga estas diretrizes com profundo cuidado humano:

ESS√äNCIA: Voc√™ entende que o luto n√£o tem prazo, n√£o segue ordem e √© √∫nico para cada pessoa. Nunca minimize a dor com frases como "vai passar" ou "ela est√° num lugar melhor". Em vez disso, honre a dor como prova do amor que existiu.

ABORDAGEM:
- Comece sempre validando o que a pessoa sente antes de qualquer outra coisa
- Fa√ßa perguntas suaves sobre a pessoa/situa√ß√£o perdida ‚Äî deixe o usu√°rio falar e lembrar
- Reconhe√ßa todos os tipos de luto: morte, fim de relacionamento, perda de emprego, sa√∫de, sonhos
- Normalize sentimentos contradit√≥rios: al√≠vio e culpa, amor e raiva, saudade e medo
- Nunca apresse o processo. Se ela disser que est√° mal, permita que esteja mal
- √Äs vezes, apenas diga "Estou aqui. Pode continuar."
- Sugira rituais de mem√≥ria com delicadeza (escrever uma carta, olhar fotos) apenas se o contexto permitir
- Se perceber isolamento ou dor muito intensa, acolha primeiro e depois sugira suporte profissional com gentileza`;
            } else if (tipoAconselhador === 'doenca') {
                personaPrompt = `Voc√™ √© um acompanhante terap√™utico especializado em suporte emocional para pessoas que enfrentam doen√ßas ‚Äî pr√≥prias ou de algu√©m amado ‚Äî e para cuidadores esgotados. Seu papel √© ${usuario.nome} se sentir menos s√≥ nesse momento dif√≠cil.

ESS√äNCIA: Doen√ßa traz medo, incerteza, perda de controle e mudan√ßa de identidade. Voc√™ acolhe tudo isso sem minimizar.

ABORDAGEM:
- Pergunte como a pessoa est√° se sentindo EMOCIONALMENTE, n√£o s√≥ fisicamente
- Valide o cansa√ßo de lutar, de esperar, de cuidar ‚Äî isso √© imensamente dif√≠cil
- Reconhe√ßa que ser cuidador tamb√©m √© exaustivo e que pedir ajuda √© coragem
- Ofere√ßa perspectiva sem falsa esperan√ßa ‚Äî "voc√™ est√° sendo muito forte" em vez de "vai ficar tudo bem"
- Se a pessoa falar de medo de morrer ou de perder algu√©m, acolha esse medo com toda a seriedade que ele merece
- Ajude a encontrar pequenos momentos de beleza e presen√ßa no dia ‚Äî sem for√ßar positividade
- Reconhe√ßa conquistas m√≠nimas como vit√≥rias reais: "conseguir se levantar hoje j√° √© muito"
- Se o usu√°rio for cuidador, valide a culpa, o amor e o esgotamento como tudo coexistindo ao mesmo tempo
- Jamais diga "seja forte" como obriga√ß√£o. Diga "voc√™ pode ser fraco aqui, eu estou com voc√™"`;
            } else {
                personaPrompt = `Voc√™ √© um terapeuta chamado "Cora√ß√£o Acolhido". Paciente: ${usuario.nome}, ${usuario.genero}, ${usuario.status}. Foco em empatia e acolhimento emocional.`;
            }

            chatHistory = [{
                role: "user",
                parts: [{
                    text: `${personaPrompt}
            CONTEXTO ADICIONAL:
            - O usu√°rio relatou estar se sentindo: ${humorAtual}.
            - Abaixo est√° o que foi conversado ONTEM (use apenas se o usu√°rio perguntar ou demonstrar que n√£o lembra):
            --- IN√çCIO DO HIST√ìRICO DE ONTEM ---
            ${conteudoOntem}
            --- FIM DO HIST√ìRICO DE ONTEM ---

            CHECK-IN DE HOJE:
            - Como dormiu: \${dadosCheckin.sono || 'n√£o informado'}
            - Ansiedade agora (1-10): \${dadosCheckin.ansiedade}
            Use esses dados com sutileza para calibrar seu tom ‚Äî n√£o os mencione mecanicamente.

            MEM√ìRIA DE SESSOES ANTERIORES (use APENAS se o usuario perguntar ou trouxer o tema):
            \${memoriaUsuario || 'Sem hist√≥rico anterior.'}

            REGRAS DE RESPOSTA:
            1. Se o usu√°rio disser que n√£o lembra ou perguntar sobre conversas passadas, fa√ßa um resumo acolhedor em at√© 2 frases.
            2. Se ele n√£o mencionar sess√µes anteriores, ignore a mem√≥ria e foque no agora.
            3. Comece SEMPRE com UM emoji e '#'.
            4. Use '|' para separar par√°grafos.`
                }]
            }];
        }

        async function salvarMensagemNoBanco(role, content) {
            try {
                const { data: { session } } = await _supabase.auth.getSession();
                if (!session?.user) return;

                // O await aqui √© importante, mas envolvemos em um try/catch interno
                const { error } = await _supabase.from('historico_conversas').insert([
                    { user_id: session.user.id, role: role, content: content }
                ]);

                if (error) console.error("Erro Supabase:", error.message);
            } catch (e) {
                console.warn("Falha ao salvar hist√≥rico, mas a conversa continua...");
            }
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            const typingIndicator = document.getElementById('typing');

            if (!message) return;

            // 1. Exibe na tela
            const userMsgElement = appendMessage(message, 'user');
            input.value = "";
            typingIndicator.style.display = "block";

            // 2. SALVA NO BANCO DE DADOS (Mensagem do Usu√°rio)
            await salvarMensagemNoBanco('user', message);

            chatHistory.push({ role: "user", parts: [{ text: message }] });

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: chatHistory })
                });

                const data = await response.json();
                let fullBotReply = data.candidates[0].content.parts[0].text;

                // 3. SALVA NO BANCO DE DADOS (Resposta completa do Bot)
                await salvarMensagemNoBanco('model', fullBotReply);

                chatHistory.push({ role: "model", parts: [{ text: fullBotReply }] });

                // Extrai o emoji de rea√ß√£o
                const [reactionEmoji, botText] = fullBotReply.split('#');

                if (reactionEmoji && userMsgElement) {
                    const reactionDiv = document.createElement('div');
                    reactionDiv.className = 'reaction';
                    reactionDiv.innerText = reactionEmoji.trim();
                    userMsgElement.appendChild(reactionDiv);
                }

                const chunks = botText.split(/[|\n]+/).filter(c => c.trim().length > 0);
                typingIndicator.style.display = "none";

                for (const chunk of chunks) {
                    typingIndicator.style.display = "block";
                    await new Promise(r => setTimeout(r, 800 + (chunk.length * 15)));
                    typingIndicator.style.display = "none";
                    appendMessage(chunk.trim(), 'bot');
                    falarTexto(chunk.trim()); // voz
                    if (chunks.length > 1) {
                        await new Promise(r => setTimeout(r, chunk.length * 60 + 600));
                    }
                }

            } catch (error) {
                typingIndicator.style.display = "none";
                appendMessage(`Sinto muito, ${usuario.nome}, tive um erro na conex√£o.`, 'bot');
            }
        }

        function appendMessage(text, side, buttons = []) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message-wrapper';

            const div = document.createElement('div');
            div.className = `message ${side}`;
            div.innerText = text;

            wrapper.appendChild(div);

            // Se houver bot√µes, adiciona-os logo abaixo da bolha de texto
            if (buttons.length > 0) {
                const btnContainer = document.createElement('div');
                btnContainer.style.display = 'flex';
                btnContainer.style.gap = '8px';
                btnContainer.style.marginTop = '10px';
                btnContainer.style.flexWrap = 'wrap';

                buttons.forEach(btn => {
                    const button = document.createElement('button');
                    button.innerText = btn.label;
                    button.style.cssText = `
                padding: 8px 16px;
                border-radius: 20px;
                border: 1px solid var(--cor-primaria);
                background: white;
                color: var(--cor-primaria);
                cursor: pointer;
                font-size: 0.85rem;
                font-weight: bold;
                transition: all 0.3s;
            `;
                    button.onclick = () => {
                        btnContainer.remove(); // Remove os bot√µes ap√≥s o clique
                        btn.action();
                    };
                    btnContainer.appendChild(button);
                });
                wrapper.appendChild(btnContainer);
            }

            const chatBox = document.getElementById('chatBox');
            chatBox.appendChild(wrapper);
            chatBox.scrollTop = chatBox.scrollHeight;

            return div;
        }




        async function carregarHistoricoDoBanco() {
            const { data: { user } } = await _supabase.auth.getUser();

            if (user) {
                const { data: mensagens, error } = await _supabase
                    .from('historico_conversas')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (!error && mensagens) {
                    mensagens.forEach(msg => {
                        // Se for do bot, precisamos tratar o formato emoji#texto
                        if (msg.role === 'model') {
                            const [_, botText] = msg.content.split('#');
                            const chunks = (botText || msg.content).split(/[|\n]+/).filter(c => c.trim().length > 0);
                            chunks.forEach(chunk => appendMessage(chunk.trim(), 'bot'));
                        } else {
                            appendMessage(msg.content, 'user');
                        }

                        // Alimenta o chatHistory para a IA ter contexto
                        chatHistory.push({ role: msg.role, parts: [{ text: msg.content }] });
                    });
                }
            }
        }

        document.getElementById('userInput').addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage());

        // iOS: quando o teclado abre, rola o chat para a √∫ltima mensagem
        document.getElementById('userInput').addEventListener('focus', () => {
            setTimeout(() => {
                const chatBox = document.getElementById('chatBox');
                chatBox.scrollTop = chatBox.scrollHeight;
                // For√ßa o scroll para que o campo fique vis√≠vel acima do teclado
                document.getElementById('userInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 350); // aguarda o teclado abrir (~300ms no iOS)
        });

        // Previne o bounce/scroll do body ao tocar fora de √°reas scroll√°veis
        document.addEventListener('touchmove', (e) => {
            if (!e.target.closest('.chat-box, .modal, .checkin-card, .historico-lista')) {
                e.preventDefault();
            }
        }, { passive: false });

        let isSignUpMode = false;

        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            document.getElementById('modal-title').innerText = isSignUpMode ? "Criar Conta" : "Entrar";
            document.getElementById('auth-btn').innerText = isSignUpMode ? "Cadastrar" : "Entrar";
            document.getElementById('perfil-extra').style.display = isSignUpMode ? "block" : "none";
            document.getElementById('toggle-text').innerText = isSignUpMode ? "J√° tem conta? Entre aqui" : "N√£o tem conta? Cadastre-se";
        }


        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  TTS ‚Äî Voz da terapeuta (Web Speech API)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let vozAtiva = true;
        let vozSelecionada = null;
        const synth = window.speechSynthesis;

        function carregarVoz() {
            const vozes = synth.getVoices();
            const filtros = [
                v => v.lang === 'pt-BR' && /female|francisca|vitoria|luciana/i.test(v.name),
                v => v.lang === 'pt-BR',
                v => v.lang.startsWith('pt'),
                v => true
            ];
            for (const f of filtros) {
                const v = vozes.find(f);
                if (v) { vozSelecionada = v; break; }
            }
        }
        speechSynthesis.onvoiceschanged = carregarVoz;
        carregarVoz();

        function falarTexto(texto) {
            if (!vozAtiva || !synth) return;
            synth.cancel();
            // Remove emojis e s√≠mbolos especiais do app
            const limpo = texto
                .replace(/[\u{1F000}-\u{1FFFF}]/gu, '')
                .replace(/[#|]/g, ' ')
                .trim();
            if (!limpo) return;
            const utter = new SpeechSynthesisUtterance(limpo);
            utter.lang = 'pt-BR';
            utter.rate = 0.91;
            utter.pitch = 1.05;
            utter.volume = 1;
            if (vozSelecionada) utter.voice = vozSelecionada;
            const btn = document.getElementById('tts-btn');
            utter.onstart = () => btn && btn.classList.add('falando');
            utter.onend = () => btn && btn.classList.remove('falando');
            utter.onerror = () => btn && btn.classList.remove('falando');
            synth.speak(utter);
        }

        function toggleVoz() {
            vozAtiva = !vozAtiva;
            const btn = document.getElementById('tts-btn');
            if (!vozAtiva) {
                synth.cancel();
                btn.innerHTML = '&#128263;';
                btn.classList.add('mudo');
                btn.classList.remove('falando');
                btn.title = 'Voz desativada ‚Äî clique para ativar';
            } else {
                btn.innerHTML = '&#128266;';
                btn.classList.remove('mudo');
                btn.title = 'Voz ativada ‚Äî clique para desativar';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  Login com Google (Supabase OAuth)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  AUTENTICA√á√ÉO ‚Äî Google OAuth + Email/Senha
        //  Solu√ß√£o definitiva: usa apenas onAuthStateChange
        //  como fonte √∫nica de verdade. window.onload n√£o
        //  chama carregarDadosEIniciar diretamente.
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let _appJaIniciado = false;

        async function loginComGoogle() {
            const btn = document.querySelector('.btn-google');
            if (btn) {
                btn.innerHTML = '<div class="loader-fofo"></div> Redirecionando...';
                btn.classList.add('btn-loading');
            }
            const { error } = await _supabase.auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo: window.location.href }
            });
            // Se der erro ANTES do redirect (raro), restaura o bot√£o
            if (error) {
                if (btn) {
                    btn.innerHTML = 'Continuar com Google';
                    btn.classList.remove('btn-loading');
                }
                const errDiv = document.getElementById('error-message');
                if (errDiv) { errDiv.innerText = 'Erro ao conectar com Google: ' + error.message; errDiv.style.display = 'block'; }
            }
            // Se n√£o der erro, o browser vai redirecionar ‚Äî n√£o precisa fazer nada mais aqui
        }

        // FONTE √öNICA DE VERDADE: este listener captura TODOS os eventos de auth:
        // - Login por email/senha
        // - Retorno do redirect OAuth (Google)
        // - Sess√£o j√° existente ao carregar a p√°gina (INITIAL_SESSION)
        _supabase.auth.onAuthStateChange(async (event, session) => {
            if (session && !_appJaIniciado) {
                _appJaIniciado = true;
                await carregarDadosEIniciar(session.user);
            }
        });

        // window.onload apenas garante que a UI est√° pronta
        // O auth √© tratado exclusivamente pelo onAuthStateChange acima
        window.onload = () => {
            // Nada aqui ‚Äî o onAuthStateChange j√° cuida da sess√£o existente
            // via evento INITIAL_SESSION que o Supabase dispara automaticamente
        };

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('error-message');
            const authBtn = document.getElementById('auth-btn');

            const originalText = authBtn.innerText;
            authBtn.innerHTML = '<div class="loader-fofo"></div> Entrando com carinho...';
            authBtn.classList.add('btn-loading', 'pulse-fofo');
            errorDiv.style.display = 'none';

            try {
                if (isSignUpMode) {
                    // L√≥gica de cadastro
                } else {
                    const { error } = await _supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    // N√ÉO chama carregarDadosEIniciar aqui!
                    // O onAuthStateChange vai capturar o evento SIGNED_IN e fazer isso.
                }
            } catch (error) {
                authBtn.innerHTML = originalText;
                authBtn.classList.remove('btn-loading', 'pulse-fofo');
                errorDiv.innerText = "Ops! E-mail ou senha incorretos.";
                errorDiv.style.display = 'block';
                document.getElementById('password').value = "";
            }
        }

        async function carregarDadosEIniciar(user) {
            usuario = {
                nome: user.user_metadata.nome || user.email?.split('@')[0] || "Amigo",
                genero: user.user_metadata.genero || "mulher",
                status: user.user_metadata.status || "solteiro"
            };

            if (usuario.genero === 'homem') {
                document.body.classList.add('tema-homem');
                document.getElementById('titulo-app').innerText = "Amigo Conselheiro";
            }

            document.getElementById('welcome-msg').innerText = `Oi, ${usuario.nome}. Que bom te ver de novo.`;
            document.getElementById('modal-overlay').style.display = 'none';

            // Carrega mem√≥ria de sess√µes anteriores em paralelo
            await carregarMemoria();

            // Check-in s√≥ uma vez por dia
            const fezCheckinHoje = await verificarCheckinHoje();
            if (!fezCheckinHoje) {
                document.getElementById('checkin-overlay').style.display = 'flex';
            } else {
                document.getElementById('popup-selecao').style.display = 'flex';
            }

            configurarGemini();
            carregarHistoricoDoBanco();
            iniciarTemporizadorSessao();
        }



        // Fun√ß√£o para sair
        async function logout() {
            const { error } = await _supabase.auth.signOut();
            if (error) alert("Erro ao sair: " + error.message);
            window.location.reload(); // Recarrega a p√°gina para voltar ao modal de login
        }

        // L√≥gica de tempo de sess√£o (1h 30min)
        function iniciarTemporizadorSessao() {
            const noventaMinutos = 90 * 60 * 1000; // milissegundos
            setTimeout(() => {
                alert("Sua sess√£o de 1h30 expirou por seguran√ßa.");
                logout();
            }, noventaMinutos);
        }


        async function limparConversa() {
            if (!confirm("Tem certeza que deseja apagar todo o hist√≥rico de conversas?")) return;

            const { data: { user } } = await _supabase.auth.getUser();
            if (user) {
                const { error } = await _supabase
                    .from('historico_conversas')
                    .delete()
                    .eq('user_id', user.id);

                if (error) {
                    alert("Erro ao limpar conversa: " + error.message);
                } else {
                    // Limpa a tela e o hist√≥rico local
                    document.getElementById('chatBox').innerHTML = `
                <div class="message-wrapper">
                    <div class="message bot" id="welcome-msg">Hist√≥rico limpo. Como posso te ajudar agora?</div>
                </div>`;
                    chatHistory = [];
                    configurarGemini(); // Reinicia as instru√ß√µes do sistema
                }
            }
        }

        // Alterna a exibi√ß√£o do menu de hist√≥rico
        async function toggleHistorico() {
            const lista = document.getElementById('listaHistorico');
            if (lista.style.display === 'block') {
                lista.style.display = 'none';
            } else {
                lista.style.display = 'block';
                await carregarDiasComConversa();
            }
        }

        // Busca no Supabase as datas √∫nicas das conversas
        // Busca no Supabase as datas √∫nicas das conversas
        async function carregarDiasComConversa() {
            const container = document.getElementById('itensHistorico');
            container.innerHTML = "<div style='font-size:0.7rem; padding:5px;'>Carregando...</div>";

            const { data: { user } } = await _supabase.auth.getUser();

            const { data, error } = await _supabase
                .from('historico_conversas')
                .select('created_at')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });

            if (error || !data || data.length === 0) {
                container.innerHTML = "<div style='font-size:0.7rem; padding:5px;'>Nenhum hist√≥rico encontrado.</div>";
                return;
            }

            // Filtra para mostrar apenas datas √∫nicas (dia/m√™s/ano)
            const diasUnicos = [...new Set(data.map(item =>
                new Date(item.created_at).toLocaleDateString('pt-BR')
            ))].slice(0, 7); // Mostra at√© a √∫ltima semana

            container.innerHTML = "";
            diasUnicos.forEach(dia => {
                const div = document.createElement('div');
                div.className = 'historico-item';
                div.innerHTML = `<span>üìÖ</span> ${dia}`;
                // Ao clicar, chama a fun√ß√£o de carregar aquele dia espec√≠fico
                div.onclick = () => carregarMensagensPorData(dia);
                container.appendChild(div);
            });
        }

        async function voltarParaHoje() {
            document.getElementById('chatBox').innerHTML = ""; // Limpa a vis√£o do passado
            chatHistory = []; // Limpa o hist√≥rico de mem√≥ria da IA
            configurarGemini(); // Reseta instru√ß√µes

            // Esconde o bot√£o de voltar
            document.getElementById('btn-hoje').style.display = 'none';

            // Recarrega as mensagens do banco
            await carregarHistoricoDoBanco();

            // Mensagem de boas-vindas atualizada
            appendMessage(`Voltamos para agora, ${usuario.nome}. Como voc√™ est√° se sentindo neste momento?`, 'bot');
        }

        // Carrega as mensagens de um dia espec√≠fico
        // Atualize sua fun√ß√£o existente para mostrar o bot√£o quando carregar um dia antigo:
        async function carregarMensagensPorData(dataString) {
            const chatBox = document.getElementById('chatBox');
            const lista = document.getElementById('listaHistorico');
            const btnHoje = document.getElementById('btn-hoje');

            // Mostra o bot√£o "Voltar para Hoje"
            btnHoje.style.display = 'block';

            chatBox.innerHTML = `<div style="text-align:center; font-size:0.8rem; color:var(--cor-primaria); margin:10px 0; font-style: italic;">‚Äî Olhando para o passado: ${dataString} ‚Äî</div>`;
            chatHistory = [];
            configurarGemini();
            lista.style.display = 'none';

            const [dia, mes, ano] = dataString.split('/');
            const dataInicio = `${ano}-${mes}-${dia}T00:00:00Z`;
            const dataFim = `${ano}-${mes}-${dia}T23:59:59Z`;

            const { data: mensagens, error } = await _supabase
                .from('historico_conversas')
                .select('*')
                .gte('created_at', dataInicio)
                .lte('created_at', dataFim)
                .order('created_at', { ascending: true });

            if (error) return alert("Erro ao carregar dia: " + error.message);

            mensagens.forEach(msg => {
                if (msg.role === 'model') {
                    const parts = msg.content.split('#');
                    const botText = parts.length > 1 ? parts[1] : parts[0];
                    const chunks = botText.split(/[|\n]+/).filter(c => c.trim().length > 0);
                    chunks.forEach(chunk => appendMessage(chunk.trim(), 'bot'));
                } else {
                    appendMessage(msg.content, 'user');
                }
                chatHistory.push({ role: msg.role, parts: [{ text: msg.content }] });
            });
        }

        // Fecha o hist√≥rico se clicar fora dele
        window.onclick = function (event) {
            if (!event.target.matches('button')) {
                const lista = document.getElementById('listaHistorico');
                if (lista) lista.style.display = 'none';
            }
        }



        let tipoAconselhador = 'psicologo';

        function toggleMenuAconselhadores() {
            const menu = document.getElementById('menuAconselhadores');
            menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
        }

        function mudarAconselhador(tipo, elemento, isInitial = false) {
            tipoAconselhador = tipo;

            // Limpa absolutamente todos os temas poss√≠veis
            document.body.classList.remove('tema-religioso', 'tema-direto', 'tema-amigavel', 'tema-carreira', 'tema-luto', 'tema-doenca', 'tema-homem');

            // Aplica o novo tema visual
            const temas = {
                'religioso': 'tema-religioso',
                'direto': 'tema-direto',
                'amigavel': 'tema-amigavel',
                'carreira': 'tema-carreira',
                'luto': 'tema-luto',
                'doenca': 'tema-doenca'
            };

            if (temas[tipo]) {
                document.body.classList.add(temas[tipo]);
            } else if (tipo === 'psicologo' && usuario.genero === 'homem') {
                document.body.classList.add('tema-homem');
            }

            // Fecha os menus/popups
            document.getElementById('popup-selecao').style.display = 'none';
            const menuLat = document.getElementById('menuAconselhadores');
            if (menuLat) menuLat.style.display = 'none';

            // Reinicia a IA com a nova instru√ß√£o
            configurarGemini();

            // Se n√£o for a escolha inicial do login, avisa no chat
            if (!isInitial) {
                const nomes = {
                    'psicologo': 'Terapia',
                    'carreira': 'Foco em Carreira',
                    'religioso': 'Espiritualidade',
                    'direto': 'Modo Pr√°tico',
                    'amigavel': 'Modo Amigo',
                    'luto': 'Suporte ao Luto',
                    'doenca': 'Apoio na Doen√ßa'
                };
                appendMessage(`Abordagem alterada para: ${nomes[tipo]}.`, 'bot');
            }
        }

        // ATUALIZE sua fun√ß√£o configurarGemini() existente para incluir as novas personas:
        function configurarGemini() {
            let personaPrompt = "";

            if (tipoAconselhador === 'carreira') {
                personaPrompt = `Voc√™ √© um mentor de carreira e especialista em mercado de trabalho. Ajude com conselhos sobre entrevistas, produtividade, transi√ß√£o de carreira e lideran√ßa. Seja motivador, profissional e estrat√©gico.`;
            } else if (tipoAconselhador === 'religioso') {
                personaPrompt = `Voc√™ √© um conselheiro espiritual profundamente acolhedor para ${usuario.nome}. Sua ess√™ncia √© f√©, compaix√£o e sabedoria b√≠blica usada com delicadeza e intelig√™ncia.

ABORDAGEM: Ou√ßa primeiro. Entenda a situa√ß√£o antes de qualquer cita√ß√£o b√≠blica. Use a B√≠blia com MODERA√á√ÉO ‚Äî n√£o em toda resposta. Quando for relevante, PERGUNTE antes: "Posso te compartilhar algo que a B√≠blia diz sobre isso que pode te confortar?" ‚Äî e espere a resposta. Se a pessoa aceitar, traga a passagem contextualizada, mostrando como ela se conecta com o que est√° sentindo agora. Passagens √∫teis: Salmos 23 (vale da sombra), Jo√£o 11:35 (Jesus chorou), Romanos 8:28 (prop√≥sito na dor), Isa√≠as 41:10 (n√£o tema), Filipenses 4:6-7 (paz que excede), Lamenta√ß√µes 3:22-23 (miseric√≥rdias todas as manh√£s), Mateus 11:28 (vinde a mim os cansados). Nunca use a B√≠blia para minimizar dor. Transmita que Deus est√° presente NA dor, n√£o ausente dela. Respeite d√∫vidas de f√© ‚Äî acolha-as como parte do caminho espiritual.`;
            } else if (tipoAconselhador === 'direto') {
                personaPrompt = `Voc√™ √© um mentor direto e pr√°tico. Foque em solu√ß√µes, passos acion√°veis e l√≥gica, mantendo a educa√ß√£o, mas sem rodeios.`;
            } else if (tipoAconselhador === 'amigavel') {
                personaPrompt = `Voc√™ √© um melhor amigo de longa data. Use uma linguagem mais informal, carinhosa e focada em "estar junto" e ouvir, como se estivessem tomando um caf√©.`;
            } else if (tipoAconselhador === 'luto') {
                personaPrompt = `Voc√™ √© um terapeuta especialista em luto e perda para ${usuario.nome}. Nunca minimize a dor. Honre o amor que existiu por tr√°s de cada perda. Valide sentimentos contradit√≥rios: al√≠vio e culpa, amor e raiva, saudade e medo. Deixe a pessoa falar, lembrar, chorar. N√£o apresse o processo. Reconhe√ßa que luto n√£o tem prazo nem ordem certa. Pergunte sobre quem ou o que foi perdido ‚Äî deixe a pessoa reviver mem√≥rias com seguran√ßa. √Äs vezes, apenas dizer "estou aqui" √© o suficiente.`;
            } else if (tipoAconselhador === 'doenca') {
                personaPrompt = `Voc√™ √© um acompanhante terap√™utico para ${usuario.nome}, que enfrenta doen√ßa ‚Äî pr√≥pria ou de algu√©m amado. Valide o cansa√ßo de lutar, esperar e cuidar. Reconhe√ßa conquistas m√≠nimas como vit√≥rias reais. N√£o force positividade. Acolha o medo ‚Äî inclusive o medo da morte ‚Äî com seriedade e humanidade. Diga "voc√™ pode ser fraco aqui, eu estou com voc√™" em vez de exigir for√ßa.`;
            } else {
                personaPrompt = `Voc√™ √© um terapeuta chamado "Cora√ß√£o Acolhido". Paciente: ${usuario.nome}, ${usuario.genero}, ${usuario.status}. Foco em psicologia humanista e empatia.`;
            }

            chatHistory = [{
                role: "user",
                parts: [{
                    text: `${personaPrompt}
            REGRAS DE RESPOSTA:
            1. Comece SEMPRE sua resposta com apenas UM emoji e '#'. Exemplo: ‚ù§Ô∏è#
            2. Nunca use t√≥picos ou listas.
            3. Responda com no m√°ximo 3 par√°grafos curtos usando '|' para separar.`
                }]
            }];
        }


        let humorAtual = "Neutro"; // Vari√°vel global para guardar o humor

        function proximaEtapaMood(tipo) {
            // Primeiro aplicamos o tipo e o tema (como j√° faz√≠amos)
            tipoAconselhador = tipo;
            document.body.classList.remove('tema-religioso', 'tema-direto', 'tema-amigavel', 'tema-carreira', 'tema-luto', 'tema-doenca', 'tema-homem');

            const temas = { 'religioso': 'tema-religioso', 'direto': 'tema-direto', 'amigavel': 'tema-amigavel', 'carreira': 'tema-carreira', 'luto': 'tema-luto', 'doenca': 'tema-doenca' };
            if (temas[tipo]) document.body.classList.add(temas[tipo]);
            else if (tipo === 'psicologo' && usuario.genero === 'homem') document.body.classList.add('tema-homem');

            // Troca a tela do popup
            document.getElementById('etapa-conselheiro').style.display = 'none';
            document.getElementById('etapa-humor').style.display = 'block';
        }

        async function finalizarSelecao(humor) {
            humorAtual = humor;
            document.getElementById('popup-selecao').style.display = 'none';

            configurarGemini();

            const pendencia = await verificarUltimaMensagemPendente();
            let saudacao = "";
            let botoes = [];

            const boasVindasHumor = {
                'Feliz': `Que maravilha te ver feliz, ${usuario.nome}!`,
                'Ansioso': `Respire fundo, ${usuario.nome}. Estou aqui com voc√™.`,
                'Triste': `Sinto muito que as coisas estejam dif√≠ceis hoje, ${usuario.nome}.`,
                'Estressado': `Pare um minuto, ${usuario.nome}. Deixe o peso do mundo l√° fora.`
            };

            saudacao = boasVindasHumor[humor] || `Oi ${usuario.nome}, que bom te ver.`;

            if (pendencia && pendencia.foiUsuario) {
                saudacao += ` | Notei que nossa √∫ltima conversa parou em: "${pendencia.texto.substring(0, 30)}...". Como prefere seguir?`;

                botoes = [
                    {
                        label: "üîÑ Continuar de onde paramos",
                        action: () => {
                            document.getElementById('userInput').value = "Vamos continuar nossa √∫ltima conversa?";
                            sendMessage();
                        }
                    },
                    {
                        label: "üÜï Iniciar novo assunto",
                        action: () => {
                            appendMessage("Entendido! Vamos focar no agora. O que est√° em sua mente?", 'bot');
                        }
                    }
                ];
            } else {
                const teveConversaOntem = await verificarConversaOntem();
                if (teveConversaOntem) {
                    saudacao += ` | A nossa conversa de ontem te ajudou de alguma forma?`;
                } else {
                    saudacao += ` Como posso te ouvir agora?`;
                }
            }

            appendMessage(saudacao, 'bot', botoes);
        }

        // ATUALIZE sua fun√ß√£o configurarGemini para usar o humorAtual:
        function configurarGemini() {
            let personaPrompt = "";

            // Personalidades (mantendo o que voc√™ j√° tinha)
            if (tipoAconselhador === 'carreira') {
                personaPrompt = `Voc√™ √© um mentor de carreira.`;
            } else if (tipoAconselhador === 'religioso') {
                personaPrompt = `Voc√™ √© um conselheiro espiritual.`;
            } // ... (resto das suas personas)

            chatHistory = [{
                role: "user",
                parts: [{
                    text: `${personaPrompt} 
            IMPORTANTE: O usu√°rio ${usuario.nome} relatou que hoje se sente: ${humorAtual}. 
            Adapte seu tom de voz a esse sentimento.
            REGRAS DE RESPOSTA:
            1. Comece SEMPRE sua resposta com apenas UM emoji e '#'.
            2. Nunca use t√≥picos ou listas.
            3. Responda com no m√°ximo 3 par√°grafos curtos usando '|'.`
                }]
            }];
        }

        async function verificarConversaOntem() {
            const { data: { user } } = await _supabase.auth.getUser();

            // Calcula a data de ontem (in√≠cio e fim do dia)
            const ontem = new Date();
            ontem.setDate(ontem.getDate() - 1);
            const dataInicio = new Date(ontem.setHours(0, 0, 0, 0)).toISOString();
            const dataFim = new Date(ontem.setHours(23, 59, 59, 999)).toISOString();

            const { data, error } = await _supabase
                .from('historico_conversas')
                .select('id')
                .eq('user_id', user.id)
                .gte('created_at', dataInicio)
                .lte('created_at', dataFim)
                .limit(1);

            return data && data.length > 0;
        }


        async function buscarResumoOntem() {
            const { data: { user } } = await _supabase.auth.getUser();

            const ontem = new Date();
            ontem.setDate(ontem.getDate() - 1);
            const dataInicio = new Date(ontem.setHours(0, 0, 0, 0)).toISOString();
            const dataFim = new Date(ontem.setHours(23, 59, 59, 999)).toISOString();

            const { data, error } = await _supabase
                .from('historico_conversas')
                .select('content, role')
                .eq('user_id', user.id)
                .gte('created_at', dataInicio)
                .lte('created_at', dataFim)
                .order('created_at', { ascending: true });

            if (error || !data || data.length === 0) return "N√£o encontrei registros da nossa conversa de ontem.";

            // Formata as mensagens para a IA entender o contexto
            return data.map(m => `${m.role === 'user' ? 'Usu√°rio' : 'IA'}: ${m.content}`).join('\n');
        }

        async function verificarUltimaMensagemPendente() {
            const { data: { user } } = await _supabase.auth.getUser();

            // Busca a √∫ltima mensagem enviada no hist√≥rico geral
            const { data, error } = await _supabase
                .from('historico_conversas')
                .select('content, role, created_at')
                .eq('user_id', user.id)
                .order('created_at', { descending: true })
                .limit(1);

            if (error || !data || data.length === 0) return null;

            const ultimaMsg = data[0];
            const agora = new Date();
            const dataMsg = new Date(ultimaMsg.created_at);
            const diffMinutos = Math.floor((agora - dataMsg) / (1000 * 60));

            // Se a √∫ltima mensagem foi do usu√°rio, ele saiu sem resposta
            // Ou se foi da IA mas faz pouco tempo (ex: menos de 2 horas), pode ser uma continua√ß√£o
            return {
                foiUsuario: ultimaMsg.role === 'user',
                texto: ultimaMsg.content,
                tempo: diffMinutos
            };
        }

    </script>




    <div class="floating-menu-btn" onclick="toggleMenuAconselhadores()" title="Mudar Aconselhador">
        ‚ú®
    </div>

    <div id="menuAconselhadores" class="menu-aconselhadores">
        <div style="font-size: 0.75rem; color: var(--cor-primaria); font-weight: bold; padding: 5px 15px;">MUDAR
            ABORDAGEM:</div>

        <div class="opcao-aconselhador" onclick="mudarAconselhador('psicologo', this)">
            <span>üåø</span> Terapia Tradicional
        </div>

        <div class="opcao-aconselhador" onclick="mudarAconselhador('carreira', this)">
            <span>üíº</span> Carreira e Trabalho
        </div>

        <div class="opcao-aconselhador" onclick="mudarAconselhador('religioso', this)">
            <span>üôè</span> Aconselhamento Espiritual
        </div>

        <div class="opcao-aconselhador" onclick="mudarAconselhador('direto', this)">
            <span>‚ö°</span> Conselhos Pr√°ticos
        </div>

        <div class="opcao-aconselhador" onclick="mudarAconselhador('amigavel', this)">
            <span>&#129528;</span> Apenas um Amigo
        </div>

        <div class="opcao-aconselhador" onclick="mudarAconselhador('luto', this)">
            <span>&#129761;</span> Suporte ao Luto
        </div>

        <div class="opcao-aconselhador" onclick="mudarAconselhador('doenca', this)">
            <span>&#129505;</span> Apoio na Doen√ßa
        </div>
    </div>
</body>

</html>
